<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="nfsstat1234567$ nfsiostat -d &#x2F;mount 2#enable$ rpcdebug -m nfs -s all #show all flags#disable$ rpcdebug -m nfs -c all  NFS client12echo &quot;options sunrpc tcp_slot_table_entries&#x3D;128&quot; &gt;&gt; &#x2F;e">
<meta property="og:type" content="article">
<meta property="og:title" content="nfs info">
<meta property="og:url" content="http://example.com/2018/11/13/nfs/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="nfsstat1234567$ nfsiostat -d &#x2F;mount 2#enable$ rpcdebug -m nfs -s all #show all flags#disable$ rpcdebug -m nfs -c all  NFS client12echo &quot;options sunrpc tcp_slot_table_entries&#x3D;128&quot; &gt;&gt; &#x2F;e">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-11-13T01:02:56.000Z">
<meta property="article:modified_time" content="2023-05-06T06:08:02.150Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="nfs">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>nfs info</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2018/11/13/ext4/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2018/07/29/pcie/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2018/11/13/nfs/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2018/11/13/nfs/&text=nfs info"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2018/11/13/nfs/&is_video=false&description=nfs info"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=nfs info&body=Check out this article: http://example.com/2018/11/13/nfs/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2018/11/13/nfs/&name=nfs info&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2018/11/13/nfs/&t=nfs info"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#nfsstat"><span class="toc-number">1.</span> <span class="toc-text">nfsstat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-client"><span class="toc-number">2.</span> <span class="toc-text">NFS client</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#file-lock"><span class="toc-number">2.1.</span> <span class="toc-text">file lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-could-I-found-which-file-cause-pipe-hang"><span class="toc-number">3.</span> <span class="toc-text">How could I found which file cause pipe hang</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#If-pipe-change-to-socket"><span class="toc-number">3.1.</span> <span class="toc-text">If pipe change to socket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-nfs-user-large-than-16-groups"><span class="toc-number">4.</span> <span class="toc-text">The nfs user large than 16 groups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-timeout"><span class="toc-number">5.</span> <span class="toc-text">NFS timeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-a-short-nfs-interrupt-from-network"><span class="toc-number">6.</span> <span class="toc-text">test a short nfs interrupt from network</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-case2-just-ss-log"><span class="toc-number">7.</span> <span class="toc-text">test case2 ,just ss log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfs-debug"><span class="toc-number">8.</span> <span class="toc-text">nfs debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfs-hang"><span class="toc-number">9.</span> <span class="toc-text">nfs hang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delegations-enabled"><span class="toc-number">10.</span> <span class="toc-text">delegations enabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-can%E2%80%99t-runing-LVS-over-NFS"><span class="toc-number">11.</span> <span class="toc-text">Why can’t runing LVS over NFS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rpc-srv-x2F-tcp-nfsd-got-error-4-when-sending-shutting-down-socket"><span class="toc-number">12.</span> <span class="toc-text">rpc-srv&#x2F;tcp: nfsd: got error -4 when sending shutting down socket</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        nfs info
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-11-13T01:02:56.000Z" itemprop="datePublished">2018-11-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Storage/">Storage</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/nfs/" rel="tag">nfs</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="nfsstat"><a href="#nfsstat" class="headerlink" title="nfsstat"></a>nfsstat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ nfsiostat -d /mount 2</span><br><span class="line"></span><br><span class="line"><span class="comment">#enable</span></span><br><span class="line">$ rpcdebug -m nfs -s all <span class="comment">#show all flags</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#disable</span></span><br><span class="line">$ rpcdebug -m nfs -c all</span><br></pre></td></tr></table></figure>

<h3 id="NFS-client"><a href="#NFS-client" class="headerlink" title="NFS client"></a>NFS client</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options sunrpc tcp_slot_table_entries=128&quot;</span> &gt;&gt; /etc/modprobe.d/sunrpc.conf</span><br><span class="line"><span class="comment"># the value default only 2</span></span><br></pre></td></tr></table></figure>

<h4 id="file-lock"><a href="#file-lock" class="headerlink" title="file lock"></a><a target="_blank" rel="noopener" href="https://docstore.mik.ua/orelly/networking_2ndEd/nfs/ch11_02.htm">file lock</a></h4><p>The NFS (Versions 2 and 3) protocol does not support file locking, but the NFS environment supports an ancillary protocol called NLM, which originally stood for “Network Lock Manager.” When an NFS filesystem on an NFS client gets a request to lock a file, instead of an NFS remote procedure call, it generates an NLM remote procedure call.   </p>
<p>The NLM protocol consists of remote procedure calls that pattern fcntl arguments and results. Because blocking locks are supported (a process blocks waiting for a lock that conflicts with another holder), the NLM protocol has the notion of callbacks, from the file server to the NLM client to notify that a lock is available. In this way, the NLM client sometimes acts as an RPC server in order to receive delayed results from lock calls.   </p>
<h3 id="How-could-I-found-which-file-cause-pipe-hang"><a href="#How-could-I-found-which-file-cause-pipe-hang" class="headerlink" title="How could I found which file cause pipe hang"></a>How could I found which file cause pipe hang</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /dev/zero | <span class="built_in">tee</span> /tank/the_file</span><br><span class="line">$ ps aux | grep 63488</span><br><span class="line">root      63488  5.2  0.0 107972   676 pts/9    S+   04:32   0:19 <span class="built_in">cat</span> /dev/zero</span><br><span class="line"></span><br><span class="line">$ strace -p 63488</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536) = 65536</span><br><span class="line">write(1, <span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>..., 65536</span><br><span class="line">strace: Process 63488 detached</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -l /proc/63488/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 0 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 1 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 3 -&gt; /dev/zero</span><br><span class="line">$ lsof | grep 36710085</span><br><span class="line"><span class="built_in">cat</span>        63488           root    1w     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line"><span class="built_in">tee</span>        63489           root    0r     FIFO                0,9         0t0   36710085 pipe</span><br><span class="line">$ <span class="built_in">ls</span> -l /proc/63489/fd</span><br><span class="line">total 0</span><br><span class="line">lr-x------ 1 root root 64 Mar 21 04:33 0 -&gt; pipe:[36710085]</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:33 1 -&gt; /dev/pts/9</span><br><span class="line">lrwx------ 1 root root 64 Mar 21 04:32 2 -&gt; /dev/pts/9</span><br><span class="line">l-wx------ 1 root root 64 Mar 21 04:33 3 -&gt; /tank/the_file</span><br></pre></td></tr></table></figure>
<h4 id="If-pipe-change-to-socket"><a href="#If-pipe-change-to-socket" class="headerlink" title="If pipe change to socket"></a>If pipe change to socket</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ll /proc/333709/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 0 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 10 -&gt; socket:[326105]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 11 -&gt; socket:[326106]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 3 -&gt; socket:[304292]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 4 -&gt; socket:[304294]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 5 -&gt; socket:[304295]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 6 -&gt; socket:[304296]</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 7 -&gt; socket:[304297]</span><br><span class="line">lr-x------ 1 root root 64 Mar 20 03:24 8 -&gt; /run/rpcbind.lock</span><br><span class="line">lrwx------ 1 root root 64 Mar 20 03:24 9 -&gt; socket:[334786]</span><br><span class="line"></span><br><span class="line"><span class="comment">#304294 is inode</span></span><br><span class="line">$ <span class="built_in">cat</span> /proc/net/tcp | grep -Ei <span class="string">&#x27;local_address|304294&#x27;</span></span><br><span class="line">sl  local_address rem_address   st tx_queue rx_queue <span class="built_in">tr</span> tm-&gt;when retrnsmt   uid  <span class="built_in">timeout</span> inode</span><br><span class="line">8: 00000000:006F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 304294 1 ffff9ac0e2f8be00 100 0 0 10 0</span><br></pre></td></tr></table></figure>

<h3 id="The-nfs-user-large-than-16-groups"><a href="#The-nfs-user-large-than-16-groups" class="headerlink" title="The nfs user large than 16 groups"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/17372">The nfs user large than 16 groups</a></h3><p>not support under linux kenrel 2.6.21 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add &quot;-g&quot;</span></span><br><span class="line">rpc.mountd -g </span><br><span class="line"></span><br><span class="line"><span class="comment"># redhat docs</span></span><br><span class="line">The RPC protocol<span class="string">&#x27;s AUTH_UNIX / AUTH_SYS Credentials structure limits the number of groups to 16, as specified in RFC 5531</span></span><br><span class="line"><span class="string">     struct authsys_parms &#123;</span></span><br><span class="line"><span class="string">        unsigned int stamp;</span></span><br><span class="line"><span class="string">        string machinename&lt;255&gt;;</span></span><br><span class="line"><span class="string">        unsigned int uid;</span></span><br><span class="line"><span class="string">        unsigned int gid;</span></span><br><span class="line"><span class="string">        unsigned int gids&lt;16&gt;;</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/etc/sysconfig/nfs</span></span><br><span class="line"><span class="string">RPCMOUNTDOPTS=&quot;--manage-gids&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The --manage-gids option for rpc.mountd (see man rpc.mountd) needs to be set on the NFS-server in /etc/sysconfig/nfs. The flag tells the server to ignore the 16 groups sent by the client and resolve group membership locally (NFS-server side).</span></span><br></pre></td></tr></table></figure>

<h3 id="NFS-timeout"><a href="#NFS-timeout" class="headerlink" title="NFS timeout"></a>NFS timeout</h3><p>timo&#x3D;600 (60s)<br>retrs&#x3D;2: only work with soft<br>hard: retry forever and not return error</p>
<p>if in the high latency env</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">client $ mount 192.168.0.1:/nfs_share /mnt -o hard,intr,vers=3,timeo=600,retrans=30,rsize=1048576,wsize=1048576,noacl,nocto</span><br><span class="line"></span><br><span class="line"><span class="comment">## Close-To-Open Cache Consistency</span></span><br><span class="line">nocto <span class="built_in">disable</span> Close-To-Open</span><br><span class="line"></span><br><span class="line">The NFS standard requires clients to maintain close-to-open cache coherency when multiple clients access the same files. This means flushing all file data and metadata changes when a client closes a file, and immediately and unconditionally retrieving a file<span class="string">&#x27;s attributes when it is opened via the open() system call API. In this way, changes made by one client appear as soon as a file is opened on any other client</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">http://www.citi.umich.edu/projects/nfs-perf/results/cel/dnlc.html</span></span><br></pre></td></tr></table></figure>

<h3 id="test-a-short-nfs-interrupt-from-network"><a href="#test-a-short-nfs-interrupt-from-network" class="headerlink" title="test a short nfs interrupt from network"></a>test a short nfs interrupt from network</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nfs client $ mount <span class="variable">$nfs_server</span>:/mountpoint /<span class="variable">$nfs_mount</span> -o timeo=60,retrans=2,soft</span><br><span class="line">nfs client $ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/<span class="variable">$nfs_mount</span>/write_file bs=1M </span><br><span class="line">nfs server $ iptables -A INPUT -s <span class="variable">$nfs_client_ip</span> -j DROP</span><br></pre></td></tr></table></figure>

<p>nfs client</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">nfs client $ ss -i </span><br><span class="line">tcp    ESTAB      0      1569744 nfs_client:732                  nfs_server:nfs</span><br><span class="line">	 cubic wscale:7,7 rto:201 rtt:0.827/0.127 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1140 ssthresh:749 bytes_acked:3422225317 bytes_received:3575596188 segs_out:2375575 segs_in:90001 send 15968.3Mbps pacing_rate 31931.7Mbps unacked:1040 retrans:0/3 rcv_rtt:6.875 rcv_space:9177516</span><br><span class="line"></span><br><span class="line"><span class="comment">###### --------- firewall block -----------</span></span><br><span class="line"></span><br><span class="line">tcp    ESTAB      0      408    nfs_client:732                  nfs_server:nfs</span><br><span class="line">	 cubic wscale:7,7 rto:406 backoff:1 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517451 segs_in:93659 send 5.0Mbps lastsnd:315 lastrcv:528 lastack:534 pacing_rate 11534.3Mbps unacked:1 retrans:1/5 lost:1 rcv_rtt:16 rcv_space:9177516</span><br><span class="line"></span><br><span class="line">backoff: 1,3,3,4,4,4,5,5,5,5,5,5,5, ....</span><br><span class="line">1 x 1</span><br><span class="line">2 x 3</span><br><span class="line">3 x 4</span><br><span class="line">7 x 5</span><br><span class="line">when backoff:8, I clear the firewall rule</span><br><span class="line">I don <span class="string">&#x27;t know why there is no any ss info in 2 seconds. could not the ip addra</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">These value has changed</span></span><br><span class="line"><span class="string">rtt:&lt;rtt&gt;/&lt;rttvar&gt;</span></span><br><span class="line"><span class="string">rtt is the average round trip time, rttvar is the mean deviation of rtt, their units are millisecond</span></span><br><span class="line"><span class="string">backoff:&lt;icsk_backoff&gt;</span></span><br><span class="line"><span class="string">used for exponential backoff re-transmission, the actual re-transmission timeout value is icsk_rto &lt;&lt; icsk_backoff</span></span><br><span class="line"><span class="string">rto:&lt;icsk_rto&gt;</span></span><br><span class="line"><span class="string">tcp re-transmission timeout value, the unit is millisecond</span></span><br><span class="line"><span class="string">cwnd:&lt;cwnd&gt;</span></span><br><span class="line"><span class="string">congestion window size</span></span><br><span class="line"><span class="string">ssthresh:&lt;ssthresh&gt;</span></span><br><span class="line"><span class="string">tcp congestion window slow start threshold</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">like this:</span></span><br><span class="line"><span class="string">33</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      4154312 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:12992 backoff:6 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517461 segs_in:93664 send 5.0Mbps lastsnd:10832 lastrcv:23667 lastack:23673 pacing_rate 11534.3Mbps unacked:1 retrans:1/10 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### here from ESTAB to FIN-WAIT-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">34</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:12992 backoff:6 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517461 segs_in:93664 send 5.0Mbps lastsnd:11837 lastrcv:24672 lastack:24678 pacing_rate 11534.3Mbps unacked:1 retrans:1/10 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">110</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:51968 backoff:8 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517465 segs_in:93666 send 5.0Mbps lastsnd:49203 lastrcv:101094 lastack:101100 pacing_rate 11534.3Mbps unacked:1 retrans:1/12 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">111</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:51968 backoff:8 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517465 segs_in:93666 send 5.0Mbps lastsnd:50208 lastrcv:102099 lastack:102105 pacing_rate 11534.3Mbps unacked:1 retrans:1/12 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">112</span></span><br><span class="line"><span class="string">tcp    FIN-WAIT-1 0      4154313 nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:51968 backoff:8 rtt:2.332/1.92 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:812 bytes_acked:3628610397 bytes_received:3684699536 segs_out:2517465 segs_in:93666 send 5.0Mbps lastsnd:51214 lastrcv:103105 lastack:103111 pacing_rate 11534.3Mbps unacked:1 retrans:1/12 lost:1 rcv_rtt:16 rcv_space:9177516</span></span><br><span class="line"><span class="string">113</span></span><br><span class="line"><span class="string">## TCP socket closed, reconnect</span></span><br><span class="line"><span class="string">114</span></span><br><span class="line"><span class="string">115</span></span><br><span class="line"><span class="string">116</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:66 lastrcv:66 lastack:66 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string">117</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:1071 lastrcv:1071 lastack:1071 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string">118</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:2077 lastrcv:2077 lastack:2077 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string">119</span></span><br><span class="line"><span class="string">tcp    ESTAB      0      0      nfs_client:732                  nfs_server:nfs</span></span><br><span class="line"><span class="string">         cubic wscale:7,7 rto:201 rtt:0.174/0.091 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:447 ssthresh:74 bytes_acked:54006797 bytes_received:12623248 segs_out:37874 segs_in:1288 send 29758.9Mbps lastsnd:3083 lastrcv:3083 lastack:3083 rcv_rtt:1 rcv_space:1624864</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## nfs info, add 10 rpc calls timeout in dmesg </span></span><br><span class="line"><span class="string">16</span></span><br><span class="line"><span class="string">Client rpc stats:</span></span><br><span class="line"><span class="string">calls      retrans    authrefrsh</span></span><br><span class="line"><span class="string">7170       0          7171</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">17</span></span><br><span class="line"><span class="string">Client rpc stats:</span></span><br><span class="line"><span class="string">calls      retrans    authrefrsh</span></span><br><span class="line"><span class="string">7180       0          7181</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:30 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string">[Sat Mar  7 22:14:31 2020] nfs: server nfs_server not responding, timed out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7180 x18</span></span><br><span class="line"><span class="string">7190 x18</span></span><br><span class="line"><span class="string">7191 x30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">nfs client $ dd if=/dev/zero of=/$nfs_mount/write_file bs=1M</span></span><br><span class="line"><span class="string">dd: error writing ‘t’: Input/output error</span></span><br><span class="line"><span class="string">3513+0 records in</span></span><br><span class="line"><span class="string">3512+0 records out</span></span><br><span class="line"><span class="string">3682598912 bytes (3.7 GB) copied, 120.265 s, 30.6 MB/s</span></span><br></pre></td></tr></table></figure>

<h3 id="test-case2-just-ss-log"><a href="#test-case2-just-ss-log" class="headerlink" title="test case2 ,just ss log"></a>test case2 ,just ss log</h3><p>In the 10 second, the nfs server block the client<br>the client not modify sysctl.conf, before reboot, all parameters have been commentted.<br>default value was net.ipv4.tcp_syn_retries &#x3D; 6 #in the default set, the TCP_RTO_MAX was 64s, if HZ equal 1s, the TCP_RTO_MAX equal 120s, that means you could not improve it to 128s</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tcp_syn_retries - INTEGER</span><br><span class="line">	Number of times initial SYNs for an active TCP connection attempt</span><br><span class="line">	will be retransmitted. Should not be higher than 127. Default value</span><br><span class="line">	is 6, which corresponds to 63seconds till the last retransmission</span><br><span class="line">	with the current initial RTO of 1second. With this the final timeout</span><br><span class="line">	for an active TCP connection attempt will happen after 127 seconds.</span><br><span class="line"></span><br><span class="line">#define TCP_RTO_MAX ((unsigned)(120*HZ))</span><br><span class="line">#define TCP_RTO_MIN ((unsigned)(HZ/5))</span><br></pre></td></tr></table></figure>

<p>singel cp command has been copy the file in the nfs mount point</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line">tcp    ESTAB      0      204    nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:202 rtt:1.164/0.065 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1882 ssthresh:1641 bytes_acked:6002294501 bytes_received:6019345332 segs_out:4166222 segs_in:152076 send 18729.5Mbps lastsnd:11 lastrcv:11 lastack:11 unacked:1 rcv_rtt:2 rcv_space:6157740</span><br><span class="line">9</span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:202 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1959 ssthresh:1641 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356084 segs_in:157556 send 17523.6Mbps lastsnd:157 lastrcv:162 lastack:167 unacked:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### nfs server block the client</span></span><br><span class="line"></span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:808 backoff:2 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356088 segs_in:157558 send 8.9Mbps lastsnd:554 lastrcv:1166 lastack:1171 unacked:1962 retrans:1/2 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">11</span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:1616 backoff:3 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356090 segs_in:157559 send 8.9Mbps lastsnd:750 lastrcv:2171 lastack:2176 unacked:1962 retrans:1/3 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">12</span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:3232 backoff:4 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356092 segs_in:157560 send 8.9Mbps lastsnd:134 lastrcv:3175 lastack:3180 unacked:1962 retrans:1/4 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### from 15 to 16, the ESTAB convert to FIN_WAIT-1</span></span><br><span class="line"></span><br><span class="line">tcp    ESTAB      0      3675872 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:3232 backoff:4 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356092 segs_in:157560 send 8.9Mbps lastsnd:2142 lastrcv:5183 lastack:5188 unacked:1962 retrans:1/4 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">15</span><br><span class="line">tcp    FIN-WAIT-1 0      3675873 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:3232 backoff:4 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356092 segs_in:157560 send 8.9Mbps lastsnd:3145 lastrcv:6186 lastack:6191 unacked:1962 retrans:1/4 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### From 216 to 217, the FIN-WAIT-1 convert to SYN-SENT, total 201 FIN-WAIT-1</span></span><br><span class="line"></span><br><span class="line">tcp    FIN-WAIT-1 0      3675873 nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic wscale:7,7 rto:103424 backoff:9 rtt:1.295/0.078 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:1 ssthresh:1371 bytes_acked:6273315925 bytes_received:6199765744 segs_out:4356102 segs_in:157565 send 8.9Mbps lastsnd:103531 lastrcv:206948 lastack:206953 unacked:1962 retrans:1/9 lost:1962 rcv_rtt:59.25 rcv_space:6157740</span><br><span class="line">216</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:tbrpf                nfs_server:nfs</span><br><span class="line">         cubic rto:1000 mss:524 rcvmss:88 advmss:1460 cwnd:10 segs_out:1 lastsnd:1807447 lastrcv:1807447 lastack:1807447 unacked:1</span><br><span class="line">217</span><br><span class="line"></span><br><span class="line"><span class="comment"># rto will always changed in SYN-SENT</span></span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">just output 3s number, not output any ss -i connection info</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">after 3s ,try again</span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">after 6s, try again</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">after 12s, try again</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">rto:1000 1s</span><br><span class="line">rto:2000 2s</span><br><span class="line">rto:4000 4s</span><br><span class="line">rto:8000 8s</span><br><span class="line">rto:16000 16s</span><br><span class="line">rto:32000 32s</span><br><span class="line">rto:64000 64s</span><br><span class="line">total 127s</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">tcp_syn_retries = 6 just work <span class="keyword">in</span> rto retry timer ,1s,2s,4s,8s,16s,32s,64s, modify it to 3, it work right now.</span><br><span class="line">the tcp SYN-SENT retry interval was 3s,6s,12s,24s ,after 24s , it <span class="string">&#x27;s will fix to 45s, each 45s the tcp SYN-SENT probe will be send</span></span><br><span class="line"><span class="string">I try to modify tcp_syn_retries, tcp_keepalive_intvl, tcp_retries1, tcp_retries2, tcp_synack_retries. it &#x27;</span>s not worked, always 45~46s, centos 7, 8 has the same result</span><br><span class="line"></span><br><span class="line"><span class="comment">#the same with tcpdump log, the last package time to next begin time about 49~50s, the last package rto was 4000ms, 49-4=45s</span></span><br><span class="line">02:39:28.383410 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2638733895, win 29200, options [mss 1460,sackOK,TS val 83069440 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:29.385376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2638733895, win 29200, options [mss 1460,sackOK,TS val 83070442 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:31.391375 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2638733895, win 29200, options [mss 1460,sackOK,TS val 83072448 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:39:38.407391 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2795358566, win 29200, options [mss 1460,sackOK,TS val 83079464 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:39.409376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2795358566, win 29200, options [mss 1460,sackOK,TS val 83080466 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:41.415375 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2795358566, win 29200, options [mss 1460,sackOK,TS val 83082472 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:39:51.439390 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2998983553, win 29200, options [mss 1460,sackOK,TS val 83092496 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:52.441377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2998983553, win 29200, options [mss 1460,sackOK,TS val 83093498 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:39:54.447374 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2998983553, win 29200, options [mss 1460,sackOK,TS val 83095504 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:40:10.495403 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3296733769, win 29200, options [mss 1460,sackOK,TS val 83111552 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:11.497378 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3296733769, win 29200, options [mss 1460,sackOK,TS val 83112554 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:13.503377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3296733769, win 29200, options [mss 1460,sackOK,TS val 83114560 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:40:41.599396 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3782733652, win 29200, options [mss 1460,sackOK,TS val 83142656 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:42.601376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3782733652, win 29200, options [mss 1460,sackOK,TS val 83143658 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:40:44.607377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3782733652, win 29200, options [mss 1460,sackOK,TS val 83145664 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:41:33.695391 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 301766284, win 29200, options [mss 1460,sackOK,TS val 83194752 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:41:34.697377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 301766284, win 29200, options [mss 1460,sackOK,TS val 83195754 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:41:36.703375 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 301766284, win 29200, options [mss 1460,sackOK,TS val 83197760 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:42:25.791393 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 1115766302, win 29200, options [mss 1460,sackOK,TS val 83246848 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:42:26.793376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 1115766302, win 29200, options [mss 1460,sackOK,TS val 83247850 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:42:28.799378 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 1115766302, win 29200, options [mss 1460,sackOK,TS val 83249856 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:43:17.887397 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 1929766369, win 29200, options [mss 1460,sackOK,TS val 83298944 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:43:18.889376 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 1929766369, win 29200, options [mss 1460,sackOK,TS val 83299946 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:43:20.895377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 1929766369, win 29200, options [mss 1460,sackOK,TS val 83301952 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:44:09.983399 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2743766395, win 29200, options [mss 1460,sackOK,TS val 83351040 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:44:10.985377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2743766395, win 29200, options [mss 1460,sackOK,TS val 83352042 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:44:12.991383 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 2743766395, win 29200, options [mss 1460,sackOK,TS val 83354048 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:45:02.079401 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3557766342, win 29200, options [mss 1460,sackOK,TS val 83403136 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:03.081377 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3557766342, win 29200, options [mss 1460,sackOK,TS val 83404138 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:05.087378 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 3557766342, win 29200, options [mss 1460,sackOK,TS val 83406144 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">02:45:54.175399 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 76799092, win 29200, options [mss 1460,sackOK,TS val 83455232 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:55.177379 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 76799092, win 29200, options [mss 1460,sackOK,TS val 83456234 ecr 0,nop,wscale 7], length 0</span><br><span class="line">02:45:57.183379 IP nfs_client.917 &gt; nfs_server.nfs: Flags [S], <span class="built_in">seq</span> 76799092, win 29200, options [mss 1460,sackOK,TS val 83458240 ecr 0,nop,wscale 7], length 0</span><br><span class="line"></span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:1000 mss:524 rcvmss:88 advmss:1460 cwnd:10 segs_out:1 lastsnd:83559872 lastrcv:83559872 lastack:83559872 unacked:1</span><br><span class="line">716</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83560877 lastrcv:83560877 lastack:83560877 unacked:1 retrans:1/1 lost:1</span><br><span class="line">717</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83561882 lastrcv:83561882 lastack:83561882 unacked:1 retrans:1/1 lost:1</span><br><span class="line">718</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83562886 lastrcv:83562886 lastack:83562886 unacked:1 retrans:1/2 lost:1</span><br><span class="line">719</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83563892 lastrcv:83563892 lastack:83563892 unacked:1 retrans:1/2 lost:1</span><br><span class="line">720</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83564897 lastrcv:83564897 lastack:83564897 unacked:1 retrans:1/2 lost:1</span><br><span class="line">721</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83565902 lastrcv:83565902 lastack:83565902 unacked:1 retrans:1/2 lost:1</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------&gt;&gt; after 45s, begin to try again</span></span><br><span class="line"></span><br><span class="line">767</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:1000 mss:524 rcvmss:88 advmss:1460 cwnd:10 segs_out:1 lastsnd:83612024 lastrcv:83612024 lastack:83612024 unacked:1</span><br><span class="line">768</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83613029 lastrcv:83613029 lastack:83613029 unacked:1 retrans:1/1 lost:1</span><br><span class="line">769</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:2000 backoff:1 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:2 lastsnd:83614034 lastrcv:83614034 lastack:83614034 unacked:1 retrans:1/1 lost:1</span><br><span class="line">770</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83615039 lastrcv:83615039 lastack:83615039 unacked:1 retrans:1/2 lost:1</span><br><span class="line">771</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83616043 lastrcv:83616043 lastack:83616043 unacked:1 retrans:1/2 lost:1</span><br><span class="line">772</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83617049 lastrcv:83617049 lastack:83617049 unacked:1 retrans:1/2 lost:1</span><br><span class="line">773</span><br><span class="line">tcp    SYN-SENT   0      1      nfs_client:917                  nfs_server:nfs</span><br><span class="line">	 cubic rto:4000 backoff:2 mss:524 rcvmss:88 advmss:1460 cwnd:1 ssthresh:7 segs_out:3 lastsnd:83618054 lastrcv:83618054 lastack:83618054 unacked:1 retrans:1/2 lost:1</span><br></pre></td></tr></table></figure>

<h3 id="nfs-debug"><a href="#nfs-debug" class="headerlink" title="nfs debug"></a><a target="_blank" rel="noopener" href="https://github.com/greg-js/arch-wiki-md-repo/blob/5d5d064e739729af8c070f2537eb05857358506e/wiki/_content/english/NFS-Troubleshooting.md#Close-to-open/flush-on-close">nfs debug</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -nt | grep :2049</span><br><span class="line">$  rpcdebug -v</span><br><span class="line">rpcdebug: no module name specified.</span><br><span class="line">usage: rpcdebug [-v] [-h] [-m module] [-s flags...|-c flags...]</span><br><span class="line">       <span class="built_in">set</span> or cancel debug flags.</span><br><span class="line"></span><br><span class="line">Module     Valid flags</span><br><span class="line">rpc        xprt call debug nfs auth <span class="built_in">bind</span> <span class="built_in">sched</span> trans svcsock svcdsp misc cache all</span><br><span class="line">nfs        vfs dircache lookupcache pagecache proc xdr file root callback client mount fscache pnfs pnfs_ld state all</span><br><span class="line">nfsd       sock fh <span class="built_in">export</span> svc proc fileop auth repcache xdr lockd all</span><br><span class="line">nlm        svc client clntlock svclock monitor clntsubs svcsubs hostcache xdr all (v3 only)</span><br><span class="line"></span><br><span class="line"><span class="comment">#/proc/sys/sunrpc/&#123;nfs_debug,rpc_debug&#125;</span></span><br><span class="line">$ rpcdebug -m rpc -s all    <span class="comment"># sets all debug flags for RPC</span></span><br><span class="line">$ rpcdebug -m rpc -c all    <span class="comment"># clears all debug flags for RPC</span></span><br><span class="line"></span><br><span class="line">$ rpcdebug -m nfsd -s all   <span class="comment"># sets all debug flags for NFS Server</span></span><br><span class="line">$ rpcdebug -m nfsd -c all   <span class="comment"># clears all debug flags for NFS Server</span></span><br><span class="line"></span><br><span class="line">$ mountstatics</span><br><span class="line">/proc/self/mountstats</span><br><span class="line"></span><br><span class="line">https://peteryj.github.io/2020/04/30/nfs-kernel-debug/</span><br><span class="line">sunrpc inject_fault</span><br><span class="line"><span class="comment"># cat /sys/kernel/debug/sunrpc/inject_fault</span></span><br><span class="line">0 // 代表不生效</span><br><span class="line"><span class="built_in">echo</span> 10000 &gt; /sys/kernel/debug/sunrpc/inject_fault/disconnect</span><br><span class="line"><span class="comment"># // 代表每10000个包允许过一个包，基本上等于disable发包了。</span></span><br><span class="line"><span class="built_in">where</span> <span class="string">&quot;10000&quot;</span> is a large positive number of transport method calls before a disconnect. </span><br><span class="line"></span><br><span class="line">https://patchwork.kernel.org/project/linux-nfs/patch/20150526155117.4542.31183.stgit@manet.1015granger.net/</span><br><span class="line">...</span><br><span class="line">// 超时N秒后，N取决于超时恢复时间</span><br><span class="line">...</span><br><span class="line"><span class="comment"># echo 0 &gt; /sys/kernel/debug/sunrpc/inject_fault</span></span><br></pre></td></tr></table></figure>

<p>mountstats</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">  NFS mount options: rw,vers=3,rsize=1048576,wsize=1048576,namlen=255,acregmin=3,acregmax=60,acdirmin=30,acdirmax=60,hard,nolock,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.53.44.7,mountvers=3,mountport=38465,mountproto=tcp,local_lock=all</span><br><span class="line">  NFS server capabilities: caps=0x3fc7,wtmult=4096,dtsize=32768,bsize=0,namlen=255</span><br><span class="line">  NFS security flavor: 1  pseudoflavor: 0</span><br><span class="line"></span><br><span class="line">NFS byte counts:</span><br><span class="line">  applications <span class="built_in">read</span> 4237 bytes via <span class="built_in">read</span>(2)</span><br><span class="line">  applications wrote 80211869696 bytes via write(2)</span><br><span class="line">  applications <span class="built_in">read</span> 0 bytes via O_DIRECT <span class="built_in">read</span>(2)</span><br><span class="line">  applications wrote 0 bytes via O_DIRECT write(2)</span><br><span class="line">  client <span class="built_in">read</span> 1827 bytes via NFS READ</span><br><span class="line">  client wrote 59369566208 bytes via NFS WRITE</span><br><span class="line">RPC statistics:</span><br><span class="line">  57175 RPC requests sent, 57110 RPC replies received (0 XIDs not found)</span><br><span class="line">  average backlog queue length: 0</span><br><span class="line"></span><br><span class="line">WRITE:</span><br><span class="line">	56638 ops (99%)</span><br><span class="line">	avg bytes sent per op: 1048396	avg bytes received per op: 160</span><br><span class="line">	backlog <span class="built_in">wait</span>: 54490.214220 	RTT: 317.525707 	total execute time: 54807.794431 (milliseconds)</span><br><span class="line">LOOKUP:</span><br><span class="line">	11 ops (0%) 	8 errors (72%)</span><br><span class="line">	avg bytes sent per op: 159	avg bytes received per op: 94</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.545455 	total execute time: 0.636364 (milliseconds)</span><br><span class="line">CREATE:</span><br><span class="line">	8 ops (0%)</span><br><span class="line">	avg bytes sent per op: 192	avg bytes received per op: 292</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.500000 	total execute time: 0.500000 (milliseconds)</span><br><span class="line">ACCESS:</span><br><span class="line">	5 ops (0%)</span><br><span class="line">	avg bytes sent per op: 152	avg bytes received per op: 36</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.400000 	total execute time: 0.400000 (milliseconds)</span><br><span class="line">GETATTR:</span><br><span class="line">	4 ops (0%)</span><br><span class="line">	avg bytes sent per op: 148	avg bytes received per op: 112</span><br><span class="line">	backlog <span class="built_in">wait</span>: 58.000000 	RTT: 58.250000 	total execute time: 116.250000 (milliseconds)</span><br><span class="line">FSSTAT:</span><br><span class="line">	3 ops (0%)</span><br><span class="line">	avg bytes sent per op: 148	avg bytes received per op: 168</span><br><span class="line">	backlog <span class="built_in">wait</span>: 32.000000 	RTT: 61.666667 	total execute time: 93.666667 (milliseconds)</span><br><span class="line">FSINFO:</span><br><span class="line">	2 ops (0%)</span><br><span class="line">	avg bytes sent per op: 148	avg bytes received per op: 164</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.000000 	total execute time: 0.000000 (milliseconds)</span><br><span class="line">NULL:</span><br><span class="line">	1 ops (0%)</span><br><span class="line">	avg bytes sent per op: 44	avg bytes received per op: 24</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.000000 	total execute time: 0.000000 (milliseconds)</span><br><span class="line">READ:</span><br><span class="line">	1 ops (0%)</span><br><span class="line">	avg bytes sent per op: 160	avg bytes received per op: 1872</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.000000 	total execute time: 0.000000 (milliseconds)</span><br><span class="line">MKDIR:</span><br><span class="line">	1 ops (0%)</span><br><span class="line">	avg bytes sent per op: 192	avg bytes received per op: 292</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 2.000000 	total execute time: 2.000000 (milliseconds)</span><br><span class="line">PATHCONF:</span><br><span class="line">	1 ops (0%)</span><br><span class="line">	avg bytes sent per op: 148	avg bytes received per op: 140</span><br><span class="line">	backlog <span class="built_in">wait</span>: 0.000000 	RTT: 0.000000 	total execute time: 0.000000 (milliseconds)</span><br></pre></td></tr></table></figure>

<p>Linux kernel</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/sunrpc/nfsd_debug</span><br><span class="line">/proc/sys/sunrpc/nfs_debug</span><br><span class="line">/proc/sys/sunrpc/nlm_debug</span><br><span class="line">/proc/sys/sunrpc/rpc_debug</span><br><span class="line"></span><br><span class="line">sysctl -w sunrpc.rpc_debug=1023</span><br><span class="line">sysctl -w sunrpc.rpc_debug=0</span><br><span class="line"></span><br><span class="line">sysctl -w sunrpc.nfsd_debug=1023</span><br><span class="line">sysctl -w sunrpc.nfsd_debug=0</span><br><span class="line"></span><br><span class="line">sysctl sunrpc.rpc_debug=0xFFFF</span><br><span class="line"></span><br><span class="line">grep . /proc/net/rpc/*/content</span><br><span class="line"><span class="built_in">cat</span> /proc/fs/nfs/exports</span><br><span class="line"><span class="built_in">cat</span> /proc/net/rpc/nfsd</span><br><span class="line"><span class="built_in">ls</span> -l /proc/fs/nfsd</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * NFS debug flags</span><br><span class="line"> */</span><br><span class="line">#define NFSDBG_VFS              0x0001</span><br><span class="line">#define NFSDBG_DIRCACHE         0x0002</span><br><span class="line">#define NFSDBG_LOOKUPCACHE      0x0004</span><br><span class="line">#define NFSDBG_PAGECACHE        0x0008</span><br><span class="line">#define NFSDBG_PROC             0x0010</span><br><span class="line">#define NFSDBG_XDR              0x0020</span><br><span class="line">#define NFSDBG_FILE             0x0040</span><br><span class="line">#define NFSDBG_ROOT             0x0080</span><br><span class="line">#define NFSDBG_CALLBACK         0x0100</span><br><span class="line">#define NFSDBG_CLIENT           0x0200</span><br><span class="line">#define NFSDBG_MOUNT            0x0400</span><br><span class="line">#define NFSDBG_FSCACHE          0x0800</span><br><span class="line">#define NFSDBG_PNFS             0x1000</span><br><span class="line">#define NFSDBG_PNFS_LD          0x2000</span><br><span class="line">#define NFSDBG_STATE            0x4000</span><br><span class="line">#define NFSDBG_ALL              0xFFFF</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Debug flags</span><br><span class="line"> */</span><br><span class="line">#define NLMDBG_SVC		0x0001</span><br><span class="line">#define NLMDBG_CLIENT		0x0002</span><br><span class="line">#define NLMDBG_CLNTLOCK		0x0004</span><br><span class="line">#define NLMDBG_SVCLOCK		0x0008</span><br><span class="line">#define NLMDBG_MONITOR		0x0010</span><br><span class="line">#define NLMDBG_CLNTSUBS		0x0020</span><br><span class="line">#define NLMDBG_SVCSUBS		0x0040</span><br><span class="line">#define NLMDBG_HOSTCACHE	0x0080</span><br><span class="line">#define NLMDBG_XDR		0x0100</span><br><span class="line">#define NLMDBG_ALL		0x7fff</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * RPC debug facilities</span><br><span class="line"> */</span><br><span class="line">#define RPCDBG_XPRT             0x0001</span><br><span class="line">#define RPCDBG_CALL             0x0002</span><br><span class="line">#define RPCDBG_DEBUG            0x0004</span><br><span class="line">#define RPCDBG_NFS              0x0008</span><br><span class="line">#define RPCDBG_AUTH             0x0010</span><br><span class="line">#define RPCDBG_BIND             0x0020</span><br><span class="line">#define RPCDBG_SCHED            0x0040</span><br><span class="line">#define RPCDBG_TRANS            0x0080</span><br><span class="line">#define RPCDBG_SVCXPRT          0x0100</span><br><span class="line">#define RPCDBG_SVCDSP           0x0200</span><br><span class="line">#define RPCDBG_MISC             0x0400</span><br><span class="line">#define RPCDBG_CACHE            0x0800</span><br><span class="line">#define RPCDBG_ALL              0x7fff</span><br></pre></td></tr></table></figure>

<h3 id="nfs-hang"><a href="#nfs-hang" class="headerlink" title="nfs hang"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/2245341">nfs hang</a></h3><ul>
<li>NFS doesn’t expect requests with wb_bytes set to zero and may make unexpected decisions about how to handle that request at the page IO layer.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">The stuck process will be have called nfs_wait_bit_uninterruptible from a write path and under nfs_updatepage. The process is waiting inside nfs_wait_on_request <span class="keyword">for</span> PG_BUSY (bit 0) to clear <span class="keyword">in</span> wb_flags.</span><br><span class="line">The struct nfs_page involve contains the following fields and valus:</span><br><span class="line">wb_flags: PG_BUSY (bit 0), PG_MAPPED (bit 1), PG_INODE_REF (bit 4)</span><br><span class="line">wb_list: empty</span><br><span class="line">wb_bytes: 0</span><br><span class="line"></span><br><span class="line">crash&gt; sys | grep RELEASE</span><br><span class="line">     RELEASE: 3.10.0-229.14.1.el7.x86_64</span><br><span class="line">crash&gt; ps -m | grep UN</span><br><span class="line">[ 0 19:58:08.608] [UN]  PID: 49425  TASK: ffff8840836738e0  CPU: 9   COMMAND: <span class="string">&quot;ascp&quot;</span></span><br><span class="line">crash&gt; <span class="built_in">set</span> 49425</span><br><span class="line">    PID: 49425</span><br><span class="line">COMMAND: <span class="string">&quot;ascp&quot;</span></span><br><span class="line">   TASK: ffff8840836738e0  [THREAD_INFO: ffff88418bc8c000]</span><br><span class="line">    CPU: 9</span><br><span class="line">  STATE: TASK_UNINTERRUPTIBLE|TASK_TRACED|EXIT_DEAD</span><br><span class="line">crash&gt; bt</span><br><span class="line">PID: 49425  TASK: ffff8840836738e0  CPU: 9   COMMAND: <span class="string">&quot;ascp&quot;</span></span><br><span class="line"> <span class="comment">#0 [ffff88418bc8fa58] __schedule at ffffffff816092dd</span></span><br><span class="line"> <span class="comment">#1 [ffff88418bc8fac0] io_schedule at ffffffff81609b3d</span></span><br><span class="line"> <span class="comment">#2 [ffff88418bc8fad8] nfs_wait_bit_uninterruptible at ffffffffa05145ae [nfs]</span></span><br><span class="line"> <span class="comment">#3 [ffff88418bc8fae8] __wait_on_bit at ffffffff81607910</span></span><br><span class="line"> <span class="comment">#4 [ffff88418bc8fb28] out_of_line_wait_on_bit at ffffffff816079c7</span></span><br><span class="line"> <span class="comment">#5 [ffff88418bc8fb98] nfs_wait_on_request at ffffffffa0515ad3 [nfs]</span></span><br><span class="line"> <span class="comment">#6 [ffff88418bc8fba8] nfs_updatepage at ffffffffa051a351 [nfs]</span></span><br><span class="line"> <span class="comment">#7 [ffff88418bc8fc08] nfs_write_end at ffffffffa050ac11 [nfs]</span></span><br><span class="line"> <span class="comment">#8 [ffff88418bc8fc58] generic_file_buffered_write at ffffffff811568c4</span></span><br><span class="line"> <span class="comment">#9 [ffff88418bc8fd20] __generic_file_aio_write at ffffffff811589c5</span></span><br><span class="line"><span class="comment">#10 [ffff88418bc8fd98] generic_file_aio_write at ffffffff81158c2d</span></span><br><span class="line"><span class="comment">#11 [ffff88418bc8fdd8] nfs_file_write at ffffffffa0509d1b [nfs]</span></span><br><span class="line"><span class="comment">#12 [ffff88418bc8fe20] do_sync_write at ffffffff811c61fd</span></span><br><span class="line"><span class="comment">#13 [ffff88418bc8fef8] vfs_write at ffffffff811c699d</span></span><br><span class="line"><span class="comment">#14 [ffff88418bc8ff38] sys_write at ffffffff811c73e8</span></span><br><span class="line"><span class="comment">#15 [ffff88418bc8ff80] system_call_fastpath at ffffffff81614389</span></span><br><span class="line">    RIP: 00007f52d68d61cd  RSP: 00007f52ccf34e30  RFLAGS: 00000202</span><br><span class="line">    RAX: 0000000000000001  RBX: ffffffff81614389  RCX: 00000000013b9ce2</span><br><span class="line">    RDX: 0000000000010000  RSI: 00007f52c9601210  RDI: 0000000000000007</span><br><span class="line">    RBP: 00007f52bc000a60   R8: 00000006ceee8600   R9: 0000000000000575</span><br><span class="line">    R10: 0000000003ee0001  R11: 0000000000000293  R12: 00007f52c9601210</span><br><span class="line">    R13: 0000000000010000  R14: 0000000000010000  R15: 00007f52ccf34d60</span><br><span class="line">    ORIG_RAX: 0000000000000001  CS: 0033  SS: 002b</span><br><span class="line"></span><br><span class="line">include/linux/nfs_page.h</span><br><span class="line">21 /*</span><br><span class="line">22  * Valid flags <span class="keyword">for</span> a dirty buffer</span><br><span class="line">23  */</span><br><span class="line">24 enum &#123;</span><br><span class="line">25--&gt;   PG_BUSY = 0,        /* nfs_&#123;un&#125;lock_request */</span><br><span class="line">26  PG_MAPPED,      /* page private <span class="built_in">set</span> <span class="keyword">for</span> buffered io */</span><br><span class="line">27  PG_CLEAN,       /* write succeeded */</span><br><span class="line">28  PG_COMMIT_TO_DS,    /* used by pnfs layouts */</span><br><span class="line">29  PG_INODE_REF,       /* extra ref held by inode when <span class="keyword">in</span> writeback */</span><br><span class="line">30  PG_HEADLOCK,        /* page group lock of wb_head */</span><br><span class="line">31  PG_TEARDOWN,        /* page group <span class="built_in">sync</span> <span class="keyword">for</span> destroy */</span><br><span class="line">32  PG_UNLOCKPAGE,      /* page group <span class="built_in">sync</span> bit <span class="keyword">in</span> <span class="built_in">read</span> path */</span><br><span class="line">33  PG_UPTODATE,        /* page group <span class="built_in">sync</span> bit <span class="keyword">in</span> <span class="built_in">read</span> path */</span><br><span class="line">34  PG_WB_END,      /* page group <span class="built_in">sync</span> bit <span class="keyword">in</span> write path */</span><br><span class="line">35  PG_REMOVE,      /* page group <span class="built_in">sync</span> bit <span class="keyword">in</span> write path */</span><br><span class="line">36 &#125;;</span><br><span class="line"></span><br><span class="line">fs/nfs/pagelist.c</span><br><span class="line">460 /**</span><br><span class="line">461  * nfs_wait_on_request - Wait <span class="keyword">for</span> a request to complete.</span><br><span class="line">462  * @req: request to <span class="built_in">wait</span> upon.</span><br><span class="line">463  *</span><br><span class="line">464  * Interruptible by fatal signals only.</span><br><span class="line">465  * The user is responsible <span class="keyword">for</span> holding a count on the request.</span><br><span class="line">466  */</span><br><span class="line">467 int</span><br><span class="line">468 nfs_wait_on_request(struct nfs_page *req)</span><br><span class="line">469 &#123;</span><br><span class="line">470--&gt;  <span class="built_in">return</span> wait_on_bit(&amp;req-&gt;wb_flags, PG_BUSY,</span><br><span class="line">471             nfs_wait_bit_uninterruptible,</span><br><span class="line">472             TASK_UNINTERRUPTIBLE);</span><br><span class="line">473 &#125;</span><br><span class="line">Get the nfs_page and the relevant field values. The nfs_page * is inside r15 == rdi prior to calling nfs_wait_on_request</span><br><span class="line">Then r15 is the second push on the stack inside __wait_on_bit</span><br><span class="line">Raw</span><br><span class="line">PID: 49425  TASK: ffff8840836738e0  CPU: 9   COMMAND: <span class="string">&quot;ascp&quot;</span></span><br><span class="line"> <span class="comment">#0 [ffff88418bc8fa58] __schedule at ffffffff816092dd</span></span><br><span class="line"> <span class="comment">#1 [ffff88418bc8fac0] io_schedule at ffffffff81609b3d</span></span><br><span class="line"> <span class="comment">#2 [ffff88418bc8fad8] nfs_wait_bit_uninterruptible at ffffffffa05145ae [nfs]</span></span><br><span class="line"> <span class="comment">#3 [ffff88418bc8fae8] __wait_on_bit at ffffffff81607910</span></span><br><span class="line"> <span class="comment">#4 [ffff88418bc8fb28] out_of_line_wait_on_bit at ffffffff816079c7</span></span><br><span class="line"> <span class="comment">#5 [ffff88418bc8fb98] nfs_wait_on_request at ffffffffa0515ad3 [nfs]</span></span><br><span class="line"> <span class="comment">#6 [ffff88418bc8fba8] nfs_updatepage at ffffffffa051a351 [nfs]</span></span><br><span class="line"></span><br><span class="line">crash&gt; <span class="built_in">print</span> nfs_wait_on_request</span><br><span class="line"><span class="variable">$10</span> = &#123;int (struct nfs_page *)&#125; 0xffffffffa0515aa0 &lt;nfs_wait_on_request&gt;</span><br><span class="line">crash&gt; dis -r ffffffffa051a351 | <span class="built_in">tail</span></span><br><span class="line">0xffffffffa051a32a &lt;nfs_updatepage+250&gt;:        jb     0xffffffffa051a588 &lt;nfs_updatepage+856&gt;</span><br><span class="line">0xffffffffa051a330 &lt;nfs_updatepage+256&gt;:        lock btsl <span class="variable">$0x0</span>,0x40(%r15)</span><br><span class="line">0xffffffffa051a337 &lt;nfs_updatepage+263&gt;:        sbb    %eax,%eax</span><br><span class="line">0xffffffffa051a339 &lt;nfs_updatepage+265&gt;:        <span class="built_in">test</span>   %eax,%eax</span><br><span class="line">0xffffffffa051a33b &lt;nfs_updatepage+267&gt;:        je     0xffffffffa051a7a9 &lt;nfs_updatepage+1401&gt;</span><br><span class="line">0xffffffffa051a341 &lt;nfs_updatepage+273&gt;:        mov    %r12,%rdi</span><br><span class="line">0xffffffffa051a344 &lt;nfs_updatepage+276&gt;:        callq  0xffffffff8160b620 &lt;_raw_spin_unlock&gt;</span><br><span class="line">0xffffffffa051a349 &lt;nfs_updatepage+281&gt;:        mov    %r15,%rdi   &lt;--- struct nfs_page *</span><br><span class="line">0xffffffffa051a34c &lt;nfs_updatepage+284&gt;:        callq  0xffffffffa0515aa0 &lt;nfs_wait_on_request&gt;</span><br><span class="line">crash&gt; dis nfs_wait_on_request | grep r15</span><br><span class="line">crash&gt; dis out_of_line_wait_on_bit | grep r15</span><br><span class="line">crash&gt; dis __wait_on_bit | grep r15</span><br><span class="line">0xffffffff816078b9 &lt;__wait_on_bit+9&gt;:   push   %r15</span><br><span class="line">crash&gt; dis __wait_on_bit | <span class="built_in">head</span></span><br><span class="line">0xffffffff816078b0 &lt;__wait_on_bit&gt;:     nopl   0x0(%rax,%rax,1) [FTRACE NOP]</span><br><span class="line">0xffffffff816078b5 &lt;__wait_on_bit+5&gt;:   push   %rbp</span><br><span class="line">0xffffffff816078b6 &lt;__wait_on_bit+6&gt;:   mov    %rsp,%rbp</span><br><span class="line">0xffffffff816078b9 &lt;__wait_on_bit+9&gt;:   push   %r15  &lt;--- 2nd push</span><br><span class="line"></span><br><span class="line">crash&gt; bt -f | grep out_of_line_wait_on_bit</span><br><span class="line"> <span class="comment">#4 [ffff88418bc8fb28] out_of_line_wait_on_bit at ffffffff816079c7</span></span><br><span class="line">crash&gt; px (0xffff88418bc8fb28 - 2*8)</span><br><span class="line"><span class="variable">$13</span> = 0xffff88418bc8fb18</span><br><span class="line">crash&gt; rd 0xffff88418bc8fb18</span><br><span class="line">ffff88418bc8fb18:  ffff8841a3abc100                    ....A...</span><br><span class="line">crash&gt; struct -x nfs_page ffff8841a3abc100</span><br><span class="line">struct nfs_page &#123;</span><br><span class="line">  wb_list = &#123;</span><br><span class="line">    next = 0xffff8841a3abc100, </span><br><span class="line">    prev = 0xffff8841a3abc100</span><br><span class="line">  &#125;, </span><br><span class="line">  wb_page = 0xffffea0190c806c0, </span><br><span class="line">  wb_context = 0xffff8840efb36900, </span><br><span class="line">  wb_lock_context = 0xffff8840efb36900, </span><br><span class="line">  wb_index = 0x6ceef6, </span><br><span class="line">  wb_offset = 0x0, </span><br><span class="line">  wb_pgbase = 0x0, </span><br><span class="line">  wb_bytes = 0x0, </span><br><span class="line">  wb_kref = &#123;</span><br><span class="line">    refcount = &#123;</span><br><span class="line">      counter = 0x3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  wb_flags = 0x13, </span><br><span class="line">  wb_verf = &#123;</span><br><span class="line">    data = <span class="string">&quot;\000\000\000\000\000\000\000&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  wb_this_page = 0xffff8841a3abc100, </span><br><span class="line">  wb_head = 0xffff8841a3abc100</span><br><span class="line">&#125;</span><br><span class="line">crash&gt; <span class="built_in">eval</span> -b 0x13 | grep bits</span><br><span class="line">   bits <span class="built_in">set</span>: 4 1 0 </span><br><span class="line">crash&gt; p &amp;((struct nfs_page *)0xffff8841a3abc100)-&gt;wb_list</span><br><span class="line"><span class="variable">$14</span> = (struct list_head *) 0xffff8841a3abc100</span><br><span class="line">crash&gt; list -H 0xffff8841a3abc100</span><br><span class="line">(empty)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="delegations-enabled"><a href="#delegations-enabled" class="headerlink" title="delegations enabled"></a>delegations enabled</h3><ul>
<li>leases-enable &#x3D;&#x3D; 1 (default, enabled)   <ul>
<li>When delegations are enabled(1), the NFS server will hold on to data structures involving files even after the file is closed as long as the NFS client has not sent a DELEGRETURN. The NFS client does not return DELEGATIONS until the DELEGATION backing a file has been idle for at least 2&#x2F;3 * nfs4leasetime.</li>
<li>If delegations are not enabled, the NFS server frees the data structures involving files as soon as a file is closed because it does not have to wait for a DELEGRETURN to free the file.</li>
</ul>
</li>
</ul>
<h3 id="Why-can’t-runing-LVS-over-NFS"><a href="#Why-can’t-runing-LVS-over-NFS" class="headerlink" title="Why can’t runing LVS over NFS"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385643846">Why can’t runing LVS over NFS</a></h3><h3 id="rpc-srv-x2F-tcp-nfsd-got-error-4-when-sending-shutting-down-socket"><a href="#rpc-srv-x2F-tcp-nfsd-got-error-4-when-sending-shutting-down-socket" class="headerlink" title="rpc-srv&#x2F;tcp: nfsd: got error -4 when sending shutting down socket"></a>rpc-srv&#x2F;tcp: nfsd: got error -4 when sending shutting down socket</h3><p>looks like could inject this part to exit the tcp socket</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * svc_tcp_sendto - Send out a reply on a TCP socket</span></span><br><span class="line"><span class="comment"> * @rqstp: completed svc_rqst</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * xpt_mutex ensures @rqstp&#x27;s whole message is written to the socket</span></span><br><span class="line"><span class="comment"> * without interruption.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns the number of bytes sent, or a negative errno.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">svc_tcp_sendto</span><span class="params">(<span class="keyword">struct</span> svc_rqst *rqstp)</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">out_close:</span><br><span class="line">        <span class="title function_">pr_notice</span><span class="params">(<span class="string">&quot;rpc-srv/tcp: %s: %s %d when sending %d bytes - shutting down socket\n&quot;</span>,</span></span><br><span class="line"><span class="params">                  xprt-&gt;xpt_server-&gt;sv_name,</span></span><br><span class="line"><span class="params">                  (err &lt; <span class="number">0</span>) ? <span class="string">&quot;got error&quot;</span> : <span class="string">&quot;sent&quot;</span>,</span></span><br><span class="line"><span class="params">                  (err &lt; <span class="number">0</span>) ? err : sent, xdr-&gt;len)</span>;</span><br><span class="line">        set_bit(XPT_CLOSE, &amp;xprt-&gt;xpt_flags);</span><br><span class="line">        svc_xprt_enqueue(xprt);</span><br><span class="line">        mutex_unlock(&amp;xprt-&gt;xpt_mutex);</span><br><span class="line">        <span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#nfsstat"><span class="toc-number">1.</span> <span class="toc-text">nfsstat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-client"><span class="toc-number">2.</span> <span class="toc-text">NFS client</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#file-lock"><span class="toc-number">2.1.</span> <span class="toc-text">file lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-could-I-found-which-file-cause-pipe-hang"><span class="toc-number">3.</span> <span class="toc-text">How could I found which file cause pipe hang</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#If-pipe-change-to-socket"><span class="toc-number">3.1.</span> <span class="toc-text">If pipe change to socket</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-nfs-user-large-than-16-groups"><span class="toc-number">4.</span> <span class="toc-text">The nfs user large than 16 groups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-timeout"><span class="toc-number">5.</span> <span class="toc-text">NFS timeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-a-short-nfs-interrupt-from-network"><span class="toc-number">6.</span> <span class="toc-text">test a short nfs interrupt from network</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-case2-just-ss-log"><span class="toc-number">7.</span> <span class="toc-text">test case2 ,just ss log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfs-debug"><span class="toc-number">8.</span> <span class="toc-text">nfs debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfs-hang"><span class="toc-number">9.</span> <span class="toc-text">nfs hang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delegations-enabled"><span class="toc-number">10.</span> <span class="toc-text">delegations enabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-can%E2%80%99t-runing-LVS-over-NFS"><span class="toc-number">11.</span> <span class="toc-text">Why can’t runing LVS over NFS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rpc-srv-x2F-tcp-nfsd-got-error-4-when-sending-shutting-down-socket"><span class="toc-number">12.</span> <span class="toc-text">rpc-srv&#x2F;tcp: nfsd: got error -4 when sending shutting down socket</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2018/11/13/nfs/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2018/11/13/nfs/&text=nfs info"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2018/11/13/nfs/&is_video=false&description=nfs info"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=nfs info&body=Check out this article: http://example.com/2018/11/13/nfs/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2018/11/13/nfs/&title=nfs info"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2018/11/13/nfs/&name=nfs info&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2018/11/13/nfs/&t=nfs info"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

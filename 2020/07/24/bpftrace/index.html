<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="repoenv123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899$ BP">
<meta property="og:type" content="article">
<meta property="og:title" content="bpftrace">
<meta property="og:url" content="http://example.com/2020/07/24/bpftrace/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="repoenv123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899$ BP">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-07-24T06:13:15.000Z">
<meta property="article:modified_time" content="2023-10-07T05:40:06.092Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="trace">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>bpftrace</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/09/17/ftrace/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2020/06/01/mdadm/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/07/24/bpftrace/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/07/24/bpftrace/&text=bpftrace"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/07/24/bpftrace/&is_video=false&description=bpftrace"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=bpftrace&body=Check out this article: http://example.com/2020/07/24/bpftrace/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/07/24/bpftrace/&name=bpftrace&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/07/24/bpftrace/&t=bpftrace"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#repo"><span class="toc-number">1.</span> <span class="toc-text">repo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#env"><span class="toc-number">2.</span> <span class="toc-text">env</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list-event"><span class="toc-number">3.</span> <span class="toc-text">list_event</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#example"><span class="toc-number">4.</span> <span class="toc-text">example</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-nested"><span class="toc-number">4.1.</span> <span class="toc-text">struct nested</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-file-name"><span class="toc-number">4.2.</span> <span class="toc-text">Show file name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show-the-path"><span class="toc-number">4.3.</span> <span class="toc-text">show the path</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-I-O"><span class="toc-number">4.4.</span> <span class="toc-text">trace I&#x2F;O </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-user-space-application"><span class="toc-number">4.5.</span> <span class="toc-text">trace user space application</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#userspace-example"><span class="toc-number">4.5.1.</span> <span class="toc-text">userspace example</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tracepoint"><span class="toc-number">5.</span> <span class="toc-text">Tracepoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Tracepoint-example"><span class="toc-number">5.1.</span> <span class="toc-text">Tracepoint example</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#example2"><span class="toc-number">5.1.1.</span> <span class="toc-text">example2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kprobe"><span class="toc-number">6.</span> <span class="toc-text">kprobe</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#test-the-kprobe-sample-codes"><span class="toc-number">6.1.</span> <span class="toc-text">test the kprobe sample codes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inject-function"><span class="toc-number">6.2.</span> <span class="toc-text">inject function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#debug-example"><span class="toc-number">6.3.</span> <span class="toc-text">debug example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stap"><span class="toc-number">7.</span> <span class="toc-text">stap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#stap-inject-the-block-level-latency"><span class="toc-number">7.0.1.</span> <span class="toc-text">stap inject the block level latency</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        bpftrace
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-07-24T06:13:15.000Z" itemprop="datePublished">2020-07-24</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Debug/">Debug</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/debug/" rel="tag">debug</a>, <a class="tag-link-link" href="/tags/trace/" rel="tag">trace</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="repo"><a href="#repo" class="headerlink" title="repo"></a><a target="_blank" rel="noopener" href="https://repos.baslab.org/bpftools/x86_64/">repo</a></h3><h3 id="env"><a href="#env" class="headerlink" title="env"></a>env</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">$ BPFTRACE_STRLEN=200 bpftrace ./your_bpf.bt</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"><span class="comment">###  basic</span></span><br><span class="line">```gawk</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;profile:hz:99 /pid == 20071/ &#123; @[ustack] = count(); &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">@start[tid] = (nsecs, args-&gt;<span class="built_in">id</span>);</span><br><span class="line">.....</span><br><span class="line"><span class="variable">$start_t</span> = @start[tid].0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#multiple parameters </span></span><br><span class="line">$ bpftrace -e  <span class="string">&#x27;kprobe:osc_checksum_bulk_rw,kprobe:osc_checksum_bulk_t10pi,kprobe:obd_cksum_type_pack&#123; @[kstack, comm] = count(); &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;BEGIN &#123; $t = (1, 2, &quot;string&quot;); printf(&quot;%d %d %s\n&quot;,$t.0, $t.1, $t.2); &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">1 2 string</span><br><span class="line"></span><br><span class="line">bpftrace -e <span class="string">&#x27;BEGIN &#123; $x = 1&lt;&lt;16; printf(&quot;%d %d\n&quot;, (uint16)$x, $x); &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">0 65536</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb -q /usr/lib/debug/boot/vmlinux-`uname -r` --ex &#x27;disassemble do_sys_open&#x27;</span></span><br><span class="line">Reading symbols from /usr/lib/debug/boot/vmlinux-5.0.0-32-generic...done.</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> do_sys_open:</span><br><span class="line">   0xffffffff812b2ed0 &lt;+0&gt;:     callq  0xffffffff81c01820 &lt;__fentry__&gt;</span><br><span class="line">   0xffffffff812b2ed5 &lt;+5&gt;:     push   %rbp</span><br><span class="line">   0xffffffff812b2ed6 &lt;+6&gt;:     mov    %rsp,%rbp</span><br><span class="line">   0xffffffff812b2ed9 &lt;+9&gt;:     push   %r15</span><br><span class="line">...</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;kprobe:do_sys_open+9 &#123; printf(&quot;in here\n&quot;); &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line"><span class="keyword">in</span> here</span><br><span class="line"></span><br><span class="line"><span class="comment">#print args</span></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;BEGIN &#123; printf(&quot;I got %d, %s (%d args)\n&quot;, $1, str($2), $#); &#125;&#x27;</span> 42 <span class="string">&quot;hello&quot;</span></span><br><span class="line">I got 42, hello (2 args)</span><br><span class="line"></span><br><span class="line"><span class="comment">#args</span></span><br><span class="line"><span class="comment">#!/usr/local/bin/bpftrace</span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O sizes &gt; %d bytes\n&quot;</span>, <span class="variable">$1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">/args-&gt;bytes &gt; <span class="variable">$1</span>/</span><br><span class="line">&#123;</span><br><span class="line">        @ = hist(args-&gt;bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## that means args-&gt;bytes</span></span><br><span class="line">$ bpftrace -lv tracepoint:block:block_rq_issue</span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">    dev_t dev;</span><br><span class="line">    sector_t sector;</span><br><span class="line">    unsigned int nr_sector;</span><br><span class="line">    unsigned int bytes;</span><br><span class="line">    char rwbs[8];</span><br><span class="line">    char <span class="built_in">comm</span>[16];</span><br><span class="line">    __data_loc char[] cmd;</span><br><span class="line"></span><br><span class="line">bpftrace -e <span class="string">&#x27;BEGIN &#123; printf(&quot;%s\n&quot;, str(*kaddr(&quot;usbcore_name&quot;))); &#125;&#x27;</span></span><br><span class="line">const char *usbcore_name = <span class="string">&quot;usbcore&quot;</span>;</span><br><span class="line"></span><br><span class="line">BPFTRACE_STRLEN=200 bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_enter_write /pid == 23506/</span></span><br><span class="line"><span class="string">    &#123; printf(&quot;&lt;%s&gt;\n&quot;, str(args-&gt;buf, args-&gt;count)); &#125;&#x27;</span></span><br><span class="line"><span class="comment">#demo </span></span><br><span class="line"><span class="comment">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_open /comm == <span class="string">&quot;dd&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        @start[tid] = nsecs;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open path: %s, &quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br><span class="line">kretprobe:vfs_open /comm == <span class="string">&quot;dd&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; pid: %d, comm: %s, open take time: %d \n&quot;</span>, pid, <span class="built_in">comm</span>, (nsecs-@start[tid]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:vfs_write /comm == <span class="string">&quot;dd&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        @wstart[tid] = nsecs;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write path: %s, &quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:vfs_write /comm == <span class="string">&quot;dd&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; pid: %d, comm: %s, write take time: %d \n&quot;</span>, pid, <span class="built_in">comm</span>, (nsecs-@wstart[tid]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END &#123;</span><br><span class="line">clear(@wstart); clear(@start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="list-event"><a href="#list-event" class="headerlink" title="list_event"></a>list_event</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -l</span><br><span class="line">$ bpftrace -l <span class="string">&#x27;*sleep*&#x27;</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;tracepoint:syscalls:sys_enter_*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#args is a pointer to a struct containing all the tracepoint arguments. This struct is automatically generated by bpftrace based tracepoint information. The members of this struct can be found with </span></span><br><span class="line">$ bpftrace -lv tracepoint:syscalls:sys_enter_open </span><br><span class="line">tracepoint:syscalls:sys_enter_open</span><br><span class="line">    int __syscall_nr;</span><br><span class="line">    const char * filename;</span><br><span class="line">    int flags;</span><br><span class="line">    umode_t mode;</span><br><span class="line"></span><br><span class="line"><span class="comment"># If BTF is available, it is also possible to list struct/union/emum definitions. For example:</span></span><br><span class="line">$ bpftrace -lv <span class="string">&quot;struct path&quot;</span></span><br><span class="line">BTF: using data from /sys/kernel/btf/vmlinux</span><br><span class="line">struct path &#123;</span><br><span class="line">        struct vfsmount *mnt;</span><br><span class="line">        struct dentry *dentry;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@name   global</span><br><span class="line">@name[key]      <span class="built_in">hash</span></span><br><span class="line">@name[tid]      thread-local</span><br><span class="line"><span class="variable">$name</span>   scratch</span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># Timing Reads by Process</span></span><br><span class="line">                  ------Probe Types, Kernel dynamic <span class="keyword">function</span> instrumentation</span><br><span class="line">                  |                 ---------thread-local Variable, custom</span><br><span class="line">                  |                 |       -------------Builtin Variable</span><br><span class="line">                  |                 |       |      ---Builtin Variable                                ---Builtin Variable                    ---Builtin Function</span><br><span class="line">                  |                 |       |      |                                                  |            |                         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;kprobe:vfs_read &#123; @tttstart[tid] = nsecs; &#125; kretprobe:vfs_read /@tttstart[tid]/ &#123; @ns[comm] = hist(nsecs - @tttstart[tid]); delete(@tttstart[tid]); &#125;&#x27;</span></span><br><span class="line">                                                            |                                                 |</span><br><span class="line">                                                            |                                                 ---Builtin Function</span><br><span class="line">                                                            ---Probe Types, Kernel dynamic <span class="keyword">function</span> <span class="built_in">return</span> instrumentation</span><br></pre></td></tr></table></figure>

<h4 id="struct-nested"><a href="#struct-nested" class="headerlink" title="struct nested"></a>struct nested</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; struct sock | grep sk_lock</span><br><span class="line">    socket_lock_t sk_lock;</span><br><span class="line">                    |</span><br><span class="line">                    -----------</span><br><span class="line">crash&gt; struct socket_lock_t   |</span><br><span class="line">typedef struct &#123;              |</span><br><span class="line">    spinlock_t slock;         |</span><br><span class="line">    int owned;----------------|</span><br><span class="line">    wait_queue_head_t wq;     |</span><br><span class="line">&#125; socket_lock_t;              |</span><br><span class="line">SIZE: 32          ------------</span><br><span class="line">                  |     |</span><br><span class="line"><span class="variable">$ulock</span> = <span class="variable">$sk</span>-&gt;sk_lock.owned;</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;net/sock.h&gt;</span></span><br><span class="line"></span><br><span class="line">k:tcp_delack_timer</span><br><span class="line">&#123;</span><br><span class="line">        @sk[tid] = arg0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kr:tcp_delack_timer</span><br><span class="line">/@sk[tid]/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$sk</span> = (struct sock *)@sk[tid];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$af</span> = <span class="variable">$sk</span>-&gt;__sk_common.skc_family;</span><br><span class="line">        <span class="variable">$ulock</span> = <span class="variable">$sk</span>-&gt;sk_lock.owned;</span><br><span class="line">        //if (<span class="variable">$af</span> == AF_INET) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$ulock</span> != 0) &#123;</span><br><span class="line">            <span class="variable">$daddr</span> = ntop(<span class="variable">$af</span>, <span class="variable">$sk</span>-&gt;__sk_common.skc_daddr);</span><br><span class="line">            <span class="variable">$saddr</span> = ntop(<span class="variable">$af</span>, <span class="variable">$sk</span>-&gt;__sk_common.skc_rcv_saddr);</span><br><span class="line">            <span class="variable">$lport</span> = <span class="variable">$sk</span>-&gt;__sk_common.skc_num;</span><br><span class="line">            <span class="variable">$dport</span> = <span class="variable">$sk</span>-&gt;__sk_common.skc_dport;</span><br><span class="line">            <span class="variable">$dport</span> = (<span class="variable">$dport</span> &gt;&gt; 8) | ((<span class="variable">$dport</span> &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0</span>xff00);</span><br><span class="line">            printf(&quot;%s %d %-<span class="number">15</span>s %-<span class="number">5</span>d -&gt; %-<span class="number">15</span>s %-<span class="number">5</span>d, lock-owned: %d retval: %d\n&quot;,</span><br><span class="line">                comm, tid, <span class="variable">$saddr</span>, <span class="variable">$lport</span>, <span class="variable">$daddr</span>, <span class="variable">$dport</span>, <span class="variable">$ulock</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">        delete(@sk[tid]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END &#123;</span><br><span class="line">   clear(@sk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Show-file-name"><a href="#Show-file-name" class="headerlink" title="Show file name"></a>Show file name</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span></span><br><span class="line">$ bpftrace --include linux/path.h --include linux/dcache.h     -e <span class="string">&#x27;kprobe:vfs_open &#123; printf(&quot;open path: %s\n&quot;, str(((path *)arg0)-&gt;dentry-&gt;d_name.name)); &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">/* <span class="built_in">wait</span> fd2path/path to the new version https://github.com/iovisor/bpftrace/issues/29 */</span><br><span class="line">/* only <span class="built_in">print</span> parent <span class="built_in">dir</span> name and file name */</span><br><span class="line">kprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open path:%s/%s,uid: %d,cmd %s, &quot;</span>, str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name), str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name), uid, comm);</span><br><span class="line">    @start = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:vfs_open</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;take ns: %d\n&quot;, (nsecs - @start));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fs&#x2F;open.c      </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * vfs_open - open the file at the given path</span></span><br><span class="line"><span class="comment"> * @path: path to open</span></span><br><span class="line"><span class="comment"> * @file: newly allocated file with f_flag initialized</span></span><br><span class="line"><span class="comment"> * @cred: credentials to use</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">vfs_open</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> path *path, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        file-&gt;f_path = *path;</span><br><span class="line">        <span class="keyword">return</span> do_dentry_open(file, d_backing_inode(path-&gt;dentry), <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/path.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line">#<span class="meta"># linux/dcache.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line">        <span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> d_flags;           <span class="comment">/* protected by d_lock */</span></span><br><span class="line">        <span class="type">seqcount_t</span> d_seq;               <span class="comment">/* per dentry seqlock */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span>    <span class="comment">/* lookup hash list */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span>        <span class="comment">/* parent directory */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span>          <span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment">                                         * negative */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> d_iname[DNAME_INLINE_LEN];        <span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span>       <span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>       <span class="comment">/* The root of the dentry tree */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> d_time;           <span class="comment">/* used by d_revalidate */</span></span><br><span class="line">        <span class="type">void</span> *d_fsdata;                 <span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span>         <span class="comment">/* LRU list */</span></span><br><span class="line">                <span class="type">wait_queue_head_t</span> *d_wait;      <span class="comment">/* in-lookup ones only */</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span>       <span class="comment">/* child of parent list */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span>     <span class="comment">/* our children */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span>      <span class="comment">/* inode alias list */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span>  <span class="comment">/* only for in-lookup ones */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">        &#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<h4 id="show-the-path"><a href="#show-the-path" class="headerlink" title="show the path"></a>show the path</h4><p>update path function 2023-10<br><a target="_blank" rel="noopener" href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#26-path-return-full-path">path(): Return full path</a><br><a target="_blank" rel="noopener" href="https://github.com/iovisor/bpftrace/pull/1492">1492</a>   </p>
<p>The same with vfs_read and vfs_write</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/fs.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/path.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;linux/dcache.h&gt;</span></span><br><span class="line"></span><br><span class="line">kprobe:vfs_open /pid == <span class="variable">$1</span>/</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The vfs_read parent dir:%s/%s/%s/%s,uid: %d,cmd %s;\n&quot;</span>,</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_parent-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">    str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name), uid, comm);</span><br><span class="line"> </span><br><span class="line">    //print raw data worked;   printf(&quot;The vfs_open parent dir:%x,uid: %d,cmd %s;\n&quot;, ((struct path *)arg0)-&gt;mnt, uid, comm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#output:</span><br><span class="line">The vfs_read parent dir:yum/history/history-<span class="number">2021</span>-<span class="number">01</span>-<span class="number">09</span>.sqlite-journal/,uid: <span class="number">0</span>,cmd yum;</span><br><span class="line"></span><br><span class="line">$ stat  /var/lib/yum/history/history-<span class="number">2021</span>-<span class="number">01</span>-<span class="number">09</span>.sqlite-journal</span><br><span class="line">  File: &#x27;/var/lib/yum/history/history-<span class="number">2021</span>-<span class="number">01</span>-<span class="number">09</span>.sqlite-journal&#x27;</span><br><span class="line">  Size: <span class="number">17024</span>           Blocks: <span class="number">48</span>         IO Block: <span class="number">4096</span>   regular file</span><br><span class="line">Device: <span class="number">802</span>h/<span class="number">2050</span>d      Inode: <span class="number">5505368</span>     Links: <span class="number">1</span></span><br><span class="line">Access: (<span class="number">0600</span>/-rw-------)  Uid: (    <span class="number">0</span>/    root)   Gid: (    <span class="number">0</span>/    root)</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">(gdb) list vfs_write</span><br><span class="line"><span class="number">527</span>     ssize_t vfs_write(struct file *file, const char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">(gdb) list vfs_read</span><br><span class="line"><span class="number">450</span>     ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">(gdb) list vfs_open</span><br><span class="line"><span class="number">856</span>     int vfs_open(const struct path *path, struct file *filp,</span><br><span class="line"><span class="number">857</span>                  const struct cred *cred)</span><br><span class="line">(gdb) list rw_verify_area</span><br><span class="line"><span class="number">397</span>     int rw_verify_area(int read_write, struct file *file, loff_t *ppos, size_t count)</span><br><span class="line"></span><br><span class="line">#el8 , vfs_read/vfs_write not working, vfs_open is ok</span><br><span class="line">#!/usr/bin/env bpftrace</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/path.h&gt;</span><br><span class="line">#include &lt;linux/dcache.h&gt;</span><br><span class="line">kprobe:vfs_open /comm == &quot;dd&quot;/</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;open path: /%s/%s/%s/%s \n&quot;,</span><br><span class="line">        str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_parent-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">        str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">        str(((struct path *)arg0)-&gt;dentry-&gt;d_parent-&gt;d_name.name),</span><br><span class="line">        str(((struct path *)arg0)-&gt;dentry-&gt;d_name.name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="trace-I-O"><a href="#trace-I-O" class="headerlink" title="trace I&#x2F;O "></a><a target="_blank" rel="noopener" href="https://www.informit.com/articles/article.aspx?p=2995360&seqNum=3#">trace I&#x2F;O </a></h4><p>This tool needs to store a timestamp at the start of each I&#x2F;O to record its duration (latency)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        delete(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @start[args-&gt;dev, args-&gt;sector] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/@start[args-&gt;dev, args-&gt;sector]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs = hist((nsecs - @start[args-&gt;dev, args-&gt;sector]) / <span class="number">1000</span>);</span><br><span class="line">        delete(@start[args-&gt;dev, args-&gt;sector]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@usecs:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                  |</span><br><span class="line">[<span class="number">128</span>, <span class="number">256</span>)             <span class="number">1</span> |@@@@@@@@@@@@@@@@@                                   |</span><br><span class="line">[<span class="number">256</span>, <span class="number">512</span>)             <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">512</span>, <span class="number">1</span>K)              <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">1</span>K, <span class="number">2</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">4</span>K, <span class="number">8</span>K)               <span class="number">0</span> |                                                    |</span><br><span class="line">[<span class="number">8</span>K, <span class="number">16</span>K)              <span class="number">3</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>
<p>Traces the full duration of the I&#x2F;O</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12s %-16s %-6s %7s\n&quot;</span>, <span class="string">&quot;TIME(ms)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;LAT(ms)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">        @iopid[arg0] = pid;</span><br><span class="line">        @iocomm[arg0] = comm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_done</span><br><span class="line">/@start[arg0] != <span class="number">0</span> &amp;&amp; @iopid[arg0] != <span class="number">0</span> &amp;&amp; @iocomm[arg0] != <span class="string">&quot;&quot;</span>/</span><br><span class="line">&#123;</span><br><span class="line">        $now = nsecs;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-12u %-16s %-6d %7d\n&quot;</span>,</span><br><span class="line">            elapsed / <span class="number">1000000</span>, @iocomm[arg0], @iopid[arg0],</span><br><span class="line">            ($now - @start[arg0]) / <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">        delete(@start[arg0]);</span><br><span class="line">        delete(@iopid[arg0]);</span><br><span class="line">        delete(@iocomm[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">        clear(@iopid);</span><br><span class="line">        clear(@iocomm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME(ms)     COMM             PID    <span class="title function_">LAT</span><span class="params">(ms)</span></span><br><span class="line">4763         vim              55675        0</span><br><span class="line">4763         vim              55675        0</span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line">6268         kworker/u434:1   46458        0</span><br><span class="line">6268         kworker/u434:1   46458        0</span><br></pre></td></tr></table></figure>
<p>biosize</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block device I/O... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        @[args-&gt;comm] = hist(args-&gt;bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nI/O size (bytes) histograms by process name:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">3</span> probes...</span><br><span class="line">Tracing block device I/O... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line">I/O <span class="title function_">size</span> <span class="params">(bytes)</span> histograms by process name:</span><br><span class="line"></span><br><span class="line">@[kworker/u434:1]:</span><br><span class="line">[0]                    1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[vim]:</span><br><span class="line">[0]                    2 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@[kworker/21:2]:</span><br><span class="line">[8, 16)                3 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>seeksize<br>show how many sectors that processes are requesting the disks to seek</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;Tracing block I/O requested seeks... Hit Ctrl-C to end.\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        if (@last[args-&gt;dev]) &#123;</span><br><span class="line">                // calculate requested seek distance</span><br><span class="line">                $last = @last[args-&gt;dev];</span><br><span class="line">                $dist = (args-&gt;sector - $last) &gt; 0 ?</span><br><span class="line">                    args-&gt;sector - $last : $last - args-&gt;sector;</span><br><span class="line"></span><br><span class="line">                // store details</span><br><span class="line">                @sectors[args-&gt;comm] = hist($dist);</span><br><span class="line">        &#125;</span><br><span class="line">        // save last requested position of disk head</span><br><span class="line">        @last[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@last);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching 3 probes...</span><br><span class="line">Tracing block I/O requested seeks... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">seeksize</span><br><span class="line">show how many sectors that processes are requesting the disks to seek</span><br><span class="line">```c</span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;Tracing block I/O requested seeks... Hit Ctrl-C to end.\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_issue</span><br><span class="line">&#123;</span><br><span class="line">        if (@last[args-&gt;dev]) &#123;</span><br><span class="line">                // calculate requested seek distance</span><br><span class="line">                $last = @last[args-&gt;dev];</span><br><span class="line">                $dist = (args-&gt;sector - $last) &gt; 0 ?</span><br><span class="line">                    args-&gt;sector - $last : $last - args-&gt;sector;</span><br><span class="line"></span><br><span class="line">                // store details</span><br><span class="line">                @sectors[args-&gt;comm] = hist($dist);</span><br><span class="line">        &#125;</span><br><span class="line">        // save last requested position of disk head</span><br><span class="line">        @last[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@last);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching 3 probes...</span><br><span class="line">Tracing block I/O requested seeks... Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@sectors[bash]:</span><br><span class="line">(..., 0)               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/15:1]:</span><br><span class="line">[0]                    1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[kworker/u433:0]:</span><br><span class="line">[256M, 512M)           1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[vim]:</span><br><span class="line">(..., 0)               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[xfsaild/sda3]:</span><br><span class="line">[128M, 256M)           1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line"></span><br><span class="line">@sectors[sync]:</span><br><span class="line">(..., 0)               1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[0]                    1 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>biopattern<br>identify the pattern of I&#x2F;O: random or sequential</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %5s %5s %8s %10s\n&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;%RND&quot;</span>, <span class="string">&quot;%SEQ&quot;</span>, <span class="string">&quot;COUNT&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KBYTES&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (@lastsector[args-&gt;dev] == args-&gt;sector) &#123;</span><br><span class="line">                @sequential++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @random++;</span><br><span class="line">        &#125;</span><br><span class="line">        @bytes = @bytes + args-&gt;nr_sector * <span class="number">512</span>;</span><br><span class="line">        @lastsector[args-&gt;dev] = args-&gt;sector + args-&gt;nr_sector;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interval:s:<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">        $count = @random + @sequential;</span><br><span class="line">        $div = $count;</span><br><span class="line">        <span class="keyword">if</span> ($div == <span class="number">0</span>) &#123;</span><br><span class="line">                $div = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%5d %5d %8d %10d\n&quot;</span>, @random * <span class="number">100</span> / $div,</span><br><span class="line">            @sequential * <span class="number">100</span> / $div, $count, @bytes / <span class="number">1024</span>);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@lastsector);</span><br><span class="line">        clear(@random); clear(@sequential); clear(@bytes);</span><br><span class="line">&#125;</span><br><span class="line">Attaching <span class="number">4</span> probes...</span><br><span class="line">TIME      %RND  %SEQ    COUNT     KBYTES</span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">58</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">59</span>:<span class="number">59</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>         <span class="number">16</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">00</span>   <span class="number">100</span>     <span class="number">0</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">01</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">03</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">04</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">05</span>    <span class="number">75</span>    <span class="number">25</span>        <span class="number">8</span>         <span class="number">48</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">06</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">07</span>     <span class="number">0</span>     <span class="number">0</span>        <span class="number">0</span>          <span class="number">0</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>:<span class="number">08</span>     <span class="number">0</span>   <span class="number">100</span>        <span class="number">1</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>biostacks</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O with init stacks. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_account_io_start</span><br><span class="line">&#123;</span><br><span class="line">        @reqstack[arg0] = kstack;</span><br><span class="line">        @reqts[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@reqts[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        @usecs[@reqstack[arg0]] = hist(nsecs - @reqts[arg0]);</span><br><span class="line">        delete(@reqstack[arg0]);</span><br><span class="line">        delete(@reqts[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@reqstack); clear(@reqts);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">5</span> probes...</span><br><span class="line">Tracing block I/O with init stacks. Hit Ctrl-C to end.</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">@usecs[</span><br><span class="line">    blk_account_io_start+<span class="number">1</span></span><br><span class="line">    generic_make_request+<span class="number">327</span></span><br><span class="line">    submit_bio+<span class="number">112</span></span><br><span class="line">    xfs_submit_ioend.isra<span class="number">.12</span>+<span class="number">97</span></span><br><span class="line">    xfs_vm_writepages+<span class="number">127</span></span><br><span class="line">    do_writepages+<span class="number">33</span></span><br><span class="line">    __filemap_fdatawrite_range+<span class="number">101</span></span><br><span class="line">    filemap_write_and_wait_range+<span class="number">65</span></span><br><span class="line">    xfs_file_fsync+<span class="number">102</span></span><br><span class="line">    do_fsync+<span class="number">103</span></span><br><span class="line">    sys_fsync+<span class="number">16</span></span><br><span class="line">    system_call_fastpath+<span class="number">37</span></span><br><span class="line">]:</span><br><span class="line">[<span class="number">2</span>K, <span class="number">4</span>K)               <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>
<p>bioerr  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">perf record -e block:block_rq_complete --filter <span class="string">&#x27;error != 0&#x27;</span></span><br><span class="line">cat /sys/kernel/debug/tracing/events/block/block_rq_complete/format</span><br><span class="line">bpftrace -e <span class="string">&#x27;kprobe:blk_status_to_errno /arg0/ &#123; @[arg0]++ &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;t:block:block_rq_issue /args-&gt;dev == 0/ &#123; @[kstack]++ &#125;&#x27;</span></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O errors. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:block:block_rq_complete</span><br><span class="line">/args-&gt;error != <span class="number">0</span>/</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;device: %d,%d, sector: %d, bytes: %d, flags: %s, error: %d\n&quot;</span>,</span><br><span class="line">            args-&gt;dev &gt;&gt; <span class="number">20</span>, args-&gt;dev &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">20</span>) - <span class="number">1</span>), args-&gt;sector,</span><br><span class="line">            args-&gt;nr_sector * <span class="number">512</span>, args-&gt;rwbs, args-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_OK 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_NOTSUPP         ((__force blk_status_t)1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_TIMEOUT         ((__force blk_status_t)2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_NOSPC           ((__force blk_status_t)3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_TRANSPORT       ((__force blk_status_t)4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_TARGET          ((__force blk_status_t)5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_NEXUS           ((__force blk_status_t)6)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_MEDIUM          ((__force blk_status_t)7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_PROTECTION      ((__force blk_status_t)8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_RESOURCE        ((__force blk_status_t)9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_STS_IOERR           ((__force blk_status_t)10)</span></span><br></pre></td></tr></table></figure>

<p>mdflush<br>for tracing flush events from md     </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/genhd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/bio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing md flush events... Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-8s %-6s %-16s %s&quot;</span>, <span class="string">&quot;TIME&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;DEVICE&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:md_flush_request</span><br><span class="line">&#123;</span><br><span class="line">        time(<span class="string">&quot;%H:%M:%S &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-6d %-16s %s\n&quot;</span>, pid, comm,</span><br><span class="line">            ((<span class="keyword">struct</span> bio *)arg1)-&gt;bi_disk-&gt;disk_name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iosched<br>traces the time that requests were queued in the I&#x2F;O scheduler   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;linux/blkdev.h&gt;</span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing block I/O schedulers. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:__elv_add_request</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg1] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:blk_start_request,</span><br><span class="line">kprobe:blk_mq_start_request</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$r</span> = (struct request *)arg0;</span><br><span class="line">        @usecs[<span class="variable">$r</span>-&gt;q-&gt;elevator-&gt;<span class="built_in">type</span>-&gt;elevator_name] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        delete(@start[arg0]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Attaching <span class="number">5</span> probes...</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Warning: could not attach probe kprobe:blk_start_request, skipping.</span><br><span class="line">cannot attach kprobe, probe entry may not exist</span><br><span class="line">Error attaching probe: &#x27;kprobe:__elv_add_request&#x27;</span><br></pre></td></tr></table></figure>

<p>scsilatency<br> to trace SCSI commands with latency distributions   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;scsi/scsi_cmnd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing scsi latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// SCSI opcodes from scsi/scsi_proto.h; add more mappings if desired:</span></span><br><span class="line">        @opcode[<span class="number">0x00</span>] = <span class="string">&quot;TEST_UNIT_READY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x03</span>] = <span class="string">&quot;REQUEST_SENSE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x08</span>] = <span class="string">&quot;READ_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0a</span>] = <span class="string">&quot;WRITE_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x0b</span>] = <span class="string">&quot;SEEK_6&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x12</span>] = <span class="string">&quot;INQUIRY&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x18</span>] = <span class="string">&quot;ERASE&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x28</span>] = <span class="string">&quot;READ_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2a</span>] = <span class="string">&quot;WRITE_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x2b</span>] = <span class="string">&quot;SEEK_10&quot;</span>;</span><br><span class="line">        @opcode[<span class="number">0x35</span>] = <span class="string">&quot;SYNCHRONIZE_CACHE&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_init_io</span><br><span class="line">&#123;</span><br><span class="line">        @start[arg0] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:scsi_done,</span><br><span class="line">kprobe:scsi_mq_done</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $cmnd = (<span class="keyword">struct</span> scsi_cmnd *)arg0;</span><br><span class="line">        $opcode = *$cmnd-&gt;req.cmd &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$opcode, @opcode[$opcode]] = hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@start); clear(@opcode);</span><br><span class="line">&#125;</span><br><span class="line">@usecs[<span class="number">74</span>, ]:</span><br><span class="line">[<span class="number">64</span>, <span class="number">128</span>)              <span class="number">9</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br></pre></td></tr></table></figure>

<p>scsiresult   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DID_OK          0x00    <span class="comment">/* NO error                                */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DID_NO_CONNECT  0x01    <span class="comment">/* Couldn&#x27;t connect before timeout period  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DID_BUS_BUSY    0x02    <span class="comment">/* BUS stayed busy through time out period */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DID_TIME_OUT    0x03    <span class="comment">/* TIMED OUT for other reason              */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DID_BAD_TARGET  0x04    <span class="comment">/* BAD target.</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">#!/usr/bin/bpftrace</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">BEGIN</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#123;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        printf(&quot;Tracing scsi command results. Hit Ctrl-C to end.\n&quot;);</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">        // host byte codes, from include/scsi/scsi.h:</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x00] = &quot;DID_OK&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x01] = &quot;DID_NO_CONNECT&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x02] = &quot;DID_BUS_BUSY&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x03] = &quot;DID_TIME_OUT&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x04] = &quot;DID_BAD_TARGET&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x05] = &quot;DID_ABORT&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x06] = &quot;DID_PARITY&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x07] = &quot;DID_ERROR&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x08] = &quot;DID_RESET&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x09] = &quot;DID_BAD_INTR&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x0a] = &quot;DID_PASSTHROUGH&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x0b] = &quot;DID_SOFT_ERROR&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x0c] = &quot;DID_IMM_RETRY&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x0d] = &quot;DID_REQUEUE&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x0e] = &quot;DID_TRANSPORT_DISRUPTED&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x0f] = &quot;DID_TRANSPORT_FAILFAST&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x10] = &quot;DID_TARGET_FAILURE&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x11] = &quot;DID_NEXUS_FAILURE&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x12] = &quot;DID_ALLOC_FAILURE&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @host[0x13] = &quot;DID_MEDIUM_ERROR&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">        // status byte codes, from include/scsi/scsi_proto.h:</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x00] = &quot;SAM_STAT_GOOD&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x02] = &quot;SAM_STAT_CHECK_CONDITION&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x04] = &quot;SAM_STAT_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x08] = &quot;SAM_STAT_BUSY&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x10] = &quot;SAM_STAT_INTERMEDIATE&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x14] = &quot;SAM_STAT_INTERMEDIATE_CONDITION_MET&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x18] = &quot;SAM_STAT_RESERVATION_CONFLICT&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x22] = &quot;SAM_STAT_COMMAND_TERMINATED&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x28] = &quot;SAM_STAT_TASK_SET_FULL&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x30] = &quot;SAM_STAT_ACA_ACTIVE&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @status[0x40] = &quot;SAM_STAT_TASK_ABORTED&quot;;</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#125;</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#123;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        @[@host[(args-&gt;result &gt;&gt; 16) &amp; 0xff], @status[args-&gt;result &amp; 0xff]] =</span></span></span><br><span class="line"><span class="comment"><span class="meta">            count();</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#125;</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">END</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#123;</span></span></span><br><span class="line"><span class="comment"><span class="meta">        clear(@status);</span></span></span><br><span class="line"><span class="comment"><span class="meta">        clear(@host);</span></span></span><br><span class="line"><span class="comment"><span class="meta">&#125;</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">Attaching 3 probes...</span></span></span><br><span class="line"><span class="comment"><span class="meta">Tracing scsi command results. Hit Ctrl-C to end.</span></span></span><br><span class="line"><span class="comment"><span class="meta">^C</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">@[DID_OK, SAM_STAT_CHECK_CONDITION]: 1</span></span></span><br><span class="line"><span class="comment"><span class="meta">@[DID_OK, SAM_STAT_GOOD]: 1596</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">driver_byte &lt;&lt; 24 | host_byte &lt;&lt; 16 | msg_byte &lt;&lt; 8 | status_byte</span></span></span><br><span class="line"><span class="comment"><span class="meta"></span></span></span><br><span class="line"><span class="comment"><span class="meta">bpftrace -lv t:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="comment"><span class="meta">tracepoint:scsi:scsi_dispatch_cmd_done</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int host_no;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int channel;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int id;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int lun;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    int result;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int opcode;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int cmd_len;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int data_sglen;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned int prot_sglen;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    unsigned char prot_op;</span></span></span><br><span class="line"><span class="comment"><span class="meta">    __data_loc unsigned char[] cmnd;</span></span></span><br></pre></td></tr></table></figure>
<p>nvmelatency<br>traces the nvme storage driver and shows command latencies by disk and nvme command opcode  k</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> bpftrace -e <span class="string">&#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/blkdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/nvme.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Tracing nvme command latency. Hit Ctrl-C to end.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// from linux/nvme.h:</span></span><br><span class="line">        @ioopcode[<span class="number">0x00</span>] = <span class="string">&quot;nvme_cmd_flush&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x01</span>] = <span class="string">&quot;nvme_cmd_write&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x02</span>] = <span class="string">&quot;nvme_cmd_read&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x04</span>] = <span class="string">&quot;nvme_cmd_write_uncor&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x05</span>] = <span class="string">&quot;nvme_cmd_compare&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x08</span>] = <span class="string">&quot;nvme_cmd_write_zeroes&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x09</span>] = <span class="string">&quot;nvme_cmd_dsm&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0d</span>] = <span class="string">&quot;nvme_cmd_resv_register&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x0e</span>] = <span class="string">&quot;nvme_cmd_resv_report&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x11</span>] = <span class="string">&quot;nvme_cmd_resv_acquire&quot;</span>;</span><br><span class="line">        @ioopcode[<span class="number">0x15</span>] = <span class="string">&quot;nvme_cmd_resv_release&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_setup_cmd</span><br><span class="line">&#123;</span><br><span class="line">        $req = (<span class="keyword">struct</span> request *)arg1;</span><br><span class="line">        <span class="keyword">if</span> ($req-&gt;rq_disk) &#123;</span><br><span class="line">                @start[arg1] = nsecs;</span><br><span class="line">                @cmd[arg1] = arg2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                @admin_commands = count();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:nvme_complete_rq</span><br><span class="line">/@start[arg0]/</span><br><span class="line">&#123;</span><br><span class="line">        $req = (<span class="keyword">struct</span> request *)arg0;</span><br><span class="line">        $cmd = (<span class="keyword">struct</span> nvme_command *)@cmd[arg0];</span><br><span class="line">        $disk = $req-&gt;rq_disk;</span><br><span class="line">        $opcode = $cmd-&gt;common.opcode &amp; <span class="number">0xff</span>;</span><br><span class="line">        @usecs[$disk-&gt;disk_name, @ioopcode[$opcode]] =</span><br><span class="line">            hist((nsecs - @start[arg0]) / <span class="number">1000</span>);</span><br><span class="line">        delete(@start[tid]); delete(@cmd[tid]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;</span><br><span class="line">        clear(@ioopcode); clear(@start); clear(@cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e <span class="string">&#x27;tracepoint:block:* &#123; @[probe] = count(); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;kprobe:scsi* &#123; @[func] = count(); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;kprobe:nvme* &#123; @[func] = count(); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;t:block:block_rq_issue &#123; @bytes = hist(args-&gt;bytes); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = sum(args-&gt;bytes); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;t:block:block_rq_complete /args-&gt;error/ &#123;</span></span><br><span class="line"><span class="string">    printf(&quot;dev %d type %s error %d\n&quot;, args-&gt;dev, args-&gt;rwbs, args-&gt;error); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;k:blk_start_plug &#123; @ts[arg0] = nsecs; &#125;</span></span><br><span class="line"><span class="string">    k:blk_flush_plug_list /@ts[arg0]/ &#123; @plug_ns = hist(nsecs - @ts[arg0]);</span></span><br><span class="line"><span class="string">    delete(@ts[arg0]); &#125;&#x27;</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;k:blk_mq_start_request &#123; @swqueues = lhist(cpu, 0, 100, 1); &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//IO type</span></span><br><span class="line">bpftrace -e <span class="string">&#x27;t:block:block_rq_issue &#123; @[args-&gt;rwbs] = count(); &#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>not work in centos kernel   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/dcache.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_unlink,tracepoint:syscalls:sys_enter_unlinkat &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s deleted by command &#x27;%s&#x27; with pid %d\n&quot;</span>,</span><br><span class="line">            str(args-&gt;pathname), comm, pid);</span><br><span class="line">    $p = curtask-&gt;real_parent;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        $i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; ... whose parent is &#x27;%s&#x27; command with pid %d\n&quot;</span>,</span><br><span class="line">               $p-&gt;comm,</span><br><span class="line">               $p-&gt;tgid);</span><br><span class="line">        $p = $p-&gt;parent;</span><br><span class="line">        <span class="keyword">if</span> ($p == <span class="number">0</span> || $p-&gt;tgid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WARNING: Kernel does not support bounded loops. Depending on LLVMs loop unroll to generate loadable code.</span><br><span class="line">    <span class="keyword">while</span> ($i &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    ~~~~~</span><br><span class="line">Attaching <span class="number">2</span> probes...</span><br><span class="line"></span><br><span class="line">Error <span class="built_in">log</span>:</span><br><span class="line">back-edge from insn <span class="number">162</span> to <span class="number">78</span></span><br></pre></td></tr></table></figure>
<p>Trace the latency from sys_enter_read to sys_exit_read and output block size counts   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">BEGIN &#123;</span><br><span class="line">   <span class="keyword">if</span> ($<span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="built_in">printf</span> (<span class="string">&quot;Please input pid in first parameter&quot;</span>);</span><br><span class="line">     <span class="built_in">exit</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">profile:hz:<span class="number">9117</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_open</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @open_time[tid] = nsecs;</span><br><span class="line">  @open_name[tid] = args-&gt;filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_newfstat</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @fstat_time[tid] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_close</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @close_time[tid] = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_unlink</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// @unlink_time[probe,tid] = nsecs;  could not write key to probe,tid</span></span><br><span class="line">  @unlink_time[tid] = nsecs;</span><br><span class="line">  @unlink_name[tid] = args-&gt;pathname;</span><br><span class="line">&#125;</span><br><span class="line">tracepoint:syscalls:sys_enter_write,</span><br><span class="line">tracepoint:syscalls:sys_enter_read</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  @rw_time[tid] = nsecs;</span><br><span class="line">  @rw_count[tid] = args-&gt;count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_open</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@open_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @open_delta[tid] = nsecs - @open_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms, flename: %s\n&quot;</span>, probe, tid, @open_delta[tid]/<span class="number">1000000</span>, @open_delta[tid]%<span class="number">1000000</span>, str(@open_name[tid]));</span><br><span class="line">     delete(@open_time[tid]); delete(@open_name[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_newfstat</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@fstat_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @fstat_delta[tid] = nsecs - @fstat_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms\n&quot;</span>, probe, tid, @fstat_delta[tid]/<span class="number">1000000</span>, @fstat_delta[tid]%<span class="number">1000000</span>);</span><br><span class="line">     delete(@fstat_time[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_close</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@close_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @close_delta[tid] = nsecs - @close_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms\n&quot;</span>, probe, tid, @close_delta[tid]/<span class="number">1000000</span>, @close_delta[tid]%<span class="number">1000000</span>);</span><br><span class="line">     delete(@close_time[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">tracepoint:syscalls:sys_exit_unlink</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@unlink_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">     @unlink_delta[tid] = nsecs - @unlink_time[tid];</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms, flename: %s\n&quot;</span>, probe, tid, @unlink_delta[tid]/<span class="number">1000000</span>, @unlink_delta[tid]%<span class="number">1000000</span>, str(@unlink_name[tid]));</span><br><span class="line">     delete(@unlink_time[tid]); delete(@unlink_name[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_exit_write,</span><br><span class="line">tracepoint:syscalls:sys_exit_read</span><br><span class="line">/pid == $<span class="number">1</span>/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (@rw_time[tid] != <span class="number">0</span>) &#123;</span><br><span class="line">    @rw_delta[tid] = nsecs - @rw_time[tid];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s tid: %d, %d.%06d ms, block size: %d bytes\n&quot;</span>, probe, tid, @rw_delta[tid]/<span class="number">1000000</span>, @rw_delta[tid]%<span class="number">1000000</span>, @rw_count[tid]);</span><br><span class="line">    delete(@rw_time[tid]); delete(@rw_delta[tid]); delete(@rw_count[tid]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END &#123;</span><br><span class="line">   clear(@rw_time);</span><br><span class="line">   clear(@rw_delta);</span><br><span class="line">   clear(@rw_count);</span><br><span class="line">   clear(@unlink_name);</span><br><span class="line">   clear(@unlink_time);</span><br><span class="line">   clear(@unlink_delta);</span><br><span class="line">   clear(@open_name);</span><br><span class="line">   clear(@open_time);</span><br><span class="line">   clear(@open_delta);</span><br><span class="line">   clear(@close_time);</span><br><span class="line">   clear(@close_delta);</span><br><span class="line">   clear(@fstat_time);</span><br><span class="line">   clear(@fstat_delta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="trace-user-space-application"><a href="#trace-user-space-application" class="headerlink" title="trace user space application"></a><a target="_blank" rel="noopener" href="https://www.percona.com/sites/default/files/presentations/Scale18x-2020-bpfTrace-finally-dTrace-replacement.pdf">trace user space application</a></h4><p>uprobe:&#x2F;bin&#x2F;bash:readline (the function begining)<br>uretprobe:&#x2F;bin&#x2F;bash:readline (the function end)<br>&#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;uprobe_events    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/bin/bash:readline &#123; @ = count() &#125;&#x27;</span></span><br><span class="line">$ ./gethostlatency <span class="comment"># host resoltion calls latency (DNS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Get all _IO function from the system library</span></span><br><span class="line">$ bpftrace -l <span class="string">&#x27;uprobe:/lib64/libc.so.6:_IO*&#x27;</span> | <span class="built_in">head</span></span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_helper_overflow</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fclose.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_new_fgetpos.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_fgets.cold.0</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_read</span><br><span class="line">uprobe:/lib64/libc.so.6:_IO_cookie_write</span><br><span class="line"></span><br><span class="line">   binaray file ------------         -----------the <span class="keyword">function</span> from hello_world</span><br><span class="line">                           |         |</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:~/hello_world:hello &#123;printf(&quot;%s\n&quot;, ustack());&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#http://mysqlentomologist.blogspot.com/2021/10/bpftrace-as-codefunction-coverage-tool.html</span></span><br><span class="line">$ BPFTRACE_MAX_PROBES=35000 bpftrace -e <span class="string">&#x27;uprobe:/home/openxs/dbs/maria10.6/bin/mariadbd:* &#123; printf(&quot;%s\n&quot;, func); &#125;&#x27;</span>a</span><br><span class="line"></span><br><span class="line"><span class="comment">#https://theartofmachinery.com/2019/04/26/bpftrace_d_gc.html</span></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/tmp/hello:_Dmain &#123; printf(&quot;D Hello World run with process ID %d\n&quot;, pid); &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> dumpgcfuncs.bt</span><br><span class="line">uprobe:/usr/local/bin/dscanner:_D2gc*</span><br><span class="line">&#123;</span><br><span class="line">  @[probe] = count();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uretprobe:/usr/local/bin/dscanner:_Dmain                                                                                                                  </span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ bpftrace dumpgcfuncs.bt | <span class="built_in">sort</span></span><br><span class="line"></span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC10freeNoSyncMFNbNiPvZv]: 31</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC10initializeFKCQCd11gcinterface2GCZv]: 1</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC11queryNoSyncMFNbPvZS4core6memory8BlkInfo_]: 44041</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC11removeRangeMFNbNiPvZv]: 2</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC12extendNoSyncMFNbPvmmxC8TypeInfoZm]: 251946</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC14collectNoStackMFNbZv]: 1</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC18fullCollectNoStackMFNbZv]: 1</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC4freeMFNbNiPvZv]: 31</span><br><span class="line">@[uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw14ConservativeGC5queryMFNbPvZS4core6memory8BlkInfo_]: 4</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> gcprofile.bt</span><br><span class="line">uprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw3Gcx11fullcollectMFNbbZm</span><br><span class="line">&#123;</span><br><span class="line">  @t = nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uretprobe:/usr/local/bin/dscanner:_D2gc4impl12conservativeQw3Gcx11fullcollectMFNbbZm / @t /</span><br><span class="line">&#123;</span><br><span class="line">  @gc_times = hist(nsecs - @t);</span><br><span class="line">&#125;</span><br><span class="line">$ bpftrace gcprofile.bt</span><br><span class="line">Attaching 2 probes...</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">@gc_times: </span><br><span class="line">[64K, 128K)          138 |@                                                   |</span><br><span class="line">[128K, 256K)        1367 |@@@@@@@@@@                                          |</span><br><span class="line">[256K, 512K)        6687 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[512K, 1M)             7 |                                                    |</span><br><span class="line">[1M, 2M)             301 |@@                                                  |</span><br><span class="line"></span><br><span class="line"><span class="comment">#Add USDT instrumentation</span></span><br><span class="line"><span class="comment"># include &quot;folly/tracing/StaticTracepoint.h&quot;</span></span><br><span class="line">readref -n usdt_sample_lib1/libusdt_sample_lib1.so</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;usdt:/tmp/tick:loop &#123;printf (&quot;got: %d\n&quot;, arg0); &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="userspace-example"><a href="#userspace-example" class="headerlink" title="userspace example"></a><a target="_blank" rel="noopener" href="http://blog.jcix.top/2019-12-04/bpftrace-profiling/">userspace example</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">sleep_func</span><span class="params">(<span class="type">int</span> sleep_time_us)</span></span><br><span class="line">&#123;</span><br><span class="line">    usleep(sleep_time_us);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> lower = <span class="number">0</span>, upper = <span class="number">100</span>;</span><br><span class="line">    srand(time(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">1000</span>; k &gt; <span class="number">0</span>; k--) &#123;</span><br><span class="line">        <span class="type">int</span> sleep_time_us = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            sleep_time_us += rand() % (upper - lower) + lower;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;us: %d\n&quot;</span>, sleep_time_us);</span><br><span class="line">        sleep_func(sleep_time_us);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bpftrace</span></span><br><span class="line">uprobe:~/sleep_prog:sleep_func</span><br><span class="line">&#123;</span><br><span class="line">    @t_start=nsecs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uretprobe:~/sleep_prog:sleep_func</span><br><span class="line">/@t_start/</span><br><span class="line">&#123;</span><br><span class="line">    @my_hist = lhist(nsecs - @t_start, 0, 10000000, 50000);</span><br><span class="line">    clear(@t_start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@my_hist:</span><br><span class="line">[250000, 300000)       1 |                                                    |</span><br><span class="line">[300000, 350000)       6 |@@                                                  |</span><br><span class="line">[350000, 400000)      14 |@@@@@@                                              |</span><br><span class="line">[400000, 450000)      39 |@@@@@@@@@@@@@@@@                                    |</span><br><span class="line">[450000, 500000)      63 |@@@@@@@@@@@@@@@@@@@@@@@@@@@                         |</span><br><span class="line">[500000, 550000)     120 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[550000, 600000)      82 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 |</span><br><span class="line">[600000, 650000)      96 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           |</span><br><span class="line">[650000, 700000)      53 |@@@@@@@@@@@@@@@@@@@@@@                              |</span><br><span class="line">[700000, 750000)      18 |@@@@@@@                                             |</span><br><span class="line">[750000, 800000)       7 |@@@                                                 |</span><br><span class="line">[800000, 850000)       0 |                                                    |</span><br><span class="line">[850000, 900000)       0 |                                                    |</span><br><span class="line">[900000, 950000)       0 |                                                    |</span><br><span class="line">[950000, 1000000)       0 |                                                    |</span><br><span class="line">[1000000, 1050000)       0 |                                                    |</span><br><span class="line">[1050000, 1100000)       0 |                                                    |</span><br><span class="line">[1100000, 1150000)       0 |                                                    |</span><br><span class="line">[1150000, 1200000)       1 |                                                    |</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_curr_state_one</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the print current state one function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_curr_state_two</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the print current state two function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">exchg2</span><span class="params">(<span class="type">int</span> px, <span class="type">int</span> *py)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> tmp = px;</span><br><span class="line">   px = *py;</span><br><span class="line">   *py = tmp;</span><br><span class="line">   <span class="type">int</span> reval=<span class="number">22</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;*px = %d, *py = %d. reval = %d\n&quot;</span>, px, *py, reval);</span><br><span class="line">   <span class="keyword">return</span> reval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> a = <span class="number">4</span>;</span><br><span class="line">   <span class="type">int</span> b = <span class="number">6</span>;</span><br><span class="line">   <span class="type">int</span> c = exchg2(a, &amp;b);</span><br><span class="line">    exchg2(a, &amp;b);</span><br><span class="line">   <span class="comment">//while (1) &#123;</span></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;a = %d, b = %d, c = %d.\n&quot;</span>, a, b, c);</span><br><span class="line">     print_curr_state_one();</span><br><span class="line">     sleep(<span class="number">1</span>);</span><br><span class="line">     print_curr_state_two();</span><br><span class="line">   <span class="comment">//&#125;</span></span><br><span class="line">   <span class="keyword">return</span>(<span class="number">11</span>);</span><br><span class="line">&#125;</span><br><span class="line">##########</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uprobe:/root/test:exchg2 &#123; printf(&quot;arg0: %d, arg1: %d\n&quot;, arg0, *arg1); &#125;&#x27;</span></span><br><span class="line">Attaching <span class="number">1</span> probe...</span><br><span class="line">arg0: <span class="number">4</span>, arg1: <span class="number">6</span></span><br><span class="line">arg0: <span class="number">4</span>, arg1: <span class="number">4</span></span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;uretprobe:/root/test:exchg2 &#123; printf(&quot;return: \&quot;%d\&quot;\n&quot;, retval);&#125;&#x27;</span></span><br><span class="line">Attaching <span class="number">1</span> probe...</span><br><span class="line"><span class="keyword">return</span>: <span class="string">&quot;22&quot;</span></span><br><span class="line"><span class="keyword">return</span>: <span class="string">&quot;22&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">root@mysql1:~<span class="comment"># bpftrace -e &#x27;uprobe:/usr/sbin/</span></span><br><span class="line">mysqld:dispatch_command &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">Could not resolve symbol: /usr/sbin/mysqld:dispatch_command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@mysql1:~# nm -D /usr/sbin/mysqld | grep dispatch_command</span></span><br><span class="line"><span class="string">00000000005af770 T</span></span><br><span class="line"><span class="string">_Z16dispatch_command19enum_server_commandP3THDPcjbb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>uprobe:/usr/sbin/mysqld:_Z16dispatch_command19enum_server_commandP3THDPcjbb &#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str(arg2)); &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">select @@version_comment limit 1</span></span><br><span class="line"><span class="string">select 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;<span class="built_in">join</span>(args-&gt;filename)&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_execve &#123;<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,str(args-&gt;filename))&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[pid,<span class="built_in">comm</span>]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[2423, in:imjournal]: 10</span></span><br><span class="line"><span class="string">@[338226, worker]: 12</span></span><br><span class="line"><span class="string">@[338161, qemu-kvm]: 19</span></span><br><span class="line"><span class="string">@[338161, CPU 0/KVM]: 20</span></span><br><span class="line"><span class="string">@[1898, NetworkManager]: 22</span></span><br><span class="line"><span class="string">@[338226, CPU 0/KVM]: 23</span></span><br><span class="line"><span class="string">@[2517288, sshd]: 24</span></span><br><span class="line"><span class="string">@[338513, CPU 1/KVM]: 24</span></span><br><span class="line"><span class="string">@[338226, qemu-kvm]: 29</span></span><br><span class="line"><span class="string">@[338161, CPU 3/KVM]: 42</span></span><br><span class="line"><span class="string">@[2801247, bpftrace]: 48</span></span><br><span class="line"><span class="string">@[338098, CPU 1/KVM]: 66</span></span><br><span class="line"><span class="string">@[338161, SPICE Worker]: 169</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:syscalls:sys_enter_* &#123;@[probe,<span class="built_in">comm</span>]=count() &#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 320 probes...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_madvise, qemu-kvm]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_select, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_getpid, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_waitid, lsmd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, irqbalance]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_inotify_add_watch, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_ioctl, sshd]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_poll, gmain]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_rt_sigreturn, bpftrace]: 1</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_pwrite64, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_fdatasync, worker]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_read, sshd]: 2</span></span><br><span class="line"><span class="string">@[tracepoint:syscalls:sys_enter_write, sshd]: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>tracepoint:raw_syscalls:sys_enter &#123;@[ksym(*(kaddr(<span class="string">&quot;sys_call_table&quot;</span>) + args-&gt;<span class="built_in">id</span> * 8))]=count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[__x64_sys_inotify_add_watch]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_exit]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigreturn]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_getpid]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_madvise]: 1</span></span><br><span class="line"><span class="string">@[__x64_sys_pwrite64]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_fdatasync]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_recvmmsg]: 2</span></span><br><span class="line"><span class="string">@[__x64_sys_select]: 6</span></span><br><span class="line"><span class="string">@[__x64_sys_rt_sigprocmask]: 8</span></span><br><span class="line"><span class="string">@[__x64_sys_clock_gettime]: 12</span></span><br><span class="line"><span class="string">@[__x64_sys_newfstat]: 34</span></span><br><span class="line"><span class="string">@[__x64_sys_close]: 36</span></span><br><span class="line"><span class="string">@[__x64_sys_openat]: 50</span></span><br><span class="line"><span class="string">@[__x64_sys_epoll_wait]: 70</span></span><br><span class="line"><span class="string">@[__x64_sys_futex]: 81</span></span><br><span class="line"><span class="string">@[__x64_sys_ppoll]: 108</span></span><br><span class="line"><span class="string">@[__x64_sys_read]: 297</span></span><br><span class="line"><span class="string">@[__x64_sys_write]: 327</span></span><br><span class="line"><span class="string">@[__x64_sys_ioctl]: 334</span></span><br><span class="line"><span class="string">@[__x64_sys_poll]: 430</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:99 /pid == 189/ &#123;@[ustack] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$ bpftrace -e &#x27;</span>profile:hz:49 &#123;@[ustack, kstack, <span class="built_in">comm</span>] = count()&#125;<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Attaching 1 probe...</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@[,</span></span><br><span class="line"><span class="string">    poll_idle+45</span></span><br><span class="line"><span class="string">    cpuidle_enter_state+115</span></span><br><span class="line"><span class="string">    cpuidle_enter+44</span></span><br><span class="line"><span class="string">    do_idle+566</span></span><br><span class="line"><span class="string">    cpu_startup_entry+111</span></span><br><span class="line"><span class="string">    start_secondary+423</span></span><br><span class="line"><span class="string">    secondary_startup_64+183</span></span><br><span class="line"><span class="string">, swapper/5]: 1</span></span><br><span class="line"><span class="string">@[</span></span><br><span class="line"><span class="string">    0x7f9e88814ab4</span></span><br><span class="line"><span class="string">    0x696765725f6b6c63</span></span><br><span class="line"><span class="string">,</span></span><br><span class="line"><span class="string">    pointer+521</span></span><br><span class="line"><span class="string">    vsnprintf+892</span></span><br><span class="line"><span class="string">    seq_vprintf+48</span></span><br><span class="line"><span class="string">    seq_printf+83</span></span><br><span class="line"><span class="string">    s_show+123</span></span><br><span class="line"><span class="string">    seq_read+745</span></span><br><span class="line"><span class="string">    proc_reg_read+60</span></span><br><span class="line"><span class="string">    vfs_read+145</span></span><br><span class="line"><span class="string">    ksys_read+79</span></span><br><span class="line"><span class="string">    do_syscall_64+91</span></span><br><span class="line"><span class="string">    entry_SYSCALL_64_after_hwframe+101</span></span><br><span class="line"><span class="string">, bpftrace]: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$  bpftrace -e &#x27;</span>k:tcp_sendmsg,k:__tcp_transmit_skb &#123; @[<span class="built_in">comm</span>, kstack] = count(); &#125;<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Got tcp rrt large than 999 µs  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace --unsafe</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/in6.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* definitions.h:11:14: error: invalid application of &#x27;sizeof&#x27; to an incomplete type &#x27;struct sockaddr_in6&#x27;</span></span><br><span class="line"><span class="comment"> definitions.h:10:28: note: forward declaration of &#x27;struct sockaddr_in6&#x27;</span></span><br><span class="line"><span class="comment"> /usr/src/linux-headers-5.4.0-58-generic/include/uapi/linux/in6.h:struct sockaddr_in6 &#123; */</span></span><br><span class="line"></span><br><span class="line">tracepoint:tcp:tcp_probe</span><br><span class="line">&#123;</span><br><span class="line">  $t = elapsed;</span><br><span class="line">  $sadr = (<span class="keyword">struct</span> sockaddr*)(args-&gt;saddr);</span><br><span class="line">  $dadr = (<span class="keyword">struct</span> sockaddr*)(args-&gt;daddr);</span><br><span class="line">  $s = (<span class="keyword">struct</span> sockaddr_in*)$sadr;</span><br><span class="line">  $d = (<span class="keyword">struct</span> sockaddr_in*)$dadr;</span><br><span class="line">  $s = (<span class="keyword">struct</span> sockaddr_in*)$sadr;</span><br><span class="line">  $d = (<span class="keyword">struct</span> sockaddr_in*)$dadr;</span><br><span class="line"></span><br><span class="line">  $rtt = args-&gt;srtt;</span><br><span class="line"></span><br><span class="line">  #<span class="meta"># average</span></span><br><span class="line">  @rtt[ntop(AF_INET, $s-&gt;sin_addr.s_addr), args-&gt;sport] = avg($rtt/<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">if</span> ($rtt &gt; <span class="number">999</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%4d.%09d sec: &quot;</span>, $t / <span class="number">1000000000</span>, $t % <span class="number">1000000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;src %s:%d, dst %s:%d RTT: %d.%03d ms\n&quot;</span>,ntop(AF_INET, $s-&gt;sin_addr.s_addr), args-&gt;sport, ntop(AF_INET, $d-&gt;sin_addr.s_addr), args-&gt;dport, $rtt/<span class="number">1000</span>, $rtt%<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>context-switches, automatic NUMA balancing cause the minor-faults and context-switches (kernel.numa_balancing&#x3D;0)  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$  bpftrace -l | grep software</span><br><span class="line">software:alignment-faults:</span><br><span class="line">software:bpf-output:</span><br><span class="line">software:context-switches:</span><br><span class="line">software:cpu-clock:</span><br><span class="line">software:cpu-migrations:</span><br><span class="line">software:dummy:</span><br><span class="line">software:emulation-faults:</span><br><span class="line">software:major-faults:</span><br><span class="line">software:minor-faults:</span><br><span class="line">software:page-faults:</span><br><span class="line">software:task-clock:</span><br><span class="line">kprobe:software_resume</span><br><span class="line">kprobe:led_stop_software_blink</span><br><span class="line"></span><br><span class="line">$ bpftrace -e  <span class="string">&#x27;software:context-switches:100 &#123; @[comm] = count(); &#125;&#x27;</span></span><br><span class="line">Attaching <span class="number">1</span> probe...</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">@[kworker/<span class="number">0</span>:<span class="number">3</span>]: <span class="number">1</span></span><br><span class="line">@[kworker/<span class="number">15</span>:<span class="number">1</span>]: <span class="number">1</span></span><br><span class="line">@[watchdog/<span class="number">7</span>]: <span class="number">1</span></span><br><span class="line">@[swapper/<span class="number">19</span>]: <span class="number">1</span></span><br><span class="line">@[watchdog/<span class="number">19</span>]: <span class="number">1</span></span><br><span class="line">@[systemd]: <span class="number">1</span></span><br><span class="line">@[swapper/<span class="number">14</span>]: <span class="number">1</span></span><br><span class="line">@[watchdog/<span class="number">8</span>]: <span class="number">2</span></span><br><span class="line">@[in:imjournal]: <span class="number">3</span></span><br><span class="line">@[swapper/<span class="number">7</span>]: <span class="number">4</span></span><br><span class="line">@[rngd]: <span class="number">4</span></span><br><span class="line">@[swapper/<span class="number">5</span>]: <span class="number">4</span></span><br><span class="line">@[bpftrace]: <span class="number">5</span></span><br><span class="line">@[rcu_sched]: <span class="number">6</span></span><br><span class="line">@[atopacctd]: <span class="number">7</span></span><br><span class="line">@[kworker/u432:<span class="number">3</span>]: <span class="number">11</span></span><br><span class="line">@[swapper/<span class="number">15</span>]: <span class="number">11</span></span><br><span class="line">@[kworker/u432:<span class="number">0</span>]: <span class="number">11</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/mikepea/bpf-noodling">bpf-noodling</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bpftrace</span><br><span class="line">/*</span><br><span class="line">  From read(2):</span><br><span class="line">    ssize_t read(int fd, void *buf, size_t count)</span><br><span class="line">  arg2 is &#x27;count&#x27; - the num bytes read.</span><br><span class="line"></span><br><span class="line">  So this reports reads that are less than 16 bytes.</span><br><span class="line">*/</span><br><span class="line">kprobe:vfs_read /arg2 &lt; 16/ &#123;</span><br><span class="line">  printf(&quot;small read: %d byte buffer\n&quot;, arg2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bpftrace</span><br><span class="line"></span><br><span class="line">tracepoint:syscalls:sys_enter_nanosleep</span><br><span class="line">&#123;</span><br><span class="line">   printf(&quot;%s is sleeping.\n&quot;, comm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bpftrace</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * sample one in 100 page faults, and record the process name</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">software:page-faults:100 &#123; @[comm] = count(); &#125;</span><br></pre></td></tr></table></figure>
<p>Got open full path from the function have the pathname parameter    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line"></span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/path.h&gt;</span><br><span class="line"></span><br><span class="line">enum &#123;WALK_TRAILING = 1, WALK_MORE = 2, WALK_NOFOLLOW = 4&#125;;</span><br><span class="line">//struct file *do_filp_open(int dfd, struct filename *pathname,const struct open_flags *op)</span><br><span class="line">//The dfd means (default file descriptor)</span><br><span class="line">//Note that the vfsmount which contains the lookup is determined by the first mountpoint the path lookup reaches – absolute paths start with the vfsmount of /, and relative paths start with the dfd(default file descriptor)&#x27;s vfsmount. Magic-links are only permitted if the vfsmount of the path is unchanged.</span><br><span class="line">//dfd是传入的AT_FDCWD，其定义在 include/uapi/linux/fcntl.h。该值表明当 filename 为相对路径的情况下将当前进程的工作目录设置为起始路径。相对而言， 你可以在另一个系统调用 openat 中为这个起始路&gt;径指定一个目录， 此时 AT_FDCWD 就会被该目录的描述符所替代。</span><br><span class="line">//If pathname is relative and dirfd is the special value AT_FDCWD, then pathname is interpreted relative to the current working directory of the calling process </span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;Tracing do_filp_open calls from %d\n&quot;, $1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kprobe:do_filp_open</span><br><span class="line">&#123;</span><br><span class="line">        $filename = str(((struct filename *)arg1)-&gt;uptr);</span><br><span class="line">        printf(&quot;do_filp_open(dfd=%d, filename-&gt;name=%s)\n&quot;, arg0, $filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Tracepoint"><a href="#Tracepoint" class="headerlink" title="Tracepoint"></a>Tracepoint</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">file path: ./include/trace/define_trace.h</span><br><span class="line"></span><br><span class="line">$ ls /sys/kernel/debug/tracing/events</span><br><span class="line">block             enable      gpio          iommu        libata   mpx   pagemap  ras           scsi      task      workqueue</span><br><span class="line">bridge            exceptions  header_event  irq          mce      napi  percpu   raw_syscalls  signal    timer     writeback</span><br><span class="line">compaction        filelock    header_page   irq_vectors  mdio     net   power    rcu           skb       ucsi      xen</span><br><span class="line">context_tracking  filemap     hyperv        kmem         mei      nfs   printk   regmap        sock      udp       xfs</span><br><span class="line">dma_fence         fs_dax      i2c           kvm          migrate  nfs4  qdisc    rpm           sunrpc    vmscan    xhci-hcd</span><br><span class="line">drm               ftrace      intel_ish     kvmmmu       module   oom   random   sched         syscalls  vsyscall</span><br><span class="line"></span><br><span class="line">$ ls /sys/kernel/debug/tracing/events/syscalls</span><br><span class="line">enable                       sys_enter_name_to_handle_at       sys_exit_accept             sys_exit_newfstat</span><br><span class="line">filter                       sys_enter_nanosleep               sys_exit_accept4            sys_exit_newfstatat</span><br><span class="line">sys_enter_accept             sys_enter_newfstat                sys_exit_access             sys_exit_newlstat</span><br><span class="line">sys_enter_accept4            sys_enter_newfstatat              sys_exit_acct               sys_exit_newstat</span><br><span class="line">sys_enter_access             sys_enter_newlstat                sys_exit_add_key            sys_exit_newuname</span><br><span class="line">sys_enter_acct               sys_enter_newstat                 sys_exit_adjtimex           sys_exit_open</span><br><span class="line">sys_enter_add_key            sys_enter_newuname                sys_exit_alarm              sys_exit_openat</span><br><span class="line">sys_enter_adjtimex           sys_enter_open                    sys_exit_bind               sys_exit_open_by_handle_at</span><br><span class="line">...</span><br><span class="line"># all /proc/kallsyms symbol could add in kprobe</span><br><span class="line">$ cat /proc/kallsyms</span><br><span class="line"></span><br><span class="line">system.map = $(nm vmlinux)</span><br><span class="line">/proc/kallsysms = system.map + loaded modules&#x27;s kallsyms</span><br><span class="line"></span><br><span class="line">$ bpftrace -l | grep sys_enter_nanosleep</span><br><span class="line">tracepoint:syscalls:sys_enter_nanosleep</span><br><span class="line"></span><br><span class="line">$ bpftrace -lv &#x27;t:syscalls:sys_enter_openat&#x27;</span><br><span class="line">tracepoint:syscalls:sys_enter_openat</span><br><span class="line">    int nr;</span><br><span class="line">    int dfd;</span><br><span class="line">    const char * filename;</span><br><span class="line">    int flags;</span><br><span class="line">    umode_t mode;</span><br><span class="line">asmlinkage long sys_openat(int dfd, const char __user *filename, int flags,</span><br><span class="line">                           umode_t mode);</span><br><span class="line"></span><br><span class="line">$ bpftrace -lv &#x27;t:k:tcp_sendmsg&#x27;</span><br><span class="line">int tcp_sendmsg(struct sock *sk, struct msghdr *msg, size_t size);</span><br><span class="line"></span><br><span class="line">$ cat /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">p:kprobes/tcp_sendmsg tcp_sendmsg dst=+0(%di):x32 dport=+12(%di):x16 src=+4(%di):x32 sport=+14(%di):x16 size=%dx</span><br><span class="line"></span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/kprobes/tcp_sendmsg/format</span><br><span class="line">name: tcp_sendmsg</span><br><span class="line">ID: 1734</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_ip; offset:8;       size:8; signed:0;</span><br><span class="line">        field:u32 dst;  offset:16;      size:4; signed:0;</span><br><span class="line">        field:u16 dport;        offset:20;      size:2; signed:0;</span><br><span class="line">        field:u32 src;  offset:22;      size:4; signed:0;</span><br><span class="line">        field:u16 sport;        offset:26;      size:2; signed:0;</span><br><span class="line">        field:u64 size; offset:28;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line">print fmt: &quot;(%lx) dst=0x%x dport=0x%x src=0x%x sport=0x%x size=0x%Lx&quot;, REC-&gt;__probe_ip, REC-&gt;dst, REC-&gt;dport, REC-&gt;src, REC-&gt;sport, REC-&gt;size</span><br><span class="line"></span><br><span class="line">#tracepoint specific</span><br><span class="line">asmlinkage long sys_openat(int dfd, const char __user *filename, int flags,</span><br><span class="line">                           umode_t mode);</span><br><span class="line">$ cat /sys/kernel/debug/tracing/events/syscalls/sys_enter_openat/format</span><br><span class="line">name: sys_enter_openat</span><br><span class="line">ID: 495</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:int nr;   offset:8;       size:4; signed:1;</span><br><span class="line">        field:int dfd;  offset:16;      size:8; signed:0;</span><br><span class="line">        field:const char * filename;    offset:24;      size:8; signed:0;</span><br><span class="line">        field:int flags;        offset:32;      size:8; signed:0;</span><br><span class="line">        field:umode_t mode;     offset:40;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line">print fmt: &quot;dfd: 0x%08lx, filename: 0x%08lx, flags: 0x%08lx, mode: 0x%08lx&quot;, ((unsigned long)(REC-&gt;dfd)), ((unsigned long)(REC-&gt;filename)), ((unsigned long)(REC-&gt;flags)), ((unsigned long)(REC-&gt;mode))</span><br></pre></td></tr></table></figure>
<h4 id="Tracepoint-example"><a href="#Tracepoint-example" class="headerlink" title="Tracepoint example"></a>Tracepoint example</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/include/linux/fs.h</span><br><span class="line"><span class="keyword">extern</span> <span class="type">long</span> <span class="title function_">do_sys_open</span><span class="params">(<span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> __user *filename, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">                        <span class="type">umode_t</span> mode)</span>;</span><br><span class="line">$ cd /sys/kernel/debug/tracing</span><br><span class="line">$ echo <span class="string">&#x27;p:open do_sys_open file=%si&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; events/kprobes/open/enable</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line">#</span><br><span class="line"># _-----=&gt; irqs-off</span><br><span class="line"># / _----=&gt; need-resched</span><br><span class="line"># | / _---=&gt; hardirq/softirq</span><br><span class="line"># || / _--=&gt; preempt-depth</span><br><span class="line"># ||| / delay</span><br><span class="line"># TASK-PID CPU# |||| TIMESTAMP FUNCTION</span><br><span class="line"># | | | |||| | |</span><br><span class="line"> ls<span class="number">-13261</span> [<span class="number">005</span>] ..<span class="number">.1</span> <span class="number">104673.170507</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x250</span>) file=<span class="number">0x562bbf8fe790</span></span><br><span class="line"></span><br><span class="line"># +<span class="number">0</span>(%reg):<span class="built_in">string</span> - Makes %reg into an address that <span class="built_in">string</span> can use</span><br><span class="line">$ echo <span class="string">&#x27;p:open do_sys_open file=+0(%si):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ echo <span class="string">&#x27;p:kprobes/open do_sys_open file=+0($arg2):string&#x27;</span> &gt; kprobe_events <span class="meta"># has the same results </span></span><br><span class="line">$ echo <span class="number">1</span> &gt; /sys/kernel/debug/tracing/events/kprobes/open/enable</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line">#</span><br><span class="line"><span class="meta"># entries-in-buffer/entries-written: 447/447   #P:24</span></span><br><span class="line">#</span><br><span class="line">#                              _-----=&gt; irqs-off</span><br><span class="line">#                             / _----=&gt; need-resched</span><br><span class="line">#                            | / _---=&gt; hardirq/softirq</span><br><span class="line">#                            || / _--=&gt; preempt-depth</span><br><span class="line">#                            ||| /     delay</span><br><span class="line">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span><br><span class="line">#              | |       |   ||||       |         |</span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.631212</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/interrupts&quot;</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.632541</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/stat&quot;</span></span><br><span class="line">      irqbalance<span class="number">-2080</span>  [<span class="number">017</span>] d... <span class="number">127509.632692</span>: open: (do_sys_open+<span class="number">0x0</span>/<span class="number">0x220</span>) file=<span class="string">&quot;/proc/irq/25/smp_affinity&quot;</span></span><br><span class="line"><span class="meta">#function events not work in centos 7.8</span></span><br><span class="line">$ cd /sys/kernel/tracing/events</span><br><span class="line">$ echo <span class="string">&#x27;do_sys_open(NULL, string file)&#x27;</span> &gt; function_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; events/functions/do_sys_open/enable</span><br><span class="line">$ ls &gt; /dev/null</span><br><span class="line">$ cat trace</span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line"><span class="meta"># tracer: nop</span></span><br><span class="line">#</span><br><span class="line"># _-----=&gt; irqs-off</span><br><span class="line"># / _----=&gt; need-resched</span><br><span class="line"># | / _---=&gt; hardirq/softirq</span><br><span class="line"># || / _--=&gt; preempt-depth</span><br><span class="line"># ||| / delay</span><br><span class="line"># TASK-PID CPU# |||| TIMESTAMP FUNCTION</span><br><span class="line"># | | | |||| | |</span><br><span class="line"> ls<span class="number">-822</span> [<span class="number">002</span>] ..<span class="number">.2</span> <span class="number">534.996438</span>: do_syscall_64-&gt;do_sys_open(file=/dev/null)</span><br><span class="line"> ls<span class="number">-822</span> [<span class="number">002</span>] ..<span class="number">.2</span> <span class="number">535.002703</span>: do_syscall_64-&gt;do_sys_open(file=/etc/ld.so.cache)</span><br></pre></td></tr></table></figure>

<h5 id="example2"><a href="#example2" class="headerlink" title="example2"></a><a target="_blank" rel="noopener" href="https://events19.linuxfoundation.org/wp-content/uploads/2017/12/oss-eu-2018-fun-with-dynamic-trace-events_steven-rostedt.pdf">example2</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">(gdb) li ip_rcv</span><br><span class="line">378</span><br><span class="line">379     /*</span><br><span class="line">380      *      Main IP Receive routine.</span><br><span class="line">381      */</span><br><span class="line">382     int ip_rcv(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)</span><br><span class="line">383     &#123;</span><br><span class="line">384             const struct iphdr *iph;</span><br><span class="line">385             u32 len;</span><br><span class="line">386</span><br><span class="line">387             /* When the interface is <span class="keyword">in</span> promisc. mode, drop all the crap</span><br><span class="line">(gdb) ptype struct net_device</span><br><span class="line"><span class="built_in">type</span> = struct net_device &#123;</span><br><span class="line">    char name[16];</span><br><span class="line">    struct hlist_node name_hlist;</span><br><span class="line">    char *ifalias;</span><br><span class="line">...</span><br><span class="line">    unsigned char perm_addr[32];</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#not work in centos 7.8, high kernel version is ok</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:net ip_rcv dev=$arg2 name=+0($arg2):string&#x27;</span> &gt; kprobe_events</span><br><span class="line">$ <span class="built_in">cat</span> kprobe_events</span><br><span class="line">p:kprobes/net ip_rcv dev=<span class="variable">$arg2</span> name=+0(<span class="variable">$arg2</span>):string</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; events/kprobes/enable</span><br><span class="line">$ <span class="built_in">cat</span> trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 460/460   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                              ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |         |   ||||      |         |</span></span><br><span class="line">          &lt;idle&gt;-0       [002] ..s. 201549.228307: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579520: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579534: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line">          &lt;idle&gt;-0       [006] ..s. 201549.579542: net: (ip_rcv+0x0/0xd0) dev=0xffff975632a1b000 name=<span class="string">&quot;br0&quot;</span></span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct net_device *)<span class="number">0</span>)-&gt;perm_addr</span><br><span class="line"><span class="variable">$1</span> = <span class="number">598</span></span><br><span class="line"></span><br><span class="line">$ echo &#x27;p:net ip_rcv name=+<span class="number">0</span>(<span class="variable">$arg2</span>):string a1=+<span class="number">598</span>(<span class="variable">$arg2</span>):x8 a2=+<span class="number">599</span>(<span class="variable">$arg2</span>):x8 a3=+<span class="number">600</span>(<span class="variable">$arg2</span>):x8 a4=+<span class="number">601</span>(<span class="variable">$arg2</span>):x8 a5=+<span class="number">602</span>(<span class="variable">$arg2</span>):x8 a6=+<span class="number">603</span>(<span class="variable">$arg2</span>):x8&#x27; &gt; kprobe_events</span><br><span class="line">$ head -n <span class="number">15</span> trace</span><br><span class="line"># tracer: nop</span><br><span class="line">#</span><br><span class="line"># entries-in-buffer/entries-written: <span class="number">84</span>/<span class="number">84</span>   #P:<span class="number">24</span></span><br><span class="line">#</span><br><span class="line">#                                _-----=&gt; irqs-off</span><br><span class="line">#                               / _----=&gt; need-resched</span><br><span class="line">#                              | / _---=&gt; hardirq/softirq</span><br><span class="line">#                              || / _--=&gt; preempt-depth</span><br><span class="line">#                              ||| /     delay</span><br><span class="line">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span><br><span class="line">#              | |         |   ||||      |         |</span><br><span class="line">          &lt;idle&gt;-<span class="number">0</span>       [<span class="number">021</span>] ..s. <span class="number">202995.512725</span>: net: (ip_rcv+<span class="number">0</span>x0/<span class="number">0</span>xd0) name=&quot;br0&quot; a1=<span class="number">0</span>x0 a2=<span class="number">0</span>x0 a3=<span class="number">0</span>x0 a4=<span class="number">0</span>x0 a5=<span class="number">0</span>x0 a6=<span class="number">0</span>x0</span><br><span class="line">           &lt;...&gt;-<span class="number">207344</span>  [<span class="number">003</span>] ..s. <span class="number">202995.750896</span>: net: (ip_rcv+<span class="number">0</span>x0/<span class="number">0</span>xd0) name=&quot;eno3&quot; a1=<span class="number">0</span>x18 a2=<span class="number">0</span>x66 a3=<span class="number">0</span>xda a4=<span class="number">0</span>x91 a5=<span class="number">0</span>x97 a6=<span class="number">0</span>x9</span><br><span class="line">#eno3 ether <span class="number">18</span>:<span class="number">66</span>:da:<span class="number">91</span>:<span class="number">97</span>:<span class="number">09</span>, looks like br0 no mac addr</span><br><span class="line"></span><br><span class="line">(gdb) li vfs_read</span><br><span class="line"><span class="number">446</span>     &#125;</span><br><span class="line"><span class="number">447</span></span><br><span class="line"><span class="number">448</span>     EXPORT_SYMBOL(do_sync_read);</span><br><span class="line"><span class="number">449</span></span><br><span class="line"><span class="number">450</span>     ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line"><span class="number">451</span>     &#123;</span><br><span class="line"><span class="number">452</span>             ssize_t ret;</span><br><span class="line"><span class="number">453</span></span><br><span class="line"><span class="number">454</span>             if (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">455                     <span class="built_in">return</span> -EBADF;</span><br><span class="line">(gdb)  ptype struct file</span><br><span class="line"><span class="built_in">type</span> = struct file &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct list_head fu_list;</span><br><span class="line">        struct callback_head fu_rcuhead;</span><br><span class="line">    &#125; f_u;</span><br><span class="line">    struct path f_path;</span><br><span class="line">    struct inode *f_inode;</span><br><span class="line">(gdb) ptype struct inode</span><br><span class="line"><span class="built_in">type</span> = struct inode &#123;</span><br><span class="line">    umode_t i_mode;</span><br><span class="line">    unsigned short i_opflags;</span><br><span class="line">    kuid_t i_uid;</span><br><span class="line">    kgid_t i_gid;</span><br><span class="line">    unsigned int i_flags;</span><br><span class="line">    struct posix_acl *i_acl;</span><br><span class="line">    struct posix_acl *i_default_acl;</span><br><span class="line">    const struct inode_operations *i_op;</span><br><span class="line">    struct super_block *i_sb;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct super_block</span><br><span class="line"><span class="built_in">type</span> = struct super_block &#123;</span><br><span class="line">    struct list_head s_list;</span><br><span class="line">    dev_t s_dev;</span><br><span class="line">    unsigned char s_blocksize_bits;</span><br><span class="line">    unsigned long s_blocksize;</span><br><span class="line">    loff_t s_maxbytes;</span><br><span class="line">    struct file_system_type *s_type;</span><br><span class="line">...</span><br><span class="line">(gdb) ptype struct file_system_type</span><br><span class="line"><span class="built_in">type</span> = struct file_system_type &#123;</span><br><span class="line">    const char *name;</span><br><span class="line"></span><br><span class="line">(gdb)  <span class="built_in">print</span> (int)&amp;((struct file *)<span class="number">0</span>)-&gt;f_inode</span><br><span class="line"><span class="variable">$1</span> = <span class="number">32</span></span><br><span class="line">(gdb) print (int)&amp;((struct inode *)<span class="number">0</span>)-&gt;i_sb</span><br><span class="line"><span class="variable">$2</span> = <span class="number">40</span></span><br><span class="line">(gdb)  print (int)&amp;((struct super_block *)<span class="number">0</span>)-&gt;s_type</span><br><span class="line"><span class="variable">$3</span> = <span class="number">40</span></span><br><span class="line">(gdb)  print (int)&amp;((struct file_system_type *)<span class="number">0</span>)-&gt;name</span><br><span class="line"><span class="variable">$4</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#not working centos <span class="number">7.8</span></span><br><span class="line">$ cd /sys/kernel/debug/tracing</span><br><span class="line">$ echo &#x27;p:myprobe vfs_read name=+<span class="number">0</span>(+<span class="number">0</span>(+<span class="number">40</span>(+<span class="number">40</span>(+<span class="number">32</span>(<span class="variable">$arg1</span>))))):string<span class="string">&#x27; &gt; kprobe_events</span></span><br><span class="line"><span class="string">$ echo 1 &gt; events/kprobes/enable</span></span><br><span class="line"><span class="string">$ cat trace</span></span><br><span class="line"><span class="string"># tracer: nop</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># entries-in-buffer/entries-written: 37/37   #P:24</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#                                _-----=&gt; irqs-off</span></span><br><span class="line"><span class="string">#                               / _----=&gt; need-resched</span></span><br><span class="line"><span class="string">#                              | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="string">#                              || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="string">#                              ||| /     delay</span></span><br><span class="line"><span class="string">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="string">#              | |         |   ||||      |         |</span></span><br><span class="line"><span class="string">           &lt;...&gt;-520179  [018] .... 206923.224377: myprobe: (vfs_read+0x0/0x160) name=&quot;devtmpfs&quot;</span></span><br><span class="line"><span class="string">           &lt;...&gt;-520179  [018] .... 206924.886880: myprobe: (vfs_read+0x0/0x160) name=&quot;sockfs&quot;</span></span><br><span class="line"><span class="string">           &lt;...&gt;-520240  [001] .... 206924.887006: myprobe: (vfs_read+0x0/0x160) name=&quot;devpts&quot;</span></span><br><span class="line"><span class="string">           &lt;...&gt;-520240  [001] .... 206924.887022: myprobe: (vfs_read+0x0/0x160) name=&quot;devpts&quot;</span></span><br><span class="line"><span class="string">           &lt;...&gt;-520240  [001] .... 206924.887029: myprobe: (vfs_read+0x0/0x160) name=&quot;devpts&quot;</span></span><br><span class="line"><span class="string">           &lt;...&gt;-520179  [018] .... 206924.887110: myprobe: (vfs_read+0x0/0x160) name=&quot;devtmpfs&quot;</span></span><br></pre></td></tr></table></figure>
<p>The same with the perf   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## The server installed debug-info</span></span><br><span class="line">$ perf probe -L vfs_read:0+10</span><br><span class="line">&lt;vfs_read@/usr/src/debug/kernel-3.10.0-1127.el7/linux-3.10.0-1127.el7.x86_64/fs/read_write.c:0&gt;</span><br><span class="line">      0  ssize_t vfs_read(struct file *file, char __user *buf, size_t count, loff_t *pos)</span><br><span class="line">      1  &#123;</span><br><span class="line">                ssize_t ret;</span><br><span class="line"></span><br><span class="line">      4         <span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">      5                 <span class="built_in">return</span> -EBADF;</span><br><span class="line">      6         <span class="keyword">if</span> (!file-&gt;f_op || (!file-&gt;f_op-&gt;<span class="built_in">read</span> &amp;&amp; !file-&gt;f_op-&gt;aio_read))</span><br><span class="line">      7                 <span class="built_in">return</span> -EINVAL;</span><br><span class="line">      8         <span class="keyword">if</span> (unlikely(!access_ok(VERIFY_WRITE, buf, count)))</span><br><span class="line">      9                 <span class="built_in">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">$ perf probe <span class="string">&#x27;vfs_read file-&gt;f_inode file-&gt;f_inode-&gt;i_sb file-&gt;f_inode-&gt;i_sb-&gt;s_type file-&gt;f_inode-&gt;i_sb-&gt;s_type-&gt;name:string&#x27;</span></span><br><span class="line"><span class="comment">### echo &#x27;p:myprobe vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27; &gt; kprobe_events</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR <span class="built_in">sleep</span> 1</span><br><span class="line">$ perf report</span><br><span class="line">  33.33%  (ffffffff87a4cf20) f_inode=0xffff8e7e363aaa80 i_sb=0xffff8e8037bda800 s_type=0xffffffffc0430500 name=<span class="string">&quot;xfs&quot;</span></span><br><span class="line">  22.22%  (ffffffff87a4cf20) f_inode=0xffff8e803b86a060 i_sb=0xffff8e7f7c923000 s_type=0xffffffff884b1be0 name=<span class="string">&quot;anon_inodefs&quot;</span></span><br><span class="line">  22.22%  (ffffffff87a4cf20) f_inode=0xffff8e803bbec8c0 i_sb=0xffff8e8037bda800 s_type=0xffffffffc0430500 name=<span class="string">&quot;xfs&quot;</span></span><br><span class="line">....</span><br><span class="line">$ perf probe -d vfs_read</span><br><span class="line">Removed event: probe:vfs_read</span><br><span class="line"></span><br><span class="line"><span class="comment">#### not support centos 7.8, work on ubuntu 20.04</span></span><br><span class="line">$ perf probe <span class="string">&#x27;vfs_read name=+0(+0(+40(+40(+32($arg1))))):string&#x27;</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR <span class="built_in">sleep</span> 1</span><br><span class="line">$ perf report</span><br><span class="line">  85.71%  (ffffffff8badefd0) name=<span class="string">&quot;ext4&quot;</span></span><br><span class="line">   7.14%  (ffffffff8badefd0) name=<span class="string">&quot;proc&quot;</span></span><br><span class="line">   7.14%  (ffffffff8badefd0) name=<span class="string">&quot;tmpfs&quot;</span></span><br><span class="line">$ perf record -e probe:vfs_read -aR <span class="built_in">sleep</span> 1</span><br><span class="line">$ perf probe -d vfs_read</span><br><span class="line"></span><br><span class="line"><span class="comment">#another example  https://docs.windriver.com/bundle/Wind_River_Linux_Tutorial_Kernel_Debugging_with_ftrace_and_kprobes_LTS_19/page/mmo1403548860893.html</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:doforkprobe _do_fork clone_flags=%ax stack_start=%dx regs=%cx parent_tidptr=+4($stack) child_tidptr=+8($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:fork_retprobe _do_fork $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:dentry_openprobe dentry_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure>



<h3 id="kprobe"><a href="#kprobe" class="headerlink" title="kprobe"></a>kprobe</h3><p>get the kprobe demo source code from linux kernel source  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/kprobes/enabled</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment"># The same results</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/available_filter_functions</span><br><span class="line">$ bpftrace -l kprobe:*</span><br><span class="line"></span><br><span class="line">$ bpftrace -l kprobe:*nfs42*</span><br><span class="line">kprobe:nfs42_clone_file_range</span><br><span class="line">kprobe:nfs42_fallocate</span><br><span class="line">kprobe:_nfs42_proc_fallocate</span><br><span class="line">kprobe:nfs42_proc_fallocate</span><br><span class="line">kprobe:_nfs42_proc_clone</span><br><span class="line">kprobe:_nfs42_proc_llseek</span><br><span class="line">kprobe:nfs42_layoutstat_prepare</span><br><span class="line">kprobe:nfs42_layoutstat_release</span><br><span class="line">kprobe:nfs42_layoutstat_done</span><br><span class="line">kprobe:nfs42_proc_allocate</span><br><span class="line">kprobe:nfs42_proc_deallocate</span><br><span class="line">kprobe:nfs42_proc_copy</span><br><span class="line">kprobe:nfs42_proc_llseek</span><br><span class="line">kprobe:nfs42_proc_layoutstats_generic</span><br><span class="line">probe:nfs42_proc_clone</span><br><span class="line"></span><br><span class="line">$ bpftrace -l kprobe:sys_unlinkat</span><br><span class="line">kprobe:SyS_unlinkat</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/kallsyms</span><br><span class="line"><span class="comment"># add kprobe for all symbols from /proc/kallsyms</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/kallsyms | grep do_sys_open</span><br><span class="line">ffffffff8b44bec0 T do_sys_open</span><br><span class="line"></span><br><span class="line">$ nm /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux |grep do_fork</span><br><span class="line">ffffffff8109acc0 T do_fork</span><br><span class="line">ffffffff81cf62e0 d do_fork_test</span><br><span class="line">$ <span class="built_in">cat</span> /proc/kallsyms |grep do_fork</span><br><span class="line">ffffffff8d69acc0 T do_fork</span><br><span class="line">ffffffff8e2f62e0 d do_fork_test</span><br><span class="line"></span><br><span class="line"><span class="comment">#it could assigning the register data</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/kprobes/enabled</span><br><span class="line">1</span><br><span class="line">$ <span class="built_in">cat</span> /proc/sys/debug/kprobes-optimization</span><br><span class="line">1</span><br><span class="line">/sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events <span class="comment">#the return value is number</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/events/kprobes/myprobe/format</span><br><span class="line"></span><br><span class="line">name: myprobe</span><br><span class="line">ID: 1662</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_ip; offset:8;       size:8; signed:0;</span><br><span class="line">        field:u64 dfd;  offset:16;      size:8; signed:0;</span><br><span class="line">        field:u64 filename;     offset:24;      size:8; signed:0;</span><br><span class="line">        field:u64 flags;        offset:32;      size:8; signed:0;</span><br><span class="line">        field:u64 mode; offset:40;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">fmt</span>: <span class="string">&quot;(%lx) dfd=0x%Lx filename=0x%Lx flags=0x%Lx mode=0x%Lx&quot;</span>, REC-&gt;__probe_ip, REC-&gt;dfd, REC-&gt;filename, REC-&gt;flags, REC-&gt;mode</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myprobe getname +0($retval):string&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events <span class="comment">#the return value is string</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 61/61   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">             cat-13819 [015] d... 280432.427059: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x88000 flags=0x4150 mode=0xffffffff</span><br><span class="line">             cat-13819 [015] d... 280432.427069: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x88000 flags=0x4150 mode=0xffffffff</span><br><span class="line">             irqbalance-2106  [019] d... 280436.335586: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x8000 flags=0x1b6 mode=0xffffffff</span><br><span class="line">             irqbalance-2106  [019] d... 280436.337937: myprobe: (do_sys_open+0x0/0x220) dfd=0xffffffff8b44c0e0 filename=0x8000 flags=0x1b6 mode=0xffffffff</span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span><br><span class="line">$ <span class="built_in">echo</span> -:myprobe &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"><span class="comment"># clear all</span></span><br><span class="line">$ <span class="built_in">echo</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/local/sbin/ply</span></span><br><span class="line">kprobe:sys_unlinkat / !strcmp(execname, <span class="string">&quot;rm&quot;</span>) /</span><br><span class="line">&#123;</span><br><span class="line">   t[pid] =  walltime;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;pid: %d %s\n&quot;</span>, pid, str(arg1) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:sys_unlinkat / !strcmp(execname, <span class="string">&quot;rm&quot;</span>) /</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sys_unlinkat take time: %lld ns\n&quot;</span>, walltime - t[pid] );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="test-the-kprobe-sample-codes"><a href="#test-the-kprobe-sample-codes" class="headerlink" title="test the kprobe sample codes"></a>test the kprobe sample codes</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">do_int3()</span><br><span class="line">└→ notify_die()</span><br><span class="line">   └→ atomic_notifier_call_chain()</span><br><span class="line">      └→ __atomic_notifier_call_chain()</span><br><span class="line">         └→ notifier_call_chain()</span><br><span class="line">            └→ kprobe_exceptions_notify()</span><br><span class="line">do_debug()</span><br><span class="line">└→ notify_die()</span><br><span class="line">   └→ atomic_notifier_call_chain()</span><br><span class="line">      └→ __atomic_notifier_call_chain()</span><br><span class="line">         └→ notifier_call_chain()</span><br><span class="line">            └→ kprobe_exceptions_notify()</span><br><span class="line">               └→ post_kprobe_handler()</span><br><span class="line">                  └→ post_handler()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> linux-3.10.0-1127.el7/samples/kprobes</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">jprobe_example.c  kprobe_example.c  kretprobe_example.c</span><br><span class="line"></span><br><span class="line"><span class="comment">## work with kretprobe_example.c</span></span><br><span class="line">$ <span class="built_in">cat</span> Makefile</span><br><span class="line">obj-m := kretprobe_example.o</span><br><span class="line">KERNEL := /lib/modules/`<span class="built_in">uname</span> -r`/build</span><br><span class="line">all:</span><br><span class="line">        make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` modules</span><br><span class="line">install:</span><br><span class="line">        make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` modules_install</span><br><span class="line">        depmod -A</span><br><span class="line">clean:</span><br><span class="line">        make -C $(KERNEL)   M=`<span class="built_in">pwd</span>` clean</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">jprobe_example.c  kretprobe_example.c   kretprobe_example.mod.c  kretprobe_example.o  modules.order</span><br><span class="line">kprobe_example.c  kretprobe_example.ko  kretprobe_example.mod.o  Makefile             Module.symvers</span><br><span class="line"></span><br><span class="line">$ insmod ./kretprobe_example.ko</span><br><span class="line"></span><br><span class="line">$ dmesg -T</span><br><span class="line">[Tue Dec 15 02:27:50 2020] do_fork returned 5570 and took 30141 ns to execute</span><br><span class="line">[Tue Dec 15 02:27:51 2020] do_fork returned 5571 and took 131646 ns to execute</span><br><span class="line"></span><br><span class="line">$ lsmod | grep kret</span><br><span class="line">kretprobe_example      12696  0</span><br><span class="line">$ rmmod kretprobe_example</span><br><span class="line">$ lsmod | grep kret</span><br><span class="line">$ dmesg -T</span><br><span class="line">[Tue Dec 15 02:30:23 2020] kretprobe at ffffffff8d69acc0 unregistered</span><br><span class="line">[Tue Dec 15 02:30:23 2020] Missed probing 0 instances of do_fork</span><br></pre></td></tr></table></figure>
<ul>
<li>linux-3.10.0-1127.el7&#x2F;include&#x2F;linux&#x2F;sysctl.h<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct ctl_table</span><br><span class="line">&#123;</span><br><span class="line">        const char *procname;           /* Text ID <span class="keyword">for</span> /proc/sys, or zero */</span><br><span class="line">        void *data;</span><br><span class="line">        int maxlen;</span><br><span class="line">        umode_t mode;</span><br><span class="line">        struct ctl_table *child;        /* Deprecated */</span><br><span class="line">        proc_handler *proc_handler;     /* Callback <span class="keyword">for</span> text formatting */</span><br><span class="line">        struct ctl_table_poll *poll;</span><br><span class="line">        void *extra1;</span><br><span class="line">        void *extra2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//mode,access permission</span><br><span class="line">//porc_dointvec, one or more int array[]</span><br><span class="line">//proc_dostring, <span class="built_in">read</span> and write stirng</span><br><span class="line">//proc_dointvec_minmax, the int value range from min to max</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="inject-function"><a href="#inject-function" class="headerlink" title="inject function"></a>inject function</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">uname</span> -r</span><br><span class="line">3.10.0-1127.el7.x86_64</span><br><span class="line">$ bpftrace -V</span><br><span class="line">bpftrace v0.11.0-118-gf543-dirty</span><br><span class="line">$ bpftrace -e <span class="string">&#x27;k:xs_tcp_send_request &#123;printf(&quot;override PID %d\n&quot;, pid);override(-5); &#125;&#x27;</span> --unsafe</span><br><span class="line">$ vi linux-3.10.0-1127.el7/net/sunrpc/xprtsock.c</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * xs_tcp_send_request - write an RPC request to a TCP socket</span><br><span class="line"> * @task: address of RPC task that manages the state of an RPC request</span><br><span class="line"> *</span><br><span class="line"> * Return values:</span><br><span class="line"> *        0:    The request has been sent</span><br><span class="line"> *   EAGAIN:    The socket was blocked, please call again later to</span><br><span class="line"> *              complete the request</span><br><span class="line"> * ENOTCONN:    Caller needs to invoke connect logic <span class="keyword">then</span> call again</span><br><span class="line"> *    other:    Some other error occurred, the request was not sent</span><br><span class="line"> *</span><br><span class="line"> * XXX: In the <span class="keyword">case</span> of soft timeouts, should we eventually give up</span><br><span class="line"> *      <span class="keyword">if</span> sendmsg is not able to make progress?</span><br><span class="line"> */</span><br><span class="line">static int xs_tcp_send_request(struct rpc_task *task)</span><br><span class="line">....</span><br><span class="line">        <span class="built_in">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe xs_tcp_send_request $retval&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/events/kprobes/myretprobe/format</span><br><span class="line">name: myretprobe</span><br><span class="line">ID: 1660</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_func;       offset:8;       size:8; signed:0;</span><br><span class="line">        field:unsigned long __probe_ret_ip;     offset:16;      size:8; signed:0;</span><br><span class="line">        field:u64 arg1; offset:24;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">fmt</span>: <span class="string">&quot;(%lx &lt;- %lx) arg1=0x%Lx&quot;</span>, REC-&gt;__probe_func, REC-&gt;__probe_ret_ip, REC-&gt;arg1</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/enable</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 24/24   #P:24</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">  kworker/u433:0-18077 [017] d... 281350.965310: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">           &lt;...&gt;-170470 [008] d... 281350.968731: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">  kworker/u433:0-18077 [021] d... 281356.021502: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line">           &lt;...&gt;-170470 [008] d... 281356.024915: myretprobe: (xprt_transmit+0x6c/0x360 [sunrpc] &lt;- xs_tcp_send_request) arg1=0xfffffffffffffffb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decimal from signed 2&#x27;s complement: 0xfffffffffffffffb = -5</span></span><br><span class="line"><span class="comment"># How to calculate ?</span></span><br><span class="line"><span class="comment"># 5 = 0000,0101</span></span><br><span class="line"><span class="comment"># Get complement: 1111,1010</span></span><br><span class="line"><span class="comment"># Add 1: 1111,1011</span></span><br><span class="line"><span class="comment">#         f , b</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/enable</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot;struct rpc_task &#123;&quot;</span> linux-3.10.0-1127.el7/include/linux/sunrpc/sched.h -A 50</span><br><span class="line">struct rpc_task &#123;</span><br><span class="line">        atomic_t                tk_count;       /* Reference count */</span><br><span class="line">        int                     tk_status;      /* result of last operation */</span><br><span class="line">        struct list_head        tk_task;        /* global list of tasks */</span><br><span class="line"></span><br><span class="line"><span class="comment">#The kernel module sunrpc.ko not in vmlinux, try to loading the kernel module</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc</span><br><span class="line">$ <span class="built_in">cp</span> sunrpc.ko.xz sunrpc-1.ko.xz</span><br><span class="line">$ xd -d sunrpc-1.ko.xz</span><br><span class="line">$ <span class="built_in">mv</span> sunrpc-1.ko sunrpc.ko</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/module/sunrpc/sections/.text</span><br><span class="line">0xffffffffc0bf9000</span><br><span class="line"></span><br><span class="line">$ add-symbol-file /lib/modules/3.10.0-1127.el7.x86_64/extra/qlgc-fastlinq/qede.ko 0xffffffffc022b000</span><br><span class="line"></span><br><span class="line">$ gdb /usr/lib/debug/lib/modules/3.10.0-1127.el7.x86_64/vmlinux</span><br><span class="line">$ add-symbol-file /usr/lib/modules/3.10.0-1127.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0bf9000</span><br><span class="line">$ add-symbol-file /usr/lib/modules/3.10.0-957.el7.x86_64/kernel/net/sunrpc/sunrpc.ko 0xffffffffc0396000</span><br><span class="line">(gdb) list xs_tcp_send_request</span><br><span class="line">655      *</span><br><span class="line">656      * XXX: In the <span class="keyword">case</span> of soft timeouts, should we eventually give up</span><br><span class="line">657      *      <span class="keyword">if</span> sendmsg is not able to make progress?</span><br><span class="line">658      */</span><br><span class="line">659     static int xs_tcp_send_request(struct rpc_task *task)</span><br><span class="line">660     &#123;</span><br><span class="line">661             struct rpc_rqst *req = task-&gt;tk_rqstp;</span><br><span class="line">662             struct rpc_xprt *xprt = req-&gt;rq_xprt;</span><br><span class="line">663             struct sock_xprt *transport = container_of(xprt, struct sock_xprt, xprt);</span><br><span class="line">664             struct xdr_buf *xdr = &amp;req-&gt;rq_snd_buf;</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">print</span> (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_count</span><br><span class="line"><span class="variable">$1</span> = <span class="number">0</span></span><br><span class="line">(gdb) print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_timeout</span><br><span class="line"><span class="variable">$3</span> = <span class="number">40</span></span><br><span class="line">(gdb) print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_runstate</span><br><span class="line"><span class="variable">$4</span> = <span class="number">48</span></span><br><span class="line">(gdb) print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_msg</span><br><span class="line"><span class="variable">$6</span> = <span class="number">120</span></span><br><span class="line">(gdb) print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_start</span><br><span class="line"><span class="variable">$5</span> = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">$ echo &#x27;r:myretprobe xs_tcp_send_request count=+<span class="number">0</span>(%di):u32 run_sta=+<span class="number">48</span>(%di):u32 tk_msg=+<span class="number">120</span>(%di):x64&#x27; &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/enable</span><br><span class="line">$ cat trace</span><br><span class="line">           &lt;...&gt;-<span class="number">81155</span> [<span class="number">020</span>] d... <span class="number">95057.395523</span>: myretprobe: (xprt_transmit+<span class="number">0</span>x6c/<span class="number">0</span>x360 [sunrpc] &lt;- xs_tcp_send_request) count=<span class="number">0</span>x0 run_sta=<span class="number">0</span>x0 tk_msg=<span class="number">0</span>xc0bfafb0ffff8bbb</span><br><span class="line">           &lt;...&gt;-<span class="number">81155</span> [<span class="number">010</span>] d... <span class="number">95057.395638</span>: myretprobe: (xprt_transmit+<span class="number">0</span>x6c/<span class="number">0</span>x360 [sunrpc] &lt;- xs_tcp_send_request) count=<span class="number">0</span>x0 run_sta=<span class="number">0</span>x0 tk_msg=<span class="number">0</span>xc0bfafb0ffff8bbb</span><br><span class="line">.....</span><br><span class="line">           &lt;...&gt;-<span class="number">81165</span> [<span class="number">008</span>] d... <span class="number">95063.283924</span>: myretprobe: (xprt_transmit+<span class="number">0</span>x6c/<span class="number">0</span>x360 [sunrpc] &lt;- xs_tcp_send_request) count=<span class="number">0</span>x0 run_sta=<span class="number">0</span>x0 tk_msg=<span class="number">0</span>xc0bfafb0ffff8bab</span><br><span class="line">           &lt;...&gt;-<span class="number">81165</span> [<span class="number">008</span>] d... <span class="number">95063.283973</span>: myretprobe: (xprt_transmit+<span class="number">0</span>x6c/<span class="number">0</span>x360 [sunrpc] &lt;- xs_tcp_send_request) count=<span class="number">0</span>x0 run_sta=<span class="number">0</span>x0 tk_msg=<span class="number">0</span>xc0bfafb0ffff8bab</span><br><span class="line"></span><br><span class="line">(gdb) print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_client</span><br><span class="line"><span class="variable">$17</span> = <span class="number">168</span></span><br><span class="line">(gdb) print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_client-&gt;cl_metrics-&gt;om_ops</span><br><span class="line"><span class="variable">$18</span> = <span class="number">8</span></span><br><span class="line">(gdb)  print (int)&amp;((struct rpc_task *)<span class="number">0</span>)-&gt;tk_client-&gt;cl_metrics-&gt;om_ntrans</span><br><span class="line"><span class="variable">$19</span> = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">$ echo &#x27;p:myprobe xs_tcp_send_request count=+<span class="number">0</span>(%di):u32 run_sta=+<span class="number">48</span>(%di):u32 pid=+<span class="number">208</span>(%di):u32&#x27; &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line">$ echo <span class="number">1</span> &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span><br><span class="line"></span><br><span class="line">$ cat trace </span><br><span class="line">           &lt;...&gt;-<span class="number">88620</span> [<span class="number">001</span>] d... <span class="number">103530.318261</span>: myprobe: (xs_tcp_send_request+<span class="number">0</span>x0/<span class="number">0</span>x230 [sunrpc]) count=<span class="number">0</span>x2 run_sta=<span class="number">0</span>x5 pid=<span class="number">0</span>x15a2c</span><br><span class="line">           &lt;...&gt;-<span class="number">88620</span> [<span class="number">001</span>] d... <span class="number">103530.354814</span>: myprobe: (xs_tcp_send_request+<span class="number">0</span>x0/<span class="number">0</span>x230 [sunrpc]) count=<span class="number">0</span>x2 run_sta=<span class="number">0</span>x5 pid=<span class="number">0</span>x15a2c</span><br><span class="line">           &lt;...&gt;-<span class="number">88469</span> [<span class="number">004</span>] d... <span class="number">103587.916562</span>: myprobe: (xs_tcp_send_request+<span class="number">0</span>x0/<span class="number">0</span>x230 [sunrpc]) count=<span class="number">0</span>x1 run_sta=<span class="number">0</span>x5 pid=<span class="number">0</span>xe5</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>xe5=<span class="number">229</span></span><br><span class="line">root        <span class="number">229</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    Dec19   <span class="number">0</span>:<span class="number">00</span> [kworker/<span class="number">2</span>:<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h4 id="debug-example"><a href="#debug-example" class="headerlink" title="debug example"></a>debug example</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">[Fri Jan 15 20:25:37 2021] ------------[ <span class="built_in">cut</span> here ]------------</span><br><span class="line">[Fri Jan 15 20:25:37 2021] WARNING: CPU: 68 PID: 111577 at kernel/irq/manage.c:1452 free_irq+0x6a/0x90</span><br><span class="line">[Fri Jan 15 20:25:37 2021] Modules linked <span class="keyword">in</span>: netlink_diag mgc(OE) lustre(OE) lmv(OE) mdc(OE) fid(OE) osc(OE) lov(OE) fld(OE) ksocklnd(OE) ptlrpc(OE) obdclass(OE) lnet(OE) libcfs(OE) nfsv3 nfs_acl nfs lockd grace fscache pktgen ib_isert iscsi_target_mod ib_srpt bonding target_core_mod ib_srp scsi_transport_srp scsi_tgt ib_ipoib ib_umad mpt2sas raid_class mptctl mptbase rpcrdma rdma_ucm ib_uverbs ib_iser rdma_cm iw_cm ib_cm libiscsi scsi_transport_iscsi dell_rbu ses enclosure scsi_transport_sas amd64_edac_mod edac_mce_amd kvm irqbypass crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd pcspkr dcdbas vfat fat joydev cdc_ether usbnet mii sg qedr ib_core megaraid_sas i2c_piix4 k10temp ipmi_si ipmi_devintf ipmi_msghandler pinctrl_amd i2c_designware_platform i2c_designware_core acpi_cpufreq</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  binfmt_misc auth_rpcgss sunrpc ip_tables ext4 mbcache jbd2 sd_mod crc_t10dif crct10dif_generic mgag200 i2c_algo_bit drm_kms_helper syscopyarea crct10dif_pclmul crct10dif_common sysfillrect crc32c_intel qede ptp sysimgblt fb_sys_fops ttm pps_core ahci drm libahci qed libata drm_panel_orientation_quirks crc8 nfit libnvdimm [last unloaded: libcfs]</span><br><span class="line">[Fri Jan 15 20:25:37 2021] CPU: 68 PID: 111577 Comm: ifconfig Kdump: loaded Tainted: G        W  OE  ------------ T 3.10.0-1127.el7.x86_64 <span class="comment">#1</span></span><br><span class="line">[Fri Jan 15 20:25:37 2021] Hardware name: Lenovo ThinkSystem SR665/7D2VCTO1WW, BIOS D8E110J-1.20 11/09/2020</span><br><span class="line">[Fri Jan 15 20:25:37 2021] Call Trace:</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b7ff85&gt;] dump_stack+0x19/0x1b</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9149bd18&gt;] __warn+0xd8/0x100</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9149be5d&gt;] warn_slowpath_null+0x1d/0x20</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff9155109a&gt;] free_irq+0x6a/0x90</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022b706&gt;] qede_sync_free_irqs+0x66/0xc0 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022eb06&gt;] qede_load+0x8a6/0x1150 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b8db6f&gt;] ? notifier_call_chain+0x4f/0x70</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffffc022f6fe&gt;] qede_open+0x3e/0xb0 [qede]</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a581b2&gt;] __dev_open+0xd2/0x150</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a584e3&gt;] __dev_change_flags+0xa3/0x180</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a585e9&gt;] dev_change_flags+0x29/0x60</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91ada523&gt;] devinet_ioctl+0x6e3/0x7e0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91adb645&gt;] inet_ioctl+0x75/0xa0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a3149b&gt;] sock_do_ioctl+0x2b/0x60</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91a316bb&gt;] sock_ioctl+0x1eb/0x2d0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91662810&gt;] do_vfs_ioctl+0x3a0/0x5b0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b8d678&gt;] ? __do_page_fault+0x238/0x500</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91662ac1&gt;] SyS_ioctl+0xa1/0xc0</span><br><span class="line">[Fri Jan 15 20:25:37 2021]  [&lt;ffffffff91b92ed2&gt;] system_call_fastpath+0x25/0x2a</span><br><span class="line">[Fri Jan 15 20:25:37 2021] ---[ end trace 6abd3d242706b4fe ]---</span><br><span class="line"></span><br><span class="line">(gdb) list *free_irq+0x6a/0x90</span><br><span class="line">0xffffffff81151030 is <span class="keyword">in</span> free_irq (kernel/irq/manage.c:1443).</span><br><span class="line">1438	 *	This <span class="keyword">function</span> must not be called from interrupt context.</span><br><span class="line">1439	 *</span><br><span class="line">1440	 *	Returns the devname argument passed to request_irq.</span><br><span class="line">1441	 */</span><br><span class="line">1442	const void *free_irq(unsigned int irq, void *dev_id)</span><br><span class="line">1443	&#123;</span><br><span class="line">1444		struct irq_desc *desc = irq_to_desc(irq);</span><br><span class="line">1445		struct irqaction *action;</span><br><span class="line">1446		const char *devname;</span><br><span class="line">1447</span><br><span class="line">1448		<span class="keyword">if</span> (!desc || WARN_ON(irq_settings_is_per_cpu_devid(desc)))</span><br><span class="line">1449			<span class="built_in">return</span> NULL;</span><br><span class="line">1450</span><br><span class="line">1451	<span class="comment">#ifdef CONFIG_SMP</span></span><br><span class="line">1452		<span class="keyword">if</span> (WARN_ON(desc-&gt;affinity_notify))</span><br><span class="line">1453			desc-&gt;affinity_notify = NULL;</span><br><span class="line">1454	<span class="comment">#endif</span></span><br><span class="line">1455</span><br><span class="line">1456		action = __free_irq(irq, dev_id);</span><br><span class="line">1457		devname = action-&gt;name;</span><br><span class="line"></span><br><span class="line">crash&gt; struct irqaction</span><br><span class="line">struct irqaction &#123;</span><br><span class="line">    irq_handler_t handler;</span><br><span class="line">    void *dev_id;</span><br><span class="line">    void *percpu_dev_id;</span><br><span class="line">    struct irqaction *next;</span><br><span class="line">    irq_handler_t thread_fn;</span><br><span class="line">    struct task_struct *thread;</span><br><span class="line">    unsigned int irq;</span><br><span class="line">    unsigned int flags;</span><br><span class="line">    unsigned long thread_flags;</span><br><span class="line">    unsigned long thread_mask;</span><br><span class="line">    const char *name;</span><br><span class="line">    struct proc_dir_entry *<span class="built_in">dir</span>;</span><br><span class="line">&#125;</span><br><span class="line">SIZE: 128</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> test.bt</span><br><span class="line"><span class="comment">#!/usr/bin/bpftrace</span></span><br><span class="line"><span class="comment">#include &lt;linux/interrupt.h&gt;</span></span><br><span class="line">kretprobe:free_irq &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pid: %d , cmd: %s, returned: %d\n&quot;</span>,pid, <span class="built_in">comm</span>, retval);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kretprobe:__free_irq &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pid: %d , cmd: %s, returned: %s\n&quot;</span>,pid, <span class="built_in">comm</span>, str(((struct irqaction *)retval)-&gt;name) );</span><br><span class="line">&#125;</span><br><span class="line">#show the device name</span><br><span class="line"></span><br><span class="line">$ ./test.bt</span><br><span class="line">Attaching <span class="number">2</span> probes...</span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">0</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511010040</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">1</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511009752</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">2</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511009464</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">3</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511009176</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">4</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511008888</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">5</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511008600</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">6</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511008312</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: enp129s0f1-fp-<span class="number">7</span></span><br><span class="line">pid: <span class="number">117014</span> , cmd: ifconfig, returned: -<span class="number">1511008024</span></span><br><span class="line">## show the info when I restart network ,Got it</span><br><span class="line"></span><br><span class="line">## up failed</span><br><span class="line">$ systemctl restart network</span><br><span class="line">Job for network.service failed because the control process exited with error code. See &quot;systemctl status network.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line"></span><br><span class="line">## try to up the device</span><br><span class="line">$ ifconfig enp129s0f1 up</span><br><span class="line">SIOCSIFFLAGS: Device or resource busy</span><br><span class="line"></span><br><span class="line">$ ls -<span class="number">1</span>  /sys/class/net/</span><br><span class="line">bond0</span><br><span class="line">bonding_masters</span><br><span class="line">enp129s0f0</span><br><span class="line">enp129s0f1</span><br><span class="line">enp35s0f3u1u6</span><br><span class="line">ens9f0</span><br><span class="line">ens9f1</span><br><span class="line">lo</span><br></pre></td></tr></table></figure>

<h3 id="stap"><a href="#stap" class="headerlink" title="stap"></a>stap</h3><p><a target="_blank" rel="noopener" href="https://alexandrnikitin.github.io/blog/transparent-hugepages-measuring-the-performance-impact/">Function latency</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env stap</span><br><span class="line">global start, intervals</span><br><span class="line"></span><br><span class="line">probe $<span class="number">1</span> &#123; start[tid()] = gettimeofday_us() &#125;</span><br><span class="line">probe $<span class="number">1.</span><span class="keyword">return</span></span><br><span class="line">&#123;</span><br><span class="line">  t = gettimeofday_us()</span><br><span class="line">  <span class="type">old_t</span> = start[tid()]</span><br><span class="line">  <span class="keyword">if</span> (<span class="type">old_t</span>) intervals &lt;&lt;&lt; t - <span class="type">old_t</span></span><br><span class="line">  delete start[tid()]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">probe timer.ms($<span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (@count(intervals) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%-25s:\n min:%dus avg:%dus max:%dus count:%d \n&quot;</span>, tz_ctime(gettimeofday_s()),</span><br><span class="line">             @min(intervals), @avg(intervals), @max(intervals), @count(intervals))</span><br><span class="line">        print(@hist_log(intervals));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">./func_time_stats.stp <span class="string">&#x27;kernel.function(&quot;__alloc_pages_slowpath&quot;)&#x27;</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">Thu Aug <span class="number">17</span> <span class="number">09</span>:<span class="number">37</span>:<span class="number">19</span> <span class="number">2017</span> CEST:</span><br><span class="line"> min:<span class="number">0u</span>s avg:<span class="number">1u</span>s max:<span class="number">23u</span>s count:<span class="number">1538</span></span><br><span class="line">value |-------------------------------------------------- count</span><br><span class="line">    <span class="number">0</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  <span class="number">549</span></span><br><span class="line">    <span class="number">1</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  <span class="number">541</span></span><br><span class="line">    <span class="number">2</span> |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 <span class="number">377</span></span><br><span class="line">    <span class="number">4</span> |@@@@                                                <span class="number">54</span></span><br><span class="line">    <span class="number">8</span> |@                                                   <span class="number">12</span></span><br><span class="line">   <span class="number">16</span> |                                                     <span class="number">5</span></span><br><span class="line">   <span class="number">32</span> |                                                     <span class="number">0</span></span><br><span class="line">   <span class="number">64</span> |                                                     <span class="number">0</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ ./func_time_stats.stp <span class="string">&#x27;kernel.function(&quot;khugepaged_scan_mm_slot&quot;)&#x27;</span> <span class="number">60000</span> -o khugepaged_scan_mm_slot.<span class="built_in">log</span></span><br><span class="line">$ ./func_time_stats.stp <span class="string">&#x27;kernel.function(&quot;__alloc_pages_slowpath&quot;)&#x27;</span> <span class="number">60000</span> -o alloc_pages_slowpath.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/baotiao/baotiao.github.com/blob/6448a8ba675cbb6ea9ec002c4d8792a2b50226d5/_posts/2017-06-14-systemtap-tips-and-example.md">stap show all local parameters could be print</a>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ stap -ve <span class="string">&#x27;probe begin &#123; log(&quot;hello world&quot;) exit() &#125;&#x27;</span></span><br><span class="line">$ stap -ve <span class="string">&#x27;probe begin &#123; printf(&quot;hello world\n&quot;); exit() &#125;&#x27;</span></span><br><span class="line">$ stap -ve <span class="string">&#x27;probe nd_syscall.read &#123; printf(&quot;hello world\n&quot;); exit() &#125;&#x27;</span></span><br><span class="line">$ stap -vL <span class="string">&#x27;process(&quot;./h264ref&quot;).function(&quot;*&quot;)&#x27;</span></span><br><span class="line">$ stap -v -e <span class="string">&#x27;probe vfs.read &#123;printf(“read performed\n”); exit()&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#show kernel module functions</span></span><br><span class="line">$ stap -l <span class="string">&#x27;module(&quot;scsi_mod&quot;).function(&quot;*&quot;)&#x27;</span></span><br><span class="line"></span><br><span class="line">$ stap -L <span class="string">&#x27;kernel.statement(&quot;si_mem_available@mm/page_alloc.c:*&quot;)&#x27;</span></span><br><span class="line">kernel.statement(<span class="string">&quot;si_mem_available@mm/page_alloc.c:3795&quot;</span>) $pages:<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>[]</span><br><span class="line">kernel.statement(<span class="string">&quot;si_mem_available@mm/page_alloc.c:3798&quot;</span>) $wmark_low:<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span> $pages:<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>[] $zone:<span class="class"><span class="keyword">struct</span> <span class="title">zone</span>*</span></span><br><span class="line"><span class="class"><span class="title">kernel</span>.<span class="title">statement</span>(&quot;<span class="title">si_mem_available</span>@<span class="title">mm</span>/<span class="title">page_alloc</span>.<span class="title">c</span>:</span><span class="number">3803</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3804</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3806</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3807</span><span class="string">&quot;) $wmark_low:long unsigned int $pages:long unsigned int[] $zone:struct zone*</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3813</span><span class="string">&quot;) $available:long int $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3820</span><span class="string">&quot;) $pages:long unsigned int[] $zone:struct zone*</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3821</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3822</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3828</span><span class="string">&quot;) $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3829</span><span class="string">&quot;) $_min2:long unsigned int $pagecache:long unsigned int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string">kernel.statement(&quot;</span>si_mem_available@mm/page_alloc.c:<span class="number">3834</span><span class="string">&quot;) $available:long int $pages:long unsigned int[]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stap -L &#x27;process(&quot;</span>/usr/bin/bash<span class="string">&quot;).function(&quot;</span>skip_single_quoted<span class="string">&quot;)&#x27;</span></span><br><span class="line"><span class="string">process(&quot;</span>/usr/bin/bash<span class="string">&quot;).function(&quot;</span>skip_single_quoted@/usr/src/debug/bash<span class="number">-4.2</span>/subst.c:<span class="number">1022</span><span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> blkdev_issue_zeroout(sb-&gt;s_bdev,</span><br><span class="line">                                    block &lt;&lt; (sb-&gt;s_blocksize_bits - <span class="number">9</span>),</span><br><span class="line">                                    nr_blocks &lt;&lt; (sb-&gt;s_blocksize_bits - <span class="number">9</span>),</span><br><span class="line">                                    gfp_mask);</span><br><span class="line">#!/usr/bin/env stap</span><br><span class="line">probe kernel.function(<span class="string">&quot;blkdev_issue_zeroout&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;name : %s, pid : %d, start sector : %d, sector number : %d.\n&quot;</span>, execname(), pid(), $sector, $nr_sects)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="stap-inject-the-block-level-latency"><a href="#stap-inject-the-block-level-latency" class="headerlink" title="stap inject the block level latency"></a><a target="_blank" rel="noopener" href="http://bean-li.github.io/SystemTap-Inject-Latency/">stap inject the block level latency</a></h5><p><a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/examples/io/iostat-scsi.stp">https://sourceware.org/systemtap/examples/io/iostat-scsi.stp</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> inject_ka.stp</span><br><span class="line">global cnt = 0 ;</span><br><span class="line">probe module(<span class="string">&quot;sd_mod&quot;</span>).<span class="keyword">function</span>(<span class="string">&quot;sd_init_command&quot;</span>) !,</span><br><span class="line">      kernel.function(<span class="string">&quot;sd_init_command&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    device = kernel_string(@choose_defined(<span class="variable">$cmd</span>, <span class="variable">$SCpnt</span>)-&gt;request-&gt;rq_disk-&gt;disk_name)</span><br><span class="line">    <span class="keyword">if</span>(device == @1)</span><br><span class="line">    &#123;</span><br><span class="line">        mdelay(<span class="variable">$2</span>);</span><br><span class="line">        <span class="keyword">if</span>(cnt % 100 == 0)</span><br><span class="line">        &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">&quot;%s inject delay %4d times %7d\n&quot;</span>, device,<span class="variable">$2</span>, cnt)</span><br><span class="line">        &#125;</span><br><span class="line">        cnt++ ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#printf(&quot;device %s sd_init_command\n&quot;, device);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">probe begin&#123;</span><br><span class="line">  println(<span class="string">&quot;inject_scsi_delay module begin&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ stap -p4 -DMAXSKIPPED=99999999 -m ik -g inject_ka.stp sdb 10</span><br><span class="line">$ staprun ik.ko</span><br></pre></td></tr></table></figure>


  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#repo"><span class="toc-number">1.</span> <span class="toc-text">repo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#env"><span class="toc-number">2.</span> <span class="toc-text">env</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list-event"><span class="toc-number">3.</span> <span class="toc-text">list_event</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#example"><span class="toc-number">4.</span> <span class="toc-text">example</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-nested"><span class="toc-number">4.1.</span> <span class="toc-text">struct nested</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-file-name"><span class="toc-number">4.2.</span> <span class="toc-text">Show file name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show-the-path"><span class="toc-number">4.3.</span> <span class="toc-text">show the path</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-I-O"><span class="toc-number">4.4.</span> <span class="toc-text">trace I&#x2F;O </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-user-space-application"><span class="toc-number">4.5.</span> <span class="toc-text">trace user space application</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#userspace-example"><span class="toc-number">4.5.1.</span> <span class="toc-text">userspace example</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tracepoint"><span class="toc-number">5.</span> <span class="toc-text">Tracepoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Tracepoint-example"><span class="toc-number">5.1.</span> <span class="toc-text">Tracepoint example</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#example2"><span class="toc-number">5.1.1.</span> <span class="toc-text">example2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kprobe"><span class="toc-number">6.</span> <span class="toc-text">kprobe</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#test-the-kprobe-sample-codes"><span class="toc-number">6.1.</span> <span class="toc-text">test the kprobe sample codes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inject-function"><span class="toc-number">6.2.</span> <span class="toc-text">inject function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#debug-example"><span class="toc-number">6.3.</span> <span class="toc-text">debug example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stap"><span class="toc-number">7.</span> <span class="toc-text">stap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#stap-inject-the-block-level-latency"><span class="toc-number">7.0.1.</span> <span class="toc-text">stap inject the block level latency</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/07/24/bpftrace/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/07/24/bpftrace/&text=bpftrace"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/07/24/bpftrace/&is_video=false&description=bpftrace"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=bpftrace&body=Check out this article: http://example.com/2020/07/24/bpftrace/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/07/24/bpftrace/&title=bpftrace"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/07/24/bpftrace/&name=bpftrace&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/07/24/bpftrace/&t=bpftrace"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

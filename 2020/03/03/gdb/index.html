<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="mem map12$ pmap -x $pid$ pmap -XX $pid  sysctl.conf12345678kptr_restrictThis toggle indicates whether restrictions are placed on exposing kernel addresses via &#x2F;proc and other interfacesa为 0 时, 未作任何处理,">
<meta property="og:type" content="article">
<meta property="og:title" content="GDB tips">
<meta property="og:url" content="http://example.com/2020/03/03/gdb/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="mem map12$ pmap -x $pid$ pmap -XX $pid  sysctl.conf12345678kptr_restrictThis toggle indicates whether restrictions are placed on exposing kernel addresses via &#x2F;proc and other interfacesa为 0 时, 未作任何处理,">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-03-03T14:17:33.000Z">
<meta property="article:modified_time" content="2023-05-04T03:46:37.864Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="trace">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>GDB tips</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2020/03/24/c/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2020/03/03/crash/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/03/03/gdb/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/03/03/gdb/&text=GDB tips"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/03/03/gdb/&is_video=false&description=GDB tips"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=GDB tips&body=Check out this article: http://example.com/2020/03/03/gdb/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/03/03/gdb/&name=GDB tips&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/03/03/gdb/&t=GDB tips"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#mem-map"><span class="toc-number">1.</span> <span class="toc-text">mem map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sysctl-conf"><span class="toc-number">2.</span> <span class="toc-text">sysctl.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trigger-the-core"><span class="toc-number">3.</span> <span class="toc-text">trigger the core</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#debuginfo"><span class="toc-number">3.0.1.</span> <span class="toc-text">debuginfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-disassem-format"><span class="toc-number">4.</span> <span class="toc-text">set disassem format</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example1"><span class="toc-number">4.1.</span> <span class="toc-text">example1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Core-pattern-setting"><span class="toc-number">4.2.</span> <span class="toc-text">Core pattern setting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples"><span class="toc-number">5.</span> <span class="toc-text">Examples</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-the-function-parameters"><span class="toc-number">5.1.</span> <span class="toc-text">trace the function parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#segment-fault"><span class="toc-number">5.2.</span> <span class="toc-text">segment fault</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Got-the-issue-line-by-gdb"><span class="toc-number">5.3.</span> <span class="toc-text">Got the issue line by gdb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example1-1"><span class="toc-number">5.4.</span> <span class="toc-text">example1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#print-argv"><span class="toc-number">5.5.</span> <span class="toc-text">print argv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#threads"><span class="toc-number">5.6.</span> <span class="toc-text">threads</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#or"><span class="toc-number"></span> <span class="toc-text">or</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example3"><span class="toc-number">0.1.</span> <span class="toc-text">example3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example4"><span class="toc-number">0.2.</span> <span class="toc-text">example4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example5-gcc-parameters-and-show-macro"><span class="toc-number">0.3.</span> <span class="toc-text">example5 gcc parameters and show macro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example6"><span class="toc-number">0.4.</span> <span class="toc-text">example6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example7-gen-the-debuginfo"><span class="toc-number">0.5.</span> <span class="toc-text">example7 gen the debuginfo</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#build-linux-kernel-module-with-debuginfo"><span class="toc-number">0.5.1.</span> <span class="toc-text">build linux kernel module with debuginfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable-ptrace-permissions"><span class="toc-number">1.</span> <span class="toc-text">Enable ptrace permissions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Core-signal"><span class="toc-number">2.</span> <span class="toc-text">Core signal</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-SIGSEGV"><span class="toc-number">2.1.</span> <span class="toc-text">Test SIGSEGV</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb-cmd"><span class="toc-number">3.</span> <span class="toc-text">gdb cmd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kprobe-example"><span class="toc-number">4.</span> <span class="toc-text">kprobe example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-stack"><span class="toc-number">5.</span> <span class="toc-text">test stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Block-Started-Symbol"><span class="toc-number">6.</span> <span class="toc-text">Block Started Symbol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-more-space-on-the-stack-frame-is-reserved-than-is-needed-in-x86"><span class="toc-number">7.</span> <span class="toc-text">Why more space on the stack frame is reserved than is needed in x86</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        GDB tips
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-03-03T14:17:33.000Z" itemprop="datePublished">2020-03-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Debug/">Debug</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/debug/" rel="tag">debug</a>, <a class="tag-link-link" href="/tags/trace/" rel="tag">trace</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="mem-map"><a href="#mem-map" class="headerlink" title="mem map"></a>mem map</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pmap -x <span class="variable">$pid</span></span><br><span class="line">$ pmap -XX <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>

<h3 id="sysctl-conf"><a href="#sysctl-conf" class="headerlink" title="sysctl.conf"></a>sysctl.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kptr_restrict</span><br><span class="line">This toggle indicates whether restrictions are placed on exposing kernel addresses via /proc and other interfacesa</span><br><span class="line">为 0 时, 未作任何处理, 直接输出, 这样对所有用户都没有限制.</span><br><span class="line">为 1 时, 中断上下文则不允许输出, 否则则校验了用户的权限.</span><br><span class="line">为 2 时, 将指针直接置 NULL, 这样所有用户都只能看到全 0.</span><br><span class="line"></span><br><span class="line">限制 %p 的输出, 不再输出实际的地址, 而是输出一个散列化的地址.</span><br><span class="line">想要在 crash 等流程输出实际地址时, 则使用 %px 输出内核符号的实际地址.</span><br></pre></td></tr></table></figure>

<h3 id="trigger-the-core"><a href="#trigger-the-core" class="headerlink" title="trigger the core"></a>trigger the core</h3><ul>
<li>-g produces debugging information in theOS native format</li>
<li>-ggdb produces debugging information specifically intennded for gdb</li>
<li>-ggdb3 produces extra debugging information, for example: including macro definitions</li>
<li>wall means enable warnning</li>
<li>-O0  turn off all optimization</li>
<li>-O1 ,-O2, -O3  optimization</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set source dir</span></span><br><span class="line">(gdb) directory /opt/src</span><br><span class="line"></span><br><span class="line">$ ./configure CFLAGS=<span class="string">&quot;-Wall -O2 -ggdb3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate the core</span></span><br><span class="line"><span class="comment">#usage:  gcore [-a] [-o filename] pid</span></span><br><span class="line">$ gcore -o /tmp/core -p <span class="variable">$pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#kernel</span></span><br><span class="line">$ <span class="built_in">echo</span> c &gt; /proc/sysrq-trigger</span><br><span class="line"></span><br><span class="line">$ sudo apt install ubuntu-dbgsym-keyring</span><br><span class="line">$ yum install xxxx-debuginfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line">$ gdb ./a.out ./bubble_sort_core</span><br><span class="line">[New LWP 20410]</span><br><span class="line">Core was generated by `./a.out<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Program terminated with signal SIGABRT, Aborted.</span></span><br><span class="line"><span class="string">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51</span></span><br><span class="line"><span class="string">51      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># attach the process</span></span><br><span class="line"><span class="string">$ gdb attach $PID</span></span><br><span class="line"><span class="string">or</span></span><br><span class="line"><span class="string">$ gdb ./the_programA_binray $pid_of_the_programA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) set logging file the_log_filename</span></span><br><span class="line"><span class="string">(gdb) set logging on/off</span></span><br><span class="line"><span class="string">(gdb) set env PATH=/tmp/bin</span></span><br><span class="line"><span class="string">(gdb) set listsize 25</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># set print variable length</span></span><br><span class="line"><span class="string">(gdb) set print elements 250</span></span><br><span class="line"><span class="string">(gdb) set print elements 0 #no limit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#This is useful in cases where you may be interested in inspecting the machine instructions of a function which has no symbolic info and do not want GDB to automatically skip over this function.</span></span><br><span class="line"><span class="string">(gdb) set step-mode on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## set debug directory</span></span><br><span class="line"><span class="string">(gdb) set debug-file-directory &lt;directory&gt;</span></span><br><span class="line"><span class="string">(gdb) show debug-file-directory</span></span><br><span class="line"><span class="string">(gdb) set debug-file-directory /usr/lib/debug</span></span><br><span class="line"><span class="string">add-symbol-file filename address</span></span><br><span class="line"><span class="string">add-symbol-file filename address [ -readnow ] [ -mapped ]</span></span><br><span class="line"><span class="string">add-symbol-file filename -ssection address ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## command line mode</span></span><br><span class="line"><span class="string">$ gdb -q --batch -ex=&quot;disas /m ll_statahead_thread&quot; /lib/modules/3.10.0-1127.el7.x86_64/extra/lustre-client/fs/lustre.ko</span></span><br></pre></td></tr></table></figure>

<h5 id="debuginfo"><a href="#debuginfo" class="headerlink" title="debuginfo"></a>debuginfo</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">gcc -g -o main main.c</span><br><span class="line">gcc -ggdb3 -o main main.c</span><br><span class="line"></span><br><span class="line"><span class="comment">#Generate the debuginfo</span></span><br><span class="line">$ objcopy --only-keep-debug main main.debug</span><br><span class="line">or</span><br><span class="line">$ <span class="built_in">cp</span> main main.debug</span><br><span class="line">$ strip --only-keep-debug main.debug</span><br><span class="line"></span><br><span class="line"><span class="comment">#Get the debuginfo</span></span><br><span class="line">objcopy --strip-debug main</span><br><span class="line">or</span><br><span class="line">strip --strip-debug --strip-unneeded main</span><br><span class="line"></span><br><span class="line"><span class="comment">#Add debuglink</span></span><br><span class="line">objcopy --add-gnu-debuglink main.debug main</span><br><span class="line">gdb main</span><br><span class="line"></span><br><span class="line"><span class="comment">#import debug file and bin file</span></span><br><span class="line">gdb -s main.debug -e main</span><br><span class="line"></span><br><span class="line">(gdb) exec-file main</span><br><span class="line">(gdb) symbol-file main.debug</span><br><span class="line">(gdb) <span class="built_in">help</span> exec-file</span><br><span class="line">(gdb) <span class="built_in">help</span> symbol-file</span><br><span class="line"></span><br><span class="line"><span class="comment">#debuginfo</span></span><br><span class="line">https://developers.redhat.com/blog/2019/10/14/introducing-debuginfod-the-elfutils-debuginfo-server<span class="comment">#how_do_i_use_debuginfod_</span></span><br><span class="line">$ yum copr <span class="built_in">enable</span> fche/elfutils</span><br><span class="line">$ yum -y install elfutils-debuginfod</span><br><span class="line"></span><br><span class="line">$ eu-readelf -n foo | grep Build.ID</span><br><span class="line">$ debuginfod -vv -R /var/tmp/rpmbuild -F /usr/lib/debug</span><br><span class="line">$ <span class="built_in">export</span> DEBUGINFOD_URLS=<span class="string">&quot;http://buildhost:8002/&quot;</span></span><br><span class="line">$ debuginfod-find <span class="built_in">source</span> BUILD-ID /path/to/foo.c</span><br><span class="line"></span><br><span class="line"><span class="comment">#test demo</span></span><br><span class="line">$ gcc -ggdb utmp.c -o utmp</span><br><span class="line">$ readelf -n utmp |grep Build</span><br><span class="line">    Build ID: 77e4050eb5a81022b97d2dc24e1094bbb94aa9f0</span><br><span class="line">$ objcopy --only-keep-debug utmp utmp.debug</span><br><span class="line">$ objcopy --strip-debug utmp</span><br><span class="line">$ sudo <span class="built_in">mv</span> utmp.debug /usr/lib/debug/.build-id/77/e4050eb5a81022b97d2dc24e1094bbb94aa9f0.debug</span><br><span class="line">$</span><br><span class="line">$ gdb ./utmp</span><br><span class="line">......</span><br><span class="line">Reading symbols from ./utmp...</span><br><span class="line">Reading symbols from /usr/lib/debug/.build-id/77/e4050eb5a81022b97d2dc24e1094bbb94aa9f0.debug...</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">$ sudo <span class="built_in">rm</span> -f /usr/lib/debug/.build-id/77/e4050eb5a81022b97d2dc24e1094bbb94aa9f0.debug</span><br><span class="line">$ gdb ./utmp</span><br><span class="line">......</span><br><span class="line">Reading symbols from ./utmp...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./utmp)</span><br><span class="line"></span><br><span class="line"><span class="comment">#custom path</span></span><br><span class="line">$ gdb utmp -s ~/utmp.debug</span><br><span class="line"></span><br><span class="line">$ gdb</span><br><span class="line">(gdb) file utmp</span><br><span class="line">(gdb) symbol ~/utmp.debug</span><br></pre></td></tr></table></figure>

<h3 id="set-disassem-format"><a href="#set-disassem-format" class="headerlink" title="set disassem format"></a>set disassem format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> disassembly-flavor att</span><br><span class="line"><span class="built_in">set</span> disassembly-flavor intel</span><br><span class="line">show disassembly-flavor</span><br><span class="line"></span><br><span class="line">|------------------|  &lt;------ high address         may be is the %rsp</span><br><span class="line">|                  |  &lt;------ previous frame</span><br><span class="line">|------------------|</span><br><span class="line">|    ......        |</span><br><span class="line">|   <span class="built_in">local</span> var1     |</span><br><span class="line">|   argument 1     |</span><br><span class="line">|   argument 2     |  &lt;------ <span class="built_in">caller</span></span><br><span class="line">|next instruction  |</span><br><span class="line">|   rbp(<span class="built_in">caller</span>)    |</span><br><span class="line">|------------------|</span><br><span class="line">| <span class="built_in">local</span> var1       |  &lt;------ callee</span><br><span class="line">|------------------|</span><br><span class="line">|    ......        |</span><br><span class="line">|------------------|  &lt;------ low addr (top stack)  may be is the %rbp</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/1/stack</span><br><span class="line">[&lt;ffffffffbc49c28e&gt;] ep_poll+0x23e/0x360 &lt;---------------low addr ( top stack )</span><br><span class="line">[&lt;ffffffffbc49d76d&gt;] SyS_epoll_wait+0xed/0x120</span><br><span class="line">[&lt;ffffffffbc992ed2&gt;] system_call_fastpath+0x25/0x2a</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff  &lt;---------------high addr</span><br><span class="line"></span><br><span class="line">The latest stack is top stack , it <span class="string">&#x27;s come from high addr to low addr</span></span><br><span class="line"><span class="string">$ cat test.c</span></span><br><span class="line"><span class="string">int square(int num) &#123;</span></span><br><span class="line"><span class="string">    return num * num;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">int main() &#123;</span></span><br><span class="line"><span class="string">    int i = 4;</span></span><br><span class="line"><span class="string">    int j = square(i);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ gcc -g -o test test.c</span></span><br><span class="line"><span class="string">(gdb) disas square</span></span><br><span class="line"><span class="string">Dump of assembler code for function square:</span></span><br><span class="line"><span class="string">   0x0000000000001125 &lt;+0&gt;:     push   %rbp   入栈当前rbp (main)</span></span><br><span class="line"><span class="string">   0x0000000000001126 &lt;+1&gt;:     mov    %rsp,%rbp 设置新的rbp为当前rsp, 应该扩展栈都省略了</span></span><br><span class="line"><span class="string">   0x0000000000001129 &lt;+4&gt;:     mov    %edi,-0x4(%rbp)  读取edi第一个参数值</span></span><br><span class="line"><span class="string">   0x000000000000112c &lt;+7&gt;:     mov    -0x4(%rbp),%eax</span></span><br><span class="line"><span class="string">   0x000000000000112f &lt;+10&gt;:    imul   %eax,%eax</span></span><br><span class="line"><span class="string">   0x0000000000001132 &lt;+13&gt;:    pop    %rbp</span></span><br><span class="line"><span class="string">   0x0000000000001133 &lt;+14&gt;:    ret</span></span><br><span class="line"><span class="string">End of assembler dump.</span></span><br><span class="line"><span class="string">(gdb) disas main</span></span><br><span class="line"><span class="string">Dump of assembler code for function main:</span></span><br><span class="line"><span class="string">   0x0000000000001134 &lt;+0&gt;:     push   %rbp</span></span><br><span class="line"><span class="string">   0x0000000000001135 &lt;+1&gt;:     mov    %rsp,%rbp 栈顶指针值设置到rbp（基指针地址)</span></span><br><span class="line"><span class="string">   0x0000000000001138 &lt;+4&gt;:     sub    $0x10,%rsp</span></span><br><span class="line"><span class="string">   0x000000000000113c &lt;+8&gt;:     movl   $0x4,-0x4(%rbp)  4先存到栈上</span></span><br><span class="line"><span class="string">   0x0000000000001143 &lt;+15&gt;:    mov    -0x4(%rbp),%eax  然后存在eax里面</span></span><br><span class="line"><span class="string">   0x0000000000001146 &lt;+18&gt;:    mov    %eax,%edi        存到edi里面，函数第一个参数</span></span><br><span class="line"><span class="string">   0x0000000000001148 &lt;+20&gt;:    call   0x1125 &lt;square&gt;</span></span><br><span class="line"><span class="string">   0x000000000000114d &lt;+25&gt;:    mov    %eax,-0x8(%rbp)</span></span><br><span class="line"><span class="string">   0x0000000000001150 &lt;+28&gt;:    mov    $0x0,%eax</span></span><br><span class="line"><span class="string">   0x0000000000001155 &lt;+33&gt;:    leave</span></span><br><span class="line"><span class="string">   0x0000000000001156 &lt;+34&gt;:    ret</span></span><br><span class="line"><span class="string">End of assembler dump.</span></span><br></pre></td></tr></table></figure>

<h4 id="example1"><a href="#example1" class="headerlink" title="example1"></a><a target="_blank" rel="noopener" href="http://linux.laoqinren.net/posts/x86-64-stack-layout-and-call-conventions/">example1</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br></pre></td><td class="code"><pre><span class="line">x86 high addr to low addr</span><br><span class="line">the stack top = the lowest addr</span><br><span class="line">rsp/esp(Extended Stack Pointer) point the stack top</span><br><span class="line"></span><br><span class="line">x86架构保留了一个特殊的寄存器——ESP (Extended Stack Pointer)，来指向栈的顶部。</span><br><span class="line"></span><br><span class="line">我们使用push指令将新数据放入栈中，push所做的首先递减ESP（ESP-4），然后将其操作数放到ESP指向的位置</span><br><span class="line">esp save the stack top addr is the 0x9080ABCC, the value(0x9080ABCC) write to exa</span><br><span class="line">push eax = <span class="string">&quot;sub esp 4&quot;</span> + <span class="string">&quot;mov [esp], exa&quot;</span></span><br><span class="line">  ESP(ESP-4) = sub esp 4</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;printf &quot;%x\n&quot;, 0x9080ABCC-0x4&#125;&#x27;</span></span><br><span class="line">9080abc8</span><br><span class="line"></span><br><span class="line">假设exa保存的值为0xDEADBEEF，那么push后</span><br><span class="line">值0xDEADBEEF 将被写入 eax。注意，0xDEADBEEF 也保留在地址0x9080ABC8，因为我们还没有覆盖它</span><br><span class="line">pop eax = <span class="string">&quot;mov eax, [esp]&quot;</span> + <span class="string">&quot;add esp + 4&quot;</span></span><br><span class="line">  ESP(ESP+4) = add esp + 4</span><br><span class="line"></span><br><span class="line">x86_64通用寄存器</span><br><span class="line">x86 有8个通用的寄存器 (eax, ebx, ecx, edx, ebp, esp, esi, edi).x86_64对他们进行扩展，变成了64位 (前缀由e变成了r) ，并且增加了另外8个寄存器 (r8, r9, r10, r11, r12, r13, r14, r15).</span><br><span class="line"></span><br><span class="line">x86_64函数调用传递参数使用的寄存器</span><br><span class="line">x86_64了提高性能速度，将前6个参数通过寄存器传递，其顺序为rdi、rsi、rdx、rcx、r8、r9，第7个及以后的参数通过栈进行传递。</span><br><span class="line">rbp寄存器，是ebp寄存器64位扩展。意思是扩展栈指针寄存器，存储栈中最高位数据的内存地址</span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line">long utilfunc(long a, long b, long c)</span><br><span class="line">&#123;</span><br><span class="line">	long xx = a + 2;</span><br><span class="line">	long yy = b + 3;</span><br><span class="line">	long zz = c + 4;</span><br><span class="line">	long <span class="built_in">sum</span> = xx + yy + zz;</span><br><span class="line">	<span class="built_in">return</span> xx * yy * zz + <span class="built_in">sum</span>;</span><br><span class="line">&#125;</span><br><span class="line">long myfunc(long a, long b, long c, long d,</span><br><span class="line">            long e, long f, long g, long h)</span><br><span class="line">&#123;</span><br><span class="line">	long xx = a * b * c * d * e * f * g * h;</span><br><span class="line">	long yy = a + b + c + d + e + f + g + h;</span><br><span class="line">	long zz = utilfunc(xx, yy, xx % yy);</span><br><span class="line">	<span class="built_in">return</span> zz + 20;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">	myfunc(1,2,3,4,5,6,7,8);</span><br><span class="line">	<span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gdb ./test</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /tmp/test...done.</span><br><span class="line">(gdb) l</span><br><span class="line">12	long myfunc(long a, long b, long c, long d,</span><br><span class="line">13	            long e, long f, long g, long h)</span><br><span class="line">14	&#123;</span><br><span class="line">15	        long xx = a * b * c * d * e * f * g * h;</span><br><span class="line">16	        long yy = a + b + c + d + e + f + g + h;</span><br><span class="line">17	        long zz = utilfunc(xx, yy, xx % yy);</span><br><span class="line">18	        <span class="built_in">return</span> zz + 20;</span><br><span class="line">19	&#125;</span><br><span class="line">20	int main(int argc, char **argv) &#123;</span><br><span class="line">21	        myfunc(1,2,3,4,5,6,7,8);</span><br><span class="line">(gdb) b 21</span><br><span class="line">Breakpoint 1 at 0x40060f: file test.c, line 21.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /tmp/./test </span><br><span class="line"></span><br><span class="line">Breakpoint 1, main (argc=1, argv=0x7fffffffe298) at test.c:21</span><br><span class="line">21	        myfunc(1,2,3,4,5,6,7,8);</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-307.el7.1.x86_64</span><br><span class="line">(gdb) s</span><br><span class="line">myfunc (a=1, b=2, c=3, d=4, e=5, f=6, g=7, h=8) at test.c:15</span><br><span class="line">15	        long xx = a * b * c * d * e * f * g * h;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  myfunc (a=1, b=2, c=3, d=4, e=5, f=6, g=7, h=8) at test.c:15</span></span><br><span class="line"><span class="comment">#1  0x0000000000400645 in main (argc=1, argv=0x7fffffffe298) at test.c:21</span></span><br><span class="line">(gdb) info reg</span><br><span class="line">rax            0x400600	4195840</span><br><span class="line">rbx            0x0	0</span><br><span class="line">rcx            0x4	4</span><br><span class="line">rdx            0x3	3</span><br><span class="line">rsi            0x2	2</span><br><span class="line">rdi            0x1	1</span><br><span class="line">rbp            0x7fffffffe180	0x7fffffffe180</span><br><span class="line">rsp            0x7fffffffe130	0x7fffffffe130</span><br><span class="line">r8             0x5	5</span><br><span class="line">r9             0x6	6</span><br><span class="line">r10            0x7fffffffdce0	140737488346336</span><br><span class="line">r11            0x7fffdfa31460	140736945394784</span><br><span class="line">r12            0x400400	4195328</span><br><span class="line">r13            0x7fffffffe290	140737488347792</span><br><span class="line">r14            0x0	0</span><br><span class="line">r15            0x0	0</span><br><span class="line">rip            0x400571	0x400571 &lt;myfunc+32&gt;</span><br><span class="line">eflags         0x206	[ PF IF ]</span><br><span class="line">cs             0x33	51</span><br><span class="line">ss             0x2b	43</span><br><span class="line">ds             0x0	0</span><br><span class="line">es             0x0	0</span><br><span class="line">fs             0x0	0</span><br><span class="line">gs             0x0	0</span><br><span class="line">(gdb) x/40g <span class="variable">$rbp</span></span><br><span class="line">0x7fffffffe180:	140737488347568	4195909</span><br><span class="line">0x7fffffffe190:	7	8</span><br><span class="line">0x7fffffffe1a0:	140737488347800	4294967296</span><br><span class="line">0x7fffffffe1b0:	0	140736945395029</span><br><span class="line">0x7fffffffe1c0:	0	140737488347800</span><br><span class="line">0x7fffffffe1d0:	4294967296	4195840</span><br><span class="line">0x7fffffffe1e0:	0	2611839461369938578</span><br><span class="line">0x7fffffffe1f0:	4195328	140737488347792</span><br><span class="line">0x7fffffffe200:	0	0</span><br><span class="line">0x7fffffffe210:	-2611839461032623470	-2611910346908663150</span><br><span class="line">0x7fffffffe220:	0	0</span><br><span class="line">0x7fffffffe230:	0	0</span><br><span class="line">0x7fffffffe240:	140736951484752	3</span><br><span class="line">0x7fffffffe250:	0	0</span><br><span class="line">0x7fffffffe260:	4195328	140737488347792</span><br><span class="line">0x7fffffffe270:	0	4195369</span><br><span class="line">0x7fffffffe280:	140737488347784	28</span><br><span class="line">0x7fffffffe290:	1	140737488348463</span><br><span class="line">0x7fffffffe2a0:	0	140737488348475</span><br><span class="line">0x7fffffffe2b0:	140737488348497	140737488348522</span><br><span class="line">(gdb) x/40g <span class="variable">$rsp</span></span><br><span class="line">0x7fffffffe130:	6	5</span><br><span class="line">0x7fffffffe140:	4	3</span><br><span class="line">0x7fffffffe150:	2	1</span><br><span class="line">0x7fffffffe160:	0	0</span><br><span class="line">0x7fffffffe170:	1	4195997</span><br><span class="line">0x7fffffffe180:	140737488347568	4195909</span><br><span class="line">0x7fffffffe190:	7	8</span><br><span class="line">0x7fffffffe1a0:	140737488347800	4294967296</span><br><span class="line">0x7fffffffe1b0:	0	140736945395029</span><br><span class="line">0x7fffffffe1c0:	0	140737488347800</span><br><span class="line">0x7fffffffe1d0:	4294967296	4195840</span><br><span class="line">0x7fffffffe1e0:	0	2611839461369938578</span><br><span class="line">0x7fffffffe1f0:	4195328	140737488347792</span><br><span class="line">0x7fffffffe200:	0	0</span><br><span class="line">0x7fffffffe210:	-2611839461032623470	-2611910346908663150</span><br><span class="line">0x7fffffffe220:	0	0</span><br><span class="line">0x7fffffffe230:	0	0</span><br><span class="line">0x7fffffffe240:	140736951484752	3</span><br><span class="line">0x7fffffffe250:	0	0</span><br><span class="line">0x7fffffffe260:	4195328	140737488347792</span><br><span class="line">(gdb) disas myfunc</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> myfunc:</span><br><span class="line">   0x0000000000400551 &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x0000000000400552 &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x0000000000400555 &lt;+4&gt;:	sub    <span class="variable">$0x50</span>,%rsp</span><br><span class="line">   0x0000000000400559 &lt;+8&gt;:	mov    %rdi,-0x28(%rbp)</span><br><span class="line">   0x000000000040055d &lt;+12&gt;:	mov    %rsi,-0x30(%rbp)</span><br><span class="line">   0x0000000000400561 &lt;+16&gt;:	mov    %rdx,-0x38(%rbp)</span><br><span class="line">   0x0000000000400565 &lt;+20&gt;:	mov    %rcx,-0x40(%rbp)</span><br><span class="line">   0x0000000000400569 &lt;+24&gt;:	mov    %r8,-0x48(%rbp)</span><br><span class="line">   0x000000000040056d &lt;+28&gt;:	mov    %r9,-0x50(%rbp)</span><br><span class="line">=&gt; 0x0000000000400571 &lt;+32&gt;:	mov    -0x28(%rbp),%rax</span><br><span class="line">   0x0000000000400575 &lt;+36&gt;:	imul   -0x30(%rbp),%rax</span><br><span class="line">   0x000000000040057a &lt;+41&gt;:	imul   -0x38(%rbp),%rax</span><br><span class="line">   0x000000000040057f &lt;+46&gt;:	imul   -0x40(%rbp),%rax</span><br><span class="line">   0x0000000000400584 &lt;+51&gt;:	imul   -0x48(%rbp),%rax</span><br><span class="line">   0x0000000000400589 &lt;+56&gt;:	imul   -0x50(%rbp),%rax</span><br><span class="line">   0x000000000040058e &lt;+61&gt;:	imul   0x10(%rbp),%rax</span><br><span class="line">   0x0000000000400593 &lt;+66&gt;:	imul   0x18(%rbp),%rax</span><br><span class="line">   0x0000000000400598 &lt;+71&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x000000000040059c &lt;+75&gt;:	mov    -0x30(%rbp),%rax</span><br><span class="line">   0x00000000004005a0 &lt;+79&gt;:	mov    -0x28(%rbp),%rdx</span><br><span class="line">   0x00000000004005a4 &lt;+83&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005a7 &lt;+86&gt;:	mov    -0x38(%rbp),%rax</span><br><span class="line">   0x00000000004005ab &lt;+90&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005ae &lt;+93&gt;:	mov    -0x40(%rbp),%rax</span><br><span class="line">   0x00000000004005b2 &lt;+97&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005b5 &lt;+100&gt;:	mov    -0x48(%rbp),%rax</span><br><span class="line">   0x00000000004005b9 &lt;+104&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005bc &lt;+107&gt;:	mov    -0x50(%rbp),%rax</span><br><span class="line">   0x00000000004005c0 &lt;+111&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005c3 &lt;+114&gt;:	mov    0x10(%rbp),%rax</span><br><span class="line">   0x00000000004005c7 &lt;+118&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005ca &lt;+121&gt;:	mov    0x18(%rbp),%rax</span><br><span class="line">   0x00000000004005ce &lt;+125&gt;:	add    %rdx,%rax</span><br><span class="line">   0x00000000004005d1 &lt;+128&gt;:	mov    %rax,-0x10(%rbp)</span><br><span class="line">   0x00000000004005d5 &lt;+132&gt;:	mov    -0x8(%rbp),%rax</span><br><span class="line">   0x00000000004005d9 &lt;+136&gt;:	cqto   </span><br><span class="line">   0x00000000004005db &lt;+138&gt;:	idivq  -0x10(%rbp)</span><br><span class="line">   0x00000000004005df &lt;+142&gt;:	mov    -0x10(%rbp),%rcx</span><br><span class="line">   0x00000000004005e3 &lt;+146&gt;:	mov    -0x8(%rbp),%rax</span><br><span class="line">---Type &lt;<span class="built_in">return</span>&gt; to <span class="built_in">continue</span>, or q &lt;<span class="built_in">return</span>&gt; to quit--- </span><br><span class="line">   0x00000000004005e7 &lt;+150&gt;:	mov    %rcx,%rsi</span><br><span class="line">   0x00000000004005ea &lt;+153&gt;:	mov    %rax,%rdi</span><br><span class="line">   0x00000000004005ed &lt;+156&gt;:	callq  0x4004ed &lt;utilfunc&gt;</span><br><span class="line">   0x00000000004005f2 &lt;+161&gt;:	mov    %rax,-0x18(%rbp)</span><br><span class="line">   0x00000000004005f6 &lt;+165&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x00000000004005fa &lt;+169&gt;:	add    <span class="variable">$0x14</span>,%rax</span><br><span class="line">   0x00000000004005fe &lt;+173&gt;:	leaveq </span><br><span class="line">   0x00000000004005ff &lt;+174&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">The 128-byte area beyond the location pointed to by %rsp is considered</span><br><span class="line">to be reserved and shall not be modified by signal or interrupt handlers.</span><br><span class="line">Therefore, <span class="built_in">functions</span> may use this area <span class="keyword">for</span> temporary data that is not</span><br><span class="line">needed across <span class="keyword">function</span> calls. In particular, leaf <span class="built_in">functions</span> may use this</span><br><span class="line">area <span class="keyword">for</span> their entire stack frame, rather than adjusting the stack pointer</span><br><span class="line"><span class="keyword">in</span> the prologue and epilogue. This area is known as the red zone.</span><br><span class="line"></span><br><span class="line">leaf <span class="keyword">function</span>就是不会再调用其它函数的函数，上面的例子中，utilfunc就是一个leaf <span class="keyword">function</span>。对于leaf <span class="keyword">function</span>函数，由于它不会在调用其他函数，所以就不需要更改其rsp寄存器，免得函数返回时还要恢复rsp寄存器。</span><br><span class="line"></span><br><span class="line">rbp 栈基地址寄存器，保存当前帧的栈底地址。 rsp 栈指针寄存器，保存当前栈顶。  </span><br><span class="line"></span><br><span class="line">$ gdb ./test</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /tmp/test...done.</span><br><span class="line">(gdb) l1</span><br><span class="line">Undefined <span class="built_in">command</span>: <span class="string">&quot;l1&quot;</span>.  Try <span class="string">&quot;help&quot;</span>.</span><br><span class="line">(gdb) l 1</span><br><span class="line">1	<span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line">2	<span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line">3	</span><br><span class="line">4	long utilfunc(long a, long b, long c)</span><br><span class="line">5	&#123;</span><br><span class="line">6	        long xx = a + 2;</span><br><span class="line">7	        long yy = b + 3;</span><br><span class="line">8	        long zz = c + 4;</span><br><span class="line">9	        long <span class="built_in">sum</span> = xx + yy + zz;</span><br><span class="line">10	        <span class="built_in">return</span> xx * yy * zz + <span class="built_in">sum</span>;</span><br><span class="line">(gdb) b 4</span><br><span class="line">Breakpoint 1 at 0x4004fd: file test.c, line 4.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /tmp/./test </span><br><span class="line"></span><br><span class="line">Breakpoint 1, utilfunc (a=40320, b=36, c=0) at test.c:6</span><br><span class="line">6	        long xx = a + 2;</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-307.el7.1.x86_64</span><br><span class="line">(gdb) info reg</span><br><span class="line">rax            0x9d80	40320</span><br><span class="line">rbx            0x0	0</span><br><span class="line">rcx            0x24	36</span><br><span class="line">rdx            0x0	0</span><br><span class="line">rsi            0x24	36</span><br><span class="line">rdi            0x9d80	40320</span><br><span class="line">rbp            0x7fffffffe120	0x7fffffffe120</span><br><span class="line">rsp            0x7fffffffe120	0x7fffffffe120</span><br><span class="line">r8             0x5	5</span><br><span class="line">r9             0x6	6</span><br><span class="line">r10            0x7fffffffdce0	140737488346336</span><br><span class="line">r11            0x7fffdfa31460	140736945394784</span><br><span class="line">r12            0x400400	4195328</span><br><span class="line">r13            0x7fffffffe290	140737488347792</span><br><span class="line">r14            0x0	0</span><br><span class="line">r15            0x0	0</span><br><span class="line">rip            0x4004fd	0x4004fd &lt;utilfunc+16&gt;</span><br><span class="line">eflags         0x216	[ PF AF IF ]</span><br><span class="line">cs             0x33	51</span><br><span class="line">ss             0x2b	43</span><br><span class="line">ds             0x0	0</span><br><span class="line">es             0x0	0</span><br><span class="line">fs             0x0	0</span><br><span class="line">gs             0x0	0</span><br><span class="line">(gdb) disas utilfunc</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> utilfunc:</span><br><span class="line">   0x00000000004004ed &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00000000004004ee &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00000000004004f1 &lt;+4&gt;:	mov    %rdi,-0x28(%rbp)</span><br><span class="line">   0x00000000004004f5 &lt;+8&gt;:	mov    %rsi,-0x30(%rbp)</span><br><span class="line">   0x00000000004004f9 &lt;+12&gt;:	mov    %rdx,-0x38(%rbp)</span><br><span class="line">=&gt; 0x00000000004004fd &lt;+16&gt;:	mov    -0x28(%rbp),%rax</span><br><span class="line">   0x0000000000400501 &lt;+20&gt;:	add    <span class="variable">$0x2</span>,%rax</span><br><span class="line">   0x0000000000400505 &lt;+24&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x0000000000400509 &lt;+28&gt;:	mov    -0x30(%rbp),%rax</span><br><span class="line">   0x000000000040050d &lt;+32&gt;:	add    <span class="variable">$0x3</span>,%rax</span><br><span class="line">   0x0000000000400511 &lt;+36&gt;:	mov    %rax,-0x10(%rbp)</span><br><span class="line">   0x0000000000400515 &lt;+40&gt;:	mov    -0x38(%rbp),%rax</span><br><span class="line">   0x0000000000400519 &lt;+44&gt;:	add    <span class="variable">$0x4</span>,%rax</span><br><span class="line">   0x000000000040051d &lt;+48&gt;:	mov    %rax,-0x18(%rbp)</span><br><span class="line">   0x0000000000400521 &lt;+52&gt;:	mov    -0x10(%rbp),%rax</span><br><span class="line">   0x0000000000400525 &lt;+56&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x0000000000400529 &lt;+60&gt;:	add    %rax,%rdx</span><br><span class="line">   0x000000000040052c &lt;+63&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x0000000000400530 &lt;+67&gt;:	add    %rdx,%rax</span><br><span class="line">   0x0000000000400533 &lt;+70&gt;:	mov    %rax,-0x20(%rbp)</span><br><span class="line">   0x0000000000400537 &lt;+74&gt;:	mov    -0x8(%rbp),%rax</span><br><span class="line">   0x000000000040053b &lt;+78&gt;:	imul   -0x10(%rbp),%rax</span><br><span class="line">   0x0000000000400540 &lt;+83&gt;:	imul   -0x18(%rbp),%rax</span><br><span class="line">   0x0000000000400545 &lt;+88&gt;:	mov    %rax,%rdx</span><br><span class="line">   0x0000000000400548 &lt;+91&gt;:	mov    -0x20(%rbp),%rax</span><br><span class="line">   0x000000000040054c &lt;+95&gt;:	add    %rdx,%rax</span><br><span class="line">   0x000000000040054f &lt;+98&gt;:	pop    %rbp</span><br><span class="line">   0x0000000000400550 &lt;+99&gt;:	retq  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ gcc -g -fomit-frame-pointer test.c  -o <span class="built_in">test</span></span><br><span class="line">$ gdb ./test</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /tmp/test...done.</span><br><span class="line">(gdb) l</span><br><span class="line">11	&#125;</span><br><span class="line">12	long myfunc(long a, long b, long c, long d,</span><br><span class="line">13	            long e, long f, long g, long h)</span><br><span class="line">14	&#123;</span><br><span class="line">15	        long xx = a * b * c * d * e * f * g * h;</span><br><span class="line">16	        long yy = a + b + c + d + e + f + g + h;</span><br><span class="line">17	        long zz = utilfunc(xx, yy, xx % yy);</span><br><span class="line">18	        <span class="built_in">return</span> zz + 20;</span><br><span class="line">19	&#125;</span><br><span class="line">20	int main(int argc, char **argv) &#123;</span><br><span class="line">(gdb) disas myfunc</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> myfunc:</span><br><span class="line">   0x000000000040055d &lt;+0&gt;:	sub    <span class="variable">$0x50</span>,%rsp</span><br><span class="line">   0x0000000000400561 &lt;+4&gt;:	mov    %rdi,0x28(%rsp)</span><br><span class="line">   0x0000000000400566 &lt;+9&gt;:	mov    %rsi,0x20(%rsp)</span><br><span class="line">   0x000000000040056b &lt;+14&gt;:	mov    %rdx,0x18(%rsp)</span><br><span class="line">   0x0000000000400570 &lt;+19&gt;:	mov    %rcx,0x10(%rsp)</span><br><span class="line">   0x0000000000400575 &lt;+24&gt;:	mov    %r8,0x8(%rsp)</span><br><span class="line">   0x000000000040057a &lt;+29&gt;:	mov    %r9,(%rsp)</span><br><span class="line">   0x000000000040057e &lt;+33&gt;:	mov    0x28(%rsp),%rax</span><br><span class="line">   0x0000000000400583 &lt;+38&gt;:	imul   0x20(%rsp),%rax</span><br><span class="line">   0x0000000000400589 &lt;+44&gt;:	imul   0x18(%rsp),%rax</span><br><span class="line">   0x000000000040058f &lt;+50&gt;:	imul   0x10(%rsp),%rax</span><br><span class="line">   0x0000000000400595 &lt;+56&gt;:	imul   0x8(%rsp),%rax</span><br><span class="line">   0x000000000040059b &lt;+62&gt;:	imul   (%rsp),%rax</span><br><span class="line">   0x00000000004005a0 &lt;+67&gt;:	imul   0x58(%rsp),%rax</span><br><span class="line">   0x00000000004005a6 &lt;+73&gt;:	imul   0x60(%rsp),%rax</span><br><span class="line">   0x00000000004005ac &lt;+79&gt;:	mov    %rax,0x48(%rsp)</span><br><span class="line">   0x00000000004005b1 &lt;+84&gt;:	mov    0x20(%rsp),%rax</span><br><span class="line">   0x00000000004005b6 &lt;+89&gt;:	mov    0x28(%rsp),%rdx</span><br><span class="line">   0x00000000004005bb &lt;+94&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005be &lt;+97&gt;:	mov    0x18(%rsp),%rax</span><br><span class="line">   0x00000000004005c3 &lt;+102&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005c6 &lt;+105&gt;:	mov    0x10(%rsp),%rax</span><br><span class="line">   0x00000000004005cb &lt;+110&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005ce &lt;+113&gt;:	mov    0x8(%rsp),%rax</span><br><span class="line">   0x00000000004005d3 &lt;+118&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005d6 &lt;+121&gt;:	mov    (%rsp),%rax</span><br><span class="line">   0x00000000004005da &lt;+125&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005dd &lt;+128&gt;:	mov    0x58(%rsp),%rax</span><br><span class="line">   0x00000000004005e2 &lt;+133&gt;:	add    %rax,%rdx</span><br><span class="line">   0x00000000004005e5 &lt;+136&gt;:	mov    0x60(%rsp),%rax</span><br><span class="line">   0x00000000004005ea &lt;+141&gt;:	add    %rdx,%rax</span><br><span class="line">   0x00000000004005ed &lt;+144&gt;:	mov    %rax,0x40(%rsp)</span><br><span class="line">   0x00000000004005f2 &lt;+149&gt;:	mov    0x48(%rsp),%rax</span><br><span class="line">   0x00000000004005f7 &lt;+154&gt;:	cqto   </span><br><span class="line">   0x00000000004005f9 &lt;+156&gt;:	idivq  0x40(%rsp)</span><br><span class="line">   0x00000000004005fe &lt;+161&gt;:	mov    0x40(%rsp),%rcx</span><br><span class="line">   0x0000000000400603 &lt;+166&gt;:	mov    0x48(%rsp),%rax</span><br><span class="line">   0x0000000000400608 &lt;+171&gt;:	mov    %rcx,%rsi</span><br><span class="line">   0x000000000040060b &lt;+174&gt;:	mov    %rax,%rdi</span><br><span class="line">---Type &lt;<span class="built_in">return</span>&gt; to <span class="built_in">continue</span>, or q &lt;<span class="built_in">return</span>&gt; to quit---</span><br><span class="line">   0x000000000040060e &lt;+177&gt;:	callq  0x4004ed &lt;utilfunc&gt;</span><br><span class="line">   0x0000000000400613 &lt;+182&gt;:	mov    %rax,0x38(%rsp)</span><br><span class="line">   0x0000000000400618 &lt;+187&gt;:	mov    0x38(%rsp),%rax</span><br><span class="line">   0x000000000040061d &lt;+192&gt;:	add    <span class="variable">$0x14</span>,%rax</span><br><span class="line">   0x0000000000400621 &lt;+196&gt;:	add    <span class="variable">$0x50</span>,%rsp</span><br><span class="line">   0x0000000000400625 &lt;+200&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb ./test</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /tmp/test...done.</span><br><span class="line">(gdb) l</span><br><span class="line">5		long xx = a + 2 + e;</span><br><span class="line">6		long yy = b + 3 + f;</span><br><span class="line">7		long zz = c + 4 + h;</span><br><span class="line">8		long ww = i + j;</span><br><span class="line">9		double vv = d + g;</span><br><span class="line">10		long <span class="built_in">sum</span> = xx + yy + zz + ww + vv;</span><br><span class="line">11		<span class="built_in">return</span> xx * yy * zz + <span class="built_in">sum</span>;</span><br><span class="line">12	&#125;</span><br><span class="line">13	int main(int argc, char **argv) &#123;</span><br><span class="line">14		myfunc(1,2,3,4.0,5,6,7.0,8, 9, 10);</span><br><span class="line">(gdb) l</span><br><span class="line">15		<span class="built_in">return</span> 0;</span><br><span class="line">16	&#125;</span><br><span class="line">(gdb)  b myfunc</span><br><span class="line">Breakpoint 1 at 0x400513: file test.c, line 5.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /tmp/./test </span><br><span class="line"></span><br><span class="line">Breakpoint 1, myfunc (a=1, b=2, c=3, d=4, e=5, f=6, g=7, h=8, i=9, j=10) at test.c:5</span><br><span class="line">5		long xx = a + 2 + e;</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-307.el7.1.x86_64</span><br><span class="line">(gdb) info reg</span><br><span class="line">rax            0x4010000000000000	4616189618054758400</span><br><span class="line">rbx            0x0	0</span><br><span class="line">rcx            0x5	5</span><br><span class="line">rdx            0x3	3</span><br><span class="line">rsi            0x2	2</span><br><span class="line">rdi            0x1	1</span><br><span class="line">rbp            0x7fffffffe178	0x7fffffffe178</span><br><span class="line">rsp            0x7fffffffe178	0x7fffffffe178</span><br><span class="line">r8             0x6	6</span><br><span class="line">r9             0x8	8</span><br><span class="line">r10            0x7fffffffdce0	140737488346336</span><br><span class="line">r11            0x7fffdfa31460	140736945394784</span><br><span class="line">r12            0x400400	4195328</span><br><span class="line">r13            0x7fffffffe290	140737488347792</span><br><span class="line">r14            0x0	0</span><br><span class="line">r15            0x0	0</span><br><span class="line">rip            0x400513	0x400513 &lt;myfunc+38&gt;</span><br><span class="line">eflags         0x216	[ PF AF IF ]</span><br><span class="line">cs             0x33	51</span><br><span class="line">ss             0x2b	43</span><br><span class="line">ds             0x0	0</span><br><span class="line">es             0x0	0</span><br><span class="line">fs             0x0	0</span><br><span class="line">gs             0x0	0</span><br><span class="line"></span><br><span class="line">//而第四个参数和第七个参数为浮点数类型，他们分别通过寄存器xmm0和xmm1来传递</span><br><span class="line"></span><br><span class="line">(gdb) p /x <span class="variable">$xmm0</span></span><br><span class="line"><span class="variable">$1</span> = &#123;v4_float = &#123;0x0, 0x2, 0x0, 0x0&#125;, v2_double = &#123;0x4, 0x0&#125;, v16_int8 = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x10, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, v8_int16 = &#123;0x0, 0x0, 0x0, </span><br><span class="line">    0x4010, 0x0, 0x0, 0x0, 0x0&#125;, v4_int32 = &#123;0x0, 0x40100000, 0x0, 0x0&#125;, v2_int64 = &#123;0x4010000000000000, 0x0&#125;, uint128 = 0x00000000000000004010000000000000&#125;</span><br><span class="line">(gdb) p /x <span class="variable">$xmm1</span></span><br><span class="line"><span class="variable">$2</span> = &#123;v4_float = &#123;0x0, 0x2, 0x0, 0x0&#125;, v2_double = &#123;0x7, 0x0&#125;, v16_int8 = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1c, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, v8_int16 = &#123;0x0, 0x0, 0x0, </span><br><span class="line">    0x401c, 0x0, 0x0, 0x0, 0x0&#125;, v4_int32 = &#123;0x0, 0x401c0000, 0x0, 0x0&#125;, v2_int64 = &#123;0x401c000000000000, 0x0&#125;, uint128 = 0x0000000000000000401c000000000000&#125;</span><br><span class="line">(gdb) p /x <span class="variable">$xmm2</span></span><br><span class="line"><span class="variable">$3</span> = &#123;v4_float = &#123;0x0, 0x0, 0x0, 0x0&#125;, v2_double = &#123;0x0, 0x0&#125;, v16_int8 = &#123;0x0 &lt;repeats 16 <span class="built_in">times</span>&gt;&#125;, v8_int16 = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, v4_int32 = &#123;0x0, 0x0, 0x0, 0x0&#125;, </span><br><span class="line">  v2_int64 = &#123;0x0, 0x0&#125;, uint128 = 0x00000000000000000000000000000000&#125;</span><br><span class="line">(gdb) p /x <span class="variable">$xmm3</span></span><br><span class="line"><span class="variable">$4</span> = &#123;v4_float = &#123;0x0, 0x0, 0x0, 0x0&#125;, v2_double = &#123;0x0, 0x0&#125;, v16_int8 = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, v8_int16 = &#123;0x0, 0x0, 0x0, 0x0, </span><br><span class="line">    0x0, 0xff, 0x0, 0x0&#125;, v4_int32 = &#123;0x0, 0x0, 0xff0000, 0x0&#125;, v2_int64 = &#123;0x0, 0xff0000&#125;, uint128 = 0x0000000000ff00000000000000000000&#125;</span><br><span class="line">(gdb) disas myfunc</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> myfunc:</span><br><span class="line">   0x00000000004004ed &lt;+0&gt;:	push   %rbp</span><br><span class="line">   0x00000000004004ee &lt;+1&gt;:	mov    %rsp,%rbp</span><br><span class="line">   0x00000000004004f1 &lt;+4&gt;:	mov    %rdi,-0x38(%rbp)</span><br><span class="line">   0x00000000004004f5 &lt;+8&gt;:	mov    %rsi,-0x40(%rbp)</span><br><span class="line">   0x00000000004004f9 &lt;+12&gt;:	mov    %rdx,-0x48(%rbp)</span><br><span class="line">   0x00000000004004fd &lt;+16&gt;:	movsd  %xmm0,-0x50(%rbp)</span><br><span class="line">   0x0000000000400502 &lt;+21&gt;:	mov    %rcx,-0x58(%rbp)</span><br><span class="line">   0x0000000000400506 &lt;+25&gt;:	mov    %r8,-0x60(%rbp)</span><br><span class="line">   0x000000000040050a &lt;+29&gt;:	movsd  %xmm1,-0x68(%rbp)</span><br><span class="line">   0x000000000040050f &lt;+34&gt;:	mov    %r9,-0x70(%rbp)</span><br><span class="line">=&gt; 0x0000000000400513 &lt;+38&gt;:	mov    -0x38(%rbp),%rax</span><br><span class="line">   0x0000000000400517 &lt;+42&gt;:	lea    0x2(%rax),%rdx</span><br><span class="line">   0x000000000040051b &lt;+46&gt;:	mov    -0x58(%rbp),%rax</span><br><span class="line">   0x000000000040051f &lt;+50&gt;:	add    %rdx,%rax</span><br><span class="line">   0x0000000000400522 &lt;+53&gt;:	mov    %rax,-0x8(%rbp)</span><br><span class="line">   0x0000000000400526 &lt;+57&gt;:	mov    -0x40(%rbp),%rax</span><br><span class="line">   0x000000000040052a &lt;+61&gt;:	lea    0x3(%rax),%rdx</span><br><span class="line">   0x000000000040052e &lt;+65&gt;:	mov    -0x60(%rbp),%rax</span><br><span class="line">   0x0000000000400532 &lt;+69&gt;:	add    %rdx,%rax</span><br><span class="line">   0x0000000000400535 &lt;+72&gt;:	mov    %rax,-0x10(%rbp)</span><br><span class="line">   0x0000000000400539 &lt;+76&gt;:	mov    -0x48(%rbp),%rax</span><br><span class="line">   0x000000000040053d &lt;+80&gt;:	lea    0x4(%rax),%rdx</span><br><span class="line">   0x0000000000400541 &lt;+84&gt;:	mov    -0x70(%rbp),%rax</span><br><span class="line">   0x0000000000400545 &lt;+88&gt;:	add    %rdx,%rax</span><br><span class="line">   0x0000000000400548 &lt;+91&gt;:	mov    %rax,-0x18(%rbp)</span><br><span class="line">   0x000000000040054c &lt;+95&gt;:	mov    0x18(%rbp),%rax</span><br><span class="line">   0x0000000000400550 &lt;+99&gt;:	mov    0x10(%rbp),%rdx</span><br><span class="line">   0x0000000000400554 &lt;+103&gt;:	add    %rdx,%rax</span><br><span class="line">   0x0000000000400557 &lt;+106&gt;:	mov    %rax,-0x20(%rbp)</span><br><span class="line">   0x000000000040055b &lt;+110&gt;:	movsd  -0x50(%rbp),%xmm0</span><br><span class="line">   0x0000000000400560 &lt;+115&gt;:	addsd  -0x68(%rbp),%xmm0</span><br><span class="line">   0x0000000000400565 &lt;+120&gt;:	movsd  %xmm0,-0x28(%rbp)</span><br><span class="line">   0x000000000040056a &lt;+125&gt;:	mov    -0x10(%rbp),%rax</span><br><span class="line">   0x000000000040056e &lt;+129&gt;:	mov    -0x8(%rbp),%rdx</span><br><span class="line">   0x0000000000400572 &lt;+133&gt;:	add    %rax,%rdx</span><br><span class="line">   0x0000000000400575 &lt;+136&gt;:	mov    -0x18(%rbp),%rax</span><br><span class="line">   0x0000000000400579 &lt;+140&gt;:	add    %rax,%rdx</span><br><span class="line">   0x000000000040057c &lt;+143&gt;:	mov    -0x20(%rbp),%rax</span><br><span class="line">   0x0000000000400580 &lt;+147&gt;:	add    %rdx,%rax</span><br><span class="line">---Type &lt;<span class="built_in">return</span>&gt; to <span class="built_in">continue</span>, or q &lt;<span class="built_in">return</span>&gt; to quit---</span><br><span class="line">   0x0000000000400583 &lt;+150&gt;:	cvtsi2sd %rax,%xmm0</span><br><span class="line">   0x0000000000400588 &lt;+155&gt;:	addsd  -0x28(%rbp),%xmm0</span><br><span class="line">   0x000000000040058d &lt;+160&gt;:	cvttsd2si %xmm0,%rax</span><br><span class="line">   0x0000000000400592 &lt;+165&gt;:	mov    %rax,-0x30(%rbp)</span><br><span class="line">   0x0000000000400596 &lt;+169&gt;:	mov    -0x8(%rbp),%rax</span><br><span class="line">   0x000000000040059a &lt;+173&gt;:	imul   -0x10(%rbp),%rax</span><br><span class="line">   0x000000000040059f &lt;+178&gt;:	imul   -0x18(%rbp),%rax</span><br><span class="line">   0x00000000004005a4 &lt;+183&gt;:	mov    %rax,%rdx</span><br><span class="line">   0x00000000004005a7 &lt;+186&gt;:	mov    -0x30(%rbp),%rax</span><br><span class="line">   0x00000000004005ab &lt;+190&gt;:	add    %rdx,%rax</span><br><span class="line">   0x00000000004005ae &lt;+193&gt;:	pop    %rbp</span><br><span class="line">   0x00000000004005af &lt;+194&gt;:	retq   </span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) x/40g <span class="variable">$rbp</span></span><br><span class="line">0x7fffffffe178:	0x00007fffffffe1b0	0x000000000040061b</span><br><span class="line">0x7fffffffe188:	0x0000000000000009	0x000000000000000a  &lt;--- 9 and 10 <span class="keyword">in</span> the stack</span><br><span class="line">0x7fffffffe198:	0x4010000000000000	0x00007fffffffe298</span><br><span class="line">0x7fffffffe1a8:	0x0000000100000000	0x0000000000000000</span><br><span class="line">0x7fffffffe1b8:	0x00007fffdfa31555	0x0000000000000000</span><br><span class="line">0x7fffffffe1c8:	0x00007fffffffe298	0x0000000100000000</span><br><span class="line">0x7fffffffe1d8:	0x00000000004005b0	0x0000000000000000</span><br><span class="line">0x7fffffffe1e8:	0x134aa776b7c5eb54	0x0000000000400400</span><br><span class="line">0x7fffffffe1f8:	0x00007fffffffe290	0x0000000000000000</span><br><span class="line">0x7fffffffe208:	0x0000000000000000	0xecb558897445eb54</span><br><span class="line">0x7fffffffe218:	0xecb518309ddfeb54	0x0000000000000000</span><br><span class="line">0x7fffffffe228:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffe238:	0x0000000000000000	0x00007fffe0000150</span><br><span class="line">0x7fffffffe248:	0x0000000000000003	0x0000000000000000</span><br><span class="line">0x7fffffffe258:	0x0000000000000000	0x0000000000400400</span><br><span class="line">0x7fffffffe268:	0x00007fffffffe290	0x0000000000000000</span><br><span class="line">0x7fffffffe278:	0x0000000000400429	0x00007fffffffe288</span><br><span class="line">0x7fffffffe288:	0x000000000000001c	0x0000000000000001</span><br><span class="line">0x7fffffffe298:	0x00007fffffffe52f	0x0000000000000000</span><br><span class="line">0x7fffffffe2a8:	0x00007fffffffe53b	0x00007fffffffe551</span><br><span class="line">(gdb) x/40g <span class="variable">$rsp</span></span><br><span class="line">0x7fffffffe178:	0x00007fffffffe1b0	0x000000000040061b  &lt;--- rbp and rsp <span class="keyword">in</span> the same location</span><br><span class="line">0x7fffffffe188:	0x0000000000000009	0x000000000000000a</span><br><span class="line">0x7fffffffe198:	0x4010000000000000	0x00007fffffffe298</span><br><span class="line">0x7fffffffe1a8:	0x0000000100000000	0x0000000000000000</span><br><span class="line">0x7fffffffe1b8:	0x00007fffdfa31555	0x0000000000000000</span><br><span class="line">0x7fffffffe1c8:	0x00007fffffffe298	0x0000000100000000</span><br><span class="line">0x7fffffffe1d8:	0x00000000004005b0	0x0000000000000000</span><br><span class="line">0x7fffffffe1e8:	0x134aa776b7c5eb54	0x0000000000400400</span><br><span class="line">0x7fffffffe1f8:	0x00007fffffffe290	0x0000000000000000</span><br><span class="line">0x7fffffffe208:	0x0000000000000000	0xecb558897445eb54</span><br><span class="line">0x7fffffffe218:	0xecb518309ddfeb54	0x0000000000000000</span><br><span class="line">0x7fffffffe228:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffe238:	0x0000000000000000	0x00007fffe0000150</span><br><span class="line">0x7fffffffe248:	0x0000000000000003	0x0000000000000000</span><br><span class="line">0x7fffffffe258:	0x0000000000000000	0x0000000000400400</span><br><span class="line">0x7fffffffe268:	0x00007fffffffe290	0x0000000000000000</span><br><span class="line">0x7fffffffe278:	0x0000000000400429	0x00007fffffffe288</span><br><span class="line">0x7fffffffe288:	0x000000000000001c	0x0000000000000001</span><br><span class="line">0x7fffffffe298:	0x00007fffffffe52f	0x0000000000000000</span><br><span class="line">0x7fffffffe2a8:	0x00007fffffffe53b	0x00007fffffffe551</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Core-pattern-setting"><a href="#Core-pattern-setting" class="headerlink" title="Core pattern setting"></a>Core pattern setting</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/sys/kernel/core_pattern</span><br><span class="line">/usr/share/apport/apport %p %s %c %d %P %E</span><br><span class="line"><span class="comment">## kernel variable</span></span><br><span class="line">kernel.core_pattern = |/usr/share/apport/apport %p %s %c %d %P %E</span><br><span class="line"><span class="comment">#If the first character of the pattern is a &#x27;|&#x27;, the kernel will treat the rest of the pattern as a command to run.  The core dump will be written to the standard input of that program instead of to a file.</span></span><br><span class="line"></span><br><span class="line">kernel.core_pipe_limit = 0</span><br><span class="line"><span class="comment"># This sysctl is only applicable when core_pattern is configured to pipe core files to a user space helper (when the first character of core_pattern is a &#x27;|&#x27;, see above).  When collecting cores via a pipe to an application, it is occasionally useful for the collecting application to gather data about the crashing process from its /proc/pid directory.  In order to do this safely, the kernel must wait for the collecting process to exit, so as not to remove the crashing processes proc files prematurely.  This in turn creates the possibility that a misbehaving userspace collecting process can block the reaping of a crashed process simply by never exiting.  This sysctl defends against that. It defines how many concurrent crashing processes may be piped to user space applications in parallel.  If this value is exceeded, then those crashing processes above that value are noted via the kernel log and their cores are skipped.  0 is a special value, indicating that unlimited processes may be captured in parallel, but that no waiting will take place (i.e. the collecting process is not guaranteed access to `/proc/&lt;crashing pid&gt;/`).</span></span><br><span class="line"></span><br><span class="line">kernel.core_uses_pid = 0</span><br><span class="line">kernel.core_patternfs.suid_dumpable = 2</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ulimit</span> -S -c unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable genarate the core file</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -c n</span><br></pre></td></tr></table></figure>
<p>userspace struct   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ dnf install dwarves</span><br><span class="line">$ pahole -V filemap.c</span><br><span class="line">struct fiemap &#123;</span><br><span class="line">        __u64                      fm_start;             /*     0     8 */</span><br><span class="line">        __u64                      fm_length;            /*     8     8 */</span><br><span class="line">        __u32                      fm_flags;             /*    16     4 */</span><br><span class="line">        __u32                      fm_mapped_extents;    /*    20     4 */</span><br><span class="line">        __u32                      fm_extent_count;      /*    24     4 */</span><br><span class="line">        __u32                      fm_reserved;          /*    28     4 */</span><br><span class="line">        struct fiemap_extent       fm_extents[];         /*    32     0 */</span><br><span class="line"></span><br><span class="line">        /* size: 32, cachelines: 1, members: 7 */</span><br><span class="line">        /* last cacheline: 32 bytes */</span><br><span class="line">&#125;;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><h4 id="trace-the-function-parameters"><a href="#trace-the-function-parameters" class="headerlink" title="trace the function parameters"></a>trace the function parameters</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//call_example.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123; <span class="keyword">return</span> a + b; &#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  add(<span class="number">333</span>, <span class="number">11</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">22</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ gcc call_example.c -o add -g</span><br><span class="line">$ gdb ./add</span><br><span class="line"></span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  main () at call_example.c:6</span></span><br><span class="line"></span><br><span class="line">(gdb) disassemble /mr</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> main:</span><br><span class="line">5       int main(void) &#123;</span><br><span class="line">   0x0000555555555139 &lt;+0&gt;:     55      push   %rbp</span><br><span class="line">   0x000055555555513a &lt;+1&gt;:     48 89 e5        mov    %rsp,%rbp</span><br><span class="line"></span><br><span class="line">6         add(333, 11);</span><br><span class="line">   0x000055555555513d &lt;+4&gt;:     be 0b 00 00 00  mov    <span class="variable">$0xb</span>,%esi</span><br><span class="line">   0x0000555555555142 &lt;+9&gt;:     bf 4d 01 00 00  mov    <span class="variable">$0x14d</span>,%edi</span><br><span class="line">   0x0000555555555147 &lt;+14&gt;:    e8 d9 ff ff ff  call   0x555555555125 &lt;add&gt;</span><br><span class="line"></span><br><span class="line">7         <span class="built_in">return</span> 22;</span><br><span class="line">   0x000055555555514c &lt;+19&gt;:    b8 16 00 00 00  mov    <span class="variable">$0x16</span>,%eax</span><br><span class="line"></span><br><span class="line">8       &#125;</span><br><span class="line">=&gt; 0x0000555555555151 &lt;+24&gt;:    5d      pop    %rbp</span><br><span class="line">   0x0000555555555152 &lt;+25&gt;:    c3      ret</span><br><span class="line"></span><br><span class="line">End of assembler dump.</span><br><span class="line"></span><br><span class="line">(gdb) i reg</span><br><span class="line">rax            0x16                22  &lt;-------- <span class="built_in">return</span> value</span><br><span class="line">rbx            0x0                 0</span><br><span class="line">rcx            0x7ffff7fa4718      140737353762584</span><br><span class="line">rdx            0x14d               333</span><br><span class="line">rsi            0xb                 11  &lt;-------- second argument</span><br><span class="line">rdi            0x14d               333 &lt;-------- first argument</span><br><span class="line">rbp            0x7fffffffdfa0      0x7fffffffdfa0</span><br><span class="line">rsp            0x7fffffffdfa0      0x7fffffffdfa0</span><br><span class="line">r8             0x0                 0</span><br><span class="line">r9             0x7ffff7fe21b0      140737354015152</span><br><span class="line">r10            0x7                 7</span><br><span class="line">r11            0x2                 2</span><br><span class="line">r12            0x555555555040      93824992235584</span><br><span class="line">r13            0x0                 0</span><br><span class="line">r14            0x0                 0</span><br><span class="line">r15            0x0                 0</span><br><span class="line">rip            0x555555555151      0x555555555151 &lt;main+24&gt;</span><br><span class="line">eflags         0x212               [ AF IF ]</span><br><span class="line">cs             0x33                51</span><br><span class="line">ss             0x2b                43</span><br><span class="line">ds             0x0                 0</span><br><span class="line">es             0x0                 0</span><br><span class="line">fs             0x0                 0</span><br><span class="line">gs             0x0                 0</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun1</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fun2</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fun3</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b,<span class="type">int</span> c)</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fun4</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b,<span class="type">int</span> c,<span class="type">int</span> d)</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fun5</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b,<span class="type">int</span> c,<span class="type">int</span> d,<span class="type">int</span> e)</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fun6</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b,<span class="type">int</span> c,<span class="type">int</span> d,<span class="type">int</span> e,<span class="type">int</span> f)</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> a,b,c,d,e,f;</span><br><span class="line">        a=b=c=d=e=f=<span class="number">2</span>;</span><br><span class="line">        fun1(a);</span><br><span class="line">        fun2(a,b);</span><br><span class="line">        fun3(a,b,c);</span><br><span class="line">        fun4(a,b,c,d);</span><br><span class="line">        fun5(a,b,c,d,e);</span><br><span class="line">        fun6(a,b,c,d,e,f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d <span class="built_in">test</span></span><br><span class="line">00000000004004ed &lt;fun1&gt;:</span><br><span class="line">  4004ed:       55                      push   %rbp</span><br><span class="line">  4004ee:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  4004f1:       89 7d <span class="built_in">fc</span>                mov    %edi,-0x4(%rbp)</span><br><span class="line">  4004f4:       5d                      pop    %rbp</span><br><span class="line">  4004f5:       c3                      retq</span><br><span class="line"></span><br><span class="line">00000000004004f6 &lt;fun2&gt;:</span><br><span class="line">  4004f6:       55                      push   %rbp</span><br><span class="line">  4004f7:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  4004fa:       89 7d <span class="built_in">fc</span>                mov    %edi,-0x4(%rbp)</span><br><span class="line">  4004fd:       89 75 f8                mov    %esi,-0x8(%rbp)</span><br><span class="line">  400500:       5d                      pop    %rbp</span><br><span class="line">  400501:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000400502 &lt;fun3&gt;:</span><br><span class="line">  400502:       55                      push   %rbp</span><br><span class="line">  400503:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  400506:       89 7d <span class="built_in">fc</span>                mov    %edi,-0x4(%rbp)</span><br><span class="line">  400509:       89 75 f8                mov    %esi,-0x8(%rbp)</span><br><span class="line">  40050c:       89 55 f4                mov    %edx,-0xc(%rbp)</span><br><span class="line">  40050f:       5d                      pop    %rbp</span><br><span class="line">  400510:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000400511 &lt;fun4&gt;:</span><br><span class="line">  400511:       55                      push   %rbp</span><br><span class="line">  400512:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  400515:       89 7d <span class="built_in">fc</span>                mov    %edi,-0x4(%rbp)</span><br><span class="line">  400518:       89 75 f8                mov    %esi,-0x8(%rbp)</span><br><span class="line">  40051b:       89 55 f4                mov    %edx,-0xc(%rbp)</span><br><span class="line">  40051e:       89 4d f0                mov    %ecx,-0x10(%rbp)</span><br><span class="line">  400521:       5d                      pop    %rbp</span><br><span class="line">  400522:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000400523 &lt;fun5&gt;:</span><br><span class="line">  400523:       55                      push   %rbp</span><br><span class="line">  400524:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  400527:       89 7d <span class="built_in">fc</span>                mov    %edi,-0x4(%rbp)</span><br><span class="line">  40052a:       89 75 f8                mov    %esi,-0x8(%rbp)</span><br><span class="line">  40052d:       89 55 f4                mov    %edx,-0xc(%rbp)</span><br><span class="line">  400530:       89 4d f0                mov    %ecx,-0x10(%rbp)</span><br><span class="line">  400533:       44 89 45 ec             mov    %r8d,-0x14(%rbp)</span><br><span class="line">  400537:       5d                      pop    %rbp</span><br><span class="line">  400538:       c3                      retq</span><br></pre></td></tr></table></figure>

<h4 id="segment-fault"><a href="#segment-fault" class="headerlink" title="segment fault"></a><a target="_blank" rel="noopener" href="https://wiki.debian.org/InterpretingKernelOutputAtProcessCrash">segment fault</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> * Page fault error code bits:</span><br><span class="line"> *</span><br><span class="line"> *   bit 0 ==    0: no page found       1: protection fault</span><br><span class="line"> *   bit 1 ==    0: <span class="built_in">read</span> access         1: write access</span><br><span class="line"> *   bit 2 ==    0: kernel-mode access  1: user-mode access</span><br><span class="line"> *   bit 3 ==                           1: use of reserved bit detected</span><br><span class="line"> *   bit 4 ==                           1: fault was an instruction fetch</span><br><span class="line"> *   bit 5 ==                           1: protection keys block access</span><br><span class="line"> */</span><br><span class="line">enum x86_pf_error_code &#123;</span><br><span class="line">        X86_PF_PROT     =               1 &lt;&lt; <span class="string">0,</span></span><br><span class="line"><span class="string">        X86_PF_WRITE    =               1 &lt;&lt; 1,</span></span><br><span class="line"><span class="string">        X86_PF_USER     =               1 &lt;&lt; 2,</span></span><br><span class="line"><span class="string">        X86_PF_RSVD     =               1 &lt;&lt; 3,</span></span><br><span class="line"><span class="string">        X86_PF_INSTR    =               1 &lt;&lt; 4,</span></span><br><span class="line"><span class="string">        X86_PF_PK       =               1 &lt;&lt; 5,</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">#endif /* _ASM_X86_TRAPS_H */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>bit2: 值为 1 时表示是用户态程序内存访问越界，值为 0 时表示是内核态程序内存访问越界</li>
<li>bit1: 值为 1 时表示是写操作导致内存访问越界，值为 0 时表示是读操作导致内存访问越界</li>
<li>bit0: 值为 1 表示没有足够的权限访问非法地址的内容， 值为 0 时表示访问的非法地址根本没有对应的页面，也就是无效地址</li>
</ul>
<p>err 4  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cat cpp_crash.cpp</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">myprint</span><span class="params">(<span class="type">int</span>* ptr)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line">    myprint(ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ulimit</span> -S -c unlimited</span><br><span class="line">$ g++ cpp_crash.cpp -o a.out -g -rdynamic -finstrument-functions</span><br><span class="line">$ ./a.out</span><br><span class="line">$ dmesg</span><br><span class="line">a.out[36921]: segfault at 0 ip 00005585d34141d1 sp 00007ffc0e9c19b0 error 4 <span class="keyword">in</span> a.out[5585d3414000+1000]</span><br><span class="line">Code: ff ff f3 0f 1e fa 55 48 89 e5 53 48 83 ec 18 48 89 7d e8 48 8b 45 08 48 89 c6 48 8d 3d e1 ff ff ff e8 c3 fe ff ff 48 8b 45 e8 &lt;8b&gt; 00 89 c6 48 8d 3d 28 0e 00 00 b8 00 00 00 00 e8 9a fe ff ff 48</span><br><span class="line"></span><br><span class="line">$ gdb ./a.out core</span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">...</span><br><span class="line">Program terminated with signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="comment">#0  0x00005585d34141d1 in myprint (ptr=0x0) at cpp_crash.cpp:5</span></span><br><span class="line">5           <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *ptr);</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">$ nm -gC a.out</span><br><span class="line">0000000000004018 B __bss_start</span><br><span class="line">                 w __cxa_finalize@@GLIBC_2.2.5</span><br><span class="line">                 U __cyg_profile_func_enter@@GLIBC_2.2.5</span><br><span class="line">                 U __cyg_profile_func_exit@@GLIBC_2.2.5</span><br><span class="line">0000000000004000 D __data_start</span><br><span class="line">0000000000004000 W data_start</span><br><span class="line">0000000000004018 D _edata</span><br><span class="line">0000000000004020 B _end</span><br><span class="line">                 w __gmon_start__</span><br><span class="line">                 U __gxx_personality_v0@@CXXABI_1.3</span><br><span class="line">0000000000002000 R _IO_stdin_used</span><br><span class="line">                 w _ITM_deregisterTMCloneTable</span><br><span class="line">                 w _ITM_registerTMCloneTable</span><br><span class="line">0000000000001320 T __libc_csu_fini</span><br><span class="line">00000000000012b0 T __libc_csu_init</span><br><span class="line">                 U __libc_start_main@@GLIBC_2.2.5</span><br><span class="line">0000000000001227 T main</span><br><span class="line">                 U <span class="built_in">printf</span>@@GLIBC_2.2.5</span><br><span class="line">00000000000010c0 T _start</span><br><span class="line">                 U _Unwind_Resume@@GCC_3.0</span><br><span class="line">00000000000011a9 T myprint(int*)</span><br></pre></td></tr></table></figure>

<h4 id="Got-the-issue-line-by-gdb"><a href="#Got-the-issue-line-by-gdb" class="headerlink" title="Got the issue line by gdb"></a>Got the issue line by gdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Mon May 10 10:57:22 2021] a.out[733]: segfault at 0 ip 000000000040092f sp 00007ffe8e80aa80 error 4 <span class="keyword">in</span> a.out[400000+1000]</span><br><span class="line"></span><br><span class="line"><span class="comment"># calculate the relative address</span></span><br><span class="line">$ gawk <span class="string">&#x27;BEGIN&#123; printf &quot;%x\n&quot;, strtonum(0x40092f-0x400000) &#125;&#x27;</span></span><br><span class="line">92f</span><br><span class="line">$ objdump -d a.out &gt; a.obj</span><br><span class="line"></span><br><span class="line"><span class="comment">## the myprint function</span></span><br><span class="line">$ grep -i 92f a.obj -A 5 -B 11</span><br><span class="line">000000000040090d &lt;_Z7myprintPi&gt;:</span><br><span class="line">  40090d:       55                      push   %rbp</span><br><span class="line">  40090e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  400911:       53                      push   %rbx</span><br><span class="line">  400912:       48 83 ec 18             sub    <span class="variable">$0x18</span>,%rsp</span><br><span class="line">  400916:       48 89 7d e8             mov    %rdi,-0x18(%rbp)</span><br><span class="line">  40091a:       48 8b 45 08             mov    0x8(%rbp),%rax</span><br><span class="line">  40091e:       48 89 c6                mov    %rax,%rsi</span><br><span class="line">  400921:       bf 0d 09 40 00          mov    <span class="variable">$0x40090d</span>,%edi</span><br><span class="line">  400926:       e8 b5 fe ff ff          callq  4007e0 &lt;__cyg_profile_func_enter@plt&gt;</span><br><span class="line">  40092b:       48 8b 45 e8             mov    -0x18(%rbp),%rax</span><br><span class="line">  40092f:       8b 00                   mov    (%rax),%eax</span><br><span class="line">  400931:       89 c6                   mov    %eax,%esi</span><br><span class="line">  400933:       bf 80 0a 40 00          mov    <span class="variable">$0x400a80</span>,%edi</span><br><span class="line">  400938:       b8 00 00 00 00          mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">  40093d:       e8 6e fe ff ff          callq  4007b0 &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">  400942:       48 8b 45 08             mov    0x8(%rbp),%rax</span><br></pre></td></tr></table></figure>

<p>err 6, not exist addr     </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line">        *ptr = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>err 6, system protect addr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> *ptr = (<span class="type">int</span> *)<span class="number">0</span>;</span><br><span class="line">        *ptr = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>err 7, write readonly addr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> *ptr = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">        <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;TEST&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>err 6, stack overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="example1-1"><a href="#example1-1" class="headerlink" title="example1"></a>example1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">(gdb) list</span><br><span class="line">1       <span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line">2       <span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line">3</span><br><span class="line">4       void printArray(int arr[], int n)</span><br><span class="line">5       &#123;</span><br><span class="line">6          <span class="keyword">for</span> (int i=0; i&lt;n; i++) &#123;</span><br><span class="line">7            arr[i]=arr[i]+i;</span><br><span class="line">8            <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line">9          &#125;</span><br><span class="line">10      &#125;</span><br><span class="line">11</span><br><span class="line">12      int main()</span><br><span class="line">13      &#123;</span><br><span class="line">14          int n = 10;</span><br><span class="line">15          int arr[n];</span><br><span class="line">16</span><br><span class="line">17          // Fill whole array with 100.</span><br><span class="line">18          memset(arr, 10, n*sizeof(arr[0]));</span><br><span class="line">19          <span class="built_in">printf</span>(<span class="string">&quot;Array after memset()\n&quot;</span>);</span><br><span class="line">20          printArray(arr, n);</span><br><span class="line">21</span><br><span class="line">22          <span class="built_in">return</span> 0;</span><br><span class="line">23      &#125;</span><br><span class="line"></span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x00000000004005d5 <span class="keyword">in</span> printArray at test2.c:7</span><br><span class="line">        breakpoint already hit 10 <span class="built_in">times</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span><br><span class="line">7            arr[i]=arr[i]+i;</span><br><span class="line">(gdb) <span class="built_in">print</span> arr</span><br><span class="line"><span class="variable">$13</span> = (int *) 0x7fffffffe0d0</span><br><span class="line">(gdb) <span class="built_in">print</span> *arr</span><br><span class="line"><span class="variable">$14</span> = 168430090</span><br><span class="line">(gdb) <span class="built_in">print</span> *arr@</span><br><span class="line">A syntax error <span class="keyword">in</span> expression, near `<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 3</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430090, 168430090, 168430090, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">$15 = 4</span></span><br><span class="line"><span class="string">(gdb) p arr[i]</span></span><br><span class="line"><span class="string">$16 = 168430090</span></span><br><span class="line"><span class="string">(gdb) p arr[20]</span></span><br><span class="line"><span class="string">$17 = -7664</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">Continuing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">7            arr[i]=arr[i]+i;</span></span><br><span class="line"><span class="string">(gdb) bt full</span></span><br><span class="line"><span class="string">#0  printArray (arr=0x7fffffffe0d0, n=10) at test2.c:7</span></span><br><span class="line"><span class="string">        i = 6</span></span><br><span class="line"><span class="string">#1  0x00000000004006ec in main () at test2.c:20</span></span><br><span class="line"><span class="string">        n = 10</span></span><br><span class="line"><span class="string">        arr = &#123;168430090, 168430091, 168430092, 168430093, 168430094, 168430095, 168430090, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">(gdb) p i</span></span><br><span class="line"><span class="string">No symbol &quot;i&quot; in current context.</span></span><br><span class="line"><span class="string">(gdb) p $i</span></span><br><span class="line"><span class="string">$24 = 5</span></span><br><span class="line"><span class="string">(gdb) set arr[$i]=10</span></span><br><span class="line"><span class="string">(gdb) set arr[$i++]=11</span></span><br><span class="line"><span class="string">(gdb) p arr[5]</span></span><br><span class="line"><span class="string">$26 = 10</span></span><br><span class="line"><span class="string">(gdb) p arr[6]</span></span><br><span class="line"><span class="string">$27 = 11</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p/t arr[6]</span></span><br><span class="line"><span class="string">$28 = 1011</span></span><br><span class="line"><span class="string">(gdb) p/x arr[6]</span></span><br><span class="line"><span class="string">$29 = 0xb</span></span><br><span class="line"><span class="string">(gdb) p/f arr[6]</span></span><br><span class="line"><span class="string">$30 = 1.54142831e-44</span></span><br><span class="line"><span class="string">(gdb) p/c arr[6]</span></span><br><span class="line"><span class="string">$31 = 11 &#x27;</span>\v<span class="string">&#x27;</span></span><br><span class="line"><span class="string">(gdb) p/d arr[6]</span></span><br><span class="line"><span class="string">$32 = 11</span></span><br><span class="line"><span class="string">(gdb) p/o arr[6]</span></span><br><span class="line"><span class="string">$33 = 013</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">examine (x command)</span></span><br><span class="line"><span class="string">(gdb) p arr</span></span><br><span class="line"><span class="string">$37 = &#123;168430090, 168430091, 168430092, 168430093, 168430094, 10, 11, 168430090, 168430090, 168430090&#125;</span></span><br><span class="line"><span class="string">      __________ same with print format</span></span><br><span class="line"><span class="string">      |</span></span><br><span class="line"><span class="string">x/[n][f][u]</span></span><br><span class="line"><span class="string">   |     |</span></span><br><span class="line"><span class="string"> number  -------------- b. Bytes. h. Halfwords (two bytes). w. Words (four bytes) This is the initial default.  g. Giant words (eight bytes)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) x/10d arr</span></span><br><span class="line"><span class="string">0x7fffffffe0d0: 168430090       168430091       168430092       168430093</span></span><br><span class="line"><span class="string">0x7fffffffe0e0: 168430094       10      11      168430090</span></span><br><span class="line"><span class="string">0x7fffffffe0f0: 168430090       168430090</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) info reg</span></span><br><span class="line"><span class="string">rax            0x400aaae297396d09       4614688658370948361</span></span><br><span class="line"><span class="string">rbx            0x7fffffffe100   140737488347392</span></span><br><span class="line"><span class="string">rcx            0x7fffdfafe9b0   140736946235824</span></span><br><span class="line"><span class="string">rdx            0xa      10</span></span><br><span class="line"><span class="string">rsi            0xa      10</span></span><br><span class="line"><span class="string">rdi            0x7fffffffe0d0   140737488347344</span></span><br><span class="line"><span class="string">rbp            0x7fffffffe0c0   0x7fffffffe0c0</span></span><br><span class="line"><span class="string">rsp            0x7fffffffe090   0x7fffffffe090</span></span><br><span class="line"><span class="string">r8             0xffffffffffffffff       -1</span></span><br><span class="line"><span class="string">r9             0x0      0</span></span><br><span class="line"><span class="string">r10            0x22     34</span></span><br><span class="line"><span class="string">r11            0x246    582</span></span><br><span class="line"><span class="string">r12            0x4004d0 4195536</span></span><br><span class="line"><span class="string">r13            0x7fffffffe210   140737488347664</span></span><br><span class="line"><span class="string">r14            0x0      0</span></span><br><span class="line"><span class="string">r15            0x0      0</span></span><br><span class="line"><span class="string">rip            0x4005da 0x4005da &lt;printArray+29&gt;</span></span><br><span class="line"><span class="string">eflags         0x206    [ PF IF ]</span></span><br><span class="line"><span class="string">cs             0x33     51</span></span><br><span class="line"><span class="string">ss             0x2b     43</span></span><br><span class="line"><span class="string">ds             0x0      0</span></span><br><span class="line"><span class="string">es             0x0      0</span></span><br><span class="line"><span class="string">fs             0x0      0</span></span><br><span class="line"><span class="string">gs             0x0      0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) list</span></span><br><span class="line"><span class="string">1       #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">2       int main()</span></span><br><span class="line"><span class="string">3       &#123;</span></span><br><span class="line"><span class="string">4               float x = 456.876;</span></span><br><span class="line"><span class="string">5               printf (&quot;\nx = %f\n&quot;, x);</span></span><br><span class="line"><span class="string">6               return 0;</span></span><br><span class="line"><span class="string">7       &#125;</span></span><br><span class="line"><span class="string">(gdb) b 4</span></span><br><span class="line"><span class="string">Breakpoint 1 at 0x400535: file float.c, line 4.</span></span><br><span class="line"><span class="string">(gdb) b 5</span></span><br><span class="line"><span class="string">Breakpoint 2 at 0x40053e: file float.c, line 5.</span></span><br><span class="line"><span class="string">(gdb) b 6</span></span><br><span class="line"><span class="string">Breakpoint 3 at 0x400555: file float.c, line 6.</span></span><br><span class="line"><span class="string">(gdb) c</span></span><br><span class="line"><span class="string">The program is not being run.</span></span><br><span class="line"><span class="string">(gdb) start</span></span><br><span class="line"><span class="string">Temporary breakpoint 4 at 0x400535: file float.c, line 4.</span></span><br><span class="line"><span class="string">Starting program: /root/./a.out</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, main () at float.c:4</span></span><br><span class="line"><span class="string">4               float x = 456.876;</span></span><br><span class="line"><span class="string">(gdb) n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 2, main () at float.c:5</span></span><br><span class="line"><span class="string">5               printf (&quot;\nx = %f\n&quot;, x);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p x</span></span><br><span class="line"><span class="string">$5 = 456.876007</span></span><br><span class="line"><span class="string">(gdb) x/fw &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe12c: 456.876007</span></span><br><span class="line"><span class="string">(gdb) x/tw &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe12c: 01000011111001000111000000100001</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### modify the float to double</span></span><br><span class="line"><span class="string">(gdb) list</span></span><br><span class="line"><span class="string">1       #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">2       int main()</span></span><br><span class="line"><span class="string">3       &#123;</span></span><br><span class="line"><span class="string">4               //float x = 456.876;</span></span><br><span class="line"><span class="string">5               double x = 456.876;</span></span><br><span class="line"><span class="string">6               printf (&quot;\nx = %lf\n&quot;, x);</span></span><br><span class="line"><span class="string">7               return 0;</span></span><br><span class="line"><span class="string">8       &#125;</span></span><br><span class="line"><span class="string">(gdb) x/1fg &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe128: 456.87599999999998</span></span><br><span class="line"><span class="string">(gdb) x/1tg &amp;x</span></span><br><span class="line"><span class="string">0x7fffffffe128: 0100000001111100100011100000010000011000100100110111010010111100</span></span><br><span class="line"><span class="string">(gdb) p x</span></span><br><span class="line"><span class="string">$6 = 456.87599999999998</span></span><br></pre></td></tr></table></figure>

<h4 id="print-argv"><a href="#print-argv" class="headerlink" title="print argv"></a><a target="_blank" rel="noopener" href="https://wizardforcel.gitbooks.io/100-gdb-tips/set-program-args.html">print argv</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -g3 walk1.c -o walk</span><br><span class="line">$ gdb ./walk <span class="comment"># or you could $ gdb -args ./walk /tmp 10</span></span><br><span class="line">Reading symbols from /root/walk...done.</span><br><span class="line"></span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x400bb8: file walk1.c, line 73.</span><br><span class="line">(gdb) r /tmp 10 <span class="comment">#  or you could (gdb) set args /tmp 10</span></span><br><span class="line">Starting program: /root/./walk /tmp 10</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main (argc=3, argv=0x7fffffffe138) at walk1.c:73</span><br><span class="line">73          <span class="keyword">if</span>(argc != 3)</span><br><span class="line">(gdb) p argc</span><br><span class="line"><span class="variable">$1</span> = 3</span><br><span class="line">(gdb) p argv</span><br><span class="line"><span class="variable">$2</span> = (char **) 0x7fffffffe138</span><br><span class="line">(gdb) p argv[0]</span><br><span class="line"><span class="variable">$3</span> = 0x7fffffffe414 <span class="string">&quot;/root/./walk&quot;</span></span><br><span class="line">(gdb) p argv[1]</span><br><span class="line"><span class="variable">$4</span> = 0x7fffffffe421 <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">(gdb) p argv[2]</span><br><span class="line"><span class="variable">$5</span> = 0x7fffffffe426 <span class="string">&quot;10&quot;</span></span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"><span class="comment"># attach args</span></span><br><span class="line">$ gdb --args /bin/bash -c <span class="string">&#x27;ls -l&#x27;</span></span><br><span class="line">$ <span class="built_in">set</span> listsize 40</span><br><span class="line">$ p *args@4</span><br><span class="line"></span><br><span class="line"><span class="comment"># if the software was install by source, you could add --directory for import debug symbol</span></span><br><span class="line"><span class="comment"># re-complie bash</span></span><br><span class="line"></span><br><span class="line">$ gdb --args /usr/local/bin/bash -c <span class="string">&#x27;echo [1g]&#x27;</span> --directory ~/tools/bash-4.4</span><br><span class="line">(gdb) la src</span><br><span class="line"></span><br><span class="line"><span class="comment">## if you want disable optimze</span></span><br><span class="line">$ CFLAGS=<span class="string">&quot;-g -O0&quot;</span> CXXFLAGS=<span class="string">&quot;-g -O0&quot;</span> LDFLAGS=<span class="string">&quot;-g&quot;</span>  ./configure --enable-debugger</span><br><span class="line">$ CFLAGS=<span class="string">&quot;-g -O0&quot;</span> CXXFLAGS=<span class="string">&quot;-g -O0&quot;</span> LDFLAGS=<span class="string">&quot;-g&quot;</span>  ./make -j 2</span><br><span class="line"></span><br><span class="line"><span class="comment">## set debug directory</span></span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory &lt;directory&gt;</span><br><span class="line">(gdb) show debug-file-directory</span><br><span class="line">(gdb) <span class="built_in">set</span> debug-file-directory /usr/lib/debug</span><br><span class="line">add-symbol-file filename address</span><br><span class="line">add-symbol-file filename address [ -readnow ] [ -mapped ]</span><br><span class="line">add-symbol-file filename -ssection address ...</span><br></pre></td></tr></table></figure>

<h4 id="threads"><a href="#threads" class="headerlink" title="threads"></a>threads</h4><p>Demo code</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">mutex _mutex;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> total = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//g++ -std=c++11 testthread.cpp -o testthread -lpthread -g</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun</span><span class="params">(<span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        lock_guard&lt;mutex&gt;lock(_mutex);</span><br><span class="line">        total +=num;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;num:&quot;</span>&lt;&lt;num&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    thread <span class="title function_">t1</span><span class="params">(fun,<span class="number">3</span>)</span>;</span><br><span class="line">    thread <span class="title function_">t2</span><span class="params">(fun,<span class="number">5</span>)</span>;</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ gdb ./testthread</span><br><span class="line">$ info threads</span><br><span class="line">$ thread <span class="number">3</span></span><br><span class="line">$ <span class="built_in">set</span> scheduler-locking on</span><br></pre></td></tr></table></figure>

<p>generate-core-file<br>&#96;&#96;bash<br>(gdb) generate-core-file</p>
<h1 id="or"><a href="#or" class="headerlink" title="or"></a>or</h1><p>gcore $pid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### example2</span><br><span class="line">- stack</span><br><span class="line">  - LIFO (Last In first out)</span><br><span class="line">  - push data in stack</span><br><span class="line">  - pop data out of the stack</span><br><span class="line"></span><br><span class="line">- stack frame</span><br><span class="line">  - Lower to high addr</span><br><span class="line">  - frame point (FP)</span><br><span class="line">    - the start of the last frame</span><br><span class="line">       - in the bottom</span><br><span class="line">       - $rbp register</span><br><span class="line">  - stack point (SP)</span><br><span class="line">    - the end of the last frame</span><br><span class="line">      - always in the top addr</span><br><span class="line">      - $sp register</span><br><span class="line"></span><br><span class="line">linux-3.10.0-1127.el7/arch/x86/include/asm/ptrace.h  </span><br><span class="line">[psABI-x86_64.pdf](https://uclibc.org/docs/psABI-x86_64.pdf)    </span><br><span class="line">- User-level applications use as integer registers for passing the sequence %rdi, %rsi, %rdx, %rcx, %r8 and %r9</span><br><span class="line">- The kernel interface uses %rdi, %rsi, %rdx, %r10, %r8 and %r9</span><br><span class="line">- A system-call is done via the syscall instruction. The kernel destroys registers %rcx and %r11</span><br><span class="line">- The number of the syscall has to be passed in register %rax</span><br><span class="line">- System-calls are limited to six arguments, no argument is passed directly on the stack</span><br><span class="line">- Returning from the syscall, register %rax contains the result of the system-call. A value in the range between -4095 and -1 indicates an error, it is -errno</span><br><span class="line">- Only values of class INTEGER or class MEMORY are passed to the kernel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">arch/x86/entry/calling.h   </span><br><span class="line">x86 function call convention, 64-bit:</span><br><span class="line">-------------------------------------</span><br><span class="line"> arguments           | callee-saved       | extra caller-saved | return</span><br><span class="line">[callee-clobbered]   |                    | [callee-clobbered] |</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">rdi rsi rdx rcx r8-9 | rbx rbp [*] r12-15 | r10-11             | rax, rdx [**]</span><br><span class="line"></span><br><span class="line"> ( rsp is obviously invariant across normal function calls. (gcc can &#x27;merge&#x27;</span><br><span class="line">   functions when it sees tail-call optimization possibilities) rflags is</span><br><span class="line">   clobbered. Leftover arguments are passed over the stack frame.)</span><br><span class="line"></span><br><span class="line"> [*]  In the frame-pointers case rbp is fixed to the stack frame.</span><br><span class="line"></span><br><span class="line"> [**] for struct return values wider than 64 bits the return convention is a</span><br><span class="line">      bit more complex: up to 128 bits width we return small structures</span><br><span class="line">      straight in rax, rdx. For structures larger than that (3 words or</span><br><span class="line">      larger) the caller puts a pointer to an on-stack return struct</span><br><span class="line">      [allocated in the caller&#x27;s stack frame] into the first argument - i.e.</span><br><span class="line">      into rdi. All other arguments shift up by one in this case.</span><br><span class="line">      Fortunately this case is rare in the kernel.</span><br><span class="line"></span><br><span class="line">// x86_64</span><br><span class="line">struct pt_regs &#123;</span><br><span class="line">        unsigned long r15;</span><br><span class="line">        unsigned long r14;</span><br><span class="line">        unsigned long r13;</span><br><span class="line">        unsigned long r12;</span><br><span class="line">        unsigned long bp;</span><br><span class="line">        unsigned long bx;</span><br><span class="line">/* arguments: non interrupts/non tracing syscalls only save up to here*/</span><br><span class="line">        unsigned long r11;</span><br><span class="line">        unsigned long r10;</span><br><span class="line">        unsigned long r9; // mapped to arg[5], if arg[5] is the float number, the r9 will not save it</span><br><span class="line">        unsigned long r8; // mapped to arg[4]</span><br><span class="line">        unsigned long ax;</span><br><span class="line">        unsigned long cx; // mapped to arg[3]</span><br><span class="line">        unsigned long dx; // mapped to arg[2]</span><br><span class="line">        unsigned long si; // mapped to arg[1]</span><br><span class="line">        unsigned long di; // mapped to arg[0] first parameters</span><br><span class="line">        unsigned long orig_ax;</span><br><span class="line">/* end of arguments */</span><br><span class="line">/* cpu exception frame or undefined */</span><br><span class="line">        unsigned long ip;</span><br><span class="line">        unsigned long cs;</span><br><span class="line">        unsigned long flags;</span><br><span class="line">        unsigned long sp;</span><br><span class="line">        unsigned long ss;</span><br><span class="line">/* top of stack page */</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#linux/arch/x86/entry/common.c</span><br><span class="line">#ifdef CONFIG_X86_64</span><br><span class="line">                if (arch == AUDIT_ARCH_X86_64) &#123;</span><br><span class="line">                        sd.args[0] = regs-&gt;di;</span><br><span class="line">                        sd.args[1] = regs-&gt;si;</span><br><span class="line">                        sd.args[2] = regs-&gt;dx;</span><br><span class="line">                        sd.args[3] = regs-&gt;r10;</span><br><span class="line">                        sd.args[4] = regs-&gt;r8;</span><br><span class="line">                        sd.args[5] = regs-&gt;r9;</span><br><span class="line">                &#125; else</span><br><span class="line">#endif</span><br><span class="line">                &#123;</span><br><span class="line">                        sd.args[0] = regs-&gt;bx;</span><br><span class="line">                        sd.args[1] = regs-&gt;cx;</span><br><span class="line">                        sd.args[2] = regs-&gt;dx;</span><br><span class="line">                        sd.args[3] = regs-&gt;si;</span><br><span class="line">                        sd.args[4] = regs-&gt;di;</span><br><span class="line">                        sd.args[5] = regs-&gt;bp;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> v1 = <span class="number">1</span>;</span><br><span class="line"><span class="type">float</span> v2 = <span class="number">0.01</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> a, <span class="type">long</span> b, <span class="type">short</span> c,<span class="type">char</span> d, <span class="type">long</span> <span class="type">long</span> e, <span class="type">float</span> f, <span class="type">double</span> g, <span class="type">int</span> *h, <span class="type">float</span> *i, <span class="type">char</span> *j)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;a: %d, b:%ld, c:%d, d: %c, e: %lld\n&quot;</span></span><br><span class="line">   <span class="string">&quot;f: %.3e, g:%.3e\nh: %p, i: %p, j:%p\n&quot;</span>, a, b, c, d, e, f, g, h, i, j);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  func(<span class="number">100</span>, <span class="number">35000L</span>, <span class="number">5</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">123456789LL</span>, <span class="number">3.14</span>, <span class="number">2.99792458e8</span>, &amp;v1, &amp;v2, <span class="string">&quot;string&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b *func</span><br><span class="line">Breakpoint 1 at 0x40052d: file c_para.c, line 7.</span><br><span class="line">(gdb) run</span><br><span class="line">Starting program: /root/codes/./c_para</span><br><span class="line"></span><br><span class="line">Breakpoint 1, func (a=0, b=1, c=1629, d=0 <span class="string">&#x27;\000&#x27;</span>, e=0, f=2.21061657e-38, g=0, h=0x76, i=0x601038 &lt;v2&gt;, j=0x4006e7 <span class="string">&quot;string&quot;</span>) at c_para.c:7</span><br><span class="line">7       &#123;</span><br><span class="line">(gdb) i r</span><br><span class="line">rax            0x41b1de784a000000       4733809291562057728</span><br><span class="line">rbx            0x0      0</span><br><span class="line">rcx            0x41     65                     -------&gt; args[3]</span><br><span class="line">rdx            0x5      5                      -------&gt; args[2]</span><br><span class="line">rsi            0x88b8   35000                  -------&gt; args[1]</span><br><span class="line">rdi            0x64     100                    -------&gt; args[0]</span><br><span class="line">rbp            0x7fffffffe400   0x7fffffffe400</span><br><span class="line">rsp            0x7fffffffe3d8   0x7fffffffe3d8</span><br><span class="line">r8             0x75bcd15        123456789      -------&gt; args[4], args[5] and args[6] is the <span class="built_in">float</span> and double <span class="built_in">type</span>, save <span class="keyword">in</span> xmm (128 bits)</span><br><span class="line">r9             0x601034 6295604                -------&gt; args[7]</span><br><span class="line">r10            0x7fffffffdf20   140737488346912</span><br><span class="line">r11            0x7ffff7a2f460   140737348039776</span><br><span class="line">r12            0x400440 4195392</span><br><span class="line">r13            0x7fffffffe4e0   140737488348384</span><br><span class="line">r14            0x0      0</span><br><span class="line">r15            0x0      0</span><br><span class="line">rip            0x40052d 0x40052d &lt;func&gt;</span><br><span class="line">eflags         0x202    [ IF ]</span><br><span class="line">cs             0x33     51</span><br><span class="line">ss             0x2b     43</span><br><span class="line">ds             0x0      0</span><br><span class="line">es             0x0      0</span><br><span class="line">fs             0x0      0</span><br><span class="line">gs             0x0      0</span><br><span class="line"></span><br><span class="line"><span class="comment">#because no enough register, two parameters save in stack (rsp register)</span></span><br><span class="line"><span class="comment">#In the stack begining, there is the function return addr, In x86_64, int and point size is the giant word (32 bits, 4 Bytes)</span></span><br><span class="line">0x7fffffffe3e8-0x7fffffffe3d8=16(dec)</span><br><span class="line"></span><br><span class="line">(gdb) x/3g <span class="variable">$rsp</span></span><br><span class="line">0x7fffffffe3d8: 4195844 6295608</span><br><span class="line">0x7fffffffe3e8: 4196071</span><br><span class="line"></span><br><span class="line"><span class="comment">#$rsp+0xc means The memory location 12 bytes above current stack pointer</span></span><br><span class="line"></span><br><span class="line">6295608=0x601038</span><br><span class="line">(gdb) <span class="built_in">printf</span> <span class="string">&quot;%.2f\n&quot;</span>, *(<span class="built_in">float</span>*)0x601038</span><br><span class="line">0.01</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">(gdb) <span class="built_in">printf</span> <span class="string">&quot;%.2f\n&quot;</span>, *(<span class="built_in">float</span>*)(*(unsigned long*)(<span class="variable">$rsp</span>+0x8))</span><br><span class="line">0.01</span><br><span class="line"></span><br><span class="line">4196071=0x4006E7</span><br><span class="line">(gdb) p (char*)0x4006E7</span><br><span class="line"><span class="variable">$9</span> = 0x4006e7 <span class="string">&quot;string&quot;</span></span><br><span class="line"></span><br><span class="line">long 8 bytes (64bit OS), 4 bytes (32bit OS)</span><br><span class="line">Add 8 bytes, go to <span class="variable">$rsp</span>+0x10</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">0x10=16</span><br><span class="line">(gdb) p (char*)(*(unsigned long*)(<span class="variable">$rsp</span>+0x10))</span><br><span class="line"><span class="variable">$11</span> = 0x4006e7 <span class="string">&quot;string&quot;</span></span><br><span class="line"></span><br><span class="line">(gdb) disas func</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> func:</span><br><span class="line">=&gt; 0x000000000040052d &lt;+0&gt;:     push   %rbp</span><br><span class="line">   0x000000000040052e &lt;+1&gt;:     mov    %rsp,%rbp</span><br><span class="line">   0x0000000000400531 &lt;+4&gt;:     sub    <span class="variable">$0x50</span>,%rsp</span><br><span class="line">   0x0000000000400535 &lt;+8&gt;:     mov    %edi,-0x4(%rbp)</span><br><span class="line">   0x0000000000400538 &lt;+11&gt;:    mov    %rsi,-0x10(%rbp)</span><br><span class="line">   0x000000000040053c &lt;+15&gt;:    mov    %ecx,%eax</span><br><span class="line">   0x000000000040053e &lt;+17&gt;:    mov    %r8,-0x20(%rbp)</span><br><span class="line">   0x0000000000400542 &lt;+21&gt;:    movss  %xmm0,-0x18(%rbp)</span><br><span class="line">   0x0000000000400547 &lt;+26&gt;:    movsd  %xmm1,-0x28(%rbp)</span><br><span class="line">   0x000000000040054c &lt;+31&gt;:    mov    %r9,-0x30(%rbp)</span><br><span class="line">   0x0000000000400550 &lt;+35&gt;:    mov    %dx,-0x8(%rbp)</span><br><span class="line">   0x0000000000400554 &lt;+39&gt;:    mov    %al,-0x14(%rbp)</span><br><span class="line">   0x0000000000400557 &lt;+42&gt;:    movss  -0x18(%rbp),%xmm0</span><br><span class="line">   0x000000000040055c &lt;+47&gt;:    cvtps2pd %xmm0,%xmm0</span><br><span class="line">   0x000000000040055f &lt;+50&gt;:    movsbl -0x14(%rbp),%r8d</span><br><span class="line">   0x0000000000400564 &lt;+55&gt;:    movswl -0x8(%rbp),%ecx</span><br><span class="line">   0x0000000000400568 &lt;+59&gt;:    mov    -0x28(%rbp),%rax</span><br><span class="line">   0x000000000040056c &lt;+63&gt;:    mov    -0x20(%rbp),%r9</span><br><span class="line">   0x0000000000400570 &lt;+67&gt;:    mov    -0x10(%rbp),%rdx</span><br><span class="line">   0x0000000000400574 &lt;+71&gt;:    mov    -0x4(%rbp),%esi</span><br><span class="line">   0x0000000000400577 &lt;+74&gt;:    mov    0x18(%rbp),%rdi</span><br><span class="line">   0x000000000040057b &lt;+78&gt;:    mov    %rdi,0x10(%rsp)</span><br><span class="line">   0x0000000000400580 &lt;+83&gt;:    mov    0x10(%rbp),%rdi</span><br><span class="line">   0x0000000000400584 &lt;+87&gt;:    mov    %rdi,0x8(%rsp)</span><br><span class="line">   0x0000000000400589 &lt;+92&gt;:    mov    -0x30(%rbp),%rdi</span><br><span class="line">   0x000000000040058d &lt;+96&gt;:    mov    %rdi,(%rsp)</span><br><span class="line">   0x0000000000400591 &lt;+100&gt;:   mov    %rax,-0x38(%rbp)</span><br><span class="line">   0x0000000000400595 &lt;+104&gt;:   movsd  -0x38(%rbp),%xmm1</span><br><span class="line">   0x000000000040059a &lt;+109&gt;:   mov    <span class="variable">$0x4006a0</span>,%edi</span><br><span class="line">   0x000000000040059f &lt;+114&gt;:   mov    <span class="variable">$0x2</span>,%eax</span><br><span class="line">   0x00000000004005a4 &lt;+119&gt;:   callq  0x400410 &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">   0x00000000004005a9 &lt;+124&gt;:   leaveq</span><br><span class="line">   0x00000000004005aa &lt;+125&gt;:   retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<h4 id="example3"><a href="#example3" class="headerlink" title="example3"></a>example3</h4><p>$rip (instruction pointer)    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  sum_till_MAX (n=4) at sum.c:14</span></span><br><span class="line"><span class="comment">#1  0x0000000000400698 in sum_till_MAX (n=4) at sum.c:18</span></span><br><span class="line"><span class="comment">#2  0x0000000000400698 in sum_till_MAX (n=3) at sum.c:18</span></span><br><span class="line"><span class="comment">#3  0x0000000000400698 in sum_till_MAX (n=2) at sum.c:18</span></span><br><span class="line"><span class="comment">#4  0x0000000000400698 in sum_till_MAX (n=1) at sum.c:18</span></span><br><span class="line"><span class="comment">#5  0x0000000000400757 in main (argc=2, argv=0x7fffffffe4e8) at sum.c:33</span></span><br><span class="line">(gdb) i r rip rbp</span><br><span class="line">rip            0x400698 0x400698 &lt;sum_till_MAX+43&gt;</span><br><span class="line">rbp            0x7fffffffe370   0x7fffffffe370</span><br><span class="line">(gdb) x/40w <span class="variable">$sp</span></span><br><span class="line">0x7fffffffe350: 0x00000000      0x00000000      0x00000000      0x00000003</span><br><span class="line">0x7fffffffe360: 0x00000000      0x00000000      0x00000003      0x00000000</span><br><span class="line">0x7fffffffe370: 0xffffe3a0      0x00007fff      0x00400698      0x00000000</span><br><span class="line">0x7fffffffe380: 0x00000000      0x00000000      0xffffe405      0x00000002</span><br><span class="line">0x7fffffffe390: 0xffffffff      0xffffffff      0x00000002      0x00000000</span><br><span class="line">0x7fffffffe3a0: 0xffffe3d0      0x00007fff      0x00400698      0x00000000</span><br><span class="line">0x7fffffffe3b0: 0xffffe400      0x00007fff      0x00400580      0x00000001</span><br><span class="line">0x7fffffffe3c0: 0xffffe4e0      0x00007fff      0x00000001      0x00000000</span><br><span class="line">0x7fffffffe3d0: 0xffffe400      0x00007fff      0x00400757      0x00000000</span><br><span class="line">0x7fffffffe3e0: 0xffffe4e8      0x00007fff      0x00400580      0x00000002</span><br><span class="line">(gdb) i frame 1</span><br><span class="line">Stack frame at 0x7fffffffe350:</span><br><span class="line"> rip = 0x400698 <span class="keyword">in</span> sum_till_MAX (sum.c:18); saved rip 0x400698</span><br><span class="line"> called by frame at 0x7fffffffe380, <span class="built_in">caller</span> of frame at 0x7fffffffe320</span><br><span class="line"> <span class="built_in">source</span> language c.</span><br><span class="line"> Arglist at 0x7fffffffe340, args: n=4</span><br><span class="line"> Locals at 0x7fffffffe340, Previous frame<span class="string">&#x27;s sp is 0x7fffffffe350</span></span><br><span class="line"><span class="string"> Saved registers:</span></span><br><span class="line"><span class="string">  rbp at 0x7fffffffe340, rip at 0x7fffffffe348</span></span><br><span class="line"><span class="string">(gdb) x/i $pc</span></span><br><span class="line"><span class="string">=&gt; 0x400698 &lt;sum_till_MAX+43&gt;:  add    %rax,-0x8(%rbp)</span></span><br><span class="line"><span class="string">(gdb) p $sp</span></span><br><span class="line"><span class="string">$7 = (void *) 0x7fffffffe350</span></span><br><span class="line"><span class="string">(gdb) i proc mapping</span></span><br><span class="line"><span class="string">process 1868</span></span><br><span class="line"><span class="string">Mapped address spaces:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          Start Addr           End Addr       Size     Offset objfile</span></span><br><span class="line"><span class="string">            0x400000           0x401000     0x1000        0x0 /root/codes/sum</span></span><br><span class="line"><span class="string">            0x600000           0x601000     0x1000        0x0 /root/codes/sum</span></span><br><span class="line"><span class="string">            0x601000           0x602000     0x1000     0x1000 /root/codes/sum</span></span><br><span class="line"><span class="string">      0x7ffff7a0d000     0x7ffff7bd1000   0x1c4000        0x0 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7bd1000     0x7ffff7dd0000   0x1ff000   0x1c4000 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7dd0000     0x7ffff7dd4000     0x4000   0x1c3000 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7dd4000     0x7ffff7dd6000     0x2000   0x1c7000 /usr/lib64/libc-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7dd6000     0x7ffff7ddb000     0x5000        0x0</span></span><br><span class="line"><span class="string">      0x7ffff7ddb000     0x7ffff7dfd000    0x22000        0x0 /usr/lib64/ld-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7ff1000     0x7ffff7ff4000     0x3000        0x0</span></span><br><span class="line"><span class="string">      0x7ffff7ff9000     0x7ffff7ffa000     0x1000        0x0</span></span><br><span class="line"><span class="string">      0x7ffff7ffa000     0x7ffff7ffc000     0x2000        0x0 [vdso]</span></span><br><span class="line"><span class="string">      0x7ffff7ffc000     0x7ffff7ffd000     0x1000    0x21000 /usr/lib64/ld-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7ffd000     0x7ffff7ffe000     0x1000    0x22000 /usr/lib64/ld-2.17.so</span></span><br><span class="line"><span class="string">      0x7ffff7ffe000     0x7ffff7fff000     0x1000        0x0</span></span><br><span class="line"><span class="string">      0x7ffffffde000     0x7ffffffff000    0x21000        0x0 [stack]</span></span><br><span class="line"><span class="string">  0xffffffffff600000 0xffffffffff601000     0x1000        0x0 [vsyscall]</span></span><br></pre></td></tr></table></figure>

<h4 id="example4"><a href="#example4" class="headerlink" title="example4"></a>example4</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ gdb /usr/lib64/libc-2.17.so</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-redhat-linux-gnu&quot;.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /usr/lib64/libc-2.17.so...Reading symbols from /usr/lib/debug/usr/lib64/libc-2.17.so.debug...done.</span><br><span class="line">done.</span><br><span class="line"></span><br><span class="line">#show the offset</span><br><span class="line">(gdb) disas memcmp</span><br><span class="line">Dump of assembler code for function memcmp:</span><br><span class="line">   0x000000000008f2f0 &lt;+0&gt;:     mov    0x337b51(%rip),%rdx        # 0x3c6e48</span><br><span class="line">   0x000000000008f2f7 &lt;+7&gt;:     testl  $0x200,0x80(%rdx)</span><br><span class="line">   0x000000000008f301 &lt;+17&gt;:    jne    0x8f30b &lt;memcmp+27&gt;</span><br><span class="line">   0x000000000008f303 &lt;+19&gt;:    lea    0x26(%rip),%rax        # 0x8f330 &lt;__memcmp_sse2&gt;</span><br><span class="line">   0x000000000008f30a &lt;+26&gt;:    retq</span><br><span class="line">   0x000000000008f30b &lt;+27&gt;:    testl  $0x80000,0x80(%rdx)</span><br><span class="line">   0x000000000008f315 &lt;+37&gt;:    je     0x8f31f &lt;memcmp+47&gt;</span><br><span class="line">   0x000000000008f317 &lt;+39&gt;:    lea    0xdac92(%rip),%rax        # 0x169fb0 &lt;__memcmp_sse4_1&gt;</span><br><span class="line">   0x000000000008f31e &lt;+46&gt;:    retq</span><br><span class="line">   0x000000000008f31f &lt;+47&gt;:    lea    0xde5ba(%rip),%rax        # 0x16d8e0 &lt;__memcmp_ssse3&gt;</span><br><span class="line">   0x000000000008f326 &lt;+54&gt;:    retq</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<h4 id="example5-gcc-parameters-and-show-macro"><a href="#example5-gcc-parameters-and-show-macro" class="headerlink" title="example5 gcc parameters and show macro"></a>example5 <a target="_blank" rel="noopener" href="http://www.lenky.info/archives/2012/08/1910">gcc parameters and show macro</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Wall -O2 -pg -o t.O2.pg t.c</span><br></pre></td></tr></table></figure>
<ul>
<li>pg: Generate extra code to write profile information suitable for the analysis program gprof.  You must use this option when compiling the source files you want data about, and you must also use it when linking.</li>
<li>time[&#x3D;file]: Report the CPU time taken by each subprocess in the compilation sequence</li>
<li>“-Q”:  Makes the compiler print out each function name as it is compiled, and print some statistics about each pass when it finishes.</li>
<li>fno-inline: Do not expand any functions inline apart from those marked with the “always_inline” attribute.  This is the default when not optimizing.</li>
<li>-g produces debugging information in theOS native format</li>
<li>-ggdb produces debugging information specifically intennded for gdb</li>
<li>-ggdb3 produces extra debugging information, for example: including macro definitions</li>
<li>wall means enable warnning</li>
<li>-O0  turn off all optimization</li>
<li>-O1 ,-O2, -O3  optimization</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat t.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;t.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> A 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> B (2+A)</span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">myfunc</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b, <span class="type">long</span> c, <span class="type">long</span> d,</span></span><br><span class="line"><span class="params">            <span class="type">long</span> e, <span class="type">long</span> f, <span class="type">long</span> g, <span class="type">long</span> h)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> xx = a * b * c * d * e * f * g * h;</span><br><span class="line">    <span class="type">long</span> yy = a + b + c + d + e + f + g + h;</span><br><span class="line">    <span class="type">long</span> zz = utilfunc(xx, yy, xx % yy);</span><br><span class="line">    <span class="keyword">return</span> zz + <span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    myfunc(<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">77</span>, <span class="number">88</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, B);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat t.h</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _T_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _T_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">long</span> <span class="title function_">utilfunc</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b, <span class="type">long</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> xx = a + <span class="number">2</span>;</span><br><span class="line">    <span class="type">long</span> yy = b + <span class="number">3</span>;</span><br><span class="line">    <span class="type">long</span> zz = c + <span class="number">4</span>;</span><br><span class="line">    <span class="type">long</span> sum = xx + yy + zz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> xx * yy * zz + sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Wall -O2 -g -o t.O2.g t.c</span><br><span class="line">$ gdb t.O2.g -q</span><br><span class="line">Reading symbols from /home/testuser1/test/t.O2.g...done.</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x400440: file t.c, line 16.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /home/testuser1/test/t.O2.g</span><br><span class="line"></span><br><span class="line">Breakpoint 1, main (argc=1, argv=0x7fffffffe288) at t.c:16</span><br><span class="line">16      &#123;</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-307.el7.1.x86_64</span><br><span class="line">(gdb) info macro A</span><br><span class="line">The symbol `A<span class="string">&#x27; has no definition as a C/C++ preprocessor macro</span></span><br><span class="line"><span class="string">at &lt;user-defined&gt;:-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Add -ggdb3</span></span><br><span class="line"><span class="string">$ gcc -Wall -O2 -ggdb3 -o t.O2.gdb3.noinline.g t.c</span></span><br><span class="line"><span class="string">$ gdb t.O2.gdb3.noinline.g -q</span></span><br><span class="line"><span class="string">Reading symbols from /home/testuser1/test/t.O2.gdb3.noinline.g...done.</span></span><br><span class="line"><span class="string">(gdb) b main</span></span><br><span class="line"><span class="string">Breakpoint 1 at 0x400440: file t.c, line 16.</span></span><br><span class="line"><span class="string">(gdb) r</span></span><br><span class="line"><span class="string">Starting program: /home/testuser1/test/t.O2.gdb3.noinline.g</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Breakpoint 1, main (argc=1, argv=0x7fffffffe278) at t.c:16</span></span><br><span class="line"><span class="string">16      &#123;</span></span><br><span class="line"><span class="string">Missing separate debuginfos, use: debuginfo-install glibc-2.17-307.el7.1.x86_64</span></span><br><span class="line"><span class="string">(gdb)  info macro A</span></span><br><span class="line"><span class="string">Defined at /home/testuser1/test/t.c:3</span></span><br><span class="line"><span class="string">#define A 1</span></span><br><span class="line"><span class="string">(gdb)  info macro B</span></span><br><span class="line"><span class="string">Defined at /home/testuser1/test/t.c:4</span></span><br><span class="line"><span class="string">#define B (2+A)</span></span><br><span class="line"><span class="string">(gdb) macro expand A</span></span><br><span class="line"><span class="string">expands to: 1</span></span><br><span class="line"><span class="string">(gdb) macro expand B</span></span><br><span class="line"><span class="string">expands to: (2+1)</span></span><br><span class="line"><span class="string">(gdb) list utilfunc</span></span><br><span class="line"><span class="string">3       #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">4</span></span><br><span class="line"><span class="string">5       static inline long utilfunc(long a, long b, long c)</span></span><br><span class="line"><span class="string">6       &#123;</span></span><br><span class="line"><span class="string">7           long xx = a + 2;</span></span><br><span class="line"><span class="string">8           long yy = b + 3;</span></span><br><span class="line"><span class="string">9           long zz = c + 4;</span></span><br><span class="line"><span class="string">10          long sum = xx + yy + zz;</span></span><br><span class="line"><span class="string">11</span></span><br><span class="line"><span class="string">12          return xx * yy * zz + sum;</span></span><br><span class="line"><span class="string">(gdb) quit</span></span><br><span class="line"><span class="string">A debugging session is active.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inferior 1 [process 28148] will be killed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Quit anyway? (y or n) y</span></span><br></pre></td></tr></table></figure>

<h4 id="example6"><a href="#example6" class="headerlink" title="example6"></a>example6</h4><ul>
<li>In rsync-3.0.6 with the z parameter, it use level 0</li>
<li>In rsync-3.1.2 with the z parameter, it use level 6<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3.1.2 perf top</span></span><br><span class="line">[.] longest_match</span><br><span class="line">[.] deflate_slow</span><br><span class="line">[.] inflate_fast</span><br><span class="line">[.] md5_process</span><br><span class="line">[.] fill_window</span><br><span class="line">[.] compress_block</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.0.6</span></span><br><span class="line">[.] match_sums</span><br><span class="line">[.] send_files</span><br><span class="line">matched (inlined)</span><br><span class="line">[.] send_token</span><br><span class="line">send_deflated_token (inlined)</span><br><span class="line">[.] deflate</span><br><span class="line">[.] deflate_stored</span><br><span class="line">[.] md5_process</span><br><span class="line">md5_update (inlined)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>the deflate_stored call just work for level 0, deflate_slow work for level 6     </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">zlib/deflate.c</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> FASTEST</span></span><br><span class="line">local <span class="type">const</span> config configuration_table[<span class="number">2</span>] = &#123;</span><br><span class="line"><span class="comment">/*      good lazy nice chain */</span></span><br><span class="line"><span class="comment">/* 0 */</span> &#123;<span class="number">0</span>,    <span class="number">0</span>,  <span class="number">0</span>,    <span class="number">0</span>, deflate_stored&#125;,  <span class="comment">/* store only */</span></span><br><span class="line"><span class="comment">/* 1 */</span> &#123;<span class="number">4</span>,    <span class="number">4</span>,  <span class="number">8</span>,    <span class="number">4</span>, deflate_fast&#125;&#125;; <span class="comment">/* max speed, no lazy matches */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">local <span class="type">const</span> config configuration_table[<span class="number">10</span>] = &#123;</span><br><span class="line"><span class="comment">/*      good lazy nice chain */</span></span><br><span class="line"><span class="comment">/* 0 */</span> &#123;<span class="number">0</span>,    <span class="number">0</span>,  <span class="number">0</span>,    <span class="number">0</span>, deflate_stored&#125;,  <span class="comment">/* store only */</span></span><br><span class="line"><span class="comment">/* 1 */</span> &#123;<span class="number">4</span>,    <span class="number">4</span>,  <span class="number">8</span>,    <span class="number">4</span>, deflate_fast&#125;, <span class="comment">/* max speed, no lazy matches */</span></span><br><span class="line"><span class="comment">/* 2 */</span> &#123;<span class="number">4</span>,    <span class="number">5</span>, <span class="number">16</span>,    <span class="number">8</span>, deflate_fast&#125;,</span><br><span class="line"><span class="comment">/* 3 */</span> &#123;<span class="number">4</span>,    <span class="number">6</span>, <span class="number">32</span>,   <span class="number">32</span>, deflate_fast&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4 */</span> &#123;<span class="number">4</span>,    <span class="number">4</span>, <span class="number">16</span>,   <span class="number">16</span>, deflate_slow&#125;,  <span class="comment">/* lazy matches */</span></span><br><span class="line"><span class="comment">/* 5 */</span> &#123;<span class="number">8</span>,   <span class="number">16</span>, <span class="number">32</span>,   <span class="number">32</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 6 */</span> &#123;<span class="number">8</span>,   <span class="number">16</span>, <span class="number">128</span>, <span class="number">128</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 7 */</span> &#123;<span class="number">8</span>,   <span class="number">32</span>, <span class="number">128</span>, <span class="number">256</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 8 */</span> &#123;<span class="number">32</span>, <span class="number">128</span>, <span class="number">258</span>, <span class="number">1024</span>, deflate_slow&#125;,</span><br><span class="line"><span class="comment">/* 9 */</span> &#123;<span class="number">32</span>, <span class="number">258</span>, <span class="number">258</span>, <span class="number">4096</span>, deflate_slow&#125;&#125;; <span class="comment">/* max compression */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">##<span class="meta"># the deflate_stored comment</span></span><br><span class="line"><span class="comment">/* ===========================================================================</span></span><br><span class="line"><span class="comment"> * Copy without compression as much as possible from the input stream, return</span></span><br><span class="line"><span class="comment"> * the current block state.</span></span><br><span class="line"><span class="comment"> * This function does not insert new strings in the dictionary since</span></span><br><span class="line"><span class="comment"> * uncompressible data is probably not useful. This function is used</span></span><br><span class="line"><span class="comment"> * only for the level=0 compression option.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> this function should be optimized to avoid extra copying from</span></span><br><span class="line"><span class="comment"> * window to pending_buf.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>The function was _tr_flush_block and the key struct is “deflate_state *s;” in zlib&#x2F;trees.c    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> address on</span><br><span class="line">show <span class="built_in">print</span> address</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> array</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> array on</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> array off</span><br><span class="line">show <span class="built_in">print</span> array</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> elements</span><br><span class="line">show <span class="built_in">print</span> elements</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> null-stop (defualt off)</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">print</span> pretty on</span><br><span class="line"></span><br><span class="line">$ grep -Rin <span class="string">&quot;FAR deflate_state&quot;</span> rsync-3.1.2/zlib</span><br><span class="line">rsync-3.1.2/zlib/deflate.h:273:&#125; FAR deflate_state;</span><br><span class="line"></span><br><span class="line">/* A Pos is an index <span class="keyword">in</span> the character window. We use short instead of int to</span><br><span class="line"> * save space <span class="keyword">in</span> the various tables. IPos is used only <span class="keyword">for</span> parameter passing.</span><br><span class="line"> */</span><br><span class="line">typedef struct internal_state &#123;</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">&#125; FAR deflate_state;</span><br><span class="line"></span><br><span class="line">(gdb) b set_compression</span><br><span class="line">(gdb) b lp_dont_compress</span><br><span class="line">(gdb) b send_deflated_token</span><br><span class="line">(gdb) b init_set_compression</span><br><span class="line"></span><br><span class="line"><span class="comment">#found the no compress suffix name</span></span><br><span class="line">(gdb) bt full</span><br><span class="line"><span class="comment">#0  init_set_compression () at token.c:125</span></span><br><span class="line">        f = 0x44e258 <span class="string">&quot;*.gz *.zip *.z *.rpm *.deb *.iso *.bz2 *.t[gb]z *.7z *.mp[34] *.mov *.avi *.ogg *.jpg *.jpeg&quot;</span></span><br><span class="line"></span><br><span class="line">loadparm.c:63</span><br><span class="line"><span class="comment">#define DEFAULT_DONT_COMPRESS &quot;*.gz *.zip *.z *.rpm *.deb *.iso *.bz2&quot; \</span></span><br><span class="line">        <span class="string">&quot; *.t[gb]z *.7z *.mp[34] *.mov *.avi *.ogg *.jpg *.jpeg&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#default rsync version is 3.1.2</span></span><br><span class="line">$ <span class="built_in">rm</span> -f linux-5.4.121-1.tar.gz ; gdb --args rsync -zP linux-5.4.121.tar.gz linux-5.4.121-2.tar.gz</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /usr/bin/rsync...Reading symbols from /usr/lib/debug/usr/bin/rsync.debug...done.</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">(gdb) b trees.c:908</span><br><span class="line">Breakpoint 1 at 0x565c0: file zlib/trees.c, line 908.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /usr/bin/rsync -zP linux-5.4.121.tar.gz linux-5.4.121-2.tar.gz</span><br><span class="line">[Detaching after fork from child process 36449]</span><br><span class="line">linux-5.4.121.tar.gz</span><br><span class="line">         32,768   0%    0.00kB/s    0:00:00</span><br><span class="line">Breakpoint 1, _tr_flush_block (s=0x5555557df640, buf=0x55555580f4d0 <span class="string">&quot;linux-5.4.121/&quot;</span>, stored_len=53256, last=0) at zlib/trees.c:912</span><br><span class="line">912     &#123;</span><br><span class="line"></span><br><span class="line">(gdb) p *s</span><br><span class="line">or</span><br><span class="line">(gdb) p *((struct internal_state *) s)</span><br><span class="line"><span class="variable">$2</span> = &#123;strm = 0x5555557da7c0 &lt;tx_strm&gt;, status = 113, pending_buf = 0x55555583f500 <span class="string">&quot;&quot;</span>, pending_buf_size = 65536, pending_out = 0x55555583f500 <span class="string">&quot;&quot;</span>, pending = 0, wrap = 0,</span><br><span class="line">  gzhead = 0x0, gzindex = 0, method = 8 <span class="string">&#x27;\b&#x27;</span>, last_flush = 0, w_size = 32768, w_bits = 15, w_mask = 32767, window = 0x55555580f4d0 <span class="string">&quot;linux-5.4.121/&quot;</span>, window_size = 65536,</span><br><span class="line">  prev = 0x55555581f4e0, <span class="built_in">head</span> = 0x55555582f4f0, ins_h = 8135, hash_size = 32768, hash_bits = 15, hash_mask = 32767, hash_shift = 5, block_start = 0, match_length = 2,</span><br><span class="line">  prev_match = 53234, match_available = 0, strstart = 53256, match_start = 53234, lookahead = 12280, prev_length = 0, max_chain_length = 128, max_lazy_match = 16,</span><br><span class="line">  level = 6</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="comment">#print offset</span></span><br><span class="line">(gdb) p &amp;((struct internal_state *)0)-&gt;level</span><br><span class="line"><span class="variable">$3</span> = (int *) 0xb4</span><br><span class="line">oxb4=180</span><br><span class="line"></span><br><span class="line">(gdb) x/181x s</span><br><span class="line">0x5555557df640: 0xc0    0xa7    0x7d    0x55    0x55    0x55    0x00    0x00</span><br><span class="line">0x5555557df648: 0x71    0x00    0x00    0x00    0xff    0x7f    0x00    0x00</span><br><span class="line">0x5555557df650: 0x00    0xf5    0x83    0x55    0x55    0x55    0x00    0x00</span><br><span class="line">0x5555557df658: 0x00    0x00    0x01    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x5555557df660: 0x00    0xf5    0x83    0x55    0x55    0x55    0x00    0x00</span><br><span class="line">0x5555557df668: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x5555557df670: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x5555557df678: 0x00    0x00    0x00    0x00    0x08    0x00    0x00    0x00</span><br><span class="line">0x5555557df680: 0x00    0x00    0x00    0x00    0x00    0x80    0x00    0x00</span><br><span class="line">0x5555557df688: 0x0f    0x00    0x00    0x00    0xff    0x7f    0x00    0x00</span><br><span class="line">0x5555557df690: 0xd0    0xf4    0x80    0x55    0x55    0x55    0x00    0x00</span><br><span class="line">0x5555557df698: 0x00    0x00    0x01    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x5555557df6a0: 0xe0    0xf4    0x81    0x55    0x55    0x55    0x00    0x00</span><br><span class="line">0x5555557df6a8: 0xf0    0xf4    0x82    0x55    0x55    0x55    0x00    0x00</span><br><span class="line">0x5555557df6b0: 0xc7    0x1f    0x00    0x00    0x00    0x80    0x00    0x00</span><br><span class="line">0x5555557df6b8: 0x0f    0x00    0x00    0x00    0xff    0x7f    0x00    0x00</span><br><span class="line">0x5555557df6c0: 0x05    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x5555557df6c8: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00</span><br><span class="line">0x5555557df6d0: 0x02    0x00    0x00    0x00    0xf2    0xcf    0x00    0x00</span><br><span class="line">0x5555557df6d8: 0x00    0x00    0x00    0x00    0x08    0xd0    0x00    0x00</span><br><span class="line">0x5555557df6e0: 0xf2    0xcf    0x00    0x00    0xf8    0x2f    0x00    0x00</span><br><span class="line">0x5555557df6e8: 0x00    0x00    0x00    0x00    0x80    0x00    0x00    0x00</span><br><span class="line">0x5555557df6f0: 0x10    0x00    0x00    0x00    0x06</span><br><span class="line">                                                ^</span><br><span class="line">                                                |</span><br><span class="line">------------------------------------------------- level=6</span><br></pre></td></tr></table></figure>

<h4 id="example7-gen-the-debuginfo"><a href="#example7-gen-the-debuginfo" class="headerlink" title="example7 gen the debuginfo"></a>example7 <a target="_blank" rel="noopener" href="http://www.lenky.info/archives/2013/04/2261">gen the debuginfo</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cat t.c </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$ objcopy --only-keep-debug t t.debuginfo</span><br><span class="line">or</span><br><span class="line">$ objcopy --only-keep-debug vmlinux.bin vmlinux.debug</span><br><span class="line"></span><br><span class="line">$ objcopy --strip-debug t</span><br><span class="line">$ objcopy --add-gnu-debuglink=t.debuginfo t ##<span class="meta"># add the .gnu_debuglink section</span></span><br><span class="line">or </span><br><span class="line">$ cp t t.debuginfo</span><br><span class="line">$ strip --only-keep-debug t.debuginfo</span><br><span class="line"><span class="meta">#stripe will delete the symtab</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> </span><br><span class="line">scriptdir=`<span class="built_in">dirname</span> <span class="variable">$&#123;0&#125;</span>`</span><br><span class="line">scriptdir=`(<span class="built_in">cd</span> <span class="variable">$&#123;scriptdir&#125;</span>; <span class="built_in">pwd</span>)`</span><br><span class="line">scriptname=`<span class="built_in">basename</span> <span class="variable">$&#123;0&#125;</span>`</span><br><span class="line"> </span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">errorexit</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  errorcode=<span class="variable">$&#123;1&#125;</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$@</span></span><br><span class="line">  <span class="built_in">exit</span> <span class="variable">$&#123;errorcode&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;USAGE <span class="variable">$&#123;scriptname&#125;</span> &lt;tostrip&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">tostripdir=`<span class="built_in">dirname</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>`</span><br><span class="line">tostripfile=`<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>`</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;tostripfile&#125;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  usage</span><br><span class="line">  errorexit 0 <span class="string">&quot;tostrip must be specified&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;tostripdir&#125;</span>&quot;</span></span><br><span class="line"> </span><br><span class="line">debugdir=.debug</span><br><span class="line">debugfile=<span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>.debug&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;creating dir <span class="variable">$&#123;tostripdir&#125;</span>/<span class="variable">$&#123;debugdir&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stripping <span class="variable">$&#123;tostripfile&#125;</span>, putting debug info into <span class="variable">$&#123;debugfile&#125;</span>&quot;</span></span><br><span class="line">objcopy --only-keep-debug <span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>/<span class="variable">$&#123;debugfile&#125;</span>&quot;</span></span><br><span class="line">strip --strip-debug --strip-unneeded <span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>&quot;</span></span><br><span class="line">objcopy --add-gnu-debuglink=<span class="string">&quot;<span class="variable">$&#123;debugdir&#125;</span>/<span class="variable">$&#123;debugfile&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;tostripfile&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">$ ./cdbi.sh t</span><br><span class="line">$ <span class="built_in">ls</span> -l .debug/</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb import the debuginfo, copy to the same dir</span></span><br><span class="line">$ <span class="built_in">cp</span> -a .debug/ /tmp/</span><br><span class="line">$ <span class="built_in">cp</span> -a t /tmp/</span><br><span class="line">or </span><br><span class="line">$ <span class="built_in">cp</span> -a t.debug /tmp/</span><br><span class="line">$ <span class="built_in">cp</span> -a t /tmp/</span><br><span class="line">or</span><br><span class="line">gdb -s .debug/t.debug -e /tmp/t -q</span><br><span class="line">or</span><br><span class="line"><span class="built_in">set</span> debug-file-directory directories</span><br></pre></td></tr></table></figure>

<h5 id="build-linux-kernel-module-with-debuginfo"><a href="#build-linux-kernel-module-with-debuginfo" class="headerlink" title="build linux kernel module with debuginfo"></a>build linux kernel module with debuginfo</h5><p>Don ‘t add -g or -ggdb3 flag for compile third-part kernel module</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">$ cat kbleds.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  * kbleds.c - Blink keyboard leds until the module is unloaded.</span></span><br><span class="line"><span class="comment"> *   */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kd.h&gt;</span> <span class="comment">/* For KDSETLED */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/tty.h&gt;</span> <span class="comment">/* For tty_struct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vt.h&gt;</span> <span class="comment">/* For MAX_NR_CONSOLES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/vt_kern.h&gt;</span> <span class="comment">/* for fg_console */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/console_struct.h&gt;</span> <span class="comment">/* For vc_cons */</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Example module illustrating the use of Keyboard LEDs.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> rday_1;</span><br><span class="line"><span class="type">int</span> rday_2 = <span class="number">20</span>;</span><br><span class="line"><span class="type">int</span> rday_3 = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">my_timer</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">my_driver</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> kbledstatus = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLINK_DELAY HZ / 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALL_LEDS_ON 0x07</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESTORE_LEDS 0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function my_timer_func blinks the keyboard LEDs periodically by invoking</span></span><br><span class="line"><span class="comment"> *  * command KDSETLED of ioctl() on the keyboard driver. To learn more on virtual</span></span><br><span class="line"><span class="comment"> *   * terminal ioctl operations, please see file:</span></span><br><span class="line"><span class="comment"> *    *   drivers/tty/vt/vt_ioctl.c, function vt_ioctl().</span></span><br><span class="line"><span class="comment"> *     *</span></span><br><span class="line"><span class="comment"> *      * The argument to KDSETLED is alternatively set to 7 (thus causing the led</span></span><br><span class="line"><span class="comment"> *       * mode to be set to LED_SHOW_IOCTL, and all the leds are lit) and to 0xFF</span></span><br><span class="line"><span class="comment"> *        * (any value above 7 switches back the led mode to LED_SHOW_FLAGS, thus</span></span><br><span class="line"><span class="comment"> *         * the LEDs reflect the actual keyboard status).  To learn more on this,</span></span><br><span class="line"><span class="comment"> *          * please see file: drivers/tty/vt/keyboard.c, function setledstate().</span></span><br><span class="line"><span class="comment"> *           */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">my_timer_func</span><span class="params">(<span class="keyword">struct</span> timer_list *unused)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">t</span> =</span> vc_cons[fg_console].d-&gt;port.tty;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kbledstatus == ALL_LEDS_ON)</span><br><span class="line">        kbledstatus = RESTORE_LEDS;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        kbledstatus = ALL_LEDS_ON;</span><br><span class="line"></span><br><span class="line">    (my_driver-&gt;ops-&gt;ioctl)(t, KDSETLED, kbledstatus);</span><br><span class="line"></span><br><span class="line">    my_timer.expires = jiffies + BLINK_DELAY;</span><br><span class="line">    add_timer(&amp;my_timer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">kbleds_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;kbleds: loading\n&quot;</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;kbleds: fgconsole is %x\n&quot;</span>, fg_console);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_NR_CONSOLES; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!vc_cons[i].d)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        pr_info(<span class="string">&quot;poet_atkm: console[%i/%i] #%i, tty %p\n&quot;</span>, i, MAX_NR_CONSOLES,</span><br><span class="line">                vc_cons[i].d-&gt;vc_num, (<span class="type">void</span> *)vc_cons[i].d-&gt;port.tty);</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;kbleds: finished scanning consoles\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    my_driver = vc_cons[fg_console].d-&gt;port.tty-&gt;driver;</span><br><span class="line">    pr_info(<span class="string">&quot;kbleds: tty driver magic %x\n&quot;</span>, my_driver-&gt;magic);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up the LED blink timer the first time. */</span></span><br><span class="line">    timer_setup(&amp;my_timer, my_timer_func, <span class="number">0</span>);</span><br><span class="line">    my_timer.expires = jiffies + BLINK_DELAY;</span><br><span class="line">    add_timer(&amp;my_timer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">kbleds_cleanup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    pr_info(<span class="string">&quot;kbleds: unloading...\n&quot;</span>);</span><br><span class="line">    del_timer(&amp;my_timer);</span><br><span class="line">    (my_driver-&gt;ops-&gt;ioctl)(vc_cons[fg_console].d-&gt;port.tty, KDSETLED,</span><br><span class="line">                            RESTORE_LEDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(kbleds_init);</span><br><span class="line">module_exit(kbleds_cleanup);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//there is no .text section when the kenrel module loading</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> Makefile</span><br><span class="line"><span class="comment"># obj-m specifie we&#x27;re a kernel module.</span></span><br><span class="line">obj-m += test_kmod1.o</span><br><span class="line"><span class="comment"># Set the path to the Kernel build utils.</span></span><br><span class="line">KBUILD=/lib/modules/$(shell <span class="built_in">uname</span> -r)/build/</span><br><span class="line"><span class="comment">#MY_CFLAGS += -ggdb3 ######## Does kernel module need it ? </span></span><br><span class="line"><span class="comment">#ccflags-y += $&#123;MY_CFLAGS&#125;</span></span><br><span class="line"><span class="comment">#CC += $&#123;MY_CFLAGS&#125;</span></span><br><span class="line"> </span><br><span class="line">default:</span><br><span class="line">        $(MAKE) -C $(KBUILD) M=$(PWD) modules</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">        $(MAKE) -C $(KBUILD) M=$(PWD) clean</span><br><span class="line"></span><br><span class="line">menuconfig:</span><br><span class="line">        $(MAKE) -C $(KBUILD) M=$(PWD) menuconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line">make -C /lib/modules/3.10.0-1127.el7.x86_64/build/ M=/root/kernel-module modules </span><br><span class="line">make[1]: Entering directory `/usr/src/kernels/3.10.0-1127.el7.x86_64<span class="string">&#x27;</span></span><br><span class="line"><span class="string">  CC [M]  /root/kernel-module/greeter.o</span></span><br><span class="line"><span class="string">  Building modules, stage 2.</span></span><br><span class="line"><span class="string">  MODPOST 1 modules</span></span><br><span class="line"><span class="string">  CC      /root/kernel-module/greeter.mod.o</span></span><br><span class="line"><span class="string">  LD [M]  /root/kernel-module/greeter.ko</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `/usr/src/kernels/3.10.0-1127.el7.x86_64&#x27;</span></span><br><span class="line"></span><br><span class="line">$ insmod kbleds.ko</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /sys/module/kbleds/sections/; <span class="built_in">cat</span> .text .bss .data</span><br><span class="line">0xffffffffc05c7000</span><br><span class="line">0xffffffffc05c9260</span><br><span class="line">0xffffffffc05c9000</span><br><span class="line"></span><br><span class="line">$ gdb /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/vmlinux /proc/kcore</span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-redhat-linux-gnu&quot;</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /usr/lib/debug/usr/lib/modules/3.10.0-1127.el7.x86_64/vmlinux...done.</span><br><span class="line">[New process 1]</span><br><span class="line">Core was generated by `BOOT_IMAGE=/boot/vmlinuz-3.10.0-1127.el7.x86_64 root=UUID=8035d79a-5216-45db-bae<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">#0  0x0000000000000000 in irq_stack_union ()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                                        (.text)                     (.data)                 (.bss)</span></span><br><span class="line"><span class="string">(gdb)  add-symbol-file ./kbleds.ko 0xffffffffc05c7000 -s .data 0xffffffffc05c9000 -s .bss 0xffffffffc05c9260</span></span><br><span class="line"><span class="string">add symbol table from file &quot;./kbleds.ko&quot; at</span></span><br><span class="line"><span class="string">        .text_addr = 0xffffffffc05c7000</span></span><br><span class="line"><span class="string">        .data_addr = 0xffffffffc05c9000</span></span><br><span class="line"><span class="string">        .bss_addr = 0xffffffffc05c9260</span></span><br><span class="line"><span class="string">(y or n) y</span></span><br><span class="line"><span class="string">Reading symbols from /root/kernel-module/kbleds.ko...done.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) p rday_2  ## print the variable</span></span><br><span class="line"><span class="string">$1 = 20</span></span><br><span class="line"><span class="string">(gdb) p rday_3</span></span><br><span class="line"><span class="string">$2 = 30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ nm kbleds.ko </span></span><br><span class="line"><span class="string">                 U add_timer</span></span><br><span class="line"><span class="string">0000000000000000 T cleanup_module</span></span><br><span class="line"><span class="string">                 U del_timer</span></span><br><span class="line"><span class="string">                 U __fentry__</span></span><br><span class="line"><span class="string">                 U fg_console</span></span><br><span class="line"><span class="string">0000000000000000 T init_module</span></span><br><span class="line"><span class="string">                 U init_timer_key</span></span><br><span class="line"><span class="string">                 U jiffies</span></span><br><span class="line"><span class="string">0000000000000000 t kbleds_cleanup</span></span><br><span class="line"><span class="string">0000000000000000 t kbleds_init</span></span><br><span class="line"><span class="string">0000000000000008 b kbledstatus</span></span><br><span class="line"><span class="string">000000000000008d r __module_depends</span></span><br><span class="line"><span class="string">0000000000000010 b my_driver</span></span><br><span class="line"><span class="string">0000000000000020 b my_timer</span></span><br><span class="line"><span class="string">0000000000000000 t my_timer_func</span></span><br><span class="line"><span class="string">                 U printk</span></span><br><span class="line"><span class="string">0000000000000000 B rday_1</span></span><br><span class="line"><span class="string">0000000000000004 D rday_2</span></span><br><span class="line"><span class="string">0000000000000000 D rday_3</span></span><br><span class="line"><span class="string">0000000000000000 D __this_module</span></span><br><span class="line"><span class="string">000000000000000c r __UNIQUE_ID_description25</span></span><br><span class="line"><span class="string">0000000000000000 r __UNIQUE_ID_license26</span></span><br><span class="line"><span class="string">000000000000004e r __UNIQUE_ID_retpoline11</span></span><br><span class="line"><span class="string">000000000000005a r __UNIQUE_ID_rhelversion10</span></span><br><span class="line"><span class="string">000000000000006a r __UNIQUE_ID_srcversion9</span></span><br><span class="line"><span class="string">0000000000000096 r __UNIQUE_ID_vermagic8</span></span><br><span class="line"><span class="string">                 U vc_cons</span></span><br><span class="line"><span class="string">0000000000000000 r ____versions</span></span><br><span class="line"><span class="string">                 U __x86_indirect_thunk_rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ $ objdump -t kbleds.ko  # all section</span></span><br><span class="line"><span class="string">kbleds.ko:     file format elf64-x86-64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SYMBOL TABLE:</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .note.gnu.build-id     0000000000000000 .note.gnu.build-id</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .text  0000000000000000 .text</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .init.text     0000000000000000 .init.text</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .exit.text     0000000000000000 .exit.text</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .rodata.str1.1 0000000000000000 .rodata.str1.1</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .rodata.str1.8 0000000000000000 .rodata.str1.8</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .modinfo       0000000000000000 .modinfo</span></span><br><span class="line"><span class="string">0000000000000000 l    d  __mcount_loc   0000000000000000 __mcount_loc</span></span><br><span class="line"><span class="string">0000000000000000 l    d  __versions     0000000000000000 __versions</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .data  0000000000000000 .data</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .gnu.linkonce.this_module      0000000000000000 .gnu.linkonce.this_module</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .bss   0000000000000000 .bss</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_info    0000000000000000 .debug_info</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_abbrev  0000000000000000 .debug_abbrev</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_loc     0000000000000000 .debug_loc</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_aranges 0000000000000000 .debug_aranges</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_ranges  0000000000000000 .debug_ranges</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_line    0000000000000000 .debug_line</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_str     0000000000000000 .debug_str</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .comment       0000000000000000 .comment</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .note.GNU-stack        0000000000000000 .note.GNU-stack</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .debug_frame   0000000000000000 .debug_frame</span></span><br><span class="line"><span class="string">0000000000000000 l    df *ABS*  0000000000000000 kbleds.c</span></span><br><span class="line"><span class="string">0000000000000000 l     F .text  0000000000000092 my_timer_func</span></span><br><span class="line"><span class="string">0000000000000008 l     O .bss   0000000000000008 kbledstatus</span></span><br><span class="line"><span class="string">0000000000000010 l     O .bss   0000000000000008 my_driver</span></span><br><span class="line"><span class="string">0000000000000020 l     O .bss   0000000000000050 my_timer</span></span><br><span class="line"><span class="string">0000000000000000 l     F .init.text     00000000000000ee kbleds_init</span></span><br><span class="line"><span class="string">0000000000000000 l     F .exit.text     0000000000000057 kbleds_cleanup</span></span><br><span class="line"><span class="string">0000000000000000 l     O .modinfo       000000000000000c __UNIQUE_ID_license26</span></span><br><span class="line"><span class="string">000000000000000c l     O .modinfo       0000000000000042 __UNIQUE_ID_description25</span></span><br><span class="line"><span class="string">0000000000000000 l    df *ABS*  0000000000000000 kbleds.mod.c</span></span><br><span class="line"><span class="string">000000000000004e l     O .modinfo       000000000000000c __UNIQUE_ID_retpoline11</span></span><br><span class="line"><span class="string">000000000000005a l     O .modinfo       0000000000000010 __UNIQUE_ID_rhelversion10</span></span><br><span class="line"><span class="string">000000000000006a l     O .modinfo       0000000000000023 __UNIQUE_ID_srcversion9</span></span><br><span class="line"><span class="string">000000000000008d l     O .modinfo       0000000000000009 __module_depends</span></span><br><span class="line"><span class="string">0000000000000000 l     O __versions     0000000000000280 ____versions</span></span><br><span class="line"><span class="string">0000000000000096 l     O .modinfo       000000000000003c __UNIQUE_ID_vermagic8</span></span><br><span class="line"><span class="string">0000000000000000 g     O .gnu.linkonce.this_module      0000000000000238 __this_module</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 fg_console</span></span><br><span class="line"><span class="string">0000000000000000 g     F .exit.text     0000000000000057 cleanup_module</span></span><br><span class="line"><span class="string">0000000000000000 g     O .data  0000000000000004 rday_3</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 __fentry__</span></span><br><span class="line"><span class="string">0000000000000000 g     F .init.text     00000000000000ee init_module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 __x86_indirect_thunk_rax</span></span><br><span class="line"><span class="string">0000000000000004 g     O .data  0000000000000004 rday_2</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 add_timer</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 printk</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 vc_cons</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 jiffies</span></span><br><span class="line"><span class="string">0000000000000000 g     O .bss   0000000000000004 rday_1</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 init_timer_key</span></span><br><span class="line"><span class="string">0000000000000000         *UND*  0000000000000000 del_timer</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ objdump -t -j .text kbleds.ko</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kbleds.ko:     file format elf64-x86-64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SYMBOL TABLE:</span></span><br><span class="line"><span class="string">0000000000000000 l    d  .text  0000000000000000 .text</span></span><br><span class="line"><span class="string">0000000000000000 l     F .text  0000000000000092 my_timer_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ objdump -t -j .bss greeter.ko </span></span><br><span class="line"><span class="string">$ objdump -t -j .data greeter.ko </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grep -E &#x27;</span>kbledstatus|rday<span class="string">&#x27; /proc/kallsyms</span></span><br><span class="line"><span class="string">ffffffffc05c9268 b kbledstatus  [kbleds]</span></span><br><span class="line"><span class="string">ffffffffc05c9000 d rday_3       [kbleds]</span></span><br><span class="line"><span class="string">ffffffffc05c9004 d rday_2       [kbleds]</span></span><br><span class="line"><span class="string">ffffffffc05c9260 b rday_1       [kbleds]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">reference: https://www.linux.com/training-tutorials/kernel-newbie-corner-kernel-and-module-debugging-gdb/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -WS kbleds.ko | grep &#x27;</span>.text<span class="string">&#x27;</span></span><br><span class="line"><span class="string">  [ 2] .text             PROGBITS        0000000000000000 000070 000092 00  AX  0   0 16</span></span><br><span class="line"><span class="string">  [ 3] .rela.text        RELA            0000000000000000 01c960 000120 18   I 34   2  8</span></span><br><span class="line"><span class="string">  [ 4] .init.text        PROGBITS        0000000000000000 000102 0000ee 00  AX  0   0  1</span></span><br><span class="line"><span class="string">  [ 5] .rela.init.text   RELA            0000000000000000 01ca80 000258 18   I 34   4  8</span></span><br><span class="line"><span class="string">  [ 6] .exit.text        PROGBITS        0000000000000000 0001f0 000057 00  AX  0   0  1</span></span><br><span class="line"><span class="string">  [ 7] .rela.exit.text   RELA            0000000000000000 01ccd8 0000c0 18   I 34   6  8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -x .text kbleds.ko </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Hex dump of section &#x27;</span>.text<span class="string">&#x27;:</span></span><br><span class="line"><span class="string"> NOTE: This section has relocations against it, but these have NOT been applied to this dump.</span></span><br><span class="line"><span class="string">  0x00000000 e8000000 00486305 00000000 48833d00 .....Hc.....H.=.</span></span><br><span class="line"><span class="string">  0x00000010 00000007 554889e5 488d0480 488b04c5 ....UH..H...H...</span></span><br><span class="line"><span class="string">  0x00000020 00000000 488b7848 745648c7 05000000 ....H.xHtVH.....</span></span><br><span class="line"><span class="string">  0x00000030 00070000 00ba0700 0000488b 05000000 ..........H.....</span></span><br><span class="line"><span class="string">  0x00000040 00be324b 0000488b 80a00000 00488b40 ..2K..H......H.@</span></span><br><span class="line"><span class="string">  0x00000050 60e80000 0000488b 05000000 0048c7c7 `.....H......H..</span></span><br><span class="line"><span class="string">  0x00000060 00000000 4805c800 00004889 05000000 ....H.....H.....</span></span><br><span class="line"><span class="string">  0x00000070 00e80000 00005dc3 0f1f8400 00000000 ......].........</span></span><br><span class="line"><span class="string">  0x00000080 48c70500 000000ff 000000ba ff000000 H...............</span></span><br><span class="line"><span class="string">  0x00000090 eba8                                ..</span></span><br><span class="line"><span class="string">or</span></span><br><span class="line"><span class="string"># To a file:</span></span><br><span class="line"><span class="string">objcopy file /dev/null --dump-section .text=text.data</span></span><br><span class="line"><span class="string"># To stdout:</span></span><br><span class="line"><span class="string">objcopy file /dev/null --dump-section .text=/dev/stdout | cat</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf -S kbleds.ko</span></span><br><span class="line"><span class="string">There are 37 section headers, starting at offset 0x334f0:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Section Headers:</span></span><br><span class="line"><span class="string">  [Nr] Name              Type             Address           Offset</span></span><br><span class="line"><span class="string">       Size              EntSize          Flags  Link  Info  Align</span></span><br><span class="line"><span class="string">  [ 0]                   NULL             0000000000000000  00000000</span></span><br><span class="line"><span class="string">       0000000000000000  0000000000000000           0     0     0</span></span><br><span class="line"><span class="string">  [ 1] .note.gnu.build-i NOTE             0000000000000000  00000040</span></span><br><span class="line"><span class="string">       0000000000000024  0000000000000000   A       0     0     4</span></span><br><span class="line"><span class="string">  [ 2] .text             PROGBITS         0000000000000000  00000070</span></span><br><span class="line"><span class="string">       0000000000000092  0000000000000000  AX       0     0     16</span></span><br><span class="line"><span class="string">  [ 3] .rela.text        RELA             0000000000000000  0001c960</span></span><br><span class="line"><span class="string">       0000000000000120  0000000000000018   I      34     2     8</span></span><br><span class="line"><span class="string">  [ 4] .init.text        PROGBITS         0000000000000000  00000102</span></span><br><span class="line"><span class="string">       00000000000000ee  0000000000000000  AX       0     0     1</span></span><br><span class="line"><span class="string">  [ 5] .rela.init.text   RELA             0000000000000000  0001ca80</span></span><br><span class="line"><span class="string">       0000000000000258  0000000000000018   I      34     4     8</span></span><br><span class="line"><span class="string">  [ 6] .exit.text        PROGBITS         0000000000000000  000001f0</span></span><br><span class="line"><span class="string">       0000000000000057  0000000000000000  AX       0     0     1</span></span><br><span class="line"><span class="string">  [ 7] .rela.exit.text   RELA             0000000000000000  0001ccd8</span></span><br><span class="line"><span class="string">       00000000000000c0  0000000000000018   I      34     6     8</span></span><br><span class="line"><span class="string">  [ 8] .rodata.str1.1    PROGBITS         0000000000000000  00000247</span></span><br><span class="line"><span class="string">       0000000000000046  0000000000000001 AMS       0     0     1</span></span><br><span class="line"><span class="string">  [ 9] .rodata.str1.8    PROGBITS         0000000000000000  00000290</span></span><br><span class="line"><span class="string">       0000000000000071  0000000000000001 AMS       0     0     8</span></span><br><span class="line"><span class="string">  [10] .modinfo          PROGBITS         0000000000000000  00000301</span></span><br><span class="line"><span class="string">       00000000000000d2  0000000000000000   A       0     0     1</span></span><br><span class="line"><span class="string">  [11] __mcount_loc      PROGBITS         0000000000000000  000003d8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ readelf  -r kbleds.ko</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Relocation section &#x27;</span>.rela.text<span class="string">&#x27; at offset 0x1c960 contains 12 entries:</span></span><br><span class="line"><span class="string">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span><br><span class="line"><span class="string">000000000001  002b00000002 R_X86_64_PC32     0000000000000000 __fentry__ - 4</span></span><br><span class="line"><span class="string">000000000008  002800000002 R_X86_64_PC32     0000000000000000 fg_console - 4</span></span><br><span class="line"><span class="string">00000000000f  000c00000002 R_X86_64_PC32     0000000000000000 .bss + 3</span></span><br><span class="line"><span class="string">000000000020  00310000000b R_X86_64_32S      0000000000000000 vc_cons + 0</span></span><br><span class="line"><span class="string">00000000002d  000c00000002 R_X86_64_PC32     0000000000000000 .bss + 0</span></span><br><span class="line"><span class="string">00000000003d  000c00000002 R_X86_64_PC32     0000000000000000 .bss + c</span></span><br><span class="line"><span class="string">000000000052  002d00000002 R_X86_64_PC32     0000000000000000 __x86_indirect_thunk_r - 4</span></span><br><span class="line"><span class="string">000000000059  003200000002 R_X86_64_PC32     0000000000000000 jiffies - 4</span></span><br><span class="line"><span class="string">000000000060  000c0000000b R_X86_64_32S      0000000000000000 .bss + 20</span></span><br><span class="line"><span class="string">00000000006d  000c00000002 R_X86_64_PC32     0000000000000000 .bss + 2c</span></span><br><span class="line"><span class="string">000000000072  002f00000002 R_X86_64_PC32     0000000000000000 add_timer - 4</span></span><br><span class="line"><span class="string">000000000083  000c00000002 R_X86_64_PC32     0000000000000000 .bss + 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Relocation section &#x27;</span>.rela.init.text<span class="string">&#x27; at offset 0x1ca80 contains 25 entries:</span></span><br><span class="line"><span class="string">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span></span><br><span class="line"><span class="string">000000000004  00050000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + 0</span></span><br><span class="line"><span class="string">000000000011  003000000002 R_X86_64_PC32     0000000000000000 printk - 4</span></span><br><span class="line"><span class="string">000000000017  002800000002 R_X86_64_PC32     0000000000000000 fg_console - 4</span></span><br><span class="line"><span class="string">00000000001e  00050000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + 13</span></span><br><span class="line"><span class="string">000000000025  003000000002 R_X86_64_PC32     0000000000000000 printk - 4</span></span><br><span class="line"><span class="string">000000000030  00310000000b R_X86_64_32S      0000000000000000 vc_cons + 0</span></span><br><span class="line"><span class="string">000000000050  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.8 + 48</span></span><br><span class="line"><span class="string">000000000058  003000000002 R_X86_64_PC32     0000000000000000 printk - 4</span></span><br></pre></td></tr></table></figure>
<h3 id="Enable-ptrace-permissions"><a href="#Enable-ptrace-permissions" class="headerlink" title="Enable ptrace permissions"></a>Enable ptrace permissions</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/sysctl.d/10-ptrace.conf</span><br><span class="line">kernel.yama.ptrace_scope = 0</span><br><span class="line"></span><br><span class="line">0 - classic ptrace permissions: a process can PTRACE_ATTACH to any other</span><br><span class="line">    process running under the same uid, as long as it is dumpable (i.e.</span><br><span class="line">    did not transition uids, start privileged, or have called</span><br><span class="line">    prctl(PR_SET_DUMPABLE...) already). Similarly, PTRACE_TRACEME is</span><br><span class="line">    unchanged.</span><br><span class="line"></span><br><span class="line">1 - restricted ptrace: a process must have a predefined relationship</span><br><span class="line">    with the inferior it wants to call PTRACE_ATTACH on. By default,</span><br><span class="line">    this relationship is that of only its descendants when the above</span><br><span class="line">    classic criteria is also met. To change the relationship, an</span><br><span class="line">    inferior can call prctl(PR_SET_PTRACER, debugger, ...) to <span class="built_in">declare</span></span><br><span class="line">    an allowed debugger PID to call PTRACE_ATTACH on the inferior.</span><br><span class="line">    Using PTRACE_TRACEME is unchanged.</span><br><span class="line"></span><br><span class="line">2 - admin-only attach: only processes with CAP_SYS_PTRACE may use ptrace</span><br><span class="line">    with PTRACE_ATTACH, or through children calling PTRACE_TRACEME.</span><br><span class="line"></span><br><span class="line">3 - no attach: no processes may use ptrace with PTRACE_ATTACH nor via</span><br><span class="line">    PTRACE_TRACEME. Once <span class="built_in">set</span>, this sysctl value cannot be changed.</span><br></pre></td></tr></table></figure>


<h3 id="Core-signal"><a href="#Core-signal" class="headerlink" title="Core signal"></a>Core signal</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">  Standard signals</span><br><span class="line">       Linux supports the standard signals listed below.  Several signal  numbers  are  architecture-dependent,  as</span><br><span class="line">       indicated  <span class="keyword">in</span>  the  <span class="string">&quot;Value&quot;</span> column.  (Where three values are given, the first one is usually valid <span class="keyword">for</span> alpha</span><br><span class="line">       and sparc, the middle one <span class="keyword">for</span> x86, arm, and most other architectures, and the last one  <span class="keyword">for</span>  mips.   (Values</span><br><span class="line">       <span class="keyword">for</span>  parisc  are  not shown; see the Linux kernel <span class="built_in">source</span> <span class="keyword">for</span> signal numbering on that architecture.)  A dash</span><br><span class="line">       (-) denotes that a signal is absent on the corresponding architecture.</span><br><span class="line"></span><br><span class="line">       First the signals described <span class="keyword">in</span> the original POSIX.1-1990 standard.</span><br><span class="line"></span><br><span class="line">       Signal     Value     Action   Comment</span><br><span class="line">       ──────────────────────────────────────────────────────────────────────</span><br><span class="line">       SIGQUIT       3       Core    Quit from keyboard</span><br><span class="line">       SIGILL        4       Core    Illegal Instruction</span><br><span class="line">       SIGABRT       6       Core    Abort signal from abort(3)</span><br><span class="line">       SIGFPE        8       Core    Floating-point exception</span><br><span class="line">       SIGSEGV      11       Core    Invalid memory reference</span><br><span class="line"></span><br><span class="line">       The signals SIGKILL and SIGSTOP cannot be caught, blocked, or ignored.</span><br><span class="line"></span><br><span class="line">       Next the signals not <span class="keyword">in</span> the POSIX.1-1990 standard but described <span class="keyword">in</span> SUSv2 and POSIX.1-2001.</span><br><span class="line"></span><br><span class="line">       Signal       Value     Action   Comment</span><br><span class="line">       ────────────────────────────────────────────────────────────────────</span><br><span class="line">       SIGBUS      10,7,10     Core    Bus error (bad memory access)</span><br><span class="line">       SIGSYS      12,31,12    Core    Bad system call (SVr4);</span><br><span class="line">                                       see also seccomp(2)</span><br><span class="line">       SIGTRAP        5        Core    Trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">       SIGXCPU     24,24,30    Core    CPU time <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">                                       see setrlimit(2)</span><br><span class="line">       SIGXFSZ     25,25,31    Core    File size <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">                                       see setrlimit(2)</span><br><span class="line">       Up to and including Linux 2.2, the default behavior <span class="keyword">for</span> SIGSYS,  SIGXCPU,  SIGXFSZ,  and  (on  architectures</span><br><span class="line">       other  than  SPARC and MIPS) SIGBUS was to terminate the process (without a core dump).  (On some other UNIX</span><br><span class="line">       systems the default action <span class="keyword">for</span> SIGXCPU and SIGXFSZ is to terminate the process without a core dump.)   Linux</span><br><span class="line">       2.4 conforms to the POSIX.1-2001 requirements <span class="keyword">for</span> these signals, terminating the process with a core dump.</span><br><span class="line"></span><br><span class="line">       Next various other signals.</span><br><span class="line"></span><br><span class="line">       Signal       Value     Action   Comment</span><br><span class="line">       ────────────────────────────────────────────────────────────────────</span><br><span class="line">       SIGIOT         6        Core    IOT <span class="built_in">trap</span>. A synonym <span class="keyword">for</span> SIGABRT</span><br><span class="line">       SIGUNUSED    -,31,-     Core    Synonymous with SIGSYS</span><br><span class="line"></span><br><span class="line">       (Signal 29 is SIGINFO / SIGPWR on an alpha but SIGLOST on a sparc.)</span><br><span class="line"></span><br><span class="line">       SIGEMT  is  not  specified  <span class="keyword">in</span>  POSIX.1-2001, but nevertheless appears on most other UNIX systems, <span class="built_in">where</span> its</span><br><span class="line">       default action is typically to terminate the process with a core dump.</span><br><span class="line"></span><br><span class="line">       SIGPWR (<span class="built_in">which</span> is not specified <span class="keyword">in</span> POSIX.1-2001) is typically ignored by default on those other UNIX  systems</span><br><span class="line">       <span class="built_in">where</span> it appears.</span><br><span class="line"></span><br><span class="line">       SIGIO (<span class="built_in">which</span> is not specified <span class="keyword">in</span> POSIX.1-2001) is ignored by default on several other UNIX systems.</span><br><span class="line"></span><br><span class="line">       Where defined, SIGUNUSED is synonymous with SIGSYS on most architectures.  Since glibc 2.26, SIGUNUSED is no</span><br><span class="line">       longer defined on any architecture.</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">kill</span> -l</span><br><span class="line"> 1) SIGHUP   2) SIGINT   3) SIGQUIT  4) SIGILL   5) SIGTRAP</span><br><span class="line"> 6) SIGABRT  7) SIGBUS   8) SIGFPE   9) SIGKILL 10) SIGUSR1</span><br><span class="line">11) SIGSEGV 12) SIGUSR2 13) SIGPIPE 14) SIGALRM 15) SIGTERM</span><br><span class="line">16) SIGSTKFLT   17) SIGCHLD 18) SIGCONT 19) SIGSTOP 20) SIGTSTP</span><br><span class="line">21) SIGTTIN 22) SIGTTOU 23) SIGURG  24) SIGXCPU 25) SIGXFSZ</span><br><span class="line">26) SIGVTALRM   27) SIGPROF 28) SIGWINCH    29) SIGIO   30) SIGPWR</span><br><span class="line">31) SIGSYS  34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3</span><br><span class="line">38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8</span><br><span class="line">43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13</span><br><span class="line">48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12</span><br><span class="line">53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7</span><br><span class="line">58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2</span><br><span class="line">63) SIGRTMAX-1  64) SIGRTMAX</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SigPnd: 0000000000000000: Signals Pending (Raised, but waiting to be acted upon potentially because they are blocked).</span><br><span class="line">SigBlk: 0000000056727a01: Signals that are blocked by the process. This can be a temporary thing. The application can be coded <span class="keyword">in</span> such a way to temporarily block a signal. The kernel will <span class="keyword">then</span> delay delivery of that signal until such time as it becomes unblocked or the signals are asked to be delivered.</span><br><span class="line">SigIgn: 0000000000381000: Signals that are ignored by the process. They are simply thrown away. (Except <span class="keyword">for</span> SIGKILL and SIGSTOP, <span class="built_in">which</span> cannot be ignored)</span><br><span class="line">SigCgt: 000000004b817efb: Signals that can be caught by the process.</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 4b817efb | xxd -r -p | xxd -b</span><br><span class="line">01001011 10000001 01111110 11111011</span><br><span class="line"> |  | || |      |  ||||||  ||||| ||</span><br><span class="line"> |  | || |      |  ||||||  ||||| |+--  1 SIGHUP (hangup)</span><br><span class="line"> |  | || |      |  ||||||  ||||| +---  2 SIGINT (interrupt)</span><br><span class="line"> |  | || |      |  ||||||  ||||+-----  4 SIGILL (illegal instruction)</span><br><span class="line"> |  | || |      |  ||||||  |||+------  5 SIGTRAP (trace/trap)</span><br><span class="line"> |  | || |      |  ||||||  ||+-------  6 SIGABRT (abort)</span><br><span class="line"> |  | || |      |  ||||||  |+--------  7 SIGEMT (emulation <span class="built_in">trap</span>)</span><br><span class="line"> |  | || |      |  ||||||  +---------  8 SIGFPE (floating point exception)</span><br><span class="line"> |  | || |      |  |||||+------------ 10 SIGBUS (bus error)</span><br><span class="line"> |  | || |      |  ||||+------------- 11 SIGSEGV (segmentation violation)</span><br><span class="line"> |  | || |      |  |||+-------------- 12 SIGSYS (bad system call)</span><br><span class="line"> |  | || |      |  ||+--------------- 13 SIGPIPE (broken pipe)</span><br><span class="line"> |  | || |      |  |+---------------- 14 SIGALRM (alarm)</span><br><span class="line"> |  | || |      |  +----------------- 15 SIGTERM (termination)</span><br><span class="line"> |  | || |      +-------------------- 17 SIGUSR2 (user signal 2)</span><br><span class="line"> |  | || +--------------------------- 24 SIGTSTP (stop -- can be ignored)</span><br><span class="line"> |  | |+----------------------------- 25 SIGCONT (<span class="built_in">continue</span>)</span><br><span class="line"> |  | +------------------------------ 26 SIGTTIN (terminal input)</span><br><span class="line"> |  +-------------------------------- 28 SIGVTALRM (timer expiration)</span><br><span class="line"> +----------------------------------- 31 SIGXFSZ (file size exceeded)</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/<span class="variable">$pid</span>/status | grep Sig</span><br><span class="line">SigQ:   6/513952</span><br><span class="line">SigPnd: 0000000000040100</span><br><span class="line">SigBlk: 0000000000000000</span><br><span class="line">SigIgn: 0000000000000000</span><br><span class="line">SigCgt: 0000000180000000</span><br></pre></td></tr></table></figure>

<h4 id="Test-SIGSEGV"><a href="#Test-SIGSEGV" class="headerlink" title="Test SIGSEGV"></a><a target="_blank" rel="noopener" href="http://blog.cuicc.com/blog/2012/09/17/core-dump-and-backtrace/">Test SIGSEGV</a></h4><ul>
<li><p>kill -11 $pid means send the SIGSEGV to trigger the segment fault</p>
</li>
<li><p>define the invaid point signal code&#x3D;128 (SI_KERNEL)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *foo = (<span class="type">int</span> *)<span class="number">-1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *foo);</span><br></pre></td></tr></table></figure>
</li>
<li><p>define the empty point and evaluation signal code&#x3D;1 (SEGV_MAPERR)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> *foo = <span class="literal">NULL</span>;</span><br><span class="line">*foo = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, *foo);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Malloc the memory and protect it (signal code&#x3D;2 (SEGV_ACCERR))</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *foo;</span><br><span class="line">posix_memalign(&amp;foo, getpagesize(), getpagesize());</span><br><span class="line"><span class="built_in">memset</span>(foo, <span class="string">&#x27;A&#x27;</span>, getpagesize());</span><br><span class="line">mprotect(foo, getpagesize(), PROT_NONE);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="gdb-cmd"><a href="#gdb-cmd" class="headerlink" title="gdb cmd"></a>gdb cmd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#break</span></span><br><span class="line"><span class="built_in">break</span> +offset</span><br><span class="line"><span class="built_in">break</span> -offset</span><br><span class="line"><span class="built_in">break</span> linenum</span><br><span class="line"><span class="built_in">break</span> filename:linenum</span><br><span class="line"><span class="built_in">break</span> func_name</span><br><span class="line"><span class="built_in">break</span> filename:func_name</span><br><span class="line"><span class="built_in">break</span> *address</span><br><span class="line"><span class="built_in">break</span> ... <span class="keyword">if</span> &lt;condition&gt;</span><br><span class="line"><span class="built_in">break</span> <span class="built_in">where</span> <span class="keyword">if</span></span><br><span class="line"></span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint 1 at 0x564b218ff830: file ./bubble_sort_bug.c, line 29.</span><br><span class="line">(gdb) b <span class="built_in">exit</span></span><br><span class="line">Breakpoint 2 at 0x7f258be23120: file exit.c, line 139.</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">1       breakpoint     keep y   0x0000564b218ff830 <span class="keyword">in</span> main at ./bubble_sort_bug.c:29</span><br><span class="line">2       breakpoint     keep y   0x00007f258be23120 <span class="keyword">in</span> __GI_exit at exit.c:139</span><br><span class="line">(gdb) i b 2</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep y   0x00007f258be23120 <span class="keyword">in</span> __GI_exit at exit.c:139</span><br><span class="line">(gdb) b main <span class="keyword">if</span> i==1</span><br><span class="line">Breakpoint 4 at 0x555555554830: file ./bubble_sort_bug.c, line 29.</span><br><span class="line"></span><br><span class="line"><span class="comment">###########################another one</span></span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">break</span> *func_b+0x23</span><br><span class="line">Breakpoint 1 at 0x804898f: file backtrace.c, line 59.</span><br><span class="line"></span><br><span class="line"><span class="comment">#display ## ultra print</span></span><br><span class="line"><span class="built_in">break</span> foo <span class="keyword">if</span> i&gt;0</span><br><span class="line">commands</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;i is %d\n&quot;</span>, i</span><br><span class="line"><span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">(gdb) until 5 <span class="comment">#&#x27;u&#x27;</span></span><br><span class="line">(gdb) skip <span class="keyword">function</span> add   <span class="comment"># step时跳过add函数</span></span><br><span class="line">(gdb) info skip   <span class="comment"># 查看skip列表</span></span><br><span class="line"></span><br><span class="line">b func_name <span class="keyword">if</span> var_name == 5</span><br><span class="line">info <span class="built_in">break</span> (i b)</span><br><span class="line">i b n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#skip function, not go to internal</span></span><br><span class="line">(gdb) next</span><br><span class="line"></span><br><span class="line"><span class="comment">#not skip, go to the function internal</span></span><br><span class="line">(gdb) step</span><br><span class="line"></span><br><span class="line"><span class="comment">#continue</span></span><br><span class="line">(gdb) <span class="built_in">continue</span></span><br><span class="line">(gdb) <span class="built_in">continue</span> 3 <span class="comment"># 跳过3个断点</span></span><br><span class="line"></span><br><span class="line">(gdb) finish <span class="comment"># like step out, finish current function</span></span><br><span class="line">   </span><br><span class="line">list linenum</span><br><span class="line">list <span class="keyword">function</span></span><br><span class="line">list filename:linenum</span><br><span class="line">list filename:<span class="keyword">function</span></span><br><span class="line">list +offset/-offset</span><br><span class="line">列出在当前行号的前面或后面的offset行附近的代码。offset为自然数。</span><br><span class="line">list +/-</span><br><span class="line">列出当前行后面或者前面的代码</span><br><span class="line">list linenum1, linenum2</span><br><span class="line">列出行linenum1和linenum2之间的代码</span><br></pre></td></tr></table></figure>
<p>info  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">info files</span><br><span class="line">显示当前的debug文件，包含程序入口地址，内存分段布局位置信息等</span><br><span class="line">info breakpoints</span><br><span class="line">显示当前设置的断点列表</span><br><span class="line">info registers</span><br><span class="line">显示当前寄存器的值，可以简写成i r。指定寄存器名称，可以查看具体寄存器信息：i r rsp</span><br><span class="line">info all-registers</span><br><span class="line">显示所有寄存器的值。GDB提供四个标准寄存器：pc是程序计数器寄存器，sp是堆栈指针。fp用于记录当前堆栈帧的指针，ps用于记录处理器状态的寄存器，GDB会处理好不同架构系统寄存器不一致问题，比如对于amd64架构，pc对应就是rip寄存器。</span><br><span class="line">引用寄存器内容是将寄存器名前置符作为变量来用。比如符作为变量来用。比如符作为变量来用。比如pc就是程序计数器寄存器值。</span><br><span class="line">info args</span><br><span class="line">显示当前函数参数</span><br><span class="line">info locals</span><br><span class="line">显示当前局部变量</span><br><span class="line">info frame</span><br><span class="line">查看当前栈帧的详细信息，包括rip信息，正在运行的指令所在文件位置</span><br><span class="line">info variables</span><br><span class="line">查看程序中的变量符号</span><br><span class="line">info <span class="built_in">functions</span></span><br><span class="line">查看程序中的函数符号</span><br><span class="line">info <span class="built_in">functions</span> regexp</span><br><span class="line">通过正则匹配来查看程序中的函数符号</span><br><span class="line">info goroutines</span><br><span class="line">显示当前执行的goroutine列表，带*的表示当前执行的。注意需要加载go runtime支持。</span><br><span class="line">info stack</span><br><span class="line">查看栈信息</span><br><span class="line">info proc mappings</span><br><span class="line">可以简写成i proc m。用来查看应用内存映射</span><br><span class="line">info proc [procid]</span><br><span class="line">显示进程信息</span><br><span class="line">info proc status</span><br><span class="line">显示进程相关信息，包括user <span class="built_in">id</span>和group <span class="built_in">id</span>；进程内有多少线程；虚拟内存的使用；挂起的信号，阻塞的信号，忽略的信号；TTY；消耗的系统和用户时间；堆栈大小；<span class="built_in">nice</span>值</span><br><span class="line">info display</span><br><span class="line"></span><br><span class="line">info watchpoints</span><br><span class="line">列出当前所设置了的所有观察点</span><br><span class="line">info line [linenum]</span><br><span class="line">查看第linenum的代码指令地址信息，不带linenum时，显示的是当前位置的指令地址信息</span><br><span class="line">info <span class="built_in">source</span></span><br><span class="line">显示此源代码的源代码语言</span><br><span class="line">info sources</span><br><span class="line">显示程序中所有有调试信息的源文件名，一共显示两个列表：一个是其符号信息已经读过的，一个是还未读取过的</span><br><span class="line">info types</span><br><span class="line">显示程序中所有类型符号</span><br><span class="line">info types regexp</span><br><span class="line">通过正则匹配来查看程序中的类型符号</span><br></pre></td></tr></table></figure>
<p>show  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">show args</span><br><span class="line">查看命令行参数</span><br><span class="line">show environment [envname]</span><br><span class="line">查看环境变量信息</span><br><span class="line">show paths</span><br><span class="line">查看程序的运行路径</span><br><span class="line">whatis var1</span><br><span class="line">显示变量var1类型</span><br><span class="line">ptype var1</span><br><span class="line">显示变量var1类型，若是var1结构体类型，会显示该结构体定义信息。</span><br><span class="line"></span><br><span class="line">(gdb) <span class="built_in">where</span></span><br><span class="line"><span class="comment">#0  _rt0_amd64 ()</span></span><br><span class="line">    at /usr/lib/go/src/runtime/asm_amd64.s:15</span><br><span class="line"><span class="comment">#1  0x0000000000000001 in ?? ()</span></span><br><span class="line"><span class="comment">#2  0x00007fffffffdd2c in ?? ()</span></span><br><span class="line"><span class="comment">#3  0x0000000000000000 in ?? ()</span></span><br><span class="line"></span><br><span class="line">(gdb) watch <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#show the assembly code</span></span><br><span class="line">(gdb) <span class="built_in">set</span> disassemble-next-line on</span><br><span class="line">(gdb) disassemble main.main</span><br><span class="line">(gdb) disas /m main.main</span><br><span class="line">(gdb) <span class="built_in">set</span> disassembly-flavor intel <span class="comment">## show the AT&amp;A to intel mode</span></span><br><span class="line"></span><br><span class="line">display &lt;<span class="built_in">expr</span>&gt;</span><br><span class="line">display /&lt;<span class="built_in">fmt</span>&gt; &lt;<span class="built_in">expr</span>&gt;</span><br><span class="line">display /&lt;<span class="built_in">fmt</span>&gt; &lt;addr&gt;</span><br><span class="line"></span><br><span class="line">(gdb) display /i <span class="variable">$pc</span></span><br><span class="line">(gdb) display /3i <span class="variable">$pc</span> <span class="comment"># 一次性显示3条指令</span></span><br><span class="line"></span><br><span class="line">(gdb) backtrace <span class="comment"># 显示当前函数的栈帧以及局部变量信息</span></span><br><span class="line">(gdb) backtrace full <span class="comment"># 显示各个函数的栈帧以及局部变量值</span></span><br><span class="line">(gdb) backtrace full n <span class="comment"># 从内向外显示n个栈桢，及其局部变量</span></span><br><span class="line">(gdb) backtrace full -n <span class="comment"># 从外向内显示n个栈桢，及其局部变量</span></span><br></pre></td></tr></table></figure>
<p>threads  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#for multithreads</span></span><br><span class="line">info threads</span><br><span class="line">显示当前可调式的所有线程，线程 ID 前有 “*” 表示当前被调试的线程。</span><br><span class="line">thread threadid</span><br><span class="line">切换线程到线程threadid</span><br><span class="line"><span class="built_in">set</span> scheduler-locking [on|off|step]</span><br><span class="line">多线程环境下，会存在多个线程运行，这会影响调试某个线程的结果，这个命令可以设置调试的时候多个线程的运行情况，on 表示只有当前调试的线程会继续执行，off 表示不屏蔽任何线程，所有线程都可以执行，step 表示在单步执行时，只有当前线程会执行。</span><br><span class="line">thread apply [threadid] [all] args</span><br><span class="line">对线程列表执行命令。比如通过thread apply all bt full可以查看所有线程的局部变量信息。</span><br></pre></td></tr></table></figure>

<p>print</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">x 按十六进制格式显示变量</span><br><span class="line">d 按十进制格式显示变量</span><br><span class="line">u 按十六进制格式显示无符号整型</span><br><span class="line">o 按八进制格式显示变量</span><br><span class="line">t 按二进制格式显示变量</span><br><span class="line">a 按十六进制格式显示变量</span><br><span class="line">c 按字符格式显示变量</span><br><span class="line">f 按浮点数格式显示变量</span><br><span class="line">expr可以是一个变量，也可以是表达式，也可以是寄存器：</span><br><span class="line"></span><br><span class="line">(gdb) p var1 # 打印变量var1</span><br><span class="line">(gdb) p &amp;var1 # 打印变量var1地址</span><br><span class="line">(gdb) p $rsp # 打印rsp寄存器地址</span><br><span class="line">(gdb) p $rsp + 8 # 打印rsp加8后的地址信息</span><br><span class="line">(gdb) p 0xc000068fd0 # 打印0xc000068fd0转换成10进制格式</span><br><span class="line">(gdb) p /x 824634150864 # 打印824634150864转换成16进制格式</span><br><span class="line"></span><br><span class="line">例如对于如下代码：int arr[] = &#123;2, 4, 6, 8, 10&#125;;，可以通过如下命令查看arr前三个单元的数据：</span><br><span class="line">(gdb) p *arr@3</span><br><span class="line">$2 = &#123;2, 4, 6&#125;</span><br><span class="line"></span><br><span class="line">examine命令用来查看内存地址中的值，可以简写成x。examine命令的语法如下所示：</span><br><span class="line"></span><br><span class="line">examine /&lt;n/f/u&gt;</span><br><span class="line"></span><br><span class="line">n 表示显示字段的长度，也就是说从当前地址向后显示几个地址的内容。</span><br><span class="line"></span><br><span class="line">f 表示显示的格式</span><br><span class="line"></span><br><span class="line">d 数字 decimal</span><br><span class="line">u 无符号数字 unsigned decimal</span><br><span class="line">s 字符串 string</span><br><span class="line">c 字符 char</span><br><span class="line">u 无符号整数 unsigned integer</span><br><span class="line">t 二进制 binary</span><br><span class="line">o 八进制格式 octal</span><br><span class="line">x 十六进制格式 hex</span><br><span class="line">f 浮点数格式 float</span><br><span class="line">i 指令 instruction</span><br><span class="line">a 地址 address</span><br><span class="line">u 表示从当前地址往后请求的字节数，默认是4个bytes</span><br><span class="line"></span><br><span class="line">b 一个字节 byte</span><br><span class="line">h 两个字节 halfword</span><br><span class="line">w 四个字节 word</span><br><span class="line">g 八个字节 giantword</span><br><span class="line">示例：</span><br><span class="line"></span><br><span class="line">(gdb) x/10c 0x4005d4 # 打印前10个字符</span><br><span class="line">(gdb) x/16xb a # 以16进制格式打印数组前a16个byte的值</span><br><span class="line">(gdb) x/16ub a # 以无符号10进制格式打印数组a前16个byte的值</span><br><span class="line">(gdb) x/16tb a # 以2进制格式打印数组前16个abyte的值</span><br><span class="line">(gdb) x/16xw a # 以16进制格式打印数组a前16个word（4个byte）的值</span><br><span class="line">(gdb) x $rsp # 打印rsp寄存器执行的地址的值</span><br><span class="line">(gdb) x $rsp + 8 # 打印rsp加8后的地址指向的值</span><br><span class="line">(gdb) x 0xc000068fd0 # 打印内存0xc000068fd0指向的值</span><br><span class="line"></span><br><span class="line">(gdb) set var var1=123 # 设置变量var1值为123</span><br><span class="line">(gdb) set var $rax=123 # 设置寄存器值为123</span><br><span class="line">(gdb) set environment envname1=123 # 设置环境变量envname1值为123</span><br><span class="line"></span><br><span class="line">(gdb) help status # 查看所有命令使用示例</span><br><span class="line">(gdb) help x # 查看x命令使用帮助</span><br><span class="line"></span><br><span class="line">(gdb) search func add # 从当前位置向前搜索add方法</span><br><span class="line">(gdb) rev func add # 从当前为向后搜索add方法</span><br><span class="line"></span><br><span class="line">(gdb) set height 0</span><br><span class="line">(gdb) set logging file /tmp/thread_apply_all_bt.txt</span><br><span class="line">(gdb) set logging on</span><br><span class="line">Copying output to /tmp/thread_apply_all_bt.txt</span><br><span class="line"></span><br><span class="line">Request a backtrace:</span><br><span class="line"></span><br><span class="line">(gdb) thread apply all bt full</span><br><span class="line"></span><br><span class="line">$ valgrind --tool=helgrind ./a.out</span><br></pre></td></tr></table></figure>

<p>watch var   It is stopped by the gdb after the write has occurred<br>rwatch var  It is stopped by the gdb after the read has occurred<br>awatch var  It is stopped by the gdb after the read and write have occurred  </p>
<p>step  (in function)<br>next  (not go to function)  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info b</span><br><span class="line">No breakpoints or watchpoints.</span><br><span class="line">(gdb) watch a <span class="keyword">if</span> a==5 </span><br><span class="line">Hardware watchpoint 3: a</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       hw watchpoint  keep y                      a</span><br><span class="line">        stop only <span class="keyword">if</span> a==5</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 2 <span class="string">&quot;a.out&quot;</span> hit Hardware watchpoint 3: a</span><br><span class="line"></span><br><span class="line">Old value = 4</span><br><span class="line">New value = 5</span><br><span class="line">thread1_func (p_arg=0x555555554844) at thread1.c:10</span><br><span class="line">10                      <span class="built_in">sleep</span>(10);</span><br><span class="line"></span><br><span class="line">(gdb) info watchpoints</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">3       hw watchpoint  keep y                      a</span><br><span class="line">        stop only <span class="keyword">if</span> a==5</span><br><span class="line">        breakpoint already hit 1 time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(gdb) watch 0x600850</span><br><span class="line">Cannot watch constant value 0x600850.</span><br><span class="line">(gdb) watch *(int *) 0x600850</span><br><span class="line">Watchpoint 1: *(int *) 6293584 </span><br></pre></td></tr></table></figure>
<p>catch <event><br>tcatch <event>  (temp catch)<br>event: throw,catch,exec,fork,load,unload,exception,exception unhandled,assert,syscall [name | number ]    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) catch syscall open</span><br><span class="line">Catchpoint 7 (syscall <span class="string">&#x27;open&#x27;</span> [2])</span><br><span class="line">(gdb) catch syscall 5</span><br><span class="line">Catchpoint 8 (syscall <span class="string">&#x27;fstat&#x27;</span> [5])</span><br><span class="line">(gdb) <span class="built_in">help</span> catch syscall</span><br><span class="line">Catch system calls by their names, <span class="built_in">groups</span> and/or numbers.</span><br><span class="line">Arguments say <span class="built_in">which</span> system calls to catch.  If no arguments are given,</span><br><span class="line">every system call will be caught.  Arguments, <span class="keyword">if</span> given, should be one</span><br><span class="line">or more system call names (<span class="keyword">if</span> your system supports that), system call</span><br><span class="line"><span class="built_in">groups</span> or system call numbers.</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> more syscall</span><br><span class="line">/usr/include/x86_64-linux-gnu/asm/unistd_64.h</span><br></pre></td></tr></table></figure>
<p>clear #clear all<br>clear function<br>clear linenum<br>delete beakpoints [range,eg: 1-5]<br>enable&#x2F;disable breakpoints [range]<br>enable breakpoints once range<br>enable breakpoints delete range    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51</span></span><br><span class="line"><span class="comment">#1  0x00007f258be20801 in __GI_abort () at abort.c:79</span></span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort,</span></span><br><span class="line">    <span class="built_in">fmt</span>=<span class="built_in">fmt</span>@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line"><span class="comment">#3  0x00007f258bf14cd1 in __GI___fortify_fail_abort (need_backtrace=need_backtrace@entry=false,</span></span><br><span class="line">    msg=msg@entry=0x7f258bf96966 <span class="string">&quot;stack smashing detected&quot;</span>) at fortify_fail.c:33</span><br><span class="line"><span class="comment">#4  0x00007f258bf14c92 in __stack_chk_fail () at stack_chk_fail.c:29</span></span><br><span class="line"><span class="comment">#5  0x0000564b218ff8e9 in main () at ./bubble_sort_bug.c:43</span></span><br><span class="line"></span><br><span class="line">(gdb) f 2</span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort,</span></span><br><span class="line">    <span class="built_in">fmt</span>=<span class="built_in">fmt</span>@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line">181     ../sysdeps/posix/libc_fatal.c: No such file or directory.</span><br><span class="line">(gdb) up</span><br><span class="line"><span class="comment">#3  0x00007f258bf14cd1 in __GI___fortify_fail_abort (need_backtrace=need_backtrace@entry=false,</span></span><br><span class="line">    msg=msg@entry=0x7f258bf96966 <span class="string">&quot;stack smashing detected&quot;</span>) at fortify_fail.c:33</span><br><span class="line">33      fortify_fail.c: No such file or directory.</span><br><span class="line">(gdb) down</span><br><span class="line"><span class="comment">#2  0x00007f258be69897 in __libc_message (action=action@entry=do_abort,</span></span><br><span class="line">    <span class="built_in">fmt</span>=<span class="built_in">fmt</span>@entry=0x7f258bf96988 <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>) at ../sysdeps/posix/libc_fatal.c:181</span><br><span class="line">181     ../sysdeps/posix/libc_fatal.c: No such file or directory.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(gdb) f 5</span><br><span class="line"><span class="comment">#5  0x0000564b218ff8e9 in main () at ./bubble_sort_bug.c:43</span></span><br><span class="line">43      &#125;</span><br><span class="line">(gdb) info f</span><br><span class="line">Stack level 5, frame at 0x7ffd58ea9f80:</span><br><span class="line"> rip = 0x564b218ff8e9 <span class="keyword">in</span> main (./bubble_sort_bug.c:43); saved rip = 0x7f258be01b97</span><br><span class="line"> <span class="built_in">caller</span> of frame at 0x7ffd58ea9e40</span><br><span class="line"> <span class="built_in">source</span> language c.</span><br><span class="line"> Arglist at 0x7ffd58ea9f70, args:</span><br><span class="line"> Locals at 0x7ffd58ea9f70, Previous frame<span class="string">&#x27;s sp is 0x7ffd58ea9f80</span></span><br><span class="line"><span class="string"> Saved registers:</span></span><br><span class="line"><span class="string">  rbx at 0x7ffd58ea9f68, rbp at 0x7ffd58ea9f70, rip at 0x7ffd58ea9f78</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(gdb) info args</span></span><br><span class="line"><span class="string">No arguments.</span></span><br><span class="line"><span class="string">(gdb) info locals</span></span><br><span class="line"><span class="string">array = &#123;20424913, 207764369, 232957269, 286304630, 340051919, 418929367, 428095442, 560929304, 622631137,</span></span><br><span class="line"><span class="string">  681405812, 702646332, 717507172, 771731937, 844764348, 871741416, 893622553, 939367001, 953569863, 983680782,</span></span><br><span class="line"><span class="string">  1133421906, 1150235085, 1170267861, 1267699692, 1278859841, 1351132359, 1478380837, 1618765791, 1747714870,</span></span><br><span class="line"><span class="string">  2015283722, 2027462427, 2046956728, 2080576919&#125;</span></span><br><span class="line"><span class="string">i = 36</span></span><br></pre></td></tr></table></figure>

<h3 id="kprobe-example"><a href="#kprobe-example" class="headerlink" title="kprobe example"></a><a target="_blank" rel="noopener" href="https://www.linuxjournal.com/content/oops-debugging-kernel-panics-0">kprobe example</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">test_module_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> *p = <span class="number">1</span>;</span><br><span class="line">printk(<span class="string">&quot;%d\n&quot;</span>, *p);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">test_module_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(test_module_init);</span><br><span class="line">module_exit(test_module_exit);</span><br><span class="line"></span><br><span class="line">## Makefile</span><br><span class="line">obj-m += test-module.o</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">    $(MAKE) -C/lib/modules/$(shell uname -r)/build M=$(PWD)</span><br><span class="line"></span><br><span class="line">$ sync &amp;&amp; sudo insmod test-module.ko</span><br><span class="line">crash&gt; mod -s test ./test.o</span><br><span class="line">$ kmem -i</span><br></pre></td></tr></table></figure>

<h3 id="test-stack"><a href="#test-stack" class="headerlink" title="test stack"></a><a target="_blank" rel="noopener" href="https://awokezhou.github.io/2019/10/15/%E5%87%BD%E6%95%B0%E5%92%8C%E6%A0%88/">test stack</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">First In, Last Out FILO</span><br><span class="line">函数调用栈在内存中从高地址向低地址生长，所以栈顶对应的内存地址在压栈时变小，退栈时变大</span><br><span class="line">在压栈过程中，esp寄存器的值会逐渐减小（栈从内存高地址向地址值“生长”）。发生调用时，程序还会将被调用函数（callee）的指令地址存到eip寄存器内，这样程序就可以依序执行被调用函数的指令了。</span><br><span class="line">调用结束时，栈变化的核心任务是弹出被调用函数（callee）的状态，并将整个栈恢复到调用函数（<span class="built_in">caller</span>）的状态。首先弹出被调用函数（callee）的局部变量，然后将栈上存储的调用函数（<span class="built_in">caller</span>）的基地址从栈内弹出，并重新保存到ebp寄存器中，这样调用函数的基地址信息得以恢复，此时栈顶会指向返回地址。最后将返回地址从栈顶弹出，并保存到eip寄存器内，这样调用函数的eip指令信息得以恢复，指向了调用函数后的下一条语句。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">func1</span></span> () &#123;    &lt;-------Frame 3</span><br><span class="line">  <span class="function"><span class="title">func2</span></span> () &#123;  &lt;-------Frame 2</span><br><span class="line">    <span class="function"><span class="title">func3</span></span> () &#123; &lt;------Frame 1 (gdb)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EIP(instruction pointer) cpu 依照 eip 的存储内容读取指令并执行，eip 随之指向相邻的下一条指令</span><br><span class="line">ESP(stack pointer) 高地址向低地址，所以ESP指向一般的下方是栈顶, 用来存储函数调用栈的栈顶地址，在压栈和退栈时发生变化。</span><br><span class="line">EBP(base pointer) 指向栈底，所以在上面(高地址), 在函数运行时不变，可以用来索引确定函数参数或局部变量的位置。</span><br><span class="line"></span><br><span class="line">程序的运行是依靠EIP指针的累加从而一条指令一条指令执行的，但是当函数调用时，在跳转到子函数时和子函数返回时，显然地址不是连续的，如何做到外层函数的保存和返回呢？在同一个时刻，堆栈中会有多个函数的信息，每个待返回的函数都会占用一块独立的连续区域，这个区域就是栈帧。一个栈帧中主要存放以下关键信息,上一栈帧的栈顶地址,局部变量,参数列表</span><br><span class="line"></span><br><span class="line">此时EBP指向<span class="built_in">caller</span>栈帧的栈底，ESP指向<span class="built_in">caller</span>栈帧的栈顶</span><br><span class="line">在调用callee之前，<span class="built_in">caller</span>会将EIP的值压栈保存，然后修改EIP寄存器的值指向被调用者callee</span><br></pre></td></tr></table></figure>

<h3 id="Block-Started-Symbol"><a href="#Block-Started-Symbol" class="headerlink" title="Block Started Symbol"></a><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/j86NDI3a0VlIxAzsvNXhcQ">Block Started Symbol</a></h3><p>由此也可以看出来bss段的数据&#x2F;变量只有名称和大小，只是简单维护地址空间中开始和结束的地址,不消耗磁盘空间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ ls -ls test</span><br><span class="line"><span class="number">12</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">8424</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">13</span> test</span><br><span class="line">$ size test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1229</span>	    <span class="number">548</span>	<span class="number">4194336</span>	<span class="number">4196113</span>	 <span class="number">400711</span>	test</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ ls -ls test; size test</span><br><span class="line"><span class="number">12</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">8424</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">14</span> test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1229</span>	    <span class="number">548</span>	<span class="number">4194336</span>	<span class="number">4196113</span>	 <span class="number">400711</span>	test</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$  ls -ls test; size test</span><br><span class="line"><span class="number">12</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">8424</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">15</span> test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1229</span>	    <span class="number">548</span>	<span class="number">4194336</span>	<span class="number">4196113</span>	 <span class="number">400711</span>	test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##<span class="meta">#not init data</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>]=&#123;<span class="number">1</span>&#125;;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ ls -ls test; size test</span><br><span class="line"><span class="number">12</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">8448</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">20</span> test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1334</span>	    <span class="number">556</span>	      <span class="number">4</span>	   <span class="number">1894</span>	    <span class="number">766</span>	test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##<span class="meta">#init to data part</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>]=&#123;<span class="number">1</span>&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ ls -ls test; size test</span><br><span class="line"><span class="number">4108</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">4202776</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">19</span> test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1229</span>	<span class="number">4194880</span>	      <span class="number">8</span>	<span class="number">4196117</span>	 <span class="number">400715</span>	test</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>]=&#123;<span class="number">1</span>&#125;;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$ ls -ls test; size test</span><br><span class="line"><span class="number">4108</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">4202776</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">21</span> test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1229</span>	<span class="number">4194880</span>	      <span class="number">8</span>	<span class="number">4196117</span>	 <span class="number">400715</span>	test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> a[<span class="number">1024</span>*<span class="number">1024</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this is a test\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">$  ls -ls test; size test</span><br><span class="line"><span class="number">12</span> -rwxr-xr-x <span class="number">1</span> root root <span class="number">8424</span> Sep  <span class="number">5</span> <span class="number">16</span>:<span class="number">25</span> test</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   <span class="number">1229</span>	    <span class="number">548</span>	<span class="number">4194336</span>	<span class="number">4196113</span>	 <span class="number">400711</span>	test</span><br></pre></td></tr></table></figure>

<h3 id="Why-more-space-on-the-stack-frame-is-reserved-than-is-needed-in-x86"><a href="#Why-more-space-on-the-stack-frame-is-reserved-than-is-needed-in-x86" class="headerlink" title="Why more space on the stack frame is reserved than is needed in x86"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40580914/why-more-space-on-the-stack-frame-is-reserved-than-is-needed-in-x86">Why more space on the stack frame is reserved than is needed in x86</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_something</span><span class="params">(<span class="type">int</span>* ptr)</span> &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Got address &quot;</span> &lt;&lt; reinterpret_cast&lt;<span class="type">void</span>*&gt;(ptr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    do_something(&amp;a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    func();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-&gt;  <span class="number">0x100001140</span> &lt;+<span class="number">0</span>&gt;:  pushq  %rbp</span><br><span class="line">    <span class="number">0x100001141</span> &lt;+<span class="number">1</span>&gt;:  movq   %rsp, %rbp</span><br><span class="line">    <span class="number">0x100001144</span> &lt;+<span class="number">4</span>&gt;:  subq   $<span class="number">0x10</span>, %rsp</span><br><span class="line">    <span class="number">0x100001148</span> &lt;+<span class="number">8</span>&gt;:  leaq   <span class="number">-0x4</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10000114c</span> &lt;+<span class="number">12</span>&gt;: callq  <span class="number">0x100000f90</span>               ; do_something(<span class="type">int</span>*)</span><br><span class="line">    <span class="number">0x100001151</span> &lt;+<span class="number">17</span>&gt;: addq   $<span class="number">0x10</span>, %rsp</span><br><span class="line">    <span class="number">0x100001155</span> &lt;+<span class="number">21</span>&gt;: popq   %rbp</span><br><span class="line">    <span class="number">0x100001156</span> &lt;+<span class="number">22</span>&gt;: retq   </span><br><span class="line">    <span class="number">0x100001157</span> &lt;+<span class="number">23</span>&gt;: nopw   (%rax,%rax)</span><br><span class="line"></span><br><span class="line">The variable a needs only <span class="number">4</span> bytes</span><br><span class="line">which in this <span class="keyword">case</span> seems to be <span class="number">4</span> bytes off from the base</span><br><span class="line">Other architectures seem to reserve more than <span class="number">16</span> bytes and have other things stored on the base of the <span class="built_in">stack</span> frame</span><br><span class="line"></span><br><span class="line">This is x64 code, note the usage of the rsp <span class="keyword">register</span>. x86 code uses the esp <span class="keyword">register</span>. Most important implementation detail of the x64 ABI is that the <span class="built_in">stack</span> must always be aligned to <span class="number">16.</span> Not actually necessary to properly run <span class="number">64</span>-bit code, but the alignment guarantee ensures that the compiler can safely emit SSE instructions. Their operands require <span class="number">16</span> byte alignment to be fast. None are actually used in this snippet but they might be in do_something.</span><br><span class="line"></span><br><span class="line">Upon entry of your function, the caller<span class="number">&#x27;</span>s CALL instruction has pushed <span class="number">8</span> bytes on the <span class="built_in">stack</span> to store the <span class="keyword">return</span> address.</span><br><span class="line">The first PUSH instruction aligns the <span class="built_in">stack</span> to <span class="number">16</span> again, no additional corrections required.</span><br><span class="line"></span><br><span class="line">It then creates the <span class="built_in">stack</span> frame to store the a variable. While only <span class="number">4</span> bytes are required, adjusting rsp by only <span class="number">4</span> isn<span class="number">&#x27;</span>t good enough to provide the necessary alignment. So it picks the next suitable value, <span class="number">16.</span> The extra <span class="number">12</span> bytes are simply unused.</span><br><span class="line"></span><br><span class="line">The LEA instruction is a very handy one that implements &amp;a. LEA = Load Effective Address = <span class="string">&quot;take the address of&quot;</span>. Not a particularly involved calculation here, it gets more convoluted when you use something like &amp;<span class="built_in">array</span>[ix]. Something that still can be done by a single LEA <span class="keyword">if</span> the <span class="built_in">array</span> element size is <span class="number">1</span>, <span class="number">2</span> or <span class="number">4</span> bytes <span class="type">long</span>, pretty common.</span><br><span class="line"></span><br><span class="line">The <span class="number">-4</span> is the offset from the start of the <span class="built_in">stack</span> frame <span class="keyword">for</span> the a variable. <span class="number">4</span> bytes are needed to store <span class="type">int</span>, your compiler implements the LP64 data model. Keep in mind that the <span class="built_in">stack</span> grows downwards so it isn<span class="number">&#x27;</span>t <span class="number">0.</span></span><br></pre></td></tr></table></figure>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#mem-map"><span class="toc-number">1.</span> <span class="toc-text">mem map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sysctl-conf"><span class="toc-number">2.</span> <span class="toc-text">sysctl.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trigger-the-core"><span class="toc-number">3.</span> <span class="toc-text">trigger the core</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#debuginfo"><span class="toc-number">3.0.1.</span> <span class="toc-text">debuginfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-disassem-format"><span class="toc-number">4.</span> <span class="toc-text">set disassem format</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example1"><span class="toc-number">4.1.</span> <span class="toc-text">example1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Core-pattern-setting"><span class="toc-number">4.2.</span> <span class="toc-text">Core pattern setting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Examples"><span class="toc-number">5.</span> <span class="toc-text">Examples</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-the-function-parameters"><span class="toc-number">5.1.</span> <span class="toc-text">trace the function parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#segment-fault"><span class="toc-number">5.2.</span> <span class="toc-text">segment fault</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Got-the-issue-line-by-gdb"><span class="toc-number">5.3.</span> <span class="toc-text">Got the issue line by gdb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example1-1"><span class="toc-number">5.4.</span> <span class="toc-text">example1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#print-argv"><span class="toc-number">5.5.</span> <span class="toc-text">print argv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#threads"><span class="toc-number">5.6.</span> <span class="toc-text">threads</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#or"><span class="toc-number"></span> <span class="toc-text">or</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example3"><span class="toc-number">0.1.</span> <span class="toc-text">example3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example4"><span class="toc-number">0.2.</span> <span class="toc-text">example4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example5-gcc-parameters-and-show-macro"><span class="toc-number">0.3.</span> <span class="toc-text">example5 gcc parameters and show macro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example6"><span class="toc-number">0.4.</span> <span class="toc-text">example6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example7-gen-the-debuginfo"><span class="toc-number">0.5.</span> <span class="toc-text">example7 gen the debuginfo</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#build-linux-kernel-module-with-debuginfo"><span class="toc-number">0.5.1.</span> <span class="toc-text">build linux kernel module with debuginfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable-ptrace-permissions"><span class="toc-number">1.</span> <span class="toc-text">Enable ptrace permissions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Core-signal"><span class="toc-number">2.</span> <span class="toc-text">Core signal</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-SIGSEGV"><span class="toc-number">2.1.</span> <span class="toc-text">Test SIGSEGV</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb-cmd"><span class="toc-number">3.</span> <span class="toc-text">gdb cmd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kprobe-example"><span class="toc-number">4.</span> <span class="toc-text">kprobe example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-stack"><span class="toc-number">5.</span> <span class="toc-text">test stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Block-Started-Symbol"><span class="toc-number">6.</span> <span class="toc-text">Block Started Symbol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-more-space-on-the-stack-frame-is-reserved-than-is-needed-in-x86"><span class="toc-number">7.</span> <span class="toc-text">Why more space on the stack frame is reserved than is needed in x86</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/03/03/gdb/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/03/03/gdb/&text=GDB tips"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/03/03/gdb/&is_video=false&description=GDB tips"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=GDB tips&body=Check out this article: http://example.com/2020/03/03/gdb/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/03/03/gdb/&title=GDB tips"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/03/03/gdb/&name=GDB tips&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/03/03/gdb/&t=GDB tips"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

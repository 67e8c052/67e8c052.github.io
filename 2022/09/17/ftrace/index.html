<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Enable12345678910111213141516171819202122232425$ sysctl -q kernel.ftrace_enabled&#x3D;1$ mount -t tracefs tracefs &#x2F;sys&#x2F;kernel&#x2F;tracing#quick start$ echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;events&#x2F;timer&#x2F;tick_st">
<meta property="og:type" content="article">
<meta property="og:title" content="ftrace">
<meta property="og:url" content="http://example.com/2022/09/17/ftrace/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Enable12345678910111213141516171819202122232425$ sysctl -q kernel.ftrace_enabled&#x3D;1$ mount -t tracefs tracefs &#x2F;sys&#x2F;kernel&#x2F;tracing#quick start$ echo 1 &gt; &#x2F;sys&#x2F;kernel&#x2F;debug&#x2F;tracing&#x2F;events&#x2F;timer&#x2F;tick_st">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-09-17T01:17:15.000Z">
<meta property="article:modified_time" content="2024-04-08T06:54:59.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="ftrace">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ftrace</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/13/rdma/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2020/07/24/bpftrace/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/09/17/ftrace/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/09/17/ftrace/&text=ftrace"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/09/17/ftrace/&is_video=false&description=ftrace"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ftrace&body=Check out this article: http://example.com/2022/09/17/ftrace/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/09/17/ftrace/&name=ftrace&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/09/17/ftrace/&t=ftrace"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable"><span class="toc-number">1.</span> <span class="toc-text">Enable</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ftrace
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-09-17T01:17:15.000Z" itemprop="datePublished">2022-09-17</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Debug/">Debug</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/debug/" rel="tag">debug</a>, <a class="tag-link-link" href="/tags/ftrace/" rel="tag">ftrace</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="Enable"><a href="#Enable" class="headerlink" title="Enable"></a>Enable</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -q kernel.ftrace_enabled=1</span><br><span class="line">$ mount -t tracefs tracefs /sys/kernel/tracing</span><br><span class="line"></span><br><span class="line"><span class="comment">#quick start</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/timer/tick_stop/enable</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/per_cpu/cpu7/trace</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;!do_mount &#x27;</span> &gt;&gt; set_ftrace_filter <span class="comment">#先把之前的do_mount filter给去掉。</span></span><br><span class="line">$ <span class="built_in">echo</span> kfree_skb &gt; set_graph_function  <span class="comment">#设置kfree_skb()</span></span><br><span class="line">$ <span class="built_in">echo</span> nop &gt; current_tracer <span class="comment">#暂时把current_tracer设置为nop, 这样可以清空trace</span></span><br><span class="line">$ <span class="built_in">echo</span> function_graph &gt; current_tracer <span class="comment">#把current_tracer设置为function_graph</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#kprobe</span></span><br><span class="line">                                               --func first parameter</span><br><span class="line">                                               |                  </span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;p:kprobes/myprobe do_filp_open dfd=+0(%di):u32 pathname=+0(+0(%si)):string&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_event</span><br><span class="line">                                                                       |</span><br><span class="line">                                                                       --second parameter</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line">      </span><br><span class="line">kprobe的基本工作原理其实也很简单。当kprobe函数注册的时候，其实就是把目标地址上内核代码的指令码，替换成了“cc”，也就是int3指令。这样一来，当内核代码执行到这条指令的时候，就会触发一个异常而进入到Linux int3异常处理函数do_int3()里。</span><br><span class="line"></span><br><span class="line">在do_int3()这个函数里，如果发现有对应的kprobe注册了probe，就会依次执行注册的pre_handler()，原来的指令，最后是post_handler()。             </span><br></pre></td></tr></table></figure>

<ul>
<li><p>mm_page_alloc_extfrag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/sys/kernel/debug/tracing/events/kmem/mm_page_alloc/format</span><br><span class="line">/sys/kernel/debug/tracing/events/syscalls/sys_enter_fsetxattr/format</span><br><span class="line">/sys/kernel/debug/tracing/events/filemap/mm_filemap_delete_from_page_cache/format</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kmem/mm_page_alloc_extfrag/enable</span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line"></span><br><span class="line">           &lt;...&gt;-48794 [003] d... 29700.500381: mm_page_alloc_extfrag: page=ffffe547d61d0000 pfn=22574080 alloc_order=9 fallback_order=10 pageblock_order=9 alloc_migratetype=2 fallback_migratetype=2 fragmenting=0 change_ownership=1</span><br><span class="line">           &lt;...&gt;-48794 [003] d... 29701.045678: mm_page_alloc_extfrag: page=ffffe547d60e0000 pfn=22558720 alloc_order=9 fallback_order=10 pageblock_order=9 alloc_migratetype=2 fallback_migratetype=2 fragmenting=0 change_ownership=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>function_graph</p>
<ul>
<li>The function_graph tracer is designed to present results in a more visually appealing format. This tracer also traces the exit of the function, displaying a flow of function calls in the kernel. Note that this tracer has more overhead than the function tracer when enabled, but the same low overhead when disabled.</li>
</ul>
</li>
<li><p>wakeup</p>
<ul>
<li>A full CPU tracer that reports the activity happening across all CPUs. Records the time that it takes to wake up the highest priority task in the system, whether that task is a real time task or not. Recording the max time it takes to wake up a non real time task will hide the times it takes to wake up a real time task.</li>
</ul>
</li>
<li><p>wakeup_rt</p>
<ul>
<li>A full CPU tracer that reports the activity happening across all CPUs. Records the time that it takes from the current highests priority task to wake up to the time it is scheduled. Only records the time for real time tasks.</li>
</ul>
</li>
<li><p>preemptirqsoff</p>
<ul>
<li>Traces the areas that disable pre-emption or interrupts, and records the maximum amount of time for which pre-emption or interrupts were disabled.</li>
</ul>
</li>
<li><p>preemptoff</p>
<ul>
<li>Similar to the preemptirqsoff tracer but traces only the maximum interval for which preemption was disabled.</li>
</ul>
</li>
<li><p>irqsoff</p>
<ul>
<li>Similar to the preemptirqsoff tracer but traces only the maximum interval for which interrupts were disabled.</li>
</ul>
</li>
<li><p>nop</p>
<ul>
<li>The default tracer. It does not provide any tracing facility itself, but as events may interleave into any tracer, the nop tracer is used for specific interest in tracing events.</li>
</ul>
</li>
<li><p>instances</p>
<ul>
<li>This is a way to make multiple trace buffers where different events can be recorded in different buffers. See “Instances” section below.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/tracing/options/function-trace</span><br><span class="line">1</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/options/function-trace</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> the number of microseconds above <span class="built_in">which</span> latencies must be recorded</span><br><span class="line"><span class="built_in">echo</span> 200 &gt; /sys/kernel/debug/tracing/tracing_thresh</span><br><span class="line"></span><br><span class="line">/sys/kernel/debug/tracing is a instance, <span class="keyword">if</span> you need more instance, you could <span class="built_in">mkdir</span> /sys/kernel/debug/tracing/instances/foo</span><br><span class="line"><span class="built_in">echo</span> &gt; trace <span class="comment"># clean buffer</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$pid</span> &gt; set_ftrace_pid</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> available_filter_functions</span><br><span class="line"><span class="built_in">echo</span> $(get from <span class="built_in">cat</span> available_filter_functions) &gt; set_ftrace_filter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;sched*&#x27;</span> &gt; set_ftrace_filter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;*lock*&#x27;</span> &gt; set_ftrace_filter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;spin_*&#x27;</span> &gt; set_ftrace_filter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;*cpu*&#x27;</span> &gt; set_ftrace_filter</span><br><span class="line">set_ftrace_notrace (opposite to that of set_ftrace_filter)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; tracing_on <span class="comment">#enable trace</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; tracing_on <span class="comment">#disable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tracer: function</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 975/975   #P:40</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">        z_wr_iss-3045  [014] .... 188761.253438: schedule &lt;-taskq_thread</span><br><span class="line">        z_wr_iss-3045  [014] .... 188761.277938: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [008] .... 188761.278328: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [008] .... 188761.278333: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [008] .... 188761.278368: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [008] .... 188761.279231: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [012] d.h. 188761.279421: scheduler_tick &lt;-update_process_times</span><br><span class="line">        z_wr_iss-3045  [012] .... 188761.279662: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [008] .... 188761.279750: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [004] .... 188761.279785: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [004] .... 188761.279896: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [004] .... 188761.280008: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line">        z_wr_iss-3045  [004] .... 188761.280020: schedule_preempt_disabled &lt;-__mutex_lock_slowpath</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> function_graph &gt; current_tracer</span><br><span class="line">$ <span class="built_in">cat</span> trace  | <span class="built_in">head</span> -20</span><br><span class="line"><span class="comment"># tracer: function_graph</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CPU  DURATION                  FUNCTION CALLS</span></span><br><span class="line"><span class="comment"># |     |   |                     |   |   |   |</span></span><br><span class="line">   2)   0.114 us    |                            finish_task_switch();</span><br><span class="line">   2) + 31.319 us   |                          &#125; /* __schedule */</span><br><span class="line">   2) + 32.114 us   |                        &#125; /* schedule_preempt_disabled */</span><br><span class="line">   2)   0.108 us    |                        _raw_spin_lock();</span><br><span class="line">   2)               |                        <span class="function"><span class="title">schedule_preempt_disabled</span></span>() &#123;</span><br><span class="line">   2)               |                          <span class="function"><span class="title">__schedule</span></span>() &#123;</span><br><span class="line">   2)   0.047 us    |                            rcu_note_context_switch();</span><br><span class="line">   2)   0.050 us    |                            _raw_spin_lock_irq();</span><br><span class="line">   2)               |                            <span class="function"><span class="title">deactivate_task</span></span>() &#123;</span><br><span class="line">   2)               |                              <span class="function"><span class="title">dequeue_task</span></span>() &#123;</span><br><span class="line">   2)   0.098 us    |                                update_rq_clock.part.81();</span><br><span class="line">   2)               |                                <span class="function"><span class="title">dequeue_task_fair</span></span>() &#123;</span><br><span class="line">   2)               |                                  <span class="function"><span class="title">dequeue_entity</span></span>() &#123;</span><br><span class="line">   2)               |                                    <span class="function"><span class="title">update_curr</span></span>() &#123;</span><br><span class="line">   2)   0.049 us    |                                      intel_pstate_update_util();</span><br><span class="line">   2)   0.050 us    |                                      __calc_delta();</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>set events</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">To enable all events, echo &#x27;*:*&#x27; or &#x27;*:&#x27; to the set_event file:</span><br><span class="line">$ echo *:* &gt; /sys/kernel/debug/tracing/set_event</span><br><span class="line"></span><br><span class="line">To enable event &#x27;sched_wakeup&#x27;:</span><br><span class="line">$ echo 1 &gt; /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable</span><br><span class="line"></span><br><span class="line">To disable it:</span><br><span class="line">$ echo 0 &gt; /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable</span><br><span class="line"></span><br><span class="line">To enable all events in sched subsystem:</span><br><span class="line">$ echo 1 &gt; /sys/kernel/debug/tracing/events/sched/enable</span><br><span class="line"></span><br><span class="line">To enable all events:</span><br><span class="line">$ echo 1 &gt; /sys/kernel/debug/tracing/events/enable</span><br><span class="line"></span><br><span class="line">When reading one of these enable files, there are four results:</span><br><span class="line"></span><br><span class="line"> 0 - all events this file affects are disabled</span><br><span class="line"> 1 - all events this file affects are enabled</span><br><span class="line"> X - there is a mixture of events enabled and disabled</span><br><span class="line"> ? - this file does not affect any event</span><br><span class="line"></span><br><span class="line">#disable ftace</span><br><span class="line">$ echo 0 &gt; tracing_on</span><br><span class="line">$ echo nop &gt; current_tracer</span><br><span class="line">$ echo notrace_printk &gt; trace_options</span><br><span class="line"></span><br><span class="line">$ trace-cmd reset #worked</span><br><span class="line"></span><br><span class="line">cat available_events </span><br><span class="line">or</span><br><span class="line">cd /sys/kernel/debug/tracing/events</span><br><span class="line"></span><br><span class="line">cat set_ftrace_pid</span><br><span class="line">no pid</span><br><span class="line">echo &gt; trace</span><br><span class="line">echo 99479 &gt; set_ftrace_pid</span><br><span class="line">echo 1 &gt; tracing_on</span><br><span class="line">echo sched:* &gt; set_event</span><br><span class="line">echo &#x27;irq:*&#x27; &gt;&gt; set_event</span><br><span class="line">echo &#x27;lock:*&#x27; &gt;&gt; set_event</span><br><span class="line"></span><br><span class="line"># tracer: nop</span><br><span class="line">#</span><br><span class="line"># entries-in-buffer/entries-written: 4916/4916   #P:40</span><br><span class="line">#</span><br><span class="line">#                              _-----=&gt; irqs-off</span><br><span class="line">#                             / _----=&gt; need-resched</span><br><span class="line">#                            | / _---=&gt; hardirq/softirq</span><br><span class="line">#                            || / _--=&gt; preempt-depth</span><br><span class="line">#                            ||| /     delay</span><br><span class="line">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span><br><span class="line">#              | |       |   ||||       |         |</span><br><span class="line">           &lt;...&gt;-99479 [010] d... 197736.430796: sched_stat_runtime: comm=bash pid=99479 runtime=152273 [ns] vruntime=833140516509 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [010] dN.. 197736.430798: sched_wakeup: comm=kworker/10:0 pid=94482 prio=120 success=1 target_cpu=010</span><br><span class="line">           &lt;...&gt;-99479 [010] dN.. 197736.430798: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=010</span><br><span class="line">           &lt;...&gt;-99479 [010] d... 197736.430800: sched_switch: prev_comm=bash prev_pid=99479 prev_prio=120 prev_state=R ==&gt; next_comm=kworker/10:0 next_pid=94482 next_prio=120</span><br><span class="line">           &lt;...&gt;-94482 [010] d... 197736.430804: sched_wakeup: comm=sshd pid=99477 prio=120 success=1 target_cpu=032</span><br><span class="line">           &lt;...&gt;-94482 [010] d... 197736.430805: sched_stat_runtime: comm=kworker/10:0 pid=94482 runtime=9300 [ns] vruntime=833128525809 [ns]</span><br><span class="line">           &lt;...&gt;-94482 [010] d... 197736.430806: sched_switch: prev_comm=kworker/10:0 prev_pid=94482 prev_prio=120 prev_state=S ==&gt; next_comm=bash next_pid=99479 next_prio=120</span><br><span class="line">          &lt;idle&gt;-0     [032] d... 197736.430807: sched_switch: prev_comm=swapper/32 prev_pid=0 prev_prio=120 prev_state=R ==&gt; next_comm=sshd next_pid=99477 next_prio=120</span><br><span class="line">           &lt;...&gt;-99477 [032] d... 197736.430839: sched_stat_runtime: comm=sshd pid=99477 runtime=36358 [ns] vruntime=9311452689443 [ns]</span><br><span class="line">           &lt;...&gt;-99477 [032] d... 197736.430848: sched_switch: prev_comm=sshd prev_pid=99477 prev_prio=120 prev_state=S ==&gt; next_comm=swapper/32 next_pid=0 next_prio=120</span><br><span class="line">           &lt;...&gt;-99479 [010] d... 197736.431094: sched_stat_runtime: comm=bash pid=99479 runtime=288569 [ns] vruntime=833140805078 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [010] dN.. 197736.431095: sched_wakeup: comm=kworker/10:0 pid=94482 prio=120 success=1 target_cpu=010</span><br><span class="line">           &lt;...&gt;-99479 [010] dN.. 197736.431095: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=010</span><br><span class="line">           &lt;...&gt;-99479 [010] d... 197736.431096: sched_switch: prev_comm=bash prev_pid=99479 prev_prio=120 prev_state=R ==&gt; next_comm=kworker/10:0 next_pid=94482 next_prio=120</span><br><span class="line"></span><br><span class="line">#Get sched_switch filter options</span><br><span class="line">cat /sys/kernel/debug/tracing/events/sched/sched_switch/format</span><br><span class="line">name: sched_switch</span><br><span class="line">ID: 324</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:char prev_comm[16];       offset:8;       size:16;        signed:1;</span><br><span class="line">        field:pid_t prev_pid;   offset:24;      size:4; signed:1;</span><br><span class="line">        field:int prev_prio;    offset:28;      size:4; signed:1;</span><br><span class="line">        field:long prev_state;  offset:32;      size:8; signed:1;</span><br><span class="line">        field:char next_comm[16];       offset:40;      size:16;        signed:1;</span><br><span class="line">        field:pid_t next_pid;   offset:56;      size:4; signed:1;</span><br><span class="line">        field:int next_prio;    offset:60;      size:4; signed:1;</span><br><span class="line"></span><br><span class="line">print fmt: &quot;prev_comm=%s prev_pid=%d prev_prio=%d prev_state=%s%s ==&gt; next_comm=%s next_pid=%d next_prio=%d&quot;, REC-&gt;prev_comm, REC-&gt;prev_pid, REC-&gt;prev_prio, REC-&gt;prev_state &amp; (1024-1) ? __print_flags(REC-&gt;prev_state &amp; (1024-1), &quot;|&quot;, &#123; 1, &quot;S&quot;&#125; , &#123; 2, &quot;D&quot; &#125;, &#123; 4, &quot;T&quot; &#125;, &#123; 8, &quot;t&quot; &#125;, &#123; 16, &quot;Z&quot; &#125;, &#123; 32, &quot;X&quot; &#125;, &#123; 64, &quot;x&quot; &#125;, &#123; 128, &quot;K&quot; &#125;, &#123; 256, &quot;W&quot; &#125;, &#123; 512, &quot;P&quot; &#125;) : &quot;R&quot;, REC-&gt;prev_state &amp; 1024 ? &quot;+&quot; : &quot;&quot;, REC-&gt;next_comm, REC-&gt;next_pid, REC-&gt;next_prio</span><br><span class="line"></span><br><span class="line">$echo &#x27;next_comm ~ &quot;cs&quot;&#x27; &gt; /sys/kernel/debug/tracing/events/sched/sched_switch/filter</span><br><span class="line"></span><br><span class="line">$ cat trace | head -40</span><br><span class="line"># tracer: nop</span><br><span class="line">#</span><br><span class="line"># entries-in-buffer/entries-written: 1017/1017   #P:40</span><br><span class="line">#</span><br><span class="line">#                              _-----=&gt; irqs-off</span><br><span class="line">#                             / _----=&gt; need-resched</span><br><span class="line">#                            | / _---=&gt; hardirq/softirq</span><br><span class="line">#                            || / _--=&gt; preempt-depth</span><br><span class="line">#                            ||| /     delay</span><br><span class="line">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span><br><span class="line">#              | |       |   ||||       |         |</span><br><span class="line">           &lt;...&gt;-99479 [004] d... 198076.877184: sched_stat_runtime: comm=bash pid=99479 runtime=192500 [ns] vruntime=910963064502 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [004] dN.. 198076.877185: sched_wakeup: comm=kworker/4:2 pid=437777 prio=120 success=1 target_cpu=004</span><br><span class="line">           &lt;...&gt;-99479 [004] dN.. 198076.877186: sched_wakeup: comm=bash pid=99479 prio=120 success=1 target_cpu=004</span><br><span class="line">           &lt;...&gt;-437777 [004] d... 198076.877192: sched_wakeup: comm=sshd pid=99477 prio=120 success=1 target_cpu=032</span><br><span class="line">           &lt;...&gt;-437777 [004] d... 198076.877193: sched_stat_runtime: comm=kworker/4:2 pid=437777 runtime=9871 [ns] vruntime=910951074373 [ns]</span><br><span class="line">           &lt;...&gt;-99477 [032] d... 198076.877225: sched_stat_runtime: comm=sshd pid=99477 runtime=34303 [ns] vruntime=9311457538136 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [004] d.h. 198076.877272: sched_stat_runtime: comm=bash pid=99479 runtime=78293 [ns] vruntime=910963142795 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [004] d.H. 198076.877281: sched_wakeup: comm=rcu_sched pid=10 prio=120 success=1 target_cpu=010</span><br><span class="line">       rcu_sched-10    [010] d... 198076.877287: sched_stat_runtime: comm=rcu_sched pid=10 runtime=7465 [ns] vruntime=833154240570 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [004] d... 198076.877487: sched_stat_runtime: comm=bash pid=99479 runtime=215091 [ns] vruntime=910963357886 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [004] dN.. 198076.877487: sched_wakeup: comm=kworker/4:2 pid=437777 prio=120 success=1 target_cpu=004</span><br><span class="line">           &lt;...&gt;-437777 [004] d... 198076.877492: sched_wakeup: comm=sshd pid=99477 prio=120 success=1 target_cpu=032</span><br><span class="line">           &lt;...&gt;-437777 [004] d... 198076.877493: sched_stat_runtime: comm=kworker/4:2 pid=437777 runtime=6786 [ns] vruntime=910951364672 [ns]</span><br><span class="line">           &lt;...&gt;-99479 [004] d... 198076.877499: sched_stat_runtime: comm=bash pid=99479 runtime=5766 [ns] vruntime=910963363652 [ns]</span><br><span class="line">           &lt;...&gt;-99477 [032] d... 198076.877526: sched_stat_runtime: comm=sshd pid=99477 runtime=34484 [ns] vruntime=9311457572620 [ns]</span><br><span class="line">          &lt;idle&gt;-0     [010] dNs. 198076.881270: sched_wakeup: comm=rcu_sched pid=10 prio=120 success=1 target_cpu=010</span><br><span class="line">       rcu_sched-10    [010] d... 198076.881286: sched_stat_runtime: comm=rcu_sched pid=10 runtime=15885 [ns] vruntime=833154256455 [ns]</span><br><span class="line">          &lt;idle&gt;-0     [016] dNs. 198076.881495: sched_wakeup: comm=kworker/u896:0 pid=163541 prio=120 success=1 target_cpu=016</span><br><span class="line">           &lt;...&gt;-163541 [016] d... 198076.881501: sched_stat_runtime: comm=kworker/u896:0 pid=163541 runtime=5333 [ns] vruntime=847786361111 [ns]</span><br><span class="line"></span><br><span class="line">$ cd /sys/kernel/debug/tracing/events/signal/signal_generate</span><br><span class="line">$ echo &quot;((sig &gt;= 10 &amp;&amp; sig &lt; 15) || sig == 17) &amp;&amp; comm != bash&quot; &gt; filter</span><br><span class="line"></span><br><span class="line"># clear filters</span><br><span class="line">$ echo 0 &gt; filter</span><br><span class="line"></span><br><span class="line">$ cd /sys/kernel/debug/tracing/events/sched</span><br><span class="line">$ echo prev_pid == 0 &gt; filter</span><br></pre></td></tr></table></figure>

<ul>
<li><p>stack</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ echo 1 &gt; /proc/sys/kernel/stack_tracer_enabled</span><br><span class="line">$ cat stack_max_size</span><br><span class="line">4720</span><br><span class="line">$ cat stack_trace</span><br><span class="line">        Depth    Size   Location    (57 entries)</span><br><span class="line">        -----    ----   --------</span><br><span class="line">  0)     4720     320   alloc_iova_fast+0xd8/0x1e0</span><br><span class="line">  1)     4400      48   intel_alloc_iova+0xa5/0xd0</span><br><span class="line">  2)     4352      80   __intel_map_single+0x97/0x1a0</span><br><span class="line">  3)     4272      16   intel_map_page+0x33/0x40</span><br><span class="line">  4)     4256      16   dma_map_page_attrs+0x36/0x38 [i40e]</span><br><span class="line">  5)     4240     184   i40e_lan_xmit_frame+0x115b/0x13b0 [i40e]</span><br><span class="line">  6)     4056     120   dev_hard_start_xmit+0x246/0x3b0</span><br><span class="line">  7)     3936      80   sch_direct_xmit+0x11a/0x250</span><br><span class="line">  8)     3856     112   __dev_queue_xmit+0x4a1/0x660</span><br><span class="line">  9)     3744      16   dev_queue_xmit+0x10/0x20</span><br><span class="line"> 10)     3728      32   bond_dev_queue_xmit+0x32/0x80 [bonding]</span><br><span class="line"> 11)     3696      72   bond_start_xmit+0x1be/0x420 [bonding]</span><br><span class="line"> 12)     3624     120   dev_hard_start_xmit+0x246/0x3b0</span><br><span class="line"> 13)     3504     120   __dev_queue_xmit+0x529/0x660</span><br><span class="line"> 14)     3384      16   dev_queue_xmit+0x10/0x20</span><br></pre></td></tr></table></figure>
</li>
<li><p>trace-cmd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$ trace-cmd record -e sched:sched_migrate_task ./stream</span><br><span class="line">$ trace-cmd report</span><br><span class="line">...</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137530 prio=120 orig_cpu=0 dest_cpu=8</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137531 prio=120 orig_cpu=0 dest_cpu=16</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137532 prio=120 orig_cpu=0 dest_cpu=24</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137533 prio=120 orig_cpu=0 dest_cpu=32</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137534 prio=120 orig_cpu=0 dest_cpu=40</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137535 prio=120 orig_cpu=0 dest_cpu=48</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137536 prio=120 orig_cpu=0 dest_cpu=56</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137537 prio=120 orig_cpu=0 dest_cpu=64</span><br><span class="line">stream-nnn x: sched_migrate_task: comm=stream pid=137538 prio=120 orig_cpu=0 dest_cpu=72</span><br><span class="line"></span><br><span class="line">$ less /syskernel/debug/tracing/available_events</span><br><span class="line">$ trace-cmd record -e tcp:tcp_destroy_sock</span><br><span class="line"></span><br><span class="line">$ yum -y install trace-cmd</span><br><span class="line">$ trace-cmd ls -l</span><br><span class="line">$ trace-cmd record -p function ls -l</span><br><span class="line">$ trace-cmd record -p function -l &#x27;sched*&#x27; myapp</span><br><span class="line">$ trace-cmd record -e sched_wakeup ls /bin</span><br><span class="line">$ trace-cmd report </span><br><span class="line"></span><br><span class="line">#enable all irq events</span><br><span class="line">$ trace-cmd start -e irq</span><br><span class="line">$ trace-cmd start -p wakeup_rt</span><br><span class="line">$ trace-cmd start -p preemptirqsoff -d</span><br><span class="line">$ trace-cmd start -p nop</span><br><span class="line"></span><br><span class="line">#userspace</span><br><span class="line">$ trace-cmd record -F --max-graph-depth 5 -r 20 -m $((1024*1024)) -p function_graph -g __uprobe_register trace-bpfcc &#x27;c:reallocarray &quot;%d, %d&quot;, arg2, arg3&#x27;</span><br><span class="line">$ trace-cmd record -F -r 20 -m $((1024*1024)) -p function_graph -g do_syscall_64 test/mymem</span><br><span class="line">$ trace-cmd record -F --max-graph-depth 5 -r 20 -m $((1024*1024)) -p function_graph -g uprobe_mmap ./mymem</span><br><span class="line">$ trace-cmd report | grep uprobe | sed &#x27;s/.*|//&#x27; | sort | uniq -c</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">tracefs=`sed -ne &#x27;s/^tracefs \(.*\) tracefs.*/\1/p&#x27; /proc/mounts`</span><br><span class="line">echo nop &gt; $tracefs/tracing/current_tracer</span><br><span class="line">echo 0 &gt; $tracefs/tracing/tracing_on</span><br><span class="line">echo $$ &gt; $tracefs/tracing/set_ftrace_pid</span><br><span class="line">echo function &gt; $tracefs/tracing/current_tracer</span><br><span class="line">echo 1 &gt; $tracefs/tracing/tracing_on</span><br><span class="line">exec &quot;your command&quot;</span><br><span class="line"></span><br><span class="line">#installaion</span><br><span class="line">$ sudo apt-get install build-essential git cmake libjson-c-dev -y</span><br><span class="line">$ sudo apt-get install freeglut3-dev libxmu-dev libxi-dev -y</span><br><span class="line">$ sudo apt-get install qtbase5-dev -y</span><br><span class="line"></span><br><span class="line">$ git clone https://git.kernel.org/pub/scm/utils/trace-cmd/trace-cmd.git/</span><br><span class="line"></span><br><span class="line">$ cd trace-cmd</span><br><span class="line">$ make gui</span><br><span class="line">$ sudo make install_gui</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">$ apt install trace-cmd kernelshark</span><br><span class="line">$ trace-cmd record -p function_graph -l vfs_* -F cp -a ~ /tmp</span><br><span class="line">$ trace-cmd record -p function_graph -l vfs_* -P $pid</span><br><span class="line"></span><br><span class="line">-l func。实际对应set_ftrace_filter，这种方式插桩的开销较小，只会追踪顶层func的执行时间且支持*等通配符的设置。</span><br><span class="line">-g func。实际对应set_graph_function，这种方式插桩的开销较大，但能追踪func以及func所有子函数的的执行时间，不支持*等通配符的设置。</span><br><span class="line"></span><br><span class="line">$ trace-cmd report | less</span><br><span class="line">$ trace-cmd report --profile</span><br><span class="line">task: cp-3484   # process name and PID</span><br><span class="line">#comments#      func       numbers   total time(ns)  AVG (ns)   MAX(ns)(timestamp sec)         MIN(ns)(timestamp sec)</span><br><span class="line">  Event: func: vfs_read() (6017) Total: 565900849 Avg: 94050 Max: 1827017(ts:20010.738236) Min:203(ts:20010.130418)</span><br><span class="line">  Event: func: vfs_write() (3520) Total: 319047851 Avg: 90638 Max: 591045(ts:20010.398434) Min:3437(ts:20011.032217)</span><br><span class="line">  Event: func: vfs_statx() (3865) Total: 49642741 Avg: 12844 Max: 1411479(ts:20010.626101) Min:924(ts:20010.718592)</span><br><span class="line"></span><br><span class="line">$ trace-cmd record -p function_graph -g vfs_read -F cp -r  ~ /tmp</span><br><span class="line">$ trace-cmd report</span><br><span class="line"></span><br><span class="line">use kernelshark open the trace.dat</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.sysnote.org/2017/03/15/error-disk-cause-iohang/">disk iohang</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t debugfs debugfs /sys/kernel/debug</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/events/scsi/scsi_dispatch_cmd_start/enable</span><br><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/events/scsi/scsi_dispatch_cmd_timeout/enable</span><br><span class="line"></span><br><span class="line">## filter</span><br><span class="line">grep &quot;host_no=7 channel=0 id=0 lun=0&quot; /sys/kernel/debug/tracing/trace</span><br></pre></td></tr></table></figure>

</li>
<li><p><a target="_blank" rel="noopener" href="https://alex.dzyoba.com/blog/ftrace/">trace func</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/function_profile_enabled <span class="comment">#disable echo 0 &gt; /sys/kernel/debug/tracing/function_profile_enabled</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/set_ftrace_pid           </span><br><span class="line">$ <span class="built_in">echo</span> <span class="keyword">function</span> &gt; /sys/kernel/debug/tracing/current_tracer    <span class="comment">#disable echo nop &gt; /sys/kernel/debug/tracing/current_tracer </span></span><br><span class="line">$ <span class="built_in">head</span> -n 50 /sys/kernel/debug/tracing/trace_stat/function*</span><br><span class="line">==&gt; /sys/kernel/debug/tracing/trace_stat/function0 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  __schedule                            1004    424211517 us     422521.4 us     17601753507 us</span><br><span class="line">  schedule                               542    424172166 us     782605.4 us     23119611005 us</span><br><span class="line">  schedule_hrtimeout_range               264    201278707 us     762419.3 us     40470986591 us</span><br><span class="line">  schedule_hrtimeout_range_clock         264    201278664 us     762419.1 us     40470941242 us</span><br><span class="line">  poll_schedule_timeout                  208    146273699 us     703238.9 us     30082886685 us</span><br><span class="line">  SyS_select                             296    76242461 us     257575.8 us     51092210753 us</span><br><span class="line">  core_sys_select                        296    76242195 us     257574.9 us     51091414780 us</span><br><span class="line"></span><br><span class="line"><span class="comment"># To make it clearer we can disable so called graph time so that child functions wouldn’t be counted</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/options/graph-time</span><br><span class="line">$ <span class="built_in">echo</span> | <span class="built_in">tee</span> -a /sys/kernel/debug/tracing/trace_stat/function*</span><br><span class="line">$ <span class="built_in">head</span> -n 10 /sys/kernel/debug/tracing/trace_stat/function*</span><br><span class="line">==&gt; /sys/kernel/debug/tracing/trace_stat/function0 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  __schedule                            6586    3493426826 us     530432.2 us     271324795 us</span><br><span class="line">  schedule                              3490    3118337477 us     893506.4 us     1717930404 us</span><br><span class="line">  schedule_hrtimeout_range              1108    1506870637 us     1359991 us     6593324008 us</span><br><span class="line">  schedule_hrtimeout_range_clock        1108    1506870506 us     1359991 us     6593133305 us</span><br><span class="line">  poll_schedule_timeout                  840    1025345543 us     1220649 us     18642402990 us</span><br><span class="line">  SyS_select                             825    437363345 us     530137.3 us     12611719967 us</span><br><span class="line">  core_sys_select                        825    437362674 us     530136.5 us     12610519710 us</span><br><span class="line">  do_select                              825    437361912 us     530135.6 us     12608400043 us</span><br><span class="line"></span><br><span class="line">==&gt; /sys/kernel/debug/tracing/trace_stat/function1 &lt;==</span><br><span class="line">  Function                               Hit    Time            Avg             s^2</span><br><span class="line">  --------                               ---    ----            ---             ---</span><br><span class="line">  __schedule                           11031    4106228674 us     372244.4 us     1590893038 us</span><br><span class="line">  schedule                              5926    3695495645 us     623607.0 us     167605838 us</span><br><span class="line">  schedule_hrtimeout_range              1099    1312775101 us     1194517 us     13265124430 us</span><br><span class="line">  schedule_hrtimeout_range_clock        1099    1312774839 us     1194517 us     13264918243 us</span><br><span class="line">  schedule_timeout                      1609    835424509 us     519219.7 us     1378549148 us</span><br><span class="line">  poll_schedule_timeout                  617    618532655 us     1002484 us     25003732733 us</span><br><span class="line">  SyS_nanosleep                           79    469837858 us     5947314 us     31161565191 us</span><br><span class="line">  hrtimer_nanosleep                       79    469837771 us     5947313 us     31158927441 us</span><br></pre></td></tr></table></figure></li>
</ul>
<p>The syscall too high than normal server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alloc_pages_current  4.854 2259.836us</span><br><span class="line">handle_mm_fault 11.994 123.722us</span><br></pre></td></tr></table></figure>

<ul>
<li>test <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_curr_state_one</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the print current state one function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_curr_state_two</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the print current state two function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">exchg2</span><span class="params">(<span class="type">int</span> px, <span class="type">int</span> *py)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> tmp = px;</span><br><span class="line">   px = *py;</span><br><span class="line">   *py = tmp;</span><br><span class="line">   <span class="type">int</span> reval=<span class="number">22</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;*px = %d, *py = %d. reval = %d\n&quot;</span>, px, *py, reval);</span><br><span class="line">   <span class="keyword">return</span> reval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> a = <span class="number">4</span>;</span><br><span class="line">   <span class="type">int</span> b = <span class="number">6</span>;</span><br><span class="line">   <span class="type">int</span> c = exchg2(a, &amp;b);</span><br><span class="line">    exchg2(a, &amp;b);</span><br><span class="line">   <span class="comment">//while (1) &#123;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a = %d, b = %d, c = %d.\n&quot;</span>, a, b, c);</span><br><span class="line">        print_curr_state_one();</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        print_curr_state_two();</span><br><span class="line">   <span class="comment">//&#125;</span></span><br><span class="line">        <span class="keyword">return</span>(<span class="number">11</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;p:uprobes/exchg2_entry /root/test:0x0005dd arg1=%ip arg2=%ax&quot;</span> &gt; /sys/kernel/debug/tracing/uprobe_events</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;r:uprobes/exchg2_exit /root/test:0x0005dd arg1=%ip arg2=%ax&quot;</span> &gt;&gt; /sys/kernel/debug/tracing/uprobe_events</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/events/uprobes/exchg2_entry/format</span><br><span class="line">name: exchg2_entry</span><br><span class="line">ID: 1525</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_ip; offset:8;       size:8; signed:0;</span><br><span class="line">        field:u64 arg1; offset:16;      size:8; signed:0;</span><br><span class="line">        field:u64 arg2; offset:24;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">fmt</span>: <span class="string">&quot;(%lx) arg1=0x%Lx arg2=0x%Lx&quot;</span>, REC-&gt;__probe_ip, REC-&gt;arg1, REC-&gt;arg2</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/events/uprobes/exchg2_exit/format</span><br><span class="line">name: exchg2_exit</span><br><span class="line">ID: 1526</span><br><span class="line">format:</span><br><span class="line">        field:unsigned short common_type;       offset:0;       size:2; signed:0;</span><br><span class="line">        field:unsigned char common_flags;       offset:2;       size:1; signed:0;</span><br><span class="line">        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;</span><br><span class="line">        field:int common_pid;   offset:4;       size:4; signed:1;</span><br><span class="line"></span><br><span class="line">        field:unsigned long __probe_func;       offset:8;       size:8; signed:0;</span><br><span class="line">        field:unsigned long __probe_ret_ip;     offset:16;      size:8; signed:0;</span><br><span class="line">        field:u64 arg1; offset:24;      size:8; signed:0;</span><br><span class="line">        field:u64 arg2; offset:32;      size:8; signed:0;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">fmt</span>: <span class="string">&quot;(%lx &lt;- %lx) arg1=0x%Lx arg2=0x%Lx&quot;</span>, REC-&gt;__probe_func, REC-&gt;__probe_ret_ip, REC-&gt;arg1, REC-&gt;arg2</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/uprobes/enable</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line"><span class="comment"># tracer: nop</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># entries-in-buffer/entries-written: 4/4   #P:4</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#                              _-----=&gt; irqs-off</span></span><br><span class="line"><span class="comment">#                             / _----=&gt; need-resched</span></span><br><span class="line"><span class="comment">#                            | / _---=&gt; hardirq/softirq</span></span><br><span class="line"><span class="comment">#                            || / _--=&gt; preempt-depth</span></span><br><span class="line"><span class="comment">#                            ||| /     delay</span></span><br><span class="line"><span class="comment">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span></span><br><span class="line"><span class="comment">#              | |       |   ||||       |         |</span></span><br><span class="line">            test-29260 [002] d...   714.441252: exchg2_entry: (0x4005dd) arg1=0x4005dd arg2=0x4</span><br><span class="line">            test-29260 [002] d...   714.441314: exchg2_exit: (0x400654 &lt;- 0x4005dd) arg1=0x400654 arg2=0x16</span><br><span class="line">            test-29260 [002] d...   714.441316: exchg2_entry: (0x4005dd) arg1=0x4005dd arg2=0x4</span><br><span class="line">            test-29260 [002] d...   714.441324: exchg2_exit: (0x400668 &lt;- 0x4005dd) arg1=0x400668 arg2=0x16</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#define ENOSPC  28 /* No space left on device */</span><br><span class="line"></span><br><span class="line">$ syscount-bpfcc -e ENOSPC -P</span><br><span class="line">PID    COMM               COUNT</span><br><span class="line">3010   dockerd                1</span><br><span class="line"></span><br><span class="line"># from perf-tool</span><br><span class="line">$ ./funcgraph -m 2 __arm64_sys_mount</span><br><span class="line">$ ./funcgraph -m 5 path_mount &gt; path_mount.log</span><br><span class="line"></span><br><span class="line">$  sudo trace-bpfcc &#x27;r::__arm64_sys_mount() &quot;%llx&quot;, retval&#x27;  \</span><br><span class="line">          &#x27;r::path_mount &quot;%llx&quot;, retval&#x27; \</span><br><span class="line">                   &#x27;r::do_new_mount &quot;%llx&quot;, retval&#x27; \</span><br><span class="line">                   &#x27;r::do_add_mount &quot;%llx&quot;, retval&#x27;\</span><br><span class="line">                   &#x27;r::graft_tree &quot;%llx&quot;, retval&#x27; \</span><br><span class="line">                   &#x27;r::attach_recursive_mnt &quot;%llx&quot; retval&#x27;\</span><br><span class="line">                   &#x27;r::count_mounts &quot;%llx&quot;, retval&#x27;</span><br><span class="line">PID     TID     COMM            FUNC             -</span><br><span class="line">3010    3017    dockerd         graft_tree       ffffffe4</span><br><span class="line">3010    3017    dockerd         attach_recursive_mnt ffffffe4</span><br><span class="line">3010    3017    dockerd         count_mounts     ffffffe4 --------------- -28 = ENOSPC</span><br><span class="line">3010    3017    dockerd         __arm64_sys_mount ffffffffffffffe4</span><br><span class="line">3010    3017    dockerd         path_mount       ffffffe4</span><br><span class="line">3010    3017    dockerd         do_new_mount     ffffffe4</span><br><span class="line">3010    3017    dockerd         do_add_mount     ffffffe4</span><br><span class="line"></span><br><span class="line">int count_mounts(struct mnt_namespace *ns, struct mount *mnt)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> unsigned int max = READ_ONCE(sysctl_mount_max);</span><br><span class="line"> unsigned int mounts = 0, old, pending, sum;</span><br><span class="line"> struct mount *p;</span><br><span class="line"></span><br><span class="line"> for (p = mnt; p; p = next_mnt(p, mnt))</span><br><span class="line">  mounts++;</span><br><span class="line"></span><br><span class="line"> old = ns-&gt;mounts;</span><br><span class="line"> pending = ns-&gt;pending_mounts;</span><br><span class="line"> sum = old + pending;</span><br><span class="line"> if ((old &gt; sum) ||</span><br><span class="line">     (pending &gt; sum) ||</span><br><span class="line">     (max &lt; sum) ||</span><br><span class="line">     (mounts &gt; (max - sum)))</span><br><span class="line">  return -ENOSPC;</span><br><span class="line"></span><br><span class="line"> ns-&gt;pending_mounts = pending + mounts;</span><br><span class="line"> return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat /proc/sys/fs/mount-max</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line">Why not print sysctl_mount_max ??</span><br><span class="line">https://mp.weixin.qq.com/s/bnaiD93ORNuPE73Z-T_gYg</span><br></pre></td></tr></table></figure>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable"><span class="toc-number">1.</span> <span class="toc-text">Enable</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/09/17/ftrace/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/09/17/ftrace/&text=ftrace"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/09/17/ftrace/&is_video=false&description=ftrace"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ftrace&body=Check out this article: http://example.com/2022/09/17/ftrace/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/09/17/ftrace/&title=ftrace"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/09/17/ftrace/&name=ftrace&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/09/17/ftrace/&t=ftrace"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

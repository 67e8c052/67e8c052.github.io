<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="RDMA RoCEv2 key feature zero-copy (FC not support) bypass-kernel (FC support) lossless network PFC(Priority-based Flow Control) over shreshold and send the “PFC pause frame”, until the value lower “sh">
<meta property="og:type" content="article">
<meta property="og:title" content="RDMA">
<meta property="og:url" content="http://example.com/2022/11/13/rdma/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="RDMA RoCEv2 key feature zero-copy (FC not support) bypass-kernel (FC support) lossless network PFC(Priority-based Flow Control) over shreshold and send the “PFC pause frame”, until the value lower “sh">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-13T07:49:55.000Z">
<meta property="article:modified_time" content="2024-02-26T02:37:27.036Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="network">
<meta property="article:tag" content="rdma">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>RDMA</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/13/ethernet/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/09/17/ftrace/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/rdma/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/rdma/&text=RDMA"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/rdma/&is_video=false&description=RDMA"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RDMA&body=Check out this article: http://example.com/2022/11/13/rdma/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/rdma/&name=RDMA&description=&lt;h3 id=&#34;RDMA&#34;&gt;&lt;a href=&#34;#RDMA&#34; class=&#34;headerlink&#34; title=&#34;RDMA&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://hustcat.github.io/queue-pair-in-rdma/&#34;&gt;RDMA&lt;/a&gt;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;RoCEv2 key feature&lt;ul&gt;
&lt;li&gt;zero-copy (FC not support)&lt;/li&gt;
&lt;li&gt;bypass-kernel (FC support)&lt;/li&gt;
&lt;li&gt;lossless network&lt;/li&gt;
&lt;li&gt;PFC(Priority-based Flow Control)&lt;ul&gt;
&lt;li&gt;over shreshold and send the “PFC pause frame”, until the value lower “shreshold” and send the “pause with zero duration”&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2022&#34;&gt;PFC class (diff level)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;coarse-grained, influence a lot&lt;/li&gt;
&lt;li&gt;VLAN-based PFC&lt;ul&gt;
&lt;li&gt;VLAN tag&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-1415&#34;&gt;HowTo Run RoCE and TCP over L2 Enabled with PFC&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;VLAN PFC 2 issues&lt;ul&gt;
&lt;li&gt;trunk mode for switch&lt;/li&gt;
&lt;li&gt;VLAN PCP could not transmit to L3, VLAN work in L2, try to import DSCP-based PFC&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DSCP-based PFC&lt;ul&gt;
&lt;li&gt;DSCP-based PFC requires both NICs and switches to classify and queue packets based on the DSCP value instead of the VLAN tag&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DSCP vs TOS&lt;ul&gt;
&lt;li&gt;The type of service (ToS) field in the IPv4 header has had various purposes over the years, and has been defined in different ways by five RFCs. The modern redefinition of the ToS field is a six-bit Differentiated Services Code Point (DSCP) field and a two-bit Explicit Congestion Notification (ECN) field. While Differentiated Services is somewhat backwards compatible with ToS, ECN is not.&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Type_of_service&#34;&gt;reference1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Differentiated_services&#34;&gt;reference2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;RDMA PFC issues&lt;ul&gt;
&lt;li&gt;RDMA transport livelock&lt;ul&gt;
&lt;li&gt;尽管PFC可以避免buffer overflow导致的丢包，但是，其它一些原因，比如FCS错误，也可能导致网络丢包。RDMA的go-back-0算法，每次出现丢包，都会导致整个message的所有packet都会重传，从而导致livelock。TCP有SACK算法，由于RDMA传输层在NIC实现，受限于硬件资源，NIC很难实现SACK算法。可以使用go-back-N算法来避免这个问题&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;PFC Deadlock&lt;ul&gt;
&lt;li&gt;当PFC机制与Ethernet的广播机制工作时，可能导致出现PFC Deadlock。简单来说，就是PFC机制会导致相应的port停止发包，而Ethernet的广播包可能引起新的PFC pause依赖（比如port对端的server down掉)，从而引起循环依赖。广播和多播对于loseless是非常危险的，建议不要将其归于loseless classes&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NIC PFC pause frame storm&lt;ul&gt;
&lt;li&gt;由于PFC pause是传递的，所以很容器引起pause frame storm。比如，NIC因为bug导致接收缓冲区填满，NIC会一直对外发送pause frame。需要在NIC端和交换机端使用watchdog机制来防止pause storm&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;The Slow-receiver symptom&lt;ul&gt;
&lt;li&gt;由于NIC的资源有限，它将大部分数据结构，比如QPC(Queue Pair Context) 和WQE (Work Queue Element)都放在host memory。而NIC只会缓存部分数据对象，一旦出现cache miss，NIC的处理速度就会下降&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## 将skb prio 0~7 映射到vlan prio 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &amp;#123;0..7&amp;#125;; &lt;span class=&#34;keyword&#34;&gt;do&lt;/span&gt; ip &lt;span class=&#34;built_in&#34;&gt;link&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt; dev eth1.100 &lt;span class=&#34;built_in&#34;&gt;type&lt;/span&gt; vlan egress-qos-map &lt;span class=&#34;variable&#34;&gt;$i&lt;/span&gt;:3 ; &lt;span class=&#34;keyword&#34;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## enable PFC on TC3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mlnx_qos -i eth1 -f 0,0,0,1,0,0,0,0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@node1 ~]&lt;span class=&#34;comment&#34;&gt;# cat /proc/net/vlan/eth1.100 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eth1.100  VID: 100       REORDER_HDR: 1  dev-&amp;gt;priv_flags: 1001&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         total frames received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          total bytes received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      Broadcast/Multicast Rcvd            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      total frames transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       total bytes transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Device: eth1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; EGRESS priority mappings: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@node1 ~]&lt;span class=&#34;comment&#34;&gt;# for i in &amp;#123;0..7&amp;#125;; do ip link set dev eth1.100 type vlan egress-qos-map $i:3 ; done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@node1 ~]&lt;span class=&#34;comment&#34;&gt;# cat /proc/net/vlan/eth1.100                                                      &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eth1.100  VID: 100       REORDER_HDR: 1  dev-&amp;gt;priv_flags: 1001&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         total frames received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          total bytes received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      Broadcast/Multicast Rcvd            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      total frames transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       total bytes transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Device: eth1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; EGRESS priority mappings: 0:3 1:3 2:3 3:3 4:3 5:3 6:3 7:3 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HowTo Set Egress Priority VLAN on Linux&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;https://community.mellanox.com/docs/DOC-2311&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Congestion Control (DCQCN)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;base Explicit Congestion Notification (ECN)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2321&#34;&gt;Understanding RoCEv2 Congestion Management&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ECN in RoCEv2&lt;ul&gt;
&lt;li&gt;RoCEv2引入了ECN机制来实现拥塞控制，即RoCEv2 Congestion Management (RCM)。通过RCM，一旦网络发生拥塞，就会通知发送端降低发送速率。与TCP类似，RoCEv2使用传输层头部Base Transport Header (BTH)的FECN标志位来标识拥塞&lt;/li&gt;
&lt;li&gt;如果收到IP.ECN为11的包，HCA生成一个RoCEv2 CNP(Congestion Notification Packet)包，返回给发送端&lt;/li&gt;
&lt;li&gt;如果收到RoCEv2 CNP包，则降低对应QP的发送速率&lt;/li&gt;
&lt;li&gt;从上一次收到RoCEv2 CNP后，经过配置的时间或者字节数，HCA可以增加对应QP的发送速率&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;RP (Injector)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reaction Point - the end node that performs rate limitation to prevent congestion&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;NP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Notification Point - the end node that receives the packets from the injector and sends back notifications to the injector for indications regarding the congestion situation&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Congestion Point - the switch queue in which congestion happens&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CNP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The RoCEv2 Congestion Notification Packet - The notification message an NP sends to the RP when it receives CE marked packets&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;[Congestion Control Loop](&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2321#jive_content_id_Congestion_Control_Loop]&#34;&gt;https://community.mellanox.com/docs/DOC-2321#jive_content_id_Congestion_Control_Loop]&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2733&#34;&gt;How To Configure RoCE over a Lossless Fabric (PFC + ECN) End-to-End Using ConnectX-4 and Spectrum (Trust L2)&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ECN with TCP&amp;#x2F;IP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ECN是一个端到端的拥塞通知机制，而不需要丢包。ECN是可选的特性，它需要端点开启ECN支持，同时底层的网络也需要支持。&lt;/li&gt;
&lt;li&gt;传统的TCP&amp;#x2F;IP网络，通过丢包来表明网络拥塞，router&amp;#x2F;switch&amp;#x2F;server都会这么做。而对于支持ECN的路由器，当发生网络拥塞时，会设置IP头部的ECN(2bits)标志位，而接收端会给发送端返回拥塞的通知(echo of the congestion indication)，然后发送端降低发送速率。由于发送速率由传输层(TCP)控制，所以，ECN需要TCP和IP层同时配合。rfc3168定义了ECN for TCP&amp;#x2F;IP。&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ECN with IP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;IP头部有2个bit的ECN标志位：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;00 – Non ECN-Capable Transport, Non-ECT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10 – ECN Capable Transport, ECT(0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;01 – ECN Capable Transport, ECT(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11 – Congestion Encountered, CE.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;ECN with TCP&lt;ul&gt;
&lt;li&gt;为了支持ECN，TCP使用了TCP头部的3个标志位：Nonce Sum (NS)，ECN-Echo (ECE)和Congestion Window Reduced (CWR)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2894&#34;&gt;IP&amp;#x2F;Ethernet&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;By using PCP bits on the VLAN header&lt;/li&gt;
&lt;li&gt;By using DSCP bits on the IP header&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CA(Channel Adapter)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CM(Communication Manager)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;QP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Send Queue(SQ)&lt;/li&gt;
&lt;li&gt;Receive Queue(RQ)&lt;/li&gt;
&lt;li&gt;RC (Reliable Connected)&lt;/li&gt;
&lt;li&gt;struct ibv_qp *ibv_create_qp&lt;/li&gt;
&lt;li&gt;struct ib_qp&lt;/li&gt;
&lt;li&gt;struct mlx4_ib_qp&lt;/li&gt;
&lt;li&gt;QP status&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L842&#34;&gt;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L842&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L2131&#34;&gt;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L2131&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;RESET  Newly created, queues empty.&lt;/li&gt;
&lt;li&gt;INIT   Basic information set. Ready for posting to receive queue.&lt;/li&gt;
&lt;li&gt;RTR    Ready to Receive. Remote address info set for connected QPs, QP may now receive packets.&lt;/li&gt;
&lt;li&gt;RTS    Ready to Send. Timeout and retry parameters set, QP may now send packets.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;BUGS&#34;&gt;&lt;a href=&#34;#BUGS&#34; class=&#34;headerlink&#34; title=&#34;BUGS&#34;&gt;&lt;/a&gt;BUGS&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://forums.developer.nvidia.com/t/mlnx-ofed-linux-5-7-1-mlx5-2-create-qp-pid-19774-create-qp-type-2-failed/232369&#34;&gt;infiniband mlx5_0: create_qp:3206:(pid 698661): Create QP type 2 failed&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;upgrade mlx5 dev firmware&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;&#34;&gt;&lt;a href=&#34;#&#34; class=&#34;headerlink&#34; title=&#34;&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://www.snia.org/sites/default/files/ESF/Optimizing-NVMe-Over-Fabrics-Performance-Final.pdf&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Default MTU is 1500B, Ethernet frame adds 18B, if not tagged, to make it 1518B maximum Ethernet frame&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;If Jumbo Frame is supported, maximum Ethernet frame can be 9000B&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Many modern OSes force the MTU transmission, regardless of upper level data size, for efficiency&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Caveat: Jumbo Frame needs to be enabled on both Initiator, Target and all network devices along the path&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://docs.nvidia.com/networking/display/mlnxofedv543580/rdma+over+converged+ethernet+(roce)#src-96900067_safe-id-UkRNQW92ZXJDb252ZXJnZWRFdGhlcm5ldChSb0NFKS1TZXR0aW5ndGhlUm9DRU1vZGVmb3JhUXVldWVQYWlyKFFQKQ&#34;&gt;RDMA over Converged Ethernet (RoCE)&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Packages-loss&#34;&gt;&lt;a href=&#34;#Packages-loss&#34; class=&#34;headerlink&#34; title=&#34;Packages loss&#34;&gt;&lt;/a&gt;Packages loss&lt;/h3&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/rdma/&t=RDMA"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDMA"><span class="toc-number">1.</span> <span class="toc-text">RDMA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BUGS"><span class="toc-number">2.</span> <span class="toc-text">BUGS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Packages-loss"><span class="toc-number">4.</span> <span class="toc-text">Packages loss</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAG-with-Mellanox-RoCEv2"><span class="toc-number">4.1.</span> <span class="toc-text">LAG with Mellanox RoCEv2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initialization-broadcom-mellanox-RoCEv2-driver-under-AlmaLinux-8-5"><span class="toc-number">4.2.</span> <span class="toc-text">initialization broadcom&#x2F;mellanox RoCEv2 driver under AlmaLinux 8.5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Here-is-the-direct-access-and-pass-the-switch-test-result"><span class="toc-number">4.3.</span> <span class="toc-text">Here is the direct access and pass the switch test result</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lustre"><span class="toc-number">5.</span> <span class="toc-text">Lustre</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mellanox-hard-reset"><span class="toc-number">6.</span> <span class="toc-text">Mellanox hard reset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#broadcom"><span class="toc-number">7.</span> <span class="toc-text">broadcom</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NIC-upgrade-firmware"><span class="toc-number">7.1.</span> <span class="toc-text">NIC upgrade firmware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuring-Peer-Memory-Direct-with-BCM5750X-Network-Adapters-with-NCCL"><span class="toc-number">7.2.</span> <span class="toc-text">Configuring Peer Memory Direct with BCM5750X Network Adapters with NCCL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#broadcom-Switch-Configuration-for-RoCE"><span class="toc-number">7.3.</span> <span class="toc-text">broadcom Switch Configuration for RoCE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-server-over-RDMA-RoCEv2"><span class="toc-number">8.</span> <span class="toc-text">NFS server over RDMA&#x2F;RoCEv2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Configure-mellanox-tools-and-Set-Up-Lossless-Configuration"><span class="toc-number">9.</span> <span class="toc-text">Configure mellanox tools and Set Up Lossless Configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcpdump-rdma-rocev2"><span class="toc-number">10.</span> <span class="toc-text">tcpdump rdma rocev2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soft-RoCE"><span class="toc-number">11.</span> <span class="toc-text">Soft-RoCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rdma-technology-features"><span class="toc-number">12.</span> <span class="toc-text">rdma-technology-features</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RDMA
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-13T07:49:55.000Z" itemprop="datePublished">2022-11-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Network/">Network</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/network/" rel="tag">network</a>, <a class="tag-link-link" href="/tags/rdma/" rel="tag">rdma</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="RDMA"><a href="#RDMA" class="headerlink" title="RDMA"></a><a target="_blank" rel="noopener" href="https://hustcat.github.io/queue-pair-in-rdma/">RDMA</a></h3><ul>
<li>RoCEv2 key feature<ul>
<li>zero-copy (FC not support)</li>
<li>bypass-kernel (FC support)</li>
<li>lossless network</li>
<li>PFC(Priority-based Flow Control)<ul>
<li>over shreshold and send the “PFC pause frame”, until the value lower “shreshold” and send the “pause with zero duration”</li>
<li><a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-2022">PFC class (diff level)</a></li>
<li>coarse-grained, influence a lot</li>
<li>VLAN-based PFC<ul>
<li>VLAN tag</li>
<li><a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-1415">HowTo Run RoCE and TCP over L2 Enabled with PFC</a></li>
<li>VLAN PFC 2 issues<ul>
<li>trunk mode for switch</li>
<li>VLAN PCP could not transmit to L3, VLAN work in L2, try to import DSCP-based PFC</li>
</ul>
</li>
</ul>
</li>
<li>DSCP-based PFC<ul>
<li>DSCP-based PFC requires both NICs and switches to classify and queue packets based on the DSCP value instead of the VLAN tag</li>
</ul>
</li>
<li>DSCP vs TOS<ul>
<li>The type of service (ToS) field in the IPv4 header has had various purposes over the years, and has been defined in different ways by five RFCs. The modern redefinition of the ToS field is a six-bit Differentiated Services Code Point (DSCP) field and a two-bit Explicit Congestion Notification (ECN) field. While Differentiated Services is somewhat backwards compatible with ToS, ECN is not.<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Type_of_service">reference1</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Differentiated_services">reference2</a></li>
</ul>
</li>
</ul>
</li>
<li>RDMA PFC issues<ul>
<li>RDMA transport livelock<ul>
<li>尽管PFC可以避免buffer overflow导致的丢包，但是，其它一些原因，比如FCS错误，也可能导致网络丢包。RDMA的go-back-0算法，每次出现丢包，都会导致整个message的所有packet都会重传，从而导致livelock。TCP有SACK算法，由于RDMA传输层在NIC实现，受限于硬件资源，NIC很难实现SACK算法。可以使用go-back-N算法来避免这个问题</li>
</ul>
</li>
<li>PFC Deadlock<ul>
<li>当PFC机制与Ethernet的广播机制工作时，可能导致出现PFC Deadlock。简单来说，就是PFC机制会导致相应的port停止发包，而Ethernet的广播包可能引起新的PFC pause依赖（比如port对端的server down掉)，从而引起循环依赖。广播和多播对于loseless是非常危险的，建议不要将其归于loseless classes</li>
</ul>
</li>
<li>NIC PFC pause frame storm<ul>
<li>由于PFC pause是传递的，所以很容器引起pause frame storm。比如，NIC因为bug导致接收缓冲区填满，NIC会一直对外发送pause frame。需要在NIC端和交换机端使用watchdog机制来防止pause storm</li>
</ul>
</li>
<li>The Slow-receiver symptom<ul>
<li>由于NIC的资源有限，它将大部分数据结构，比如QPC(Queue Pair Context) 和WQE (Work Queue Element)都放在host memory。而NIC只会缓存部分数据对象，一旦出现cache miss，NIC的处理速度就会下降</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 将skb prio 0~7 映射到vlan prio 3</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..7&#125;; <span class="keyword">do</span> ip <span class="built_in">link</span> <span class="built_in">set</span> dev eth1.100 <span class="built_in">type</span> vlan egress-qos-map <span class="variable">$i</span>:3 ; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## enable PFC on TC3</span></span><br><span class="line">mlnx_qos -i eth1 -f 0,0,0,1,0,0,0,0</span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># cat /proc/net/vlan/eth1.100 </span></span><br><span class="line">eth1.100  VID: 100       REORDER_HDR: 1  dev-&gt;priv_flags: 1001</span><br><span class="line">         total frames received            0</span><br><span class="line">          total bytes received            0</span><br><span class="line">      Broadcast/Multicast Rcvd            0</span><br><span class="line"></span><br><span class="line">      total frames transmitted            0</span><br><span class="line">       total bytes transmitted            0</span><br><span class="line">Device: eth1</span><br><span class="line">INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0</span><br><span class="line"> EGRESS priority mappings: </span><br><span class="line">[root@node1 ~]<span class="comment"># for i in &#123;0..7&#125;; do ip link set dev eth1.100 type vlan egress-qos-map $i:3 ; done</span></span><br><span class="line">[root@node1 ~]<span class="comment"># cat /proc/net/vlan/eth1.100                                                      </span></span><br><span class="line">eth1.100  VID: 100       REORDER_HDR: 1  dev-&gt;priv_flags: 1001</span><br><span class="line">         total frames received            0</span><br><span class="line">          total bytes received            0</span><br><span class="line">      Broadcast/Multicast Rcvd            0</span><br><span class="line"></span><br><span class="line">      total frames transmitted            0</span><br><span class="line">       total bytes transmitted            0</span><br><span class="line">Device: eth1</span><br><span class="line">INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0</span><br><span class="line"> EGRESS priority mappings: 0:3 1:3 2:3 3:3 4:3 5:3 6:3 7:3 </span><br><span class="line"></span><br><span class="line">HowTo Set Egress Priority VLAN on Linux</span><br><span class="line">https://community.mellanox.com/docs/DOC-2311</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Congestion Control (DCQCN)</p>
<ul>
<li>base Explicit Congestion Notification (ECN)</li>
<li><a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-2321">Understanding RoCEv2 Congestion Management</a></li>
<li>ECN in RoCEv2<ul>
<li>RoCEv2引入了ECN机制来实现拥塞控制，即RoCEv2 Congestion Management (RCM)。通过RCM，一旦网络发生拥塞，就会通知发送端降低发送速率。与TCP类似，RoCEv2使用传输层头部Base Transport Header (BTH)的FECN标志位来标识拥塞</li>
<li>如果收到IP.ECN为11的包，HCA生成一个RoCEv2 CNP(Congestion Notification Packet)包，返回给发送端</li>
<li>如果收到RoCEv2 CNP包，则降低对应QP的发送速率</li>
<li>从上一次收到RoCEv2 CNP后，经过配置的时间或者字节数，HCA可以增加对应QP的发送速率</li>
</ul>
</li>
</ul>
</li>
<li><p>RP (Injector)</p>
<ul>
<li>Reaction Point - the end node that performs rate limitation to prevent congestion</li>
</ul>
</li>
<li><p>NP</p>
<ul>
<li>Notification Point - the end node that receives the packets from the injector and sends back notifications to the injector for indications regarding the congestion situation</li>
</ul>
</li>
<li><p>CP</p>
<ul>
<li>Congestion Point - the switch queue in which congestion happens</li>
</ul>
</li>
<li><p>CNP</p>
<ul>
<li>The RoCEv2 Congestion Notification Packet - The notification message an NP sends to the RP when it receives CE marked packets</li>
</ul>
</li>
<li><p>[Congestion Control Loop](<a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-2321#jive_content_id_Congestion_Control_Loop]">https://community.mellanox.com/docs/DOC-2321#jive_content_id_Congestion_Control_Loop]</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-2733">How To Configure RoCE over a Lossless Fabric (PFC + ECN) End-to-End Using ConnectX-4 and Spectrum (Trust L2)</a></p>
</li>
<li><p>ECN with TCP&#x2F;IP</p>
<ul>
<li>ECN是一个端到端的拥塞通知机制，而不需要丢包。ECN是可选的特性，它需要端点开启ECN支持，同时底层的网络也需要支持。</li>
<li>传统的TCP&#x2F;IP网络，通过丢包来表明网络拥塞，router&#x2F;switch&#x2F;server都会这么做。而对于支持ECN的路由器，当发生网络拥塞时，会设置IP头部的ECN(2bits)标志位，而接收端会给发送端返回拥塞的通知(echo of the congestion indication)，然后发送端降低发送速率。由于发送速率由传输层(TCP)控制，所以，ECN需要TCP和IP层同时配合。rfc3168定义了ECN for TCP&#x2F;IP。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ECN with IP</span><br><span class="line">IP头部有2个bit的ECN标志位：</span><br><span class="line"></span><br><span class="line">00 – Non ECN-Capable Transport, Non-ECT</span><br><span class="line">10 – ECN Capable Transport, ECT(0)</span><br><span class="line">01 – ECN Capable Transport, ECT(1)</span><br><span class="line">11 – Congestion Encountered, CE.</span><br></pre></td></tr></table></figure></li>
<li>ECN with TCP<ul>
<li>为了支持ECN，TCP使用了TCP头部的3个标志位：Nonce Sum (NS)，ECN-Echo (ECE)和Congestion Window Reduced (CWR)</li>
</ul>
</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-2894">IP&#x2F;Ethernet</a></p>
<ul>
<li>By using PCP bits on the VLAN header</li>
<li>By using DSCP bits on the IP header</li>
</ul>
</li>
<li><p>CA(Channel Adapter)</p>
</li>
<li><p>CM(Communication Manager)</p>
</li>
<li><p>QP</p>
<ul>
<li>Send Queue(SQ)</li>
<li>Receive Queue(RQ)</li>
<li>RC (Reliable Connected)</li>
<li>struct ibv_qp *ibv_create_qp</li>
<li>struct ib_qp</li>
<li>struct mlx4_ib_qp</li>
<li>QP status<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L842">https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L842</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L2131">https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L2131</a></li>
<li>RESET  Newly created, queues empty.</li>
<li>INIT   Basic information set. Ready for posting to receive queue.</li>
<li>RTR    Ready to Receive. Remote address info set for connected QPs, QP may now receive packets.</li>
<li>RTS    Ready to Send. Timeout and retry parameters set, QP may now send packets.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="BUGS"><a href="#BUGS" class="headerlink" title="BUGS"></a>BUGS</h3><ul>
<li><a target="_blank" rel="noopener" href="https://forums.developer.nvidia.com/t/mlnx-ofed-linux-5-7-1-mlx5-2-create-qp-pid-19774-create-qp-type-2-failed/232369">infiniband mlx5_0: create_qp:3206:(pid 698661): Create QP type 2 failed</a><ul>
<li>upgrade mlx5 dev firmware</li>
</ul>
</li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a><a target="_blank" rel="noopener" href="https://www.snia.org/sites/default/files/ESF/Optimizing-NVMe-Over-Fabrics-Performance-Final.pdf"></a></h3><ul>
<li><p>Default MTU is 1500B, Ethernet frame adds 18B, if not tagged, to make it 1518B maximum Ethernet frame</p>
</li>
<li><p>If Jumbo Frame is supported, maximum Ethernet frame can be 9000B</p>
</li>
<li><p>Many modern OSes force the MTU transmission, regardless of upper level data size, for efficiency</p>
</li>
<li><p>Caveat: Jumbo Frame needs to be enabled on both Initiator, Target and all network devices along the path</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/mlnxofedv543580/rdma+over+converged+ethernet+(roce)#src-96900067_safe-id-UkRNQW92ZXJDb252ZXJnZWRFdGhlcm5ldChSb0NFKS1TZXR0aW5ndGhlUm9DRU1vZGVmb3JhUXVldWVQYWlyKFFQKQ">RDMA over Converged Ethernet (RoCE)</a></p>
</li>
</ul>
<h3 id="Packages-loss"><a href="#Packages-loss" class="headerlink" title="Packages loss"></a>Packages loss</h3><span id="more"></span>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Packages loss ---&gt;  Multiplicative-decrease</span><br><span class="line"></span><br><span class="line">sender ----1GbE------|</span><br><span class="line">                     |</span><br><span class="line">                     |------1GbE------receiver</span><br><span class="line">                     |&lt;-------packages loss</span><br><span class="line">sender ----1GbE------|</span><br></pre></td></tr></table></figure>
<ul>
<li>Enterprise switch<ul>
<li>Low buffer (xx MB)<ul>
<li>All ports share xx MB for the Multiplexing(多路复用)</li>
</ul>
</li>
<li><a href="https://link.zhihu.com/?target=https://people.csail.mit.edu/alizadeh/papers/dctcp-sigcomm10.pdf">Partition&#x2F;Aggregate</a><ul>
<li>N ports vs 1, 1 vs N ports ( Incast case )<ul>
<li>It ‘s easy cause flow backlog (流量积压)</li>
</ul>
</li>
</ul>
</li>
<li>The multi-path not balancing<ul>
<li>the flow go to the traffic jam link</li>
</ul>
</li>
</ul>
</li>
<li>RoCEv2<ul>
<li>PSN (Packet Sequence Number)<ul>
<li>Go back to N<ul>
<li>tx 0-5 packages, No 2 lost<ul>
<li>re-trans all packages (from 2 to 5, tcp only retrans 2)</li>
<li>that why RoCEv2 need the lossless L2&#x2F;L3 network</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>The RoCEv2 adapter depends PFC cause the lower efficiency</li>
<li>The adapter hardware BDP(Bandwidth Delay Product)<ul>
<li>Too low cause waste performance</li>
<li>Too high cause traffic jam</li>
<li>if the BDP value is not dynamic and the Multi flow pass the same path cause the not balancing and congestion</li>
<li>How to caculate ? in the 6us link<ul>
<li>2 x ToR 25GbE switch RTT&#x3D;(6us),BDP means 19K (25<em>1000</em>1000&#x2F;8(bit to KBytes) * (6&#x2F;1000&#x2F;1000 6us to seconds)&#x3D;18.75 KB)<ul>
<li>the Mellanox spectrum only 12MB buffer, 12000&#x2F;18.75&#x3D;640 (incast&#x3D;n vs 1, easy to decrease the bandwidth(egress drops) , 640 flow vs 1 , all ports share the 12MB buffer ) , if the situation less than 640 flows(Microburst), it means will cause the packages loss, you don ‘t need PFC setting</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Application limit</li>
<li>SDN center controller schdule the all bandwidth net(promising)</li>
</ul>
</li>
<li>Flow control<ul>
<li>Global pause<ul>
<li>work queue length trigger to stop all packages(XOFF Pause Frame)</li>
<li>contrinue by XON Frame</li>
</ul>
</li>
<li>PFC(Priority Flow Control) 802.1Qbb<ul>
<li>Each port has 8 x queue, diff priority<ul>
<li>switch send PFC Pause Frame </li>
<li>pause with zero duration to recovery</li>
<li><a target="_blank" rel="noopener" href="https://community.mellanox.com/docs/DOC-2022">https://community.mellanox.com/docs/DOC-2022</a></li>
</ul>
</li>
<li>P802.1Qcz - Congestion Isolation (CI)<ul>
<li>Improve PFC by isolating congested queues and reduce hop-by-hop head-of-line blocking</li>
</ul>
</li>
<li>issues<ul>
<li>Hop by hop flow control<ul>
<li>Head of line blocking</li>
<li>Fairness<ul>
<li>The pause frame work in the port + priotity, could not control to “the single flow”</li>
</ul>
</li>
<li>Congestion spreading</li>
<li>Buffer Bloat, increasing latency</li>
<li>Increased jitter reducing throughput</li>
<li>Deadlocks with some implementations (PFC strom)<ul>
<li>enable watchdog</li>
</ul>
</li>
<li>RDMA transport livelock<ul>
<li>packages loss&#x2F;error ,FCS error</li>
</ul>
</li>
<li>QPC(Queue Pair Context) &#x2F; WQE (Work Queue Element) in host memory</li>
</ul>
</li>
</ul>
</li>
<li>Benefits over PFC<ul>
<li>Use local switch telemetry to trigger back-to-sender signaling</li>
<li>Edge-to-edge FC signaling using L3 message</li>
<li>Removes head-of-line blocking completely from the network</li>
<li>SFC signaling directly to transport protocol end-point (per-flow)</li>
<li>Works with many types of transport protocols (RoCEv2, TCP, UDP)</li>
</ul>
</li>
<li>PFC of PCP(Priority Code Point)<ul>
<li>L2 VLAN tag</li>
</ul>
</li>
<li>PFC of DSCP<ul>
<li>eg: pxe no vlan header<ul>
<li>DSCP of ip header</li>
</ul>
</li>
<li>RoCE adapter support</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.ieee802.org/1/files/public/docs2022/new-blendin-SFC-sim-0522-v01.pdf">SFC Source Flow Control</a><ul>
<li>Signal from switch directly to traffic source</li>
<li>Remove head-of-line blocking from network</li>
<li>SFC w&#x2F; Proxy design to accelerate deployment</li>
<li>Does not require complex buffer tuning</li>
</ul>
</li>
</ul>
</li>
<li>Congestion control<ul>
<li>base the flow<ul>
<li>Congestion detect<ul>
<li>RTT(Round-Trip Time) base the latency<ul>
<li>RoCEv2<ul>
<li>DCQCN(Data Center Quantized Congestion Notification)<ul>
<li>Mellanox support<ul>
<li>extensions: pZTR-RTTCC(base rtt)](<a target="_blank" rel="noopener" href="https://developer.nvidia.com/zh-cn/blog/scaling-zero-touch-roce-technology-with-round-trip-time-congestion-control/#:~:text=%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E9%87%8F%E5%8C%96%E6%8B%A5%E5%A1%9E%E9%80%9A%E7%9F%A5%EF%BC%88%20DCQCN%20%EF%BC%89%E6%98%AF%E4%B8%80%E7%A7%8D%E6%8B%A5%E5%A1%9E,%E6%8C%87%E7%A4%BA%E5%8D%B3%E5%B0%86%E5%8F%91%E7%94%9F%E7%9A%84%E6%8B%A5%E5%A1%9E%E3%80%82">https://developer.nvidia.com/zh-cn/blog/scaling-zero-touch-roce-technology-with-round-trip-time-congestion-control/#:~:text=%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83%E9%87%8F%E5%8C%96%E6%8B%A5%E5%A1%9E%E9%80%9A%E7%9F%A5%EF%BC%88%20DCQCN%20%EF%BC%89%E6%98%AF%E4%B8%80%E7%A7%8D%E6%8B%A5%E5%A1%9E,%E6%8C%87%E7%A4%BA%E5%8D%B3%E5%B0%86%E5%8F%91%E7%94%9F%E7%9A%84%E6%8B%A5%E5%A1%9E%E3%80%82</a>)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Congestion point<ul>
<li>The queue depth large than X, update the ECN + RED flag the next receiver</li>
</ul>
</li>
<li>Respond point<ul>
<li>The adpater coordinate the send ratio</li>
</ul>
</li>
<li>Google Timely<ul>
<li>not depends the switch<ul>
<li>Just the first sender and the last receiver</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ECN(Explicit Congestion Notification) Normaly, ECN+PFC<ul>
<li>Differentiated Services of ip header</li>
<li>swtich support RED(random early drop, more fair) (switch support)<ul>
<li>The switch will update the package info(ENC 11, Congestion Encountered)when the traffic jam, the next receiver will know the status by the ENC flag.</li>
<li>When the ECN + RED, it ‘s not random packages loss, it ‘s the random add the ECN flag in these flow.</li>
</ul>
</li>
</ul>
</li>
<li>rfc3168—&gt;ECN for TCP&#x2F;IP<ul>
<li>传统的TCP&#x2F;IP网络，通过丢包来表明网络拥塞，router&#x2F;switch&#x2F;server都会这么做。而对于支持ECN的路由器，当发生网络拥塞时，会设置IP头部的ECN(2bits)标志位，而接收端会给发送端返回拥塞的通知(echo of the congestion indication)，然后发送端降低发送速率。</li>
<li>00 - Non ECN-Capable Transport, Non-ECT</li>
<li>10 - ECN Capable Transport, ECT(0)</li>
<li>01 - ECN Capable Transport, ECT(1)</li>
<li>11 - Congestion Encountered, CE.</li>
</ul>
</li>
<li>Package loss<ul>
<li>Not good for RoCEv2, tcp is OK</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="LAG-with-Mellanox-RoCEv2"><a href="#LAG-with-Mellanox-RoCEv2" class="headerlink" title="LAG with Mellanox RoCEv2"></a>LAG with Mellanox RoCEv2</h4><ul>
<li>active-backup (mode 1)</li>
<li>balance-xor (mode 2)</li>
<li>802.3ad (LACP) (mode 4)</li>
<li>Configure the ports in Ethernet mode</li>
<li>Install the MLNX_OFED Rel. 4.0 or later</li>
<li>Use Kernel 4.9 or later. Also RHEL7.4 and newer RHEL7.x include the support<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ifcfg-bond0</span><br><span class="line">BONDING_OPTS=<span class="string">&quot;mode=active-backup miimon=100 updelay=100 downdelay=100&quot;</span></span><br><span class="line"></span><br><span class="line">https://docs.nvidia.com/networking/display/mlnxofedv543580/rdma+over+converged+ethernet+(roce)<span class="comment">#src-96900067_safe-id-UkRNQW92ZXJDb252ZXJnZWRFdGhlcm5ldChSb0NFKS1TZXR0aW5ndGhlUm9DRU1vZGVmb3JhUXVldWVQYWlyKFFQKQ</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="initialization-broadcom-mellanox-RoCEv2-driver-under-AlmaLinux-8-5"><a href="#initialization-broadcom-mellanox-RoCEv2-driver-under-AlmaLinux-8-5" class="headerlink" title="initialization broadcom&#x2F;mellanox RoCEv2 driver under AlmaLinux 8.5"></a>initialization broadcom&#x2F;mellanox RoCEv2 driver under AlmaLinux 8.5</h4><p>BCM driver install failed with lustre kernel because the bad kernel-devel version   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Install lustre verision, the make rpms scripts will show some errors when the rpmbuild</span></span><br><span class="line">$ <span class="built_in">cd</span> ~/bcm_223.1.96.0/Linux/Linux_Driver/netxtreme-bnxt_en-1.10.2-223.0.162.0</span><br><span class="line"><span class="comment">#rocebuild in the makefile</span></span><br><span class="line"><span class="comment">#roceinstall</span></span><br><span class="line"><span class="comment">#roceclean</span></span><br><span class="line">$ make rocebuild</span><br><span class="line">$ make roceinstall</span><br><span class="line"></span><br><span class="line">$ more /etc/security/limits.d/rdma.conf</span><br><span class="line"><span class="comment"># configuration for rdma tuning</span></span><br><span class="line">*** soft memlock unlimited</span><br><span class="line">*** hard memlock unlimited</span><br><span class="line">$ yum install -y libibverbs-devel libibverbs pciutils-devel infiniband-diags perftest qperf librdmacm libibverbs-utils libusbx fuse-libs tcsh make valgrind-devel libnl3-devel cma createrepo  tk tcsh</span><br><span class="line">$ <span class="built_in">cd</span> bcm_223.1.96.0/Linux/KMP-L2-RoCE/KMP/Redhat/rhel7.9</span><br><span class="line"></span><br><span class="line">$ rpmbuild --rebuild bnxt_en-1.10.2-223.0.162.0.rhel7u9.src.rpm</span><br><span class="line">$ <span class="built_in">cd</span> ../../../../KMP-RoCE-Lib/KMP/Redhat/rhel7.9/</span><br><span class="line">$ rpmbuild --rebuild libbnxt_re-223.0.162.0-rhel7u9.src.rpm</span><br><span class="line">$ <span class="built_in">cd</span> /root/rpmbuild/RPMS/x86_64/</span><br><span class="line">$ rpm -ivh bnxt_en-debugsource-1.10.2-223.0.162.0.4.18.0.348.rt7.130.rhel8u5.x86_64.rpm     libbnxt_re-223.0.162.0-rhel8u5.x86_64.rpm bnxt_en-debugsource-1.10.2-223.0.162.0.4.18.0.348.rt7.130.rhel8u5.x86_64.rpm     libbnxt_re-223.0.162.0-rhel8u5.x86_64.rpmbnxt_en-doc-1.10.2-223.0.162.0.4.18.0.348.rt7.130.rhel8u5.x86_64.rpm             libbnxt_re-debuginfo-223.0.162.0-rhel8u5.x86_64.rpm kmod-bnxt_en-1.10.2-223.0.162.0.4.18.0.348.rt7.130.rhel8u5.x86_64.rpm            libbnxt_re-debugsource-223.0.162.0-rhel8u5.x86_64.rpm kmod-bnxt_en-debuginfo-1.10.2-223.0.162.0.4.18.0.348.rt7.130.rhel8u5.x86_64.rpm  libbnxt_re-devel-223.0.162.0-rhel8u5.x86_64.rpm</span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$ ibv_devices </span><br><span class="line">    device          	   node GUID</span><br><span class="line">    ------          	----------------</span><br><span class="line">    bnxt_re0        	b22628fffee04d10</span><br><span class="line">    bnxt_re1        	b22628fffee04d11</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ibv_devinfo </span></span><br><span class="line">hca_id:	bnxt_re0</span><br><span class="line">	transport:			InfiniBand (0)</span><br><span class="line">	fw_ver:				216.0.231.0</span><br><span class="line">	node_guid:			b226:28ff:fee0:4d10</span><br><span class="line">	sys_image_guid:			b226:28ff:fee0:4d10</span><br><span class="line">	vendor_id:			0x14e4</span><br><span class="line">	vendor_part_id:			5968</span><br><span class="line">	hw_ver:				0x2100</span><br><span class="line">	phys_port_cnt:			1</span><br><span class="line">		port:	1</span><br><span class="line">			state:			PORT_ACTIVE (4)</span><br><span class="line">			max_mtu:		4096 (5)</span><br><span class="line">			active_mtu:		4096 (5)</span><br><span class="line">			sm_lid:			0</span><br><span class="line">			port_lid:		0</span><br><span class="line">			port_lmc:		0x00</span><br><span class="line">			link_layer:		Ethernet</span><br><span class="line"></span><br><span class="line">hca_id:	bnxt_re1</span><br><span class="line">	transport:			InfiniBand (0)</span><br><span class="line">	fw_ver:				216.0.231.0</span><br><span class="line">	node_guid:			b226:28ff:fee0:4d11</span><br><span class="line">	sys_image_guid:			b226:28ff:fee0:4d11</span><br><span class="line">	vendor_id:			0x14e4</span><br><span class="line">	vendor_part_id:			5968</span><br><span class="line">	hw_ver:				0x2100</span><br><span class="line">	phys_port_cnt:			1</span><br><span class="line">		port:	1</span><br><span class="line">			state:			PORT_ACTIVE (4)</span><br><span class="line">			max_mtu:		4096 (5)</span><br><span class="line">			active_mtu:		4096 (5)</span><br><span class="line">			sm_lid:			0</span><br><span class="line">			port_lid:		0</span><br><span class="line">			port_lmc:		0x00</span><br><span class="line">			link_layer:		Ethernet</span><br><span class="line"></span><br><span class="line">Server A $ rping -s</span><br><span class="line">Server B $ rping -c -a 192.168.0.17 -v</span><br><span class="line">ping data: rdma-ping-0: ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqr</span><br><span class="line">ping data: rdma-ping-1: BCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrs</span><br><span class="line">ping data: rdma-ping-2: CDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrst</span><br><span class="line">ping data: rdma-ping-3: DEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstu</span><br><span class="line">ping data: rdma-ping-4: EFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuv</span><br><span class="line">ping data: rdma-ping-5: FGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvw</span><br><span class="line">ping data: rdma-ping-6: GHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwx</span><br><span class="line">ping data: rdma-ping-7: HIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxy</span><br><span class="line">ping data: rdma-ping-8: IJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz</span><br><span class="line">ping data: rdma-ping-9: JKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyzA</span><br><span class="line"></span><br><span class="line"><span class="comment">#qperf not test</span></span><br><span class="line"><span class="comment"># qperf -v -i mlx4_0:1 192.0.2.1 conf</span></span><br><span class="line">conf:</span><br><span class="line">loc_node = rdma-dev-01.lab.bos.redhat.com</span><br><span class="line">loc_cpu = 12 Cores: Mixed CPUs</span><br><span class="line">loc_os = Linux 4.18.0-187.el8.x86_64</span><br><span class="line">loc_qperf = 0.4.11</span><br><span class="line">rem_node = rdma-dev-00.lab.bos.redhat.com</span><br><span class="line"></span><br><span class="line">qperf -v -i mlx4_0:1 192.0.2.1 rc_bi_bw</span><br><span class="line">rc_bi_bw:</span><br><span class="line">bw = 10.7 GB/sec</span><br><span class="line">msg_rate = 163 K/sec</span><br><span class="line">loc_id = mlx4_0</span><br><span class="line">rem_id = mlx4_0:1</span><br><span class="line">loc_cpus_used = 65 % cpus</span><br><span class="line">rem_cpus_used = 62 % cpus</span><br><span class="line"></span><br><span class="line">qperf -v -i mlx4_0:1 192.0.2.1 rc_bw</span><br><span class="line">rc_bw:</span><br><span class="line">bw = 6.19 GB/sec</span><br><span class="line">msg_rate = 94.4 K/sec</span><br><span class="line">loc_id = mlx4_0</span><br><span class="line">rem_id = mlx4_0:1</span><br><span class="line">send_cost = 63.5 ms/GB</span><br><span class="line">recv_cost = 63 ms/GB</span><br><span class="line">send_cpus_used = 39.5 % cpus</span><br><span class="line">recv_cpus_used = 39 % cpus</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/bnxt_re/bnxt_re1/info</span><br><span class="line">bnxt_re debug info:</span><br><span class="line">=====[ IBDEV bnxt_re1 ]=============================</span><br><span class="line">        <span class="built_in">link</span> state: UP</span><br><span class="line">        Max QP:         65537</span><br><span class="line">        Max SRQ:        4096</span><br><span class="line">        Max CQ:         65536</span><br><span class="line">        Max MR:         262144</span><br><span class="line">        Max MW:         262144</span><br><span class="line">        Max AH:         65536</span><br><span class="line">        Max PD:         65536</span><br><span class="line"></span><br><span class="line">        Resize CQ count: 0</span><br><span class="line">        Recoverable Errors: 0</span><br><span class="line">        Rx Pkts: 85409154</span><br><span class="line">        Rx Bytes: 23134407928</span><br><span class="line">        Tx Pkts: 85409028</span><br><span class="line">        Tx Bytes: 22530881780</span><br><span class="line">        CNP Tx Pkts: 0 &lt;----------------如果收到IP.ECN为11的包，HCA生成一个RoCEv2 CNP(Congestion Notification Packet)包，返回给发送端； </span><br><span class="line">                                       (2) 如果收到RoCEv2 CNP包，则降低对应QP的发送速率； (3) 从上一次收到RoCEv2 CNP后，经过配置的时间或者字节数，HCA可以增加对应QP的发送速率。</span><br><span class="line">        CNP Rx Pkts: 0</span><br><span class="line">        RoCE Only Rx Pkts: 85409154</span><br><span class="line">        RoCE Only Rx Bytes: 23134407928</span><br><span class="line">        RoCE Only Tx Pkts: 85409028</span><br><span class="line">        RoCE Only Tx Bytes: 22530881780</span><br><span class="line"></span><br><span class="line"><span class="comment"># in this case, too many error in our layer 3</span></span><br><span class="line">	RoCE Only Rx Pkts: 14751422</span><br><span class="line">	RoCE Only Rx Bytes: 17993037060</span><br><span class="line">	RoCE Only Tx Pkts: 75556190</span><br><span class="line">	RoCE Only Tx Bytes: 306052685844</span><br><span class="line">	rx_roce_error_pkts: 323649</span><br><span class="line">	rx_roce_discard_pkts: 3008</span><br><span class="line">	to_retransmits: 449</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/class/infiniband/bnxt_re0/ports/1/gid_attrs/types/1</span><br><span class="line">RoCE v2</span><br><span class="line"></span><br><span class="line">$ <span class="comment">#check pkey</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/class/infiniband/bnxt_re*/ports/1/pkeys/* | grep -v <span class="string">&quot;0x0000&quot;</span></span><br><span class="line">0xffff</span><br><span class="line">0xffff</span><br><span class="line"></span><br><span class="line">$ rdma <span class="built_in">link</span></span><br><span class="line"><span class="built_in">link</span> mlx5_0/1 state DOWN physical_state DISABLED netdev ens1f0np0 </span><br><span class="line"><span class="built_in">link</span> mlx5_1/1 state DOWN physical_state DISABLED netdev ens1f1np1 </span><br><span class="line"><span class="built_in">link</span> mlx5_2/1 state ACTIVE physical_state LINK_UP netdev ens2np0 </span><br><span class="line"></span><br><span class="line">$ ibdev2netdev</span><br><span class="line">bnxt_re0 port 1 ==&gt; ens1f0np0 (Up)</span><br><span class="line">bnxt_re1 port 1 ==&gt; ens1f1np1 (Up)</span><br></pre></td></tr></table></figure>
<p>Mellanox  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ more /etc/security/limits.d/rdma.conf</span><br><span class="line"><span class="comment"># configuration for rdma tuning</span></span><br><span class="line">*** soft memlock unlimited</span><br><span class="line">*** hard memlock unlimited</span><br><span class="line">$ yum install -y libibverbs-devel libibverbs pciutils-devel infiniband-diags perftest qperf librdmacm libibverbs-utils libusbx fuse-libs tcsh make valgrind-devel libnl3-devel cma createrepo tcsh tk</span><br><span class="line"> </span><br><span class="line">$ ~/MLNX_OFED_LINUX-5.7-1.0.2.0-rhel7.9-x86_64] $ ./mlnxofedinstall --add-kernel-support</span><br><span class="line"></span><br><span class="line">$ ./mlnxofedinstall --add-kernel-support --skip-distro-check  --skip-repo --with-nvmf</span><br><span class="line"></span><br><span class="line">$ ./mlnxofedinstall --upstream-libs --dpdk</span><br><span class="line"><span class="comment">#build DPDK</span></span><br><span class="line">$ make LDFLAGS=-libverbs</span><br><span class="line"></span><br><span class="line">Note: This program will create MLNX_OFED_LINUX TGZ <span class="keyword">for</span> rhel7.9 under /tmp/MLNX_OFED_LINUX-5.7-1.0.2.0-3.10.0-1160.49.1.el7_lustre.x86_64 directory.</span><br><span class="line">See <span class="built_in">log</span> file /tmp/MLNX_OFED_LINUX-5.7-1.0.2.0-3.10.0-1160.49.1.el7_lustre.x86_64/mlnx_iso.10126_logs/mlnx_ofed_iso.10126.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">Checking <span class="keyword">if</span> all needed packages are installed...</span><br><span class="line">Building MLNX_OFED_LINUX RPMS . Please <span class="built_in">wait</span>...</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /sys/class/infiniband/mlx5_0/ports/1/counters/port_rcv_packets /sys/class/infiniband/mlx5_0/ports/1/counters/port_xmit_packets</span><br><span class="line">85409028</span><br><span class="line">85409161</span><br><span class="line"></span><br><span class="line">https://github.com/prometheus/node_exporter/issues/573</span><br><span class="line">What did you see instead?</span><br><span class="line">A bandwidth divided by 4 =  bytes</span><br><span class="line">port_rcv_data: Total number of data octets, divided by 4 (lanes) = bytes</span><br><span class="line">It <span class="string">&#x27;s match with my test result</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Counters</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_xmit_packets</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_xmit_data</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_rcv_packets</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_rcv_data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/sys/class/infiniband/mlx5_0/ports/1/counters/port_rcv_errors</span></span><br><span class="line"><span class="string">/sys/class/infiniband/mlx5_1/ports/1/counters/port_rcv_errors</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Info</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/rate</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/state</span></span><br><span class="line"><span class="string">/sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/phys_state</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Counters</span></span><br><span class="line"><span class="string">UserParameter=infiniband.port_xmit_packets[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_xmit_packets</span></span><br><span class="line"><span class="string">UserParameter=infiniband.port_xmit_data[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_xmit_data</span></span><br><span class="line"><span class="string">UserParameter=infiniband.port_rcv_packets[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_rcv_packets</span></span><br><span class="line"><span class="string">UserParameter=infiniband.port_rcv_data[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/counters/port_rcv_data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Info</span></span><br><span class="line"><span class="string">UserParameter=infiniband.rate[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/rate</span></span><br><span class="line"><span class="string">UserParameter=infiniband.state[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/state | cut -f1 -d:</span></span><br><span class="line"><span class="string">UserParameter=infiniband.phys_state[*], DEVICE=&quot;$(echo $1 | cut -f1 -d:)&quot;; PORT=&quot;$(echo $1 | cut -f2 -d:)&quot;; cat /sys/class/infiniband/$&#123;DEVICE&#125;/ports/$&#123;PORT&#125;/phys_state | cut -f1 -d:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ibdev2netdev</span></span><br><span class="line"><span class="string">mlx5_0 port 1 ==&gt; enp129s0f0 (Up)</span></span><br><span class="line"><span class="string">mlx5_1 port 1 ==&gt; enp129s0f1 (Up)</span></span><br></pre></td></tr></table></figure>

<h4 id="Here-is-the-direct-access-and-pass-the-switch-test-result"><a href="#Here-is-the-direct-access-and-pass-the-switch-test-result" class="headerlink" title="Here is the direct access and pass the switch test result"></a>Here is the direct access and pass the switch test result</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">=====[ IBDEV bnxt_re1 ]=============================	=====[ IBDEV bnxt_re0 ]=============================</span><br><span class="line">	Max QP:		65537		Max QP:		65537</span><br><span class="line">	Max SRQ:	4096		Max SRQ:	4096</span><br><span class="line">	Max CQ:		65536		Max CQ:		65536</span><br><span class="line">	Max MR:		262144		Max MR:		262144</span><br><span class="line">	Max MW:		262144		Max MW:		262144</span><br><span class="line">	Max AH:		65536		Max AH:		65536</span><br><span class="line">	Max PD:		65536		Max PD:		65536</span><br><span class="line">	Active QP:	1		Active QP:	2</span><br><span class="line">	Active CQ:	1		Active CQ:	2</span><br><span class="line">	Active MR:	515		Active MR:	515</span><br><span class="line">	Active MW:	3		Active MW:	3</span><br><span class="line">	Active PD:	3		Active PD:	3</span><br><span class="line">	QP Watermark:	2		QP Watermark:	2</span><br><span class="line">	CQ Watermark:	2		CQ Watermark:	2</span><br><span class="line">	MR Watermark:	515		MR Watermark:	515</span><br><span class="line">	MW Watermark:	3		MW Watermark:	3</span><br><span class="line">	AH Watermark:	1		AH Watermark:	1</span><br><span class="line">	PD Watermark:	3		PD Watermark:	3</span><br><span class="line">	Rx Pkts: 2541869559		Rx Pkts: 1976902041</span><br><span class="line">	Rx Bytes: 9737185870258		Rx Bytes: 7314160171666</span><br><span class="line">	Tx Pkts: 1741681972		Tx Pkts: 1813588003</span><br><span class="line">	Tx Bytes: 6695291878340		Tx Bytes: 7046029165506</span><br><span class="line">	RoCE Only Rx Pkts: 2541869559		RoCE Only Rx Pkts: 1976902041</span><br><span class="line">	RoCE Only Rx Bytes: 9737185870258		RoCE Only Rx Bytes: 7314160171666</span><br><span class="line">	RoCE Only Tx Pkts: 1741681972		RoCE Only Tx Pkts: 1813588003</span><br><span class="line">	RoCE Only Tx Bytes: 6695291878340		RoCE Only Tx Bytes: 7046029165506</span><br><span class="line">	rx_roce_error_pkts: 0		rx_roce_error_pkts: 1</span><br><span class="line">	tx_write_req: 1610336943		tx_write_req: 1693833730</span><br><span class="line">	rx_write_req: 2340013479		rx_write_req: 1755089408</span><br><span class="line">	tx_send_req: 26560623		tx_send_req: 33375533</span><br><span class="line">	rx_send_req: 25805120		rx_send_req: 33658050</span><br><span class="line">	rx_good_pkts: 2541869559		rx_good_pkts: 1976902041</span><br><span class="line">	rx_good_bytes: 9737185870258		rx_good_bytes: 7314160171666</span><br><span class="line">	to_retransmits: 431		to_retransmits: 1745               &lt;---------- increase quickly when pass the switch</span><br><span class="line">	seq_err_naks_rcvd: 12286		seq_err_naks_rcvd: 79707   &lt;---------- increase quickly when pass the switch</span><br><span class="line">	max_retry_exceeded: 4		max_retry_exceeded: 24             &lt;----------</span><br><span class="line">	rnr_naks_rcvd: 24		rnr_naks_rcvd: 11096</span><br><span class="line">	unrecoverable_err: 495		unrecoverable_err: 5980</span><br><span class="line">	mem_mgmt_op_err: 483		mem_mgmt_op_err: 5980</span><br><span class="line">	num_irq_started : 1		num_irq_started : 1</span><br><span class="line">	latency_slab [0 - 1] sec = 614		latency_slab [0 - 1] sec = 16327</span><br></pre></td></tr></table></figure>

<h3 id="Lustre"><a href="#Lustre" class="headerlink" title="Lustre"></a>Lustre</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">rw=read</span><br><span class="line">ioengine=libaio</span><br><span class="line">iodepth=64</span><br><span class="line">direct=1</span><br><span class="line">fallocate=none</span><br><span class="line">size=258G</span><br><span class="line">numjobs=1</span><br><span class="line">group_reporting</span><br><span class="line">time_based</span><br><span class="line">runtime=3600</span><br><span class="line">refill_buffers</span><br><span class="line">bssplit=1M/100</span><br><span class="line">[test__mnt1]</span><br><span class="line">directory=/mnt/test100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">numactl -N 0 fio fio.cfg </span><br><span class="line">test__mnt1: (g=0): rw=read, bs=(R) 1024KiB-1024KiB, (W) 1024KiB-1024KiB, (T) 1024KiB-1024KiB, ioengine=libaio, iodepth=64</span><br><span class="line">fio-3.19</span><br><span class="line">Starting 1 process</span><br><span class="line">test__mnt1: Laying out IO file (1 file / 264192MiB)</span><br><span class="line">Jobs: 1 (f=1): [R(1)][7.8%][r=10.5GiB/s][r=10.8k IOPS][eta 55m:21s]</span><br><span class="line"></span><br><span class="line"># OSS</span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    7.05    0.00    0.00   92.95</span><br><span class="line"></span><br><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">nvme4n1       2211.00    1.00   2714.00      0.00     0.00     0.00   0.00   0.00    0.46    0.00   1.03  1256.96     4.00   0.43  94.40</span><br><span class="line">nvme3n1       2178.00    1.00   2711.00      0.00     0.00     0.00   0.00   0.00    0.48    0.00   1.04  1274.59     4.00   0.43  94.60</span><br><span class="line">nvme1n1       21692.00    1.00   2711.50      0.00     0.00     0.00   0.00   0.00    1.54    0.00  33.35   128.00     4.00   0.04  97.60</span><br><span class="line">nvme2n1       21703.00    1.00   2712.88      0.00     0.00     0.00   0.00   0.00    1.54    3.00  33.36   128.00     4.00   0.04  96.60</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    7.02    0.00    0.00   92.98</span><br><span class="line"></span><br><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">nvme4n1       2169.00    0.00   2703.00      0.00     0.00     0.00   0.00   0.00    0.48    0.00   1.03  1276.11     0.00   0.43  94.10</span><br><span class="line">nvme3n1       2167.00    0.00   2704.00      0.00     0.00     0.00   0.00   0.00    0.47    0.00   1.02  1277.76     0.00   0.43  93.60</span><br><span class="line">nvme1n1       21632.00    0.00   2704.00      0.00     0.00     0.00   0.00   0.00    1.39    0.00  30.16   128.00     0.00   0.04  97.10</span><br><span class="line">nvme2n1       21606.00    0.00   2700.75      0.00     0.00     0.00   0.00   0.00    1.49    0.00  32.13   128.00     0.00   0.04  96.30</span><br><span class="line"></span><br><span class="line">client.conf (Mellanox MT27800 [ConnectX-5])</span><br><span class="line">options lnet networks=o2ib2(enp129s0f0)</span><br><span class="line">options lnet accept_backlog=1024</span><br><span class="line">options lnet accept_timeout=15</span><br><span class="line">options lnet lnet_retry_count=6</span><br><span class="line">options lnet lnet_transaction_timeout=120</span><br><span class="line">options ksocklnd credits=512</span><br><span class="line">options ksocklnd peer_credits=16</span><br><span class="line">options ksocklnd conns_per_peer=16</span><br><span class="line">options ptlrpc at_max=320</span><br><span class="line">options ptlrpc at_min=50</span><br><span class="line">options ptlrpc ldlm_enqueue_min=240</span><br><span class="line">options ko2iblnd peer_credits=256 peer_credits_hiw=256 credits=512 concurrent_sends=128 ntx=2048 fmr_pool_size=2048 fmr_flush_trigger=8192 fmr_cache=1</span><br><span class="line">options libcfs cpu_pattern=&quot;0[2,4,6] 1[3,5,7]&quot;</span><br><span class="line"></span><br><span class="line">top - 17:09:14 up  2:00,  2 users,  load average: 4.27, 3.91, 2.54</span><br><span class="line">Tasks: 730 total,   3 running, 727 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.0 us,  4.8 sy,  0.0 ni, 95.0 id,  0.0 wa,  0.2 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem : 257771.7 total, 252009.5 free,   3514.7 used,   2247.4 buff/cache</span><br><span class="line">MiB Swap:   4095.0 total,   4095.0 free,      0.0 used. 251120.0 avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                </span><br><span class="line"> 377946 root      20   0 2432780  70932   1252 R  85.0   0.0   7:02.45 fio                                                                                                                    </span><br><span class="line"> 377792 root      20   0       0      0      0 I  52.8   0.0   3:14.77 ptlrpcd_00_01                                                                                                          </span><br><span class="line"> 377794 root      20   0       0      0      0 I  50.2   0.0   3:11.32 ptlrpcd_00_03                                                                                                          </span><br><span class="line"> 377791 root      20   0       0      0      0 I  49.2   0.0   3:14.07 ptlrpcd_00_00                                                                                                          </span><br><span class="line"> 377793 root      20   0       0      0      0 R  49.2   0.0   3:14.67 ptlrpcd_00_02                                                                                                          </span><br><span class="line"> 377786 root      20   0       0      0      0 S  11.0   0.0   1:22.70 kiblnd_sd_01_00                                                                                                        </span><br><span class="line"> 377787 root      20   0       0      0      0 S  11.0   0.0   1:22.63 kiblnd_sd_01_01                                                                                                        </span><br><span class="line"> 377797 root      20   0       0      0      0 I   0.3   0.0   1:19.31 ptlrpcd_01_02                                                                                                          </span><br><span class="line"> 377798 root      20   0       0      0      0 I   0.3   0.0   1:18.80 ptlrpcd_01_03    </span><br><span class="line"></span><br><span class="line">server.conf (BCM57508 NetXtreme-E)</span><br><span class="line">options lnet networks=o2ib2(ens1f1np1),tcp2(ens1f1np1)</span><br><span class="line">options lnet accept_backlog=1024</span><br><span class="line">options lnet accept_timeout=15</span><br><span class="line">options lnet lnet_retry_count=6</span><br><span class="line">options lnet lnet_transaction_timeout=120</span><br><span class="line">options ksocklnd credits=512</span><br><span class="line">options ksocklnd peer_credits=16</span><br><span class="line">options ptlrpc at_max=320</span><br><span class="line">options ptlrpc at_min=50</span><br><span class="line">options ptlrpc ldlm_enqueue_min=240</span><br><span class="line">options ko2iblnd peer_credits=256 peer_credits_hiw=128 credits=1024 concurrent_sends=256 ntx=2048 map_on_demand=32 fmr_pool_size=2048 fmr_flush_trigger=8192 fmr_cache=1</span><br><span class="line"></span><br><span class="line">top - 17:10:19 up  6:42,  1 user,  load average: 9.24, 7.60, 5.03</span><br><span class="line">Tasks: 666 total,   2 running, 663 sleeping,   0 stopped,   1 zombie</span><br><span class="line">%Cpu(s):  0.0 us,  6.2 sy,  0.0 ni, 93.3 id,  0.0 wa,  0.4 hi,  0.1 si,  0.0 st</span><br><span class="line">MiB Mem : 257216.0 total, 253780.4 free,   2871.1 used,    564.4 buff/cache</span><br><span class="line">MiB Swap:   4096.0 total,   4096.0 free,      0.0 used. 252349.0 avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                </span><br><span class="line">   7390 root      20   0       0      0      0 S   7.7   0.0   1:02.82 kiblnd_sd_00_00                                                                                                        </span><br><span class="line">   7391 root      20   0       0      0      0 S   7.7   0.0   1:02.81 kiblnd_sd_00_01                                                                                                        </span><br><span class="line">   7393 root      20   0       0      0      0 S   7.7   0.0   1:02.87 kiblnd_sd_00_03                                                                                                        </span><br><span class="line">   7392 root      20   0       0      0      0 S   7.4   0.0   1:02.80 kiblnd_sd_00_02                                                                                                        </span><br><span class="line">   7818 root      20   0       0      0      0 I   6.2   0.0   0:38.57 ll_ost_io00_024                                                                                                        </span><br><span class="line">   7825 root      20   0       0      0      0 I   6.2   0.0   0:36.31 ll_ost_io00_031                                                                                                        </span><br><span class="line">   7677 root      20   0       0      0      0 I   5.9   0.0   0:35.75 ll_ost_io00_002                                                                                                        </span><br><span class="line">   7798 root      20   0       0      0      0 I   5.9   0.0   0:38.65 ll_ost_io00_004                                                                                                        </span><br><span class="line">   7800 root      20   0       0      0      0 I   5.9   0.0   0:36.26 ll_ost_io00_006                                                                                                        </span><br><span class="line">   7803 root      20   0       0      0      0 I   5.9   0.0   0:38.78 ll_ost_io00_009                                                                                                        </span><br><span class="line">   7810 root      20   0       0      0      0 I   5.9   0.0   0:34.79 ll_ost_io00_016                                                                                                        </span><br><span class="line">   7819 root      20   0       0      0      0 I   5.9   0.0   0:38.82 ll_ost_io00_025                                                                                                        </span><br><span class="line">   7827 root      20   0       0      0      0 I   5.9   0.0   0:35.52 ll_ost_io00_033                                                                                                        </span><br><span class="line">   7830 root      20   0       0      0      0 I   5.9   0.0   0:34.78 ll_ost_io00_035                                                                                                        </span><br><span class="line">   7676 root      20   0       0      0      0 I   5.5   0.0   0:38.52 ll_ost_io00_001                                                                                                        </span><br><span class="line">   7805 root      20   0       0      0      0 I   5.5   0.0   0:39.74 ll_ost_io00_011                                                                                                        </span><br><span class="line">   7812 root      20   0       0      0      0 I   5.5   0.0   0:38.82 ll_ost_io00_018                                                                                                        </span><br><span class="line">   7816 root      20   0       0      0      0 D   5.5   0.0   0:41.67 ll_ost_io00_022                                                                                                        </span><br><span class="line">   7823 root      20   0       0      0      0 I   5.5   0.0   0:37.62 ll_ost_io00_029                                                                                                        </span><br><span class="line">   7799 root      20   0       0      0      0 I   5.1   0.0   0:36.79 ll_ost_io00_005                                                                                                        </span><br><span class="line">   7806 root      20   0       0      0      0 I   5.1   0.0   0:40.73 ll_ost_io00_012                                                                                                        </span><br><span class="line">   7807 root      20   0       0      0      0 I   5.1   0.0   0:29.64 ll_ost_io00_013                                                                                                        </span><br><span class="line">   7808 root      20   0       0      0      0 I   5.1   0.0   0:39.20 ll_ost_io00_014                                                                                                        </span><br><span class="line">   7809 root      20   0       0      0      0 I   5.1   0.0   0:36.99 ll_ost_io00_015                                                                                                        </span><br><span class="line">   7811 root      20   0       0      0      0 I   5.1   0.0   0:38.30 ll_ost_io00_017                                                                                                        </span><br><span class="line">   7813 root      20   0       0      0      0 R   5.1   0.0   0:37.53 ll_ost_io00_019                                                                                                        </span><br><span class="line">   7821 root      20   0       0      0      0 I   5.1   0.0   0:38.64 ll_ost_io00_027                                                                                                        </span><br><span class="line">   7797 root      20   0       0      0      0 I   4.8   0.0   0:36.40 ll_ost_io00_003                                                                                                        </span><br><span class="line">   7832 root      20   0       0      0      0 I   4.8   0.0   0:37.90 ll_ost_io00_036                                                                                                        </span><br><span class="line">   7802 root      20   0       0      0      0 I   4.4   0.0   0:35.29 ll_ost_io00_008                                                                                                        </span><br><span class="line">   7804 root      20   0       0      0      0 I   4.4   0.0   0:36.38 ll_ost_io00_010                                                                                                        </span><br><span class="line">   7814 root      20   0       0      0      0 I   4.4   0.0   0:37.37 ll_ost_io00_020                                                                                                        </span><br><span class="line">   7820 root      20   0       0      0      0 I   4.4   0.0   0:38.08 ll_ost_io00_026                                                                                                        </span><br><span class="line">   7675 root      20   0       0      0      0 I   4.0   0.0   0:39.55 ll_ost_io00_000                                                                                                        </span><br><span class="line">   7826 root      20   0       0      0      0 I   4.0   0.0   0:28.44 ll_ost_io00_032                                                                                                        </span><br><span class="line">   7824 root      20   0       0      0      0 I   3.7   0.0   0:41.26 ll_ost_io00_030                                                                                                        </span><br><span class="line">   7822 root      20   0       0      0      0 I   2.9   0.0   0:36.80 ll_ost_io00_028                                                                                                        </span><br><span class="line">   7817 root      20   0       0      0      0 I   1.5   0.0   0:39.99 ll_ost_io00_023                                                                                                        </span><br><span class="line">   7579 root      20   0       0      0      0 I   0.4   0.0   0:02.01 ldlm_bl_01                                                                                                             </span><br><span class="line">   7580 root      20   0       0      0      0 I   0.4   0.0   0:01.93 ldlm_bl_02                                                                                                             </span><br><span class="line">   7828 root      20   0       0      0      0 I   0.4   0.0   0:02.07 ldlm_bl_04                                                                                                             </span><br><span class="line">   7833 root      20   0       0      0      0 I   0.4   0.0   0:01.89 ldlm_bl_05                         </span><br><span class="line"></span><br><span class="line">#Mellanox rx 2048 will cause too many tcp retrans on H3C and Huawei switch, increase it to 4096, the retrans dispearred, however I modify to 2048 again, the TCP retrans not increased</span><br></pre></td></tr></table></figure>

<h3 id="Mellanox-hard-reset"><a href="#Mellanox-hard-reset" class="headerlink" title="Mellanox hard reset"></a>Mellanox hard reset</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ flint -d 51:00.0 -ocr hw query</span><br><span class="line">QuadEn 0</span><br><span class="line">$ flint -d 51:00.0 -ocr hw <span class="built_in">set</span> QuadEn=1</span><br></pre></td></tr></table></figure>

<h3 id="broadcom"><a href="#broadcom" class="headerlink" title="broadcom"></a>broadcom</h3><h4 id="NIC-upgrade-firmware"><a href="#NIC-upgrade-firmware" class="headerlink" title="NIC upgrade firmware"></a>NIC upgrade firmware</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Download the Firmware package and the FW upgrade utility <span class="string">&#x27;bnxtnvm&#x27;</span>, from the adapter product page.</span><br><span class="line">Run the following <span class="built_in">command</span>:</span><br><span class="line"><span class="comment"># ./bnxtnvm -dev= install</span></span><br></pre></td></tr></table></figure>

<h4 id="Configuring-Peer-Memory-Direct-with-BCM5750X-Network-Adapters-with-NCCL"><a href="#Configuring-Peer-Memory-Direct-with-BCM5750X-Network-Adapters-with-NCCL" class="headerlink" title="Configuring Peer Memory Direct with BCM5750X Network Adapters with NCCL"></a>Configuring Peer Memory Direct with BCM5750X Network Adapters with NCCL</h4><p>NIC traffic with peer meory direct(NIC direct communicate with GPU memory)</p>
<ul>
<li>NVIDIA, CUDA Toolkit</li>
<li>NVIDIA NCCL Library</li>
<li>NCCL Test Suite</li>
<li>OpenMPI</li>
<li>BCM5750X drivers:<ul>
<li>bnxt_en</li>
<li>bnxt_re and user library</li>
<li>nv_peer_mem driver</li>
<li>ib_peer_mem driver</li>
</ul>
</li>
<li>perftest (for initial testing of RoCE)</li>
</ul>
<h4 id="broadcom-Switch-Configuration-for-RoCE"><a href="#broadcom-Switch-Configuration-for-RoCE" class="headerlink" title="broadcom Switch Configuration for RoCE"></a><a target="_blank" rel="noopener" href="https://techdocs.broadcom.com/us/en/storage-and-ethernet-connectivity/ethernet-nic-controllers/bcm957xxx/adapters/Configuration-adapter/RoCE/switch-configuration1.html">broadcom Switch Configuration for RoCE</a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The default NIC configuration enables the use of Explicit Congestion Notification (ECN), Priority Flow Control (PFC), and Enhanced Transmission Selection (ETS) on the network adapter. ECN and PFC are used because the RoCE protocol is network congestion sensitive. For congestion control purposes, the priority settings on the network must match the Congestion Control settings on the RNIC</span><br><span class="line">For a better understanding of ECN and PFC, see RoCE Congestion Control. The default RNIC settings enable RoCE packets to be marked with a DSCP value of 26 and the CNP packets to be marked with a DSCP value of 48. If VLAN Tagging is enabled, the RoCE packets are marked with a VLAN Priority Code Point (PCP) value of 3 and the CNP packets are marked with a VLAN PCP value of 7. PFC is enabled for Priority 3 traffic and ETS is configured between RoCE and non-ROCE traffic to be 50% each. The DSCP and VLAN priorities are also described in DSCP and VLAN</span><br></pre></td></tr></table></figure>

<ul>
<li><p>The switch configuration elements required are as follows:</p>
<ul>
<li>Map DSCP traffic priorities for RoCE and CNP traffic to traffic classes</li>
<li>Enable PFC</li>
<li>Enable ECN</li>
<li>Enable ETS</li>
<li>Example: Arista 7060CX (DCQCN-P at 100G)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qos map dscp 26 to traffic-class 3</span><br><span class="line">qos map dscp 48 to traffic-class 7</span><br><span class="line">!</span><br><span class="line">interface Ethernet1/1</span><br><span class="line">tx-queue 3</span><br><span class="line">random-detect ecn minimum-threshold 500 kbytes maximum-threshold 1500 kbytes max-mark-probability 20</span><br><span class="line">priority-flow-control mode on</span><br><span class="line">priority-flow-control priority 3 no-drop</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>The RoCE configuration defaults for the Linux drivers are:</p>
<ul>
<li>RoCEv2 (RDMA over IPv4) enabled</li>
<li>Congestion Control and PFC enabled</li>
<li>RoCE traffic tagged with DSCP value 26 on priority 3</li>
<li>RoCE CNP traffic tagged with DSCP value 48 on priority 7</li>
<li>1500-byte MTU</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://techdocs.broadcom.com/us/en/storage-and-ethernet-connectivity/ethernet-nic-controllers/bcm957xxx/adapters/Configuration-adapter/RoCE/advanced-network-configuration.html">Disable PFC (Congestion Control Only)</a></p>
<ul>
<li>Removes risk of traffic blocking and congestion spreading. Incompatible with unreliable RDMA connection types. (UD, UC)</li>
</ul>
</li>
<li><p>Disable ECN (PFC Only)</p>
<ul>
<li>Improves throughput for very bursty traffic. Incompatible with multihop switch fabrics.</li>
</ul>
</li>
<li><p>Use VLAN tags instead of DSCP</p>
<ul>
<li>Appends VLAN header to RoCE traffic. Uses VLAN priority field to classify packets instead of IP header DS field</li>
</ul>
</li>
<li><p>Use Jumbo Frames</p>
<ul>
<li>Increases maximum throughput. All devices on network must use the same MTU. Typical large value is 9000.</li>
</ul>
</li>
<li><p>For interswitch (for example, spine-to-leaf)</p>
<ul>
<li>Each switch port participating in congestion control must be configured with the previous ECN threshold for the class of service associated with RoCEv2 traffic. Different vendors have different naming conventions that specify the minimum and maximum marking threshold and the marking percentage.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Switch Egress Port Link Speed (Gb/s)	Deterministic (DCQCN-D) ECN Min Threshold (Kilobytes)	ECN Max Threshold (Kilobytes)	Probability</span><br><span class="line">10	12	13	100%</span><br><span class="line">25	16	17	100%</span><br><span class="line">50	24	25	100%</span><br><span class="line">100	64	65	100%</span><br><span class="line">200	64	66	100%</span><br><span class="line">400*	130	131	100%</span><br><span class="line"></span><br><span class="line">Mark Values (Probabilistic DCQCN-P)</span><br><span class="line">Switch Egress Port Link Speed (Gb/s)	Probabilistic (DCQCN-P) ECN Min Threshold (Kilobytes)	ECN Max Threshold (Kilobytes)	Probability</span><br><span class="line">10	TBD	TBD	TBD</span><br><span class="line">25	TBD	TBD	TBD</span><br><span class="line">50	TBD	TBD	TBD</span><br><span class="line">100	500	1500	20%</span><br><span class="line">200	500	1500	20%</span><br><span class="line">400*	1000	3000	20%</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>The QoS parameters of Broadcom RNICs can be changed from the default values to match the network. The available parameters are:</p>
<ul>
<li><p>Congestion Control: Enable&#x2F;Disable</p>
</li>
<li><p>Priority Flow Control: Enable&#x2F;Disable</p>
</li>
<li><p>RoCE and general IP traffic priority</p>
</li>
<li><p>Bandwidth allocation ratio for RoCE and IP using ETS</p>
</li>
<li><p>ESCP priority for RoCE and CNP traffic</p>
</li>
<li><p>VLAN priority for RoCE and CNP traffic</p>
</li>
<li><p>Congestion control internal tunings</p>
</li>
<li><p>RoCE Profile – optimized for RoCE performance</p>
</li>
<li><p>Default Profile – optimized for non-RoCE (L2&#x2F;IP) performance</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bnxtnvm -dev=&lt;interface&gt; setoption=performance_profile#0 </span></span><br><span class="line"><span class="comment"># bnxtnvm -dev=&lt;interface&gt; setoption=performance_profile#1</span></span><br><span class="line"><span class="comment"># bnxtnvm -dev=&lt;interface&gt; getoption=performance_profile</span></span><br></pre></td></tr></table></figure></li>
<li><p>Bind the task to the CPU with a matching NUMA node to the network adapter.</p>
</li>
<li><p>Increase the depth of RX queue using an application-specific parameter. For example, ib_send_bw has the -r option to increase receive queue depth.</p>
</li>
<li><p>If the application allows, tune the threshold of completion suppression. This tuning is also known as CQ moderation. For example, ib_send_bw has the -Q option.</p>
</li>
<li><p>Use the following recommendations for improving RDMA workload performance:</p>
<ul>
<li>Refer to the recommendations for the best BIOS performance related to NUMA Per Socket (NPS), the preferred I&#x2F;O device, and IOMMU.</li>
<li>For user-mode RDMA workloads, the recommended configuration for optimal performance is to ensure that the number of application processes&#x2F;threads do not exceed the number of CPU cores. Typically, one application process is mapped to one CPU core in HPC and ML applications. Over subscription of the application&#x2F;core ratio may lead to decreased system efficiency due to higher cache misses and OS scheduling overheads.</li>
<li>The system configuration should also account for any co-existing non-RDMA or management application usage of the CPU cores.</li>
<li>Unless an application has been thoroughly tested in the hyper-threaded (HT) environment, it is recommended to disable hyper-threading.</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://techdocs.broadcom.com/us/en/storage-and-ethernet-connectivity/ethernet-nic-controllers/bcm957xxx/adapters/statistics/appendix-a-statistics-definitions.html#appendix-a-statistics-definitions">NIC Statistics Definitions</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Device Resource Limits</span><br><span class="line">Device Resource Limits</span><br><span class="line">Counters	Description</span><br><span class="line">Max QP	 Maximum QP <span class="built_in">limit</span>.</span><br><span class="line">Max SRQ	 Maximum SRQ <span class="built_in">limit</span>.</span><br><span class="line">Max CQ	 Maximum CQs <span class="built_in">limit</span>.</span><br><span class="line">Max MR	 Maximum memory region <span class="built_in">limit</span>.</span><br><span class="line">Max MW	 Maximum memory window <span class="built_in">limit</span>.</span><br><span class="line">Max AH	 Maximum Address handle <span class="built_in">limit</span>.</span><br><span class="line">Max PD	 Maximum Protection domain <span class="built_in">limit</span>.</span><br><span class="line"></span><br><span class="line">Active Resource Limits</span><br><span class="line">Counters	Description</span><br><span class="line">Active QP	 Number of active QPs.</span><br><span class="line">Active SRQ	 Number of active SRQs.</span><br><span class="line">Active CQ	 Number of active CQs.</span><br><span class="line">Active MR	 Number of active memory regions.</span><br><span class="line">Active MW	 Number of active memory windows.</span><br><span class="line">Active AH	 Number of active Address handles.</span><br><span class="line">Active PD	 Number of active Protection domains.</span><br><span class="line"></span><br><span class="line">Resource Watermarks</span><br><span class="line">Congestion Notification Counters</span><br><span class="line">Transmit Counters</span><br><span class="line">Receive Counters</span><br><span class="line">Recoverable Errors</span><br><span class="line">Fatal Errors</span><br><span class="line">Responder Errors</span><br><span class="line"></span><br><span class="line">PCIe Errors</span><br><span class="line">res_tx_pci_err	 Number of PCI errors detected during transmission by responder.</span><br><span class="line">res_rx_pci_err	 Number of PCI errors detected during reception by responder.</span><br><span class="line"></span><br><span class="line">Device Control Plane Counters</span><br><span class="line">num_irq_started	 Number of <span class="built_in">times</span> the control plane interrupt service routine had enabled.</span><br><span class="line">num_irq_stopped	 Number of <span class="built_in">times</span> the control plane interrupt service routine had disabled.</span><br><span class="line">poll_in_intr_en	 Number of <span class="built_in">times</span> a control path <span class="built_in">command</span> had timed out <span class="keyword">in</span> interrupt mode and the driver had to fall on to polling mode.</span><br><span class="line">poll_in_intr_dis	 Number of <span class="built_in">times</span> control path <span class="built_in">command</span> has been completed <span class="keyword">in</span> pure polling mode because the interrupt mode was disabled.</span><br><span class="line"></span><br><span class="line">Driver Debug Counters</span><br><span class="line">Resize CQ count	Debug counter <span class="keyword">for</span> CQ resize ops after driver load.</span><br><span class="line">num_irq_startednum_irq_started	Debug counter <span class="keyword">for</span> IRQs started after device creation.</span><br><span class="line">num_irq_stoppednum_irq_stopped	Debug counter <span class="keyword">for</span> IRQs stopped after device creation.</span><br><span class="line">poll_in_intr_enpoll_in_intr_en	Debug counter <span class="keyword">for</span> indicating control path polling when interrupt enabled.</span><br><span class="line">poll_in_intr_dispoll_in_intr_dis	Debug counter <span class="keyword">for</span> indicating control path polling when interrupts are disabled.</span><br><span class="line">cmdq_full_dbg_cnt	Debug counter to indicate control path CMDQ full.</span><br><span class="line">fw_service_prof_type_sup	Debug info to indicate the current service profile config.</span><br><span class="line">dbq_int_recvdbq_int_recv	Debug counter to indicate the DBQ interrupt received.</span><br><span class="line">dbq_int_endbq_int_en	Debug counter to indicate the number of iterations dbq interrupt is enabled.</span><br><span class="line">dbq_pacing_rescheddbq_pacing_resched	Debug counter to indicate the number of <span class="built_in">times</span> pacing thread rescheduled.</span><br><span class="line">dbq_pacing_completedbq_pacing_complete	Debug counter to indicate the count <span class="built_in">where</span> the pacing thread completed.</span><br><span class="line">dbq_dbr_fifo_reg	Debug counter to monitor the HW FIFO reg.</span><br><span class="line">dbr_drop_recov_epoch	Debug counter to indicate epoch of latest DBR drop event.</span><br><span class="line">dbr_drop_recov_events	Debug counter to indicate the number of DBR drop events.</span><br><span class="line">dbr_drop_recov_timeouts	Debug counter to indicate the DBR drop events scheduled to the  user space and failed to complete within the <span class="built_in">timeout</span>.</span><br><span class="line">dbr_drop_recov_timeout_users	Debug counter to indicate the number of user instances that  experienced <span class="built_in">timeout</span> when driver finishes the recovery thread.</span><br><span class="line">dbr_drop_recov_event_skips	Debug counter to indicate the number of DBR drop events ignored  (skipped) by the driver because of one or more outstanding event.</span><br><span class="line">latency_slab	Each slab is of 1 second granularity. The Counters of each slab represent  the total number of control path commands completed <span class="keyword">in</span> that range. Up to 128 seconds latency is tracked.</span><br></pre></td></tr></table></figure>

<h3 id="NFS-server-over-RDMA-RoCEv2"><a href="#NFS-server-over-RDMA-RoCEv2" class="headerlink" title="NFS server over RDMA&#x2F;RoCEv2"></a>NFS server over RDMA&#x2F;RoCEv2</h3><p>Because RHEL default rpm compiled by rdma-core not Mellanox OFED, remove uninstall the mellanox driver</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Server and client $ yum install rdma-core</span><br><span class="line">Server and client $ vi /etc/rdma/modules/rdma.conf</span><br><span class="line"><span class="comment"># NFS over RDMA client support</span></span><br><span class="line">xprtrdma</span><br><span class="line"><span class="comment"># NFS over RDMA server support</span></span><br><span class="line">svcrdma</span><br><span class="line"></span><br><span class="line">Server $ vi /etc/exports</span><br><span class="line">Server $ <span class="built_in">mkdir</span> /mnt/nfsordma</span><br><span class="line">Server $ <span class="built_in">echo</span> <span class="string">&quot;/mnt/nfsordma *(fsid=0,rw,async,insecure,no_root_squash)&quot;</span> &gt;&gt; /etc/exports</span><br><span class="line">Server $ vi /etc/nfs.conf</span><br><span class="line">[nfsd]</span><br><span class="line">threads=128</span><br><span class="line">rdma=y</span><br><span class="line">rdma-port=20049</span><br><span class="line">$ systemctl restart nfs-server</span><br><span class="line"></span><br><span class="line">or modify online</span><br><span class="line"></span><br><span class="line">Server $ modprobe svcrdma</span><br><span class="line">Server $ <span class="built_in">echo</span> rdma 20049 &gt; /proc/fs/nfsd/portlist</span><br><span class="line">Server $ <span class="built_in">cat</span> /proc/fs/nfsd/portlist</span><br><span class="line">rdma 20049</span><br><span class="line">rdma 20049</span><br><span class="line">tcp 2049</span><br><span class="line">tcp 2049</span><br><span class="line"></span><br><span class="line">Client $ modprobe xprtrdma</span><br><span class="line">Client $ mount -o rdma,port=20049  192.168.0.1:/mnt/nfsordma /mnt1</span><br></pre></td></tr></table></figure>

<h3 id="Configure-mellanox-tools-and-Set-Up-Lossless-Configuration"><a href="#Configure-mellanox-tools-and-Set-Up-Lossless-Configuration" class="headerlink" title="Configure mellanox tools and Set Up Lossless Configuration"></a><a target="_blank" rel="noopener" href="https://documents.westerndigital.com/content/dam/doc-library/en_us/assets/public/western-digital/collateral/reference-arch/reference-architecture-high-performance-lustre-filesystem.pdf">Configure mellanox tools and Set Up Lossless Configuration</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ens3f0np0 ens6f0np0; </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment">#This parameter is used to set dscp to priority mapping when the trust state is &quot;dscp&quot;. Note that for this setting to take effect on VF, please reload the VF driver or restart the VM. </span></span><br><span class="line">  <span class="comment">#to map dscp 26 to priority 3</span></span><br><span class="line">  mlnx_qos -i <span class="variable">$i</span> --dscp2prio <span class="built_in">set</span>,26,3; </span><br><span class="line"> </span><br><span class="line">  <span class="comment">#set the trust level (pcp or dscp). </span></span><br><span class="line">  mlnx_qos -i <span class="variable">$i</span> --trust dscp;  </span><br><span class="line"></span><br><span class="line">  <span class="comment">#set the CNP DSCP priority values on the NP and set guaranteed QoS in the switches for this value</span></span><br><span class="line">  <span class="built_in">echo</span> 48 &gt; /sys/class/net/<span class="variable">$&#123;i&#125;</span>/ecn/roce_np/cnp_dscp; </span><br><span class="line"></span><br><span class="line">  <span class="comment">#Enable ENC in the queue 3</span></span><br><span class="line">  <span class="built_in">echo</span> 1 &gt; /sys/class/net/<span class="variable">$&#123;i&#125;</span>/ecn/roce_rp/enable/3; </span><br><span class="line"></span><br><span class="line">  <span class="comment">#Enable PFC in the queue 3 (0,1,2,3)</span></span><br><span class="line">  mlnx_qos -i <span class="variable">$i</span> --pfc 0,0,0,1,0,0,0,0 ; </span><br><span class="line"><span class="keyword">done</span> ;</span><br><span class="line"></span><br><span class="line">cma_roce_tos -d mlx5_0 -t 106; </span><br><span class="line">cma_roce_tos -d mlx5_2 -t 106</span><br><span class="line">                           ^</span><br><span class="line">                           |</span><br><span class="line">                           |</span><br><span class="line">                         &lt;Tos&gt; The ToS field is 8 bits, <span class="keyword">while</span> the DSCP is 6 bits. To <span class="built_in">set</span> a DSCP value of X, you need to multiply this value by 4 (SHIFT 2). </span><br><span class="line">                               For example, to <span class="built_in">set</span> DSCP value of 24, (24x4=96). Set the ToS bit to 96.</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ens3f0np0 ens6f0np0; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  mlnx_qos -i <span class="variable">$i</span> --dscp2prio <span class="built_in">set</span>,26,3; </span><br><span class="line">  mlnx_qos -i <span class="variable">$i</span> --trust dscp;  </span><br><span class="line">  <span class="built_in">echo</span> 48 &gt; /sys/class/net/<span class="variable">$&#123;i&#125;</span>/ecn/roce_np/cnp_dscp; </span><br><span class="line">  <span class="built_in">echo</span> 1 &gt; /sys/class/net/<span class="variable">$&#123;i&#125;</span>/ecn/roce_rp/enable/3; </span><br><span class="line">  mlnx_qos -i <span class="variable">$i</span> --pfc 0,0,0,1,0,0,0,0 ; </span><br><span class="line"><span class="keyword">done</span> ; </span><br><span class="line">cma_roce_tos -d mlx5_0 -t 106; </span><br><span class="line">cma_roce_tos -d mlx5_2 -t 106</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------&gt;</span><br><span class="line">modprobe -v nvme-core multipath=no</span><br><span class="line">	 modprobe -v nvme</span><br><span class="line">	 modprobe -v nvme-rdma</span><br><span class="line">	 mlnx_qos -i ens1f0</span><br><span class="line">	 mlnx_qos -i ens1f1</span><br><span class="line">	 mst start</span><br><span class="line">mst status</span><br><span class="line"><span class="built_in">yes</span> | mlxconfig -d /dev/mst/mt4119_pciconf0 <span class="built_in">set</span> LLDP_NB_DCBX_P1=FALSE LLDP_NB_TX_MODE_</span><br><span class="line">P1=2 LLDP_NB_RX_MODE_P1=2 LLDP_NB_DCBX_P2=FALSE LLDP_NB_TX_MODE_P2=2 LLDP_NB_RX_MODE_</span><br><span class="line">P2=2</span><br><span class="line"><span class="built_in">yes</span> | mlxconfig -d /dev/mst/mt4119_pciconf0.1 <span class="built_in">set</span> LLDP_NB_DCBX_P1=FALSE LLDP_NB_TX_</span><br><span class="line">MODE_P1=2 LLDP_NB_RX_MODE_P1=2 LLDP_NB_DCBX_P2=FALSE LLDP_NB_TX_MODE_P2=2 LLDP_NB_RX_</span><br><span class="line">MODE_P2=2</span><br><span class="line">	 mlnx_qos -i ens1f0 --trust dscp</span><br><span class="line">	 mlnx_qos -i ens1f1 --trust dscp</span><br><span class="line">	 mlnx_qos -i ens1f0 --pfc 0,0,0,1,0,0,0,0</span><br><span class="line">	 mlnx_qos -i ens1f1 --pfc 0,0,0,1,0,0,0,0</span><br><span class="line">	 mlnx_qos -i ens1f0 ----buffer_size 130944,130944,0,0,0,0,0,0</span><br><span class="line">	 mlnx_qos -i ens1f1 --prio2buffer 0,0,0,1,0,0,0,0</span><br><span class="line">mlnx_qos -i ens1f0 --tsa ets,ets,ets,ets,ets,ets,strict,ets --tcbw</span><br><span class="line">14,15,14,15,14,14,0,14</span><br><span class="line">mlnx_qos -i ens1f1 ----buffer_size 130944,130944,0,0,0,0,0,0</span><br><span class="line">	 mlnx_qos -i ens1f0 --prio2buffer 0,0,0,1,0,0,0,0</span><br><span class="line">mlnx_qos -i ens1f0 --tsa ets,ets,ets,ets,ets,ets,strict,ets --tcbw</span><br><span class="line">14,15,14,15,14,14,0,14</span><br><span class="line">	 cma_roce_mode -d mlx5_0 -m 2</span><br><span class="line">	 cma_roce_mode -d mlx5_1 -m 2</span><br><span class="line">	 cma_roce_tos -d mlx5_0 -t 96</span><br><span class="line">	 cma_roce_tos -d mlx5_1 -t 96</span><br><span class="line">	 cma_roce_tos -d mlx5_0</span><br><span class="line">	 cma_roce_tos -d mlx5_1</span><br><span class="line"></span><br><span class="line"><span class="comment">#Set up lossless configuration on the switch and on all Lustre storage servers where volumes from OpenFlex devices will be mapped. For more details regarding lossless configuration on OpenFlex devices and switches, visit www.westerndigital.com/support and follow the steps mentioned in the lossless configuration guide for your switch brand.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Set up the IPs. Set the MTU value to 4500 for all storage ports and the MTU value to 9216 for other ports on the host as well as on the switch. Verify all the ports are up and configured properly.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">. If multiple interfaces of the same host need to be added to o2ib network, <span class="keyword">then</span> an ARP flux issue will occur. Run</span><br><span class="line">the below commands after every reboot to fix ARP flux issue <span class="keyword">for</span> Multi-Rail node.</span><br><span class="line">	 <span class="comment">#Setting ARP so it doesn’t broadcast</span></span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f0.arp_ignore=1</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f0.arp_filter=0</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f0.arp_announce=2</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f0.rp_filter=0</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f1.arp_ignore=1</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f1.arp_filter=0</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f1.arp_announce=2</span><br><span class="line">	 sysctl -w net.ipv4.conf.ens1f1.rp_filter=0</span><br><span class="line">	 ip neigh flush dev ens1f0</span><br><span class="line">	 ip neigh flush dev ens1f1</span><br><span class="line">	 <span class="built_in">echo</span> 201 ens1f0 &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">	 <span class="built_in">echo</span> 202 ens1f1 &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line">ip route add 192.168.10.0/26 dev ens1f0 proto kernel scope <span class="built_in">link</span> src 192.168.10.15</span><br><span class="line">table ens1f0</span><br><span class="line">ip route add 192.168.10.0/26 dev ens1f1 proto kernel scope <span class="built_in">link</span> src 192.168.10.16</span><br><span class="line">table ens1f1</span><br><span class="line">	 ip rule add from 192.168.10.15 table ens1f0</span><br><span class="line">	 ip rule add from 192.16</span><br><span class="line">         ip route flush cache</span><br><span class="line"></span><br><span class="line">Run the below commands to configure LNet with Multi-Rail to add <span class="built_in">local</span> interfaces to LNet o2ib0 and add peer</span><br><span class="line">details.</span><br><span class="line">$ lnetctl net add --net o2ib0 --<span class="keyword">if</span> ens1f0,ens1f1</span><br><span class="line">$ lnetctl peer add --prim_nid 192.168.10.17@o2ib –nid 192.168.10.17</span><br><span class="line">@o2ib,192.168.10.18@o2ib</span><br><span class="line">$ lnetctl peer add --prim_nid 192.168.10.19@o2ib –nid 192.168.10.19</span><br><span class="line">@o2ib,192.168.10.20@o2ib</span><br><span class="line"></span><br><span class="line">$ lnetctl net show</span><br><span class="line">	 net:</span><br><span class="line">	 	 - net <span class="built_in">type</span>: lo</span><br><span class="line">	 	 	 <span class="built_in">local</span> NI(s):</span><br><span class="line">	 	 	 	 - nid: 0@lo</span><br><span class="line">	 	 	 	 	 status: up</span><br><span class="line">	 	 - net <span class="built_in">type</span>: o2ib</span><br><span class="line">	 	 	 <span class="built_in">local</span> NI(s):</span><br><span class="line">	 	 	 	 - nid: 192.168.10.15@o2ib</span><br><span class="line">	 	 	 	 	 status: up</span><br><span class="line">	 	 	 	 	 interfaces:</span><br><span class="line">	 	 	 	 	 	 0: ens1f0</span><br><span class="line">	 	 	 	 - nid: 192.168.10.16@o2ib</span><br><span class="line">	 	 	 	 	 status: up</span><br><span class="line">	 	 	 	 	 interfaces:</span><br><span class="line">	 	 	 	 	 	 0: ens1f1</span><br><span class="line"></span><br><span class="line">$ lnetctl peer show</span><br><span class="line">	 peer:</span><br><span class="line">	 	 - primary nid: 192.168.10.17@o2ib</span><br><span class="line">	 	 	 Multi-Rail: True</span><br><span class="line">	 	 	 peer ni:</span><br><span class="line">	 	 	 	 - nid: 192.168.10.17@o2ib</span><br><span class="line">	 	 	 	 	 state: NA</span><br><span class="line">	 	 	 	 - nid: 192.168.10.18@o2ib</span><br><span class="line">	 	 	 	 	 state: NA</span><br><span class="line">	 	 - primary nid: 192.168.10.19@o2ib</span><br><span class="line">	 	 	 Multi-Rail: True</span><br><span class="line">	 	 	 	 peer ni:</span><br><span class="line">	 	 	 	 - nid: 192.168.10.19@o2ib</span><br><span class="line">	 	 	 	 	 state: NA</span><br><span class="line">	 	 	 	 - nid: 192.168.10.20@o2ib</span><br><span class="line">	 	 	 	 	 state: NA</span><br><span class="line"></span><br><span class="line">Lustre server-specific tuning &lt;------------------------------------------try to <span class="built_in">test</span></span><br><span class="line">	 $ [root@lustre-server1]<span class="comment"># lctl set_param timeout=600</span></span><br><span class="line">	 $ [root@lustre-server1]<span class="comment"># lctl set_param ldlm_timeout=200</span></span><br><span class="line">	 $ [root@lustre-server1]<span class="comment"># lctl set_param at_min=250</span></span><br><span class="line">	 $ [root@lustre-server1]<span class="comment"># lctl set_param at_max=600</span></span><br><span class="line">	 $ [root@lustre-server1]<span class="comment"># lctl set_param obdfilter.lustrefs-OST*.brw_size=16</span></span><br><span class="line">Validate the settings:</span><br><span class="line">	 $ [root@lustre-server1]<span class="comment"># lctl get_param obdfilter.lustrefs-OST*.brw_size</span></span><br><span class="line">	 obdfilter.lustrefs-OST0000.brw_size=16</span><br><span class="line">	 obdfilter.lustrefs-OST0002.brw_size=16</span><br><span class="line">Lustre client-specific tuning</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param osc.*.checksums=0</span></span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param timeout=600</span></span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param at_min=250</span></span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param at_max=600</span></span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param ldlm.namespaces.*.lru_size=2000</span></span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param osc.*OST*.max_rpcs_in_flight=32</span></span><br><span class="line">	 $ [root@lustre-client1]<span class="comment">#lctl set_param osc.*OST*.max_dirty_mb=64</span></span><br><span class="line">The “max_pages_per_rpc” parameter is a tuneable that sets the maximum number of pages that will undergo I/O</span><br><span class="line"><span class="keyword">in</span> a single RPC to that OST.</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment"># lctl set_param osc.lustrefs-OST*.max_pages_per_rpc=1024</span></span><br><span class="line">The “max_read_ahead_mb” is a tuneable that sets the maximum amount of data readahead on a file. These are</span><br><span class="line"><span class="built_in">read</span> ahead <span class="keyword">in</span> an RPC-sized chunk.</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment"># lctl set_param llite.lustre*.max_read_ahead_mb=1024</span></span><br><span class="line">The “max_rpcs_in_flight” is a tuneable that sets the maximum number of concurrent RPCs <span class="keyword">in</span> flight to the OST.</span><br><span class="line">This parameter <span class="keyword">in</span> the majority of cases will <span class="built_in">help</span> with small file IO patterns.</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment"># lctl set_param osc.lustrefs-OST*.max_rpcs_in_flight=32</span></span><br><span class="line">Validate the settings:</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment"># lctl get_param osc.lustrefs-OST*.max_pages_per_rpc</span></span><br><span class="line">	 osc.lustrefs-OST0000-osc-ffff99a61eace000.max_pages_per_rpc=1024</span><br><span class="line">	 osc.lustrefs-OST0001-osc-ffff99a61eace000.max_pages_per_rpc=1024</span><br><span class="line">	 osc.lustrefs-OST0002-osc-ffff99a61eace000.max_pages_per_rpc=1024</span><br><span class="line">	 osc.lustrefs-OST0003-osc-ffff99a61eace000.max_pages_per_rpc=1024</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment"># lctl get_param llite.lustre*.max_read_ahead_mb</span></span><br><span class="line">	 llite.lustrefs-ffff99a61eace000.max_read_ahead_mb=1024</span><br><span class="line">	 $ [root@lustre-client1]<span class="comment"># lctl get_param osc.lustrefs-OST*.max_rpcs_in_flight</span></span><br><span class="line">	 osc.lustrefs-OST0000-osc-ffff99a61eace000.max_rpcs_in_flight=32</span><br><span class="line">	 osc.lustrefs-OST0001-osc-ffff99a61eace000.max_rpcs_in_flight=32</span><br><span class="line">	 osc.lustrefs-OST0002-osc-ffff99a61eace000.max_rpcs_in_flight=32</span><br><span class="line">	 osc.lustrefs-OST0003-osc-ffff99a61eace000.max_rpcs_in_flight=32</span><br></pre></td></tr></table></figure>



<h3 id="tcpdump-rdma-rocev2"><a href="#tcpdump-rdma-rocev2" class="headerlink" title="tcpdump rdma rocev2"></a>tcpdump rdma rocev2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ibdev2netdev </span><br><span class="line">mlx5_0 port 1 ==&gt; ens1np0 (Up)</span><br><span class="line">mlx5_1 port 1 ==&gt; ens2f0np0 (Down)</span><br><span class="line">mlx5_2 port 1 ==&gt; ens2f1np1 (Down)</span><br><span class="line"></span><br><span class="line">$ tcpdump -i mlx5_0 host 192.168.0.1 -s 0</span><br></pre></td></tr></table></figure>

<h3 id="Soft-RoCE"><a href="#Soft-RoCE" class="headerlink" title="Soft-RoCE"></a>Soft-RoCE</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">modprobe  rdma_rxe</span><br><span class="line">$ rdma <span class="built_in">link</span> add <span class="variable">$your_soft</span>-roce-dev-name <span class="built_in">type</span> rxe netdev ens160 </span><br><span class="line">$ rdma <span class="built_in">link</span></span><br><span class="line">$ ibstat</span><br><span class="line">$ ibv_devinfo</span><br><span class="line"></span><br><span class="line">$ rdma <span class="built_in">link</span> del <span class="variable">$your_soft</span>-roce-dev-name</span><br><span class="line">$ ibstat</span><br></pre></td></tr></table></figure>

<h3 id="rdma-technology-features"><a href="#rdma-technology-features" class="headerlink" title="rdma-technology-features"></a><a target="_blank" rel="noopener" href="https://asterfusion.com/blog20230809-rdma-technology-features/">rdma-technology-features</a></h3><ul>
<li>IB<ul>
<li>IBTA</li>
<li>IB专网L3</li>
<li>延时低, 成本高,可靠性高,CPU低,运维成本低</li>
<li>建设成本高昂，服务器需要专用的IB网卡，专用的IB交换机搭建专用网络，一般是普通网络设备的五到十倍，只有在金融、期货交易等环境中才会考虑使用</li>
<li>网络基础设施增多使相应的配套设施增加，如线缆、模块、监控、环动、电耗等</li>
<li>InfiniBand网络具备高带宽、无丢包、配置和运维简单等优势</li>
<li>InfiniBand交换机的延迟始终低于以太网交换机，一种特定类型的以太网交换机的端口到端口延迟为230ns，而具有相同端口数量的InfiniBand交换机的端口到端口延迟为100ns</li>
<li>Mellanox</li>
</ul>
</li>
<li>iWARP<ul>
<li>IETF</li>
<li>TCP&#x2F;IP以太网L3</li>
<li>延时高, 成本中,可靠性低,CPU高,运维成本低</li>
<li>WARP协议较复杂，包含DDP、MPA和RDMAP三层子协议</li>
<li>基于TCP提供可靠的服务，但拥塞控制机制复杂，重传机制导致时延增大；</li>
<li>TCP需建立连接，工作效率低，且只能适用于点到点的场景，不适合多播场景</li>
<li>在大规模数据中心和大规模应用程序的场景中，大量的TCP连接会占用较多的系统资源（TCP流量将导致接近100%的CPU资源被占用），影响网络扩展性和性能</li>
<li>iWARP与传统TCP流共享协议号空间，因此需要使用上下文状态来确定数据包是否为iWARP，增加处理延时</li>
<li>iWARP是一个全新的协议，所以服务器网卡需要支持该协议</li>
<li>Chelsio&#x2F;intel&#x2F;Marvel&#x2F;Kazan Networks</li>
</ul>
</li>
<li>RoCE<ul>
<li>IBTA</li>
<li>依赖无损以太网，保障RDMA的低时延、零丢包和高可靠</li>
<li>无损以太网配置较IB网络更加复杂，运维也更加复杂 </li>
<li>RoCEv1<ul>
<li>以太网L2</li>
<li>只能在同一以太网广播域中通信，可伸缩性受限</li>
</ul>
</li>
<li>RoCEv2高<ul>
<li>UDP&#x2F;IP以太网L3</li>
<li>延时中, 成本低,可靠性中,CPU低,运维成本高</li>
<li>引入IP解决了网络扩展性问题，可以在三层间路由；引入UDP解决负载均衡的问题，提高网络利用率</li>
<li>依赖无损以太网，并定义了拥塞控制协议ECN，保障低时延、零丢包和高可靠</li>
<li>UDP是无连接的，高效，具有较好的实时性，且支持一对一，一对多，多对一和多对多的交互通信</li>
<li>UDP具有较少的开销，占用较少的系统资源，网络扩展性和性能不受影响</li>
<li>根据UDP端口号可以快速识别RoCE流，处理时延低</li>
<li>Mellanox&#x2F;Emulex&#x2F;Broadcom&#x2F;QLogic&#x2F;Cavium&#x2F;Huawei&#x2F;ATTO&#x2F;intel&#x2F;Marvel&#x2F;Kazan Networks</li>
</ul>
</li>
<li>ENC( Explicit Congestion Notification )<ul>
<li>Weighted Random Early Detection (WRED) drops packets based on the average length exceeding a specific threshold value to indicate congestion. Explicit Congestion Notification (ECN) is an extension to WRED that marks the drop-eligible packets, instead of dropping, using the same criteria of minimum threshold, maximum threshold, and drop probability. WRED Behavior with and without ECN shows the WRED behavior without ECN and with ECN.</li>
<li>RFC 3168 states that the two-bit ECN field comprises an ECT bit and a CE bit that are used to implement ECN. The ECT bit and the CE bit can be combined into four possible ECN field values 00 to 11. The first number is ECT bit and the second number is the CE bit. ENC Field Values shows the possible combination</li>
<li><a target="_blank" rel="noopener" href="https://documentation.extremenetworks.com/exos_32.5/GUID-F6EA1959-8295-4B38-BCB2-194BD7CE8FD9.shtml">Limitations</a><ul>
<li>TCP yellow traffic color is not supported.</li>
<li>ECN over VXLAN is not supported. Any tunneling protocol implemented with double headers is not supported</li>
<li>The ECN counters showing the number of marked packets is not available yet, so those appear as 0</li>
<li>This implementation is limited to ECN pass-through. End points having TCP&#x2F;DCTCP&#x2F;RoCEv2 capabilities can use the ECN services</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDMA"><span class="toc-number">1.</span> <span class="toc-text">RDMA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BUGS"><span class="toc-number">2.</span> <span class="toc-text">BUGS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Packages-loss"><span class="toc-number">4.</span> <span class="toc-text">Packages loss</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAG-with-Mellanox-RoCEv2"><span class="toc-number">4.1.</span> <span class="toc-text">LAG with Mellanox RoCEv2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#initialization-broadcom-mellanox-RoCEv2-driver-under-AlmaLinux-8-5"><span class="toc-number">4.2.</span> <span class="toc-text">initialization broadcom&#x2F;mellanox RoCEv2 driver under AlmaLinux 8.5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Here-is-the-direct-access-and-pass-the-switch-test-result"><span class="toc-number">4.3.</span> <span class="toc-text">Here is the direct access and pass the switch test result</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lustre"><span class="toc-number">5.</span> <span class="toc-text">Lustre</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mellanox-hard-reset"><span class="toc-number">6.</span> <span class="toc-text">Mellanox hard reset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#broadcom"><span class="toc-number">7.</span> <span class="toc-text">broadcom</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NIC-upgrade-firmware"><span class="toc-number">7.1.</span> <span class="toc-text">NIC upgrade firmware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuring-Peer-Memory-Direct-with-BCM5750X-Network-Adapters-with-NCCL"><span class="toc-number">7.2.</span> <span class="toc-text">Configuring Peer Memory Direct with BCM5750X Network Adapters with NCCL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#broadcom-Switch-Configuration-for-RoCE"><span class="toc-number">7.3.</span> <span class="toc-text">broadcom Switch Configuration for RoCE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS-server-over-RDMA-RoCEv2"><span class="toc-number">8.</span> <span class="toc-text">NFS server over RDMA&#x2F;RoCEv2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Configure-mellanox-tools-and-Set-Up-Lossless-Configuration"><span class="toc-number">9.</span> <span class="toc-text">Configure mellanox tools and Set Up Lossless Configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcpdump-rdma-rocev2"><span class="toc-number">10.</span> <span class="toc-text">tcpdump rdma rocev2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soft-RoCE"><span class="toc-number">11.</span> <span class="toc-text">Soft-RoCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rdma-technology-features"><span class="toc-number">12.</span> <span class="toc-text">rdma-technology-features</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/rdma/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/rdma/&text=RDMA"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/rdma/&is_video=false&description=RDMA"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RDMA&body=Check out this article: http://example.com/2022/11/13/rdma/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/rdma/&title=RDMA"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/rdma/&name=RDMA&description=&lt;h3 id=&#34;RDMA&#34;&gt;&lt;a href=&#34;#RDMA&#34; class=&#34;headerlink&#34; title=&#34;RDMA&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://hustcat.github.io/queue-pair-in-rdma/&#34;&gt;RDMA&lt;/a&gt;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;RoCEv2 key feature&lt;ul&gt;
&lt;li&gt;zero-copy (FC not support)&lt;/li&gt;
&lt;li&gt;bypass-kernel (FC support)&lt;/li&gt;
&lt;li&gt;lossless network&lt;/li&gt;
&lt;li&gt;PFC(Priority-based Flow Control)&lt;ul&gt;
&lt;li&gt;over shreshold and send the “PFC pause frame”, until the value lower “shreshold” and send the “pause with zero duration”&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2022&#34;&gt;PFC class (diff level)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;coarse-grained, influence a lot&lt;/li&gt;
&lt;li&gt;VLAN-based PFC&lt;ul&gt;
&lt;li&gt;VLAN tag&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-1415&#34;&gt;HowTo Run RoCE and TCP over L2 Enabled with PFC&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;VLAN PFC 2 issues&lt;ul&gt;
&lt;li&gt;trunk mode for switch&lt;/li&gt;
&lt;li&gt;VLAN PCP could not transmit to L3, VLAN work in L2, try to import DSCP-based PFC&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DSCP-based PFC&lt;ul&gt;
&lt;li&gt;DSCP-based PFC requires both NICs and switches to classify and queue packets based on the DSCP value instead of the VLAN tag&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DSCP vs TOS&lt;ul&gt;
&lt;li&gt;The type of service (ToS) field in the IPv4 header has had various purposes over the years, and has been defined in different ways by five RFCs. The modern redefinition of the ToS field is a six-bit Differentiated Services Code Point (DSCP) field and a two-bit Explicit Congestion Notification (ECN) field. While Differentiated Services is somewhat backwards compatible with ToS, ECN is not.&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Type_of_service&#34;&gt;reference1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Differentiated_services&#34;&gt;reference2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;RDMA PFC issues&lt;ul&gt;
&lt;li&gt;RDMA transport livelock&lt;ul&gt;
&lt;li&gt;尽管PFC可以避免buffer overflow导致的丢包，但是，其它一些原因，比如FCS错误，也可能导致网络丢包。RDMA的go-back-0算法，每次出现丢包，都会导致整个message的所有packet都会重传，从而导致livelock。TCP有SACK算法，由于RDMA传输层在NIC实现，受限于硬件资源，NIC很难实现SACK算法。可以使用go-back-N算法来避免这个问题&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;PFC Deadlock&lt;ul&gt;
&lt;li&gt;当PFC机制与Ethernet的广播机制工作时，可能导致出现PFC Deadlock。简单来说，就是PFC机制会导致相应的port停止发包，而Ethernet的广播包可能引起新的PFC pause依赖（比如port对端的server down掉)，从而引起循环依赖。广播和多播对于loseless是非常危险的，建议不要将其归于loseless classes&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NIC PFC pause frame storm&lt;ul&gt;
&lt;li&gt;由于PFC pause是传递的，所以很容器引起pause frame storm。比如，NIC因为bug导致接收缓冲区填满，NIC会一直对外发送pause frame。需要在NIC端和交换机端使用watchdog机制来防止pause storm&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;The Slow-receiver symptom&lt;ul&gt;
&lt;li&gt;由于NIC的资源有限，它将大部分数据结构，比如QPC(Queue Pair Context) 和WQE (Work Queue Element)都放在host memory。而NIC只会缓存部分数据对象，一旦出现cache miss，NIC的处理速度就会下降&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## 将skb prio 0~7 映射到vlan prio 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &amp;#123;0..7&amp;#125;; &lt;span class=&#34;keyword&#34;&gt;do&lt;/span&gt; ip &lt;span class=&#34;built_in&#34;&gt;link&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt; dev eth1.100 &lt;span class=&#34;built_in&#34;&gt;type&lt;/span&gt; vlan egress-qos-map &lt;span class=&#34;variable&#34;&gt;$i&lt;/span&gt;:3 ; &lt;span class=&#34;keyword&#34;&gt;done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## enable PFC on TC3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;mlnx_qos -i eth1 -f 0,0,0,1,0,0,0,0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@node1 ~]&lt;span class=&#34;comment&#34;&gt;# cat /proc/net/vlan/eth1.100 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eth1.100  VID: 100       REORDER_HDR: 1  dev-&amp;gt;priv_flags: 1001&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         total frames received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          total bytes received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      Broadcast/Multicast Rcvd            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      total frames transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       total bytes transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Device: eth1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; EGRESS priority mappings: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@node1 ~]&lt;span class=&#34;comment&#34;&gt;# for i in &amp;#123;0..7&amp;#125;; do ip link set dev eth1.100 type vlan egress-qos-map $i:3 ; done&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[root@node1 ~]&lt;span class=&#34;comment&#34;&gt;# cat /proc/net/vlan/eth1.100                                                      &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;eth1.100  VID: 100       REORDER_HDR: 1  dev-&amp;gt;priv_flags: 1001&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;         total frames received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          total bytes received            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      Broadcast/Multicast Rcvd            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      total frames transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;       total bytes transmitted            0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Device: eth1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; EGRESS priority mappings: 0:3 1:3 2:3 3:3 4:3 5:3 6:3 7:3 &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HowTo Set Egress Priority VLAN on Linux&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;https://community.mellanox.com/docs/DOC-2311&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Congestion Control (DCQCN)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;base Explicit Congestion Notification (ECN)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2321&#34;&gt;Understanding RoCEv2 Congestion Management&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ECN in RoCEv2&lt;ul&gt;
&lt;li&gt;RoCEv2引入了ECN机制来实现拥塞控制，即RoCEv2 Congestion Management (RCM)。通过RCM，一旦网络发生拥塞，就会通知发送端降低发送速率。与TCP类似，RoCEv2使用传输层头部Base Transport Header (BTH)的FECN标志位来标识拥塞&lt;/li&gt;
&lt;li&gt;如果收到IP.ECN为11的包，HCA生成一个RoCEv2 CNP(Congestion Notification Packet)包，返回给发送端&lt;/li&gt;
&lt;li&gt;如果收到RoCEv2 CNP包，则降低对应QP的发送速率&lt;/li&gt;
&lt;li&gt;从上一次收到RoCEv2 CNP后，经过配置的时间或者字节数，HCA可以增加对应QP的发送速率&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;RP (Injector)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reaction Point - the end node that performs rate limitation to prevent congestion&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;NP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Notification Point - the end node that receives the packets from the injector and sends back notifications to the injector for indications regarding the congestion situation&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Congestion Point - the switch queue in which congestion happens&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CNP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The RoCEv2 Congestion Notification Packet - The notification message an NP sends to the RP when it receives CE marked packets&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;[Congestion Control Loop](&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2321#jive_content_id_Congestion_Control_Loop]&#34;&gt;https://community.mellanox.com/docs/DOC-2321#jive_content_id_Congestion_Control_Loop]&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2733&#34;&gt;How To Configure RoCE over a Lossless Fabric (PFC + ECN) End-to-End Using ConnectX-4 and Spectrum (Trust L2)&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ECN with TCP&amp;#x2F;IP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ECN是一个端到端的拥塞通知机制，而不需要丢包。ECN是可选的特性，它需要端点开启ECN支持，同时底层的网络也需要支持。&lt;/li&gt;
&lt;li&gt;传统的TCP&amp;#x2F;IP网络，通过丢包来表明网络拥塞，router&amp;#x2F;switch&amp;#x2F;server都会这么做。而对于支持ECN的路由器，当发生网络拥塞时，会设置IP头部的ECN(2bits)标志位，而接收端会给发送端返回拥塞的通知(echo of the congestion indication)，然后发送端降低发送速率。由于发送速率由传输层(TCP)控制，所以，ECN需要TCP和IP层同时配合。rfc3168定义了ECN for TCP&amp;#x2F;IP。&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ECN with IP&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;IP头部有2个bit的ECN标志位：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;00 – Non ECN-Capable Transport, Non-ECT&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10 – ECN Capable Transport, ECT(0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;01 – ECN Capable Transport, ECT(1)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11 – Congestion Encountered, CE.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;ECN with TCP&lt;ul&gt;
&lt;li&gt;为了支持ECN，TCP使用了TCP头部的3个标志位：Nonce Sum (NS)，ECN-Echo (ECE)和Congestion Window Reduced (CWR)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://community.mellanox.com/docs/DOC-2894&#34;&gt;IP&amp;#x2F;Ethernet&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;By using PCP bits on the VLAN header&lt;/li&gt;
&lt;li&gt;By using DSCP bits on the IP header&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CA(Channel Adapter)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CM(Communication Manager)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;QP&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Send Queue(SQ)&lt;/li&gt;
&lt;li&gt;Receive Queue(RQ)&lt;/li&gt;
&lt;li&gt;RC (Reliable Connected)&lt;/li&gt;
&lt;li&gt;struct ibv_qp *ibv_create_qp&lt;/li&gt;
&lt;li&gt;struct ib_qp&lt;/li&gt;
&lt;li&gt;struct mlx4_ib_qp&lt;/li&gt;
&lt;li&gt;QP status&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L842&#34;&gt;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L842&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L2131&#34;&gt;https://github.com/hustcat/rdma-core/blob/v15/libibverbs/verbs.h#L2131&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;RESET  Newly created, queues empty.&lt;/li&gt;
&lt;li&gt;INIT   Basic information set. Ready for posting to receive queue.&lt;/li&gt;
&lt;li&gt;RTR    Ready to Receive. Remote address info set for connected QPs, QP may now receive packets.&lt;/li&gt;
&lt;li&gt;RTS    Ready to Send. Timeout and retry parameters set, QP may now send packets.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;BUGS&#34;&gt;&lt;a href=&#34;#BUGS&#34; class=&#34;headerlink&#34; title=&#34;BUGS&#34;&gt;&lt;/a&gt;BUGS&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://forums.developer.nvidia.com/t/mlnx-ofed-linux-5-7-1-mlx5-2-create-qp-pid-19774-create-qp-type-2-failed/232369&#34;&gt;infiniband mlx5_0: create_qp:3206:(pid 698661): Create QP type 2 failed&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;upgrade mlx5 dev firmware&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;&#34;&gt;&lt;a href=&#34;#&#34; class=&#34;headerlink&#34; title=&#34;&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://www.snia.org/sites/default/files/ESF/Optimizing-NVMe-Over-Fabrics-Performance-Final.pdf&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Default MTU is 1500B, Ethernet frame adds 18B, if not tagged, to make it 1518B maximum Ethernet frame&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;If Jumbo Frame is supported, maximum Ethernet frame can be 9000B&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Many modern OSes force the MTU transmission, regardless of upper level data size, for efficiency&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Caveat: Jumbo Frame needs to be enabled on both Initiator, Target and all network devices along the path&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://docs.nvidia.com/networking/display/mlnxofedv543580/rdma+over+converged+ethernet+(roce)#src-96900067_safe-id-UkRNQW92ZXJDb252ZXJnZWRFdGhlcm5ldChSb0NFKS1TZXR0aW5ndGhlUm9DRU1vZGVmb3JhUXVldWVQYWlyKFFQKQ&#34;&gt;RDMA over Converged Ethernet (RoCE)&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Packages-loss&#34;&gt;&lt;a href=&#34;#Packages-loss&#34; class=&#34;headerlink&#34; title=&#34;Packages loss&#34;&gt;&lt;/a&gt;Packages loss&lt;/h3&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/rdma/&t=RDMA"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Ethernet cable Active The Active cable makes use of electronics for signal conditioning   Passive The Passive cable does not make use of electronics for signal conditioning Passive twinax cables are r">
<meta property="og:type" content="article">
<meta property="og:title" content="ethernet">
<meta property="og:url" content="http://example.com/2022/11/13/ethernet/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Ethernet cable Active The Active cable makes use of electronics for signal conditioning   Passive The Passive cable does not make use of electronics for signal conditioning Passive twinax cables are r">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/tcp-state-diagram-v2.svg">
<meta property="og:image" content="http://example.com/img/duplicate-segment.svg">
<meta property="og:image" content="http://example.com/img/last-ack.svg">
<meta property="og:image" content="http://example.com/img/last-ack-reuse.svg">
<meta property="og:image" content="http://example.com/img/tshark-1.png">
<meta property="og:image" content="http://example.com/img/tshark-2.png">
<meta property="article:published_time" content="2022-11-13T08:51:06.000Z">
<meta property="article:modified_time" content="2022-12-11T14:44:03.835Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="network">
<meta property="article:tag" content="ethernet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/tcp-state-diagram-v2.svg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ethernet</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/13/cpu/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/13/rdma/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/ethernet/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/ethernet/&text=ethernet"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/ethernet/&is_video=false&description=ethernet"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ethernet&body=Check out this article: http://example.com/2022/11/13/ethernet/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/ethernet/&name=ethernet&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/ethernet/&t=ethernet"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ethernet-cable"><span class="toc-number">1.</span> <span class="toc-text">Ethernet cable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP-timer"><span class="toc-number">2.</span> <span class="toc-text">TCP timer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RTT-three-types"><span class="toc-number">2.1.</span> <span class="toc-text">RTT three types</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Retransmission-Timeout"><span class="toc-number">2.2.</span> <span class="toc-text">Retransmission Timeout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Delayed-ACK-Timer"><span class="toc-number">2.3.</span> <span class="toc-text">Delayed ACK Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Persist-Timer"><span class="toc-number">2.4.</span> <span class="toc-text">Persist Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Keepalive-Timer"><span class="toc-number">2.5.</span> <span class="toc-text">Keepalive Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FIN-WAIT-2-Timer"><span class="toc-number">2.6.</span> <span class="toc-text">FIN_WAIT_2 Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TIME-WAIT-Timer"><span class="toc-number">2.7.</span> <span class="toc-text">TIME_WAIT Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSL-Maximum-Segment-Lifetime"><span class="toc-number">2.8.</span> <span class="toc-text">MSL (Maximum Segment Lifetime)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcp-fin-timeout-and-tcp-max-tw-buckets"><span class="toc-number">2.9.</span> <span class="toc-text">tcp_fin_timeout and tcp_max_tw_buckets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcp-tw-reuse"><span class="toc-number">2.10.</span> <span class="toc-text">tcp_tw_reuse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sysctl-conf"><span class="toc-number">2.11.</span> <span class="toc-text">sysctl.conf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SLE-and-SER-in-SACK-RFC2018"><span class="toc-number">3.</span> <span class="toc-text">SLE and SER in SACK(RFC2018)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tools"><span class="toc-number">4.</span> <span class="toc-text">Tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-retrans"><span class="toc-number">5.</span> <span class="toc-text">tcp retrans</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcpdump-802-3-header"><span class="toc-number">5.1.</span> <span class="toc-text">tcpdump 802.3 header</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-netif-rx"><span class="toc-number">6.</span> <span class="toc-text">tcp netif_rx</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ethernet
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-13T08:51:06.000Z" itemprop="datePublished">2022-11-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Network/">Network</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ethernet/" rel="tag">ethernet</a>, <a class="tag-link-link" href="/tags/network/" rel="tag">network</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="Ethernet-cable"><a href="#Ethernet-cable" class="headerlink" title="Ethernet cable"></a><a target="_blank" rel="noopener" href="https://cshihong.github.io/2020/08/23/%E5%85%89%E7%BA%A4%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">Ethernet cable</a></h3><ul>
<li>Active<ul>
<li>The Active cable makes use of electronics for signal conditioning</li>
</ul>
</li>
<li>Passive<ul>
<li>The Passive cable does not make use of electronics for signal conditioning<ul>
<li>Passive twinax cables are rated for ranges up to 5m and provide a good working solutions at a great cost</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.arista.com/assets/data/pdf/Arista100G_TC_QA.pdf">Arista 100G cable</a><br><a target="_blank" rel="noopener" href="https://www.arista.com/assets/data/pdf/Arista100G_TC_QA.pdf">Mellanox 100G DAC cable</a><br><a target="_blank" rel="noopener" href="https://www.mellanox.com/sites/default/files/products/interconnect/pdf/Mellanox_Cable_Management_Guidelines_and_FAQs_Application_Note.pdf">Mellanox cable </a></p>
<ul>
<li><p>PCC (passive copper cable)</p>
<ul>
<li>A high-speed electrical cable with an SFP or QSFP connector in each end, but no active components in the RF connections. The term ‘passive’ means that there is no active processing of the electrical signal.</li>
</ul>
</li>
<li><p>Direct Attach Copper cable (DAC)</p>
<ul>
<li>direct electrical connection between cable ends</li>
<li>The DACs still have an EEPROM, a memory chip in each end, so the host system can read which type of cable is plugged in, and how much attenuation it should expect.</li>
</ul>
</li>
<li><p>Active Optical cable (AOC)</p>
<ul>
<li>Electrical conversion to optics transmitted over integrated optical fibers</li>
<li>An optical fiber cable iwth an optical transceiver with the fibers bonded inside and not removeable</li>
</ul>
</li>
<li><p>Optical Transceivers</p>
<ul>
<li>Electrical conversion to optics over fibers with optical connectors<ul>
<li>More expensive SR(short range),SR4(Short range 4 channels)</li>
<li>4 parallecl multi-mode fibers<ul>
<li>100m after which the signal degrades</li>
</ul>
</li>
<li>4 parallecl single-mode fibers<ul>
<li>Parallel single-mode transceivers(PSM4) are used from 500m-2km the ost of 8 fibers adds up with each meter</li>
<li>Multiplexing the four channels signals into two single fibers is more economical with CWDM4(Coarse Wavelength division multiplexer 4 channels) for up 2KM and LR4(long range 4 channels) up to 10km</li>
</ul>
</li>
<li>4 Channels multiplexed over 2 single-mode fibers</li>
</ul>
</li>
</ul>
</li>
<li><p>Connector Types</p>
<ul>
<li>SFP (Small Formfactor Pluggable)<ul>
<li>A transceiver or cable with a single lane(channel) in each direction</li>
</ul>
</li>
<li>SFP+ denotes the 10~14Gb&#x2F;s type of AOC&#x2F;transceivers</li>
<li>QSFP(Quad small Formfactor Pluggable)<ul>
<li>A bidirectional transceiver or cable with 4 lanes in each direction</li>
</ul>
</li>
<li>QSFP+ denotes cables&#x2F;transceivers for 4x (10<del>14)Gbps applications, while QSFP28 denotes the 4 x(24</del>28)&#x3D;100Gbps product range with QSFP form factor</li>
<li>QSFP-DD(double-density) support up to 400Gbps in aggregate over an 8x 50Gbps electrical interface.</li>
<li>Transceiver (transmitter and receiver) is a converter with an electrical connector in one end and optical connector in the other end</li>
</ul>
</li>
<li><p>Optical Transmission and Fiber Types</p>
<ul>
<li>MMF(multi-mode fiber)<ul>
<li>The type of fiber used for VCSEL (Vertical Cavity Surface<br>Emitting Laser) based transmission, normally operating at 850 nm wavelength. Its maximum reach is 100 m for 25 Gb&#x2F;s line rates.</li>
</ul>
</li>
<li>OM2&#x2F;3&#x2F;4(optical multi-mode) are classiffications of MMF for different reach.<ul>
<li>higher number indicates lower degradation of the optical signal, and longer reach. MMF cables usually have the following color scheme</li>
<li>OM2 orange used for data rates at 1~14 Gbps, 62.5 μm fiber core diameter</li>
<li>OM3 aqua or teal 70m reach for 25&#x2F;100Gbps transceivers, 50 μm fiber core diameter</li>
<li>OM4 aqua or purple 100m reach for 25&#x2F;100Gbps transceivers, 50-um core diameter</li>
<li>OM5 aqua green not commonly used</li>
</ul>
</li>
</ul>
</li>
<li><p>Optical connector type</p>
<ul>
<li>MPO (Multi-fiber plush on)<ul>
<li>is a connector standard supporting multiple rows with up to 12<br>fibers in each. A QSFP transceiver with MPO receptacle uses the outermost 4 positions on each side</li>
</ul>
</li>
<li>MTP<ul>
<li>are a vendor specific proprietary high-precision version of MPO connectors</li>
</ul>
</li>
<li>LC<ul>
<li>are used for both single-mode and multi-mode fibers and used in both SFP and QSFP MSA transceivers</li>
</ul>
</li>
</ul>
</li>
<li><p>diff 100GbE IB and Ethernet cable</p>
<ul>
<li>CDR (clock and data retimeing) default status</li>
<li>IB EDR CDR is bypsswd&#x2F;disabled this ensures backward compatibility to FDR devices</li>
<li>EThernet 100G: The CDR is default on, and must be disabled at lower data rates, eg: 40Gbps</li>
<li>Copper cables<ul>
<li>IB EDR: The link budget usually assumes that the signal attenuation is small enough to allow operation without Forward Error Correction (FEC).</li>
<li>Ethernet 100G: RS-FEC enabled by default</li>
</ul>
</li>
<li>Identifier<ul>
<li>IB EDR and QSFP+ backward compatibility to FDR devices</li>
<li>Ethernet 100G: QSFP28<ul>
<li>The EEPROM memory map of QSFP28 (100 Gb&#x2F;s cables&#x2F;transceivers) is defined in specification SFF-8636 and for SFP28 (25 Gb&#x2F;s cables&#x2F;transceivers) in SFF-8472</li>
</ul>
</li>
</ul>
</li>
<li>Bit error ratios<ul>
<li>IEEE defines the BER of 1E-5 for Ethernet that is corrected with FEC in the host to 1E-12</li>
<li>InfiniBand assumes no use of FEC in the host and requires 1E-15 BER.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The Ethernet standards define FEC (Forward Error Correction) on by default for AOCs and optical transceivers. This implies that the Bit Error Rate (BER &#x3D; bit errors&#x2F;bits transmitted) maximum is 1E-12 after FEC (pre-FEC of maximum 1E-5). All LinkX products are tested in Mellanox end-to-end systems for pre-FEC BER of 1E-15 as part of our product qualification, more specifically the System Level Performance Quality Assurance (SLPQA) test.</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>meters</th>
<th>Standard</th>
</tr>
</thead>
<tbody><tr>
<td>QSFP 100GbE Transceivers (OM3 70m&#x2F;4 100m)</td>
<td>70~100</td>
<td>100(100GBASE-SR10),70(100GBASE-SR4, SR&#x3D;short reach)</td>
</tr>
<tr>
<td></td>
<td>10k</td>
<td>100GBASE-LR4, LR&#x3D;long reach</td>
</tr>
<tr>
<td></td>
<td>80k</td>
<td>100GBASE-ZR, it is not an IEEE standard</td>
</tr>
<tr>
<td>QSFP 100GbE Transceivers</td>
<td>500,2k,10k,40k</td>
<td>10k(100GBASE-LR4),40k(100GBASE-ER4, ER&#x3D;Extended reach)</td>
</tr>
<tr>
<td>100GbE QSFP to QSFP Active Optical cable</td>
<td>3~30</td>
<td>Based on IEEE 100GBASE-SR4</td>
</tr>
<tr>
<td>QSFP+ to QSFP+ passive Twinax Copper Cables</td>
<td>0.5~5</td>
<td>100GBASE-ER4(The 802.3bj covers the electrical)</td>
</tr>
<tr>
<td>100GbE QSFP28 Direct Attach Copper Cable</td>
<td>3~7</td>
<td>5m(IEEE 802.3bj CA-25G-L),2m(IEEE 802.3bj CA-25G-N, 100BASE-CR4)</td>
</tr>
</tbody></table>
<p>AOC not support DDM(Digital Diagnostic Monitoring)&#x2F;DOM(Digital optical monitoring)<br>RGD means rugged transceivers, and can operate under more extreme conditions<br>Physical Media Devices (PMDs)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">                            nTYPE-LLLm</span><br><span class="line">                            | |   ||||</span><br><span class="line">10 10Mb/s-------------------- |   ||||</span><br><span class="line">2.5G 2.5Gb/s                  |   |||-----------Trailing number</span><br><span class="line">10G  10Gb/s                   |   |||            1,4,8,10,16 pairs or lanes</span><br><span class="line">24/40/100/400 Gbps            |   ||------------Third letter</span><br><span class="line">                              |   ||            M multimode</span><br><span class="line">                              |   ||</span><br><span class="line">                              |   ||</span><br><span class="line">Modulation TYPE----------------   ||</span><br><span class="line">BASE    Baseband                  ||</span><br><span class="line">BROAD   Broadband                 |-----------------Second letter</span><br><span class="line">PASS    Passband                  |                 P PAM4</span><br><span class="line">                                  First letter      R Scrambled</span><br><span class="line">                                  B Bidirectional   W WAN coding</span><br><span class="line">                                  C Twin-ax copper  X External coding</span><br><span class="line">                                  E Extra long or 40km</span><br><span class="line">                                  F fiber or 2km</span><br><span class="line">                                  K Backplane</span><br><span class="line">                                  L long or 10km</span><br><span class="line">                                  P PON</span><br><span class="line">                                  S Short or 100</span><br><span class="line">                                  T twisted pair</span><br></pre></td></tr></table></figure>

<h3 id="TCP-timer"><a href="#TCP-timer" class="headerlink" title="TCP timer"></a><a target="_blank" rel="noopener" href="http://blog.qiusuo.im/blog/2014/03/19/tcp-timeout/">TCP timer</a></h3><p><a href="/img/Tcp_state_diagram.png"></a></p>
<h4 id="RTT-three-types"><a href="#RTT-three-types" class="headerlink" title="RTT three types"></a><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/tcp-timers/">RTT three types</a></h4><p>Measured RTT(RTTm) – The measured round-trip time for a segment is the time required for the segment to reach the destination and be acknowledged, although the acknowledgment may include other segments.</p>
<p>Smoothed RTT(RTTs) – It is the weighted average of RTTm. RTTm is likely to change and its fluctuation is so high that a single measurement cannot be used to calculate RTO.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Initially -&gt; No value</span><br><span class="line">After the first measurement -&gt; RTTs=RTTm</span><br><span class="line">After each measurement -&gt; RTTs= (1-t)*RTTs + t*RTTm</span><br><span class="line">Note: t=1/8 (default <span class="keyword">if</span> not given)</span><br></pre></td></tr></table></figure>

<p>Deviated RTT(RTTd) – Most implementation do not use RTTs alone so RTT deviated is also calculated to find out RTO.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Initially -&gt; No value</span><br><span class="line">After the first measurement -&gt; RTTd=RTTm/2</span><br><span class="line">After each measurement -&gt; RTTd= (1-k)*RTTd + k*(RTTm-RTTs)</span><br><span class="line">Note: k=1/4 (default if not given)</span><br></pre></td></tr></table></figure>

<h4 id="Retransmission-Timeout"><a href="#Retransmission-Timeout" class="headerlink" title="Retransmission Timeout"></a>Retransmission Timeout</h4><p>RTO calculation – The value of RTO is based on the smoothed round-trip time and its deviation. Most implementations use the following formula to calculate the RTO:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Initial value -&gt; Original (given in question)</span><br><span class="line">After any measurement -&gt; RTO=RTTs + 4*RTTd</span><br><span class="line">#NOTE: At every retransmission the value of RTO doubles. ( RTO(new) = RTO(before retransmission) *2 )</span><br><span class="line"></span><br><span class="line">## in linux</span><br><span class="line">tcp_retries1 (integer; default: 3; since Linux 2.2)</span><br><span class="line"></span><br><span class="line">The number of times TCP will attempt to retransmit a packet on an established connection normally, without the extra effort of getting the network layers involved. Once we exceed this number of retransmits, we first have the network layer update the route if possible before each new retransmit. The default is the RFC specified minimum of 3.</span><br><span class="line"></span><br><span class="line">tcp_retries2 (integer; default: 15; since Linux 2.2)</span><br><span class="line"></span><br><span class="line">The maximum number of times a TCP packet is retransmitted in established state before giving up. The default value is 15, which corresponds to a duration of approxi‐mately between 13 to 30 minutes, depending on the retransmission timeout. The RFC 1122 specified minimum limit of 100 seconds is typically deemed too short.</span><br></pre></td></tr></table></figure>

<h4 id="Delayed-ACK-Timer"><a href="#Delayed-ACK-Timer" class="headerlink" title="Delayed ACK Timer"></a>Delayed ACK Timer</h4><p>If reach the timeout, reply the ACK, if in the timeout range, it will wait data to transmit, 200 ms in Microsoft Windows by default</p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/reducing_the_tcp_delayed_ack_timeout">In real time system</a></p>
<ul>
<li>This mode is used at the start of a TCP connection so that the congestion window can grow quickly.</li>
<li>The acknowledgment (ACK) timeout interval (ATO) is set to tcp_ato_min, the minimum timeout value.</li>
<li>To change the default TCP ACK timeout value, write the required value in milliseconds to the &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_ato_min file<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo 4 &gt; /proc/sys/net/ipv4/tcp_ato_min</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Delayed ACK</p>
<ul>
<li>After the connection is established, TCP assumes this mode, in which ACKs for multiple received packets can be sent in a single packet.</li>
<li>ATO is set to tcp_delack_min to restart or reset the timer.</li>
<li>To change the default TCP Delayed ACK value, write the required value in milliseconds to the &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_delack_min file:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 4 &gt; /proc/sys/net/ipv4/tcp_delack_min</span><br></pre></td></tr></table></figure>
TCP switches between the two modes depending on the current congestion.<br>Some applications that send small network packets could experience latencies due to the TCP quick and delayed acknowledgment timeouts, which previously were 40 ms by default. That means small packets from an application that seldom sends information through the network could experience a delay up to 40 ms to receive the acknowledgment that a packet has been received by the other side. To minimize this issue, both tcp_ato_min and tcp_delack_min timeouts are now 4 ms by default.</li>
</ul>
<h4 id="Persist-Timer"><a href="#Persist-Timer" class="headerlink" title="Persist Timer"></a>Persist Timer</h4><p>When receive the zero window, stop to transmit data.<br>The RFC1122 suggest the window probe timer is RTO</p>
<h4 id="Keepalive-Timer"><a href="#Keepalive-Timer" class="headerlink" title="Keepalive Timer"></a>Keepalive Timer</h4><p>In the tcp_keepalive_intvl, the server will send the Probe Segment to make sure the other side is online ? if no respond, it will resend until timeout, if timeout that means the other side has crash.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tcp_keepalive_intvl (<span class="built_in">integer</span>; default: 75; since Linux 2.4)</span><br><span class="line">The number of seconds between TCP keep-alive probes.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_probes (<span class="built_in">integer</span>; default: 9; since Linux 2.2)</span><br><span class="line">The maximum number of TCP keep-alive probes to send before giving up and killing the connection <span class="keyword">if</span> no response is obtained from the other end.</span><br><span class="line"></span><br><span class="line">tcp_keepalive_time (<span class="built_in">integer</span>; default: 7200; since Linux 2.2)</span><br><span class="line">The number of seconds a connection needs to be idle before TCP begins sending out keep-alive probes. Keep-alives are only sent when the SO_KEEPALIVE socket option is enabled. The default value is 7200 seconds (2 hours). An idle connection is terminated after approximately an additional 11 minutes (9 probes an interval of 75 sec‐onds apart) when keep-alive is enabled.</span><br></pre></td></tr></table></figure>

<h4 id="FIN-WAIT-2-Timer"><a href="#FIN-WAIT-2-Timer" class="headerlink" title="FIN_WAIT_2 Timer"></a>FIN_WAIT_2 Timer</h4><p>The activer try to disable the tcp connection, send the FIN and get the ACK, the activer to convert the FIN_WAIT_1 to FIN_WAIT_2 and it could not send any data, just wait the FIN from the client. if the client down or don’t send the FIN to the activer, same with Dos attack.<br>If timeout, give up the tcp connection.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcp_fin_timeout (<span class="built_in">integer</span>; default: 60; since Linux 2.2)</span><br><span class="line">This specifies how many seconds to <span class="built_in">wait</span> <span class="keyword">for</span> a final FIN packet before the socket is forcibly closed. This is strictly a violation of the TCP specification, but required to prevent denial-of-service attacks. In Linux 2.2, the default value was 180.</span><br></pre></td></tr></table></figure>

<h4 id="TIME-WAIT-Timer"><a href="#TIME-WAIT-Timer" class="headerlink" title="TIME_WAIT Timer"></a>TIME_WAIT Timer</h4><p>timeout &#x3D; 2xMSL<br>Linux was net.ipv4.tcp_fin_timeout &#x3D; 60</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TCP_TIMEWAIT_LEN (60*HZ) <span class="comment">/* how long to wait to destroy TIME-WAIT</span></span></span><br><span class="line"><span class="comment"><span class="meta">                              * state, about 60 seconds     */</span></span></span><br></pre></td></tr></table></figure>

<p>the server(FIN_WAIT_2) receive the FIN from the client, after the server reply the ACK,the server will convert FIN_WAIT_2 to TIME_WAIT and start the TIME_WAIT timer<br>and the ack loss, when the client will retrans the FIN to the server.</p>
<ol>
<li><p>if the server not in TIME_WAIT, if the port re-use for another application, maybe the application will go to the wrong state. if the connection in the TIME_WAIT state, it ‘s OK.<br>So the TIME_WAIT must be a long time enough, to avoid the wandering duplicates</p>
</li>
<li><p>because the ack package loss, if the activer has disable the A tcp connection, the client is waitting the ack. if the activer want create a new tcp connection to use the same port, the activer will send the SYN packet, the client is waitting the ack, the client will reply the RST cause the new connection interrupt</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">When the persist timer expires, 1 byte of data is sent(segment 6). The receiving application has <span class="built_in">read</span> 256 bytes from the receivebuffer (at time 3.99), so the byte is accepted and acknowledged (segment 7).But the advertised window is still 0, since the receiver does not have room foreither one full-sized segment or one-half of its buffer. This is silly windowavoidance by the receiver.</span><br><span class="line"></span><br><span class="line">tcp_rcv_state_process</span><br><span class="line">    |--&gt;tcp_time_wait</span><br><span class="line">           |--&gt;inet_twsk_alloc</span><br><span class="line">           |      |--&gt;setup_pinned_timer(&amp;tw-&gt;tw_timer, tw_timer_handler,(unsigned long)tw);</span><br><span class="line">           |--&gt;__inet_twsk_schedule(tw, timeo, <span class="literal">false</span>);</span><br><span class="line">                  |--&gt;mod_timer(&amp;tw-&gt;tw_timer, jiffies + timeo);</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="comment"># TIME_WAIT port use the new tcp connection</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"><span class="comment"># In some NAT/loading balancing env cause DROP the SYN packet and reply the RST</span></span><br><span class="line"><span class="comment"># remove from linux kernel 4.10</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fin_timeout = 60</span><br><span class="line">net.ipv4.ip_local_port_range = 32768 60999</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000</span><br><span class="line"><span class="comment"># TIME_WAIT socket max number</span></span><br></pre></td></tr></table></figure>

<h4 id="MSL-Maximum-Segment-Lifetime"><a href="#MSL-Maximum-Segment-Lifetime" class="headerlink" title="MSL (Maximum Segment Lifetime)"></a>MSL (Maximum Segment Lifetime)</h4><ul>
<li><p>2MSL server&#x2F;client send the close request in the last ack(time wait status), timewait &#x3D; 2MSL ? after timeout ,send fin ? in this time, the port could not be used.</p>
<ul>
<li>if you set SO_REUSEPORT, don ‘t to wait 2MSL to use the port SO_REUSEPORT (since Linux 3.9)</li>
<li>Permits multiple AF_INET or AF_INET6 sockets to be bound to an identical socket address.  This option must be set on each socket (including the first socket) prior to calling bind(2) on the socket.  To prevent port hijacking, all of the processes binding to the same address must have the same effective UID.  This option can be employed with both TCP an UDP sockets.</li>
<li>the SO_REUSEPORT socket option support was implemented in a series of patches by Tom Herbert. The new socket option allows multiple sockets on the same host to bind to the same port, and is intended to improve the performance of multithreaded network server applications running on top of multicore systems.</li>
</ul>
</li>
<li><p>TTL (time to live) in ip head   </p>
</li>
<li><p>MSL(Maximum segment lifetime) &gt; TTL(Time-to-live)  </p>
</li>
<li><p>RTT (round-trip time)      </p>
</li>
<li><p>packets per second (pps)</p>
</li>
<li><p>bytes per second (bps)</p>
</li>
</ul>
<h4 id="tcp-fin-timeout-and-tcp-max-tw-buckets"><a href="#tcp-fin-timeout-and-tcp-max-tw-buckets" class="headerlink" title="tcp_fin_timeout and tcp_max_tw_buckets"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/41776">tcp_fin_timeout and tcp_max_tw_buckets</a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">If you set too large value to tcp_fin_timeout, the system may become out of port, file-descripter and memory. If you set too small value, the system may leak delayed packets.</span><br><span class="line">If you set too large value to tcp_max_tw_buckets, the system may become out of port, file-descripter and memory. If you set too small value, the system may not communicate another host.</span><br><span class="line"></span><br><span class="line">TCP(7)</span><br><span class="line"></span><br><span class="line">       tcp_fin_timeout (integer; default: 60)</span><br><span class="line">              This  specifies  how many seconds to wait for a final FIN packet</span><br><span class="line">              before the socket is forcibly closed.  This is strictly a viola-</span><br><span class="line">              tion  of  the TCP specification, but required to prevent denial-</span><br><span class="line">              of-service attacks.  In Linux 2.2, the default value was 180.</span><br><span class="line">&lt;snip&gt;</span><br><span class="line">       tcp_max_tw_buckets (integer; default: see below)</span><br><span class="line">              The  maximum number of sockets in TIME_WAIT state allowed in the</span><br><span class="line">              system.  This limit exists only to prevent simple denial-of-ser-</span><br><span class="line">              vice  attacks.   The  default  value  of  NR_FILE*2  is adjusted</span><br><span class="line">              depending on the memory  in  the  system.   If  this  number  is</span><br><span class="line">              exceeded, the socket is closed and a warning is printed.</span><br><span class="line">&lt;snip&gt;</span><br><span class="line">       TCP_LINGER2</span><br><span class="line">              The  lifetime  of orphaned FIN_WAIT2 state sockets.  This option</span><br><span class="line">              can be used to override the system wide  sysctl  tcp_fin_timeout</span><br><span class="line">              on  this  socket.  This is not to be confused with the socket(7)</span><br><span class="line">              level option SO_LINGER.  This option should not be used in  code</span><br><span class="line">              intended to be portable.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="tcp-tw-reuse"><a href="#tcp-tw-reuse" class="headerlink" title="tcp_tw_reuse"></a><a target="_blank" rel="noopener" href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">tcp_tw_reuse</a></h4><p>NOTE: net.ipv4.tcp_tw_recycle has been removed from Linux 4.12<br>Linux will randomize timestamp offsets for each connection, making this option completely broken, with or without NAT. It has been completely removed from Linux 4.12.<br>The LAST-ACK state is handled in the exact same way as for net.ipv4.tcp_tw_recycle.  </p>
<p>By enabling net.ipv4.tcp_tw_reuse, Linux will reuse an existing connection in the TIME-WAIT state for a new outgoing connection if the new timestamp is strictly bigger than the most recent timestamp recorded for the previous connection: an outgoing connection in the TIME-WAIT state can be reused after just one second.<br><img src="/img/tcp-state-diagram-v2.svg"><br><img src="/img/duplicate-segment.svg"><br>Due to a shortened TIME-WAIT state, a delayed TCP segment has been accepted in an unrelated connection.<br>The other purpose is to ensure the remote end has closed the connection. When the last ACK is lost, the remote end stays in the LAST-ACK state. Without the TIME-WAIT state, a connection could be reopened while the remote end still thinks the previous connection is valid. When it receives a SYN segment (and the sequence number matches), it will answer with a RST as it is not expecting such a segment. The new connection will be aborted with an error<br><img src="/img/last-ack.svg"><br>If the remote end stays in LAST-ACK state because the last ACK was lost, opening a new connection with the same quadruplet will not work.<br>RFC 793 requires the TIME-WAIT state to last twice the time of the MSL. On Linux, this duration is not tunable and is defined in include&#x2F;net&#x2F;tcp.h as one minute:  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define TCP_TIMEWAIT_LEN (60*HZ) /* how long to wait to destroy TIME-WAIT</span></span><br><span class="line">                                  * state, about 60 seconds     */</span><br></pre></td></tr></table></figure>
<p>If the FIN segments are received in a timely manner, the local end socket will still be in the TIME-WAIT state and the expected ACK segments will be sent.<br>Once a new connection replaces the TIME-WAIT entry, the SYN segment of the new connection is ignored (thanks to the timestamps) and won’t be answered by a RST but only by a retransmission of the FIN segment. The FIN segment will then be answered with a RST (because the local connection is in the SYN-SENT state) which will allow the transition out of the LAST-ACK state. The initial SYN segment will eventually be resent (after one second) because there was no answer and the connection will be established without apparent error, except a slight delay:<br><img src="/img/last-ack-reuse.svg">   </p>
<h4 id="sysctl-conf"><a href="#sysctl-conf" class="headerlink" title="sysctl.conf"></a>sysctl.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># each socket will use some fd</span></span><br><span class="line">fs.file-max = 1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcp short connection will cause a lot of TIME_WAIT</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 7000</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable tcp source trace</span></span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># set timeout</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_fin_timeout = xx</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_syn_retries= xx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#TIMEOUT socket re-use</span></span><br><span class="line">net.ipv4.tcp_tw_reuse= 1</span><br><span class="line">net.ipv4.tcp_timestamps = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># socket buffer to 256MB</span></span><br><span class="line">net.core.rmem_max = 268435456</span><br><span class="line">net.core.wmem_max = 268435456</span><br><span class="line"><span class="comment"># allow tcp ipv4 buffer auto-tuning up to 256MB</span></span><br><span class="line"><span class="comment"># min,init,maxinum size</span></span><br><span class="line">net.ipv4.tcp_rmem = 65536 134217728 268435456</span><br><span class="line">net.ipv4.tcp_wmem = 65536 134217728 268435456</span><br><span class="line">net.ipv4.tcp_mem = 65536 134217728 268435456</span><br><span class="line"></span><br><span class="line">kernel.numa_balancing=0</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_frto=1</span><br><span class="line"><span class="comment">#Because packets out of order or another issue trigger the packet RTO, but the packet was not loss, it &#x27;s misjudging, that means Spurious retransmission timeouts.</span></span><br><span class="line"><span class="comment">#Active F-RTO</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_frto=2</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_no_metrics_save = 1</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line"><span class="comment">#net.ipv4.tcp_syn_retries = 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># works best with &gt;= 500 client computers ##</span></span><br><span class="line">net.ipv4.neigh.default.gc_interval = 3600</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 3600</span><br><span class="line">net.ipv4.neigh.default.gc_thresh3 = 8192</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2 = 4096</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1 = 2048</span><br><span class="line"><span class="comment"># Keep alive</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 60</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_time = 7200</span><br><span class="line"></span><br><span class="line">[Thin-stream](https://nnc3.com/mags/LJ_1994-2014/LJ/219/11180.html)</span><br><span class="line"><span class="comment"># default eq 0</span></span><br><span class="line">sysctl -w net.ipv4.tcp_thin_linear_timeouts=1</span><br><span class="line">sysctl -w net.ipv4.tcp_thin_dupack=1</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/tcp_thin_linear_timeouts</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/tcp_thin_dupack</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="SLE-and-SER-in-SACK-RFC2018"><a href="#SLE-and-SER-in-SACK-RFC2018" class="headerlink" title="SLE and SER in SACK(RFC2018)"></a>SLE and SER in SACK(RFC2018)</h3><ul>
<li><p>tcpdump will show some packet show “SLE&#x3D;20480 SER&#x3D;24576”</p>
<ul>
<li>SLE: Sequence Left Edge of already acknowledged data when Selective Acknowledgments are used</li>
<li>SRE: Sequence Right Edge of already acknowledged data when Selective Acknowledgments are used</li>
</ul>
</li>
<li><p>When server send the package length from 1~24576, the client just return ack&#x3D;$((seq+18736))</p>
<ul>
<li>The client receive 18736 bytes, and recevice the out of order packets from 20480<del>24576 bytes, and just loss from 18737</del>20479 Bytes</li>
<li>The server don ‘t need to retrans 20480 to 24576 bytes. if the system not enable sack, it will retrans from 18737~24576</li>
</ul>
</li>
</ul>
<h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ss -tan state time-wait</span><br><span class="line">$ dmesg | grep &quot;TCP established hash table&quot;</span><br><span class="line">[    1.041036] TCP established hash table entries: 524288 (order: 10, 4194304 bytes)</span><br><span class="line">$ dmesg | grep &quot;TCP bind hash table&quot;</span><br><span class="line">[    1.041724] TCP bind hash table entries: 65536 (order: 8, 1048576 bytes)</span><br><span class="line"></span><br><span class="line">$ slabtop -o | grep -E &#x27;(^  OBJS|tw_sock_TCP|tcp_bind_bucket)&#x27;</span><br><span class="line"></span><br><span class="line">$ ethtool -s p4p2 speed 1000 duplex full autoneg off</span><br><span class="line">$ grep ETHTOOL_OPTS /etc/sysconfig/network-scripts/ifcfg-p4p1</span><br><span class="line">ETHTOOL_OPTS=speed 1000 duplex full</span><br><span class="line">$ systemctl restart network</span><br><span class="line">$ ifconfig eth0 txqueuelen 3000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="tcp-retrans"><a href="#tcp-retrans" class="headerlink" title="tcp retrans"></a><a target="_blank" rel="noopener" href="http://perthcharles.github.io/2015/09/07/wiki-tcp-retries/">tcp retrans</a></h3><p>RTO(retransmission timeout)<br>RRT(round-trip time)<br>TCP keep the weight value SRTT(smoothed RRT)</p>
<p>The latest RRTS &#x3D; (1-a) * ( last RTTS) + a * (the lastest RRT)<br>In RFC2988, a &#x3D; 1&#x2F;8<br>RTTD was the RTT deviation weight value<br>First get RTTD, RTTD value &#x3D; RRT&#x2F;2<br>Next the RTTD&#x3D;(1-B)<em>(the last RTTD) + B(RTTS-the lastest RRT)<br>RFC B&#x3D;1&#x2F;4<br>RTO&#x3D; RTTS + 4</em>RTTD<br>The RFC suggest if the message retrans, this RRT value will be drop<br>When the trigger tcp retrans, the latest RTO * 2 &#x3D; the last RTO until the maximum</p>
<p>But RFC !&#x3D; the real implementation</p>
<p><a target="_blank" rel="noopener" href="https://ms2008.github.io/2017/04/14/tcp-timeout/">tcp_syn_retries 三次握手</a><br>net.ipv4.tcp_syn_retries retrans interval was [1,3,7,15,31]s</p>
<p>tcp_syn_retries2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">if tcp_retries2=15，the timeout was 924600ms。</span><br><span class="line"></span><br><span class="line">1. If RTT is tiny that the RTO init value was about 200ms</span><br><span class="line">   The total timeout was 924600ms，looks like retrans 15 times cause over the timeout value and end the tcp stream</span><br><span class="line"></span><br><span class="line">2. If RTT is large,the RTO calculate value was 1000ms</span><br><span class="line">   it doesn&#x27; t need retrans 15 times，the timeout value will over 924600ms.</span><br><span class="line">   if the RTT=400ms,set tcp_retries2=10, only 3 times the tcp stream will end</span><br><span class="line"></span><br><span class="line">[tcpretrans](https://github.com/brendangregg/perf-tools)</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">$ nstat -rsz | grep -Ei &#x27;fail|crc|dis|drop|miss|err|over|timeout|jabb&#x27;</span><br><span class="line">TcpExtTCPSackFailures           559232             0.0</span><br><span class="line">TcpExtTCPLossFailures           44575              0.0</span><br><span class="line">TcpExtTCPRenoRecoveryFail       0                  0.0</span><br><span class="line">TcpExtTCPSackRecoveryFail       400237             0.0</span><br><span class="line">TcpExtTCPSchedulerFailed        0                  0.0</span><br><span class="line">TcpExtTCPAbortFailed            3                  0.0</span><br><span class="line">TcpExtTCPSACKDiscard            0                  0.0</span><br><span class="line">TcpExtTCPBacklogDrop            0                  0.0</span><br><span class="line">TcpExtPFMemallocDrop            0                  0.0</span><br><span class="line">TcpExtTCPMinTTLDrop             0                  0.0</span><br><span class="line">TcpExtTCPDeferAcceptDrop        0                  0.0</span><br><span class="line">TcpExtTCPReqQFullDrop           0                  0.0</span><br><span class="line">TcpExtTCPRetransFail            631                0.0</span><br><span class="line">TcpExtTCPOFODrop                15819              0.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ netstat -s | grep -i retrans</span><br><span class="line">    36900 segments retransmited</span><br><span class="line">    TCPLostRetransmit: 135</span><br><span class="line">    36854 fast retransmits</span><br><span class="line">    32 forward retransmits</span><br><span class="line">    9 retransmits in slow start</span><br><span class="line">    5 SACK retransmits failed</span><br><span class="line">$ netstat -s | grep -i retrans</span><br><span class="line">    36963 segments retransmited</span><br><span class="line">    TCPLostRetransmit: 135</span><br><span class="line">    36917 fast retransmits</span><br><span class="line">    32 forward retransmits</span><br><span class="line">    9 retransmits in slow start</span><br><span class="line">    5 SACK retransmits failed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ tshark -r first.pcapng &quot;tcp.analysis.retransmission&quot;</span><br><span class="line">no output</span><br><span class="line"></span><br><span class="line">$ tshark -r first.pcapng &quot;tcp.analysis.duplicate_ack&quot;</span><br><span class="line"></span><br><span class="line">21801 0.710632534   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#1] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794721 TSecr=61820560 SLE=777178578 SRE=777375434</span><br><span class="line">21804 0.710733730   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#2] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794721 TSecr=61820560 SLE=777178578 SRE=777500706</span><br><span class="line">21811 0.711034519   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#3] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=777867574</span><br><span class="line">21814 0.711153496   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#4] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778010742</span><br><span class="line">21816 0.711206308   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#5] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778082326</span><br><span class="line">21818 0.711259113   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#6] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778144962</span><br><span class="line">21820 0.711369837   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#7] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778279182</span><br><span class="line">21823 0.711477980   10.53.19.1 -&gt; 10.53.19.2   TCP 78 [TCP Dup ACK 21799#8] targus-getdata1 &gt; 40746 [ACK] Seq=1 Ack=777160682 Win=5263360 Len=0 TSval=2597794722 TSecr=61820560 SLE=777178578 SRE=778413402</span><br></pre></td></tr></table></figure>

<p><img src="/img/tshark-1.png"><br><img src="/img/tshark-2.png"></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://osqa-ask.wireshark.org/questions/21006/tcp-dup-acktcp-retransmission">TCP has this inherent mechanism of recovery. In tcp stream eq 8 of your trace there was a condition of retransmission generated due to timing but not because of drops. Here is the snippet of your trace</a></p>
</li>
<li><p>Server send a packet to client(Let us call it packet-A){Packet.no-150}</p>
</li>
<li><p>Client acknowledged the packet (Let us call it ack-A){Packet.no-192}</p>
</li>
<li><p>Somehow packet-A was retransmitted by Server.The reason might be the delay in receiving ack-A from client and ack timer got out and retransmission timer got kicked in.(Dup of Packet-A){Packet.no-194}</p>
</li>
<li><p>Client generated a duplicate ack for the retransmitted packet.(Dup of ack-A){Packet.no-195}</p>
</li>
</ul>
<h4 id="tcpdump-802-3-header"><a href="#tcpdump-802-3-header" class="headerlink" title="tcpdump 802.3 header"></a><a target="_blank" rel="noopener" href="https://support.f5.com/csp/article/K2289">tcpdump 802.3 header</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">LACP is handled by the switch fabric, therefore packets must be captured directly on the physical interface, <span class="keyword">for</span> example, 1.1, as opposed to the VLAN or 0.0.</span><br><span class="line"></span><br><span class="line">To capture only LACP packets, use the following syntax:</span><br><span class="line"></span><br><span class="line">tcpdump -ni &lt;interface&gt; -e ether proto 0x8809</span><br><span class="line"></span><br><span class="line">Note: The -e switch prints the link-level header on each line.</span><br><span class="line"></span><br><span class="line">For example, to capture LACP packets on interface 1.1 of a Link Aggregation Group (LAG), <span class="built_in">type</span> the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">tcpdump -ni 1.1 -e ether proto 0x8809</span><br><span class="line"></span><br><span class="line">The output appears similar to the following example:</span><br><span class="line"></span><br><span class="line">15:21:03.445333 00:50:56:92:2a:82 &gt; 01:80:c2:00:00:02, ethertype 802.1Q (0x8100), length 128: vlan 0, p 0, ethertype Slow Protocols, LACPv1, length: 110</span><br><span class="line"></span><br><span class="line">Ethernet header (basically IEEE 802.3)</span><br><span class="line"></span><br><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         Preamble (8)                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                      Preamble cont.                           |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination address (6)                    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|   Destination address cont.   |         Source address (6)    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Source address cont.                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|            Type (2)           | Pri |C|     802.1q tag        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">| <span class="keyword">if</span> <span class="built_in">type</span>!=0x8100, prev. 2 bytes are part of this field  (46 -  |</span><br><span class="line">| 1500 bytes of data) ...                                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Frame Check Sequence, FCS (4)              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">Note: Although the previous diagram correctly shows both Preamble and Frame Check Sequence, tcpdump does not include these <span class="keyword">in</span> the totals <span class="keyword">for</span> header bytes (presumably because the data is fixed, so there is no reason to match against it.) As a result, <span class="keyword">if</span> you are basing ether expressions on this chart, you must subtract 12 (as <span class="keyword">if</span> the Preamble and FCS sections <span class="keyword">do</span> not exist.)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">To view the SYN packets and the SYN and ACK packets, you would create the following filter that accepts either value <span class="keyword">for</span> the flag byte:</span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] == 18&#x27;</span> or <span class="string">&#x27;tcp[13] == 2&#x27;</span></span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] == 18&#x27;</span> or <span class="string">&#x27;tcp[13] == 2&#x27;</span></span><br><span class="line"></span><br><span class="line">You can also create a filter that looks <span class="keyword">for</span> the <span class="built_in">set</span> SYN bit and ignores the rest of the flags <span class="keyword">in</span> the header. You must <span class="built_in">set</span> the filter to perform a logic AND (&amp;) to remove all but the value of the SYN bit and <span class="keyword">then</span> <span class="built_in">test</span> it.</span><br><span class="line"></span><br><span class="line">For example, <span class="keyword">if</span> the TCP flags are 00010010 and the mask <span class="keyword">for</span> Syn is 00000010(2 <span class="keyword">in</span> binary) <span class="keyword">then</span> 00010010 + 00000010 = 00000010. You can <span class="keyword">then</span> <span class="built_in">test</span> the resulting value against the SYN flag, by setting the filter as follows:</span><br><span class="line">tcpdump -ni internal <span class="string">&#x27;tcp[13] &amp; 2 == 2&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="tcp-netif-rx"><a href="#tcp-netif-rx" class="headerlink" title="tcp netif_rx"></a><a target="_blank" rel="noopener" href="https://tldp.org/HOWTO/KernelAnalysis-HOWTO-8.html">tcp netif_rx</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">net_rx_action</span><br><span class="line">   |skb = __skb_dequeue (the exact opposite of __skb_queue_tail)</span><br><span class="line">   |<span class="keyword">for</span> (ptype = first_protocol; ptype &lt; max_protocol; ptype++) // Determine </span><br><span class="line">      |<span class="keyword">if</span> (skb-&gt;protocol == ptype)                               // what is the network protocol</span><br><span class="line">         |ptype-&gt;func -&gt; ip_rcv // according to <span class="string">&#x27;&#x27;</span>struct ip_packet_type [net/ipv4/ip_output.c]<span class="string">&#x27;&#x27;</span></span><br><span class="line"> </span><br><span class="line">    **** NOW WE KNOW THAT PACKET IS IP ****</span><br><span class="line">         |ip_rcv</span><br><span class="line">            |NF_HOOK (ip_rcv_finish)</span><br><span class="line">               |ip_route_input // search from routing table to determine <span class="keyword">function</span> to call</span><br><span class="line">                  |skb-&gt;dst-&gt;input -&gt; ip_local_deliver // according to previous routing table check, destination is <span class="built_in">local</span> machine</span><br><span class="line">                     |ip_defrag // reassembles IP fragments</span><br><span class="line">                        |NF_HOOK (ip_local_deliver_finish)</span><br><span class="line">                           |ipprot-&gt;handler -&gt; tcp_v4_rcv // according to <span class="string">&#x27;&#x27;</span>tcp_protocol [include/net/protocol.c]<span class="string">&#x27;&#x27;</span></span><br><span class="line"> </span><br><span class="line">     **** NOW WE KNOW THAT PACKET IS TCP ****</span><br><span class="line">                           |tcp_v4_rcv   </span><br><span class="line">                              |sk = __tcp_v4_lookup </span><br><span class="line">                              |tcp_v4_do_rcv</span><br><span class="line">                                 |switch(sk-&gt;state) </span><br><span class="line"></span><br><span class="line">     *** Packet can be sent to the task <span class="built_in">which</span> uses relative socket ***</span><br><span class="line">                                 |<span class="keyword">case</span> TCP_ESTABLISHED:</span><br><span class="line">                                    |tcp_rcv_established</span><br><span class="line">                                       |__skb_queue_tail // enqueue packet to socket</span><br><span class="line">                                       |sk-&gt;data_ready -&gt; sock_def_readable </span><br><span class="line">                                          |wake_up_interruptible</span><br><span class="line">                                </span><br><span class="line"></span><br><span class="line">     *** Packet has still to be handshaked by 3-way TCP handshake ***</span><br><span class="line">                                 |<span class="keyword">case</span> TCP_LISTEN:</span><br><span class="line">                                    |tcp_v4_hnd_req</span><br><span class="line">                                       |tcp_v4_search_req</span><br><span class="line">                                       |tcp_check_req</span><br><span class="line">                                          |syn_recv_sock -&gt; tcp_v4_syn_recv_sock</span><br><span class="line">                                       |__tcp_v4_lookup_established</span><br><span class="line">                                 |tcp_rcv_state_process</span><br><span class="line"></span><br><span class="line">                    *** 3-Way TCP Handshake ***</span><br><span class="line">                                    |switch(sk-&gt;state)</span><br><span class="line">                                    |<span class="keyword">case</span> TCP_LISTEN: // We received SYN</span><br><span class="line">                                       |conn_request -&gt; tcp_v4_conn_request</span><br><span class="line">                                          |tcp_v4_send_synack // Send SYN + ACK</span><br><span class="line">                                             |tcp_v4_synq_add // <span class="built_in">set</span> SYN state</span><br><span class="line">                                    |<span class="keyword">case</span> TCP_SYN_SENT: // we received SYN + ACK</span><br><span class="line">                                       |tcp_rcv_synsent_state_process</span><br><span class="line">                                          tcp_set_state(TCP_ESTABLISHED)</span><br><span class="line">                                             |tcp_send_ack</span><br><span class="line">                                                |tcp_transmit_skb</span><br><span class="line">                                                   |queue_xmit -&gt; ip_queue_xmit</span><br><span class="line">                                                      |ip_queue_xmit2</span><br><span class="line">                                                         |skb-&gt;dst-&gt;output</span><br><span class="line">                                    |<span class="keyword">case</span> TCP_SYN_RECV: // We received ACK</span><br><span class="line">                                       |<span class="keyword">if</span> (ACK)</span><br><span class="line">                                          |tcp_set_state(TCP_ESTABLISHED)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net_rx_action [net/core/dev.c]</span><br><span class="line">__skb_dequeue [include/linux/skbuff.h]</span><br><span class="line">ip_rcv [net/ipv4/ip_input.c]</span><br><span class="line">NF_HOOK -&gt; nf_hook_slow [net/core/netfilter.c]</span><br><span class="line">ip_rcv_finish [net/ipv4/ip_input.c]</span><br><span class="line">ip_route_input [net/ipv4/route.c]</span><br><span class="line">ip_local_deliver [net/ipv4/ip_input.c]</span><br><span class="line">ip_defrag [net/ipv4/ip_fragment.c]</span><br><span class="line">ip_local_deliver_finish [net/ipv4/ip_input.c]</span><br><span class="line">tcp_v4_rcv [net/ipv4/tcp_ipv4.c]</span><br><span class="line">__tcp_v4_lookup</span><br><span class="line">tcp_v4_do_rcv</span><br><span class="line">tcp_rcv_established [net/ipv4/tcp_input.c]</span><br><span class="line">__skb_queue_tail [include/linux/skbuff.h]</span><br><span class="line">sock_def_readable [net/core/sock.c]</span><br><span class="line">wake_up_interruptible [include/linux/sched.h]</span><br><span class="line">tcp_v4_hnd_req [net/ipv4/tcp_ipv4.c]</span><br><span class="line">tcp_v4_search_req</span><br><span class="line">tcp_check_req</span><br><span class="line">tcp_v4_syn_recv_sock</span><br><span class="line">__tcp_v4_lookup_established</span><br><span class="line">tcp_rcv_state_process [net/ipv4/tcp_input.c]</span><br><span class="line">tcp_v4_conn_request [net/ipv4/tcp_ipv4.c]</span><br><span class="line">tcp_v4_send_synack</span><br><span class="line">tcp_v4_synq_add</span><br><span class="line">tcp_rcv_synsent_state_process [net/ipv4/tcp_input.c]</span><br><span class="line">tcp_set_state [include/net/tcp.h]</span><br><span class="line">tcp_send_ack [net/ipv4/tcp_output.c]</span><br><span class="line"></span><br><span class="line">SERVER (LISTENING)                       CLIENT (CONNECTING)</span><br><span class="line">                           SYN </span><br><span class="line">                   &lt;-------------------</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">                        SYN + ACK</span><br><span class="line">                   -------------------&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">                           ACK </span><br><span class="line">                   &lt;-------------------</span><br><span class="line"></span><br><span class="line">                    3-Way TCP handshake</span><br></pre></td></tr></table></figure>



  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ethernet-cable"><span class="toc-number">1.</span> <span class="toc-text">Ethernet cable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP-timer"><span class="toc-number">2.</span> <span class="toc-text">TCP timer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RTT-three-types"><span class="toc-number">2.1.</span> <span class="toc-text">RTT three types</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Retransmission-Timeout"><span class="toc-number">2.2.</span> <span class="toc-text">Retransmission Timeout</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Delayed-ACK-Timer"><span class="toc-number">2.3.</span> <span class="toc-text">Delayed ACK Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Persist-Timer"><span class="toc-number">2.4.</span> <span class="toc-text">Persist Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Keepalive-Timer"><span class="toc-number">2.5.</span> <span class="toc-text">Keepalive Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FIN-WAIT-2-Timer"><span class="toc-number">2.6.</span> <span class="toc-text">FIN_WAIT_2 Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TIME-WAIT-Timer"><span class="toc-number">2.7.</span> <span class="toc-text">TIME_WAIT Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSL-Maximum-Segment-Lifetime"><span class="toc-number">2.8.</span> <span class="toc-text">MSL (Maximum Segment Lifetime)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcp-fin-timeout-and-tcp-max-tw-buckets"><span class="toc-number">2.9.</span> <span class="toc-text">tcp_fin_timeout and tcp_max_tw_buckets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcp-tw-reuse"><span class="toc-number">2.10.</span> <span class="toc-text">tcp_tw_reuse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sysctl-conf"><span class="toc-number">2.11.</span> <span class="toc-text">sysctl.conf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SLE-and-SER-in-SACK-RFC2018"><span class="toc-number">3.</span> <span class="toc-text">SLE and SER in SACK(RFC2018)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tools"><span class="toc-number">4.</span> <span class="toc-text">Tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-retrans"><span class="toc-number">5.</span> <span class="toc-text">tcp retrans</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcpdump-802-3-header"><span class="toc-number">5.1.</span> <span class="toc-text">tcpdump 802.3 header</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcp-netif-rx"><span class="toc-number">6.</span> <span class="toc-text">tcp netif_rx</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/ethernet/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/ethernet/&text=ethernet"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/ethernet/&is_video=false&description=ethernet"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ethernet&body=Check out this article: http://example.com/2022/11/13/ethernet/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/ethernet/&title=ethernet"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/ethernet/&name=ethernet&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/ethernet/&t=ethernet"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Show cpu topo12345# cpu topo CPU topo$ yum install -y hwloc$ lstopo --no-io --no-legend --of txt$ lstopo --no-io --no-legend --of svg cpu-topo.svg$ lstopo --no-io --no-legend --of png cpu-topo.png  Re">
<meta property="og:type" content="article">
<meta property="og:title" content="CPU">
<meta property="og:url" content="http://example.com/2022/11/13/cpu/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Show cpu topo12345# cpu topo CPU topo$ yum install -y hwloc$ lstopo --no-io --no-legend --of txt$ lstopo --no-io --no-legend --of svg cpu-topo.svg$ lstopo --no-io --no-legend --of png cpu-topo.png  Re">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/cpu-cache-memory.png">
<meta property="og:image" content="http://example.com/img/cpu-Isolated-334379.png">
<meta property="article:published_time" content="2022-11-13T13:29:34.000Z">
<meta property="article:modified_time" content="2023-08-22T06:21:13.091Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="cpu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/cpu-cache-memory.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CPU</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/13/nvme/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/13/ethernet/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/cpu/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/cpu/&text=CPU"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/cpu/&is_video=false&description=CPU"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CPU&body=Check out this article: http://example.com/2022/11/13/cpu/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/cpu/&name=CPU&description=&lt;h4 id=&#34;Show-cpu-topo&#34;&gt;&lt;a href=&#34;#Show-cpu-topo&#34; class=&#34;headerlink&#34; title=&#34;Show cpu topo&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://unix.stackexchange.com/questions/113544/interpret-the-output-of-lstopo&#34;&gt;Show cpu topo&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# cpu topo CPU topo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ yum install -y hwloc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ lstopo --no-io --no-legend --of txt&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ lstopo --no-io --no-legend --of svg cpu-topo.svg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ lstopo --no-io --no-legend --of png cpu-topo.png&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;Redhat-server-Certification&#34;&gt;&lt;a href=&#34;#Redhat-server-Certification&#34; class=&#34;headerlink&#34; title=&#34;Redhat server Certification&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://catalog.redhat.com/hardware/search?type=Server&#34;&gt;Redhat server Certification&lt;/a&gt;&lt;/h3&gt;&lt;h3 id=&#34;x86-CPU&#34;&gt;&lt;a href=&#34;#x86-CPU&#34; class=&#34;headerlink&#34; title=&#34;x86 CPU&#34;&gt;&lt;/a&gt;x86 CPU&lt;/h3&gt;&lt;h4 id=&#34;RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support&#34;&gt;&lt;a href=&#34;#RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support&#34; class=&#34;headerlink&#34; title=&#34;RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://lore.kernel.org/all/20190609151613.195164-1-elver@google.com/T/&#34;&gt;RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support&lt;/a&gt;&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;RHEL8 kernel has merged&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;Monitor&#34;&gt;&lt;a href=&#34;#Monitor&#34; class=&#34;headerlink&#34; title=&#34;Monitor&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://github.com/LucaCanali/Miscellaneous/blob/master/Spark_Notes/Tools_Linux_Memory_Perf_Measure.md&#34;&gt;Monitor&lt;/a&gt;&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/opcm/pcm&#34;&gt;Intel Processor Counter Monitor&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.amd.com/en/developer/uprof.html#documentation&#34;&gt;AMD Î¼Prof&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/RRZE-HPC/likwid&#34;&gt;Likwid&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/andikleen/pmu-tools&#34;&gt;pmu tools&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/01org/intel-cmt-cat&#34;&gt;intel pqos&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://download.01.org/perfmon/&#34;&gt;intel perfmon&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/TomTheBear/perfmondb&#34;&gt;intel perfmondb&lt;/a&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm-power 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm-core 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm-memory 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/opt/AMDuProf_4.0-341/bin/AMDuProfPcm -m memory -a -d 10 -C&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-perfctr -c 0-39 -g MEM -S 10s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-perfctr -c 0-39 -g ENERGY -S 10s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-topology&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-powermeter&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-features -a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-perfctr -c 0-39 -g L3 -S 10s &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pmu tools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./ocperf.py list&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./toplev.py -l2 &lt;span class=&#34;built_in&#34;&gt;sleep&lt;/span&gt; 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;AMD-NUMA-and-NPS&#34;&gt;&lt;a href=&#34;#AMD-NUMA-and-NPS&#34; class=&#34;headerlink&#34; title=&#34;AMD NUMA and NPS&#34;&gt;&lt;/a&gt;AMD NUMA and NPS&lt;/h4&gt;&lt;p&gt;In my test, The lower core number and the lower memory performance in the multi-chip module EPCY2, not show it within intel ICE-Lake&lt;br&gt;I mean, 8x cores EPYC2 only Dual memory controller, 16x cores means quad memory controller. I guess after 32 cores is the best memory performance choice.    &lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;MC0-|             |               |-MC7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    -----2x CCD   |   2x CCD  -----&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MC1-|             |               |-MC8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MC2-|             |               |-MC4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    -----2x CCD   |   2x CCD  -----&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MC3-|             |               |-MC5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;NPS0 â This is only available on a 2-socket system. This means one NUMA node per system. Memory is interleaved across all 16 memory channels in the system&lt;ul&gt;
&lt;li&gt;none&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NPS1 â In this, the whole CPU is a single NUMA domain, with all the cores in the socket, and all the associated memory in this one NUMA domain. Memory is interleaved across the eight memory channels. All PCIe devices on the socket belong to this single NUMA domain&lt;ul&gt;
&lt;li&gt;general-purpose workloading&lt;/li&gt;
&lt;li&gt;SPEC CPU 2017&lt;/li&gt;
&lt;li&gt;IO intensive&lt;/li&gt;
&lt;li&gt;Virtualization&lt;/li&gt;
&lt;li&gt;Vmark3&lt;/li&gt;
&lt;li&gt;HammerDB&lt;/li&gt;
&lt;li&gt;Database and analytics&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NPS2 â This setting partitions the CPU into 2 NUMA domains, with half the cores and memory in each domain. Memory is interleaved across 4 memory channels in each NUMA domain&lt;ul&gt;
&lt;li&gt;SPECjbb 2015&lt;/li&gt;
&lt;li&gt;HPC and Teclo&lt;/li&gt;
&lt;li&gt;HPC&lt;/li&gt;
&lt;li&gt;Openstack NFV&lt;/li&gt;
&lt;li&gt;Openstack realtime NFV&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NPS4 â This setting partitions the CPU into four NUMA domains. Each quadrant is a NUMA domain, and memory is interleaved across the 2 memory channels in each quadrant. PCIe devices will be local to one of the 4 NUMA domains on the socket, depending on the quadrant of the IOD that has the PCIe root for the device.&lt;ul&gt;
&lt;li&gt;SPECjbb 2015&lt;/li&gt;
&lt;li&gt;SPECpower ssj 2008&lt;/li&gt;
&lt;li&gt;Virtualization&lt;/li&gt;
&lt;li&gt;TPCx-V&lt;/li&gt;
&lt;li&gt;Container&lt;/li&gt;
&lt;li&gt;Database and analytics&lt;/li&gt;
&lt;li&gt;Hadoop&lt;/li&gt;
&lt;li&gt;TPCx-IOT&lt;/li&gt;
&lt;li&gt;HPC and Teclo&lt;/li&gt;
&lt;li&gt;HPC&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;Intel-Cascade-Lake-CPU-suffix&#34;&gt;&lt;a href=&#34;#Intel-Cascade-Lake-CPU-suffix&#34; class=&#34;headerlink&#34; title=&#34;Intel Cascade Lake CPU suffix&#34;&gt;&lt;/a&gt;Intel Cascade Lake CPU suffix&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;âFâ suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package&lt;/li&gt;
&lt;li&gt;âLâ suffix indicates the SKU is a large memory (4.5 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;âMâ suffix indicates the SKU is a medium memory (2 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;âNâ suffix indicates the SKU is a specialized for Networking&amp;#x2F;NFV&lt;/li&gt;
&lt;li&gt;âSâ suffix indicates the SKU is a search application-specialized model&lt;/li&gt;
&lt;li&gt;âTâ suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification&lt;/li&gt;
&lt;li&gt;âUâ suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)&lt;/li&gt;
&lt;li&gt;âVâ suffix indicates the SKU targets the VM density value market&lt;/li&gt;
&lt;li&gt;âYâ suffix indicates the SKU has Speed Select Technology (SST)&lt;/li&gt;
&lt;li&gt;âRâ suffix indicates the SKU is a refresh model( add cores or frequency)"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/cpu/&t=CPU"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-cpu-topo"><span class="toc-number">1.</span> <span class="toc-text">Show cpu topo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redhat-server-Certification"><span class="toc-number"></span> <span class="toc-text">Redhat server Certification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x86-CPU"><span class="toc-number"></span> <span class="toc-text">x86 CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support"><span class="toc-number">1.</span> <span class="toc-text">RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Monitor"><span class="toc-number">2.</span> <span class="toc-text">Monitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-NUMA-and-NPS"><span class="toc-number">3.</span> <span class="toc-text">AMD NUMA and NPS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Intel-Cascade-Lake-CPU-suffix"><span class="toc-number">4.</span> <span class="toc-text">Intel Cascade Lake CPU suffix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cpu-features"><span class="toc-number">5.</span> <span class="toc-text">intel cpu features</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith"><span class="toc-number">6.</span> <span class="toc-text">Why some of the 8,16 x cores EPYC2 limit the memory bandwith</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cluster-mode"><span class="toc-number">7.</span> <span class="toc-text">CPU cluster mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cache-speed"><span class="toc-number">8.</span> <span class="toc-text">CPU cache speed</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline-Width"><span class="toc-number">8.1.</span> <span class="toc-text">Pipeline Width</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Caculate-the-Tflops"><span class="toc-number">8.2.</span> <span class="toc-text">Caculate the Tflops</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-medium-speed"><span class="toc-number">8.3.</span> <span class="toc-text">CPU medium speed</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number"></span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pin-CPU"><span class="toc-number">1.</span> <span class="toc-text">pin CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#modify-grub-boot-order"><span class="toc-number">2.</span> <span class="toc-text">modify grub boot order</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cache-consistenta"><span class="toc-number">3.</span> <span class="toc-text">Cache consistenta</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-SMT-255-cores"><span class="toc-number">4.</span> <span class="toc-text">AMD SMT, 255 cores</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-STAT"><span class="toc-number">5.</span> <span class="toc-text">CPU STAT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#kernel-parameters"><span class="toc-number">5.1.</span> <span class="toc-text">kernel parameters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-IDLE"><span class="toc-number">5.2.</span> <span class="toc-text">CPU IDLE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><span class="toc-number">6.</span> <span class="toc-text">Application multiple threads get down to single core cause performance issue in intel skylake platform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#E3-v6-Turbo-not-support-under-the-CentOS6"><span class="toc-number">7.</span> <span class="toc-text">E3 v6 Turbo not support under the CentOS6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isolated-CPUs-example"><span class="toc-number">8.</span> <span class="toc-text">Isolated CPUs example</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#use-the-isolated-core"><span class="toc-number">8.1.</span> <span class="toc-text">use the isolated core</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-x86-options"><span class="toc-number">9.</span> <span class="toc-text">gcc_x86_options</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Disable-features-AVX"><span class="toc-number">10.</span> <span class="toc-text">Disable features AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ban-half-core-try-to-not-running-HT"><span class="toc-number">11.</span> <span class="toc-text">Ban half core, try to not running HT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Turn-off-the-cpu-cores-under-linux"><span class="toc-number">12.</span> <span class="toc-text">Turn off the cpu cores under linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cmt-cat"><span class="toc-number">13.</span> <span class="toc-text">intel-cmt-cat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-process-with-CPU"><span class="toc-number">14.</span> <span class="toc-text">Linux process with CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numa"><span class="toc-number">15.</span> <span class="toc-text">numa</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#How-many-temperature-is-high-for-intel-CPU"><span class="toc-number">16.</span> <span class="toc-text">How many temperature is high for intel CPU ?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tool-for-CPU-machine-specific-registers"><span class="toc-number">17.</span> <span class="toc-text">tool for CPU machine specific registers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#irqbalance"><span class="toc-number">18.</span> <span class="toc-text">irqbalance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-Performance-overrides"><span class="toc-number"></span> <span class="toc-text">CVE Performance overrides</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenMP-env-var"><span class="toc-number">1.</span> <span class="toc-text">OpenMP env var</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#turbostat"><span class="toc-number">1.1.</span> <span class="toc-text">turbostat</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powertop"><span class="toc-number">2.</span> <span class="toc-text">powertop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powercap"><span class="toc-number">3.</span> <span class="toc-text">powercap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#process-counter-monitor-PCM"><span class="toc-number">4.</span> <span class="toc-text">process counter monitor (PCM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numatop"><span class="toc-number">5.</span> <span class="toc-text">numatop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-CPU-parameters"><span class="toc-number">6.</span> <span class="toc-text">Linux CPU parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handle-overflow-in-jiffies"><span class="toc-number"></span> <span class="toc-text">handle overflow in jiffies</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Data-Cache-Unit-on-chip-memory-system"><span class="toc-number">1.</span> <span class="toc-text">Data Cache Unit (on-chip memory system)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EPYC-suggestion"><span class="toc-number"></span> <span class="toc-text">EPYC suggestion</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#More-performance-degrade-when-AMD-EPYC2-under-the-powersave-mode-intel-is-OK"><span class="toc-number">1.</span> <span class="toc-text">More performance degrade when AMD EPYC2 under the powersave mode, intel is OK</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CPU
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-13T13:29:34.000Z" itemprop="datePublished">2022-11-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CPU/">CPU</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/cpu/" rel="tag">cpu</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h4 id="Show-cpu-topo"><a href="#Show-cpu-topo" class="headerlink" title="Show cpu topo"></a><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/113544/interpret-the-output-of-lstopo">Show cpu topo</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cpu topo CPU topo</span></span><br><span class="line">$ yum install -y hwloc</span><br><span class="line">$ lstopo --no-io --no-legend --of txt</span><br><span class="line">$ lstopo --no-io --no-legend --of svg cpu-topo.svg</span><br><span class="line">$ lstopo --no-io --no-legend --of png cpu-topo.png</span><br></pre></td></tr></table></figure>

<h3 id="Redhat-server-Certification"><a href="#Redhat-server-Certification" class="headerlink" title="Redhat server Certification"></a><a target="_blank" rel="noopener" href="https://catalog.redhat.com/hardware/search?type=Server">Redhat server Certification</a></h3><h3 id="x86-CPU"><a href="#x86-CPU" class="headerlink" title="x86 CPU"></a>x86 CPU</h3><h4 id="RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support"><a href="#RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support" class="headerlink" title="RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support"></a><a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20190609151613.195164-1-elver@google.com/T/">RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support</a></h4><ul>
<li>RHEL8 kernel has merged</li>
</ul>
<h4 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a><a target="_blank" rel="noopener" href="https://github.com/LucaCanali/Miscellaneous/blob/master/Spark_Notes/Tools_Linux_Memory_Perf_Measure.md">Monitor</a></h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/opcm/pcm">Intel Processor Counter Monitor</a></li>
<li><a target="_blank" rel="noopener" href="https://www.amd.com/en/developer/uprof.html#documentation">AMD Î¼Prof</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/RRZE-HPC/likwid">Likwid</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/andikleen/pmu-tools">pmu tools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/01org/intel-cmt-cat">intel pqos</a></li>
<li><a target="_blank" rel="noopener" href="https://download.01.org/perfmon/">intel perfmon</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/TomTheBear/perfmondb">intel perfmondb</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">bin/pcm-power 20</span><br><span class="line">bin/pcm-core 20</span><br><span class="line">bin/pcm 20</span><br><span class="line">bin/pcm-memory 20</span><br><span class="line"></span><br><span class="line">/opt/AMDuProf_4.0-341/bin/AMDuProfPcm -m memory -a -d 10 -C</span><br><span class="line"></span><br><span class="line">/usr/local/bin/likwid-perfctr -c 0-39 -g MEM -S 10s</span><br><span class="line">/usr/local/bin/likwid-perfctr -c 0-39 -g ENERGY -S 10s</span><br><span class="line">/usr/local/bin/likwid-topology</span><br><span class="line">/usr/local/bin/likwid-powermeter</span><br><span class="line">/usr/local/bin/likwid-features -a</span><br><span class="line">/usr/local/bin/likwid-perfctr -c 0-39 -g L3 -S 10s </span><br><span class="line"></span><br><span class="line">pmu tools</span><br><span class="line">./ocperf.py list</span><br><span class="line">./toplev.py -l2 <span class="built_in">sleep</span> 2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="AMD-NUMA-and-NPS"><a href="#AMD-NUMA-and-NPS" class="headerlink" title="AMD NUMA and NPS"></a>AMD NUMA and NPS</h4><p>In my test, The lower core number and the lower memory performance in the multi-chip module EPCY2, not show it within intel ICE-Lake<br>I mean, 8x cores EPYC2 only Dual memory controller, 16x cores means quad memory controller. I guess after 32 cores is the best memory performance choice.    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MC0-|             |               |-MC7</span><br><span class="line">    -----2x CCD   |   2x CCD  -----</span><br><span class="line">MC1-|             |               |-MC8</span><br><span class="line">-----------------------------------</span><br><span class="line">MC2-|             |               |-MC4</span><br><span class="line">    -----2x CCD   |   2x CCD  -----</span><br><span class="line">MC3-|             |               |-MC5</span><br></pre></td></tr></table></figure>
<ul>
<li>NPS0 â This is only available on a 2-socket system. This means one NUMA node per system. Memory is interleaved across all 16 memory channels in the system<ul>
<li>none</li>
</ul>
</li>
<li>NPS1 â In this, the whole CPU is a single NUMA domain, with all the cores in the socket, and all the associated memory in this one NUMA domain. Memory is interleaved across the eight memory channels. All PCIe devices on the socket belong to this single NUMA domain<ul>
<li>general-purpose workloading</li>
<li>SPEC CPU 2017</li>
<li>IO intensive</li>
<li>Virtualization</li>
<li>Vmark3</li>
<li>HammerDB</li>
<li>Database and analytics</li>
</ul>
</li>
<li>NPS2 â This setting partitions the CPU into 2 NUMA domains, with half the cores and memory in each domain. Memory is interleaved across 4 memory channels in each NUMA domain<ul>
<li>SPECjbb 2015</li>
<li>HPC and Teclo</li>
<li>HPC</li>
<li>Openstack NFV</li>
<li>Openstack realtime NFV</li>
</ul>
</li>
<li>NPS4 â This setting partitions the CPU into four NUMA domains. Each quadrant is a NUMA domain, and memory is interleaved across the 2 memory channels in each quadrant. PCIe devices will be local to one of the 4 NUMA domains on the socket, depending on the quadrant of the IOD that has the PCIe root for the device.<ul>
<li>SPECjbb 2015</li>
<li>SPECpower ssj 2008</li>
<li>Virtualization</li>
<li>TPCx-V</li>
<li>Container</li>
<li>Database and analytics</li>
<li>Hadoop</li>
<li>TPCx-IOT</li>
<li>HPC and Teclo</li>
<li>HPC</li>
</ul>
</li>
</ul>
<h4 id="Intel-Cascade-Lake-CPU-suffix"><a href="#Intel-Cascade-Lake-CPU-suffix" class="headerlink" title="Intel Cascade Lake CPU suffix"></a>Intel Cascade Lake CPU suffix</h4><ul>
<li>âFâ suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package</li>
<li>âLâ suffix indicates the SKU is a large memory (4.5 TiB) tier SKU</li>
<li>âMâ suffix indicates the SKU is a medium memory (2 TiB) tier SKU</li>
<li>âNâ suffix indicates the SKU is a specialized for Networking&#x2F;NFV</li>
<li>âSâ suffix indicates the SKU is a search application-specialized model</li>
<li>âTâ suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification</li>
<li>âUâ suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)</li>
<li>âVâ suffix indicates the SKU targets the VM density value market</li>
<li>âYâ suffix indicates the SKU has Speed Select Technology (SST)</li>
<li>âRâ suffix indicates the SKU is a refresh model( add cores or frequency)<span id="more"></span></li>
</ul>
<h4 id="intel-cpu-features"><a href="#intel-cpu-features" class="headerlink" title="intel cpu features"></a><a target="_blank" rel="noopener" href="https://www.all-electronics.de/wp-content/uploads/migrated/document/196371/413ei0507-intel-sma.pdf">intel cpu features</a></h4><ul>
<li><p>IntelÂ® Wide Dynamic Execution</p>
<ul>
<li>Dynamic execution is a combination of techniques (data flow analysis, speculative execution, out of order execution, and super scalar) that Intel first implemented in the P6 microarchitecture used in the IntelÂ® PentiumÂ® Pro processor, PentiumÂ® II processor and PentiumÂ® III processors.</li>
</ul>
</li>
<li><p>IntelÂ® Advanced Digital Media Boost</p>
<ul>
<li>Intel Advanced Digital Media Boost helps achieve similar dramatic gains in throughputs for programs utilizing SSE instructions of 128-bit operands. (SSE instructions enhance Intel architecture by enabling programmers to develop algorithms that can mix packed, single-precision, and double-precision floating point and integers, using SSE instructions.)</li>
</ul>
</li>
<li><p>IntelÂ® Intelligent Power Capability</p>
<ul>
<li>Intel Intelligent Power Capability is a set of capabilities for reducing power consumption and device design requirements. This feature manages the runtime power consumption of all the processorâs execution cores. It includes an advanced power-gating capability that allows for an ultra fine-grained logic control that turns on individual processor logic subsystems only if and when they are needed. Additionally, many buses and arrays are split so that data required in some modes of operation can be put in a low-power state when not needed</li>
</ul>
</li>
<li><p>IntelÂ® Advanced Smart Cache</p>
<ul>
<li>Intel Advanced Smart Cache is a multi-core optimized cache that improves performance and efficiency by increasing the probability that each execution core of a dual-core processor can access data from a higher-performance, more-efficient cache subsystem</li>
</ul>
</li>
<li><p>IntelÂ® Smart Memory Access</p>
<ul>
<li>Intel Smart Memory Access improves system performance by optimizing the use of the available data bandwidth from the memory subsystem and hiding the latency of memory accesses. The goal is to ensure that data can be used as quickly as possible and is located as close as possible to where itâs needed to minimize latency and thus improve efficiency and speed</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19253-01/817-0547/girss/index.html">x86 T-state Throttling State</a></p>
<ul>
<li>This feature provides the basic CPU Advanced Configuration and Power Interface (ACPI) T-state support. T-state support enables the CPU driver to receive _TPC change notifications as a manner of controlling the processor speed. This is frequently done on some systems as a passive cooling mechanism along with the existing CPU ACPI P-States.</li>
<li>the more for decrease the temprature</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://colfaxresearch.com/skl-avx512/">SKL</a></p>
<ul>
<li>AVX-512F<ul>
<li>The fundamental instruction set, it expands most of AVX functions to support 512-bit registers and adds masking, embedded broadcasting, embedded rounding and exception control.</li>
</ul>
</li>
<li>AVX-512CD   <ul>
<li>Conflict Detection instruction set allows vectorization of loops with vector dependency due to writing conflicts</li>
</ul>
</li>
<li>AVX-512BW <ul>
<li>Byte and Word support instruction set: 8-bit and 16-bit integer operations, processing up to 64 8-bit elements or 32 16-bit integer elements per vector</li>
</ul>
</li>
<li>AVX-512DQ   <ul>
<li>Double and Quad word instruction set, supports new instructions for double-word (32-bit) and quadword (64-bit) integer and floating-point elements</li>
</ul>
</li>
<li>AVX-512VL <ul>
<li>Vector Length extensions: support for vector lengths smaller than 512 bits</li>
</ul>
</li>
</ul>
</li>
<li><p>KNL</p>
<ul>
<li>AVX-512F    <ul>
<li>Conflict Detection instruction set allows vectorization of loops with vector dependency due to writing conflicts</li>
</ul>
</li>
<li>AVX-512CD<ul>
<li>Byte and Word support instruction set: 8-bit and 16-bit integer operations, processing up to 64 8-bit elements or 32 16-bit integer elements per vector</li>
</ul>
</li>
<li>AVX-512PF<ul>
<li>Data prefetching for gather and scatter instructions</li>
</ul>
</li>
<li>AVX-512ER<ul>
<li>Exponential and Reciprocal instruction set for high-accuracy base-2 exponential functions, reciprocals, and reciprocal square root<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Compiler        Intel compilers 17.x    Intel compilers 18.x                      GNU and LLVM</span><br><span class="line">Cross-platform  -xCommon-AVX512         -xCommon-AVX512                         -mfma -mavx512f -mavx512cd</span><br><span class="line">SKL processors  -xCore-AVX512           -xCore-AVX512 -qopt-zmm-usage=high      -march=skylake-avx512</span><br><span class="line">KNL processors  -xMIC-AVX512            -xMIC-AVX512    -march=knl</span><br><span class="line"></span><br><span class="line">$ icc -xCORE-AVX512 -c auto_vec.c</span><br><span class="line">$ icc -xCORE-AVX512 -S auto_vec.c</span><br><span class="line">$ icc -xCORE-AVX512 -c auto_vec.c -qopt-report=5 </span><br><span class="line"></span><br><span class="line">$ icc  -xCORE-AVX512 -S auto_vec.c -qopt-report-embed</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -c auto_vec.c</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -S auto_vec.c</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -c auto_vec.c -fopt-info-vec</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -S auto_vec.c -fopt-info-vec</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith"><a href="#Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith" class="headerlink" title="Why some of the 8,16 x cores EPYC2 limit the memory bandwith"></a>Why some of the 8,16 x cores EPYC2 limit the memory bandwith</h4><p><a target="_blank" rel="noopener" href="https://en.wikichip.org/wiki/amd/epyc/7252">This model supports up to 8 channels of up to DDR4-3200 memory with a theoretical maximum bandwidth of 25.6 GB&#x2F;s (â 23.84 GiB&#x2F;s) per channel, but is apparently bandwidth limited by the IFOP links between the I&#x2F;O die and its only two compute dies (effective bandwidth â 55 GB&#x2F;s per CCD at 1.46 GHz FCLK). According to AMD this processor is âoptimized for 4 channels with DDR4-2667 DIMMsâ (â 21.3 GB&#x2F;s per channel) and therefore has a âper-socket theoretical memory bandwidth 85.3 GB&#x2F;sâ (â 79.47 Ga)</a></p>
<h4 id="CPU-cluster-mode"><a href="#CPU-cluster-mode" class="headerlink" title="CPU cluster mode"></a>CPU cluster mode</h4><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/technical/xeon-processor-scalable-family-technical-overview.html">CHA is responsible for tracking of requests from the core and responding to snoops from local and remote agents as well as resolution of coherency across multiple processors</a></p>
<ul>
<li>All2All<ul>
<li>No policy, free, maybe the request pass the longest path</li>
</ul>
</li>
<li>SNC-2&#x2F;SNC-4 (sub-NUMA)<ul>
<li>Don ât keep cache consistency with remote numa node, divide by numa and cluster range</li>
</ul>
</li>
<li>Hemishphere<ul>
<li>Memory channel(worked) with symmetric assembly in the 2 x Memory controller</li>
</ul>
</li>
<li>Quadrant<ul>
<li>Same with hemishphere in the 4 x Memory controller</li>
</ul>
</li>
<li>Auto</li>
</ul>
<h4 id="CPU-cache-speed"><a href="#CPU-cache-speed" class="headerlink" title="CPU cache speed"></a>CPU cache speed</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.7-cpu.com/cpu/Ice_Lake.html">Intel i7-1065G7 (Ice Lake), 3.9 GHz (Turbo Boost), 10 nm. 122 mm2, RAM: 16 GB, dual LPDDR4-3733. Surface Pro 7</a><ul>
<li>L1 Data Cache Latency &#x3D; 5 cycles for simple access via pointer</li>
<li>L1 Data Cache Latency &#x3D; 5 cycles for access with complex address calculation (size_t n, *p; n &#x3D; p[n]).</li>
<li>L2 Cache Latency &#x3D; 13 cycles</li>
<li>L3 Cache Latency &#x3D; 42 cycles (core 0)</li>
<li>L3 Cache Latency &#x3D; 41 cycles (core 1)</li>
<li>L3 Cache Latency &#x3D; 41 cycles (core 2)</li>
<li>L3 Cache Latency &#x3D; 42 cycles (core 3)</li>
<li>RAM Latency &#x3D; 42 cycles + 87 ns </li>
<li>Branch misprediction penalty &#x3D; 17 cycles average (if mOp cache hit).</li>
<li>Branch misprediction penalty &#x3D; 20-21 ? cycles (if mOp cache miss). </li>
<li>64-bytes range cross penalty &#x3D; 6 cycles</li>
<li>4096-bytes range cross penalty &#x3D; 7 cycles (1 additional cycle over 64-bytes cross penalty). </li>
<li>L1 B&#x2F;W (Parallel Random Read) &#x3D; 0.5 cycles per one access</li>
<li>L1 Write (8-32 bytes step) &#x3D; 0.5 cycles per one write </li>
<li>L2-&gt;L1 B&#x2F;W (Parallel Random Read) &#x3D; 1.4 cycles per cache line</li>
<li>L2-&gt;L1 B&#x2F;W (Read, 64 bytes step) &#x3D; 1.4 cycles per cache line</li>
<li>L2 Write (Write, 16-64 bytes step) &#x3D; 3.0 cycles per cache line </li>
<li>L3-&gt;L1 B&#x2F;W (Parallel Random Read) &#x3D; 4.0 (or less) cycles per cache line</li>
<li>L3-&gt;L1 B&#x2F;W (Read, 64 bytes step) &#x3D; 3.3 cycles per cache line</li>
<li>L3 Write (Write, 16-64 bytes step) &#x3D; 5.2 cycles per cache line </li>
<li>RAM Read B&#x2F;W (Parallel Random Read) &#x3D; 6 ns (or less) &#x2F; cache line</li>
<li>RAM Read B&#x2F;W (Read, 16-64 Bytes step) &#x3D; 24-25 GB&#x2F;s</li>
<li>RAM Read B&#x2F;W (Read, 64 Bytes step - pointer chasing) &#x3D; 18 GB&#x2F;s</li>
<li>RAM Write B&#x2F;W (Write, 8-64 Bytes step) &#x3D; 18 GB&#x2F;s</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.7-cpu.com/cpu/Zen2.html">AMD 3800X (Zen2), 7 nm. RAM: 32 GB, RAM DDR4-3200 16-18-18-38-56-1T (dual channel)</a><ul>
<li>L1 Data cache &#x3D; 32 KB, 64 B&#x2F;line, 8-WAY. write-back, ECC. Two 256-bit loads and one 256-bit store per cycle.</li>
<li>L1 Instruction cache &#x3D; 32 KB, 64 B&#x2F;line, 8-WAY. 32 bytes fetch &#x2F; cycle.</li>
<li>L2 cache &#x3D; 512 KB, 64 B&#x2F;line, 8-WAY, write-back. 32 bytes L2-&gt;L1 datapath.</li>
<li>L3 cache &#x3D; 16 MB or 4 MB per CCX 4 cores), 64 B&#x2F;line, 16-WAY, write-back. victim for L2.</li>
<li>Op Cache (OC): 4096 items. up to 8 Instructions&#x2F;entry. 8-way, 64 sets. Entry limits: 8 instructions, 8 32-bit t immediates&#x2F;displacements (64-bit immediates&#x2F;displacements take two slots), 4 microcode instructions. An OC entry terminates at the end of a 64-byte aligned memory region.</li>
<li>Dispatch: 6 ops&#x2F;cycle</li>
<li>Retire Unit: receive 6 macro-op&#x2F;cycle, 224 macro ops. 8 macro-op&#x2F;cycle retire</li>
<li>4 ALUS, 3 AGUs</li>
<li>ALU schedulers : 4x16.</li>
<li>AGU scheduler : 1x28.</li>
<li>reorder buffer : 224.</li>
<li>integer register file : 180.</li>
<li>FP scheduler : 36 entry micro-op.</li>
<li>4 FPU pipes.</li>
<li>2x 32B loads + 1x 32B store per cycle</li>
<li>Load Queue: 44 entry</li>
<li>Store Queue: 48 entry</li>
<li>LS unit can track up to 22 outstanding in-flight cache misses. </li>
<li>4 cycles for simple access via pointer</li>
<li>5 cycles for access with complex address calculation (size_t n, *p; n &#x3D; p[n]).</li>
<li>AMD DOC: 7- or 8-cycle FPU load-to-use latency.</li>
<li>L2 Cache Latency &#x3D; 12 cycles</li>
<li>L3 Cache Latency &#x3D; 38 cycles</li>
<li>RAM Latency &#x3D; 38 cycles + 66 ns</li>
</ul>
</li>
</ul>
<p>AMD Roma 7552 L1 instruct 32K 8-way, L1 32K 8-way, L2 512K 8-way, L3-per-socket 192M 16-way   </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.intel.com/content/dam/support/us/en/documents/motherboards/server/sb/intelserversystembiossetuputilityguide10_final.pdf">DCU Data Prefetcher</a><ul>
<li>[Enabled] The next cache line will be prefetched into L1 data cache from L2 or system memory during unused cycles if it sees that the processor core has accessed several bytes sequentially in a cache line as data.</li>
<li>[Disabled] Only fetches cache line with data required by the processor (64 bytes)</li>
</ul>
</li>
<li>DCU Mode<ul>
<li>32KB 8Way Without ECC</li>
<li>16KB 4Way With ECC</li>
</ul>
</li>
</ul>
<h5 id="Pipeline-Width"><a href="#Pipeline-Width" class="headerlink" title="Pipeline Width"></a><a target="_blank" rel="noopener" href="https://travisdowns.github.io/blog/2019/06/11/speed-limits.html">Pipeline Width</a></h5><ul>
<li>Intel Skylake: Maximum 4 fused uops per cycle</li>
<li>Intel Ice Lake: Maximum 5 fused uops per cycle</li>
<li>AMD Zen, Zen 2: Maximum 6 MOPs from up to 5 instructions per cycle</li>
<li>AMD Zen 3: Maximum 6 MOPs from up to 6 instructions per cycle</li>
<li>Apple M1: Maximum 8 ops per cycle</li>
</ul>
<h5 id="Caculate-the-Tflops"><a href="#Caculate-the-Tflops" class="headerlink" title="Caculate the Tflops"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Matrix_Yao/p/9550967.html">Caculate the Tflops</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">FP64  </span><br><span class="line">     2xsocket</span><br><span class="line">       |24 cores</span><br><span class="line">       |  | operations_per_cycle = 2 x FMA AVX512 , (fma_num)2 x (512/FP64) x 2(multiply and Adding is counted as an operation that why 8x2) =2 x 8 x 2 =32</span><br><span class="line">       |  |  | 2.6GHz</span><br><span class="line">       |  |  |  |</span><br><span class="line">TFLOPS=2*24*32*2.6*10^9*10^-12=3.9936 Tflops</span><br><span class="line"></span><br><span class="line">FP32=FP64 x 2</span><br><span class="line">FP16=Before the Xeon CPU SapphirRapids(SPR), the CPU not support the native FP16-FMA, it need convert FP16 to FP 32 by the vcvtph2ps instruction, finish the compute by FP32 </span><br><span class="line">In this status, FP16 TFLOPS = FP 32 TFLOPS</span><br><span class="line">BF16=From the CooperLake(CPX), The Xeon support BF16(multiply and Adding compute),<span class="keyword">if</span> the CPU Flag has the AVX512_BF16 means support the native BF16, the BF16 share the FMA with FP32, so the BF16 instruction is not standard FMA, it <span class="string">&#x27;s the DP(Dot Product)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1x AVX-512 reg could store 32xBF16 data, 1x AVX-512 BF16 DP, each clock cycle could run 32 x BF16(multiply and add operations)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">AVX INT32 MA</span></span><br><span class="line"><span class="string">CPU finish INT32(multiply and adding op) by the vpmuldq and vpaddq instructions</span></span><br><span class="line"><span class="string">1 x AVX-512 reg could store 16x INT32 data, 1x AVX-512 FMA, 2 x clock cycle could do 16xINT32(multiply add op)ï¼each clock cycle do 8xINT32.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pre-VNNI MA</span></span><br><span class="line"><span class="string">Before support the VNNI(Vector Neural Network Instructions), the CPU finish INT16 DP by the vpmaddwd + vpaddd. (it &#x27;</span>s share FP32 FMA too, it <span class="string">&#x27;s not support the INT16 FMA)</span></span><br><span class="line"><span class="string">1x AVX-512 reg could store 32x INT16. 2x clock cycle do 32xINT16(multiply add op), each clock cycle run 16x INT16</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">post-VNNI DP</span></span><br><span class="line"><span class="string">After support the VNNI, The CPU finish the INT16 by single vpdpwssd instruction</span></span><br><span class="line"><span class="string">1x AVX-512 FMA single cycle =  32 x INT16 single cycle</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INT8 TOPS</span></span><br><span class="line"><span class="string">Before support the VNNI, the CPU finish INT8 DP by vpmaddubsw + vpmaddwd + vpaddd</span></span><br><span class="line"><span class="string">1x AVX-512 store 64xINT8, 1x AVX-512 FMA need 3xclock to do 64xINT8, each clock to do 64/3 INT8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">After support VNNI, The CPU finish INT8 by the single vpdpbusd</span></span><br><span class="line"><span class="string">1x AVX-512 reg could store 64xINT8, 1x AVX-512 FMA = 64x INT8 single cycle</span></span><br></pre></td></tr></table></figure>

<ul>
<li>eIPC: effective instuction per cycle  </li>
<li>IPC: insns per cycle insn&#x2F;cycles<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cpu FSB x multiplier = frequency</span><br><span class="line">cpu frequency x IPC</span><br></pre></td></tr></table></figure></li>
<li>Application CPU time &#x3D; instruction nums&#x2F;(frequency x IPC)</li>
<li><a target="_blank" rel="noopener" href="https://plantegg.github.io/2021/06/18/%E5%87%A0%E6%AC%BECPU%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94">The simple cpu maximum performance evaluate &#x3D; frequency x Core nums x Maximum N(4&#x2F;5&#x2F;6&#x2F;8 or more) fused uops per cycle x 1.3(smt2, 2 HT x86) or 1.5(smt4, 4 HT power)</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perf <span class="built_in">stat</span> -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses  -a -p <span class="variable">$test_app_pid</span></span><br></pre></td></tr></table></figure>
<img src="/img/cpu-cache-memory.png"></li>
</ul>
<h5 id="CPU-medium-speed"><a href="#CPU-medium-speed" class="headerlink" title="CPU medium speed"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4087280/approximate-cost-to-access-various-caches-and-main-memory">CPU medium speed</a></h5><p><a href="/img/cpu_speed_a7jWu.png"></a><br>L1 cache (instruction cache and data cache) hit : <del>4 clock cycle<br>L2 cache hit: ~10 clock cycle<br>L3 cache hit, line unshare: ~40 clock cycle<br>L3 cache hit, share line in another core: ~65 clock cycle<br>L3 cache hit, modified in another core ~75 cycles remote<br>L3 cache ~100-300 cycles<br>Local DRAM ~30 ns (</del>120 cycles)<br>Remote DRAM ~100 ns</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">           0.5 ns - CPU L1 dCACHE reference</span><br><span class="line">           1   ns - speed-of-light (a photon) travel a 1 ft (30.5cm) distance</span><br><span class="line">           5   ns - CPU L1 iCACHE Branch mispredict</span><br><span class="line">           7   ns - CPU L2  CACHE reference</span><br><span class="line">          71   ns - CPU cross-QPI/NUMA best  <span class="keyword">case</span> on XEON E5-46*</span><br><span class="line">         100   ns - MUTEX lock/unlock</span><br><span class="line">         100   ns - own DDR MEMORY reference</span><br><span class="line">         135   ns - CPU cross-QPI/NUMA best  <span class="keyword">case</span> on XEON E7-*</span><br><span class="line">         202   ns - CPU cross-QPI/NUMA worst <span class="keyword">case</span> on XEON E7-*</span><br><span class="line">         325   ns - CPU cross-QPI/NUMA worst <span class="keyword">case</span> on XEON E5-46*</span><br><span class="line">      10,000   ns - Compress 1K bytes with Zippy PROCESS</span><br><span class="line">      20,000   ns - Send 2K bytes over 1 Gbps NETWORK</span><br><span class="line">     250,000   ns - Read 1 MB sequentially from MEMORY</span><br><span class="line">     500,000   ns - Round trip within a same DataCenter</span><br><span class="line">  10,000,000   ns - DISK seek</span><br><span class="line">  10,000,000   ns - Read 1 MB sequentially from NETWORK</span><br><span class="line">  30,000,000   ns - Read 1 MB sequentially from DISK</span><br><span class="line"> 150,000,000   ns - Send a NETWORK packet CA -&gt; Netherlands</span><br><span class="line">|   |   |   |</span><br><span class="line">|   |   | ns|</span><br><span class="line">|   | us|</span><br><span class="line">| ms|</span><br></pre></td></tr></table></figure>

<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="pin-CPU"><a href="#pin-CPU" class="headerlink" title="pin CPU"></a>pin CPU</h4><p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-CPU-Configuration_suggestions#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Configuration_suggestions-Configuring_CPU_thread_and_interrupt_affinity_with_Tuna">tuna</a>    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop irqbalance.service</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/module/spl/parameters/spl_taskq_thread_dynamic</span><br><span class="line">tuna -c 12-15 -t <span class="string">&#x27;*rcu*&#x27;</span> --move</span><br><span class="line"></span><br><span class="line">grep mlx5_com /proc/interrupts</span><br><span class="line">tuna -C 12-15 -i -q <span class="string">&#x27;mlx5_comp*@pci:0000:c1:00.0&#x27;</span></span><br><span class="line">tuna -C 12-15 -i -q <span class="string">&#x27;mlx5_comp*@pci:0000:c1:00.1&#x27;</span></span><br><span class="line">tuna -C 12-15 -i -q <span class="string">&#x27;mpt3sas*-msix*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Move lustre and zfs process</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/module/spl/parameters/spl_taskq_thread_dynamic</span><br><span class="line">$ tuna --cpus=8-15 --threads z_wr_iss* --move</span><br><span class="line">$ tuna --cpus=8-15 --threads z_wr_int* --move</span><br><span class="line">$ tuna --cpus=0-7 --threads socknal* --move</span><br><span class="line">$ tuna --cpus=0-7 --threads ll_ost_io* --move</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Move an irq to cpu 5</span></span><br><span class="line">$ tuna -c5 -q eth4-rx-4 -move</span><br><span class="line"></span><br><span class="line"><span class="comment">#Move all irqs named &quot;eth4*&quot; away from numa node 1</span></span><br><span class="line">$ tuna -S 1 -i -q <span class="string">&#x27;eth4*&#x27;</span>  </span><br><span class="line">                    |</span><br><span class="line">                    ---name from /proc/interrupts</span><br><span class="line">$ tuna --cpus CPUs --isolate</span><br><span class="line">$ tuna --cpus CPUs --include</span><br><span class="line">$ tuna --irqs IRQs --cpus CPU --move</span><br><span class="line">$ tuna --irqs sfc1* -c7 -m -x</span><br><span class="line">$ tuna --irqs <span class="string">&#x27;enp1s0f*&#x27;</span> --socket 0 --spread --show_irqs</span><br><span class="line">$ tuna --threads thread --priority policy:level  <span class="comment">#level:0-99</span></span><br><span class="line">$ tuna --cpus=0,1 --threads=ssh* --move --cpus=2,3 --threads=http* --move</span><br><span class="line">$ tuna --threads 7861 --show_threads</span><br><span class="line">$ tuna --threads 7861 --priority=RR:40</span><br><span class="line">$ tuna -t qemu* -P -c0 -mP -c1 -mP -c+0 -mP</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0 0xff,0xffffffff    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0 0xff,0xffffffff   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0 0xff,0xffffffff   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0 0xff,0xffffffff  54315196        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0 0xff,0xffffffff  42864592         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        0    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        0   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        0   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        0  54315198        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        0  42864593         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        1  54315200        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        1  42864595         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0      0,1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0      0,1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0      0,1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0      0,1  54315202        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0      0,1  42864597         6630        qemu-kvm</span><br><span class="line">```  </span><br><span class="line">   </span><br><span class="line">[tuna <span class="built_in">set</span> the linux process](https://access.redhat.com/solutions/2144921)   </span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># check kernel threads</span></span><br><span class="line">$ tuna -U -P</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  2      OTHER     0    0xfff 386420266      1048922        kthreadd</span><br><span class="line">  4      OTHER     0        0         7            0    kworker/0:0H</span><br><span class="line">  6      OTHER     0        0   4030025         3019     ksoftirqd/0</span><br><span class="line">  7       FIFO    99        0    155252            0     migration/0</span><br><span class="line"></span><br><span class="line">$ tuna --threads=7861 --priority=RR:40</span><br><span class="line">$ tuna --threads=sshd --show_threads --priority=RR:40 --show_threads</span><br><span class="line"></span><br><span class="line"><span class="comment"># Got the voluntary and nonvoluntary ctxt switch</span></span><br><span class="line"><span class="comment"># pid is the io test app</span></span><br><span class="line">grep ctxt_switches /proc/<span class="variable">$&#123;pid&#125;</span>/status</span><br><span class="line">voluntary_ctxt_switches:        2940930 (I/O bound)</span><br><span class="line">nonvoluntary_ctxt_switches:     9042</span><br><span class="line"></span><br><span class="line"><span class="comment"># 147095 is the cpu test app</span></span><br><span class="line">grep ctxt_switches /proc/147095/status</span><br><span class="line">voluntary_ctxt_switches:        478</span><br><span class="line">nonvoluntary_ctxt_switches:     1565 (CPU bound)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling automatic IRQ balancing</span></span><br><span class="line">$ systemctl stop irqbalance.service</span><br><span class="line">$ systemctl <span class="built_in">disable</span> irqbalance.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#  the kernel will automatically try to balance the load based on its understanding of the hardware&#x27;s NUMA layout</span></span><br><span class="line">$  <span class="built_in">echo</span> kernel.numa_balancing=0 &gt;&gt; /etc/sysctl.conf ; sysctl -p</span><br><span class="line"></span><br><span class="line">j$ <span class="built_in">cat</span> /sys/class/net/eth0/device/_node</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Isolated CPUs with the kernelâs scheduler load balancing:</span></span><br><span class="line">isolated_cores=2-23</span><br><span class="line"><span class="comment"># Isolated CPUs without the kernelâs scheduler load balancing:</span></span><br><span class="line">no_balance_cores=2,3</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;isolcpus=1-3,5-31, iommu=pt, audit=0&#x27;</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;intel_pstate=disable&#x27;</span></span><br><span class="line">$ grubby --update-kernel=ALL --remove-args=<span class="string">&#x27;mem=66G&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="modify-grub-boot-order"><a href="#modify-grub-boot-order" class="headerlink" title="modify grub boot order"></a>modify grub boot order</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --default-kernel</span><br><span class="line">$ grubby --default-index</span><br><span class="line"></span><br><span class="line">$ grubby --info=&quot;/boot/vmlinuz-$(uname -r)&quot;</span><br><span class="line">$ grubby --info=ALL | grep ^kernel</span><br><span class="line">$ grubby --set-default=&quot;/boot/vmlinuz-4.18.0-193.1.2.el8_2.x86_64&quot;</span><br><span class="line">$ grubby --info=ALL | grep -E &quot;^kernel|^index&quot;</span><br><span class="line">$ grubby --set-default-index=2</span><br></pre></td></tr></table></figure>

<h4 id="Cache-consistenta"><a href="#Cache-consistenta" class="headerlink" title="Cache consistenta"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/94811032">Cache consistent</a>a</h4><ul>
<li>write back<ul>
<li>only cache and then write to memory</li>
</ul>
</li>
<li>write through<ul>
<li>write cache and memory at the same time</li>
</ul>
</li>
<li>Snooping<ul>
<li>boardcast</li>
</ul>
</li>
<li>Directory-based<ul>
<li>index directory for some cores</li>
<li>The worst case: N x Cores, each core will communicates with the others(N-1)</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/20793.html">reference1</a><br><a target="_blank" rel="noopener" href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm">reference2</a></p>
<h4 id="AMD-SMT-255-cores"><a href="#AMD-SMT-255-cores" class="headerlink" title="AMD SMT, 255 cores"></a><a target="_blank" rel="noopener" href="https://developer.amd.com/wp-content/resources/56745_0.80.pdf">AMD SMT, 255 cores</a></h4><p>Some workloads, including many HPC ones, observe a performance neutral or even performance negative result when SMT is enabled. Some applications license by the hardware thread enabled, not just physical core. For those reasons, disabling SMT on your EPYC 7002 Series processor may be desirable. There are also some operating systems that have not enabled support for the x2APIC within the EPYC 7002 Series Processor, which is required to support beyond 255 threads. If you are running an operating system that does not support AMDâs x2APIC implementation, and have two 64-core processors installed, you will need to disable SMT.   </p>
<h4 id="CPU-STAT"><a href="#CPU-STAT" class="headerlink" title="CPU STAT"></a>CPU STAT</h4><h5 id="kernel-parameters"><a href="#kernel-parameters" class="headerlink" title="kernel parameters"></a>kernel parameters</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cpuidle.off=1   [CPU_IDLE]</span><br><span class="line">                <span class="built_in">disable</span> the cpuidle sub-system</span><br><span class="line">cpuidle.governor=</span><br><span class="line">                [CPU_IDLE] Name of the cpuidle governor to use.</span><br><span class="line">cpufreq.off=1   [CPU_FREQ]</span><br><span class="line">                <span class="built_in">disable</span> the cpufreq sub-system</span><br><span class="line">cpufreq.default_governor=</span><br><span class="line"></span><br><span class="line">intel_idle.max_cstate=0 processor.max_cstate=0 idle=mwait</span><br><span class="line">idle=mwait C1 will be entered whenever the core is idle irrespective of other settings</span><br><span class="line">idle=poll keeps the processing cores <span class="keyword">in</span> C0 state when used <span class="keyword">in</span> conjunction with intel_idle.max_cstate=0</span><br><span class="line"></span><br><span class="line">https://zorrozou.github.io/docs/%E8%AF%A6%E8%A7%A3Cgroup%20V2.html</span><br><span class="line">or <span class="keyword">for</span> debian</span><br><span class="line">$ cset shield --cpu 1-4 --kthread=on</span><br><span class="line"></span><br><span class="line"><span class="comment"># Isolated CPUs with the kernelâs scheduler load balancing:</span></span><br><span class="line">isolated_cores=2-23</span><br><span class="line"><span class="comment"># Isolated CPUs without the kernelâs scheduler load balancing:</span></span><br><span class="line">no_balance_cores=2,3</span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=32-47,48-63 default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=nomwait&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="CPU-IDLE"><a href="#CPU-IDLE" class="headerlink" title="CPU IDLE"></a>CPU IDLE</h5><ul>
<li><p>Performance Per Watt (DAPC)<br>  - Dell Active Power Control</p>
</li>
<li><p>Performance Per Watt (OS)<br>  - OS DBPM</p>
</li>
<li><p>P-states â changing frequency and voltage of cores, to reduce power dissipation or increase performance</p>
</li>
<li><p>C-state â voltage and frequency gating for CPU cores</p>
</li>
<li><p>PC-state â voltage gating components of the CPU</p>
</li>
<li><p>S-state â sleep state, equivalent to halt</p>
</li>
<li><p>D-state â device power management </p>
</li>
<li><p>CC0 Normal operating state of the CPU where code is being executed </p>
</li>
<li><p>CC1 All threads on that core execute HLT or MWAIT (C1&#x2F;C1E) instruction. The core is in low power mode with low voltage and frequency. When returning to CC0, frequency and voltage are restored to the state before idle state. </p>
</li>
<li><p>C1E Same as CC1, but when exiting this state, the CPU start operating in LFM CC3 The contents of L1, L2 caches are flushed to LLC, and the coreâs volt-age is lowered, and clock is stopped.  </p>
</li>
<li><p>CC6 The core saves its architectural state to SRAM, and the core is com-pletely powered down. </p>
</li>
<li><p>CC7 â CC10 These states are rarely used in Xeon CPUs, but if these states are im-plemented, they exhibit the same behaviour as CC6<br>It is important to note that a CPU has a special register call Time Stamp Counter (TSC). In Intel Xeon CPU, starting from Nehalem generation of CPUs, two generations prior to Ivy Bridge, TSC became C-state invariant, meaning that it never stops counting, and it also counts at a constant frequency.     </p>
</li>
<li><p>PC0 This is the normal operating state for the processor. The processor remains in the normal state when at least one of its processor IA cores is in the C0 or C1. Individual processor IA cores may be in deeper power idle states while the package is in C0 state. </p>
</li>
<li><p>PC2 Special package C-state not explicitly available to SW. There are two scenar-ios when this state is used:</p>
<ul>
<li>When deeper PC-states are off limits, and PC2 is the deepest PC-state</li>
<li>When the CPU is in PC3 state and a memory access request is received. In this case the CPU transitions to PC2, and completes all out-standing memory access requests, and then transitions back to PC3, or PC0 if there is a cause to wake from idle state.</li>
</ul>
</li>
<li><p>PC3 Package low power state </p>
</li>
<li><p>PC6 LLC Cache is flushed, and turned off </p>
</li>
<li><p>PC7 â PC10 Typically present only on Desktop CPUs, not on CPU meant for servers</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/drivers/idle/intel_idle.c</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cpuidle_state</span> <span class="title">skx_cstates</span>[] =</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">                .name = <span class="string">&quot;C1-SKX&quot;</span>,</span><br><span class="line">                .desc = <span class="string">&quot;MWAIT 0x00&quot;</span>,</span><br><span class="line">                .flags = MWAIT2flg(<span class="number">0x00</span>),</span><br><span class="line">                .exit_latency = <span class="number">2</span>,</span><br><span class="line">                .target_residency = <span class="number">2</span>,</span><br><span class="line">                .enter = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                .name = <span class="string">&quot;C1E-SKX&quot;</span>,</span><br><span class="line">                .desc = <span class="string">&quot;MWAIT 0x01&quot;</span>,</span><br><span class="line">                .flags = MWAIT2flg(<span class="number">0x01</span>),</span><br><span class="line">                .exit_latency = <span class="number">10</span>,</span><br><span class="line">                .target_residency = <span class="number">20</span>,</span><br><span class="line">                .enter = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                .name = <span class="string">&quot;C6-SKX&quot;</span>,</span><br><span class="line">                .desc = <span class="string">&quot;MWAIT 0x20&quot;</span>,</span><br><span class="line">                .flags = MWAIT2flg(<span class="number">0x20</span>) | CPUIDLE_FLAG_TLB_FLUSHED,</span><br><span class="line">                .exit_latency = <span class="number">133</span>,</span><br><span class="line">                .target_residency = <span class="number">600</span>,</span><br><span class="line">                .enter = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                .enter = <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>




</li>
<li><p><a target="_blank" rel="noopener" href="https://community.intel.com/t5/Software-Tuning-Performance/Monitoring-C1-and-C1E-core-c-state/m-p/1067363/highlight/true#M5233">intel cpu state</a><br>  - state0 âPOLLâ (cpu spin-waits because it is expected to get more work very soon â &lt; 10 microseconds)<br>  - state1 âC1-SKXâ â default behavior of MWAIT with argument EAX&#x3D;0x00 â has 2 microsecond wakeup latency<br>  - state2 âC1E-SKXâ â MWAIT with argument EAX&#x3D;0x01 â has 10 microsecond wakeup latency and drops core to maximum efficiency frequency<br>  - state3 âC6-SKXâ â MWAIT with argument EAX&#x3D;0x20 â has 133 microsecond wakeup latency and turns off core (allowing more power to other cores)</p>
</li>
<li><p>idle&#x3D;poll</p>
<ul>
<li>idle&#x3D;poll is somewhat drastic in many cases, as preventing idle CPUs from saving almost any energy at all may not be the only effect of it.<ul>
<li>For example, on Intel hardware it effectively prevents CPUs from using P-states (see CPU Performance Scaling) that require any number of CPUs in a package to be idle, so it very well may hurt single-thread computations performance as well as energy-efficiency. Thus using it for performance reasons may not be a good idea at all</li>
</ul>
</li>
</ul>
</li>
<li><p>idle&#x3D;halt</p>
<ul>
<li>In the idle&#x3D;halt case, the architecture support code will use the HLT instruction of the CPUs (which, as a rule, suspends the execution of the program and causes the hardware to attempt to enter the shallowest available idle state) for this purpose, and if idle&#x3D;poll is used, idle CPUs will execute a more or lessa lightweightââ sequence of instructions in a tight loop.</li>
</ul>
</li>
<li><p>idle&#x3D;nomwait</p>
<ul>
<li>The idle&#x3D;nomwait option disables the intel_idle driver and causes acpi_idle to be used (as long as all of the information needed by it is there in the systemâs ACPI tables), but it is not allowed to use the MWAIT instruction of the CPUs to ask the hardware to enter idle states.</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.0/admin-guide/pm/cpuidle.html">In addition to the architecture-level kernel command line options affecting CPU idle time management, there are parameters affecting individual CPUIdle drivers that can be passed to them via the kernel command line. Specifically, the intel_idle.max_cstate&#x3D;<n> and processor.max_cstate&#x3D;<n> parameters, where <n> is an idle state index also used in the name of the given stateâs directory in sysfs (see Representation of Idle States), causes the intel_idle and acpi_idle drivers, respectively, to discard all of the idle states deeper than idle state <n></a></p>
<p>By booting with the kernel command line argument processor.max_cstate&#x3D;1 and idle&#x3D;poll the system will never enter a C-state other than zero and will not even use the MWAIT mechanism to temporarily halt in the idle routine. While this will provide the fastest scheduler response time, it is very wasteful of power and will generate heat that requires the air conditioning system to run (and waste more power).       </p>
<p>This method is not recommended for general use, but can be quite handy for testing whether your application is being affected by cstates and idle transition latency. Booting your kernel and adding the commandline options: processor.max_cstate&#x3D;1 idle&#x3D;poll     </p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/articles/65410">The second method, which has a bit more fine-grained control of the power management features, is to use the Power Management Quality of Service interface (PM QOS). The file &#x2F;dev&#x2F;cpu_dma_latency is the interface which when opened registers a quality-of-service request for latency with the operating system. A program should open &#x2F;dev&#x2F;cpu_dma_latency, write a 32-bit number to it representing a maximum response time in microseconds and then keep the file descriptor open while low-latency operation is desired.  Writing a zero means that you want the fastest response time</a><br><a target="_blank" rel="noopener" href="https://gist.github.com/SaveTheRbtz/f5e8d1ca7b55b6a7897b">Set the cpu_dma_latency</a>    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2009 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span></span><br><span class="line"><span class="comment"> * Copyright 2010 Luis R. Rodriguez &lt;lrodriguez@atheros.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Permission to use, copy, modify, and/or distribute this software for any</span></span><br><span class="line"><span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span></span><br><span class="line"><span class="comment"> * copyright notice and this permission notice appear in all copies.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span></span><br><span class="line"><span class="comment"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span></span><br><span class="line"><span class="comment"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span></span><br><span class="line"><span class="comment"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span></span><br><span class="line"><span class="comment"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span></span><br><span class="line"><span class="comment"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span></span><br><span class="line"><span class="comment"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Compile simply with:</span></span><br><span class="line"><span class="comment"> *	cc -o cpudmalatency cpudmalatency.c	</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Some unpatched buggy BIOSes create excessive C-state transition latencies</span></span><br><span class="line"><span class="comment"> * which can affect DMA on some devices. Instead of patching each and every</span></span><br><span class="line"><span class="comment"> * Linux kernel driver to account for these inefficiencies - lets punt these</span></span><br><span class="line"><span class="comment"> * work arounds to userspace. Linux distributions will hopefully have a way</span></span><br><span class="line"><span class="comment"> * to automatically detect these buggy platforms and call this. Note that</span></span><br><span class="line"><span class="comment"> * this app will hold the file open.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int32_t</span> v;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;latency [us]&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;	latency: the maximum tolerable CPU DMA you\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;	         are willing to put up with [in microseconds]\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This program will block until you hit Ctrl-C, at which point\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;the file descriptor is closed and the latency requirement is\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;unregistered again.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Hint: if you have an platform with a buggy BIOS that has\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;issues with excessive C-state transition latencies try value 55\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;setting latency to %d.%.6d seconds\n&quot;</span>, v/<span class="number">1000000</span>, v % <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">&quot;/dev/cpu_dma_latency&quot;</span>, O_WRONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open /dev/cpu_dma_latency&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, &amp;v, <span class="keyword">sizeof</span>(v)) != <span class="keyword">sizeof</span>(v)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;write to /dev/cpu_dma_latency&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://huataihuang.gitbooks.io/cloud-atlas/content/os/linux/kernel/cpu/intel_pstate.html">intel_pstate for more info</a><br><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cpuidle/sysfs.txt">cpuidle work with linux</a>    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable turbo in intel_pstate</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/devices/system/cpu/intel_pstate/no_turbo</span><br><span class="line"><span class="comment"># acpi-cpufreq disable</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpufreq/boost</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line">$ ./cpudmalatency 20</span><br><span class="line">setting latency to 0.000020 seconds</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /sys/devices/system/cpu/cpu0/cpuidle/</span><br><span class="line">state0  state1  state2  state3  state4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## Option to disable this idle state (bool, 1 disable idle, 0 enable)</span></span><br><span class="line"><span class="built_in">echo</span> 1 | <span class="built_in">tee</span> -a /sys/devices/system/cpu/cpu*/cpuidle/state*/disable</span><br><span class="line"></span><br><span class="line"><span class="comment">## mode</span></span><br><span class="line"><span class="built_in">cat</span> /sys/devices/system/cpu/cpu0/cpuidle/state*/name</span><br><span class="line">POLL</span><br><span class="line">C1-HSW</span><br><span class="line">C1E-HSW</span><br><span class="line">C3-HSW</span><br><span class="line">C6-HSW <span class="comment">### C6   Deep Power Down         Reduces the CPU internal voltage to any value, including 0 V</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Latency to exit out of this idle state (in microseconds)</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu0/cpuidle/state*/latency</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">10</span><br><span class="line">33</span><br><span class="line">133</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you could not get the cpu freq from &quot;cpupower frequency-info&quot;</span></span><br><span class="line"><span class="comment"># use the command</span></span><br><span class="line">cpupower monitor -m Mperf</span><br><span class="line">cpupower frequency-set -g performance</span><br><span class="line">cpupower idle-set -d 0</span><br><span class="line">cpupower idle-set -d 1</span><br><span class="line">cpupower idle-set -d 2</span><br><span class="line">cpupower idle-set -d 3</span><br><span class="line">cpupower idle-set -d 4</span><br><span class="line">tuned-adm profile throughput-performance</span><br><span class="line">tuned-adm active</span><br><span class="line"></span><br><span class="line"><span class="comment">#custom </span></span><br><span class="line">$ <span class="built_in">mkdir</span> /etc/tuned/my_profile</span><br><span class="line">$ vi /etc/tuned/my_profile/tuned.conf</span><br><span class="line">[main]</span><br><span class="line">summary=Customized tuning on top of cpu-partitioning</span><br><span class="line">include=cpu-partitioning</span><br><span class="line">[cpu]</span><br><span class="line">force_latency=cstate.id:0|1</span><br><span class="line">$ tuned-adm profile my_profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#direct set the latency</span></span><br><span class="line">$ cpupower idle-set -D 133 <span class="comment">##enable 0,1,2,3 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 33  <span class="comment">##enable 0,1,2 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 10  <span class="comment">##enable 0,1 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 2   <span class="comment">##enable 0 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 0   <span class="comment">##disable 0,1,2,3,4</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/support/articles/000006619/processors/intel-core-processors.html">intel-core-idle-info</a></p>
<ul>
<li><p>CPU&#x2F;Package sleep states</p>
<ul>
<li>C0 - Active: CPU is on and operating.</li>
<li>C1 - Auto Halt: Core clock is off. The processor is not executing instructions, but can return to an executing state almost instantaneously. Some processors also support an enhanced C1 state (C1E) for lower power consumption.</li>
<li>C2 - Stop Clock: Core and bus clocks are off. The processor maintains all software-visible state, but can take longer to wake up.</li>
<li>C3 - Deep Sleep: Clock generator is off. The processor does not need to keep its cache coherent, but maintains other states. Some processors have variations of the C3 state (Deep Sleep, Deeper Sleep) that differ by how long it takes to wake the processor.</li>
<li>C4 - Deeper Sleep: Reduced VCC</li>
<li>DC4 - Deeper C4 Sleep: Further reduced VCC</li>
</ul>
</li>
<li><p>ACPI (Advanced Configuration and Power Interface)   </p>
<ul>
<li>The ACPI on the System Manageability Bus enables low-power sleep mode and conserves energy when a system is idle.</li>
</ul>
</li>
<li><p>Power management</p>
<ul>
<li>How power is efficiently directed to different components of a system. Power management is especially important for portable devices that rely on battery power. By reducing power to components that are not being used, a good power management system can double or triple the lifetime of a battery.</li>
</ul>
</li>
<li><p>Deeper Sleep</p>
<ul>
<li>Works along with IntelÂ® QuickStart technology on IntelÂ® Mobile Processors. Deeper Sleep is a dynamic power management mode that delivers longer battery life. Deeper Sleep minimizes the power consumption of the CPU when it senses an extended period of inactivity by the user. It reduces power when idle and quickly restores the CPU to an active state as soon as the user resumes use of the system. It reduces processor voltage below the minimum operating voltage while preserving the processor state. Deeper Sleep is functionally identical to the Deep Sleep State but at a 66 percent lower voltage.</li>
</ul>
</li>
<li><p>QuickStart technology</p>
<ul>
<li>Extends battery life by entering a low-power state during the briefest pauses in user activity, such as between key strokes. Instantly returns to full-power state when prompted.</li>
</ul>
</li>
<li><p>IntelÂ® Enhanced Deeper Sleep with Dynamic Cache Sizing</p>
<ul>
<li>This new power savings mechanism flushes system memory dynamically, based on demand or during periods of inactivity. Power savings occur as the cache ways are turned off once the data has been saved in memory. L2 cache data integrity determines Deeper Sleep minimum voltage limits for the IntelÂ® Coreâ¢ Duo processor. Once the Dynamic Cache Sizing feature flushes the entire L2 cache to memory, the processor transitions to IntelÂ® Enhanced Deeper Sleep. This allows the processor to lower voltage below the Deeper Sleep minimum voltage for enhanced power savings and&#x2F;or efficiencies.</li>
</ul>
</li>
<li><p>Mwait is a special instruction in CPUs which essentially instructs the CPU to enter power saving mode. Mwait can be called in a variety of ways. Mwait can be called with a time hint, to tell the CPU for how long it should be idle. Mwait can also be called with a hint for C-state. Intel_idle passes the information from idle governor to the hardware by call-ing mwait with hints to desired C-state<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.163/source/drivers/idle/intel_idle.c#L1115">source code</a>   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">call_cpuidle() &#123;</span><br><span class="line">  cpuidle_enter() &#123;</span><br><span class="line">    cpuidle_enter_state() &#123;</span><br><span class="line">      sched_idle_set_state();</span><br><span class="line">      intel_idle() &#123;</span><br><span class="line">        leave_mm();</span><br><span class="line">        mwait_idle_with_hints.constprop<span class="number">.2</span>();</span><br><span class="line">      &#125;</span><br><span class="line">     sched_idle_set_state();</span><br><span class="line">     arch_local_irq_enable() &#123;</span><br><span class="line">       do_IRQ() &#123;</span><br><span class="line">         irq_enter() &#123;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set the maximum frequency</span></span><br><span class="line">$ cpupower frequency-set -u 2.8G</span><br><span class="line">$ cpupower frequency-set -d 2.0G</span><br><span class="line">$ <span class="built_in">echo</span> 3000000 | <span class="built_in">tee</span> /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpuidle/current_driver</span><br><span class="line">intel_idle</span><br><span class="line"></span><br><span class="line"><span class="comment">#switch driver</span></span><br><span class="line">$ modprobe -r acpi_cpufreq</span><br><span class="line">$ modprobe intel_pstate</span><br><span class="line"></span><br><span class="line"><span class="comment">#or in the lower OS</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;install acpi_cpufreq /sbin/modprobe intel_pstate&#x27;</span> &gt;/etc/modprobe.d/cpu.conf</span><br><span class="line">$ dracut -f --add-drivers intel_pstate</span><br><span class="line"><span class="comment">#The intel_pstate driver was added later during RHEL6 life cycle and is available in our kernel since RHEL6.5, but Red Hat decided to keep acpi_cpufreq as default to prevent any potential compatibility issues.</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /usr/lib/modules/$(<span class="built_in">uname</span> -r)/kernel/drivers/cpufreq/</span><br><span class="line">acpi-cpufreq.ko.xz          cpufreq_stats.ko.xz  pcc-cpufreq.ko.xz  speedstep-lib.ko.xz</span><br><span class="line">amd_freq_sensitivity.ko.xz  p4-clockmod.ko.xz    powernow-k8.ko.xz</span><br><span class="line"></span><br><span class="line">$ cpupower frequency-info --driver</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line"></span><br><span class="line">$ cpupower frequency-info --governors</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/intel_pstate/status</span><br><span class="line">active</span><br><span class="line">$ <span class="built_in">echo</span> off | sudo <span class="built_in">tee</span> /sys/devices/system/cpu/intel_pstate/status</span><br><span class="line">off</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> acpi-cpufreq &gt; /sys/devices/system/cpu/cpu2/cpufreq/scaling_driver</span><br><span class="line">-bash: /sys/devices/system/cpu/cpu2/cpufreq/scaling_driver: Permission denied</span><br><span class="line"><span class="comment"># can&#x27;t reload the driver</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cpuid show all cpu features</span></span><br><span class="line">$ cpuid -1 -l5</span><br><span class="line">Disclaimer: cpuid may not support decoding of all cpuid registers.</span><br><span class="line">CPU:</span><br><span class="line">   MONITOR/MWAIT (5):</span><br><span class="line">      smallest monitor-line size (bytes)       = 0x40 (64)</span><br><span class="line">      largest monitor-line size (bytes)        = 0x40 (64)</span><br><span class="line">      enum of Monitor-MWAIT exts supported     = <span class="literal">true</span></span><br><span class="line">      supports intrs as break-event <span class="keyword">for</span> MWAIT  = <span class="literal">true</span></span><br><span class="line">      number of C0 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C1 sub C-states using MWAIT    = 0x2 (2)</span><br><span class="line">      number of C2 sub C-states using MWAIT    = 0x1 (1)</span><br><span class="line">      number of C3 sub C-states using MWAIT    = 0x2 (2)</span><br><span class="line">      number of C4 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C5 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C6 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C7 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line"></span><br><span class="line">$ cpuid -1 -l6</span><br><span class="line">Disclaimer: cpuid may not support decoding of all cpuid registers.</span><br><span class="line">CPU:</span><br><span class="line">   Thermal and Power Management Features (6):</span><br><span class="line">      digital thermometer                     = <span class="literal">true</span></span><br><span class="line">      Intel Turbo Boost Technology            = <span class="literal">true</span></span><br><span class="line">      ARAT always running APIC timer          = <span class="literal">true</span></span><br><span class="line">      PLN power <span class="built_in">limit</span> notification            = <span class="literal">true</span></span><br><span class="line">      ECMD extended clock modulation duty     = <span class="literal">true</span></span><br><span class="line">      PTM package thermal management          = <span class="literal">true</span></span><br><span class="line">      HWP base registers                      = <span class="literal">false</span></span><br><span class="line">      HWP notification                        = <span class="literal">false</span></span><br><span class="line">      HWP activity window                     = <span class="literal">false</span></span><br><span class="line">      HWP energy performance preference       = <span class="literal">false</span></span><br><span class="line">      HWP package level request               = <span class="literal">false</span></span><br><span class="line">      HDC base registers                      = <span class="literal">false</span></span><br><span class="line">      digital thermometer thresholds          = 0x2 (2)</span><br><span class="line">      ACNT/MCNT supported performance measure = <span class="literal">true</span></span><br><span class="line">      ACNT2 available                         = <span class="literal">false</span></span><br><span class="line">      performance-energy bias capability      = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>looks like the x86 has the differnet behaviors in the different power management policy in linux kernel code</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pause and rep;nop </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nops(times) __asm__ __volatile__(<span class="string">&quot;rep;nop&quot;</span>:<span class="string">&quot;=c&quot;</span>(result):<span class="string">&quot;c&quot;</span>(times))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> movstr(src,des) __asm__ __volatile__(   <span class="string">&quot;cld\n\t&quot;</span>       \</span></span><br><span class="line"><span class="meta">                                                <span class="string">&quot;rep;movsb&quot;</span>     \</span></span><br><span class="line"><span class="meta">                                                :<span class="string">&quot;=c&quot;</span>(result)           \</span></span><br><span class="line"><span class="meta">                                                :<span class="string">&quot;S&quot;</span>(src),<span class="string">&quot;D&quot;</span>(des),<span class="string">&quot;c&quot;</span>(times))</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> times, result;</span><br><span class="line">        <span class="type">char</span> src[<span class="number">5</span>] = &#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>&#125;;</span><br><span class="line">        <span class="type">char</span> des[<span class="number">5</span>];</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"> </span><br><span class="line">        times = <span class="number">5</span>;</span><br><span class="line">        result = <span class="number">5</span>;</span><br><span class="line"> </span><br><span class="line">        movstr(src,des);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;result = %d\n&quot;</span>, result);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; times; i++)</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">&quot;%c  &quot;</span>, des[i]);</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        times = <span class="number">5</span>;</span><br><span class="line">        nops(times);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;result = %d\n&quot;</span>, result);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">./rep</span><br><span class="line">result = <span class="number">0</span></span><br><span class="line">a  b  c  d  e  </span><br><span class="line">result = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">ä¸é¢ç¨åºä¸­ï¼ movstr() å®ç¨æ¥æ¼ç¤ºä¸è¬ç rep åç¼çä½¿ç¨æ¹å¼ï¼è¿éç¨ä¸æ®µåèæ±ç¼å°æ°ç» src ä¸­ç <span class="number">5</span> ä¸ªå­ç¬¦é½æ·è´å° des æ°ç»ä¸­å»ãåå¼å§æ¶ï¼result åéçå¼ä¸º <span class="number">5</span> ãä½å¨æ§è¡å® movstr() åï¼å®åä¸º <span class="number">0</span> ï¼è¿ä¸ªå¼æ¯éè¿ ecx å¯å­å¨ä¼ éè¿å»çï¼å ä¸ºæ­£æ¯ä½¿ç¨äº rep åç¼ï¼å°å¤å¶æåï¼ecx çå¼å°±ä¼åä¸º <span class="number">0</span> ãæ¥çï¼æä»¬æ§è¡ nops() å®ãnops å®å°±æ¯ç¨æ¥æµè¯ rep;nop çï¼ç rep;nop æ¯ä¸æ¯ä¼æ§è¡ <span class="number">5</span> æ¬¡ï¼å¦ææ¯çè¯ï¼é£ä¹ result å°æåä¼åä¸º <span class="number">0</span> ï¼ä½æç»ç»æä¸æ¯ï¼èæ¯ <span class="number">5</span> ãç±æ­¤å¯è§ï¼rep;nop å¹¶ä¸ç­åäºæ§è¡äº <span class="number">5</span> ä¸ª nop ãé£ä¹ rep;nop æ¯ä»ä¹å¢ï¼éè¿åæ±ç¼ç¨åºå¯ä»¥çå°ï¼rep;nop è¢«ç¿»è¯æ pause æä»¤ï¼ä¸ä¸¤èçæä»¤ç é½æ¯ f3 <span class="number">90</span> ãé£ä¹ pause æä»¤æ¯åä»ä¹çå¢ï¼è¿å¨ Intel æåéæè§£éï¼</span><br><span class="line"></span><br><span class="line">PAUSEâSpin Loop Hint</span><br><span class="line">Description</span><br><span class="line">Improves the performance of spin-wait loops. When executing a âspin-wait loop,â a Pentium <span class="number">4</span></span><br><span class="line">processor suffers a severe performance penalty when exiting the loop because it detects a</span><br><span class="line">possible memory order violation. The PAUSE instruction provides a hint to the processor that</span><br><span class="line">the code sequence is a spin-wait loop. The processor uses this hint to bypass the memory order</span><br><span class="line">violation in most situations, which greatly improves processor performance. For this reason, it</span><br><span class="line">is recommended that a PAUSE instruction be placed in all spin-wait loops.</span><br><span class="line">æå spin-wait <span class="title function_">loops</span><span class="params">(èªæéå¾ªç¯ç­å¾)</span>çæ§è½ãå¨æ§è¡ä¸ä¸ª spin-wait loop æ¶ï¼Pentium4 å¤çå¨ä¼</span><br><span class="line">éå°ä¸¥éçæ§è½æå¤±.PAUSE æä»¤ä¼åå¤çå¨æä¾ä¸ç§æç¤ºï¼åè¯å¤çå¨ææ§è¡çä»£ç åºåæ¯ä¸ä¸ª spin-wait loopã</span><br><span class="line">å¤çå¨ä¼æ ¹æ®è¿ä¸ªæç¤ºèé¿å¼åå­åºåå²çª<span class="params">(memory order violation)</span>ï¼ä¹å°±æ¯è¯´å¯¹ spin-wait loop ä¸åç¼å­ï¼ä¸åæä»¤</span><br><span class="line">éæ°æåºç­å¨ä½ãè¿æ ·å°±å¯ä»¥å¤§å¤§çæé«äºå¤çå¨çæ§è½ãæ­£æ¯åºäºæ­¤ï¼æå»ºè®®å¨ spin-wait loops ä¸­ä½¿ç¨ pasuse æä»¤ã</span><br><span class="line">An additional function of the PAUSE instruction is to reduce the power consumed by a Pentium</span><br><span class="line">4 processor <span class="keyword">while</span> executing a spin loop. The Pentium 4 processor can execute a spin-wait loop</span><br><span class="line">extremely quickly, causing the processor to consume a lot of power <span class="keyword">while</span> it waits <span class="keyword">for</span> the</span><br><span class="line">resource it is spinning on to become available. Inserting a pause instruction in a spin-wait loop</span><br><span class="line">greatly reduces the processorâs power consumption.</span><br><span class="line">PAUSEæä»¤çå¦å¤ä¸ä¸ªåè½æ¯è®© Pentium4 å¤çå¨å¨æ§è¡ spin-wait loop æ¶å¯ä»¥åå°çµæºçæ¶èã</span><br><span class="line">å¨ç­å¾èµæºèæ§è¡èªæéç­å¾æ¶ï¼Pentium4 å¤çå¨ä»¥æå¿«çéåº¦æ§è¡èªæç­å¾æ¶ï¼å°ä¼æ¶èå¾å¤çµè½ï¼</span><br><span class="line">ä½ä½¿ç¨ pause æä»¤åå¯ä»¥æå¤§çåå°å¤çå¨ççµè½æ¶èã</span><br><span class="line">This instruction was introduced in the Pentium 4 processors, but is backward compatible with</span><br><span class="line">all IA-32 processors. In earlier IA-32 processors, the PAUSE instruction operates like a NOP</span><br><span class="line">instruction.</span><br><span class="line">PAUSE æä»¤å¨ Pentium4 å¤çå¨ä¸­å¼å¥ï¼ä½å®ä¹æ¯ååå¼å®¹çãå¨æ©åç IA-32 å¤çå¨éï¼PAUSE æä»¤å®éä¸å°±ç¸å½äº NOP æä»¤ã</span><br><span class="line">The Pentium 4 processor implements the PAUSE instruction as a pre-defined delay. The delay</span><br><span class="line">is finite and can be zero <span class="keyword">for</span> some processors. This instruction does not change the architectural</span><br><span class="line">state of the <span class="title function_">processor</span> <span class="params">(that is, it performs essentially a delaying no-op operation)</span>.</span><br><span class="line">Pentium4 å¤çå¨ä»¥ä¸ç§ é¢å»¶è¿<span class="params">(pre-defined delay)</span>çææ¯æ¥å®ç° PAUSE æä»¤ãè¿ç§å»¶è¿ä¹æ¯æéåº¦çï¼å¹¶ä¸å¨ä¸äºå¤çå¨ä¸æ¯é¶å»¶è¿ãè¯¥æä»¤ä¸ä¼æ¹åå¤çå¨çå¤çå¨çç¶æã</span><br><span class="line"></span><br><span class="line">ç®åè¯´, Intelæ¨èå¨spin-wait loopsä¸­ä½¿ç¨pauseæä»¤, å ä¸ºå®æ¢å¯ä»¥é¿åæ§è½æå¤±, é¿å¼åå­åºåå²çª, è¿å¯ä»¥åå°çµæºæ¶è, å¹¶ä¸ä¸ä¼æå¼å®¹æ§é®é¢.</span><br><span class="line">æ±ç¼æä»¤repçæ¬ææ¯éå¤æ§è¡repåçæä»¤ç´å°ecxå¯å­å¨ä¸­çå¼åæ0ä¸ºæ­¢</span><br><span class="line"><span class="comment">/* REP NOP (PAUSE) is a good thing to insert into busy-wait loops. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">rep_nop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__ __volatile__(<span class="string">&quot;rep;nop&quot;</span>: : :<span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">delay_tsc</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> loops)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> bclock, now;</span><br><span class="line"> </span><br><span class="line">    preempt_disable();        <span class="comment">/* TSC&#x27;s are per-cpu */</span></span><br><span class="line">    rdtscl(bclock);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        rep_nop();</span><br><span class="line">        rdtscl(now);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((now-bclock) &lt; loops);</span><br><span class="line">    preempt_enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä¸é¢å½æ°ï¼éè¿ä¸æ­çè¯»å TSC çå¼æ¥æ¯è¾æ¯å¦å·²ç»è¾¾å°è¦æ±ç loops æ¥å»¶è¿ï¼å¨å»¶è¿çè¿ç¨ä¸­ä¸æ­çæ§è¡ rep_nop() å½æ°è¿è¡ pause ã</span><br><span class="line">http:<span class="comment">//www.groad.net/bbs/forum.php?mod=viewthread&amp;tid=3373</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><a href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform" class="headerlink" title="Application multiple threads get down to single core cause performance issue in intel skylake platform"></a>Application multiple threads get down to single core cause performance issue in intel skylake platform</h4><ul>
<li>The test CPU was Intel 2x Silver 4116</li>
<li>Default OS version was 3.10.0-862.el7.x86_64<br>  - Pstate enabled in BIOS, I donât know why it âs not work<br>  - <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/7.7_release_notes/index#enhancement_kernel">RHEL 7.7 release note BZ#1698453</a> The intel_pstate driver loads on the Intel Skylake-X systems with HWP disabled<br>  - How to avoid this get down to single core<br>          - Upgrade kernel to RHEL 7.7+<br>          - Disable Hyper threading</li>
<li>if you set BIOS to performance mode, HWP(Hardware-Controlled Performance States) will be disabled cause not loading intel_pstate<br>  - <a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-pm/patch/20180110193852.63667-2-srinivas.pandruvada@linux.intel.com/">cpufreq: intel_pstate: Add Skylake servers support</a></li>
</ul>
<p>Looks like acpi-cpu-freq not support Turbo mode for each cores</p>
<p>Before upgrade</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### intel pstat 3.6GHz</span></span><br><span class="line"> cpupower  frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 1.20 GHz - 3.70 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 1.20 GHz and 3.70 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 3.60 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: <span class="built_in">yes</span></span><br><span class="line">    Active: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACPI-cpufreq only 3.4GHz, not 3.6GHz</span></span><br><span class="line"></span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 1.20 GHz - 3.40 GHz</span><br><span class="line">  available frequency steps:  3.40 GHz, 3.40 GHz, 3.30 GHz, 3.10 GHz, 3.00 GHz, 2.80 GHz, 2.70 GHz, 2.50 GHz, 2.30 GHz, 2.20 GHz, 2.00 GHz, 1.90 GHz, 1.70 GHz, 1.60 GHz, 1.40 GHz, 1.20 GHz</span><br><span class="line">  available cpufreq governors: conservative userspace powersave ondemand performance</span><br><span class="line">  current policy: frequency should be within 1.20 GHz and 3.40 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 3.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: <span class="built_in">yes</span></span><br><span class="line">    Active: <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>After upgarde   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 3.00 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.00 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 2.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: <span class="built_in">yes</span></span><br><span class="line">    Active: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Single core</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">11671 root      20   0   66.6g  64.1g   2176 S  14.3 40.9   5741:29 xxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#Multiple cores</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">19663 root      20   0   41.5g  40.6g   3680 S  2235 25.9 830:58.64 xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<h4 id="E3-v6-Turbo-not-support-under-the-CentOS6"><a href="#E3-v6-Turbo-not-support-under-the-CentOS6" class="headerlink" title="E3 v6 Turbo not support under the CentOS6"></a>E3 v6 Turbo not support under the CentOS6</h4><p>The status is wrong, when you benchmark the CPU, you will got the turbo worked.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ cpupower frequency-set --governor ondemand/powersave/performance</span><br><span class="line"></span><br><span class="line">CentOS 6</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line"></span><br><span class="line">CentOS 7</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br></pre></td></tr></table></figure>

<h4 id="Isolated-CPUs-example"><a href="#Isolated-CPUs-example" class="headerlink" title="Isolated CPUs example"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/isolating_cpus_using_tuned-profiles-realtime">Isolated CPUs example</a></h4><ul>
<li>isolcpus: Isolate a given set of CPUs from disturbance. Deprecated - use cpusets instead<ul>
<li><a target="_blank" rel="noopener" href="https://www.codeblueprint.co.uk/2019/10/08/isolcpus-is-deprecated-kinda.html">It prevent all kernel tasks from running there and, crucially, it prevents the Linux scheduler load balancer from placing tasks on those CPUs too</a></li>
<li>isolcpus disabled the scheduler load balancer for CPUs 1-4 (eg: isolcpus&#x3D;1-4)</li>
<li>How to use<ul>
<li>isolcpus&#x3D;1-4 and you use taskset to place your four vCPU tasks on to those isolated CPUs like so: taskset -c 1-4 -p <task pid><ul>
<li>show the process and CPU core number: âps -aLo comm,psrâ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Isolating CPUs generally involves:<br>removing all user-space threads;<br>removing any unbound kernel threads (bound kernel threads are tied to a specific CPU and may not be moved);<br>removing interrupts by modifying the &#x2F;proc&#x2F;irq&#x2F;N&#x2F;smp_affinity property of each Interrupt Request (IRQ) number N in the system.</p>
<p>Plan out CPU allocation, e.g.<br>        * CPUs should NOT be used for more than one task.<br>        * CPUs for host OS<br>        * CPUs for XVIO<br>        * CPUs for VMs<br>                * CPUs for guest OS<br>                * CPUs for VNF or application</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ yum install tuned tuned-profiles-realtime</span><br><span class="line">$ <span class="built_in">cat</span> /etc/tuned/realtime-variables.conf</span><br><span class="line">isolated_cores=0-3,5,7</span><br><span class="line">$ tuned-adm profile realtime</span><br><span class="line">$ grep isolcpus /proc/cmdline</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=32-47,48-63 default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=nomwait&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/cpu-Isolated-334379.png"></p>
<h5 id="use-the-isolated-core"><a href="#use-the-isolated-core" class="headerlink" title="use the isolated core"></a>use the isolated core</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## run the benchmark for all cores, you could see the core 2 not worked</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()</span><br><span class="line">&#123;  </span><br><span class="line">   fork();</span><br><span class="line">   fork();</span><br><span class="line">   fork();</span><br><span class="line">   <span class="keyword">while</span>(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## you could taskset to core 2</span></span><br><span class="line">$ taskset -c 2 ./your_app</span><br><span class="line"></span><br><span class="line"><span class="comment">## isolate the kernel thread and interrupt</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/..../smp_affinity</span><br><span class="line">fb</span><br><span class="line">fb = 11111011</span><br><span class="line">          |</span><br><span class="line">          -----avoid the core 2</span><br></pre></td></tr></table></figure>
<p>the author show the timer tick in the core 2 too<br>The kernel docs <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/timers/no_hz.html">NO_HZ</a></p>
<ul>
<li>ever omit scheduling-clock ticks (CONFIG_HZ_PERIODIC&#x3D;y or CONFIG_NO_HZ&#x3D;n for older kernels). You normally will -not- want to choose this option.</li>
<li>Omit scheduling-clock ticks on idle CPUs (CONFIG_NO_HZ_IDLE&#x3D;y or CONFIG_NO_HZ&#x3D;y for older kernels). This is the most common approach, and should be the default.</li>
<li>Omit scheduling-clock ticks on CPUs that are either idle or that have only one runnable task (CONFIG_NO_HZ_FULL&#x3D;y). Unless you are running realtime applications or certain types of HPC workloads, you will normally -not- want this option.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /boot/config-5.11.0-25-generic | grep NO_HZ_FULL</span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_FULL is not set</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## recomplie the kernel</span></span><br><span class="line">CONFIG_NO_HZ_FULL=y</span><br><span class="line">(x) Full dynticks system(tickless)</span><br></pre></td></tr></table></figure>

<p>Only one job in core 2, the timer interrupt will not increaseâ¦. not test, just record<br>and he use dma-map-benchmark to run DMA map and unmap, the core 2 not work too  </p>
<ul>
<li><p>In the HPC env</p>
<ul>
<li>isolcpus these cores<ul>
<li>pin the HPC job to these cores(part 1)</li>
<li>pin the interrupt and kernel threads to another cores(part 2)</li>
<li>CONFIG_NO_HZ_FULL&#x3D;y and running single job to each core</li>
</ul>
</li>
</ul>
</li>
<li><p>PREEMPT_RT real time kernel</p>
</li>
<li><p>randomsize_va_space </p>
<ul>
<li>sudo bash -c âecho 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_spaceâ           # address randomization<ul>
<li>0 Turn the process address space randomization off. This is the default for architectures that do not support this feature anyways, and kernels that are booted with the ânorandmapsâ parameter.</li>
<li>1 Make the addresses of mmap base, stack and VDSO page randomized. This, among other things, implies that shared libraries will be loaded to random addresses. Also for PIE-linked binaries, the location of code start is randomized. This is the default if the CONFIG_COMPAT_BRK option is enabled.</li>
<li>2 Additionally enable heap randomization. This is the default if CONFIG_COMPAT_BRK is disabled</li>
</ul>
</li>
</ul>
</li>
<li><p>CONFIG_NO_HZ_FULL&#x3D;y</p>
</li>
<li><p>The Read-Copy-Update (RCU) system is a lockless mechanism for mutual exclusion inside the kernel. As a consequence of performing RCU operations, call-backs are sometimes queued on CPUs to be performed at a future moment when removing memory is safe</p>
<ul>
<li>To remove one or more CPUs from the candidates for running RCU callbacks<ul>
<li>rcu_nocbs&#x3D;1,4-6<ul>
<li>1,4,5,6 is a no-callback CPU</li>
<li>This means that RCU callbacks will not be done in the rcuc&#x2F;$CPU thread pinned to CPU 1,4,5,7, relieving CPU 1,4,5,6 from doing RCU callbacks job.</li>
</ul>
</li>
<li>tuna -t rcu* -c 0 -m<ul>
<li>The core 0 denotes the housekeeping CPU</li>
<li>This relieves all CPUs other than CPU 0 from doing RCU work.</li>
</ul>
</li>
<li>rcu_nocb_poll &#x3D; rcu_nocbs&#x3D;allcpu<ul>
<li>To relieve each CPU from the responsibility of awakening their RCU offload threads, set the rcu_nocb_poll kernel parameter:</li>
<li>Setting rcu_nocb_poll to relieve each CPU from the responsibility awakening their RCU offload threads.</li>
</ul>
</li>
</ul>
</li>
<li>disable mce&#x3D;off (Machine Check Exception)</li>
<li>idle&#x3D;nomwait&#x2F;poll<ul>
<li>Poll forces a polling idle loop that can slightly improve the performance of waking up a idle CPU, but will use a lot of power and make the system run hot. Not recommended.</li>
<li>idle&#x3D;halt: Halt is forced to be used for CPU idle. In such case C2&#x2F;C3 wonât be used again.</li>
<li>idle&#x3D;nomwait: Disable mwait for CPU C-states</li>
</ul>
</li>
<li>intel_pstate&#x3D;disable</li>
<li>intel_idle.max_cstate<ul>
<li>0       disables intel_idle and fall back on acpi_idle.</li>
<li>1 to 9  specify maximum depth of C-state.</li>
</ul>
</li>
<li>processor.max_cstate &#x3D; 1<ul>
<li>Limit processor to maximum C-state</li>
<li>max_cstate&#x3D;9 overrides any DMI blacklist limit.</li>
</ul>
</li>
<li>tsc&#x3D;reliable<ul>
<li>[x86] reliable: mark tsc clocksource as reliable, this disables clocksource verification at runtime, as well as the stability checks done at bootup. Used to enable high-resolution timer mode on older hardware, and in virtualized environment.</li>
</ul>
</li>
<li>pcie_asmp&#x3D;off  <ul>
<li>Forcibly enable or disable PCIe Active State Power Management</li>
</ul>
</li>
<li>disable KSM<ul>
<li>echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;ksm&#x2F;merge_across_nodes</li>
<li>echo 0 &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;ksm&#x2F;run</li>
</ul>
</li>
<li>disable watchdog<ul>
<li>echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;watchdog</li>
<li>echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;nmi_watchdog</li>
</ul>
</li>
<li>disable timer migration<ul>
<li>echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;timer_migration</li>
</ul>
</li>
<li>set ksoftirq or rcuc process for isolcpus, here is isolcpus&#x3D;1-4<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    for ((i=4;i&lt;=7;i++)); do chrt -fp 2 $(pgrep -a ksoftirq | grep -E &quot;ksoftirqd/$&#123;i&#125;$&quot; | cut -f1 -d&#x27; &#x27;); done</span><br><span class="line">                                      |</span><br><span class="line">                                      ---the min value the higher priority</span><br><span class="line"></span><br><span class="line">Threads with a SCHED_FIFO policy will run ahead of SCHED_OTHER tasks. Instead of using nice values, SCHED_FIFO uses a fixed priority between 1 (lowest) and 99 (highest). A SCHED_FIFO thread with a priority of 1 will always be scheduled ahead of any SCHED_OTHER thread.</span><br></pre></td></tr></table></figure></li>
<li>echo -1 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sched_rt_period_us</li>
<li>echo -1 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;sched_rt_runtime_us</li>
<li>disable irqbalance service<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  i=5</span><br><span class="line">  <span class="keyword">for</span> irq <span class="keyword">in</span> /proc/irq/* ; </span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">     [[ <span class="variable">$i</span> -gt 9 ]] &amp;&amp; i=1</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$i</span> &gt; <span class="variable">$&#123;irq&#125;</span>/smp_affinity_list</span><br><span class="line">     ((i++)) </span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">KVM pin the isolcpus=1-4</span><br><span class="line">    &lt;cputune&gt;</span><br><span class="line">       &lt;vcpupin vcpu=<span class="string">&quot;0&quot;</span> cpuset=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">       &lt;vcpupin vcpu=<span class="string">&quot;1&quot;</span> cpuset=<span class="string">&quot;2&quot;</span>/&gt;</span><br><span class="line">       &lt;vcpupin vcpu=<span class="string">&quot;2&quot;</span> cpuset=<span class="string">&quot;3&quot;</span>/&gt;</span><br><span class="line">       &lt;vcpupin vcpu=<span class="string">&quot;3&quot;</span> cpuset=<span class="string">&quot;4&quot;</span>/&gt;</span><br><span class="line">    &lt;/cputune&gt;</span><br></pre></td></tr></table></figure></li>
<li>disable kvm tsc<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   &lt;clock offset=&#x27;utc&#x27;&gt;</span><br><span class="line">      &lt;timer name=&#x27;kvmclock&#x27; present=&#x27;no&#x27;/&gt;</span><br><span class="line">   &lt;/clock&gt;</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=&quot;default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=nomwait tsc=reliable pcie_asmp=off intel_pstate=disable&quot;</span><br><span class="line"></span><br><span class="line">echo 0 &gt; /sys/kernel/mm/ksm/merge_across_nodes</span><br><span class="line">echo 0 &gt; /sys/kernel/mm/ksm/run</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/watchdog</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/nmi_watchdog</span><br><span class="line">echo -1 &gt; /proc/sys/kernel/sched_rt_period_us</span><br><span class="line">echo -1 &gt; /proc/sys/kernel/sched_rt_runtime_us</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/timer_migration</span><br><span class="line"></span><br><span class="line">#benchmark real time</span><br><span class="line">$ cyclictest -m -n -p95 -h60 -i200 -D 10m</span><br><span class="line">http://ssdxiao.github.io/linux/2017/05/27/NFV-KVM-realtime.html</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="gcc-x86-options"><a href="#gcc-x86-options" class="headerlink" title="gcc_x86_options"></a><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html">gcc_x86_options</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">-march=cpu-type</span><br><span class="line">Generate instructions <span class="keyword">for</span> the machine <span class="built_in">type</span> cpu-type. </span><br><span class="line"></span><br><span class="line">-mtune=cpu-type ; only generic and intel</span><br><span class="line">Tune to cpu-type everything applicable about the generated code, except <span class="keyword">for</span> the ABI and the <span class="built_in">set</span> of available instructions. </span><br><span class="line"></span><br><span class="line">-mincoming-stack-boundary=num</span><br><span class="line">Assume the incoming stack is aligned to a 2 raised to num byte boundary. If -mincoming-stack-boundary is not specified, the one specified by -mpreferred-stack-boundary is used.</span><br><span class="line">-mmmx</span><br><span class="line">-msse</span><br><span class="line">-msse2</span><br><span class="line">-msse3</span><br><span class="line">-mssse3</span><br><span class="line">-msse4</span><br><span class="line">-msse4a</span><br><span class="line">-msse4.1</span><br><span class="line">-msse4.2</span><br><span class="line">-mavx</span><br><span class="line">-mavx2</span><br><span class="line">-mavx512f</span><br><span class="line">-mavx512pf</span><br><span class="line">-mavx512er</span><br><span class="line">-mavx512cd</span><br><span class="line">-mavx512vl</span><br><span class="line">-mavx512bw</span><br><span class="line">-mavx512dq</span><br><span class="line">-mavx512ifma</span><br><span class="line">-mavx512vbmi</span><br><span class="line">-mavx512vbmi2</span><br><span class="line">-mavx512bf16</span><br><span class="line">-mavx512vpopcntdq</span><br><span class="line">-mavx512vp2intersect</span><br><span class="line">-mavx5124fmaps</span><br><span class="line">-mavx512vnni</span><br><span class="line">-mavx5124vnniw</span><br><span class="line">-mcldemote</span><br><span class="line">.... <span class="comment">## too many</span></span><br><span class="line">-mprefer-vector-width=opt</span><br><span class="line">This option instructs GCC to use opt-bit vector width <span class="keyword">in</span> instructions instead of default on the selected platform.</span><br><span class="line">none/128/256/512</span><br><span class="line"></span><br><span class="line"><span class="comment">#test Makefile</span></span><br><span class="line">CFLAGS = -m64 -Wall -O3 -fopenmp</span><br><span class="line">CFLAGS = -m64 -g -Wall -fopenmp -lpthread -march=broadwell -mavx2 -mprefer-vector-width=256</span><br><span class="line">CFLAGS = -m64 -g -Wall -fopenmp -lpthread -march=skylake-avx512 -mprefer-vector-width=512 -mavx512pf</span><br><span class="line"></span><br><span class="line"><span class="comment">#show the CPU arch</span></span><br><span class="line">$ gcc -march=native -Q --<span class="built_in">help</span>=target</span><br><span class="line">$ gcc -march=native -Q --<span class="built_in">help</span>=target|grep march</span><br><span class="line">-march=                               broadwell</span><br></pre></td></tr></table></figure>

<h4 id="Disable-features-AVX"><a href="#Disable-features-AVX" class="headerlink" title="Disable features AVX"></a><a target="_blank" rel="noopener" href="https://www.ibm.com/support/pages/how-disable-cpu-feature-flag-hle-hardware-lock-elision-rhel-x86-intel">Disable features AVX</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">CentOS 8.5 </span><br><span class="line"></span><br><span class="line">linux-4.18.0-305.el8/arch/x86/include/asm/cpufeatures.h</span><br><span class="line"></span><br><span class="line"><span class="comment">#define X86_FEATURE_HLE                 ( 9*32+ 4) /* Hardware Lock Elision */ 292</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX                 ( 4*32+28) /* Advanced Vector Extensions */ 156</span></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX2                ( 9*32+ 5) /* AVX2 instructions */   293</span></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX512F             ( 9*32+16) /* AVX-512 Foundation */  304</span></span><br><span class="line"></span><br><span class="line">$ grep -io avx2 /proc/cpuinfo </span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;clearcpuid=293&#x27;</span></span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$ grep -io avx2 /proc/cpuinfo </span><br><span class="line"><span class="comment"># no output, grep failed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add another flag</span></span><br><span class="line">$ grep -io hle /proc/cpuinfo</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line"></span><br><span class="line"><span class="comment">## support from linux 5.10</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;clearcpuid=292,293,304&#x27;</span> </span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0a4bb5e5507a585532cc413125b921c8546fc39f</span></span><br><span class="line">x86/fpu: Allow multiple bits <span class="keyword">in</span> clearcpuid= parameter</span><br><span class="line">The Linux 5.10 support multile bits</span><br><span class="line">compare with the centos 8.5 <span class="built_in">source</span> code, it <span class="string">&#x27;s not support multiple bits</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/introduction-to-intel-advanced-vector-extensions">disable AVX again</a><br>To use the Intel AVX extensions reliably in most settings, the operating system must support saving and loading the new registers (with XSAVE&#x2F;XRSTOR) on thread context switches to prevent data corruption. To help avoid such errors, operating systems supporting Intel AVX-aware context switches explicitly set a CPU bit enabling the new instructions; otherwise, an undefined opcode (#UD) exception is generated when Intel AVX instructions are used.</p>
<p>Add kernel parameter to disable AVX </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">        noxsave         [BUGS=X86] Disables x86 extended register state save</span><br><span class="line">                        and restore using xsave. The kernel will fallback to</span><br><span class="line">                        enabling legacy floating-point and sse state.</span><br><span class="line"></span><br><span class="line">        noxsaveopt      [X86] Disables xsaveopt used <span class="keyword">in</span> saving x86 extended</span><br><span class="line">                        register states. The kernel will fall back to use</span><br><span class="line">                        xsave to save the states. By using this parameter,</span><br><span class="line">                        performance of saving the states is degraded because</span><br><span class="line">                        xsave doesn<span class="string">&#x27;t support modified optimization while</span></span><br><span class="line"><span class="string">                        xsaveopt supports it on xsaveopt enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        noxsaves        [X86] Disables xsaves and xrstors used in saving and</span></span><br><span class="line"><span class="string">                        restoring x86 extended register state in compacted</span></span><br><span class="line"><span class="string">                        form of xsave area. The kernel will fall back to use</span></span><br><span class="line"><span class="string">                        xsaveopt and xrstor to save and restore the states</span></span><br><span class="line"><span class="string">                        in standard form of xsave area. By using this</span></span><br><span class="line"><span class="string">                        parameter, xsave area per process might occupy more</span></span><br><span class="line"><span class="string">                        memory on xsaves enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cpuid | grep XSAVE -i | head</span></span><br><span class="line"><span class="string">Disclaimer: cpuid may not support decoding of all cpuid registers.</span></span><br><span class="line"><span class="string">      FXSAVE/FXRSTOR                         = true</span></span><br><span class="line"><span class="string">      XSAVE/XSTOR states                      = true</span></span><br><span class="line"><span class="string">      OS-enabled XSAVE/XSTOR                  = true</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/0):</span></span><br><span class="line"><span class="string">      bytes required by XSAVE/XRSTOR area     = 0x00000340 (832)</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/1):</span></span><br><span class="line"><span class="string">      XSAVEOPT instruction                        = true</span></span><br><span class="line"><span class="string">      XSAVEC instruction                          = false</span></span><br><span class="line"><span class="string">      XSAVES/XRSTORS instructions                 = false</span></span><br><span class="line"><span class="string">      64-byte alignment in compacted XSAVE     = false</span></span><br></pre></td></tr></table></figure>

<h4 id="Ban-half-core-try-to-not-running-HT"><a href="#Ban-half-core-try-to-not-running-HT" class="headerlink" title="Ban half core, try to not running HT"></a>Ban half core, try to not running HT</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ((i=<span class="number">0</span>;i&lt;$(grep -c processor /proc/cpuinfo);i++)); </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  <span class="built_in">cat</span> /sys/devices/system/cpu/cpu<span class="variable">$i</span>/cache/index2/shared_cpu_list; </span><br><span class="line"><span class="keyword">done</span> | awk -F, <span class="string">&#x27;&#123;a[$1]=$0&#125; END&#123;</span></span><br><span class="line"><span class="string">  count=0;</span></span><br><span class="line"><span class="string">  for (i in a) &#123;</span></span><br><span class="line"><span class="string">     if(count==0) &#123;</span></span><br><span class="line"><span class="string">       printf i</span></span><br><span class="line"><span class="string">     &#125; else &#123;</span></span><br><span class="line"><span class="string">       printf &quot;,&quot;i</span></span><br><span class="line"><span class="string">     &#125;;</span></span><br><span class="line"><span class="string">       count++</span></span><br><span class="line"><span class="string">  &#125; </span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">17,4,18,5,19,6,7,8,9,10,11,12,13,0,14,1,15,2,16,3</span><br></pre></td></tr></table></figure>

<h4 id="Turn-off-the-cpu-cores-under-linux"><a href="#Turn-off-the-cpu-cores-under-linux" class="headerlink" title="Turn off the cpu cores under linux"></a>Turn off the cpu cores under linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpu17/online</span><br></pre></td></tr></table></figure>

<h4 id="intel-cmt-cat"><a href="#intel-cmt-cat" class="headerlink" title="intel-cmt-cat"></a>intel-cmt-cat</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ yum install intel-cmt-cat.x86_64</span><br><span class="line"></span><br><span class="line">TIME 2020-01-07 17:54:05</span><br><span class="line">           LLC(Last Level Cache): CMT(Cache Monitoring Technology) Cache Occupancy</span><br><span class="line">           MBL:MBM local bandwidth</span><br><span class="line">           MBR:MBM Remote bandwidth</span><br><span class="line">$ pqos</span><br><span class="line">    CORE   IPC   MISSES     LLC[KB]   MBL[MB/s]   MBR[MB/s]</span><br><span class="line"></span><br><span class="line">       0  0.26       6k      1080.0         0.2         0.0</span><br><span class="line">       1  0.26       0k         0.0         0.0         0.0</span><br><span class="line">       2  0.27       4k      4600.0         0.5         0.0</span><br><span class="line">       3  0.26       5k       520.0         0.0         0.2</span><br><span class="line">       4  0.27       8k      1120.0         0.7         0.1</span><br><span class="line">       5  0.25      12k      1080.0         0.7         0.2</span><br><span class="line">       6  0.28      18k      1040.0         0.9         0.1</span><br><span class="line">       7  0.25       0k         0.0         0.0         0.0</span><br><span class="line">       8  0.27       4k      3400.0         0.2         0.1</span><br><span class="line">       9  0.25       0k      1360.0         0.1         0.1</span><br><span class="line">      10  0.26      14k      7000.0         1.3         0.0</span><br><span class="line">      11  0.39       1k       120.0         0.0         0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>L3 misses&#x2F;s (LUR, more L3 and lower misses in some case)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/intel/intel-cmt-cat/wiki/Usage-Examples">Usage-example</a></p>
<p>Cache Monitoring Technology (CMT)<br>Cache Allocation Technology (CAT)<br>Memory Bandwidth Monitoring (MBM)<br>Memory Bandwidth Allocation (MBA)<br>Code and Data Prioritization (CDP)</p>
<h4 id="Linux-process-with-CPU"><a href="#Linux-process-with-CPU" class="headerlink" title="Linux process with CPU"></a>Linux process with CPU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/stat</span><br><span class="line">    user <span class="built_in">nice</span> system idle  iowait irq softirq steal guest  guest_nice</span><br><span class="line">cpu  602  8    786  680812 901    0   13      29    0      0</span><br><span class="line"></span><br><span class="line"><span class="comment"># steal</span></span><br><span class="line">Stolen time, <span class="built_in">which</span> is the time spent <span class="keyword">in</span> other operating systems when running <span class="keyword">in</span> a virtualized environment</span><br><span class="line"></span><br><span class="line">$ getconf CLK_TCK</span><br><span class="line">100</span><br><span class="line"></span><br><span class="line">cpuTime = 1000ull * 1000ull * 1000ull * (usertime + systime) / (unsigned long long)sysconf(_SC_CLK_TCK);</span><br></pre></td></tr></table></figure>

<h4 id="numa"><a href="#numa" class="headerlink" title="numa"></a>numa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br></pre></td><td class="code"><pre><span class="line">$ numactl -H</span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 2 4 6 8 10 12 14 16 18 20 22</span><br><span class="line">node 0 size: 63795 MB</span><br><span class="line">node 0 free: 6517 MB</span><br><span class="line">node 1 cpus: 1 3 5 7 9 11 13 15 17 19 21 23</span><br><span class="line">node 1 size: 64506 MB</span><br><span class="line">node 1 free: 3673 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1 </span><br><span class="line">  0:  10  21 </span><br><span class="line">  1:  21  10 </span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/node/node*/distance</span><br><span class="line">10 21</span><br><span class="line">21 10</span><br><span class="line"></span><br><span class="line">$ dnf install -y acpica-tools</span><br><span class="line">$ acpidump &gt; acpidata</span><br><span class="line">$ acpixtract -sSLIT acpidata</span><br><span class="line">$ dmesg | grep <span class="string">&quot;acpi/hmat&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/node/&#123;possible,online,has_memory,has_normal_memory,has_cpu&#125;</span><br><span class="line">0-1</span><br><span class="line">0-1</span><br><span class="line">0-1</span><br><span class="line">0-1</span><br><span class="line">0-1</span><br><span class="line"><span class="comment"># in the AMD EPYC arch, some numa node not in the has_memory and has_normal_memory</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/fs/cgroup/cpuset/cpuset.&#123;mems,effective_mems&#125;</span><br><span class="line"></span><br><span class="line">https://stevescargall.com/blog/2022/11/03/linux-numa-distances-explained/</span><br><span class="line">SLIT distances are derived as follows:</span><br><span class="line">The <span class="built_in">local</span> node is 10.</span><br><span class="line">Nodes within a given partition are 11.</span><br><span class="line">Nodes <span class="keyword">in</span> other partitions within the same socket are 12.</span><br><span class="line">Nodes <span class="keyword">in</span> the other socket are 20 or 32</span><br><span class="line">Possible values are from 0-254, <span class="built_in">where</span> 254 is undefined/unknown.</span><br><span class="line"></span><br><span class="line">$ systemctl stop irqbalance</span><br><span class="line"><span class="comment">## Show  node for dev</span></span><br><span class="line">$ numactl -a -N netdev:em1 grep allowed /proc/self/status</span><br><span class="line">Cpus_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000055,55555555</span><br><span class="line">Cpus_allowed_list:      0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38</span><br><span class="line">Mems_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span><br><span class="line">Mems_allowed_list:      0-1</span><br><span class="line"></span><br><span class="line"><span class="comment">## bind to 0,2,4 cores</span></span><br><span class="line">$ numactl -a -N netdev:em1 -C 0,2,4 grep allowed /proc/self/status</span><br><span class="line">Cpus_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000015</span><br><span class="line">Cpus_allowed_list:      0,2,4</span><br><span class="line">Mems_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000003</span><br><span class="line">Mems_allowed_list:      0-1</span><br><span class="line"></span><br><span class="line">$ lspci  | grep Ethernet</span><br><span class="line">01:00.0 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme II BCM57800 1/10 Gigabit Ethernet (rev 10)</span><br><span class="line"> | |  |</span><br><span class="line"> | |  ---func</span><br><span class="line"> | ---slot</span><br><span class="line"> ---bus</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the pcie info</span></span><br><span class="line">$ lspci -vv -k -xxxx -b -D -nn -qq -Q -s 01:00.0</span><br><span class="line">$ lspci -vv -xxxx -s 01:00.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#show dev</span></span><br><span class="line">$ numactl --prefer netdev:em1 --show</span><br><span class="line"></span><br><span class="line"><span class="comment">#not work</span></span><br><span class="line">$ numactl --prefer pci:01:00 --show</span><br><span class="line">                        |  |</span><br><span class="line">                        |  ---slot</span><br><span class="line">                        ---bus</span><br><span class="line"></span><br><span class="line">$ numactl -m 6-7 -N 6-7 numactl --show</span><br><span class="line">$ numactl -m netdev:ens6f2 -N netdev:ens6f2 numactl --show</span><br><span class="line">$ numactl -m file:/data -N file:/data numactl --show</span><br><span class="line">$ numactl --interleave=4-7 -N 4-7 numactl --show</span><br><span class="line"></span><br><span class="line">numastat -c qemu-kvm</span><br><span class="line"></span><br><span class="line">Per-node process memory usage (<span class="keyword">in</span> MBs)</span><br><span class="line">PID              Node 0 Node 1 Total</span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line">4341 (qemu-kvm)     517   1112  1629</span><br><span class="line">4371 (qemu-kvm)     396   1184  1580</span><br><span class="line">4494 (qemu-kvm)    2094   4569  6663</span><br><span class="line">4608 (qemu-kvm)    1987   1852  3838</span><br><span class="line">10103 (qemu-kvm)    751   1119  1870</span><br><span class="line">1023677 (qemu-kv   1978   2232  4209</span><br><span class="line">2689460 (qemu-kv   2323   1751  4074</span><br><span class="line">2846540 (qemu-kv   1287   1516  2804</span><br><span class="line">3947371 (qemu-kv   3180   4519  7699</span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line">Total             14513  19853 34366</span><br><span class="line"><span class="comment">#The kvm should in the single numa node (aligned), here is unaligned.</span></span><br><span class="line">numa zone</span><br><span class="line">-----------------64 bit-----------------------</span><br><span class="line">                          |-----END of RAM</span><br><span class="line">node1 --------------------</span><br><span class="line">                          |-----Normal zone</span><br><span class="line">----------------------------------------------</span><br><span class="line">                          |---- Normal zone</span><br><span class="line">node0 ------------------------- 4GB DMA32 zone</span><br><span class="line">                          |---- 16M DMA zone</span><br><span class="line"></span><br><span class="line">Per Node / Zone <span class="built_in">split</span> LRU Paging Dynamics</span><br><span class="line"></span><br><span class="line">      ------------------User Alloccations------------------</span><br><span class="line">     |  -----reactivate----------                          |</span><br><span class="line">     |  |                       |                          |</span><br><span class="line">     V  V                       |                          |</span><br><span class="line">     ---------             ---------------                 |</span><br><span class="line">    | Active  |           | Inactive      |                |</span><br><span class="line">    |  anonLRU|-----------|-&gt;anonLRU      |                |</span><br><span class="line">    |  -------|page aging |---------------|--reclaming---&gt;FREE</span><br><span class="line">    |  fileLRU|--------- -|-&gt;fileLRU      |                ^</span><br><span class="line">    |         |           |               |                |</span><br><span class="line">     ---------             ---------------                 |</span><br><span class="line">        |           swapout |           |                  |</span><br><span class="line">        |            flush  |           |                  |</span><br><span class="line">        |                   V           V user deletions   |</span><br><span class="line">        ---------------------------------------------------</span><br><span class="line"><span class="comment">#write the it to systemd service config file</span></span><br><span class="line">[Service]</span><br><span class="line">...other lines...</span><br><span class="line">ExecStart=/bin/ctl -aN netdev:em1 -C 6 /path/to/ptpd</span><br><span class="line">...other lines...</span><br><span class="line"></span><br><span class="line">Instead of a number a node can also be:</span><br><span class="line">  netdev:DEV the node connected to network device DEV</span><br><span class="line">  file:PATH  the node the block device of path is connected to</span><br><span class="line">  ip:HOST    the node of the network device host routes through</span><br><span class="line">  block:PATH the node of block device path</span><br><span class="line">  pci:[seg:]bus:dev[:func] The node of a PCI device</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dell H330 IR</span></span><br><span class="line">$ lspci -ttv | grep <span class="string">&quot;MegaRAID SAS-3 3008&quot;</span> -B 1</span><br><span class="line"> \-[0000:00]-+-00.0  Intel Corporation Xeon E7 v4/Xeon E5 v4/Xeon E3 v4/Xeon D DMI2</span><br><span class="line">             +-01.0-[02]----00.0  LSI Logic / Symbios Logic MegaRAID SAS-3 3008 [Fury]</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -l /sys/class/block</span><br><span class="line">sda -&gt; ../../devices/pci0000:00/0000:00:01.0/0000:02:00.0/host0/target0:0:0/0:0:0:0/block/sda</span><br><span class="line"></span><br><span class="line">CPU ID</span><br><span class="line">Zero-based CPU ID       0       1       2       3       4       5       6       7       8       9       10      11      12</span><br><span class="line">Decimal Value           1       2       4       8       16      32      64      128     256     512     1024    2048    4096</span><br><span class="line">Hexadecimal Value       1       2       4       8       10      20      40      80      100     200     400     800     1000</span><br><span class="line"></span><br><span class="line">Zero-based CPU ID       13      14      15      16      17      18      19      20      21      22      23</span><br><span class="line">Decimal Value           8192    16384   32768   65536   131072  262144  524288  1048576 2097152 4194304 8388608</span><br><span class="line">Hexadecimal Value       2000    4000    8000    10000   20000   40000   80000   100000  200000  400000  800000</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;%x %x\n&#x27;</span> 1024 4096</span><br><span class="line">400 1000</span><br><span class="line"></span><br><span class="line">$</span><br><span class="line"></span><br><span class="line">$ awk -F <span class="string">&#x27;[ :]+&#x27;</span> <span class="string">&#x27;$0!~/CPU/ &amp;&amp; $0~/em1/&#123;print $2&#125;&#x27;</span> /proc/interrupts</span><br><span class="line">88</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 400 &gt; /proc/irq/88/smp_affinitya</span><br><span class="line">...</span><br><span class="line">$ <span class="built_in">echo</span> 1000 &gt; /proc/irq/97/smp_affinity</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">seq</span> 63 88 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span><br><span class="line">/proc/irq/63/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class="line">/proc/irq/64/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000004</span><br><span class="line">/proc/irq/65/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000010</span><br><span class="line">/proc/irq/66/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000040</span><br><span class="line">/proc/irq/67/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000100</span><br><span class="line">/proc/irq/68/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000400</span><br><span class="line">/proc/irq/69/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00001000</span><br><span class="line">/proc/irq/70/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00004000</span><br><span class="line">/proc/irq/71/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00010000</span><br><span class="line">/proc/irq/72/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00aaaaaa</span><br><span class="line">/proc/irq/73/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00aaaaaa</span><br><span class="line">/proc/irq/74/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00040000</span><br><span class="line">/proc/irq/75/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00100000</span><br><span class="line">/proc/irq/76/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00400000</span><br><span class="line">/proc/irq/77/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000002</span><br><span class="line">/proc/irq/78/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000008</span><br><span class="line">/proc/irq/79/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000020</span><br><span class="line">/proc/irq/80/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000080</span><br><span class="line">/proc/irq/81/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000200</span><br><span class="line">/proc/irq/82/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000800</span><br><span class="line">/proc/irq/83/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00002000</span><br><span class="line">/proc/irq/84/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00008000</span><br><span class="line">/proc/irq/85/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00020000</span><br><span class="line">/proc/irq/86/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00080000</span><br><span class="line">/proc/irq/87/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00200000</span><br><span class="line">/proc/irq/88/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00800000</span><br><span class="line"></span><br><span class="line">$ tuna --irqs=72 --show_irqs</span><br><span class="line">   <span class="comment"># users            affinity</span></span><br><span class="line">  72 dmar0            0xaaaaaa</span><br><span class="line">0xaaaaaa = 101010101010101010101010  == 1 all cores</span><br><span class="line">                                          -----------------------------cpu23</span><br><span class="line">                                          |                     -------cpu1</span><br><span class="line">$ tuna --irqs=88 --show_irqs              |                     |------cpu0</span><br><span class="line">   <span class="comment"># users            affinity            |                     ||</span></span><br><span class="line">  88 mpt3sas0-msix23        23  (0x800000=100000000000000000000000)</span><br><span class="line">$ tuna --irqs=77 --show_irqs</span><br><span class="line">   <span class="comment"># users            affinity</span></span><br><span class="line">  77 mpt3sas0-msix12         1  (0x00000002=10), cpu1 not cpu0</span><br><span class="line"></span><br><span class="line">$ lspci | grep 3008</span><br><span class="line">82:00.0 Serial Attached SCSI controller: Broadcom / LSI SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/pci0000:80/0000:80:03.0/0000:82:00.0/_node</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ lspcu</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19,21,23</span><br><span class="line"></span><br><span class="line">$ tuna --irqs=mpt3sas1\* --cpus=0,1 --move</span><br><span class="line">$ <span class="built_in">echo</span> 0xff &gt; /proc/irq/125/smp_affinity</span><br><span class="line">-bash: <span class="built_in">echo</span>: write error: Input/output error</span><br><span class="line"><span class="comment">### mpt3sas could not be modified that why tuna not work</span></span><br><span class="line"></span><br><span class="line">$ grep em3 /proc/interrupts</span><br><span class="line">114 116 117 118 119 120 121 122 123</span><br><span class="line">$ <span class="built_in">seq</span> 114 123 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span><br><span class="line">/proc/irq/114/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000040</span><br><span class="line">grep: /proc/irq/115/smp_affinity: No such file or directory</span><br><span class="line">/proc/irq/116/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000400</span><br><span class="line">/proc/irq/117/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00001000</span><br><span class="line">/proc/irq/118/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00040000</span><br><span class="line">/proc/irq/119/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00100000</span><br><span class="line">/proc/irq/120/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00400000</span><br><span class="line">/proc/irq/121/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class="line">/proc/irq/122/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000004</span><br><span class="line">/proc/irq/123/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,00000010</span><br><span class="line"></span><br><span class="line">$ tuna --irqs=114 --show_irqs                                                   -----------cpu6, seventh cpu core, 0,1,2,3,4,5,6</span><br><span class="line">   <span class="comment"># users            affinity                                                  |</span></span><br><span class="line"> 114 em3                     6  bnx2x  6 not means 110,,,,, it <span class="string">&#x27;s means cpu6   0x40 = 1000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=em3\* --show_irqs</span></span><br><span class="line"><span class="string">   # users            affinity</span></span><br><span class="line"><span class="string"> 114 em3                     6  bnx2x      --------------cpu12</span></span><br><span class="line"><span class="string"> 116 em3-fp-0               10  bnx2x      |</span></span><br><span class="line"><span class="string"> 117 em3-fp-1               12  bnx2x  eg: 1000000000000 = 0x1000</span></span><br><span class="line"><span class="string"> 118 em3-fp-2               18  bnx2x</span></span><br><span class="line"><span class="string"> 119 em3-fp-3               20  bnx2x</span></span><br><span class="line"><span class="string"> 120 em3-fp-4               22  bnx2x</span></span><br><span class="line"><span class="string"> 121 em3-fp-5                0  bnx2x</span></span><br><span class="line"><span class="string"> 122 em3-fp-6                2  bnx2x</span></span><br><span class="line"><span class="string"> 123 em3-fp-7                4  bnx2x</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/class/net/em3/device/_node</span></span><br><span class="line"><span class="string">0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18,20,22</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --irqs=em3\* --cpus=0,1,2,3,4,5,6,7 --move ## it &#x27;</span>s 0xff and it <span class="string">&#x27;s worked</span></span><br><span class="line"><span class="string">$ seq 114 123 | xargs -I% grep -H . /proc/irq/%/smp_affinity</span></span><br><span class="line"><span class="string">/proc/irq/114/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/116/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/117/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/118/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/119/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/120/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/121/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/122/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string">/proc/irq/123/smp_affinity:000000,00000000,00000000,00000000,00000000,00000000,000000ff</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ tuna --threads=watchdog\* \</span></span><br><span class="line"><span class="string">        --show_threads \</span></span><br><span class="line"><span class="string">        --cpus=0 \</span></span><br><span class="line"><span class="string">        --move \</span></span><br><span class="line"><span class="string">        --show_threads \</span></span><br><span class="line"><span class="string">        --cpus=1 \</span></span><br><span class="line"><span class="string">        --move \</span></span><br><span class="line"><span class="string">        --show_threads \</span></span><br><span class="line"><span class="string">        --cpus=+0 \</span></span><br><span class="line"><span class="string">        --move \</span></span><br><span class="line"><span class="string">        --show_threads</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## show pid  stats</span></span><br><span class="line"><span class="string">$ perl -maps-summary.pl &lt; /proc/1/numa_maps</span></span><br><span class="line"><span class="string">N0        :          676 (  0.00 GB)</span></span><br><span class="line"><span class="string">N1        :          230 (  0.00 GB)</span></span><br><span class="line"><span class="string">active    :          385 (  0.00 GB)</span></span><br><span class="line"><span class="string">anon      :          443 (  0.00 GB)</span></span><br><span class="line"><span class="string">dirty     :          443 (  0.00 GB)</span></span><br><span class="line"><span class="string">kernelpagesize_kB:          268 (  0.00 GB)</span></span><br><span class="line"><span class="string">mapmax    :          146 (  0.00 GB)</span></span><br><span class="line"><span class="string">mapped    :          463 (  0.00 GB)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stat -mczs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Per-node system memory usage (in MBs):</span></span><br><span class="line"><span class="string">                 Node 0 Node 1  Total</span></span><br><span class="line"><span class="string">                 ------ ------ ------</span></span><br><span class="line"><span class="string">MemTotal          64230  64448 128678</span></span><br><span class="line"><span class="string">MemUsed           45328  34761  80089</span></span><br><span class="line"><span class="string">FilePages         42949  32954  75903</span></span><br><span class="line"><span class="string">Inactive          42669  31659  74328</span></span><br><span class="line"><span class="string">Inactive(file)    42668  29360  72028</span></span><br><span class="line"><span class="string">MemFree           18901  29687  48589</span></span><br><span class="line"><span class="string">Shmem                 1   3530   3531</span></span><br><span class="line"><span class="string">Inactive(anon)        2   2298   2300</span></span><br><span class="line"><span class="string">Slab                872   1168   2041</span></span><br><span class="line"><span class="string">SReclaimable        669   1027   1695</span></span><br><span class="line"><span class="string">Active              285   1332   1617</span></span><br><span class="line"><span class="string">Active(anon)          5   1272   1277</span></span><br><span class="line"><span class="string">SUnreclaim          204    142    345</span></span><br><span class="line"><span class="string">Active(file)        280     60    341</span></span><br><span class="line"><span class="string">AnonPages             5     37     42</span></span><br><span class="line"><span class="string">Mapped                6     20     26</span></span><br><span class="line"><span class="string">KernelStack           5      5     10</span></span><br><span class="line"><span class="string">AnonHugePages         0     10     10</span></span><br><span class="line"><span class="string">PageTables            2      3      5</span></span><br><span class="line"><span class="string">Dirty                 0      0      0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://gist.github.com/sitano/c2269ed158e15ab97829</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ numastat -nc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Per-node numastat info (in MBs):</span></span><br><span class="line"><span class="string">                 Node 0  Node 1    Total</span></span><br><span class="line"><span class="string">                ------- ------- --------</span></span><br><span class="line"><span class="string">Numa_Hit        6966101 4861306 11827407</span></span><br><span class="line"><span class="string">Numa_Miss         47509    2039    49548</span></span><br><span class="line"><span class="string">Numa_Foreign       2039   47509    49548</span></span><br><span class="line"><span class="string">Interleave_Hit      142     142      284</span></span><br><span class="line"><span class="string">Local_Node      6966031 4861115 11827145</span></span><br><span class="line"><span class="string">Other_Node        47579    2231    49810</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">numastat -mc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Per-node system memory usage (in MBs):</span></span><br><span class="line"><span class="string">                 Node 0 Node 1  Total</span></span><br><span class="line"><span class="string">                 ------ ------ ------</span></span><br><span class="line"><span class="string">MemTotal          64214  64464 128678</span></span><br><span class="line"><span class="string">MemFree            3895  25196  29091</span></span><br><span class="line"><span class="string">MemUsed           60319  39267  99586</span></span><br><span class="line"><span class="string">Active            37061  36103  73163</span></span><br><span class="line"><span class="string">Inactive          20956    779  21735</span></span><br><span class="line"><span class="string">Active(anon)         23     24     47</span></span><br><span class="line"><span class="string">Inactive(anon)       26     25     51</span></span><br><span class="line"><span class="string">Active(file)      37038  36079  73117</span></span><br><span class="line"><span class="string">Inactive(file)    20931    754  21685</span></span><br><span class="line"><span class="string">Unevictable           0      0      0</span></span><br><span class="line"><span class="string">Mlocked               0      0      0</span></span><br><span class="line"><span class="string">Dirty                 0      0      0</span></span><br><span class="line"><span class="string">Writeback             0      0      0</span></span><br><span class="line"><span class="string">FilePages         57994  36858  94852</span></span><br><span class="line"><span class="string">Mapped               23      6     29</span></span><br><span class="line"><span class="string">AnonPages            23     24     47</span></span><br><span class="line"><span class="string">Shmem                25     25     50</span></span><br><span class="line"><span class="string">KernelStack           5      4      9</span></span><br><span class="line"><span class="string">PageTables            1      2      4</span></span><br><span class="line"><span class="string">NFS_Unstable          0      0      0</span></span><br><span class="line"><span class="string">Bounce                0      0      0</span></span><br><span class="line"><span class="string">WritebackTmp          0      0      0</span></span><br><span class="line"><span class="string">Slab               1073   1122   2195</span></span><br><span class="line"><span class="string">SReclaimable        895   1003   1898</span></span><br><span class="line"><span class="string">SUnreclaim          178    119    297</span></span><br><span class="line"><span class="string">AnonHugePages         2      6      8</span></span><br><span class="line"><span class="string">HugePages_Total       0      0      0</span></span><br><span class="line"><span class="string">HugePages_Free        0      0      0</span></span><br><span class="line"><span class="string">HugePages_Surp        0      0      0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ perf stat -e sched:sched_stick_numa,sched:sched_move_numa,sched:sched_swap_numa,migrate:mm_migrate_pages,minor-faults -p $PID</span></span><br></pre></td></tr></table></figure>

<p>Get hardware status from numactl<br>$ lspci -tvv<br> -[0000:00]-+-00.0  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D DMI2<br>             +-01.0-[01-02]â-00.0  LSI Logic &#x2F; Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3<br>             +-02.0-[03-04]â+-00.0  Intel Corporation Ethernet Controller X710 for 10GbE SFP+<br>             |               -00.1  Intel Corporation Ethernet Controller X710 for 10GbE SFP+<br>             +-02.2-[05-06]â+-00.0  Intel Corporation Ethernet Controller 10-Gigabit X540-AT2<br>             |               -00.1  Intel Corporation Ethernet Controller 10-Gigabit X540-AT2<br>             +-03.0-[07]â<br>             +-03.2-[08]â-00.0  Intel Corporation I210 Gigabit Network Connection<br>             +-04.0  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 0<br>             +-04.1  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 1<br>             +-04.2  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 2<br>             +-04.3  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 3<br>             +-04.4  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 4<br>             +-04.5  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 5<br>             +-04.6  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 6<br>             +-04.7  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 7<br>             +-05.0  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Map&#x2F;VTd_Misc&#x2F;System Management<br>             +-05.1  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D IIO Hot Plug<br>             +-05.2  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D IIO RAS&#x2F;Control Status&#x2F;Global Errors<br>             +-05.4  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D I&#x2F;O APIC<br>             +-11.0  Intel Corporation C610&#x2F;X99 series chipset SPSR<br>             +-11.3  Intel Corporation C610&#x2F;X99 series chipset MS SMBus 2<br>             +-11.4  Intel Corporation C610&#x2F;X99 series chipset sSATA Controller [AHCI mode]<br>             +-14.0  Intel Corporation C610&#x2F;X99 series chipset USB xHCI Host Controller<br>             +-16.0  Intel Corporation C610&#x2F;X99 series chipset MEI Controller #1<br>             +-16.1  Intel Corporation C610&#x2F;X99 series chipset MEI Controller #2<br>             +-1a.0  Intel Corporation C610&#x2F;X99 series chipset USB Enhanced Host Controller #2<br>             +-1c.0-[09]â<br>             +-1c.2-[0a-0b]â-00.0-[0b]â-00.0  ASPEED Technology, Inc. ASPEED Graphics Family<br>             +-1d.0  Intel Corporation C610&#x2F;X99 series chipset USB Enhanced Host Controller #1<br>             +-1f.0  Intel Corporation C610&#x2F;X99 series chipset LPC Controller<br>             +-1f.2  Intel Corporation C610&#x2F;X99 series chipset 6-Port SATA Controller [AHCI mode]<br>             +-1f.3  Intel Corporation C610&#x2F;X99 series chipset SMBus Controller<br>             -1f.6  Intel Corporation C610&#x2F;X99 series chipset Thermal Subsystem</p>
<p>$ numactl âprefer pci:0000:00:01.0 âshow<br>policy: preferred<br>preferred node: 0<br>physcpubind: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19<br>cpubind: 0 1<br>nodebind: 0 1<br>membind: 0 1</p>
<p>$ numactl âprefer pci:0000:00:02.0-04 âshow<br>policy: preferred<br>preferred node: 0<br>physcpubind: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19<br>cpubind: 0 1<br>nodebind: 0 1<br>membind: 0 1</p>
<p>$ dmesg -T | grep numa -i<br>[Mon Aug  6 19:40:25 2018] No NUMA configuration found<br>[Mon Aug  6 19:41:05 2018] pci_bus 0000:00: on NUMA node 0</p>
<p>#If ACPI is disabled, that will also disable NUMA; verify that ACPI is not disabled by a grub.conf kernel parameter and remove it if found be careful you have not disable ACPI in BIOS, if you don ât know how to do, please reset the BIOS to default setting.</p>
<p>$ numactl âhardware<br>available: 4 nodes (0-3)<br>node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74<br>node 0 size: 786305 MB<br>node 0 free: 768918 MB<br>node 1 cpus: 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89<br>node 1 size: 786432 MB<br>node 1 free: 768579 MB<br>node 2 cpus: 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104<br>node 2 size: 786432 MB<br>node 2 free: 769063 MB<br>node 3 cpus: 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119<br>node 3 size: 786432 MB<br>node 3 free: 766922 MB<br>node distances:<br>node   0   1   2   3<br>  0:  10  21  21  21<br>  1:  21  10  21  21<br>  2:  21  21  10  21<br>  3:  21  21  21  10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Interleave mode   </span><br><span class="line">```bash</span><br><span class="line">vm.zone_reclaim_mode = 0 ## default,could use remote numa memroy</span><br><span class="line">numactl --interleave=all ./your_script</span><br></pre></td></tr></table></figure>

<p>disable numa in grub   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;numa=off&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Get the numa info from the Linux proc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `pidof qemu-kvm`; <span class="keyword">do</span> <span class="built_in">cat</span> /proc/<span class="variable">$i</span>/status | grep -E <span class="string">&#x27;Cpus_allowed_list|Mems_allowed_list&#x27;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>numad service   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf install numad</span><br><span class="line">systemctl <span class="built_in">enable</span> numad</span><br><span class="line">systemctl start numad</span><br></pre></td></tr></table></figure>
<h4 id="How-many-temperature-is-high-for-intel-CPU"><a href="#How-many-temperature-is-high-for-intel-CPU" class="headerlink" title="How many temperature is high for intel CPU ?"></a>How many temperature is high for intel CPU ?</h4><p>In intel 2nd Gen Scalable Xeon refresh version just 14nm+++, so it cause high temperature, eg: 6248R</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">     air---------------------------T(ambient) ----</span><br><span class="line">                                                 |</span><br><span class="line">| | | | | | | | |                               sa------</span><br><span class="line">| |cooling fin| |                                |     |</span><br><span class="line">| | | | |-------------------------T(sink)--------      |</span><br><span class="line">| | | | | | | | |                               cs     ca</span><br><span class="line">^^^^^^^^^-------------------------T(<span class="keyword">case</span>)--------      |</span><br><span class="line">|    =======    |                               jc-----</span><br><span class="line">|   |||CPU------------------------T(junction)----</span><br><span class="line">==================</span><br><span class="line">|===baseboard===|</span><br><span class="line">=================</span><br></pre></td></tr></table></figure>

<p>In some vendor mark the max DST temperature in the SPEC.<br>The BMC has no DST temperature sensor output. the CPU1 DTS is unspec.    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sdr <span class="built_in">type</span> Temperature</span><br><span class="line">CPU1 OverTemp    | 85h | ok  |  3.1 | Transition to OK</span><br><span class="line">CPU1 Temp        | 84h | ok  |  3.1 | 72 degrees C</span><br><span class="line">CPU1 DTS         | 50h | ok  |  3.1 | -22.80 unspecif</span><br><span class="line">CPU2 OverTemp    | 87h | ok  |  3.2 | Transition to OK</span><br><span class="line">CPU2 Temp        | 86h | ok  |  3.2 | 72 degrees C</span><br><span class="line">CPU2 DTS         | 51h | ok  |  3.2 | -22.80 unspecif</span><br><span class="line">DIMM 1 Temp      | 30h | ok  | 32.1 | 29 degrees C</span><br><span class="line">DIMM 2 Temp      | 31h | ns  | 32.2 | No Reading</span><br><span class="line">PCH OverTemp     | 8Bh | ok  | 45.1 | Transition to OK</span><br><span class="line">PCH Temp         | 2Fh | ok  | 45.1 | 43 degrees C</span><br><span class="line">Ambient Temp     | 80h | ok  | 39.1 | 22 degrees C</span><br><span class="line">PCI 1 OverTemp   | 48h | ok  | 11.1 | Transition to OK</span><br><span class="line">PCI 2 OverTemp   | 49h | ok  | 11.2 | Transition to OK</span><br><span class="line">Exhaust Temp     | 83h | ok  | 30.2 | 38 degrees C</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>In my benchmark, I got the result, I can ât got DTS temperature from BMC sensor, but I could use the DTS value to measure.<br>The 6248R(the hottest room) and 6248(hot room),6240R(cool room) in the different server room</p>
<p>And in many manufacturer BMC manager (IDRAC&#x2F;TSM), In the BMC interface show the CPU maximum temperature is same with the DST max temperature.  </p>
<p><a target="_blank" rel="noopener" href="https://cdrdv2.intel.com/v1/dl/getContent/616776">Got the DST max</a></p>
<table>
<thead>
<tr>
<th>CPU(all Â°C)</th>
<th>Tcase</th>
<th>DST max</th>
<th>throttling temp dmesg</th>
<th>performance idle</th>
<th>powersave idle</th>
<th>Full loading</th>
<th>rack and fan</th>
</tr>
</thead>
<tbody><tr>
<td>Xeon 64248R</td>
<td>75</td>
<td>95</td>
<td>96</td>
<td>73</td>
<td>55</td>
<td>84(after silicone)</td>
<td>20k rpm,SR630</td>
</tr>
<tr>
<td>Xeon 64248</td>
<td>86</td>
<td>100</td>
<td>100</td>
<td>60</td>
<td>49</td>
<td>87</td>
<td>unknow,SR630</td>
</tr>
<tr>
<td>Xeon 6240R</td>
<td>90</td>
<td>104</td>
<td>104</td>
<td>35</td>
<td>41</td>
<td>82</td>
<td>16k,PowerEdge C6420</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPU1 Temp        | 84h | ok  |  3.1 | 72 degrees C</span><br></pre></td></tr></table></figure>
<p>if the DST max temperature &gt; 84h CPU1 Temp(72 degress C) that means the temperature little high for 2nd gen scalable CPU, but the CPU could work well except the Fan or some circuit not suitable for high temperature env<br>if the Tcase temperature &gt; 84h CPU1 Temp(72 degress C) that means it âs the cool air temperature for this CPU    </p>
<p>The Fan location<br>In this example, C6h is the sensor code. c6h is XCC sensor number for âFan 7A Tachâ     </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CPU 1 Overtemp   | C4h | ok  |  3.1 | Transition to OK</span><br><span class="line">CPU 1 Temp       | C6h | ok  |  3.1 | 43 degrees C</span><br><span class="line">CPU 1 DTS        | CAh | ok  |  3.1 | -51 unspecified</span><br><span class="line">CPU 2 Overtemp   | C5h | ok  |  3.2 | Transition to OK</span><br><span class="line">CPU 2 Temp       | C7h | ok  |  3.2 | 40 degrees C</span><br><span class="line">CPU 2 DTS        | CBh | ok  |  3.2 | -51 unspecified</span><br><span class="line">PCIe 1 Temp      | 41h | ok  | 11.1 | Transition to OK</span><br><span class="line">PCIe 3 Temp      | 43h | ok  | 11.3 | Transition to OK</span><br><span class="line">PCIe 5 Temp      | 45h | ok  | 11.5 | Transition to OK</span><br><span class="line">PCIe 6 Temp      | 46h | ok  | 11.6 | Transition to OK</span><br><span class="line">Drive Overtemp   | BFh | ok  | 37.4 |</span><br><span class="line">M2 Temp          | BEh | ns  | 11.7 | No Reading</span><br><span class="line">PCH Overtemp     | BDh | ok  | 45.1 | Transition to OK</span><br><span class="line">Ambient Temp     | B0h | ok  | 39.1 | 22 degrees C</span><br><span class="line">Exhaust Temp     | E3h | ok  | 13.1 | 38 degrees C</span><br></pre></td></tr></table></figure>
<p><a href="/img/server_c6h_location.png"></a>     </p>
<h4 id="tool-for-CPU-machine-specific-registers"><a href="#tool-for-CPU-machine-specific-registers" class="headerlink" title="tool for CPU machine specific registers"></a>tool for CPU machine specific registers</h4><ul>
<li>wrmsr - tool for writing CPU machine specific registers (MSR)</li>
<li>rdmsr - tool for reading CPU machine specific registers (MSR)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># only turning of that one</span></span><br><span class="line">$ rdmsr -a 0x1a4</span><br><span class="line">0</span><br><span class="line">...</span><br><span class="line"><span class="comment">## the line number = CPU thread numbers</span></span><br><span class="line"></span><br><span class="line">$ wrmsr -a 0x1a4 <span class="string">&quot;<span class="subst">$((2#1111)</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  only turning of that one</span></span><br><span class="line">$ wrmsr -a 0x1a4 <span class="string">&quot;<span class="subst">$((2#0001)</span>)&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="irqbalance"><a href="#irqbalance" class="headerlink" title="irqbalance"></a>irqbalance</h4><p>&#x2F;etc&#x2F;sysconfig&#x2F;irqbalance  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exclude CPUs 8 to 15 by uncommenting the variable IRQBALANCE_BANNED_CPUS and setting its value this wayj</span></span><br><span class="line">IRQBALANCE_BANNED_CPUS=0000ff00</span><br></pre></td></tr></table></figure>

<h3 id="CVE-Performance-overrides"><a href="#CVE-Performance-overrides" class="headerlink" title="CVE Performance overrides"></a>CVE Performance overrides</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">## disable CVE patch for performance</span><br><span class="line">$ grubby --update-kernel=ALL --args=&#x27;spectre_v2=off spec_store_bypass_disable=off nopti l1tf=off&#x27;</span><br><span class="line"></span><br><span class="line">$ grep . /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line"></span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/itlb_multihit:KVM: Mitigation: Split huge pages</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/mds:Mitigation: Clear CPU buffers; SMT vulnerable</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/spectre_v2:Mitigation: Full generic retpoline, IBPB: conditional, IBRS_FW, STIBP: conditional, RSB filling</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/srbds:Mitigation: Microcode</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/tsx_async_abort:Mitigation: Clear CPU buffers; SMT vulnerable</span><br></pre></td></tr></table></figure>

<h4 id="OpenMP-env-var"><a href="#OpenMP-env-var" class="headerlink" title="OpenMP env var"></a>OpenMP env var</h4><p>The OMP_NUM_THREADS environment variable specifies the number of threads to use for parallel region OMP_NUM_THREADS   </p>
<h5 id="turbostat"><a href="#turbostat" class="headerlink" title="turbostat"></a>turbostat</h5><ul>
<li>Avg_MHz</li>
<li>Bzy_MHz<ul>
<li>idle CPU frequency</li>
</ul>
</li>
<li>PkgWatt<ul>
<li>The whole CPU power</li>
</ul>
</li>
<li>RAMwatt<ul>
<li>All mem power</li>
</ul>
</li>
<li>CoreTmp</li>
<li>PkgTtmp<ul>
<li>The vluae of the whole CPU package thermal monitor<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#only cpupower performance enabel idle mode</span></span><br><span class="line">Package	Node	Core	CPU	Avg_MHz	Busy%	Bzy_MHz	TSC_MHz	IRQ	POLL	C1	C2	POLL%	C1%	C2%</span><br><span class="line">-	-	-	-	1709	56.16	3043	2274	1275769	530	453872	59572	0.01	25.52	18.82</span><br><span class="line">0	0	0	0	1206	39.76	3033	2298	30372	0	4352	2756	0.00	10.23	51.45</span><br><span class="line">0	0	1	1	1389	45.92	3026	2298	14244	0	987	1003	0.00	13.68	41.62</span><br><span class="line">0	0	2	2	2945	96.95	3038	2298	51880	0	5802	0	0.00	3.11	0.00</span><br><span class="line">0	0	3	3	2957	97.45	3034	2295	51291	0	5891	0	0.00	2.60	0.00</span><br><span class="line">0	1	4	4	3035	100.00	3035	2295	6455	0	0	0	0.00	0.00	0.00</span><br><span class="line">0	1	5	5	1283	42.32	3031	2295	4741	0	1226	176	0.00	53.39	5.44</span><br><span class="line">0	1	6	6	2979	98.21	3033	2294	6830	0	0	4	0.00	0.00	1.82</span><br><span class="line">0	1	7	7	1	0.03	2517	2294	48	0	7	21	0.00	0.11	101.84</span><br><span class="line">0	2	8	8	1407	46.45	3028	2295	13949	1	3587	1323	0.00	27.49	27.18</span><br><span class="line">0	2	9	9	757	24.94	3034	2295	3748	1	2852	1188	0.01	38.93	37.66</span><br><span class="line">0	2	10	10	1105	36.38	3038	2295	5326	1	3126	1085	0.00	42.30	22.62</span><br><span class="line">0	2	11	11	3034	100.00	3034	2294	5288	0	0	0	0.00	0.00	0.00</span><br><span class="line">0	3	12	12	1062	34.91	3041	2294	12899	0	2685	506	0.00	39.18	27.21</span><br><span class="line">0	3	13	13	786	25.91	3035	2294	1959	0	2452	457	0.00	61.62	13.93</span><br><span class="line">0	3	14	14	1927	63.65	3028	2294	5951	0	1130	292	0.00	28.73	8.34</span><br><span class="line"></span><br><span class="line"><span class="comment">#09 modified 64x cores, disable all idle mode</span></span><br><span class="line">Package	Node	Core	CPU	Avg_MHz	Busy%	Bzy_MHz	TSC_MHz	IRQ	POLL	C1	C2	POLL%	C1%	C2%</span><br><span class="line">-	-	-	-	2989	100.00	2989	2220	23362	18823	0	0	52.96	0.00	0.00</span><br><span class="line">0	0	0	0	3439	100.00	3439	2569	192	193	0	0	113.98	0.00	0.00</span><br><span class="line">0	0	1	1	3448	100.00	3448	2575	48	221	0	0	98.38	0.00	0.00</span><br><span class="line">0	0	2	2	3437	100.00	3437	2567	194	0	0	0	0.00	0.00	0.00</span><br><span class="line">0	0	3	3	3437	100.00	3437	2567	12	193	0	0	113.95	0.00	0.00</span><br><span class="line">0	1	4	4	3438	100.00	3438	2567	195	0	0	0	0.00	0.00	0.00</span><br><span class="line">0	1	5	5	3438	100.00	3438	2567	41	307	0	0	106.68	0.00	0.00</span><br><span class="line">0	1	6	6	3227	100.00	3227	2412	138	128	0	0	39.37	0.00	0.00</span><br><span class="line">0	1	7	7	3226	100.00	3226	2411	115	297	0	0	63.04	0.00	0.00</span><br><span class="line">0	2	8	8	3226	100.00	3226	2410	18	181	0	0	106.63	0.00	0.00</span><br><span class="line">0	2	9	9	3225	100.00	3225	2410	109	165	0	0	72.88	0.00	0.00</span><br><span class="line">0	2	10	10	3225	100.00	3225	2410	41	178	0	0	94.32	0.00	0.00</span><br><span class="line">0	2	11	11	3223	100.00	3223	2408	194	0	0	0	0.00	0.00	0.00</span><br><span class="line">0	3	12	12	3223	100.00	3223	2408	14	181	0	0	106.81	0.00	0.00</span><br><span class="line">0	3	13	13	3223	100.00	3223	2407	41	225	0	0	91.29	0.00	0.00</span><br><span class="line">0	3	14	14	3201	100.00	3201	2391	107	161	0	0	68.96	0.00	0.00</span><br><span class="line"></span><br><span class="line"><span class="comment">#17 not modify, 32 x cores</span></span><br><span class="line">Package	Core	CPU	Avg_MHz	Busy%	Bzy_MHz	TSC_MHz	IRQ	POLL	C1	C2	POLL%	C1%	C2%</span><br><span class="line">-	-	-	2627	85.39	3077	2586	982174	392	207129	126878	0.00	7.11	7.53</span><br><span class="line">0	0	0	2392	74.17	3225	2576	22028	20	9143	3116	0.01	14.81	10.96</span><br><span class="line">0	1	1	3144	97.45	3226	2576	14377	0	883	300	0.00	1.61	0.93</span><br><span class="line">0	2	2	3220	99.79	3227	2576	9441	1	158	18	0.00	0.08	0.12</span><br><span class="line">0	3	3	2554	79.18	3226	2576	14788	7	5351	2330	0.00	11.44	9.31</span><br><span class="line">0	4	4	2512	77.85	3226	2575	39844	30	8978	3828	0.03	12.40	9.71</span><br><span class="line">0	5	5	2005	62.13	3228	2579	23243	32	11603	4302	0.02	22.07	15.72</span><br><span class="line">0	6	6	3080	95.36	3230	2579	10747	12	2356	573	0.00	2.84	1.79</span><br><span class="line">0	7	7	3228	99.94	3230	2579	10661	0	131	9	0.00	0.04	0.01</span><br><span class="line">0	8	8	3107	96.19	3230	2579	10586	2	457	457	0.00	1.39	2.42</span><br><span class="line">0	9	9	2475	76.72	3226	2578	19266	8	4610	3060	0.01	10.42	12.82</span><br><span class="line">0	10	10	3127	96.85	3229	2578	12585	4	1101	400	0.00	1.65	1.49</span><br><span class="line">0	11	11	2933	90.84	3229	2578	21124	2	1147	1156	0.00	3.46	5.69</span><br><span class="line">0	12	12	2857	88.50	3228	2578	18636	11	2626	1686	0.00	5.35	6.14</span><br><span class="line">0	13	13	2471	76.56	3227	2578	18559	5	3913	3137	0.00	9.43	13.96</span><br><span class="line">0	14	14	3027	93.81	3227	2578	15178	2	958	984	0.00	2.40	3.78</span><br><span class="line">0	15	15	2508	77.98	3216	2578	22712	13	6192	2857	0.01	11.64	10.34</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="powertop"><a href="#powertop" class="headerlink" title="powertop"></a>powertop</h4><h4 id="powercap"><a href="#powercap" class="headerlink" title="powercap"></a>powercap</h4><h4 id="process-counter-monitor-PCM"><a href="#process-counter-monitor-PCM" class="headerlink" title="process counter monitor (PCM)"></a>process counter monitor (PCM)</h4><h4 id="numatop"><a href="#numatop" class="headerlink" title="numatop"></a>numatop</h4><ul>
<li><p>RMA(K): number of Remote Memory Accesses (unit is 1000).</p>
<ul>
<li>RMA(K) &#x3D; RMA &#x2F; 1000;</li>
</ul>
</li>
<li><p>LMA(K): number of Local Memory Accesses (unit is 1000).</p>
<ul>
<li>LMA(K) &#x3D; LMA &#x2F; 1000;</li>
</ul>
</li>
<li><p>IR: Instruction Retired.</p>
</li>
<li><p>CYCLE: CPU cycles.</p>
</li>
<li><p>RMA&#x2F;LMA: ratio of RMA&#x2F;LMA.</p>
</li>
<li><p>CPI: CPU cycle per instruction.</p>
</li>
<li><p>CPU%: CPU utilization.</p>
</li>
<li><p>RPI(K): RMA normalized by 1000 instructions.</p>
<ul>
<li>RPI(K) &#x3D; RMA &#x2F; (IR &#x2F; 1000);</li>
</ul>
</li>
<li><p>LPI(K): LMA normalized by 1000 instructions.</p>
<ul>
<li>LPI(K) &#x3D; LMA &#x2F; (IR &#x2F; 1000);</li>
</ul>
</li>
<li><p>ACCESS%: percentage of memory accesses are to this node.</p>
</li>
<li><p>LAT(ns): the average latency (nanoseconds) of memory accesses to this node.</p>
</li>
<li><p>CPU: array of logical CPUs which belong to this node</p>
</li>
<li><p>CPU%: per-node CPU utilization</p>
</li>
<li><p>MEM active: the amount of memory that has been used more recently and<br>is not usually reclaimed unless absolute necessary</p>
</li>
<li><p>MEM inactive: the amount of memory that has not been used for a while<br>and is eligible to be swapped to disk</p>
</li>
<li><p>Dirty: the amount of memory waiting to be written back to the disk</p>
</li>
<li><p>Writeback: the amount of memory actively being written back to the disk</p>
</li>
<li><p>Mapped: all pages mapped into a process</p>
</li>
</ul>
<h4 id="Linux-CPU-parameters"><a href="#Linux-CPU-parameters" class="headerlink" title="Linux CPU parameters"></a>Linux CPU parameters</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vfio-pci.ids=[...] amd_iommu=on iommu=pt iommu=1 acpi_enforce_resources=lax isolcpus=7-15 rcu_nocbs=7-15 nohz_full=7-15 rcu_nocb_poll irqaffinity=0,1,2,3,4,5,6 spl_taskq_thread_bind=1 nohibernate zfs_force=1 systemd.unified_cgroup_hierarchy=0 loglevel=4   </span><br></pre></td></tr></table></figure>
<ul>
<li><p>rcu_nocbs&#x3D;      [KNL]</p>
<ul>
<li>RCU is a synchronization mechanism that was added to the Linux kernel during the 2.5 development effort that is optimized for read-mostly situations.</li>
<li>The argument is a cpu list, as described above.</li>
<li>In kernels built with CONFIG_RCU_NOCB_CPU&#x3D;y, set the specified list of CPUs to be no-callback CPUs.</li>
<li>Invocation of these CPUsâ RCU callbacks will be offloaded to ârcuox&#x2F;Nâ kthreads created for that purpose, where âxâ is âbâ for RCU-bh, âpâ for RCU-preempt, and âsâ for RCU-sched, and âNâ is the CPU number.  This reduces OS jitter on the offloaded CPUs, which can be useful for HPC and real-time workloads.  It can also improve energy efficiency for asymmetric multiprocessors.</li>
</ul>
</li>
<li><p>nohz_full&#x3D;      [KNL,BOOT]</p>
<ul>
<li>The argument is a cpu list, as described above. In kernels built with CONFIG_NO_HZ_FULL&#x3D;y, set the specified list of CPUs whose tick will be stopped whenever possible. </li>
<li>The boot CPU will be forced outside the range to maintain the timekeeping.  Any CPUs in this list will have their RCU callbacks offloaded, just as if they had also been called out in thercu_nocbs&#x3D; boot parameter.</li>
</ul>
</li>
<li><p>rcu_nocb_poll   [KNL]</p>
<ul>
<li>Rather than requiring that offloaded CPUs (specified by rcu_nocbs&#x3D; above) explicitly awaken the corresponding ârcuoNâ kthreads, make these kthreads poll for callbacks.</li>
<li>This improves the real-time response for the offloaded CPUs by relieving them of the need to wake up the corresponding kthread, but degrades energy efficiency by requiring that the kthreads periodically wake up to do the polling.</li>
</ul>
</li>
<li><p>irqaffinity [SMP] </p>
<ul>
<li>Set the default irq affinity mask The argument is a cpu list, as described above.</li>
</ul>
</li>
<li><p>nohibernate     </p>
<ul>
<li>[HIBERNATION] Disable hibernation and resume.</li>
</ul>
</li>
<li><p>loglevel</p>
<ul>
<li>All Kernel Messages with a loglevel smaller than the console loglevel will be printed to the console. It can also be changed with klogd or other programs. The loglevels are defined as follows:</li>
<li>0 (KERN_EMERG)          system is unusable</li>
<li>1 (KERN_ALERT)          action must be taken immediately</li>
<li>2 (KERN_CRIT)           critical conditions</li>
<li>3 (KERN_ERR)            error conditions</li>
<li>4 (KERN_WARNING)        warning conditions</li>
<li>5 (KERN_NOTICE)         normal but significant condition</li>
<li>6 (KERN_INFO)           informational</li>
<li>7 (KERN_DEBUG)          debug-level messages</li>
</ul>
</li>
<li><p>Enable cgroup v1</p>
<ul>
<li>Cgroup v2 is now enabled by default. If you want to switch to cgroup v1 instead, you need to set the following<ul>
<li>systemd.unified_cgroup_hierarchy&#x3D;0</li>
</ul>
</li>
</ul>
</li>
<li><p>amd_iommu</p>
<ul>
<li>Pass parameters to the AMD IOMMU driver in the system. Possible values are:<br>-fullflush - Deprecated, equivalent to iommu.strict&#x3D;1<br>-off          - do not initialize any AMD IOMMU found in the system<br>force_isolation - Force device isolation for all devices. The IOMMU driver is not allowed anymore to lift isolation requirements as needed. This option does not override iommu&#x3D;pt<br>force_enable - Force enable the IOMMU on platforms known to be buggy with IOMMU enabled. Use this option with care.</li>
</ul>
</li>
<li><p>iommu</p>
<ul>
<li>off</li>
<li>force</li>
<li>noforce</li>
<li>biomerge</li>
<li>panic</li>
<li>nopanic</li>
<li>merge</li>
<li>nomerge</li>
<li>forcesac</li>
<li>soft</li>
<li>pt              [x86, IA-64]</li>
<li>nobypass        [PPC&#x2F;POWERNV]<ul>
<li>Disable IOMMU bypass, using IOMMU for PCI devices.</li>
</ul>
</li>
</ul>
</li>
<li><p>acpi_enforce_resources&#x3D; [ACPI]</p>
<ul>
<li>{ strict | lax | no }</li>
<li>Check for resource conflicts between native drivers and ACPI OperationRegions (SystemIO and SystemMemory only). IO ports and memory declared in ACPI might be used by the ACPI subsystem in arbitrary AML code and can interfere with legacy drivers.<ul>
<li>strict (default): access to resources claimed by ACPI is denied; legacy drivers trying to access reserved resources will fail to bind to device using them.</li>
<li>lax: access to resources claimed by ACPI is allowed; legacy drivers trying to access reserved resources will bind successfully but a warning message is logged.</li>
<li>no: ACPI OperationRegions are not marked as reserved, no further checks are performed.</li>
</ul>
</li>
</ul>
</li>
<li><p>isolcpus&#x3D;[KNL,SMP] </p>
<ul>
<li>Isolate CPUs from the general process scheduler. The argument is a cpu list, as described above.<ul>
<li>This option can be used to specify one or more CPUs to isolate from the general SMP balancing and scheduling algorithms. You can move a process onto or off an âisolatedâ CPU via the CPU affinity syscalls or cpuset. <cpu number> begins at 0 and the maximum value is ânumber of CPUs in system - 1â.</li>
<li>This option is the preferred way to isolate CPUs. The alternative â manually setting the CPU mask of all tasks in the system â can cause problems and suboptimal load balancer performance.</li>
<li>NOTE: kernel threads are not able to be disabled and will always be visible on all cores. In ps -eLf output, these show up in brackets, like [ksoftirqd&#x2F;0]</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="handle-overflow-in-jiffies"><a href="#handle-overflow-in-jiffies" class="headerlink" title="handle overflow in jiffies"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8206762/how-does-linux-handle-overflow-in-jiffies">handle overflow in jiffies</a></h3><p>1ms &#x3D; millisecond<br>1us &#x3D; microsecond !&#x3D;ms, microsecond &#x3D; us<br>1ns &#x3D; billisecond &#x3D; nanosecond<br>1ps &#x3D; picosecond</p>
<p>&#x2F;usr&#x2F;src&#x2F;kernels&#x2F;$(uname -r)&#x2F;include&#x2F;linux&#x2F;jiffies.h</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">These inlines deal with timer wrapping correctly. You are</span><br><span class="line">strongly encouraged to use them</span><br><span class="line">1. Because people otherwise forget</span><br><span class="line">2. Because <span class="keyword">if</span> the timer wrap changes <span class="keyword">in</span> future you won<span class="string">&#x27;t have to</span></span><br><span class="line"><span class="string">   alter your driver code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">time_after(a,b) returns true if the time a is after time b.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>time_before(jiffies, timeout)<br>#define time_before(jiffies, timeout) ((long)(jiffies) - (long)(timeout) &lt; 0)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (time_before(jiffies, <span class="built_in">timeout</span>)</span><br><span class="line">&#123;</span><br><span class="line">    /* we did not time out, good ... */</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    /* we timed out, error ...*</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,time_before(jiffies,<span class="built_in">timeout</span>));</span><br></pre></td></tr></table></figure>


<p>&#x2F;usr&#x2F;src&#x2F;kernels&#x2F;3.10.0-862.11.6.el7.x86_64&#x2F;include&#x2F;generated&#x2F;autoconf.h</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define CONFIG_HZ 1000</span></span><br></pre></td></tr></table></figure>

<p>&#x2F;usr&#x2F;src&#x2F;kernels&#x2F;$(uname -r)&#x2F;include&#x2F;asm-generic&#x2F;param.h<br>1GHz&#x3D;1000,000,000 Hz<br>1 second&#x2F;1000000000<br>awk âBEGIN{printf â%.9f\nâ,1&#x2F;1000000000}â<br>0.000000001 (1ns&#x2F;Hz system precision)</p>
<p>Linux kenrel CONFIG_HZ &#x3D; 1000</p>
<p>Tick &#x3D; 1sec &#x2F; CONFIG_HZ&#x3D; 1ms<br>average 1ms with once interrput, 1000 time interrupt in single second</p>
<p>The timer tick is a timer interrupt that is usually generated HZ times per second<br>jiffies means the unit of time</p>
<p>the kernel use some macros prevent an overflow, eg: time_before</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#incldue <span class="string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> i,j,k</span><br><span class="line">j = jiffies;</span><br><span class="line">i = j + HZ;</span><br><span class="line">k = j + HZ*<span class="number">1000</span>;</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ASM_GENERIC_PARAM_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/asm-generic/param.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">undef</span> HZ</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> HZ             CONFIG_HZ       <span class="comment">/* Internal kernel timer frequency */</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> USER_HZ        100             <span class="comment">/* some user interfaces are */</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CLOCKS_PER_SEC (USER_HZ)       <span class="comment">/* in &quot;ticks&quot; like times() */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __ASM_GENERIC_PARAM_H */</span></span></span><br></pre></td></tr></table></figure>

<h4 id="Data-Cache-Unit-on-chip-memory-system"><a href="#Data-Cache-Unit-on-chip-memory-system" class="headerlink" title="Data Cache Unit (on-chip memory system)"></a><a target="_blank" rel="noopener" href="https://www.doc.ic.ac.uk/~axgopala/papers/usparc/paper/node6.html">Data Cache Unit (on-chip memory system)</a></h4><ul>
<li>This unit comprises of the on-chip caches, <ul>
<li>namely the level-one (L1) cache. <ul>
<li>There are three first-level on-chip data caches: data - 64-Kbyte, four-way associative, </li>
<li>32-byte line; </li>
<li>prefetch - 2-Kbyte, four-way associative, 64-byte line; </li>
<li>and write - 2-Kbyte, four-way associative, 64-byte line</li>
</ul>
</li>
</ul>
</li>
<li>BIOS <ul>
<li>DCU Mode<ul>
<li>MSR 31h Bit[0]<ul>
<li>16KB 4-way with ECC</li>
<li>32KB 8WAY Without ECC</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.spec.org/cpu2017/flags/KTNF-Platform-Flags-Version-KM-H620-10B1-SA2.html">BIOS setting reference</a></li>
</ul>
</li>
</ul>
<h3 id="EPYC-suggestion"><a href="#EPYC-suggestion" class="headerlink" title="EPYC suggestion"></a><a target="_blank" rel="noopener" href="https://documentation.suse.com/sbp/all/html/SBP-AMD-EPYC-3-SLES15SP2/index.html">EPYC suggestion</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pin CPU</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a command bound to CPU 1</span></span><br><span class="line">$ taskset -c 1 [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a command bound to CPUs belonging to node 0</span></span><br><span class="line">$ taskset -c `<span class="built_in">cat</span> /sys/devices/system/node/node0/cpulist` [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a command bound to CPUs belonging to nodes 0 and 1</span></span><br><span class="line">$ numactl âcpunodebind=0,1 [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a command bound to CPUs that share L3 cache with cpu 1</span></span><br><span class="line">$ taskset -c `<span class="built_in">cat</span> /sys/devices/system/cpu/cpu1/cache/index3/shared_cpu_list` [<span class="built_in">command</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>numa_hit is incremented when an allocation uses the preferred node where preferred may be either a local node or one specified by a memory policy.</p>
</li>
<li><p>numa_miss is incremented when an alternative node is used to satisfy an allocation.</p>
</li>
<li><p>numa_foreign is rarely useful but is accounted against a node that was preferred. It is a subtle distinction from numa_miss that is rarely useful.</p>
</li>
<li><p>numa_interleave is incremented when an interleave policy was used to select allowed nodes in a round-robin fashion.</p>
</li>
<li><p>numa_local increments when a local node is used for an allocation regardless of policy.</p>
</li>
<li><p>numa_other is used when a remote node is used for an allocation regardless of policy.</p>
<ul>
<li>For the local memory policy, the numa_hit and numa_miss counters are the most important to pay attention to. An application that is allocating memory that starts incrementing the numa_miss implies that the first level of saturation has been reached</li>
</ul>
</li>
<li><p>This can be observed by monitoring the pgscan_kswapd and pgsteal_kswapd &#x2F;proc&#x2F;vmstat counters. If this is matched with an increase in major faults or minor faults then it may be indicative of severe thrashing. In this case the interleave policy should be considered. An ideal tuning option is to identify if shared memory is the source of the usage</p>
<ul>
<li>pgscan_kswapd</li>
<li>pgsteal_kswapd<ul>
<li>If this is matched with an increase in major faults or minor faults then it may be indicative of severe thrashing. In this case the interleave policy should be considered.</li>
</ul>
</li>
<li>pgscan_direct</li>
<li>pgsteal_direct<ul>
<li>More severe saturation is observed if the pgscan_direct and pgsteal_direct counters are also increasing as these indicate that the application is stalling while memory is being reclaimed. If the application was bound to individual nodes, increasing the number of available nodes will alleviate the pressure. If the application is unbound, it indicates that the WSS of the workload exceeds all available memory. It can only be alleviated by tuning the application to use less memory or increasing the amount of RAM available.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#normal epyc2</span></span><br><span class="line">pgscan_kswapd_normal 2876895945</span><br><span class="line">pgsteal_kswapd_normal 2483004881</span><br><span class="line">pgscan_direct_normal 5977891181</span><br><span class="line">pgsteal_direct_normal 5086446213</span><br><span class="line"></span><br><span class="line"><span class="comment">#issue epyc2</span></span><br><span class="line">pgsteal_kswapd_normal 13723699203</span><br><span class="line">pgscan_kswapd_normal 16182344567</span><br><span class="line">pgsteal_direct_normal 13111787129</span><br><span class="line">pgscan_direct_normal 16156188768</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>vm.zone_reclaim_mode&#x3D;1</p>
<ul>
<li>While this option is good from a locality perspective, it can incur high costs because of stalls related to reclaim and the possibility that data from the task will be reclaimed. Treat this option with a high degree of caution and testing</li>
<li>The ability to use local memory where possible and remote memory if necessary is valuable. But there are cases where it is imperative that local memory always be used<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define RECLAIM_OFF 0</span></span><br><span class="line"><span class="comment">#define RECLAIM_ZONE (1&lt;&lt;0) /* Run shrink_inactive_list on the zone */</span></span><br><span class="line"><span class="comment">#define RECLAIM_WRITE (1&lt;&lt;1)    /* Writeout pages during reclaim */</span></span><br><span class="line"><span class="comment">#define RECLAIM_SWAP (1&lt;&lt;2) /* Swap pages out during reclaim */</span></span><br><span class="line"></span><br><span class="line">åæ ¸å¨å½åzoneåæ²¡æè¶³å¤åå­å¯ç¨çæåµä¸ï¼ä¼æ ¹æ®zone_reclaim_modeçè®¾ç½®æ¥å³ç­æ¯ä»ä¸ä¸ä¸ªzoneæ¾ç©ºé²åå­è¿æ¯å¨zoneåé¨è¿è¡åæ¶ãè¿ä¸ªå¼ä¸º0æ¶è¡¨ç¤ºå¯ä»¥ä»ä¸ä¸ä¸ªzoneæ¾å¯ç¨åå­ï¼é0è¡¨ç¤ºå¨æ¬å°åæ¶</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>turbostat</p>
<ul>
<li>processor.max_cstate&#x3D;2</li>
<li>cpupower  frequency-set -g performance</li>
<li>cpupower idle-set -e 3&#x2F;2&#x2F;1&#x2F;0</li>
</ul>
</li>
<li><p>kernel parameters</p>
<ul>
<li>mitigations&#x3D;off<ul>
<li>Disable all optional CPU mitigations.  This improves system performance, but it may also expose users to several CPU vulnerabilities</li>
</ul>
</li>
</ul>
</li>
<li><p>Compiler selection</p>
<ul>
<li>The OS packages are built against a generic target but where applications and benchmarks can be rebuilt from source, the minimum option should be -march&#x3D;znver2 for GCC 10 or -march&#x3D;znver3 for GCC 11 and later versions of GCC.</li>
<li>stream<ul>
<li>-Ofast -march&#x3D;znver2 -mcmodel&#x3D;medium -DOFFSET&#x3D;512</li>
<li>-fopemp</li>
<li>OMP_PROC_BIND&#x3D;SPREAD</li>
<li>OMP_NUM_THREADS&#x3D;32</li>
<li>trace-cmd record -e sched:sched_migrate_task .&#x2F;stream</li>
<li>trace-cmd report</li>
</ul>
</li>
<li>NASA PARALLEL BENCHMARK<ul>
<li>gcc 10.2.1</li>
<li>openmpi2-2.1.6-10.19.x86_64</li>
<li>-m64 -O3 -mcmodel&#x3D;large</li>
<li>Selective number processes: bt&#x3D;256 sp&#x3D;256 mg&#x3D;32 lu&#x3D;121 ep&#x3D;256 cg&#x3D;32</li>
<li>Fortran compiler flags: -fallow-argument-mismatch -fallow-invalid-boz</li>
<li>Tuned compiler flags: -Ofast -march&#x3D;znver2 -mtune&#x3D;znver2 -ftree-vectorize</li>
<li>CPU governor performance: cpupower frequency-set -g performance</li>
<li>Scheduler parameters<ul>
<li>sysctl -w kernel.sched_migration_cost_ns&#x3D;5000000</li>
<li>sysctl -w kernel.sched_min_granularity_ns&#x3D;10000000</li>
<li>kernel.sched_nr_migrate<ul>
<li>Increasing the sched_nr_migrate variable gives high performance from SCHED_OTHER threads that spawn lots of tasks, at the expense of real-time latencies. For low real-time task latency at the expense of SCHED_OTHER task performance, the value must be lowered. The default value is 8</li>
</ul>
</li>
</ul>
</li>
<li>mpirun parameters: -mca btl ^openib,udapl -np 64 âbind-to l3cache:overload-allowed</li>
</ul>
</li>
<li>VM<ul>
<li>For virtualization workloads, rather than using Transparent Huge Pages (THP) on the host, it is recommended that 1 GB huge pages are used for the memory of the VMs</li>
<li>echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</li>
<li>default_hugepagesz&#x3D;1GB hugepagesz&#x3D;1GB hugepages&#x3D;<number of hugepages><ul>
<li>The value <number of hugepages> can be computed by taking the amount of memory we want to devoted to VMs, and dividing it by the page size (1 GB). For example on our host with 256 GB of RAM, creating 200 Huge Pages means we can accommodate up to 210 GB of VMsâ RAM, and leave plenty (~50GB) to the host OS.</li>
</ul>
</li>
<li>Secure Encrypted Virtualization (SEV) <ul>
<li>mem_encrypt&#x3D;on kvm_amd.sev&#x3D;1</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>240<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;132&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;133&#x27;</span>/&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">iommu</span> <span class="attr">model</span>=<span class="string">&#x27;intel&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">driver</span> <span class="attr">intremap</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">iommu</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="More-performance-degrade-when-AMD-EPYC2-under-the-powersave-mode-intel-is-OK"><a href="#More-performance-degrade-when-AMD-EPYC2-under-the-powersave-mode-intel-is-OK" class="headerlink" title="More performance degrade when AMD EPYC2 under the powersave mode, intel is OK"></a>More performance degrade when AMD EPYC2 under the powersave mode, intel is OK</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">$ taskset -c 10 ./un-test</span><br><span class="line">setup time: 12035 ms</span><br><span class="line">mmap() time: 12035 ms</span><br><span class="line">memset() time: 12035 ms</span><br><span class="line">mmap() time: 12035 ms</span><br><span class="line">memset() time: 12035 ms</span><br><span class="line">mmap() time: 12035 ms</span><br><span class="line">memset() time: 12035 ms</span><br><span class="line">mmap() time: 12035 ms</span><br><span class="line">memset() time: 12035 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable idle 0 and idle 1</span></span><br><span class="line">setup time: 6172 ms</span><br><span class="line">mmap() time: 6172 ms</span><br><span class="line">memset() time: 6172 ms</span><br><span class="line">mmap() time: 6172 ms</span><br><span class="line">memset() time: 6172 ms</span><br><span class="line">mmap() time: 6172 ms</span><br><span class="line">memset() time: 6172 ms</span><br><span class="line">mmap() time: 6172 ms</span><br><span class="line">memset() time: 6172 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/mman.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;strings.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;sys/time.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;time.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define NUM_BLOCKS ( 4096 * 1024 )</span></span><br><span class="line"><span class="comment">#define BLOCKSIZE ( 4 * 1024 )</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main( int argc, char **argv )</span><br><span class="line">&#123;</span><br><span class="line">    int ii;</span><br><span class="line"></span><br><span class="line">    char *blocks[ NUM_BLOCKS ];</span><br><span class="line"></span><br><span class="line">    struct timespec ts1, ts2;</span><br><span class="line">    long long elapsed_ns;</span><br><span class="line"></span><br><span class="line">    clock_gettime (CLOCK_MONOTONIC, &amp;ts1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ii = 0; ii &lt; NUM_BLOCKS; ii++ )</span><br><span class="line">    &#123;</span><br><span class="line">        blocks[ ii ] = mmap( NULL, BLOCKSIZE,</span><br><span class="line">            PROT_READ | PROT_WRITE,</span><br><span class="line">            MAP_ANONYMOUS | MAP_PRIVATE, -1, 0 );</span><br><span class="line">        // force the creation of the mapping</span><br><span class="line">        blocks[ ii ][ ii % BLOCKSIZE ] = ii;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clock_gettime (CLOCK_MONOTONIC, &amp;ts2);</span><br><span class="line">    elapsed_ns = (ts2.tv_sec - ts1.tv_sec) * 1000000000 + ts2.tv_nsec - ts1.tv_nsec;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;setup time: %lld ms\n&quot;</span>, elapsed_ns/1000000);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( int jj = 0; jj &lt; 4; jj++ )</span><br><span class="line">    &#123;</span><br><span class="line">        clock_gettime (CLOCK_MONOTONIC, &amp;ts1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( ii = 0; ii &lt; NUM_BLOCKS; ii++ )</span><br><span class="line">        &#123;</span><br><span class="line">            blocks[ ii ] = mmap( blocks[ ii ],</span><br><span class="line">                BLOCKSIZE, PROT_READ | PROT_WRITE,</span><br><span class="line">                MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE, -1, 0 );</span><br><span class="line">            blocks[ ii ][ ii % BLOCKSIZE ] = 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        clock_gettime (CLOCK_MONOTONIC, &amp;ts2);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;mmap() time: %lld ms\n&quot;</span>, elapsed_ns/1000000);</span><br><span class="line"></span><br><span class="line">        clock_gettime (CLOCK_MONOTONIC, &amp;ts1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( ii = 0; ii &lt; NUM_BLOCKS; ii++ )</span><br><span class="line">        &#123;</span><br><span class="line">            memset( blocks[ ii ], 0, BLOCKSIZE );</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">        clock_gettime (CLOCK_MONOTONIC, &amp;ts2);</span><br><span class="line">        <span class="built_in">printf</span> (<span class="string">&quot;memset() time: %lld ms\n&quot;</span>, elapsed_ns/1000000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span>( 0 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ gcc -std=gnu99  test.c -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-cpu-topo"><span class="toc-number">1.</span> <span class="toc-text">Show cpu topo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redhat-server-Certification"><span class="toc-number"></span> <span class="toc-text">Redhat server Certification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#x86-CPU"><span class="toc-number"></span> <span class="toc-text">x86 CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support"><span class="toc-number">1.</span> <span class="toc-text">RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Monitor"><span class="toc-number">2.</span> <span class="toc-text">Monitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-NUMA-and-NPS"><span class="toc-number">3.</span> <span class="toc-text">AMD NUMA and NPS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Intel-Cascade-Lake-CPU-suffix"><span class="toc-number">4.</span> <span class="toc-text">Intel Cascade Lake CPU suffix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cpu-features"><span class="toc-number">5.</span> <span class="toc-text">intel cpu features</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith"><span class="toc-number">6.</span> <span class="toc-text">Why some of the 8,16 x cores EPYC2 limit the memory bandwith</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cluster-mode"><span class="toc-number">7.</span> <span class="toc-text">CPU cluster mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cache-speed"><span class="toc-number">8.</span> <span class="toc-text">CPU cache speed</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline-Width"><span class="toc-number">8.1.</span> <span class="toc-text">Pipeline Width</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Caculate-the-Tflops"><span class="toc-number">8.2.</span> <span class="toc-text">Caculate the Tflops</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-medium-speed"><span class="toc-number">8.3.</span> <span class="toc-text">CPU medium speed</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number"></span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pin-CPU"><span class="toc-number">1.</span> <span class="toc-text">pin CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#modify-grub-boot-order"><span class="toc-number">2.</span> <span class="toc-text">modify grub boot order</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cache-consistenta"><span class="toc-number">3.</span> <span class="toc-text">Cache consistenta</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-SMT-255-cores"><span class="toc-number">4.</span> <span class="toc-text">AMD SMT, 255 cores</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-STAT"><span class="toc-number">5.</span> <span class="toc-text">CPU STAT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#kernel-parameters"><span class="toc-number">5.1.</span> <span class="toc-text">kernel parameters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-IDLE"><span class="toc-number">5.2.</span> <span class="toc-text">CPU IDLE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><span class="toc-number">6.</span> <span class="toc-text">Application multiple threads get down to single core cause performance issue in intel skylake platform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#E3-v6-Turbo-not-support-under-the-CentOS6"><span class="toc-number">7.</span> <span class="toc-text">E3 v6 Turbo not support under the CentOS6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isolated-CPUs-example"><span class="toc-number">8.</span> <span class="toc-text">Isolated CPUs example</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#use-the-isolated-core"><span class="toc-number">8.1.</span> <span class="toc-text">use the isolated core</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-x86-options"><span class="toc-number">9.</span> <span class="toc-text">gcc_x86_options</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Disable-features-AVX"><span class="toc-number">10.</span> <span class="toc-text">Disable features AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ban-half-core-try-to-not-running-HT"><span class="toc-number">11.</span> <span class="toc-text">Ban half core, try to not running HT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Turn-off-the-cpu-cores-under-linux"><span class="toc-number">12.</span> <span class="toc-text">Turn off the cpu cores under linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cmt-cat"><span class="toc-number">13.</span> <span class="toc-text">intel-cmt-cat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-process-with-CPU"><span class="toc-number">14.</span> <span class="toc-text">Linux process with CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numa"><span class="toc-number">15.</span> <span class="toc-text">numa</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#How-many-temperature-is-high-for-intel-CPU"><span class="toc-number">16.</span> <span class="toc-text">How many temperature is high for intel CPU ?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tool-for-CPU-machine-specific-registers"><span class="toc-number">17.</span> <span class="toc-text">tool for CPU machine specific registers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#irqbalance"><span class="toc-number">18.</span> <span class="toc-text">irqbalance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-Performance-overrides"><span class="toc-number"></span> <span class="toc-text">CVE Performance overrides</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenMP-env-var"><span class="toc-number">1.</span> <span class="toc-text">OpenMP env var</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#turbostat"><span class="toc-number">1.1.</span> <span class="toc-text">turbostat</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powertop"><span class="toc-number">2.</span> <span class="toc-text">powertop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powercap"><span class="toc-number">3.</span> <span class="toc-text">powercap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#process-counter-monitor-PCM"><span class="toc-number">4.</span> <span class="toc-text">process counter monitor (PCM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numatop"><span class="toc-number">5.</span> <span class="toc-text">numatop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-CPU-parameters"><span class="toc-number">6.</span> <span class="toc-text">Linux CPU parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handle-overflow-in-jiffies"><span class="toc-number"></span> <span class="toc-text">handle overflow in jiffies</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Data-Cache-Unit-on-chip-memory-system"><span class="toc-number">1.</span> <span class="toc-text">Data Cache Unit (on-chip memory system)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EPYC-suggestion"><span class="toc-number"></span> <span class="toc-text">EPYC suggestion</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#More-performance-degrade-when-AMD-EPYC2-under-the-powersave-mode-intel-is-OK"><span class="toc-number">1.</span> <span class="toc-text">More performance degrade when AMD EPYC2 under the powersave mode, intel is OK</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/cpu/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/cpu/&text=CPU"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/cpu/&is_video=false&description=CPU"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CPU&body=Check out this article: http://example.com/2022/11/13/cpu/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/cpu/&name=CPU&description=&lt;h4 id=&#34;Show-cpu-topo&#34;&gt;&lt;a href=&#34;#Show-cpu-topo&#34; class=&#34;headerlink&#34; title=&#34;Show cpu topo&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://unix.stackexchange.com/questions/113544/interpret-the-output-of-lstopo&#34;&gt;Show cpu topo&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# cpu topo CPU topo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ yum install -y hwloc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ lstopo --no-io --no-legend --of txt&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ lstopo --no-io --no-legend --of svg cpu-topo.svg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ lstopo --no-io --no-legend --of png cpu-topo.png&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&#34;Redhat-server-Certification&#34;&gt;&lt;a href=&#34;#Redhat-server-Certification&#34; class=&#34;headerlink&#34; title=&#34;Redhat server Certification&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://catalog.redhat.com/hardware/search?type=Server&#34;&gt;Redhat server Certification&lt;/a&gt;&lt;/h3&gt;&lt;h3 id=&#34;x86-CPU&#34;&gt;&lt;a href=&#34;#x86-CPU&#34; class=&#34;headerlink&#34; title=&#34;x86 CPU&#34;&gt;&lt;/a&gt;x86 CPU&lt;/h3&gt;&lt;h4 id=&#34;RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support&#34;&gt;&lt;a href=&#34;#RHEL-7-not-support-intel-Coffee-Lake-EDAC-ie31200-Add-Intel-Coffee-Lake-CPU-support&#34; class=&#34;headerlink&#34; title=&#34;RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://lore.kernel.org/all/20190609151613.195164-1-elver@google.com/T/&#34;&gt;RHEL 7 not support intel Coffee Lake. EDAC, ie31200: Add Intel Coffee Lake CPU support&lt;/a&gt;&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;RHEL8 kernel has merged&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;Monitor&#34;&gt;&lt;a href=&#34;#Monitor&#34; class=&#34;headerlink&#34; title=&#34;Monitor&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://github.com/LucaCanali/Miscellaneous/blob/master/Spark_Notes/Tools_Linux_Memory_Perf_Measure.md&#34;&gt;Monitor&lt;/a&gt;&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/opcm/pcm&#34;&gt;Intel Processor Counter Monitor&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.amd.com/en/developer/uprof.html#documentation&#34;&gt;AMD Î¼Prof&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/RRZE-HPC/likwid&#34;&gt;Likwid&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/andikleen/pmu-tools&#34;&gt;pmu tools&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/01org/intel-cmt-cat&#34;&gt;intel pqos&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://download.01.org/perfmon/&#34;&gt;intel perfmon&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/TomTheBear/perfmondb&#34;&gt;intel perfmondb&lt;/a&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm-power 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm-core 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/pcm-memory 20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/opt/AMDuProf_4.0-341/bin/AMDuProfPcm -m memory -a -d 10 -C&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-perfctr -c 0-39 -g MEM -S 10s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-perfctr -c 0-39 -g ENERGY -S 10s&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-topology&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-powermeter&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-features -a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/local/bin/likwid-perfctr -c 0-39 -g L3 -S 10s &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pmu tools&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./ocperf.py list&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./toplev.py -l2 &lt;span class=&#34;built_in&#34;&gt;sleep&lt;/span&gt; 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;AMD-NUMA-and-NPS&#34;&gt;&lt;a href=&#34;#AMD-NUMA-and-NPS&#34; class=&#34;headerlink&#34; title=&#34;AMD NUMA and NPS&#34;&gt;&lt;/a&gt;AMD NUMA and NPS&lt;/h4&gt;&lt;p&gt;In my test, The lower core number and the lower memory performance in the multi-chip module EPCY2, not show it within intel ICE-Lake&lt;br&gt;I mean, 8x cores EPYC2 only Dual memory controller, 16x cores means quad memory controller. I guess after 32 cores is the best memory performance choice.    &lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;MC0-|             |               |-MC7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    -----2x CCD   |   2x CCD  -----&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MC1-|             |               |-MC8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MC2-|             |               |-MC4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    -----2x CCD   |   2x CCD  -----&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MC3-|             |               |-MC5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;NPS0 â This is only available on a 2-socket system. This means one NUMA node per system. Memory is interleaved across all 16 memory channels in the system&lt;ul&gt;
&lt;li&gt;none&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NPS1 â In this, the whole CPU is a single NUMA domain, with all the cores in the socket, and all the associated memory in this one NUMA domain. Memory is interleaved across the eight memory channels. All PCIe devices on the socket belong to this single NUMA domain&lt;ul&gt;
&lt;li&gt;general-purpose workloading&lt;/li&gt;
&lt;li&gt;SPEC CPU 2017&lt;/li&gt;
&lt;li&gt;IO intensive&lt;/li&gt;
&lt;li&gt;Virtualization&lt;/li&gt;
&lt;li&gt;Vmark3&lt;/li&gt;
&lt;li&gt;HammerDB&lt;/li&gt;
&lt;li&gt;Database and analytics&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NPS2 â This setting partitions the CPU into 2 NUMA domains, with half the cores and memory in each domain. Memory is interleaved across 4 memory channels in each NUMA domain&lt;ul&gt;
&lt;li&gt;SPECjbb 2015&lt;/li&gt;
&lt;li&gt;HPC and Teclo&lt;/li&gt;
&lt;li&gt;HPC&lt;/li&gt;
&lt;li&gt;Openstack NFV&lt;/li&gt;
&lt;li&gt;Openstack realtime NFV&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NPS4 â This setting partitions the CPU into four NUMA domains. Each quadrant is a NUMA domain, and memory is interleaved across the 2 memory channels in each quadrant. PCIe devices will be local to one of the 4 NUMA domains on the socket, depending on the quadrant of the IOD that has the PCIe root for the device.&lt;ul&gt;
&lt;li&gt;SPECjbb 2015&lt;/li&gt;
&lt;li&gt;SPECpower ssj 2008&lt;/li&gt;
&lt;li&gt;Virtualization&lt;/li&gt;
&lt;li&gt;TPCx-V&lt;/li&gt;
&lt;li&gt;Container&lt;/li&gt;
&lt;li&gt;Database and analytics&lt;/li&gt;
&lt;li&gt;Hadoop&lt;/li&gt;
&lt;li&gt;TPCx-IOT&lt;/li&gt;
&lt;li&gt;HPC and Teclo&lt;/li&gt;
&lt;li&gt;HPC&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;Intel-Cascade-Lake-CPU-suffix&#34;&gt;&lt;a href=&#34;#Intel-Cascade-Lake-CPU-suffix&#34; class=&#34;headerlink&#34; title=&#34;Intel Cascade Lake CPU suffix&#34;&gt;&lt;/a&gt;Intel Cascade Lake CPU suffix&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;âFâ suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package&lt;/li&gt;
&lt;li&gt;âLâ suffix indicates the SKU is a large memory (4.5 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;âMâ suffix indicates the SKU is a medium memory (2 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;âNâ suffix indicates the SKU is a specialized for Networking&amp;#x2F;NFV&lt;/li&gt;
&lt;li&gt;âSâ suffix indicates the SKU is a search application-specialized model&lt;/li&gt;
&lt;li&gt;âTâ suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification&lt;/li&gt;
&lt;li&gt;âUâ suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)&lt;/li&gt;
&lt;li&gt;âVâ suffix indicates the SKU targets the VM density value market&lt;/li&gt;
&lt;li&gt;âYâ suffix indicates the SKU has Speed Select Technology (SST)&lt;/li&gt;
&lt;li&gt;âRâ suffix indicates the SKU is a refresh model( add cores or frequency)"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/cpu/&t=CPU"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

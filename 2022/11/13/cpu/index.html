<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="x86 CPUIntel Cascade Lake CPU suffix “F” suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package “L” suffix indicates the SKU is a large memory (4.5 TiB) tier SKU “M” suffix indicat">
<meta property="og:type" content="article">
<meta property="og:title" content="CPU">
<meta property="og:url" content="http://example.com/2022/11/13/cpu/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="x86 CPUIntel Cascade Lake CPU suffix “F” suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package “L” suffix indicates the SKU is a large memory (4.5 TiB) tier SKU “M” suffix indicat">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/cpu-cache-memory.png">
<meta property="og:image" content="http://example.com/img/cpu-Isolated-334379.png">
<meta property="article:published_time" content="2022-11-13T13:29:34.000Z">
<meta property="article:modified_time" content="2022-11-14T14:06:24.409Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="cpu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/cpu-cache-memory.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CPU</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/13/nvme/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/13/pcie/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/cpu/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/cpu/&text=CPU"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/cpu/&is_video=false&description=CPU"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CPU&body=Check out this article: http://example.com/2022/11/13/cpu/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/cpu/&name=CPU&description=&lt;h3 id=&#34;x86-CPU&#34;&gt;&lt;a href=&#34;#x86-CPU&#34; class=&#34;headerlink&#34; title=&#34;x86 CPU&#34;&gt;&lt;/a&gt;x86 CPU&lt;/h3&gt;&lt;h4 id=&#34;Intel-Cascade-Lake-CPU-suffix&#34;&gt;&lt;a href=&#34;#Intel-Cascade-Lake-CPU-suffix&#34; class=&#34;headerlink&#34; title=&#34;Intel Cascade Lake CPU suffix&#34;&gt;&lt;/a&gt;Intel Cascade Lake CPU suffix&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;“F” suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package&lt;/li&gt;
&lt;li&gt;“L” suffix indicates the SKU is a large memory (4.5 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;“M” suffix indicates the SKU is a medium memory (2 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;“N” suffix indicates the SKU is a specialized for Networking&amp;#x2F;NFV&lt;/li&gt;
&lt;li&gt;“S” suffix indicates the SKU is a search application-specialized model&lt;/li&gt;
&lt;li&gt;“T” suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification&lt;/li&gt;
&lt;li&gt;“U” suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)&lt;/li&gt;
&lt;li&gt;“V” suffix indicates the SKU targets the VM density value market&lt;/li&gt;
&lt;li&gt;“Y” suffix indicates the SKU has Speed Select Technology (SST)&lt;/li&gt;
&lt;li&gt;“R” suffix indicates the SKU is a refresh model( add cores or frequency)"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/cpu/&t=CPU"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#x86-CPU"><span class="toc-number">1.</span> <span class="toc-text">x86 CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Intel-Cascade-Lake-CPU-suffix"><span class="toc-number">1.1.</span> <span class="toc-text">Intel Cascade Lake CPU suffix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cpu-features"><span class="toc-number">1.2.</span> <span class="toc-text">intel cpu features</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith"><span class="toc-number">1.3.</span> <span class="toc-text">Why some of the 8,16 x cores EPYC2 limit the memory bandwith</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cluster-mode"><span class="toc-number">1.4.</span> <span class="toc-text">CPU cluster mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cache-speed"><span class="toc-number">1.5.</span> <span class="toc-text">CPU cache speed</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline-Width"><span class="toc-number">1.5.1.</span> <span class="toc-text">Pipeline Width</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Caculate-the-Tflops"><span class="toc-number">1.5.2.</span> <span class="toc-text">Caculate the Tflops</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#how-to-test-it-benchmark-flag-test-flag"><span class="toc-number">1.5.3.</span> <span class="toc-text">how to test it benchmark_flag test_flag</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-medium-speed"><span class="toc-number">1.5.4.</span> <span class="toc-text">CPU medium speed</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pin-CPU"><span class="toc-number">2.1.</span> <span class="toc-text">pin CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-cpu-topo"><span class="toc-number">2.2.</span> <span class="toc-text">Show cpu topo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cache-consistenta"><span class="toc-number">2.3.</span> <span class="toc-text">Cache consistenta</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-SMT-255-cores"><span class="toc-number">2.4.</span> <span class="toc-text">AMD SMT, 255 cores</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-STAT"><span class="toc-number">2.5.</span> <span class="toc-text">CPU STAT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#kernel-parameters"><span class="toc-number">2.5.1.</span> <span class="toc-text">kernel parameters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-IDLE"><span class="toc-number">2.5.2.</span> <span class="toc-text">CPU IDLE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><span class="toc-number">2.6.</span> <span class="toc-text">Application multiple threads get down to single core cause performance issue in intel skylake platform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#E3-v6-Turbo-not-support-under-the-CentOS6"><span class="toc-number">2.7.</span> <span class="toc-text">E3 v6 Turbo not support under the CentOS6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isolated-CPUs-example"><span class="toc-number">2.8.</span> <span class="toc-text">Isolated CPUs example</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#use-the-isolated-core"><span class="toc-number">2.8.1.</span> <span class="toc-text">use the isolated core</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-x86-options"><span class="toc-number">2.9.</span> <span class="toc-text">gcc_x86_options</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Disable-features-AVX"><span class="toc-number">2.10.</span> <span class="toc-text">Disable features AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ban-half-core-try-to-not-running-HT"><span class="toc-number">2.11.</span> <span class="toc-text">Ban half core, try to not running HT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Turn-off-the-cpu-cores-under-linux"><span class="toc-number">2.12.</span> <span class="toc-text">Turn off the cpu cores under linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cmt-cat"><span class="toc-number">2.13.</span> <span class="toc-text">intel-cmt-cat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-process-with-CPU"><span class="toc-number">2.14.</span> <span class="toc-text">Linux process with CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numa"><span class="toc-number">2.15.</span> <span class="toc-text">numa</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#How-many-temperature-is-high-for-intel-CPU"><span class="toc-number">2.16.</span> <span class="toc-text">How many temperature is high for intel CPU ?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tool-for-CPU-machine-specific-registers"><span class="toc-number">2.17.</span> <span class="toc-text">tool for CPU machine specific registers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#irqbalance"><span class="toc-number">2.18.</span> <span class="toc-text">irqbalance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-Performance-overrides"><span class="toc-number">3.</span> <span class="toc-text">CVE Performance overrides</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenMP-env-var"><span class="toc-number">3.1.</span> <span class="toc-text">OpenMP env var</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#turbostat"><span class="toc-number">3.1.1.</span> <span class="toc-text">turbostat</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powertop"><span class="toc-number">3.2.</span> <span class="toc-text">powertop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powercap"><span class="toc-number">3.3.</span> <span class="toc-text">powercap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#process-counter-monitor-PCM"><span class="toc-number">3.4.</span> <span class="toc-text">process counter monitor (PCM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numatop"><span class="toc-number">3.5.</span> <span class="toc-text">numatop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-CPU-parameters"><span class="toc-number">3.6.</span> <span class="toc-text">Linux CPU parameters</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CPU
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-13T13:29:34.000Z" itemprop="datePublished">2022-11-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CPU/">CPU</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/cpu/" rel="tag">cpu</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="x86-CPU"><a href="#x86-CPU" class="headerlink" title="x86 CPU"></a>x86 CPU</h3><h4 id="Intel-Cascade-Lake-CPU-suffix"><a href="#Intel-Cascade-Lake-CPU-suffix" class="headerlink" title="Intel Cascade Lake CPU suffix"></a>Intel Cascade Lake CPU suffix</h4><ul>
<li>“F” suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package</li>
<li>“L” suffix indicates the SKU is a large memory (4.5 TiB) tier SKU</li>
<li>“M” suffix indicates the SKU is a medium memory (2 TiB) tier SKU</li>
<li>“N” suffix indicates the SKU is a specialized for Networking&#x2F;NFV</li>
<li>“S” suffix indicates the SKU is a search application-specialized model</li>
<li>“T” suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification</li>
<li>“U” suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)</li>
<li>“V” suffix indicates the SKU targets the VM density value market</li>
<li>“Y” suffix indicates the SKU has Speed Select Technology (SST)</li>
<li>“R” suffix indicates the SKU is a refresh model( add cores or frequency)<span id="more"></span></li>
</ul>
<h4 id="intel-cpu-features"><a href="#intel-cpu-features" class="headerlink" title="intel cpu features"></a><a target="_blank" rel="noopener" href="https://www.all-electronics.de/wp-content/uploads/migrated/document/196371/413ei0507-intel-sma.pdf">intel cpu features</a></h4><ul>
<li><p>Intel® Wide Dynamic Execution</p>
<ul>
<li>Dynamic execution is a combination of techniques (data flow analysis, speculative execution, out of order execution, and super scalar) that Intel first implemented in the P6 microarchitecture used in the Intel® Pentium® Pro processor, Pentium® II processor and Pentium® III processors.</li>
</ul>
</li>
<li><p>Intel® Advanced Digital Media Boost</p>
<ul>
<li>Intel Advanced Digital Media Boost helps achieve similar dramatic gains in throughputs for programs utilizing SSE instructions of 128-bit operands. (SSE instructions enhance Intel architecture by enabling programmers to develop algorithms that can mix packed, single-precision, and double-precision floating point and integers, using SSE instructions.)</li>
</ul>
</li>
<li><p>Intel® Intelligent Power Capability</p>
<ul>
<li>Intel Intelligent Power Capability is a set of capabilities for reducing power consumption and device design requirements. This feature manages the runtime power consumption of all the processor’s execution cores. It includes an advanced power-gating capability that allows for an ultra fine-grained logic control that turns on individual processor logic subsystems only if and when they are needed. Additionally, many buses and arrays are split so that data required in some modes of operation can be put in a low-power state when not needed</li>
</ul>
</li>
<li><p>Intel® Advanced Smart Cache</p>
<ul>
<li>Intel Advanced Smart Cache is a multi-core optimized cache that improves performance and efficiency by increasing the probability that each execution core of a dual-core processor can access data from a higher-performance, more-efficient cache subsystem</li>
</ul>
</li>
<li><p>Intel® Smart Memory Access</p>
<ul>
<li>Intel Smart Memory Access improves system performance by optimizing the use of the available data bandwidth from the memory subsystem and hiding the latency of memory accesses. The goal is to ensure that data can be used as quickly as possible and is located as close as possible to where it’s needed to minimize latency and thus improve efficiency and speed</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19253-01/817-0547/girss/index.html">x86 T-state Throttling State</a></p>
<ul>
<li>This feature provides the basic CPU Advanced Configuration and Power Interface (ACPI) T-state support. T-state support enables the CPU driver to receive _TPC change notifications as a manner of controlling the processor speed. This is frequently done on some systems as a passive cooling mechanism along with the existing CPU ACPI P-States.</li>
<li>the more for decrease the temprature</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://colfaxresearch.com/skl-avx512/">SKL</a></p>
<ul>
<li>AVX-512F<ul>
<li>The fundamental instruction set, it expands most of AVX functions to support 512-bit registers and adds masking, embedded broadcasting, embedded rounding and exception control.</li>
</ul>
</li>
<li>AVX-512CD   <ul>
<li>Conflict Detection instruction set allows vectorization of loops with vector dependency due to writing conflicts</li>
</ul>
</li>
<li>AVX-512BW <ul>
<li>Byte and Word support instruction set: 8-bit and 16-bit integer operations, processing up to 64 8-bit elements or 32 16-bit integer elements per vector</li>
</ul>
</li>
<li>AVX-512DQ   <ul>
<li>Double and Quad word instruction set, supports new instructions for double-word (32-bit) and quadword (64-bit) integer and floating-point elements</li>
</ul>
</li>
<li>AVX-512VL <ul>
<li>Vector Length extensions: support for vector lengths smaller than 512 bits</li>
</ul>
</li>
</ul>
</li>
<li><p>KNL</p>
<ul>
<li>AVX-512F    <ul>
<li>Conflict Detection instruction set allows vectorization of loops with vector dependency due to writing conflicts</li>
</ul>
</li>
<li>AVX-512CD<ul>
<li>Byte and Word support instruction set: 8-bit and 16-bit integer operations, processing up to 64 8-bit elements or 32 16-bit integer elements per vector</li>
</ul>
</li>
<li>AVX-512PF<ul>
<li>Data prefetching for gather and scatter instructions</li>
</ul>
</li>
<li>AVX-512ER<ul>
<li>Exponential and Reciprocal instruction set for high-accuracy base-2 exponential functions, reciprocals, and reciprocal square root<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Compiler        Intel compilers 17.x    Intel compilers 18.x                      GNU and LLVM</span><br><span class="line">Cross-platform  -xCommon-AVX512         -xCommon-AVX512                         -mfma -mavx512f -mavx512cd</span><br><span class="line">SKL processors  -xCore-AVX512           -xCore-AVX512 -qopt-zmm-usage=high      -march=skylake-avx512</span><br><span class="line">KNL processors  -xMIC-AVX512            -xMIC-AVX512    -march=knl</span><br><span class="line"></span><br><span class="line">$ icc -xCORE-AVX512 -c auto_vec.c</span><br><span class="line">$ icc -xCORE-AVX512 -S auto_vec.c</span><br><span class="line">$ icc -xCORE-AVX512 -c auto_vec.c -qopt-report=5 </span><br><span class="line"></span><br><span class="line">$ icc  -xCORE-AVX512 -S auto_vec.c -qopt-report-embed</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -c auto_vec.c</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -S auto_vec.c</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -c auto_vec.c -fopt-info-vec</span><br><span class="line">$ gcc -O3 -march=skylake-avx512 -S auto_vec.c -fopt-info-vec</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith"><a href="#Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith" class="headerlink" title="Why some of the 8,16 x cores EPYC2 limit the memory bandwith"></a>Why some of the 8,16 x cores EPYC2 limit the memory bandwith</h4><p><a target="_blank" rel="noopener" href="https://en.wikichip.org/wiki/amd/epyc/7252">This model supports up to 8 channels of up to DDR4-3200 memory with a theoretical maximum bandwidth of 25.6 GB&#x2F;s (≈ 23.84 GiB&#x2F;s) per channel, but is apparently bandwidth limited by the IFOP links between the I&#x2F;O die and its only two compute dies (effective bandwidth ≈ 55 GB&#x2F;s per CCD at 1.46 GHz FCLK). According to AMD this processor is “optimized for 4 channels with DDR4-2667 DIMMs” (≈ 21.3 GB&#x2F;s per channel) and therefore has a “per-socket theoretical memory bandwidth 85.3 GB&#x2F;s” (≈ 79.47 Ga)</a></p>
<h4 id="CPU-cluster-mode"><a href="#CPU-cluster-mode" class="headerlink" title="CPU cluster mode"></a>CPU cluster mode</h4><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/technical/xeon-processor-scalable-family-technical-overview.html">CHA is responsible for tracking of requests from the core and responding to snoops from local and remote agents as well as resolution of coherency across multiple processors</a></p>
<ul>
<li>All2All<ul>
<li>No policy, free, maybe the request pass the longest path</li>
</ul>
</li>
<li>SNC-2&#x2F;SNC-4 (sub-NUMA)<ul>
<li>Don ‘t keep cache consistency with remote numa node, divide by numa and cluster range</li>
</ul>
</li>
<li>Hemishphere<ul>
<li>Memory channel(worked) with symmetric assembly in the 2 x Memory controller</li>
</ul>
</li>
<li>Quadrant<ul>
<li>Same with hemishphere in the 4 x Memory controller</li>
</ul>
</li>
<li>Auto</li>
</ul>
<h4 id="CPU-cache-speed"><a href="#CPU-cache-speed" class="headerlink" title="CPU cache speed"></a>CPU cache speed</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.7-cpu.com/cpu/Ice_Lake.html">Intel i7-1065G7 (Ice Lake), 3.9 GHz (Turbo Boost), 10 nm. 122 mm2, RAM: 16 GB, dual LPDDR4-3733. Surface Pro 7</a><ul>
<li>L1 Data Cache Latency &#x3D; 5 cycles for simple access via pointer</li>
<li>L1 Data Cache Latency &#x3D; 5 cycles for access with complex address calculation (size_t n, *p; n &#x3D; p[n]).</li>
<li>L2 Cache Latency &#x3D; 13 cycles</li>
<li>L3 Cache Latency &#x3D; 42 cycles (core 0)</li>
<li>L3 Cache Latency &#x3D; 41 cycles (core 1)</li>
<li>L3 Cache Latency &#x3D; 41 cycles (core 2)</li>
<li>L3 Cache Latency &#x3D; 42 cycles (core 3)</li>
<li>RAM Latency &#x3D; 42 cycles + 87 ns </li>
<li>Branch misprediction penalty &#x3D; 17 cycles average (if mOp cache hit).</li>
<li>Branch misprediction penalty &#x3D; 20-21 ? cycles (if mOp cache miss). </li>
<li>64-bytes range cross penalty &#x3D; 6 cycles</li>
<li>4096-bytes range cross penalty &#x3D; 7 cycles (1 additional cycle over 64-bytes cross penalty). </li>
<li>L1 B&#x2F;W (Parallel Random Read) &#x3D; 0.5 cycles per one access</li>
<li>L1 Write (8-32 bytes step) &#x3D; 0.5 cycles per one write </li>
<li>L2-&gt;L1 B&#x2F;W (Parallel Random Read) &#x3D; 1.4 cycles per cache line</li>
<li>L2-&gt;L1 B&#x2F;W (Read, 64 bytes step) &#x3D; 1.4 cycles per cache line</li>
<li>L2 Write (Write, 16-64 bytes step) &#x3D; 3.0 cycles per cache line </li>
<li>L3-&gt;L1 B&#x2F;W (Parallel Random Read) &#x3D; 4.0 (or less) cycles per cache line</li>
<li>L3-&gt;L1 B&#x2F;W (Read, 64 bytes step) &#x3D; 3.3 cycles per cache line</li>
<li>L3 Write (Write, 16-64 bytes step) &#x3D; 5.2 cycles per cache line </li>
<li>RAM Read B&#x2F;W (Parallel Random Read) &#x3D; 6 ns (or less) &#x2F; cache line</li>
<li>RAM Read B&#x2F;W (Read, 16-64 Bytes step) &#x3D; 24-25 GB&#x2F;s</li>
<li>RAM Read B&#x2F;W (Read, 64 Bytes step - pointer chasing) &#x3D; 18 GB&#x2F;s</li>
<li>RAM Write B&#x2F;W (Write, 8-64 Bytes step) &#x3D; 18 GB&#x2F;s</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.7-cpu.com/cpu/Zen2.html">AMD 3800X (Zen2), 7 nm. RAM: 32 GB, RAM DDR4-3200 16-18-18-38-56-1T (dual channel)</a><ul>
<li>L1 Data cache &#x3D; 32 KB, 64 B&#x2F;line, 8-WAY. write-back, ECC. Two 256-bit loads and one 256-bit store per cycle.</li>
<li>L1 Instruction cache &#x3D; 32 KB, 64 B&#x2F;line, 8-WAY. 32 bytes fetch &#x2F; cycle.</li>
<li>L2 cache &#x3D; 512 KB, 64 B&#x2F;line, 8-WAY, write-back. 32 bytes L2-&gt;L1 datapath.</li>
<li>L3 cache &#x3D; 16 MB or 4 MB per CCX 4 cores), 64 B&#x2F;line, 16-WAY, write-back. victim for L2.</li>
<li>Op Cache (OC): 4096 items. up to 8 Instructions&#x2F;entry. 8-way, 64 sets. Entry limits: 8 instructions, 8 32-bit t immediates&#x2F;displacements (64-bit immediates&#x2F;displacements take two slots), 4 microcode instructions. An OC entry terminates at the end of a 64-byte aligned memory region.</li>
<li>Dispatch: 6 ops&#x2F;cycle</li>
<li>Retire Unit: receive 6 macro-op&#x2F;cycle, 224 macro ops. 8 macro-op&#x2F;cycle retire</li>
<li>4 ALUS, 3 AGUs</li>
<li>ALU schedulers : 4x16.</li>
<li>AGU scheduler : 1x28.</li>
<li>reorder buffer : 224.</li>
<li>integer register file : 180.</li>
<li>FP scheduler : 36 entry micro-op.</li>
<li>4 FPU pipes.</li>
<li>2x 32B loads + 1x 32B store per cycle</li>
<li>Load Queue: 44 entry</li>
<li>Store Queue: 48 entry</li>
<li>LS unit can track up to 22 outstanding in-flight cache misses. </li>
<li>4 cycles for simple access via pointer</li>
<li>5 cycles for access with complex address calculation (size_t n, *p; n &#x3D; p[n]).</li>
<li>AMD DOC: 7- or 8-cycle FPU load-to-use latency.</li>
<li>L2 Cache Latency &#x3D; 12 cycles</li>
<li>L3 Cache Latency &#x3D; 38 cycles</li>
<li>RAM Latency &#x3D; 38 cycles + 66 ns</li>
</ul>
</li>
</ul>
<p>AMD Roma 7552 L1 instruct 32K 8-way, L1 32K 8-way, L2 512K 8-way, L3-per-socket 192M 16-way   </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.intel.com/content/dam/support/us/en/documents/motherboards/server/sb/intelserversystembiossetuputilityguide10_final.pdf">DCU Data Prefetcher</a><ul>
<li>[Enabled] The next cache line will be prefetched into L1 data cache from L2 or system memory during unused cycles if it sees that the processor core has accessed several bytes sequentially in a cache line as data.</li>
<li>[Disabled] Only fetches cache line with data required by the processor (64 bytes)</li>
</ul>
</li>
<li>DCU Mode<ul>
<li>32KB 8Way Without ECC</li>
<li>16KB 4Way With ECC</li>
</ul>
</li>
</ul>
<h5 id="Pipeline-Width"><a href="#Pipeline-Width" class="headerlink" title="Pipeline Width"></a><a target="_blank" rel="noopener" href="https://travisdowns.github.io/blog/2019/06/11/speed-limits.html">Pipeline Width</a></h5><ul>
<li>Intel Skylake: Maximum 4 fused uops per cycle</li>
<li>Intel Ice Lake: Maximum 5 fused uops per cycle</li>
<li>AMD Zen, Zen 2: Maximum 6 MOPs from up to 5 instructions per cycle</li>
<li>AMD Zen 3: Maximum 6 MOPs from up to 6 instructions per cycle</li>
<li>Apple M1: Maximum 8 ops per cycle</li>
</ul>
<h5 id="Caculate-the-Tflops"><a href="#Caculate-the-Tflops" class="headerlink" title="Caculate the Tflops"></a>Caculate the Tflops</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">FP64  </span><br><span class="line">     2xsocket</span><br><span class="line">       |24 cores</span><br><span class="line">       |  | operations_per_cycle = 2 x FMA AVX512 , (fma_num)2 x (512/FP64) x 2(乘法和加法各算一个操作，所以8可以乘2) =2 x 8 x 2 =32</span><br><span class="line">       |  |  | 2.6GHz</span><br><span class="line">       |  |  |  |</span><br><span class="line">TFLOPS=2*24*32*2.6*10^9*10^-12=3.9936 Tflops</span><br><span class="line"></span><br><span class="line">FP32=FP64 x 2</span><br><span class="line">FP16=Xeon CPU在SapphirRapids(SPR)之前不支持FP16的原生FMA运算，需要先通过vcvtph2ps指令将FP16转换成FP32，再通过FP32的FMA运算来完成。此时，FP16的峰值TFLOPS与FP32的峰值TFLOPS是相等的</span><br><span class="line"></span><br><span class="line">BF16=Xeon CPU从CooperLake(CPX)开始支持BF16的乘加运算，凡是CPU Flag中有AVX512_BF16的CPU均支持原生BF16乘加。但因为其复用了FP32的FMA，所以暴露出来的BF16指令并不是标准的FMA，而是DP(Dot Product)</span><br><span class="line"></span><br><span class="line">一个AVX-512寄存器可以存放32个BF16。因此，一个AVX-512 BF16 DP每个clock cycle可以做32个乘加操作。</span><br><span class="line"></span><br><span class="line">AVX INT32 MA</span><br><span class="line">CPU通过两条指令vpmuldq + vpaddq完成INT32的乘加操作</span><br><span class="line">一个AVX-512寄存器可以存放16个INT32, 一个AVX-512 FMA每2个clock cycle可以做16个INT32乘加操作，即平均每个clock cycle可以做8个INT32乘加操作。</span><br><span class="line"></span><br><span class="line">pre-VNNI MA</span><br><span class="line">在支持VNNI(Vector Neural Network Instructions)指令前，CPU通过两条指令vpmaddwd + vpaddd完成INT16的DP操作(原因也是为了复用INT32的FMA，所以选择不支持INT16的FMA，而只支持Multiply Add)</span><br><span class="line">一个AVX-512寄存器可以存放32个INT16。因此，每2个clock cycle可以做32个INT16乘加操作，即平均每个clock cycle做16个INT16乘加操作</span><br><span class="line"></span><br><span class="line">post-VNNI DP</span><br><span class="line">在支持VNNI指令后，CPU通过一条指令vpdpwssd完成INT16的乘加操作</span><br><span class="line">一个AVX-512 FMA每个clock cycle可以做32个INT16乘加操作</span><br><span class="line"></span><br><span class="line">INT8 TOPS计算</span><br><span class="line">在支持VNNI指令前，CPU通过三条指令vpmaddubsw + vpmaddwd + vpaddd完成INT8的DP操作</span><br><span class="line">一个AVX-512寄存器可以存放64个INT8 。因此，一个AVX-512 FMA每3个clock可以做64个INT8乘加操作，即平均每个clock做64/3￼个INT8乘加操作</span><br><span class="line"></span><br><span class="line">在支持VNNI指令后，CPU通过一条指令vpdpbusd完成INT8的DP操作,</span><br><span class="line">一个AVX-512寄存器可以存放64个INT8。因此，一个AVX-512 FMA每个clock cycle可以做64个INT8乘加操作</span><br></pre></td></tr></table></figure>

<h5 id="how-to-test-it-benchmark-flag-test-flag"><a href="#how-to-test-it-benchmark-flag-test-flag" class="headerlink" title="how to test it benchmark_flag test_flag"></a><a target="_blank" rel="noopener" href="https://github.com/travisdowns/uarch-bench">how to test it</a> benchmark_flag test_flag</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">$ yum install devtoolset-9-toolchain</span><br><span class="line">$ scl <span class="built_in">enable</span> devtoolset-9 bash</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/obilaniu/libpfc</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/nemequ/portable-snippets</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/andikleen/pmu-tools</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/bombela/backward-cpp/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/travisdowns/nasm-utils</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/wcohen/libpfm4</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/travisdowns/avx-turbo</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfc ./</span><br><span class="line">$ <span class="built_in">cp</span> -a nasm-utils uarch-benchs</span><br><span class="line">$ <span class="built_in">cp</span> -a ../pmu-tools ./</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfm4 ./</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.o ./</span><br><span class="line">$ vi isa-support.cpp</span><br><span class="line">$ vi perf-timer.cpp</span><br><span class="line">$ vi main.cpp</span><br><span class="line">$ vi libpfm4-support.cpp</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">avx-turbo  backward-cpp  libpfc  libpfm4  nasm-utils  pmu-tools  portable-snippets  uarch-bench</span><br><span class="line">$ <span class="built_in">cd</span> avx-turbo</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../libpfc</span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=<span class="variable">$C_INCLUDE_PATH</span>:/opt/lib/el7/mpich-3.2.1/include/:/opt/lib/el7/libtool-2.4.6/include:~/uarch/libpfc/include:~/uarch/avx-turbo:~/uarch/libpfc/include</span><br><span class="line">$ <span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:/local/nvme/uarch/libpfc</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../uarch-bench</span><br><span class="line">$ <span class="built_in">rmdir</span> libpfc</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfc ./</span><br><span class="line">$ <span class="built_in">mkdir</span> cpu</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.c cpu</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.h cpu</span><br><span class="line">$ <span class="built_in">rmdir</span> pmu-tools</span><br><span class="line">$ <span class="built_in">cp</span> -a ../pmu-tools ./</span><br><span class="line">$ <span class="built_in">rmdir</span> backward-cpp</span><br><span class="line">$ <span class="built_in">cp</span> -a ../backward-cpp ./</span><br><span class="line">$ <span class="built_in">rmdir</span> nasm-utils/</span><br><span class="line">$ <span class="built_in">cp</span> -a ../nasm-utils ./</span><br><span class="line">$ <span class="built_in">rmdir</span> libpfm4</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfm4 ./</span><br><span class="line">$ <span class="built_in">rmdir</span> pmu-tools</span><br><span class="line">$ <span class="built_in">cp</span> -a ../pmu-tools ./</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.o ./</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ ./uarch-bench</span><br><span class="line">Welcome to uarch-bench (f88a3a8-dirty)</span><br><span class="line">Supported CPU features: SSE3 PCLMULQDQ VMX SMX EST TM2 SSSE3 FMA CX16 SSE4_1 SSE4_2 MOVBE POPCNT AES AVX RDRND TSC_ADJ SGX BMI1 HLE AVX2 BMI2 ERMS RTM MPX RDSEED ADX CLFLUSHOPT INTEL_PT</span><br><span class="line">Pinned to CPU 0</span><br><span class="line">Median CPU speed: 3.987 GHz</span><br><span class="line">Running benchmarks <span class="built_in">groups</span> using timer clock</span><br><span class="line"></span><br><span class="line">** Running group basic : Basic Benchmarks **</span><br><span class="line">                               Benchmark    Cycles     Nanos</span><br><span class="line">                     Dependent add chain      1.00      0.25</span><br><span class="line">                   Independent add chain      0.25      0.06</span><br><span class="line">                  Dependent imul 64-&gt;128      3.00      0.75</span><br><span class="line">                   Dependent imul 64-&gt;64      3.00      0.75</span><br><span class="line">                Independent imul 64-&gt;128      1.01      0.25</span><br><span class="line">                 Independent imul 64-&gt;64      1.00      0.25</span><br><span class="line">                    Same location stores      1.00      0.25</span><br><span class="line">                Disjoint location stores      1.00      0.25</span><br><span class="line">                Dependent push/pop chain      4.42      1.11</span><br><span class="line">              Independent push/pop chain      1.04      0.26</span><br><span class="line">     Back-to-back call of empty <span class="keyword">function</span>      4.37      1.10</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">$ $ ./uarch-bench.sh --test-name=memory/load-parallel/parallel-load-128</span><br><span class="line">Driver: intel_pstate, governor: performance</span><br><span class="line">Vendor ID: GenuineIntel</span><br><span class="line">Model name: Intel(R) Xeon(R) CPU E5-2643 v3 @ 3.40GHz</span><br><span class="line">intel_pstate/no_turbo reports that turbo is already disabled</span><br><span class="line">Using timer: clock</span><br><span class="line">Welcome to uarch-bench (f88a3a8-dirty)</span><br><span class="line">Supported CPU features: SSE3 PCLMULQDQ VMX SMX EST TM2 SSSE3 FMA CX16 SSE4_1 SSE4_2 MOVBE POPCNT AES AVX RDRND TSC_ADJ BMI1 AVX2 BMI2 ERMS</span><br><span class="line">Pinned to CPU 0</span><br><span class="line">Median CPU speed: 3.399 GHz</span><br><span class="line">Running benchmarks <span class="built_in">groups</span> using timer clock</span><br><span class="line"></span><br><span class="line">** Running group memory/load-parallel : Random(ish) parallel loads from fixed-size regions **</span><br><span class="line">                               Benchmark    Cycles     Nanos</span><br><span class="line">                   128-KiB parallel load      2.27      0.67</span><br><span class="line">Finished <span class="keyword">in</span> 315 ms (memory/load-parallel)</span><br><span class="line"></span><br><span class="line">$./uarch-bench.sh --timer=perf --test-name=cpp/sum-halves --extra-events=uops_issued.any</span><br><span class="line">./uarch-bench.sh --test-name=cpp/sum-halves --extra-events=uops_issued.any</span><br><span class="line">$./uarch-bench.sh --timer=perf --test-name=cpp/mul-4 --extra-events=uops_issued.any,uops_retired.retire_slots</span><br><span class="line">./uarch-bench.sh --test-name=cpp/mul-4 --extra-events=uops_issued.any,uops_retired.retire_slots</span><br><span class="line">$./uarch-bench.sh --timer=perf --test-name=cpp/mul-4 --extra-events=uops_dispatched_port.port_0<span class="comment">#p0,uops_dispatched_port.port_1#p1,uops_dispatched_port.port_2#p2,uops_dispatched_port.port_3#p3,uops_dispatched_port.port_4#p4,uops_dispatched_port.port_5#p5,uops_dispatched_port.port_6#p6,uops_dispatched_port.port_7#p7</span></span><br><span class="line">$ ./uarch-bench.sh --test-name=cpp/mul-4 --extra-events=uops_dispatched_port.port_0<span class="comment">#p0,uops_dispatched_port.port_1#p1,uops_dispatched_port.port_2#p2,uops_dispatched_port.port_3#p3,uops_dispatched_port.port_4#p4,uops_dispatched_port.port_5#p5,uops_dispatched_port.port_6#p6,uops_dispatched_port.port_7#p7</span></span><br><span class="line">$ ./uarch-bench.sh --test-name=cpp/mul-chain --extra-events=uops_dispatched_port.port_0<span class="comment">#p0,uops_dispatched_port.port_1#p1,uops_dispatched_port.port_2#p2,uops_dispatched_port.port_3#p3,uops_dispatched_port.port_4#p4,uops_dispatched_port.port_5#p5,uops_dispatched_port.port_6#p6</span></span><br></pre></td></tr></table></figure>
<ul>
<li>eIPC: effective instuction per cycle</li>
<li>IPC: insns per cycle insn&#x2F;cycles<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cpu FSB x multiplier = frequency</span><br><span class="line">cpu frequency x IPC</span><br></pre></td></tr></table></figure></li>
<li>Application CPU time &#x3D; instruction nums&#x2F;(frequency x IPC)</li>
<li><a target="_blank" rel="noopener" href="https://plantegg.github.io/2021/06/18/%E5%87%A0%E6%AC%BECPU%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94">The simple cpu maximum performance evaluate &#x3D; frequency x Core nums x Maximum N(4&#x2F;5&#x2F;6&#x2F;8 or more) fused uops per cycle x 1.3(smt2, 2 HT x86) or 1.5(smt4, 4 HT power)</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ perf <span class="built_in">stat</span> -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses  -a -p <span class="variable">$test_app_pid</span></span><br></pre></td></tr></table></figure>
<img src="/img/cpu-cache-memory.png"></li>
</ul>
<h5 id="CPU-medium-speed"><a href="#CPU-medium-speed" class="headerlink" title="CPU medium speed"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4087280/approximate-cost-to-access-various-caches-and-main-memory">CPU medium speed</a></h5><p><a href="/img/cpu_speed_a7jWu.png"></a><br>L1 cache (instruction cache and data cache) hit : <del>4 clock cycle<br>L2 cache hit: ~10 clock cycle<br>L3 cache hit, line unshare: ~40 clock cycle<br>L3 cache hit, share line in another core: ~65 clock cycle<br>L3 cache hit, modified in another core ~75 cycles remote<br>L3 cache ~100-300 cycles<br>Local DRAM ~30 ns (</del>120 cycles)<br>Remote DRAM ~100 ns</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">           0.5 ns - CPU L1 dCACHE reference</span><br><span class="line">           1   ns - speed-of-light (a photon) travel a 1 ft (30.5cm) distance</span><br><span class="line">           5   ns - CPU L1 iCACHE Branch mispredict</span><br><span class="line">           7   ns - CPU L2  CACHE reference</span><br><span class="line">          71   ns - CPU cross-QPI/NUMA best  <span class="keyword">case</span> on XEON E5-46*</span><br><span class="line">         100   ns - MUTEX lock/unlock</span><br><span class="line">         100   ns - own DDR MEMORY reference</span><br><span class="line">         135   ns - CPU cross-QPI/NUMA best  <span class="keyword">case</span> on XEON E7-*</span><br><span class="line">         202   ns - CPU cross-QPI/NUMA worst <span class="keyword">case</span> on XEON E7-*</span><br><span class="line">         325   ns - CPU cross-QPI/NUMA worst <span class="keyword">case</span> on XEON E5-46*</span><br><span class="line">      10,000   ns - Compress 1K bytes with Zippy PROCESS</span><br><span class="line">      20,000   ns - Send 2K bytes over 1 Gbps NETWORK</span><br><span class="line">     250,000   ns - Read 1 MB sequentially from MEMORY</span><br><span class="line">     500,000   ns - Round trip within a same DataCenter</span><br><span class="line">  10,000,000   ns - DISK seek</span><br><span class="line">  10,000,000   ns - Read 1 MB sequentially from NETWORK</span><br><span class="line">  30,000,000   ns - Read 1 MB sequentially from DISK</span><br><span class="line"> 150,000,000   ns - Send a NETWORK packet CA -&gt; Netherlands</span><br><span class="line">|   |   |   |</span><br><span class="line">|   |   | ns|</span><br><span class="line">|   | us|</span><br><span class="line">| ms|</span><br></pre></td></tr></table></figure>

<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="pin-CPU"><a href="#pin-CPU" class="headerlink" title="pin CPU"></a>pin CPU</h4><p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-CPU-Configuration_suggestions#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Configuration_suggestions-Configuring_CPU_thread_and_interrupt_affinity_with_Tuna">tuna</a>    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop irqbalance.service</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/module/spl/parameters/spl_taskq_thread_dynamic</span><br><span class="line">tuna -c 12-15 -t <span class="string">&#x27;*rcu*&#x27;</span> --move</span><br><span class="line">tuna -C 12-15 -i -q <span class="string">&#x27;mlx5_comp*@pci:0000:c1:00.0&#x27;</span></span><br><span class="line">tuna -C 12-15 -i -q <span class="string">&#x27;mlx5_comp*@pci:0000:c1:00.1&#x27;</span></span><br><span class="line">tuna -C 12-15 -i -q <span class="string">&#x27;mpt3sas*-msix*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Move lustre and zfs process</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/module/spl/parameters/spl_taskq_thread_dynamic</span><br><span class="line">$ tuna --cpus=8-15 --threads z_wr_iss* --move</span><br><span class="line">$ tuna --cpus=8-15 --threads z_wr_int* --move</span><br><span class="line">$ tuna --cpus=0-7 --threads socknal* --move</span><br><span class="line">$ tuna --cpus=0-7 --threads ll_ost_io* --move</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Move an irq to cpu 5</span></span><br><span class="line">$ tuna -c5 -q eth4-rx-4 -move</span><br><span class="line"></span><br><span class="line"><span class="comment">#Move all irqs named &quot;eth4*&quot; away from numa node 1</span></span><br><span class="line">$ tuna -S 1 -i -q <span class="string">&#x27;eth4*&#x27;</span>  </span><br><span class="line">                    |</span><br><span class="line">                    ---name from /proc/interrupts</span><br><span class="line">$ tuna --cpus CPUs --isolate</span><br><span class="line">$ tuna --cpus CPUs --include</span><br><span class="line">$ tuna --irqs IRQs --cpus CPU --move</span><br><span class="line">$ tuna --irqs sfc1* -c7 -m -x</span><br><span class="line">$ tuna --irqs <span class="string">&#x27;enp1s0f*&#x27;</span> --socket 0 --spread --show_irqs</span><br><span class="line">$ tuna --threads thread --priority policy:level  <span class="comment">#level:0-99</span></span><br><span class="line">$ tuna --cpus=0,1 --threads=ssh* --move --cpus=2,3 --threads=http* --move</span><br><span class="line">$ tuna --threads 7861 --show_threads</span><br><span class="line">$ tuna --threads 7861 --priority=RR:40</span><br><span class="line">$ tuna -t qemu* -P -c0 -mP -c1 -mP -c+0 -mP</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0 0xff,0xffffffff    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0 0xff,0xffffffff   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0 0xff,0xffffffff   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0 0xff,0xffffffff  54315196        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0 0xff,0xffffffff  42864592         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        0    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        0   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        0   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        0  54315198        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        0  42864593         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0        1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0        1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0        1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0        1  54315200        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0        1  42864595         6630        qemu-kvm</span><br><span class="line">                      thread       ctxt_switches</span><br><span class="line">    pid SCHED_ rtpri affinity voluntary nonvoluntary             cmd</span><br><span class="line">  153687  OTHER     0      0,1    173264           51        qemu-kvm</span><br><span class="line">  212178  OTHER     0      0,1   1820409          376        qemu-kvm</span><br><span class="line">  376594  OTHER     0      0,1   2480482         1780        qemu-kvm</span><br><span class="line">  380332  OTHER     0      0,1  54315202        41275        qemu-kvm</span><br><span class="line">  382034  OTHER     0      0,1  42864597         6630        qemu-kvm</span><br></pre></td></tr></table></figure>

<h4 id="Show-cpu-topo"><a href="#Show-cpu-topo" class="headerlink" title="Show cpu topo"></a><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/113544/interpret-the-output-of-lstopo">Show cpu topo</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ yum install -y hwloc</span><br><span class="line">$ lstopo --no-io --no-legend --of txt</span><br><span class="line">$ lstopo --no-io --no-legend --of svg cpu-topo.svg</span><br><span class="line">$ lstopo --no-io --no-legend --of png cpu-topo.png</span><br></pre></td></tr></table></figure>

<h4 id="Cache-consistenta"><a href="#Cache-consistenta" class="headerlink" title="Cache consistenta"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/94811032">Cache consistent</a>a</h4><ul>
<li>write back<ul>
<li>only cache and then write to memory</li>
</ul>
</li>
<li>write through<ul>
<li>write cache and memory at the same time</li>
</ul>
</li>
<li>Snooping<ul>
<li>boardcast</li>
</ul>
</li>
<li>Directory-based<ul>
<li>index directory for some cores</li>
<li>The worst case: N x Cores, each core will communicates with the others(N-1)</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/20793.html">reference1</a><br><a target="_blank" rel="noopener" href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm">reference2</a></p>
<h4 id="AMD-SMT-255-cores"><a href="#AMD-SMT-255-cores" class="headerlink" title="AMD SMT, 255 cores"></a><a target="_blank" rel="noopener" href="https://developer.amd.com/wp-content/resources/56745_0.80.pdf">AMD SMT, 255 cores</a></h4><p>Some workloads, including many HPC ones, observe a performance neutral or even performance negative result when SMT is enabled. Some applications license by the hardware thread enabled, not just physical core. For those reasons, disabling SMT on your EPYC 7002 Series processor may be desirable. There are also some operating systems that have not enabled support for the x2APIC within the EPYC 7002 Series Processor, which is required to support beyond 255 threads. If you are running an operating system that does not support AMD’s x2APIC implementation, and have two 64-core processors installed, you will need to disable SMT.   </p>
<h4 id="CPU-STAT"><a href="#CPU-STAT" class="headerlink" title="CPU STAT"></a>CPU STAT</h4><h5 id="kernel-parameters"><a href="#kernel-parameters" class="headerlink" title="kernel parameters"></a>kernel parameters</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cpuidle.off=1   [CPU_IDLE]</span><br><span class="line">                <span class="built_in">disable</span> the cpuidle sub-system</span><br><span class="line">cpuidle.governor=</span><br><span class="line">                [CPU_IDLE] Name of the cpuidle governor to use.</span><br><span class="line">cpufreq.off=1   [CPU_FREQ]</span><br><span class="line">                <span class="built_in">disable</span> the cpufreq sub-system</span><br><span class="line">cpufreq.default_governor=</span><br><span class="line"></span><br><span class="line">intel_idle.max_cstate=0 processor.max_cstate=0 idle=mwait</span><br><span class="line">idle=mwait C1 will be entered whenever the core is idle irrespective of other settings</span><br><span class="line">idle=poll keeps the processing cores <span class="keyword">in</span> C0 state when used <span class="keyword">in</span> conjunction with intel_idle.max_cstate=0</span><br><span class="line"></span><br><span class="line">https://zorrozou.github.io/docs/%E8%AF%A6%E8%A7%A3Cgroup%20V2.html</span><br><span class="line">or <span class="keyword">for</span> debian</span><br><span class="line">$ cset shield --cpu 1-4 --kthread=on</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=32-47,48-63 default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=nomwait&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="CPU-IDLE"><a href="#CPU-IDLE" class="headerlink" title="CPU IDLE"></a>CPU IDLE</h5><ul>
<li><p>Performance Per Watt (DAPC)<br>  - Dell Active Power Control</p>
</li>
<li><p>Performance Per Watt (OS)<br>  - OS DBPM</p>
</li>
<li><p>P-states – changing frequency and voltage of cores, to reduce power dissipation or increase performance</p>
</li>
<li><p>C-state – voltage and frequency gating for CPU cores</p>
</li>
<li><p>PC-state – voltage gating components of the CPU</p>
</li>
<li><p>S-state – sleep state, equivalent to halt</p>
</li>
<li><p>D-state – device power management </p>
</li>
<li><p>CC0 Normal operating state of the CPU where code is being executed </p>
</li>
<li><p>CC1 All threads on that core execute HLT or MWAIT (C1&#x2F;C1E) instruction. The core is in low power mode with low voltage and frequency. When returning to CC0, frequency and voltage are restored to the state before idle state. </p>
</li>
<li><p>C1E Same as CC1, but when exiting this state, the CPU start operating in LFM CC3 The contents of L1, L2 caches are flushed to LLC, and the core’s volt-age is lowered, and clock is stopped.  </p>
</li>
<li><p>CC6 The core saves its architectural state to SRAM, and the core is com-pletely powered down. </p>
</li>
<li><p>CC7 – CC10 These states are rarely used in Xeon CPUs, but if these states are im-plemented, they exhibit the same behaviour as CC6<br>It is important to note that a CPU has a special register call Time Stamp Counter (TSC). In Intel Xeon CPU, starting from Nehalem generation of CPUs, two generations prior to Ivy Bridge, TSC became C-state invariant, meaning that it never stops counting, and it also counts at a constant frequency.     </p>
</li>
<li><p>PC0 This is the normal operating state for the processor. The processor remains in the normal state when at least one of its processor IA cores is in the C0 or C1. Individual processor IA cores may be in deeper power idle states while the package is in C0 state. </p>
</li>
<li><p>PC2 Special package C-state not explicitly available to SW. There are two scenar-ios when this state is used:</p>
<ul>
<li>When deeper PC-states are off limits, and PC2 is the deepest PC-state</li>
<li>When the CPU is in PC3 state and a memory access request is received. In this case the CPU transitions to PC2, and completes all out-standing memory access requests, and then transitions back to PC3, or PC0 if there is a cause to wake from idle state.</li>
</ul>
</li>
<li><p>PC3 Package low power state </p>
</li>
<li><p>PC6 LLC Cache is flushed, and turned off </p>
</li>
<li><p>PC7 – PC10 Typically present only on Desktop CPUs, not on CPU meant for servers</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/drivers/idle/intel_idle.c</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cpuidle_state</span> <span class="title">skx_cstates</span>[] =</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">                .name = <span class="string">&quot;C1-SKX&quot;</span>,</span><br><span class="line">                .desc = <span class="string">&quot;MWAIT 0x00&quot;</span>,</span><br><span class="line">                .flags = MWAIT2flg(<span class="number">0x00</span>),</span><br><span class="line">                .exit_latency = <span class="number">2</span>,</span><br><span class="line">                .target_residency = <span class="number">2</span>,</span><br><span class="line">                .enter = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                .name = <span class="string">&quot;C1E-SKX&quot;</span>,</span><br><span class="line">                .desc = <span class="string">&quot;MWAIT 0x01&quot;</span>,</span><br><span class="line">                .flags = MWAIT2flg(<span class="number">0x01</span>),</span><br><span class="line">                .exit_latency = <span class="number">10</span>,</span><br><span class="line">                .target_residency = <span class="number">20</span>,</span><br><span class="line">                .enter = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                .name = <span class="string">&quot;C6-SKX&quot;</span>,</span><br><span class="line">                .desc = <span class="string">&quot;MWAIT 0x20&quot;</span>,</span><br><span class="line">                .flags = MWAIT2flg(<span class="number">0x20</span>) | CPUIDLE_FLAG_TLB_FLUSHED,</span><br><span class="line">                .exit_latency = <span class="number">133</span>,</span><br><span class="line">                .target_residency = <span class="number">600</span>,</span><br><span class="line">                .enter = &amp;intel_idle &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                .enter = <span class="literal">NULL</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>




</li>
<li><p><a target="_blank" rel="noopener" href="https://community.intel.com/t5/Software-Tuning-Performance/Monitoring-C1-and-C1E-core-c-state/m-p/1067363/highlight/true#M5233">intel cpu state</a><br>  - state0 “POLL” (cpu spin-waits because it is expected to get more work very soon – &lt; 10 microseconds)<br>  - state1 “C1-SKX” – default behavior of MWAIT with argument EAX&#x3D;0x00 – has 2 microsecond wakeup latency<br>  - state2 “C1E-SKX” – MWAIT with argument EAX&#x3D;0x01 – has 10 microsecond wakeup latency and drops core to maximum efficiency frequency<br>  - state3 “C6-SKX” – MWAIT with argument EAX&#x3D;0x20 – has 133 microsecond wakeup latency and turns off core (allowing more power to other cores)</p>
</li>
<li><p>idle&#x3D;poll</p>
<ul>
<li>idle&#x3D;poll is somewhat drastic in many cases, as preventing idle CPUs from saving almost any energy at all may not be the only effect of it.<ul>
<li>For example, on Intel hardware it effectively prevents CPUs from using P-states (see CPU Performance Scaling) that require any number of CPUs in a package to be idle, so it very well may hurt single-thread computations performance as well as energy-efficiency. Thus using it for performance reasons may not be a good idea at all</li>
</ul>
</li>
</ul>
</li>
<li><p>idle&#x3D;halt</p>
<ul>
<li>In the idle&#x3D;halt case, the architecture support code will use the HLT instruction of the CPUs (which, as a rule, suspends the execution of the program and causes the hardware to attempt to enter the shallowest available idle state) for this purpose, and if idle&#x3D;poll is used, idle CPUs will execute a more or lessa lightweight’’ sequence of instructions in a tight loop.</li>
</ul>
</li>
<li><p>idle&#x3D;nomwait</p>
<ul>
<li>The idle&#x3D;nomwait option disables the intel_idle driver and causes acpi_idle to be used (as long as all of the information needed by it is there in the system’s ACPI tables), but it is not allowed to use the MWAIT instruction of the CPUs to ask the hardware to enter idle states.</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.0/admin-guide/pm/cpuidle.html">In addition to the architecture-level kernel command line options affecting CPU idle time management, there are parameters affecting individual CPUIdle drivers that can be passed to them via the kernel command line. Specifically, the intel_idle.max_cstate&#x3D;<n> and processor.max_cstate&#x3D;<n> parameters, where <n> is an idle state index also used in the name of the given state’s directory in sysfs (see Representation of Idle States), causes the intel_idle and acpi_idle drivers, respectively, to discard all of the idle states deeper than idle state <n></a></p>
<p>By booting with the kernel command line argument processor.max_cstate&#x3D;1 and idle&#x3D;poll the system will never enter a C-state other than zero and will not even use the MWAIT mechanism to temporarily halt in the idle routine. While this will provide the fastest scheduler response time, it is very wasteful of power and will generate heat that requires the air conditioning system to run (and waste more power).       </p>
<p>This method is not recommended for general use, but can be quite handy for testing whether your application is being affected by cstates and idle transition latency. Booting your kernel and adding the commandline options: processor.max_cstate&#x3D;1 idle&#x3D;poll     </p>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/articles/65410">The second method, which has a bit more fine-grained control of the power management features, is to use the Power Management Quality of Service interface (PM QOS). The file &#x2F;dev&#x2F;cpu_dma_latency is the interface which when opened registers a quality-of-service request for latency with the operating system. A program should open &#x2F;dev&#x2F;cpu_dma_latency, write a 32-bit number to it representing a maximum response time in microseconds and then keep the file descriptor open while low-latency operation is desired.  Writing a zero means that you want the fastest response time</a><br><a target="_blank" rel="noopener" href="https://gist.github.com/SaveTheRbtz/f5e8d1ca7b55b6a7897b">Set the cpu_dma_latency</a>    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2009 Johannes Berg &lt;johannes@sipsolutions.net&gt;</span></span><br><span class="line"><span class="comment"> * Copyright 2010 Luis R. Rodriguez &lt;lrodriguez@atheros.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Permission to use, copy, modify, and/or distribute this software for any</span></span><br><span class="line"><span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span></span><br><span class="line"><span class="comment"> * copyright notice and this permission notice appear in all copies.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span></span><br><span class="line"><span class="comment"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span></span><br><span class="line"><span class="comment"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span></span><br><span class="line"><span class="comment"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span></span><br><span class="line"><span class="comment"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span></span><br><span class="line"><span class="comment"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span></span><br><span class="line"><span class="comment"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Compile simply with:</span></span><br><span class="line"><span class="comment"> *	cc -o cpudmalatency cpudmalatency.c	</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Some unpatched buggy BIOSes create excessive C-state transition latencies</span></span><br><span class="line"><span class="comment"> * which can affect DMA on some devices. Instead of patching each and every</span></span><br><span class="line"><span class="comment"> * Linux kernel driver to account for these inefficiencies - lets punt these</span></span><br><span class="line"><span class="comment"> * work arounds to userspace. Linux distributions will hopefully have a way</span></span><br><span class="line"><span class="comment"> * to automatically detect these buggy platforms and call this. Note that</span></span><br><span class="line"><span class="comment"> * this app will hold the file open.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int32_t</span> v;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;latency [us]&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;	latency: the maximum tolerable CPU DMA you\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;	         are willing to put up with [in microseconds]\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This program will block until you hit Ctrl-C, at which point\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;the file descriptor is closed and the latency requirement is\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;unregistered again.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Hint: if you have an platform with a buggy BIOS that has\n&quot;</span>);</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;issues with excessive C-state transition latencies try value 55\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;setting latency to %d.%.6d seconds\n&quot;</span>, v/<span class="number">1000000</span>, v % <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">&quot;/dev/cpu_dma_latency&quot;</span>, O_WRONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open /dev/cpu_dma_latency&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, &amp;v, <span class="keyword">sizeof</span>(v)) != <span class="keyword">sizeof</span>(v)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;write to /dev/cpu_dma_latency&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://huataihuang.gitbooks.io/cloud-atlas/content/os/linux/kernel/cpu/intel_pstate.html">intel_pstate for more info</a><br><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cpuidle/sysfs.txt">cpuidle work with linux</a>    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># disable turbo in intel_pstate</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /sys/devices/system/cpu/intel_pstate/no_turbo</span><br><span class="line"><span class="comment"># acpi-cpufreq disable</span></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpufreq/boost</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line">$ ./cpudmalatency 20</span><br><span class="line">setting latency to 0.000020 seconds</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /sys/devices/system/cpu/cpu0/cpuidle/</span><br><span class="line">state0  state1  state2  state3  state4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## Option to disable this idle state (bool, 1 disable idle, 0 enable)</span></span><br><span class="line"><span class="built_in">echo</span> 1 | <span class="built_in">tee</span> -a /sys/devices/system/cpu/cpu*/cpuidle/state*/disable</span><br><span class="line"></span><br><span class="line"><span class="comment">## mode</span></span><br><span class="line"><span class="built_in">cat</span> /sys/devices/system/cpu/cpu0/cpuidle/state*/name</span><br><span class="line">POLL</span><br><span class="line">C1-HSW</span><br><span class="line">C1E-HSW</span><br><span class="line">C3-HSW</span><br><span class="line">C6-HSW <span class="comment">### C6   Deep Power Down         Reduces the CPU internal voltage to any value, including 0 V</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Latency to exit out of this idle state (in microseconds)</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu0/cpuidle/state*/latency</span><br><span class="line">0</span><br><span class="line">2</span><br><span class="line">10</span><br><span class="line">33</span><br><span class="line">133</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you could not get the cpu freq from &quot;cpupower frequency-info&quot;</span></span><br><span class="line"><span class="comment"># use the command</span></span><br><span class="line">cpupower monitor -m Mperf</span><br><span class="line">cpupower frequency-set -g performance</span><br><span class="line">cpupower idle-set -d 0</span><br><span class="line">cpupower idle-set -d 1</span><br><span class="line">cpupower idle-set -d 2</span><br><span class="line">cpupower idle-set -d 3</span><br><span class="line">cpupower idle-set -d 4</span><br><span class="line">tuned-adm profile throughput-performance</span><br><span class="line">tuned-adm active</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#direct set the latency</span></span><br><span class="line">$ cpupower idle-set -D 133 <span class="comment">##enable 0,1,2,3 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 33  <span class="comment">##enable 0,1,2 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 10  <span class="comment">##enable 0,1 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 2   <span class="comment">##enable 0 and disable 4</span></span><br><span class="line">$ cpupower idle-set -D 0   <span class="comment">##disable 0,1,2,3,4</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/support/articles/000006619/processors/intel-core-processors.html">intel-core-idle-info</a></p>
<ul>
<li><p>CPU&#x2F;Package sleep states</p>
<ul>
<li>C0 - Active: CPU is on and operating.</li>
<li>C1 - Auto Halt: Core clock is off. The processor is not executing instructions, but can return to an executing state almost instantaneously. Some processors also support an enhanced C1 state (C1E) for lower power consumption.</li>
<li>C2 - Stop Clock: Core and bus clocks are off. The processor maintains all software-visible state, but can take longer to wake up.</li>
<li>C3 - Deep Sleep: Clock generator is off. The processor does not need to keep its cache coherent, but maintains other states. Some processors have variations of the C3 state (Deep Sleep, Deeper Sleep) that differ by how long it takes to wake the processor.</li>
<li>C4 - Deeper Sleep: Reduced VCC</li>
<li>DC4 - Deeper C4 Sleep: Further reduced VCC</li>
</ul>
</li>
<li><p>ACPI (Advanced Configuration and Power Interface)   </p>
<ul>
<li>The ACPI on the System Manageability Bus enables low-power sleep mode and conserves energy when a system is idle.</li>
</ul>
</li>
<li><p>Power management</p>
<ul>
<li>How power is efficiently directed to different components of a system. Power management is especially important for portable devices that rely on battery power. By reducing power to components that are not being used, a good power management system can double or triple the lifetime of a battery.</li>
</ul>
</li>
<li><p>Deeper Sleep</p>
<ul>
<li>Works along with Intel® QuickStart technology on Intel® Mobile Processors. Deeper Sleep is a dynamic power management mode that delivers longer battery life. Deeper Sleep minimizes the power consumption of the CPU when it senses an extended period of inactivity by the user. It reduces power when idle and quickly restores the CPU to an active state as soon as the user resumes use of the system. It reduces processor voltage below the minimum operating voltage while preserving the processor state. Deeper Sleep is functionally identical to the Deep Sleep State but at a 66 percent lower voltage.</li>
</ul>
</li>
<li><p>QuickStart technology</p>
<ul>
<li>Extends battery life by entering a low-power state during the briefest pauses in user activity, such as between key strokes. Instantly returns to full-power state when prompted.</li>
</ul>
</li>
<li><p>Intel® Enhanced Deeper Sleep with Dynamic Cache Sizing</p>
<ul>
<li>This new power savings mechanism flushes system memory dynamically, based on demand or during periods of inactivity. Power savings occur as the cache ways are turned off once the data has been saved in memory. L2 cache data integrity determines Deeper Sleep minimum voltage limits for the Intel® Core™ Duo processor. Once the Dynamic Cache Sizing feature flushes the entire L2 cache to memory, the processor transitions to Intel® Enhanced Deeper Sleep. This allows the processor to lower voltage below the Deeper Sleep minimum voltage for enhanced power savings and&#x2F;or efficiencies.</li>
</ul>
</li>
<li><p>Mwait is a special instruction in CPUs which essentially instructs the CPU to enter power saving mode. Mwait can be called in a variety of ways. Mwait can be called with a time hint, to tell the CPU for how long it should be idle. Mwait can also be called with a hint for C-state. Intel_idle passes the information from idle governor to the hardware by call-ing mwait with hints to desired C-state<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.19.163/source/drivers/idle/intel_idle.c#L1115">source code</a>   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">call_cpuidle() &#123;</span><br><span class="line">  cpuidle_enter() &#123;</span><br><span class="line">    cpuidle_enter_state() &#123;</span><br><span class="line">      sched_idle_set_state();</span><br><span class="line">      intel_idle() &#123;</span><br><span class="line">        leave_mm();</span><br><span class="line">        mwait_idle_with_hints.constprop<span class="number">.2</span>();</span><br><span class="line">      &#125;</span><br><span class="line">     sched_idle_set_state();</span><br><span class="line">     arch_local_irq_enable() &#123;</span><br><span class="line">       do_IRQ() &#123;</span><br><span class="line">         irq_enter() &#123;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set the maximum frequency</span></span><br><span class="line">$ cpupower frequency-set -u 2.8G</span><br><span class="line">$ cpupower frequency-set -d 2.0G</span><br><span class="line">$ <span class="built_in">echo</span> 3000000 | <span class="built_in">tee</span> /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpuidle/current_driver</span><br><span class="line">intel_idle</span><br><span class="line"></span><br><span class="line"><span class="comment">#switch driver</span></span><br><span class="line">$ modprobe -r acpi_cpufreq</span><br><span class="line">$ modprobe intel_pstate</span><br><span class="line"></span><br><span class="line"><span class="comment">#or in the lower OS</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;install acpi_cpufreq /sbin/modprobe intel_pstate&#x27;</span> &gt;/etc/modprobe.d/cpu.conf</span><br><span class="line">$ dracut -f --add-drivers intel_pstate</span><br><span class="line"><span class="comment">#The intel_pstate driver was added later during RHEL6 life cycle and is available in our kernel since RHEL6.5, but Red Hat decided to keep acpi_cpufreq as default to prevent any potential compatibility issues.</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /usr/lib/modules/$(<span class="built_in">uname</span> -r)/kernel/drivers/cpufreq/</span><br><span class="line">acpi-cpufreq.ko.xz          cpufreq_stats.ko.xz  pcc-cpufreq.ko.xz  speedstep-lib.ko.xz</span><br><span class="line">amd_freq_sensitivity.ko.xz  p4-clockmod.ko.xz    powernow-k8.ko.xz</span><br><span class="line"></span><br><span class="line">$ cpupower frequency-info --driver</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line"></span><br><span class="line">$ cpupower frequency-info --governors</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/intel_pstate/status</span><br><span class="line">active</span><br><span class="line">$ <span class="built_in">echo</span> off | sudo <span class="built_in">tee</span> /sys/devices/system/cpu/intel_pstate/status</span><br><span class="line">off</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> acpi-cpufreq &gt; /sys/devices/system/cpu/cpu2/cpufreq/scaling_driver</span><br><span class="line">-bash: /sys/devices/system/cpu/cpu2/cpufreq/scaling_driver: Permission denied</span><br><span class="line"><span class="comment"># can&#x27;t reload the driver</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cpuid show all cpu features</span></span><br><span class="line">$ cpuid -1 -l5</span><br><span class="line">Disclaimer: cpuid may not support decoding of all cpuid registers.</span><br><span class="line">CPU:</span><br><span class="line">   MONITOR/MWAIT (5):</span><br><span class="line">      smallest monitor-line size (bytes)       = 0x40 (64)</span><br><span class="line">      largest monitor-line size (bytes)        = 0x40 (64)</span><br><span class="line">      enum of Monitor-MWAIT exts supported     = <span class="literal">true</span></span><br><span class="line">      supports intrs as break-event <span class="keyword">for</span> MWAIT  = <span class="literal">true</span></span><br><span class="line">      number of C0 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C1 sub C-states using MWAIT    = 0x2 (2)</span><br><span class="line">      number of C2 sub C-states using MWAIT    = 0x1 (1)</span><br><span class="line">      number of C3 sub C-states using MWAIT    = 0x2 (2)</span><br><span class="line">      number of C4 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C5 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C6 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line">      number of C7 sub C-states using MWAIT    = 0x0 (0)</span><br><span class="line"></span><br><span class="line">$ cpuid -1 -l6</span><br><span class="line">Disclaimer: cpuid may not support decoding of all cpuid registers.</span><br><span class="line">CPU:</span><br><span class="line">   Thermal and Power Management Features (6):</span><br><span class="line">      digital thermometer                     = <span class="literal">true</span></span><br><span class="line">      Intel Turbo Boost Technology            = <span class="literal">true</span></span><br><span class="line">      ARAT always running APIC timer          = <span class="literal">true</span></span><br><span class="line">      PLN power <span class="built_in">limit</span> notification            = <span class="literal">true</span></span><br><span class="line">      ECMD extended clock modulation duty     = <span class="literal">true</span></span><br><span class="line">      PTM package thermal management          = <span class="literal">true</span></span><br><span class="line">      HWP base registers                      = <span class="literal">false</span></span><br><span class="line">      HWP notification                        = <span class="literal">false</span></span><br><span class="line">      HWP activity window                     = <span class="literal">false</span></span><br><span class="line">      HWP energy performance preference       = <span class="literal">false</span></span><br><span class="line">      HWP package level request               = <span class="literal">false</span></span><br><span class="line">      HDC base registers                      = <span class="literal">false</span></span><br><span class="line">      digital thermometer thresholds          = 0x2 (2)</span><br><span class="line">      ACNT/MCNT supported performance measure = <span class="literal">true</span></span><br><span class="line">      ACNT2 available                         = <span class="literal">false</span></span><br><span class="line">      performance-energy bias capability      = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><a href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform" class="headerlink" title="Application multiple threads get down to single core cause performance issue in intel skylake platform"></a>Application multiple threads get down to single core cause performance issue in intel skylake platform</h4><ul>
<li>The test CPU was Intel 2x Silver 4116</li>
<li>Default OS version was 3.10.0-862.el7.x86_64<br>  - Pstate enabled in BIOS, I don’t know why it ‘s not work<br>  - <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/7.7_release_notes/index#enhancement_kernel">RHEL 7.7 release note BZ#1698453</a> The intel_pstate driver loads on the Intel Skylake-X systems with HWP disabled<br>  - How to avoid this get down to single core<br>          - Upgrade kernel to RHEL 7.7+<br>          - Disable Hyper threading</li>
<li>if you set BIOS to performance mode, HWP(Hardware-Controlled Performance States) will be disabled cause not loading intel_pstate<br>  - <a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-pm/patch/20180110193852.63667-2-srinivas.pandruvada@linux.intel.com/">cpufreq: intel_pstate: Add Skylake servers support</a></li>
</ul>
<p>Looks like acpi-cpu-freq not support Turbo mode for each cores</p>
<p>Before upgrade</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### intel pstat 3.6GHz</span></span><br><span class="line"> cpupower  frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 1.20 GHz - 3.70 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 1.20 GHz and 3.70 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 3.60 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: <span class="built_in">yes</span></span><br><span class="line">    Active: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACPI-cpufreq only 3.4GHz, not 3.6GHz</span></span><br><span class="line"></span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 1.20 GHz - 3.40 GHz</span><br><span class="line">  available frequency steps:  3.40 GHz, 3.40 GHz, 3.30 GHz, 3.10 GHz, 3.00 GHz, 2.80 GHz, 2.70 GHz, 2.50 GHz, 2.30 GHz, 2.20 GHz, 2.00 GHz, 1.90 GHz, 1.70 GHz, 1.60 GHz, 1.40 GHz, 1.20 GHz</span><br><span class="line">  available cpufreq governors: conservative userspace powersave ondemand performance</span><br><span class="line">  current policy: frequency should be within 1.20 GHz and 3.40 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 3.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: <span class="built_in">yes</span></span><br><span class="line">    Active: <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>After upgarde   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 3.00 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.00 GHz.</span><br><span class="line">                  The governor <span class="string">&quot;performance&quot;</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 2.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: <span class="built_in">yes</span></span><br><span class="line">    Active: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Single core</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">11671 root      20   0   66.6g  64.1g   2176 S  14.3 40.9   5741:29 xxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#Multiple cores</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">19663 root      20   0   41.5g  40.6g   3680 S  2235 25.9 830:58.64 xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<h4 id="E3-v6-Turbo-not-support-under-the-CentOS6"><a href="#E3-v6-Turbo-not-support-under-the-CentOS6" class="headerlink" title="E3 v6 Turbo not support under the CentOS6"></a>E3 v6 Turbo not support under the CentOS6</h4><p>The status is wrong, when you benchmark the CPU, you will got the turbo worked.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ cpupower frequency-set --governor ondemand/powersave/performance</span><br><span class="line"></span><br><span class="line">CentOS 6</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line">3701000</span><br><span class="line"></span><br><span class="line">CentOS 7</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">4100000</span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br><span class="line">3899859</span><br></pre></td></tr></table></figure>

<h4 id="Isolated-CPUs-example"><a href="#Isolated-CPUs-example" class="headerlink" title="Isolated CPUs example"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/isolating_cpus_using_tuned-profiles-realtime">Isolated CPUs example</a></h4><ul>
<li>isolcpus: Isolate a given set of CPUs from disturbance. Deprecated - use cpusets instead<ul>
<li><a target="_blank" rel="noopener" href="https://www.codeblueprint.co.uk/2019/10/08/isolcpus-is-deprecated-kinda.html">It prevent all kernel tasks from running there and, crucially, it prevents the Linux scheduler load balancer from placing tasks on those CPUs too</a></li>
<li>isolcpus disabled the scheduler load balancer for CPUs 1-4 (eg: isolcpus&#x3D;1-4)</li>
<li>How to use<ul>
<li>isolcpus&#x3D;1-4 and you use taskset to place your four vCPU tasks on to those isolated CPUs like so: taskset -c 1-4 -p <task pid><ul>
<li>show the process and CPU core number: “ps -aLo comm,psr”</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Isolating CPUs generally involves:<br>removing all user-space threads;<br>removing any unbound kernel threads (bound kernel threads are tied to a specific CPU and may not be moved);<br>removing interrupts by modifying the &#x2F;proc&#x2F;irq&#x2F;N&#x2F;smp_affinity property of each Interrupt Request (IRQ) number N in the system.</p>
<p>Plan out CPU allocation, e.g.<br>        * CPUs should NOT be used for more than one task.<br>        * CPUs for host OS<br>        * CPUs for XVIO<br>        * CPUs for VMs<br>                * CPUs for guest OS<br>                * CPUs for VNF or application</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ yum install tuned tuned-profiles-realtime</span><br><span class="line">$ <span class="built_in">cat</span> /etc/tuned/realtime-variables.conf</span><br><span class="line">isolated_cores=0-3,5,7</span><br><span class="line">$ tuned-adm profile realtime</span><br><span class="line">$ grep isolcpus /proc/cmdline</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=32-47,48-63 default_hugepagesz=1GB hugepagesz=1G hugepages=12 intel_idle.max_cstate=0 processor.max_cstate=0 idle=nomwait&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/cpu-Isolated-334379.png"></p>
<h5 id="use-the-isolated-core"><a href="#use-the-isolated-core" class="headerlink" title="use the isolated core"></a>use the isolated core</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&quot;isolcpus=2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## run the benchmark for all cores, you could see the core 2 not worked</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()</span><br><span class="line">&#123;  </span><br><span class="line">   fork();</span><br><span class="line">   fork();</span><br><span class="line">   fork();</span><br><span class="line">   <span class="keyword">while</span>(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## you could taskset to core 2</span></span><br><span class="line">$ taskset -c 2 ./your_app</span><br><span class="line"></span><br><span class="line"><span class="comment">## isolate the kernel thread and interrupt</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/..../smp_affinity</span><br><span class="line">fb</span><br><span class="line">fb = 11111011</span><br><span class="line">          |</span><br><span class="line">          -----avoid the core 2</span><br></pre></td></tr></table></figure>
<p>the author show the timer tick in the core 2 too<br>The kernel docs <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/timers/no_hz.html">NO_HZ</a></p>
<ul>
<li>ever omit scheduling-clock ticks (CONFIG_HZ_PERIODIC&#x3D;y or CONFIG_NO_HZ&#x3D;n for older kernels). You normally will -not- want to choose this option.</li>
<li>Omit scheduling-clock ticks on idle CPUs (CONFIG_NO_HZ_IDLE&#x3D;y or CONFIG_NO_HZ&#x3D;y for older kernels). This is the most common approach, and should be the default.</li>
<li>Omit scheduling-clock ticks on CPUs that are either idle or that have only one runnable task (CONFIG_NO_HZ_FULL&#x3D;y). Unless you are running realtime applications or certain types of HPC workloads, you will normally -not- want this option.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /boot/config-5.11.0-25-generic | grep NO_HZ_FULL</span><br><span class="line"><span class="comment"># CONFIG_NO_HZ_FULL is not set</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## recomplie the kernel</span></span><br><span class="line">CONFIG_NO_HZ_FULL=y</span><br><span class="line">(x) Full dynticks system(tickless)</span><br></pre></td></tr></table></figure>

<p>Only one job in core 2, the timer interrupt will not increase…. not test, just record<br>and he use dma-map-benchmark to run DMA map and unmap, the core 2 not work too  </p>
<ul>
<li>In the HPC env<ul>
<li>isolcpus these cores<ul>
<li>pin the HPC job to these cores(part 1)</li>
<li>pin the interrupt and kernel threads to another cores(part 2)</li>
<li>CONFIG_NO_HZ_FULL&#x3D;y and running single job to each core</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="gcc-x86-options"><a href="#gcc-x86-options" class="headerlink" title="gcc_x86_options"></a><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html">gcc_x86_options</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">-march=cpu-type</span><br><span class="line">Generate instructions <span class="keyword">for</span> the machine <span class="built_in">type</span> cpu-type. </span><br><span class="line"></span><br><span class="line">-mtune=cpu-type ; only generic and intel</span><br><span class="line">Tune to cpu-type everything applicable about the generated code, except <span class="keyword">for</span> the ABI and the <span class="built_in">set</span> of available instructions. </span><br><span class="line"></span><br><span class="line">-mincoming-stack-boundary=num</span><br><span class="line">Assume the incoming stack is aligned to a 2 raised to num byte boundary. If -mincoming-stack-boundary is not specified, the one specified by -mpreferred-stack-boundary is used.</span><br><span class="line">-mmmx</span><br><span class="line">-msse</span><br><span class="line">-msse2</span><br><span class="line">-msse3</span><br><span class="line">-mssse3</span><br><span class="line">-msse4</span><br><span class="line">-msse4a</span><br><span class="line">-msse4.1</span><br><span class="line">-msse4.2</span><br><span class="line">-mavx</span><br><span class="line">-mavx2</span><br><span class="line">-mavx512f</span><br><span class="line">-mavx512pf</span><br><span class="line">-mavx512er</span><br><span class="line">-mavx512cd</span><br><span class="line">-mavx512vl</span><br><span class="line">-mavx512bw</span><br><span class="line">-mavx512dq</span><br><span class="line">-mavx512ifma</span><br><span class="line">-mavx512vbmi</span><br><span class="line">-mavx512vbmi2</span><br><span class="line">-mavx512bf16</span><br><span class="line">-mavx512vpopcntdq</span><br><span class="line">-mavx512vp2intersect</span><br><span class="line">-mavx5124fmaps</span><br><span class="line">-mavx512vnni</span><br><span class="line">-mavx5124vnniw</span><br><span class="line">-mcldemote</span><br><span class="line">.... <span class="comment">## too many</span></span><br><span class="line">-mprefer-vector-width=opt</span><br><span class="line">This option instructs GCC to use opt-bit vector width <span class="keyword">in</span> instructions instead of default on the selected platform.</span><br><span class="line">none/128/256/512</span><br><span class="line"></span><br><span class="line"><span class="comment">#test Makefile</span></span><br><span class="line">CFLAGS = -m64 -Wall -O3 -fopenmp</span><br><span class="line">CFLAGS = -m64 -g -Wall -fopenmp -lpthread -march=broadwell -mavx2 -mprefer-vector-width=256</span><br><span class="line">CFLAGS = -m64 -g -Wall -fopenmp -lpthread -march=skylake-avx512 -mprefer-vector-width=512 -mavx512pf</span><br><span class="line"></span><br><span class="line"><span class="comment">#show the CPU arch</span></span><br><span class="line">$ gcc -march=native -Q --<span class="built_in">help</span>=target</span><br><span class="line">$ gcc -march=native -Q --<span class="built_in">help</span>=target|grep march</span><br><span class="line">-march=                               broadwell</span><br></pre></td></tr></table></figure>

<h4 id="Disable-features-AVX"><a href="#Disable-features-AVX" class="headerlink" title="Disable features AVX"></a><a target="_blank" rel="noopener" href="https://www.ibm.com/support/pages/how-disable-cpu-feature-flag-hle-hardware-lock-elision-rhel-x86-intel">Disable features AVX</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">CentOS 8.5 </span><br><span class="line"></span><br><span class="line">linux-4.18.0-305.el8/arch/x86/include/asm/cpufeatures.h</span><br><span class="line"></span><br><span class="line"><span class="comment">#define X86_FEATURE_HLE                 ( 9*32+ 4) /* Hardware Lock Elision */ 292</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX                 ( 4*32+28) /* Advanced Vector Extensions */ 156</span></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX2                ( 9*32+ 5) /* AVX2 instructions */   293</span></span><br><span class="line"><span class="comment">#define X86_FEATURE_AVX512F             ( 9*32+16) /* AVX-512 Foundation */  304</span></span><br><span class="line"></span><br><span class="line">$ grep -io avx2 /proc/cpuinfo </span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line">avx2</span><br><span class="line"></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;clearcpuid=293&#x27;</span></span><br><span class="line"></span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line">$ grep -io avx2 /proc/cpuinfo </span><br><span class="line"><span class="comment"># no output, grep failed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add another flag</span></span><br><span class="line">$ grep -io hle /proc/cpuinfo</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line">hle</span><br><span class="line"></span><br><span class="line"><span class="comment">## support from linux 5.10</span></span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;clearcpuid=292,293,304&#x27;</span> </span><br><span class="line">$ reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">## https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0a4bb5e5507a585532cc413125b921c8546fc39f</span></span><br><span class="line">x86/fpu: Allow multiple bits <span class="keyword">in</span> clearcpuid= parameter</span><br><span class="line">The Linux 5.10 support multile bits</span><br><span class="line">compare with the centos 8.5 <span class="built_in">source</span> code, it <span class="string">&#x27;s not support multiple bits</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/introduction-to-intel-advanced-vector-extensions">disable AVX again</a><br>To use the Intel AVX extensions reliably in most settings, the operating system must support saving and loading the new registers (with XSAVE&#x2F;XRSTOR) on thread context switches to prevent data corruption. To help avoid such errors, operating systems supporting Intel AVX-aware context switches explicitly set a CPU bit enabling the new instructions; otherwise, an undefined opcode (#UD) exception is generated when Intel AVX instructions are used.</p>
<p>Add kernel parameter to disable AVX </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">        noxsave         [BUGS=X86] Disables x86 extended register state save</span><br><span class="line">                        and restore using xsave. The kernel will fallback to</span><br><span class="line">                        enabling legacy floating-point and sse state.</span><br><span class="line"></span><br><span class="line">        noxsaveopt      [X86] Disables xsaveopt used <span class="keyword">in</span> saving x86 extended</span><br><span class="line">                        register states. The kernel will fall back to use</span><br><span class="line">                        xsave to save the states. By using this parameter,</span><br><span class="line">                        performance of saving the states is degraded because</span><br><span class="line">                        xsave doesn<span class="string">&#x27;t support modified optimization while</span></span><br><span class="line"><span class="string">                        xsaveopt supports it on xsaveopt enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        noxsaves        [X86] Disables xsaves and xrstors used in saving and</span></span><br><span class="line"><span class="string">                        restoring x86 extended register state in compacted</span></span><br><span class="line"><span class="string">                        form of xsave area. The kernel will fall back to use</span></span><br><span class="line"><span class="string">                        xsaveopt and xrstor to save and restore the states</span></span><br><span class="line"><span class="string">                        in standard form of xsave area. By using this</span></span><br><span class="line"><span class="string">                        parameter, xsave area per process might occupy more</span></span><br><span class="line"><span class="string">                        memory on xsaves enabled systems.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cpuid | grep XSAVE -i | head</span></span><br><span class="line"><span class="string">Disclaimer: cpuid may not support decoding of all cpuid registers.</span></span><br><span class="line"><span class="string">      FXSAVE/FXRSTOR                         = true</span></span><br><span class="line"><span class="string">      XSAVE/XSTOR states                      = true</span></span><br><span class="line"><span class="string">      OS-enabled XSAVE/XSTOR                  = true</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/0):</span></span><br><span class="line"><span class="string">      bytes required by XSAVE/XRSTOR area     = 0x00000340 (832)</span></span><br><span class="line"><span class="string">   XSAVE features (0xd/1):</span></span><br><span class="line"><span class="string">      XSAVEOPT instruction                        = true</span></span><br><span class="line"><span class="string">      XSAVEC instruction                          = false</span></span><br><span class="line"><span class="string">      XSAVES/XRSTORS instructions                 = false</span></span><br><span class="line"><span class="string">      64-byte alignment in compacted XSAVE     = false</span></span><br></pre></td></tr></table></figure>

<h4 id="Ban-half-core-try-to-not-running-HT"><a href="#Ban-half-core-try-to-not-running-HT" class="headerlink" title="Ban half core, try to not running HT"></a>Ban half core, try to not running HT</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ((i=0;i&lt;$(grep -c processor /proc/cpuinfo);i++)); </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  <span class="built_in">cat</span> /sys/devices/system/cpu/cpu<span class="variable">$i</span>/cache/index2/shared_cpu_list; </span><br><span class="line"><span class="keyword">done</span> | awk -F, <span class="string">&#x27;&#123;a[$1]=$0&#125; END&#123;</span></span><br><span class="line"><span class="string">  count=0;</span></span><br><span class="line"><span class="string">  for (i in a) &#123;</span></span><br><span class="line"><span class="string">     if(count==0) &#123;</span></span><br><span class="line"><span class="string">       printf i</span></span><br><span class="line"><span class="string">     &#125; else &#123;</span></span><br><span class="line"><span class="string">       printf &quot;,&quot;i</span></span><br><span class="line"><span class="string">     &#125;;</span></span><br><span class="line"><span class="string">       count++</span></span><br><span class="line"><span class="string">  &#125; </span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">17,4,18,5,19,6,7,8,9,10,11,12,13,0,14,1,15,2,16,3</span><br></pre></td></tr></table></figure>

<h4 id="Turn-off-the-cpu-cores-under-linux"><a href="#Turn-off-the-cpu-cores-under-linux" class="headerlink" title="Turn off the cpu cores under linux"></a>Turn off the cpu cores under linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpu17/online</span><br></pre></td></tr></table></figure>

<h4 id="intel-cmt-cat"><a href="#intel-cmt-cat" class="headerlink" title="intel-cmt-cat"></a>intel-cmt-cat</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ yum install intel-cmt-cat.x86_64</span><br><span class="line"></span><br><span class="line">TIME 2020-01-07 17:54:05</span><br><span class="line">           LLC(Last Level Cache): CMT(Cache Monitoring Technology) Cache Occupancy</span><br><span class="line">           MBL:MBM local bandwidth</span><br><span class="line">           MBR:MBM Remote bandwidth</span><br><span class="line">$ pqos</span><br><span class="line">    CORE   IPC   MISSES     LLC[KB]   MBL[MB/s]   MBR[MB/s]</span><br><span class="line"></span><br><span class="line">       0  0.26       6k      1080.0         0.2         0.0</span><br><span class="line">       1  0.26       0k         0.0         0.0         0.0</span><br><span class="line">       2  0.27       4k      4600.0         0.5         0.0</span><br><span class="line">       3  0.26       5k       520.0         0.0         0.2</span><br><span class="line">       4  0.27       8k      1120.0         0.7         0.1</span><br><span class="line">       5  0.25      12k      1080.0         0.7         0.2</span><br><span class="line">       6  0.28      18k      1040.0         0.9         0.1</span><br><span class="line">       7  0.25       0k         0.0         0.0         0.0</span><br><span class="line">       8  0.27       4k      3400.0         0.2         0.1</span><br><span class="line">       9  0.25       0k      1360.0         0.1         0.1</span><br><span class="line">      10  0.26      14k      7000.0         1.3         0.0</span><br><span class="line">      11  0.39       1k       120.0         0.0         0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>L3 misses&#x2F;s (LUR, more L3 and lower misses in some case)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/intel/intel-cmt-cat/wiki/Usage-Examples">Usage-example</a></p>
<p>Cache Monitoring Technology (CMT)<br>Cache Allocation Technology (CAT)<br>Memory Bandwidth Monitoring (MBM)<br>Memory Bandwidth Allocation (MBA)<br>Code and Data Prioritization (CDP)</p>
<h4 id="Linux-process-with-CPU"><a href="#Linux-process-with-CPU" class="headerlink" title="Linux process with CPU"></a>Linux process with CPU</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/stat</span><br><span class="line">    user <span class="built_in">nice</span> system idle  iowait irq softirq steal guest  guest_nice</span><br><span class="line">cpu  602  8    786  680812 901    0   13      29    0      0</span><br><span class="line"></span><br><span class="line"><span class="comment"># steal</span></span><br><span class="line">Stolen time, <span class="built_in">which</span> is the time spent <span class="keyword">in</span> other operating systems when running <span class="keyword">in</span> a virtualized environment</span><br><span class="line"></span><br><span class="line">$ getconf CLK_TCK</span><br><span class="line">100</span><br><span class="line"></span><br><span class="line">cpuTime = 1000ull * 1000ull * 1000ull * (usertime + systime) / (unsigned long long)sysconf(_SC_CLK_TCK);</span><br></pre></td></tr></table></figure>

<h4 id="numa"><a href="#numa" class="headerlink" title="numa"></a>numa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">numastat -nc</span><br><span class="line"></span><br><span class="line">Per-node numastat info (<span class="keyword">in</span> MBs):</span><br><span class="line">                 Node 0  Node 1    Total</span><br><span class="line">                ------- ------- --------</span><br><span class="line">Numa_Hit        6966101 4861306 11827407</span><br><span class="line">Numa_Miss         47509    2039    49548</span><br><span class="line">Numa_Foreign       2039   47509    49548</span><br><span class="line">Interleave_Hit      142     142      284</span><br><span class="line">Local_Node      6966031 4861115 11827145</span><br><span class="line">Other_Node        47579    2231    49810</span><br><span class="line"></span><br><span class="line">numastat -mc</span><br><span class="line"></span><br><span class="line">Per-node system memory usage (<span class="keyword">in</span> MBs):</span><br><span class="line">                 Node 0 Node 1  Total</span><br><span class="line">                 ------ ------ ------</span><br><span class="line">MemTotal          64214  64464 128678</span><br><span class="line">MemFree            3895  25196  29091</span><br><span class="line">MemUsed           60319  39267  99586</span><br><span class="line">Active            37061  36103  73163</span><br><span class="line">Inactive          20956    779  21735</span><br><span class="line">Active(anon)         23     24     47</span><br><span class="line">Inactive(anon)       26     25     51</span><br><span class="line">Active(file)      37038  36079  73117</span><br><span class="line">Inactive(file)    20931    754  21685</span><br><span class="line">Unevictable           0      0      0</span><br><span class="line">Mlocked               0      0      0</span><br><span class="line">Dirty                 0      0      0</span><br><span class="line">Writeback             0      0      0</span><br><span class="line">FilePages         57994  36858  94852</span><br><span class="line">Mapped               23      6     29</span><br><span class="line">AnonPages            23     24     47</span><br><span class="line">Shmem                25     25     50</span><br><span class="line">KernelStack           5      4      9</span><br><span class="line">PageTables            1      2      4</span><br><span class="line">NFS_Unstable          0      0      0</span><br><span class="line">Bounce                0      0      0</span><br><span class="line">WritebackTmp          0      0      0</span><br><span class="line">Slab               1073   1122   2195</span><br><span class="line">SReclaimable        895   1003   1898</span><br><span class="line">SUnreclaim          178    119    297</span><br><span class="line">AnonHugePages         2      6      8</span><br><span class="line">HugePages_Total       0      0      0</span><br><span class="line">HugePages_Free        0      0      0</span><br><span class="line">HugePages_Surp        0      0      0</span><br><span class="line"></span><br><span class="line">$ perf <span class="built_in">stat</span> -e <span class="built_in">sched</span>:sched_stick_numa,<span class="built_in">sched</span>:sched_move_numa,<span class="built_in">sched</span>:sched_swap_numa,migrate:mm_migrate_pages,minor-faults -p <span class="variable">$PID</span></span><br></pre></td></tr></table></figure>

<p>Get hardware status from numactl<br>$ lspci -tvv<br> -[0000:00]-+-00.0  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D DMI2<br>             +-01.0-[01-02]—-00.0  LSI Logic &#x2F; Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3<br>             +-02.0-[03-04]–+-00.0  Intel Corporation Ethernet Controller X710 for 10GbE SFP+<br>             |               -00.1  Intel Corporation Ethernet Controller X710 for 10GbE SFP+<br>             +-02.2-[05-06]–+-00.0  Intel Corporation Ethernet Controller 10-Gigabit X540-AT2<br>             |               -00.1  Intel Corporation Ethernet Controller 10-Gigabit X540-AT2<br>             +-03.0-[07]–<br>             +-03.2-[08]—-00.0  Intel Corporation I210 Gigabit Network Connection<br>             +-04.0  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 0<br>             +-04.1  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 1<br>             +-04.2  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 2<br>             +-04.3  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 3<br>             +-04.4  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 4<br>             +-04.5  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 5<br>             +-04.6  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 6<br>             +-04.7  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Crystal Beach DMA Channel 7<br>             +-05.0  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D Map&#x2F;VTd_Misc&#x2F;System Management<br>             +-05.1  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D IIO Hot Plug<br>             +-05.2  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D IIO RAS&#x2F;Control Status&#x2F;Global Errors<br>             +-05.4  Intel Corporation Xeon E7 v4&#x2F;Xeon E5 v4&#x2F;Xeon E3 v4&#x2F;Xeon D I&#x2F;O APIC<br>             +-11.0  Intel Corporation C610&#x2F;X99 series chipset SPSR<br>             +-11.3  Intel Corporation C610&#x2F;X99 series chipset MS SMBus 2<br>             +-11.4  Intel Corporation C610&#x2F;X99 series chipset sSATA Controller [AHCI mode]<br>             +-14.0  Intel Corporation C610&#x2F;X99 series chipset USB xHCI Host Controller<br>             +-16.0  Intel Corporation C610&#x2F;X99 series chipset MEI Controller #1<br>             +-16.1  Intel Corporation C610&#x2F;X99 series chipset MEI Controller #2<br>             +-1a.0  Intel Corporation C610&#x2F;X99 series chipset USB Enhanced Host Controller #2<br>             +-1c.0-[09]–<br>             +-1c.2-[0a-0b]—-00.0-[0b]—-00.0  ASPEED Technology, Inc. ASPEED Graphics Family<br>             +-1d.0  Intel Corporation C610&#x2F;X99 series chipset USB Enhanced Host Controller #1<br>             +-1f.0  Intel Corporation C610&#x2F;X99 series chipset LPC Controller<br>             +-1f.2  Intel Corporation C610&#x2F;X99 series chipset 6-Port SATA Controller [AHCI mode]<br>             +-1f.3  Intel Corporation C610&#x2F;X99 series chipset SMBus Controller<br>             -1f.6  Intel Corporation C610&#x2F;X99 series chipset Thermal Subsystem</p>
<p>$ numactl –prefer pci:0000:00:01.0 –show<br>policy: preferred<br>preferred node: 0<br>physcpubind: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19<br>cpubind: 0 1<br>nodebind: 0 1<br>membind: 0 1</p>
<p>$ numactl –prefer pci:0000:00:02.0-04 –show<br>policy: preferred<br>preferred node: 0<br>physcpubind: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19<br>cpubind: 0 1<br>nodebind: 0 1<br>membind: 0 1</p>
<p>$ dmesg -T | grep numa -i<br>[Mon Aug  6 19:40:25 2018] No NUMA configuration found<br>[Mon Aug  6 19:41:05 2018] pci_bus 0000:00: on NUMA node 0</p>
<p>#If ACPI is disabled, that will also disable NUMA; verify that ACPI is not disabled by a grub.conf kernel parameter and remove it if found be careful you have not disable ACPI in BIOS, if you don ‘t know how to do, please reset the BIOS to default setting.</p>
<p>$ numactl –hardware<br>available: 4 nodes (0-3)<br>node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74<br>node 0 size: 786305 MB<br>node 0 free: 768918 MB<br>node 1 cpus: 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89<br>node 1 size: 786432 MB<br>node 1 free: 768579 MB<br>node 2 cpus: 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104<br>node 2 size: 786432 MB<br>node 2 free: 769063 MB<br>node 3 cpus: 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119<br>node 3 size: 786432 MB<br>node 3 free: 766922 MB<br>node distances:<br>node   0   1   2   3<br>  0:  10  21  21  21<br>  1:  21  10  21  21<br>  2:  21  21  10  21<br>  3:  21  21  21  10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Interleave mode   </span><br><span class="line">```bash</span><br><span class="line">vm.zone_reclaim_mode = 0 ## default,could use remote numa memroy</span><br><span class="line">numactl --interleave=all ./your_script</span><br></pre></td></tr></table></figure>

<p>disable numa in grub   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;numa=off&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Get the numa info from the Linux proc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `pidof qemu-kvm`; <span class="keyword">do</span> <span class="built_in">cat</span> /proc/<span class="variable">$i</span>/status | grep -E <span class="string">&#x27;Cpus_allowed_list|Mems_allowed_list&#x27;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>numad service   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf install numad</span><br><span class="line">systemctl <span class="built_in">enable</span> numad</span><br><span class="line">systemctl start numad</span><br></pre></td></tr></table></figure>
<h4 id="How-many-temperature-is-high-for-intel-CPU"><a href="#How-many-temperature-is-high-for-intel-CPU" class="headerlink" title="How many temperature is high for intel CPU ?"></a>How many temperature is high for intel CPU ?</h4><p>In intel 2nd Gen Scalable Xeon refresh version just 14nm+++, so it cause high temperature, eg: 6248R</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">     air---------------------------T(ambient) ----</span><br><span class="line">                                                 |</span><br><span class="line">| | | | | | | | |                               sa------</span><br><span class="line">| |cooling fin| |                                |     |</span><br><span class="line">| | | | |-------------------------T(sink)--------      |</span><br><span class="line">| | | | | | | | |                               cs     ca</span><br><span class="line">^^^^^^^^^-------------------------T(<span class="keyword">case</span>)--------      |</span><br><span class="line">|    =======    |                               jc-----</span><br><span class="line">|   |||CPU------------------------T(junction)----</span><br><span class="line">==================</span><br><span class="line">|===baseboard===|</span><br><span class="line">=================</span><br></pre></td></tr></table></figure>

<p>In some vendor mark the max DST temperature in the SPEC.<br>The BMC has no DST temperature sensor output. the CPU1 DTS is unspec.    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sdr <span class="built_in">type</span> Temperature</span><br><span class="line">CPU1 OverTemp    | 85h | ok  |  3.1 | Transition to OK</span><br><span class="line">CPU1 Temp        | 84h | ok  |  3.1 | 72 degrees C</span><br><span class="line">CPU1 DTS         | 50h | ok  |  3.1 | -22.80 unspecif</span><br><span class="line">CPU2 OverTemp    | 87h | ok  |  3.2 | Transition to OK</span><br><span class="line">CPU2 Temp        | 86h | ok  |  3.2 | 72 degrees C</span><br><span class="line">CPU2 DTS         | 51h | ok  |  3.2 | -22.80 unspecif</span><br><span class="line">DIMM 1 Temp      | 30h | ok  | 32.1 | 29 degrees C</span><br><span class="line">DIMM 2 Temp      | 31h | ns  | 32.2 | No Reading</span><br><span class="line">PCH OverTemp     | 8Bh | ok  | 45.1 | Transition to OK</span><br><span class="line">PCH Temp         | 2Fh | ok  | 45.1 | 43 degrees C</span><br><span class="line">Ambient Temp     | 80h | ok  | 39.1 | 22 degrees C</span><br><span class="line">PCI 1 OverTemp   | 48h | ok  | 11.1 | Transition to OK</span><br><span class="line">PCI 2 OverTemp   | 49h | ok  | 11.2 | Transition to OK</span><br><span class="line">Exhaust Temp     | 83h | ok  | 30.2 | 38 degrees C</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>In my benchmark, I got the result, I can ‘t got DTS temperature from BMC sensor, but I could use the DTS value to measure.<br>The 6248R(the hottest room) and 6248(hot room),6240R(cool room) in the different server room</p>
<p>And in many manufacturer BMC manager (IDRAC&#x2F;TSM), In the BMC interface show the CPU maximum temperature is same with the DST max temperature.  </p>
<p><a target="_blank" rel="noopener" href="https://cdrdv2.intel.com/v1/dl/getContent/616776">Got the DST max</a></p>
<table>
<thead>
<tr>
<th>CPU(all °C)</th>
<th>Tcase</th>
<th>DST max</th>
<th>throttling temp dmesg</th>
<th>performance idle</th>
<th>powersave idle</th>
<th>Full loading</th>
<th>rack and fan</th>
</tr>
</thead>
<tbody><tr>
<td>Xeon 64248R</td>
<td>75</td>
<td>95</td>
<td>96</td>
<td>73</td>
<td>55</td>
<td>84(after silicone)</td>
<td>20k rpm,SR630</td>
</tr>
<tr>
<td>Xeon 64248</td>
<td>86</td>
<td>100</td>
<td>100</td>
<td>60</td>
<td>49</td>
<td>87</td>
<td>unknow,SR630</td>
</tr>
<tr>
<td>Xeon 6240R</td>
<td>90</td>
<td>104</td>
<td>104</td>
<td>35</td>
<td>41</td>
<td>82</td>
<td>16k,PowerEdge C6420</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPU1 Temp        | 84h | ok  |  3.1 | 72 degrees C</span><br></pre></td></tr></table></figure>
<p>if the DST max temperature &gt; 84h CPU1 Temp(72 degress C) that means the temperature little high for 2nd gen scalable CPU, but the CPU could work well except the Fan or some circuit not suitable for high temperature env<br>if the Tcase temperature &gt; 84h CPU1 Temp(72 degress C) that means it ‘s the cool air temperature for this CPU    </p>
<p>The Fan location<br>In this example, C6h is the sensor code. c6h is XCC sensor number for “Fan 7A Tach”     </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CPU 1 Overtemp   | C4h | ok  |  3.1 | Transition to OK</span><br><span class="line">CPU 1 Temp       | C6h | ok  |  3.1 | 43 degrees C</span><br><span class="line">CPU 1 DTS        | CAh | ok  |  3.1 | -51 unspecified</span><br><span class="line">CPU 2 Overtemp   | C5h | ok  |  3.2 | Transition to OK</span><br><span class="line">CPU 2 Temp       | C7h | ok  |  3.2 | 40 degrees C</span><br><span class="line">CPU 2 DTS        | CBh | ok  |  3.2 | -51 unspecified</span><br><span class="line">PCIe 1 Temp      | 41h | ok  | 11.1 | Transition to OK</span><br><span class="line">PCIe 3 Temp      | 43h | ok  | 11.3 | Transition to OK</span><br><span class="line">PCIe 5 Temp      | 45h | ok  | 11.5 | Transition to OK</span><br><span class="line">PCIe 6 Temp      | 46h | ok  | 11.6 | Transition to OK</span><br><span class="line">Drive Overtemp   | BFh | ok  | 37.4 |</span><br><span class="line">M2 Temp          | BEh | ns  | 11.7 | No Reading</span><br><span class="line">PCH Overtemp     | BDh | ok  | 45.1 | Transition to OK</span><br><span class="line">Ambient Temp     | B0h | ok  | 39.1 | 22 degrees C</span><br><span class="line">Exhaust Temp     | E3h | ok  | 13.1 | 38 degrees C</span><br></pre></td></tr></table></figure>
<p><a href="/img/server_c6h_location.png"></a>     </p>
<h4 id="tool-for-CPU-machine-specific-registers"><a href="#tool-for-CPU-machine-specific-registers" class="headerlink" title="tool for CPU machine specific registers"></a>tool for CPU machine specific registers</h4><ul>
<li>wrmsr - tool for writing CPU machine specific registers (MSR)</li>
<li>rdmsr - tool for reading CPU machine specific registers (MSR)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># only turning of that one</span></span><br><span class="line">$ rdmsr -a 0x1a4</span><br><span class="line">0</span><br><span class="line">...</span><br><span class="line"><span class="comment">## the line number = CPU thread numbers</span></span><br><span class="line"></span><br><span class="line">$ wrmsr -a 0x1a4 <span class="string">&quot;<span class="subst">$((2#1111)</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  only turning of that one</span></span><br><span class="line">$ wrmsr -a 0x1a4 <span class="string">&quot;<span class="subst">$((2#0001)</span>)&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="irqbalance"><a href="#irqbalance" class="headerlink" title="irqbalance"></a>irqbalance</h4><p>&#x2F;etc&#x2F;sysconfig&#x2F;irqbalance  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exclude CPUs 8 to 15 by uncommenting the variable IRQBALANCE_BANNED_CPUS and setting its value this wayj</span></span><br><span class="line">IRQBALANCE_BANNED_CPUS=0000ff00</span><br></pre></td></tr></table></figure>

<h3 id="CVE-Performance-overrides"><a href="#CVE-Performance-overrides" class="headerlink" title="CVE Performance overrides"></a>CVE Performance overrides</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">## disable CVE patch for performance</span><br><span class="line">$ grubby --update-kernel=ALL --args=&#x27;spectre_v2=off spec_store_bypass_disable=off nopti l1tf=off&#x27;</span><br><span class="line"></span><br><span class="line">$ grep . /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line"></span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/itlb_multihit:KVM: Mitigation: Split huge pages</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/mds:Mitigation: Clear CPU buffers; SMT vulnerable</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/spectre_v2:Mitigation: Full generic retpoline, IBPB: conditional, IBRS_FW, STIBP: conditional, RSB filling</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/srbds:Mitigation: Microcode</span><br><span class="line">/sys/devices/system/cpu/vulnerabilities/tsx_async_abort:Mitigation: Clear CPU buffers; SMT vulnerable</span><br></pre></td></tr></table></figure>

<h4 id="OpenMP-env-var"><a href="#OpenMP-env-var" class="headerlink" title="OpenMP env var"></a>OpenMP env var</h4><p>The OMP_NUM_THREADS environment variable specifies the number of threads to use for parallel region OMP_NUM_THREADS   </p>
<h5 id="turbostat"><a href="#turbostat" class="headerlink" title="turbostat"></a>turbostat</h5><ul>
<li>Avg_MHz</li>
<li>Bzy_MHz<ul>
<li>idle CPU frequency</li>
</ul>
</li>
<li>PkgWatt<ul>
<li>The whole CPU power</li>
</ul>
</li>
<li>RAMwatt<ul>
<li>All mem power</li>
</ul>
</li>
<li>CoreTmp</li>
<li>PkgTtmp<ul>
<li>The vluae of the whole CPU package thermal monitor</li>
</ul>
</li>
</ul>
<h4 id="powertop"><a href="#powertop" class="headerlink" title="powertop"></a>powertop</h4><h4 id="powercap"><a href="#powercap" class="headerlink" title="powercap"></a>powercap</h4><h4 id="process-counter-monitor-PCM"><a href="#process-counter-monitor-PCM" class="headerlink" title="process counter monitor (PCM)"></a>process counter monitor (PCM)</h4><h4 id="numatop"><a href="#numatop" class="headerlink" title="numatop"></a>numatop</h4><ul>
<li><p>RMA(K): number of Remote Memory Accesses (unit is 1000).</p>
<ul>
<li>RMA(K) &#x3D; RMA &#x2F; 1000;</li>
</ul>
</li>
<li><p>LMA(K): number of Local Memory Accesses (unit is 1000).</p>
<ul>
<li>LMA(K) &#x3D; LMA &#x2F; 1000;</li>
</ul>
</li>
<li><p>IR: Instruction Retired.</p>
</li>
<li><p>CYCLE: CPU cycles.</p>
</li>
<li><p>RMA&#x2F;LMA: ratio of RMA&#x2F;LMA.</p>
</li>
<li><p>CPI: CPU cycle per instruction.</p>
</li>
<li><p>CPU%: CPU utilization.</p>
</li>
<li><p>RPI(K): RMA normalized by 1000 instructions.</p>
<ul>
<li>RPI(K) &#x3D; RMA &#x2F; (IR &#x2F; 1000);</li>
</ul>
</li>
<li><p>LPI(K): LMA normalized by 1000 instructions.</p>
<ul>
<li>LPI(K) &#x3D; LMA &#x2F; (IR &#x2F; 1000);</li>
</ul>
</li>
<li><p>ACCESS%: percentage of memory accesses are to this node.</p>
</li>
<li><p>LAT(ns): the average latency (nanoseconds) of memory accesses to this node.</p>
</li>
<li><p>CPU: array of logical CPUs which belong to this node</p>
</li>
<li><p>CPU%: per-node CPU utilization</p>
</li>
<li><p>MEM active: the amount of memory that has been used more recently and<br>is not usually reclaimed unless absolute necessary</p>
</li>
<li><p>MEM inactive: the amount of memory that has not been used for a while<br>and is eligible to be swapped to disk</p>
</li>
<li><p>Dirty: the amount of memory waiting to be written back to the disk</p>
</li>
<li><p>Writeback: the amount of memory actively being written back to the disk</p>
</li>
<li><p>Mapped: all pages mapped into a process</p>
</li>
</ul>
<h4 id="Linux-CPU-parameters"><a href="#Linux-CPU-parameters" class="headerlink" title="Linux CPU parameters"></a>Linux CPU parameters</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vfio-pci.ids=[...] amd_iommu=on iommu=pt iommu=1 acpi_enforce_resources=lax isolcpus=7-15 rcu_nocbs=7-15 nohz_full=7-15 rcu_nocb_poll irqaffinity=0,1,2,3,4,5,6 spl_taskq_thread_bind=1 nohibernate zfs_force=1 systemd.unified_cgroup_hierarchy=0 loglevel=4   </span><br></pre></td></tr></table></figure>
<ul>
<li><p>rcu_nocbs&#x3D;      [KNL]</p>
<ul>
<li>RCU is a synchronization mechanism that was added to the Linux kernel during the 2.5 development effort that is optimized for read-mostly situations.</li>
<li>The argument is a cpu list, as described above.</li>
<li>In kernels built with CONFIG_RCU_NOCB_CPU&#x3D;y, set the specified list of CPUs to be no-callback CPUs.</li>
<li>Invocation of these CPUs’ RCU callbacks will be offloaded to “rcuox&#x2F;N” kthreads created for that purpose, where “x” is “b” for RCU-bh, “p” for RCU-preempt, and “s” for RCU-sched, and “N” is the CPU number.  This reduces OS jitter on the offloaded CPUs, which can be useful for HPC and real-time workloads.  It can also improve energy efficiency for asymmetric multiprocessors.</li>
</ul>
</li>
<li><p>nohz_full&#x3D;      [KNL,BOOT]</p>
<ul>
<li>The argument is a cpu list, as described above. In kernels built with CONFIG_NO_HZ_FULL&#x3D;y, set the specified list of CPUs whose tick will be stopped whenever possible. </li>
<li>The boot CPU will be forced outside the range to maintain the timekeeping.  Any CPUs in this list will have their RCU callbacks offloaded, just as if they had also been called out in thercu_nocbs&#x3D; boot parameter.</li>
</ul>
</li>
<li><p>rcu_nocb_poll   [KNL]</p>
<ul>
<li>Rather than requiring that offloaded CPUs (specified by rcu_nocbs&#x3D; above) explicitly awaken the corresponding “rcuoN” kthreads, make these kthreads poll for callbacks.</li>
<li>This improves the real-time response for the offloaded CPUs by relieving them of the need to wake up the corresponding kthread, but degrades energy efficiency by requiring that the kthreads periodically wake up to do the polling.</li>
</ul>
</li>
<li><p>irqaffinity [SMP] </p>
<ul>
<li>Set the default irq affinity mask The argument is a cpu list, as described above.</li>
</ul>
</li>
<li><p>nohibernate     </p>
<ul>
<li>[HIBERNATION] Disable hibernation and resume.</li>
</ul>
</li>
<li><p>loglevel</p>
<ul>
<li>All Kernel Messages with a loglevel smaller than the console loglevel will be printed to the console. It can also be changed with klogd or other programs. The loglevels are defined as follows:</li>
<li>0 (KERN_EMERG)          system is unusable</li>
<li>1 (KERN_ALERT)          action must be taken immediately</li>
<li>2 (KERN_CRIT)           critical conditions</li>
<li>3 (KERN_ERR)            error conditions</li>
<li>4 (KERN_WARNING)        warning conditions</li>
<li>5 (KERN_NOTICE)         normal but significant condition</li>
<li>6 (KERN_INFO)           informational</li>
<li>7 (KERN_DEBUG)          debug-level messages</li>
</ul>
</li>
<li><p>Enable cgroup v1</p>
<ul>
<li>Cgroup v2 is now enabled by default. If you want to switch to cgroup v1 instead, you need to set the following<ul>
<li>systemd.unified_cgroup_hierarchy&#x3D;0</li>
</ul>
</li>
</ul>
</li>
<li><p>amd_iommu</p>
<ul>
<li>Pass parameters to the AMD IOMMU driver in the system. Possible values are:<br>-fullflush - Deprecated, equivalent to iommu.strict&#x3D;1<br>-off          - do not initialize any AMD IOMMU found in the system<br>force_isolation - Force device isolation for all devices. The IOMMU driver is not allowed anymore to lift isolation requirements as needed. This option does not override iommu&#x3D;pt<br>force_enable - Force enable the IOMMU on platforms known to be buggy with IOMMU enabled. Use this option with care.</li>
</ul>
</li>
<li><p>iommu</p>
<ul>
<li>off</li>
<li>force</li>
<li>noforce</li>
<li>biomerge</li>
<li>panic</li>
<li>nopanic</li>
<li>merge</li>
<li>nomerge</li>
<li>forcesac</li>
<li>soft</li>
<li>pt              [x86, IA-64]</li>
<li>nobypass        [PPC&#x2F;POWERNV]<ul>
<li>Disable IOMMU bypass, using IOMMU for PCI devices.</li>
</ul>
</li>
</ul>
</li>
<li><p>acpi_enforce_resources&#x3D; [ACPI]</p>
<ul>
<li>{ strict | lax | no }</li>
<li>Check for resource conflicts between native drivers and ACPI OperationRegions (SystemIO and SystemMemory only). IO ports and memory declared in ACPI might be used by the ACPI subsystem in arbitrary AML code and can interfere with legacy drivers.<ul>
<li>strict (default): access to resources claimed by ACPI is denied; legacy drivers trying to access reserved resources will fail to bind to device using them.</li>
<li>lax: access to resources claimed by ACPI is allowed; legacy drivers trying to access reserved resources will bind successfully but a warning message is logged.</li>
<li>no: ACPI OperationRegions are not marked as reserved, no further checks are performed.</li>
</ul>
</li>
</ul>
</li>
<li><p>isolcpus&#x3D;[KNL,SMP] </p>
<ul>
<li>Isolate CPUs from the general process scheduler. The argument is a cpu list, as described above.<ul>
<li>This option can be used to specify one or more CPUs to isolate from the general SMP balancing and scheduling algorithms. You can move a process onto or off an “isolated” CPU via the CPU affinity syscalls or cpuset. <cpu number> begins at 0 and the maximum value is “number of CPUs in system - 1”.</li>
<li>This option is the preferred way to isolate CPUs. The alternative – manually setting the CPU mask of all tasks in the system – can cause problems and suboptimal load balancer performance.</li>
<li>NOTE: kernel threads are not able to be disabled and will always be visible on all cores. In ps -eLf output, these show up in brackets, like [ksoftirqd&#x2F;0]</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#x86-CPU"><span class="toc-number">1.</span> <span class="toc-text">x86 CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Intel-Cascade-Lake-CPU-suffix"><span class="toc-number">1.1.</span> <span class="toc-text">Intel Cascade Lake CPU suffix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cpu-features"><span class="toc-number">1.2.</span> <span class="toc-text">intel cpu features</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Why-some-of-the-8-16-x-cores-EPYC2-limit-the-memory-bandwith"><span class="toc-number">1.3.</span> <span class="toc-text">Why some of the 8,16 x cores EPYC2 limit the memory bandwith</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cluster-mode"><span class="toc-number">1.4.</span> <span class="toc-text">CPU cluster mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-cache-speed"><span class="toc-number">1.5.</span> <span class="toc-text">CPU cache speed</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline-Width"><span class="toc-number">1.5.1.</span> <span class="toc-text">Pipeline Width</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Caculate-the-Tflops"><span class="toc-number">1.5.2.</span> <span class="toc-text">Caculate the Tflops</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#how-to-test-it-benchmark-flag-test-flag"><span class="toc-number">1.5.3.</span> <span class="toc-text">how to test it benchmark_flag test_flag</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-medium-speed"><span class="toc-number">1.5.4.</span> <span class="toc-text">CPU medium speed</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pin-CPU"><span class="toc-number">2.1.</span> <span class="toc-text">pin CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Show-cpu-topo"><span class="toc-number">2.2.</span> <span class="toc-text">Show cpu topo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cache-consistenta"><span class="toc-number">2.3.</span> <span class="toc-text">Cache consistenta</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMD-SMT-255-cores"><span class="toc-number">2.4.</span> <span class="toc-text">AMD SMT, 255 cores</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-STAT"><span class="toc-number">2.5.</span> <span class="toc-text">CPU STAT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#kernel-parameters"><span class="toc-number">2.5.1.</span> <span class="toc-text">kernel parameters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-IDLE"><span class="toc-number">2.5.2.</span> <span class="toc-text">CPU IDLE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Application-multiple-threads-get-down-to-single-core-cause-performance-issue-in-intel-skylake-platform"><span class="toc-number">2.6.</span> <span class="toc-text">Application multiple threads get down to single core cause performance issue in intel skylake platform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#E3-v6-Turbo-not-support-under-the-CentOS6"><span class="toc-number">2.7.</span> <span class="toc-text">E3 v6 Turbo not support under the CentOS6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isolated-CPUs-example"><span class="toc-number">2.8.</span> <span class="toc-text">Isolated CPUs example</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#use-the-isolated-core"><span class="toc-number">2.8.1.</span> <span class="toc-text">use the isolated core</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-x86-options"><span class="toc-number">2.9.</span> <span class="toc-text">gcc_x86_options</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Disable-features-AVX"><span class="toc-number">2.10.</span> <span class="toc-text">Disable features AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ban-half-core-try-to-not-running-HT"><span class="toc-number">2.11.</span> <span class="toc-text">Ban half core, try to not running HT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Turn-off-the-cpu-cores-under-linux"><span class="toc-number">2.12.</span> <span class="toc-text">Turn off the cpu cores under linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-cmt-cat"><span class="toc-number">2.13.</span> <span class="toc-text">intel-cmt-cat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-process-with-CPU"><span class="toc-number">2.14.</span> <span class="toc-text">Linux process with CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numa"><span class="toc-number">2.15.</span> <span class="toc-text">numa</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#How-many-temperature-is-high-for-intel-CPU"><span class="toc-number">2.16.</span> <span class="toc-text">How many temperature is high for intel CPU ?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tool-for-CPU-machine-specific-registers"><span class="toc-number">2.17.</span> <span class="toc-text">tool for CPU machine specific registers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#irqbalance"><span class="toc-number">2.18.</span> <span class="toc-text">irqbalance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-Performance-overrides"><span class="toc-number">3.</span> <span class="toc-text">CVE Performance overrides</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenMP-env-var"><span class="toc-number">3.1.</span> <span class="toc-text">OpenMP env var</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#turbostat"><span class="toc-number">3.1.1.</span> <span class="toc-text">turbostat</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powertop"><span class="toc-number">3.2.</span> <span class="toc-text">powertop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powercap"><span class="toc-number">3.3.</span> <span class="toc-text">powercap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#process-counter-monitor-PCM"><span class="toc-number">3.4.</span> <span class="toc-text">process counter monitor (PCM)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numatop"><span class="toc-number">3.5.</span> <span class="toc-text">numatop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-CPU-parameters"><span class="toc-number">3.6.</span> <span class="toc-text">Linux CPU parameters</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/13/cpu/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/13/cpu/&text=CPU"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/13/cpu/&is_video=false&description=CPU"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CPU&body=Check out this article: http://example.com/2022/11/13/cpu/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/13/cpu/&title=CPU"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/13/cpu/&name=CPU&description=&lt;h3 id=&#34;x86-CPU&#34;&gt;&lt;a href=&#34;#x86-CPU&#34; class=&#34;headerlink&#34; title=&#34;x86 CPU&#34;&gt;&lt;/a&gt;x86 CPU&lt;/h3&gt;&lt;h4 id=&#34;Intel-Cascade-Lake-CPU-suffix&#34;&gt;&lt;a href=&#34;#Intel-Cascade-Lake-CPU-suffix&#34; class=&#34;headerlink&#34; title=&#34;Intel Cascade Lake CPU suffix&#34;&gt;&lt;/a&gt;Intel Cascade Lake CPU suffix&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;“F” suffix integrates the Omni-Path Host Fabric Interface (HFI) die on-package&lt;/li&gt;
&lt;li&gt;“L” suffix indicates the SKU is a large memory (4.5 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;“M” suffix indicates the SKU is a medium memory (2 TiB) tier SKU&lt;/li&gt;
&lt;li&gt;“N” suffix indicates the SKU is a specialized for Networking&amp;#x2F;NFV&lt;/li&gt;
&lt;li&gt;“S” suffix indicates the SKU is a search application-specialized model&lt;/li&gt;
&lt;li&gt;“T” suffix indicates that SKU has an extended lifetime (10 year use) guarantees and NEBS-friendly packing specification&lt;/li&gt;
&lt;li&gt;“U” suffix indicates the SKU is a single-socket model (even if part of the Xeon Gold family that normally supports up two 4-way SMP)&lt;/li&gt;
&lt;li&gt;“V” suffix indicates the SKU targets the VM density value market&lt;/li&gt;
&lt;li&gt;“Y” suffix indicates the SKU has Speed Select Technology (SST)&lt;/li&gt;
&lt;li&gt;“R” suffix indicates the SKU is a refresh model( add cores or frequency)"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/13/cpu/&t=CPU"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Jemalloc TCMalloc1234567$ yum install gperftools-libs$ exprot TCMALLOC_RELEASE_RATE &#x3D; 0~10 (10 means the fastest reclaim)$ LD_PRELOAD&#x3D;&#x2F;usr&#x2F;lib64&#x2F;libtcmalloc.so.4 sh .&#x2F;test.sh$ LD_PRELOAD&#x3D;&#x2F;usr&#x2F;local&#x2F;li">
<meta property="og:type" content="article">
<meta property="og:title" content="benchmark">
<meta property="og:url" content="http://example.com/2022/11/14/benchmark/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Jemalloc TCMalloc1234567$ yum install gperftools-libs$ exprot TCMALLOC_RELEASE_RATE &#x3D; 0~10 (10 means the fastest reclaim)$ LD_PRELOAD&#x3D;&#x2F;usr&#x2F;lib64&#x2F;libtcmalloc.so.4 sh .&#x2F;test.sh$ LD_PRELOAD&#x3D;&#x2F;usr&#x2F;local&#x2F;li">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-14T07:35:11.000Z">
<meta property="article:modified_time" content="2022-11-17T04:48:22.151Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="bench">
<meta property="article:tag" content="test">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>benchmark</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/14/ipmi/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/14/issues/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/14/benchmark/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/14/benchmark/&text=benchmark"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/14/benchmark/&is_video=false&description=benchmark"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=benchmark&body=Check out this article: http://example.com/2022/11/14/benchmark/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/14/benchmark/&name=benchmark&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/14/benchmark/&t=benchmark"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jemalloc-TCMalloc"><span class="toc-number">1.</span> <span class="toc-text">Jemalloc TCMalloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calculate-upload-x2F-download-speed-by-ping"><span class="toc-number">2.</span> <span class="toc-text">calculate upload&#x2F;download speed by ping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openssl"><span class="toc-number">3.</span> <span class="toc-text">openssl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bash"><span class="toc-number">4.</span> <span class="toc-text">bash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sysbech"><span class="toc-number">5.</span> <span class="toc-text">sysbech</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#test-mysql"><span class="toc-number">5.1.</span> <span class="toc-text">test mysql</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis"><span class="toc-number">6.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linpack-for-x86"><span class="toc-number">7.</span> <span class="toc-text">Linpack for x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AVX"><span class="toc-number">8.</span> <span class="toc-text">AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP"><span class="toc-number">9.</span> <span class="toc-text">UDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RFC6349-TCP-benchmark"><span class="toc-number">10.</span> <span class="toc-text">RFC6349 TCP benchmark</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pkggen-kernel-mode"><span class="toc-number">11.</span> <span class="toc-text">pkggen kernel mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nc-test"><span class="toc-number">12.</span> <span class="toc-text">nc test</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iperf3"><span class="toc-number">13.</span> <span class="toc-text">iperf3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qperf"><span class="toc-number">14.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#netperf"><span class="toc-number">15.</span> <span class="toc-text">netperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sockperf"><span class="toc-number">16.</span> <span class="toc-text">sockperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fio-test-multiple-nodes"><span class="toc-number">17.</span> <span class="toc-text">fio test multiple nodes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-softlock-and-hardlock-in-kernel"><span class="toc-number">18.</span> <span class="toc-text">test softlock and hardlock in kernel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ab"><span class="toc-number">19.</span> <span class="toc-text">ab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoCEv2-benchmark"><span class="toc-number">20.</span> <span class="toc-text">RoCEv2 benchmark</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rping"><span class="toc-number">20.1.</span> <span class="toc-text">rping</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ibv-rc-pingpong"><span class="toc-number">20.2.</span> <span class="toc-text">ibv_rc_pingpong</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#qperf-1"><span class="toc-number">20.3.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#perftest"><span class="toc-number">20.4.</span> <span class="toc-text">perftest</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MEM"><span class="toc-number">21.</span> <span class="toc-text">MEM</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lmbench"><span class="toc-number">21.1.</span> <span class="toc-text">lmbench</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uarch-bench"><span class="toc-number">22.</span> <span class="toc-text">uarch-bench</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#contextswitch"><span class="toc-number">23.</span> <span class="toc-text">contextswitch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X-mem"><span class="toc-number">24.</span> <span class="toc-text">X-mem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dd"><span class="toc-number">25.</span> <span class="toc-text">dd</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        benchmark
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-14T07:35:11.000Z" itemprop="datePublished">2022-11-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Benchmark/">Benchmark</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/bench/" rel="tag">bench</a>, <a class="tag-link-link" href="/tags/test/" rel="tag">test</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h4 id="Jemalloc-TCMalloc"><a href="#Jemalloc-TCMalloc" class="headerlink" title="Jemalloc TCMalloc"></a>Jemalloc TCMalloc</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gperftools-libs</span><br><span class="line">$ exprot TCMALLOC_RELEASE_RATE = 0~10 (10 means the fastest reclaim)</span><br><span class="line">$ LD_PRELOAD=/usr/lib64/libtcmalloc.so.4 sh ./test.sh</span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=/usr/local/lib/libjemalloc.so.2 sh ./test.sh</span><br><span class="line">$ LD_PRELOAD=/opt/rh/rh-varnish6/root/usr/lib64/libjemalloc.so.2 ./test.sh</span><br><span class="line">$ LD_PRELOAD=mimalloc-2.0.0-src/out/release/libmimalloc.so.2.0 sh ./test.sh</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/google/tcmalloc/issues/40">benchmark</a></p>
<h4 id="calculate-upload-x2F-download-speed-by-ping"><a href="#calculate-upload-x2F-download-speed-by-ping" class="headerlink" title="calculate upload&#x2F;download speed by ping"></a><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping">calculate upload&#x2F;download speed by ping</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 10000 -s 1472 10.100.100.100</span><br></pre></td></tr></table></figure>
<p>At the end of the result i get: round-trip min&#x2F;avg&#x2F;max&#x2F;stddev &#x3D; 0.174&#x2F;0.219&#x2F;2.078&#x2F;0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, that’s 24 kb. 24 kb &#x2F; 0.219 ms &#x3D; 110 Mb&#x2F;s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it won’t take too long to finish.</p>
<p>1500 TX Bytes + 1500 RX Bytes&#x3D; 3000 Bytes &#x3D; 3000 * 8 &#x3D; 24000 bits<br>24000 &#x2F; 0.219 &#x3D; 109.589 Mb&#x2F;s</p>
<p>It ‘s not represent full throughput. just test single link in your ethernet adapter. not parallel.   </p>
<h4 id="openssl"><a href="#openssl" class="headerlink" title="openssl"></a>openssl</h4><p><a target="_blank" rel="noopener" href="https://plantegg.github.io/2020/11/15/Linux%E5%86%85%E5%AD%98--%E7%A2%8E%E7%89%87/">In this page, the openssl speed slow when malloc the big page, you could compare with diff servers</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./openssl speed -multi <span class="variable">$cores</span> -seconds 300 -bytes 1048576 aes-256-ige whirlpool des-ede3 sha512 hmac <span class="comment"># after 1.1.1h</span></span><br></pre></td></tr></table></figure>

<h4 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;7^999999&quot;</span> | bc &gt; /dev/null</span><br><span class="line">$ bash -c <span class="string">&#x27;echo &quot;scale=5000; 4*a(1)&quot; | bc -l -q &gt;/dev/null&#x27;</span> <span class="comment">#pi</span></span><br><span class="line">$ perf <span class="built_in">stat</span> -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores -- bash -c <span class="string">&#x27;echo &quot;7^999999&quot; | bc &gt; /dev/null&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The sysbench prime number can ‘t got the consistent result     </p>
<h4 id="sysbech"><a href="#sysbech" class="headerlink" title="sysbech"></a>sysbech</h4><h5 id="test-mysql"><a href="#test-mysql" class="headerlink" title="test mysql"></a>test mysql</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$  sysbench --<span class="built_in">test</span>=<span class="string">&#x27;/usr/share/doc/sysbench/tests/db/select.lua&#x27;</span> --oltp_tables_count=1 --report-interval=1 --oltp-table-size=10000000  --mysql-port=3307 --mysql-db=sysbench_single --mysql-user=root --mysql-password=<span class="string">&#x27;Bj6f9g96!@#&#x27;</span>  --max-requests=0   --oltp_skip_trx=on --oltp_auto_inc=on  --oltp_range_size=5  --mysql-table-engine=innodb --rand-init=on   --max-time=300 --mysql-host=x86.51 --num-threads=4 run</span><br></pre></td></tr></table></figure>

<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>Just test CPU&#x2F;MEM, not write to disk</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">create a demo file to avoid redis <span class="built_in">exit</span></span><br><span class="line">$ <span class="built_in">mkdir</span> demo </span><br><span class="line">or</span><br><span class="line">$ <span class="built_in">touch</span> demo</span><br><span class="line"></span><br><span class="line"><span class="comment">#server, or add numactl</span></span><br><span class="line">pkill redis-server</span><br><span class="line">j=6001</span><br><span class="line">count=0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..31&#125;; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  <span class="keyword">if</span> [[ $((count%<span class="number">2</span>)) -eq 0 ]]; </span><br><span class="line">  <span class="keyword">then</span>   </span><br><span class="line">    <span class="built_in">echo</span> -n  <span class="string">&quot;numactl -C &quot;</span><span class="variable">$i</span><span class="string">&quot;,&quot;</span>; </span><br><span class="line">  <span class="keyword">else</span>   </span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span><span class="string">&quot; redis-server demo --save \&quot;\&quot; --appendonly no --io-threads 2 --port <span class="variable">$j</span> &amp;&quot;</span>; </span><br><span class="line">    ((j++))</span><br><span class="line">  <span class="keyword">fi</span> </span><br><span class="line">  ((count++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#client</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;start_time=$(date +%s)&#x27;</span> &gt; run_client.sh </span><br><span class="line">j=6001</span><br><span class="line">dsize=2</span><br><span class="line">incr_num=20</span><br><span class="line">count=0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;31..63&#125;;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [[ $((count%<span class="number">2</span>)) -eq 0 ]];</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -n  <span class="string">&quot;numactl -C &quot;</span><span class="variable">$i</span><span class="string">&quot;,&quot;</span> &gt;&gt; run_client.sh</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span><span class="string">&quot; redis-benchmark -r 123456789 -c 32 --threads 2 -q -n 100000000 -t set,get,incr,lpush -d <span class="variable">$dsize</span> -q -p <span class="variable">$j</span> &gt; /tmp/redist_<span class="variable">$&#123;i&#125;</span>.log &amp;&quot;</span>  &gt;&gt; run_client.sh</span><br><span class="line">    ((dsize=dsize+incr_num))</span><br><span class="line">    ((j++))</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  ((count++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">wait</span> &gt;&gt; run_client.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;end_time=$(date +%s)&#x27;</span> &gt;&gt; run_client.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;echo &quot;redis bench time: &quot;$((end_time-start_time)) | tee  /tmp/redis.$(openssl rand -hex 4).log&#x27;</span> &gt;&gt; run_client.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#test results</span></span><br><span class="line">SET: 403063.28 requests per second</span><br><span class="line">GET: 508388.41 requests per second</span><br></pre></td></tr></table></figure>
<p>redis mode2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server --port 7777  --protected-mode no --maxmemory 12000mb --maxmemory-samples 10 --maxmemory-policy allkeys-lru</span><br><span class="line">Client $ numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,<span class="built_in">set</span>,lpush,lpop,incr -P 16 -q -h 192.168.0.201 -p 7777 -d 16</span><br></pre></td></tr></table></figure>

<h4 id="Linpack-for-x86"><a href="#Linpack-for-x86" class="headerlink" title="Linpack for x86"></a><a target="_blank" rel="noopener" href="https://www.ngohq.com/linpack-xtreme.html">Linpack for x86</a></h4><p>Auto calculte the problem size</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mem_var=$(awk <span class="string">&#x27;/MemAvailable/ &#123;printf &quot;%d\n&quot;, $2/1024/1024&#125;&#x27;</span> /proc/meminfo)</span><br><span class="line">$ cpu_cores=$(grep MHz /proc/cpuinfo  -c)</span><br><span class="line">$ test_size=$(awk -v cpu_cores=<span class="variable">$cpu_cores</span> -v mem_var=<span class="variable">$mem_var</span> <span class="string">&#x27;BEGIN&#123;print sqrt(((mem_var-0.067*cpu_cores)/18)*2)*35000&#125;&#x27;</span>)</span><br><span class="line">                                                                                             |              |       |</span><br><span class="line">                                                      one thread will take 0.067GB memory-----              |       |</span><br><span class="line">                                                                 problem size-------------------------------|--------</span><br><span class="line">                                                                                                            |</span><br><span class="line">                                                                                                            |</span><br><span class="line">                                                                                                            |</span><br><span class="line">take away the threads mem size, 35000 problem size will take 18Gx1 memory, 7000 problem will take 18G*2------</span><br><span class="line">105000 will take 18G*4, 140000 = 18G*8</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> default</span><br><span class="line">Linpack data file</span><br><span class="line">Linpack Xtreme v1.1.5 by Regeneration</span><br><span class="line">1</span><br><span class="line"><span class="variable">$test_size</span> <span class="comment"># problem size</span></span><br><span class="line"><span class="variable">$test_size</span> <span class="comment"># leading dimensions</span></span><br><span class="line">1 <span class="comment"># number of times to run LINPACK</span></span><br><span class="line">4</span><br></pre></td></tr></table></figure>
<p>AMD EPYC2(2x 7742, 16 x 32G DDR 3200MHz) proportion to the performance not across the extra NUMA, and internal NUMA has the impact too<br>If the benchmark malloc 90% memory or more, the EPYC2 will from 2000GFLOPS down to 1000+GFLOPS, only half performance<br>It ‘s not used be in the random Memory-intensive tasks, maybe single socket is the better choice<br>In the same case(90%+ mem), the EPYC2 has the long latency than intel system   </p>
<h4 id="AVX"><a href="#AVX" class="headerlink" title="AVX"></a>AVX</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////////////////////////////</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> ARR_SIZE=<span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> A[ARR_SIZE],C[ARR_SIZE]; </span><br><span class="line">  <span class="type">int</span> B[ARR_SIZE];</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; ARR_SIZE; i++)</span><br><span class="line">    A[B[i]] += <span class="number">1.0f</span>/C[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Broadwell</span><br><span class="line">$ icc CD.c -xCORE-AVX2 -O3 -qopt-report=<span class="number">5</span> -fp-model fast=<span class="number">2</span> -S</span><br><span class="line"></span><br><span class="line"><span class="meta"># skylake</span></span><br><span class="line">$ icc CD.c -xCORE-AVX512 -O3 -qopt-report=<span class="number">5</span> -fp-model fast=<span class="number">2</span> -S</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//The example in the listing below shows a benchmark of the fused multiply-add (FMA) operation.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> n_trials = <span class="number">1000000000</span>; <span class="comment">// Enough to keep cores busy for a while and observe a steady state</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> flops_per_calc = <span class="number">2</span>; <span class="comment">// Multiply + add = 2 instructions</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> n_chained_fmas = <span class="number">10</span>; <span class="comment">// Must be tuned for architectures here and in blocks (R) and in (E)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">  &#123; &#125; <span class="comment">// Warm up the threads</span></span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> t0 = omp_get_wtime(); <span class="comment">// start timer</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line"></span><br><span class="line">  &#123; <span class="comment">// Benchmark in all threads</span></span><br><span class="line">    <span class="type">double</span> fa[VECTOR_WIDTH*n_chained_fmas], fb[VECTOR_WIDTH], fc[VECTOR_WIDTH];</span><br><span class="line"></span><br><span class="line">    fa[<span class="number">0</span>:VECTOR_WIDTH*n_chained_fmas] = <span class="number">0.0</span>; <span class="comment">// prototype of a memory-based array</span></span><br><span class="line">    fb[<span class="number">0</span>:VECTOR_WIDTH] = <span class="number">0.5</span>; <span class="comment">// fixed</span></span><br><span class="line">    fc[<span class="number">0</span>:VECTOR_WIDTH] = <span class="number">1.0</span>; <span class="comment">// fixed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa01 = fa +  <span class="number">0</span>*VECTOR_WIDTH; <span class="comment">// This is block (R)</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa02 = fa +  <span class="number">1</span>*VECTOR_WIDTH; <span class="comment">// To tune for a specific architecture,</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa03 = fa +  <span class="number">2</span>*VECTOR_WIDTH; <span class="comment">// more or fewer fa* variables</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa04 = fa +  <span class="number">3</span>*VECTOR_WIDTH; <span class="comment">// must be used</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa05 = fa +  <span class="number">4</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa06 = fa +  <span class="number">5</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa07 = fa +  <span class="number">6</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa08 = fa +  <span class="number">7</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa09 = fa +  <span class="number">8</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa10 = fa +  <span class="number">9</span>*VECTOR_WIDTH;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> nounroll <span class="comment">// Prevents automatic unrolling by compiler to avoid skewed benchmarks</span></span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n_trials; i++)</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp simd <span class="comment">// Ensures that vectorization does occur</span></span></span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; VECTOR_WIDTH; j++) &#123; <span class="comment">// VECTOR_WIDTH=4 for AVX2, =8 for AVX-512</span></span><br><span class="line">        fa01[j] = fa01[j]*fb[j] + fc[j]; <span class="comment">// This is block (E)</span></span><br><span class="line">        fa02[j] = fa02[j]*fb[j] + fc[j]; <span class="comment">// To tune for a specific architecture,</span></span><br><span class="line">        fa03[j] = fa03[j]*fb[j] + fc[j]; <span class="comment">// more or fewer such FMA constructs</span></span><br><span class="line">        fa04[j] = fa04[j]*fb[j] + fc[j]; <span class="comment">// must be used</span></span><br><span class="line">        fa05[j] = fa05[j]*fb[j] + fc[j];</span><br><span class="line">        fa06[j] = fa06[j]*fb[j] + fc[j];</span><br><span class="line">        fa07[j] = fa07[j]*fb[j] + fc[j];</span><br><span class="line">        fa08[j] = fa08[j]*fb[j] + fc[j];</span><br><span class="line">        fa09[j] = fa09[j]*fb[j] + fc[j];</span><br><span class="line">        fa10[j] = fa10[j]*fb[j] + fc[j];</span><br><span class="line">      &#125;</span><br><span class="line">    fa[<span class="number">0</span>:VECTOR_WIDTH*n_chained_fmas] *= <span class="number">2.0</span>; <span class="comment">// Prevent dead code elimination</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> t1 = omp_get_wtime();</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> gflops = <span class="number">1.0e-9</span>*(<span class="type">double</span>)VECTOR_WIDTH*(<span class="type">double</span>)n_trials*(<span class="type">double</span>)flops_per_calc*</span><br><span class="line">                        (<span class="type">double</span>)omp_get_max_threads()*(<span class="type">double</span>)n_chained_fmas;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Chained FMAs=%d, vector width=%d, GFLOPs=%.1f, time=%.6f s, performance=%.1f GFLOP/s\n&quot;</span>, </span><br><span class="line">                        n_chained_fmas, VECTOR_WIDTH, gflops, t1 - t0, gflops/(t1 - t0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ icpc -qopenmp -DVECTOR_WIDTH=<span class="number">4</span> -xCORE-AVX2 -S -o fma_avx2_10.s fma_10.c</span><br><span class="line">$ icpc -qopenmp -DVECTOR_WIDTH=<span class="number">8</span> -xCORE-AVX512 -S -o fma_avx512_08.s fma_08.c</span><br></pre></td></tr></table></figure>

<h4 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h4><p><a target="_blank" rel="noopener" href="https://github.com/majek/dump/blob/master/how-to-receive-a-million-packets/udpsender.c">udp sender</a><br><a target="_blank" rel="noopener" href="https://github.com/majek/dump/blob/master/how-to-receive-a-million-packets/udpreceiver1.c">udp receiver</a>   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> ((i=4;i&lt;=96;i=i+10)); <span class="keyword">do</span> <span class="built_in">echo</span> CPU core:<span class="variable">$i</span>; <span class="built_in">timeout</span> 5 taskset -c <span class="variable">$i</span> ./receiver 0.0.0.0:4321; <span class="keyword">done</span></span><br><span class="line">CPU core:4</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">CPU core:14</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.411M pps  12.538MiB / 105.177Mb</span><br><span class="line">  0.455M pps  13.891MiB / 116.523Mb</span><br><span class="line">  0.452M pps  13.797MiB / 115.737Mb</span><br><span class="line">  0.430M pps  13.109MiB / 109.969Mb</span><br><span class="line">CPU core:54</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.719M pps  21.929MiB / 183.950Mb</span><br><span class="line">  0.685M pps  20.907MiB / 175.383Mb</span><br><span class="line">  0.680M pps  20.766MiB / 174.199Mb</span><br><span class="line">  0.544M pps  16.611MiB / 139.345Mb</span><br><span class="line">....</span><br><span class="line">CPU core:74</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.936M pps  28.571MiB / 239.668Mb</span><br><span class="line">  0.935M pps  28.540MiB / 239.410Mb</span><br><span class="line">  0.936M pps  28.563MiB / 239.602Mb</span><br><span class="line">  0.948M pps  28.928MiB / 242.669Mb</span><br><span class="line">CPU core:84</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.616M pps  18.786MiB / 157.585Mb</span><br><span class="line">  0.622M pps  18.976MiB / 159.180Mb</span><br><span class="line">  0.618M pps  18.847MiB / 158.102Mb</span><br><span class="line">  0.615M pps  18.780MiB / 157.541Mb</span><br></pre></td></tr></table></figure>

<h4 id="RFC6349-TCP-benchmark"><a href="#RFC6349-TCP-benchmark" class="headerlink" title="RFC6349 TCP benchmark"></a><a target="_blank" rel="noopener" href="https://www.viavisolutions.com/zh-cn/literature/rfc-6349-testing-truespeed-viavi-solutions-experience-your-network-your-custom-application-notes-zh.pdf">RFC6349 TCP benchmark</a></h4><ul>
<li>RFC 4821 through PLPMTUD make sure network path mtu</li>
<li>benchmark RRT(Round-Trip Time) and BB(bottle neck bandwidth)<ul>
<li>example:RRT&#x3D;25ms, bandwidth&#x3D;45Mbps, window&#x3D;64KB, receiver take 12.5ms to sender BDP(bandwidth-delay product) &#x3D; BB * RRT &#x2F;8 &#x3D; 140.625 KB, double sender ‘s window size</li>
<li>TCP global synchronization</li>
<li>RWND(Receive Window)</li>
<li>CWND(Congestion Window)</li>
<li>LFN(Long fat network)</li>
<li>RTD(round-trip delay time)</li>
<li>TDP(Tail drop polocy)</li>
<li>tcp transfer time<ul>
<li>In the 500Mbps netowrk, start 5x transmit services, each transmit means 100Mbps, actually, the 5 x tansmit bandwith are not balancing. 5 x sender transfer 100MB file.<ul>
<li>500MB&#x2F;(500Mbps&#x2F;8)&#x3D;8 sec, in fact, the test use 12sec, that means 12sec&#x2F;8sec&#x3D;1.5, 1.5x late than the theoretically</li>
</ul>
</li>
</ul>
</li>
<li>tcp efficiency<ul>
<li>(total bytes - retrans bytes)&#x2F;total bytes * 100 &#x3D; 98%, in our data center , there are 2 percent tcp retrans. that too bad in some times.</li>
</ul>
</li>
<li>tcp cache latency percent, (test average rrt - base rrt)&#x2F;base rrt * 100, if base rrt&#x3D; 25ms, in the test, the average rrt&#x3D;32ms, (32-25)&#x2F;25*100&#x3D;28%, tcp RTD increase 28%(congestion)</li>
</ul>
</li>
<li>if the tcp performance not reach your expect<ul>
<li>re-gen tcp connection, and modify tcp rwnd size, mtu size</li>
<li>speed limit cause tail drop polocy and cause too many tcp retrans</li>
<li>the maximum tcp cache size, it limit by OS memory size, and to check tcp queue</li>
<li>socket buffer size, a lot of OS could modify the each connection receive and transmit buffer limit. the socket buffer must be large enough.</li>
</ul>
</li>
</ul>
<h4 id="pkggen-kernel-mode"><a href="#pkggen-kernel-mode" class="headerlink" title="pkggen kernel mode"></a>pkggen kernel mode</h4><p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/629155/">The problem, Jesper said, is that the kernel developers have focused on scaling out to large numbers of cores. In the process, they have been able to hide regressions in per-core efficiency. The networking stack, as a result, works well for many workloads, but workloads that are especially latency-sensitive have suffered. The kernel, today, can only forward something between 1M and 2M packets per core every second, while some of the bypass alternatives approach a rate of 15M packets per core per second. Then there is the cost of performing a system call. On a system with SELinux and auditing enabled, that cost is just over 75ns — over the time budget on its own. Disabling auditing and SELinux reduces the time required to just under 42ns, which is better, but that is still a big part of the time budget. There are ways of amortizing that cost over multiple packets; they include system calls like sendmmsg(), recvmmsg(), sendfile(), and splice().</a><br>10GbE Full-duplex, about 2M      </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Result: OK: 958748771(c958745900+d2871) usec, 2000000000 (42byte,0frags)</span><br><span class="line">  2086052pps 700Mb/sec (700913472bps) errors: 0</span><br><span class="line"></span><br><span class="line">Result: OK: 939714052(c939699215+d14836) usec, 2000000000 (42byte,0frags)</span><br><span class="line">  2128307pps 715Mb/sec (715111152bps) errors: 0</span><br><span class="line"></span><br><span class="line">pgset <span class="string">&quot;count 2000000000&quot;</span></span><br><span class="line">pgset <span class="string">&quot;delay 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 8&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pgset <span class="string">&quot;count 2000000000&quot;</span></span><br><span class="line">pgset <span class="string">&quot;delay 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 8&quot;</span></span><br><span class="line"></span><br><span class="line">Result: OK: 184502252(c184496912+d5340) usec, 274564113 (42byte,0frags)</span><br><span class="line">  1488134pps 500Mb/sec (500013024bps) errors: 0</span><br><span class="line"></span><br><span class="line">Result: OK: 183209415(c183209277+d138) usec, 272639542 (42byte,0frags)</span><br><span class="line">  1488130pps 500Mb/sec (500011680bps) errors: 0</span><br></pre></td></tr></table></figure>

<h4 id="nc-test"><a href="#nc-test" class="headerlink" title="nc test"></a>nc test</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ nc -l 22222 &lt; /dev/zero</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 &gt; /dev/null</span><br></pre></td></tr></table></figure>

<h4 id="iperf3"><a href="#iperf3" class="headerlink" title="iperf3"></a>iperf3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ iperf3 -s -D -p 520<span class="variable">$i</span></span><br><span class="line">Client $ iperf3 -c <span class="variable">$client_ip</span> -P 1 -t 360000 -p 520<span class="variable">$i</span></span><br></pre></td></tr></table></figure>

<h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server $ qperf -lp <span class="variable">$port</span> &amp;</span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 36000 -oo msg_size:1K:4K:*2 <span class="variable">$server_ip</span> tcp_bw</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 60 -oo msg_size:64:1024K:*4 <span class="variable">$server_ip</span> tcp_lat</span><br></pre></td></tr></table></figure>

<h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Server $ taskset -c 5 netserver &amp;</span><br><span class="line">Client $ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM</span><br><span class="line"></span><br><span class="line">Server $ numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br></pre></td></tr></table></figure>

<h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./sockperf server --tcp -p 11111</span><br><span class="line">./sockperf server -p 11111 #udp</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br></pre></td></tr></table></figure>




<h4 id="fio-test-multiple-nodes"><a href="#fio-test-multiple-nodes" class="headerlink" title="fio test multiple nodes"></a>fio test multiple nodes</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ fio --server</span><br><span class="line"><span class="comment">## start fio process in each test server</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> fio-test</span><br><span class="line">Server-A-ip</span><br><span class="line">Server-B-ip</span><br><span class="line">Server-C-ip</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ fio --client=fio_hosts.list /mnt/fio.cfg</span><br><span class="line"></span><br><span class="line">All clients: (groupid=0, <span class="built_in">jobs</span>=8): err= 0: pid=0: Fri Mar  6 17:08:04 2020</span><br><span class="line">   <span class="built_in">read</span>: IOPS=1147, BW=1148Mi (1203M)(1011GiB/902172msec)</span><br><span class="line">    slat (nsec): min=58, max=368519, avg=450.92, stdev=799.19</span><br><span class="line">    clat (usec): min=1355, max=4778.4k, avg=58198.62, stdev=114448.04</span><br><span class="line">     lat (usec): min=1356, max=4778.4k, avg=58199.07, stdev=114448.07</span><br><span class="line">   bw (  KiB/s): min= 2043, max=2654208, per=12.74%, avg=149910.02, stdev=178032.72, samples=14109</span><br><span class="line">   iops        : min=    1, max= 2592, avg=146.33, stdev=173.87, samples=14109</span><br><span class="line">  write: IOPS=1146, BW=1146Mi (1202M)(1010GiB/902172msec)</span><br><span class="line">    slat (nsec): min=162, max=916488, avg=799.05, stdev=783.74</span><br><span class="line">    clat (usec): min=1345, max=3839.9k, avg=52775.15, stdev=105530.38</span><br><span class="line">     lat (usec): min=1346, max=3839.9k, avg=52775.95, stdev=105530.41</span><br></pre></td></tr></table></figure>
<p>Test block dev <a target="_blank" rel="noopener" href="https://github.com/axboe/fio/issues/1110">lat</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slat (usec): min=4, max=6154, avg=48.82, stdev=56.38：</span><br></pre></td></tr></table></figure>
<ul>
<li>slat<ul>
<li>Submission latency (min being the minimum, max being the maximum, avg being the average, stdev being the standard deviation). This is the time it took to submit the I&#x2F;O.<ul>
<li>For sync I&#x2F;O this row is not displayed as the slat is really the completion latency (since queue&#x2F;complete is one operation there).</li>
<li>This value can be in nanoseconds, microseconds or milliseconds — fio will choose the most appropriate base and print that (in the example above nanoseconds was the best scale).</li>
<li>Note: in –minimal mode latencies are always expressed in microseconds.</li>
</ul>
</li>
</ul>
</li>
<li>clat<ul>
<li>Completion latency (after submission to completion). Same names as slat, this denotes the time from submission to completion of the I&#x2F;O pieces. For sync I&#x2F;O, clat will usually be equal (or very close) to 0, as the time from submit to complete is basically just CPU time (I&#x2F;O has already been done, see slat explanation).</li>
<li>For sync I&#x2F;O, clat will usually be equal (or very close) to 0, as the time from submit to complete is basically just CPU time (I&#x2F;O has already been done, see slat explanation).</li>
</ul>
</li>
<li>lat<ul>
<li>Total latency. Same names as slat and clat, this denotes the time from when fio created the I&#x2F;O unit to completion of the I&#x2F;O operation.</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">directory=./</span><br><span class="line">iodepth=8</span><br><span class="line">rwmixread=50</span><br><span class="line">numjobs=32</span><br><span class="line">size=100M</span><br><span class="line">norandommap=1</span><br><span class="line">group_reporting</span><br><span class="line">refill_buffers</span><br><span class="line">end_fsync=1</span><br><span class="line">disable_slat=1</span><br><span class="line">exitall</span><br><span class="line"><span class="built_in">timeout</span>=36000</span><br><span class="line">direct=0</span><br><span class="line">nrfiles=8</span><br><span class="line">bssplit=4k/10:32k/20:64k/20:128k/20:256k/20:1024k/10</span><br><span class="line">[job1]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job2]</span><br><span class="line">rw=<span class="built_in">read</span></span><br><span class="line">ioengine=psync</span><br></pre></td></tr></table></figure>
<ul>
<li>randseed&#x3D;int<ul>
<li>Seed the random number generators based on this seed value, to be able to control what sequence of output is being generated. If not set, the random sequence depends on the randrepeat setting.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ fio -rw=randread -ioengine=libaio -name=rw -numjobs=1 -runtime=10 -filename=/dev/sda1 --debug=random | <span class="built_in">head</span></span><br><span class="line">fio: <span class="built_in">set</span> debug option random</span><br><span class="line">rw: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1</span><br><span class="line">fio-3.7</span><br><span class="line">Starting 1 process</span><br><span class="line">random   37700 off rand 259043585</span><br><span class="line">random   37700 off rand 3179521932</span><br><span class="line">random   37700 off rand 3621444214</span><br><span class="line">random   37700 off rand 2018697059</span><br><span class="line">random   37700 off rand 1726199243</span><br><span class="line">random   37700 off rand 3608323581</span><br><span class="line">fio: pid=37700, got signal=13</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">- fio verify  </span><br><span class="line">  - verify=crc64</span><br><span class="line">  - do_verify=1 (<span class="built_in">enable</span> verify, default enabled)</span><br><span class="line">  - verify_pattern=<span class="string">&#x27;xxxxxx&#x27;</span></span><br><span class="line">  - verify=meta(This  option  is deprecated)</span><br></pre></td></tr></table></figure>
   verify&#x3D;str<br>      If writing to a file, fio can verify the file contents after each iteration of the job. Each verification method also implies<br>      verification  of special header, which is written to the beginning of each block. This header also includes meta information,<br>      like offset of the block, block number, timestamp when block was written, etc. verify can  be  combined  with  verify_pattern<br>      option. The allowed values are:<br>             crc64  Use an experimental crc64 sum of the data area and store it in the header of each block.<br>             crc32c Use  a  crc32c sum of the data area and store it in the header of each block. This will automatically use hard‐<br>                    ware acceleration (e.g. SSE4.2 on an x86 or CRC crypto extensions on ARM64) but  will  fall  back  to  software<br>                    crc32c if none is found. Generally the fastest checksum fio supports when hardware accelerated.<br>             crc32c-intel<br>                    Synonym for crc32c.<br>             crc32  Use a crc32 sum of the data area and store it in the header of each block.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">- fio test metadata</span><br><span class="line">```bash</span><br><span class="line">--ioengine=posixaio --openfiles=10000 --numjobs=$DP_NUM --filesize=64k --lockfile=readwrite</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>fio io_uring<br><a target="_blank" rel="noopener" href="https://github.com/Linkerist/blog/issues/25">libaio issues</a></p>
<ul>
<li>just support direct IO, no cache and alignment issue, direct IO is good for high-performance device<ul>
<li>not cache means simply</li>
</ul>
</li>
<li>block too in some cases<ul>
<li>io_getevents(2) —&gt; read_events to read AIO finished events<ul>
<li>wait_event_interruptible_hrtimeout of the read_events cause the blocked (sleep by __wait_event_hrtimeout)</li>
</ul>
</li>
</ul>
</li>
<li>copy overhead<ul>
<li>each IO will copy 64 + 8 Bytes when submit</li>
<li>each IO completed copy 32 Bytes</li>
<li>Total 104 Bytes<ul>
<li>not good for the small IO</li>
</ul>
</li>
</ul>
</li>
<li>API<ul>
<li>each IO has 2 x system call<ul>
<li>submit</li>
<li>wait for completion</li>
<li>events loss carefully</li>
<li>CVE-2017-5754 cause performance degraded</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/block_dump</span><br><span class="line">$ fio --name=randread --rw=randread --bs=4K --ioengine=io_uring --sqthread_poll=1 --size=1000G --numjobs=1 --filename=/dev/disk/by-id/ata-ST31000340NS_9QJ1CAAA-part1 --direct=1 --group_reporting</span><br><span class="line"></span><br><span class="line">fio(2039789): READ block 21187832 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 27664240 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 20709568 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 17529624 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 27647664 on sdb1 (8 sectors)</span><br></pre></td></tr></table></figure>




<h4 id="test-softlock-and-hardlock-in-kernel"><a href="#test-softlock-and-hardlock-in-kernel" class="headerlink" title="test softlock and hardlock in kernel"></a>test softlock and hardlock in kernel</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">hog.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">hog_thread</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hogging a CPU now\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* unreached */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init</span><br><span class="line"><span class="title function_">hog_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, <span class="literal">NULL</span>, <span class="string">&quot;hog&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line"><span class="meta">#makefile</span></span><br><span class="line">obj-m += hog.o</span><br><span class="line"> </span><br><span class="line">all:</span><br><span class="line">    make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) modules</span><br><span class="line">clean:</span><br><span class="line">    make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) clean</span><br><span class="line"></span><br><span class="line"><span class="meta"># in centos </span></span><br><span class="line">$ cat Makefile</span><br><span class="line">obj-m += hog.o</span><br><span class="line"></span><br><span class="line">all: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">clean: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$ make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">$ ls </span><br><span class="line">hog.c  hog.ko  hog.mod.c  hog.mod.o  hog.o  Makefile  modules.order  Module.symvers</span><br><span class="line"></span><br><span class="line">$ insmod hog.ko</span><br><span class="line">$ lsmod | grep hog</span><br><span class="line">hog                    <span class="number">12386</span>  <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> kernel:NMI watchdog: BUG: soft lockup - CPU#<span class="number">0</span> stuck <span class="keyword">for</span> <span class="number">23</span>s! [hog:<span class="number">2308</span>]</span><br><span class="line"></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] NMI watchdog: BUG: soft lockup - CPU#<span class="number">0</span> stuck <span class="keyword">for</span> <span class="number">23</span>s! [hog:<span class="number">2308</span>]</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Modules linked in: hog(OE) dell_rbu dcdbas sunrpc nfit libnvdimm zfs(POE) zunicode(POE) zavl(POE) icp(POE) ppdev iosf_mbi crc32_pclmul ghash_clmulni_intel joydev zcommon(POE) znvpair(POE) spl(OE) sg aesni_intel virtio_balloon virtio_rng lrw gf128mul glue_helper ablk_helper cryptd pcspkr i2c_piix4 parport_pc parport binfmt_misc ip_tables xfs libcrc32c sr_mod sd_mod cdrom crc_t10dif crct10dif_generic ata_generic pata_acpi virtio_console virtio_net virtio_blk virtio_scsi qxl drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm drm crct10dif_pclmul crct10dif_common crc32c_intel ata_piix ahci libahci libata serio_raw virtio_pci virtio_ring virtio floppy drm_panel_orientation_quirks dm_mirror dm_region_hash dm_log dm_mod</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] CPU: <span class="number">0</span> PID: <span class="number">2308</span> Comm: hog Kdump: loaded Tainted: P           OE  ------------   <span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span>.el7.x86_64 #<span class="number">1</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Hardware name: Red Hat KVM, BIOS <span class="number">1.11</span><span class="number">.1</span><span class="number">-4.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">189</span>+f9babebb <span class="number">04</span>/<span class="number">01</span>/<span class="number">2014</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] task: ffff9c0335878000 ti: ffff9c03356a4000 task.ti: ffff9c03356a4000</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RIP: <span class="number">0010</span>:[&lt;ffffffffc0721017&gt;]  [&lt;ffffffffc0721017&gt;] hog_thread+<span class="number">0x17</span>/<span class="number">0x1000</span> [hog]</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RSP: <span class="number">0018</span>:ffff9c03356a7ec0  EFLAGS: <span class="number">00000246</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RAX: <span class="number">0000000000000011</span> RBX: ffff9c03356a7e50 RCX: <span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RDX: <span class="number">0000000000000000</span> RSI: ffff9c033dc13898 RDI: ffff9c033dc13898</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RBP: ffff9c03356a7ec0 R08: <span class="number">0000000000000000</span> R09: <span class="number">0000000000000040</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] R10: <span class="number">000000000000029</span>a R11: <span class="number">0000000000</span>aaaaaa R12: <span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] R13: ffffffffc0721000 R14: <span class="number">0000000000000000</span> R15: ffff9c03352ebc90</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] FS:  <span class="number">0000000000000000</span>(<span class="number">0000</span>) GS:ffff9c033dc00000(<span class="number">0000</span>) knlGS:<span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] CS:  <span class="number">0010</span> DS: <span class="number">0000</span> ES: <span class="number">0000</span> CR0: <span class="number">0000000080050033</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] CR2: <span class="number">0000561560589e20</span> CR3: <span class="number">0000000006010000</span> CR4: <span class="number">00000000003606f</span>0</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] DR0: <span class="number">0000000000000000</span> DR1: <span class="number">0000000000000000</span> DR2: <span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] DR3: <span class="number">0000000000000000</span> DR6: <span class="number">00000000f</span>ffe0ff0 DR7: <span class="number">0000000000000400</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Call Trace:</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa08c50d1&gt;] kthread+<span class="number">0xd1</span>/<span class="number">0xe0</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa08c5000&gt;] ? insert_kthread_work+<span class="number">0x40</span>/<span class="number">0x40</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa0f8cd37&gt;] ret_from_fork_nospec_begin+<span class="number">0x21</span>/<span class="number">0x21</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa08c5000&gt;] ? insert_kthread_work+<span class="number">0x40</span>/<span class="number">0x40</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Code: &lt;eb&gt; fe <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>Enable nmi_watchdog&#x3D;1 in kernel  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat hard.c</span><br><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/kernel.h&gt;</span><br><span class="line">#include &lt;linux/kthread.h&gt;</span><br><span class="line">#include &lt;linux/spinlock.h&gt;</span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"> </span><br><span class="line">static int</span><br><span class="line">hog_thread(void *data)</span><br><span class="line">&#123;</span><br><span class="line">    static DEFINE_SPINLOCK(lock);</span><br><span class="line">    unsigned long flags;</span><br><span class="line"> </span><br><span class="line">    printk(KERN_INFO &quot;Hogging a CPU now\n&quot;);</span><br><span class="line">    spin_lock_irqsave(&amp;lock, flags);</span><br><span class="line">    while (1);</span><br><span class="line"> </span><br><span class="line">    /* unreached */</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static int __init</span><br><span class="line">hog_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, NULL, &quot;hog&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line">obj-m += hard.o</span><br><span class="line"></span><br><span class="line">all: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">clean: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$  make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">make: Entering directory `/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span><br><span class="line">  CC [M]  /root/hardhog/hard.o</span><br><span class="line">  Building modules, stage 2.</span><br><span class="line">  MODPOST 1 modules</span><br><span class="line">  CC      /root/hardhog/hard.mod.o</span><br><span class="line">  LD [M]  /root/hardhog/hard.ko</span><br><span class="line"></span><br><span class="line">$ insmod hard.ko</span><br><span class="line"></span><br><span class="line"># after insmod, the KVM ssh not respond too.</span><br></pre></td></tr></table></figure>

<h4 id="ab"><a href="#ab" class="headerlink" title="ab"></a>ab</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 10000 -c 300 http://xx.xx.xx.xx/test.php</span><br></pre></td></tr></table></figure>

<h4 id="RoCEv2-benchmark"><a href="#RoCEv2-benchmark" class="headerlink" title="RoCEv2 benchmark"></a>RoCEv2 benchmark</h4><h5 id="rping"><a href="#rping" class="headerlink" title="rping"></a>rping</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server A $ rping -s</span><br><span class="line">Server B $ rping -c -a 192.168.0.2 -v</span><br><span class="line">ping data: rdma-ping-0: ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqr</span><br><span class="line">ping data: rdma-ping-1: BCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrs</span><br></pre></td></tr></table></figure>

<h5 id="ibv-rc-pingpong"><a href="#ibv-rc-pingpong" class="headerlink" title="ibv_rc_pingpong"></a>ibv_rc_pingpong</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Server A $ ibv_rc_pingpong -g 0 -d bnxt_re1 -i 1 -r 1000 -n 9999999 -l 10</span><br><span class="line">  <span class="built_in">local</span> address:  LID 0x0000, QPN 0x000609, PSN 0xbf578f, GID fe80::b226:28ff:fee0:4d11</span><br><span class="line">  remote address: LID 0x0000, QPN 0x0003ec, PSN 0xdbc936, GID fe80::9a03:9bff:fe90:8040</span><br><span class="line">81919991808 bytes <span class="keyword">in</span> 56.09 seconds = 11684.77 Mbit/sec</span><br><span class="line">9999999 iters <span class="keyword">in</span> 56.09 seconds = 5.61 usec/iter</span><br><span class="line"></span><br><span class="line">Server B $  ibv_rc_pingpong -g 0 -d mlx5_0 -r 1000 -n 9999999 -l 10 192.168.0.2</span><br><span class="line">  <span class="built_in">local</span> address:  LID 0x0000, QPN 0x0003ec, PSN 0xdbc936, GID fe80::9a03:9bff:fe90:8040</span><br><span class="line">  remote address: LID 0x0000, QPN 0x000609, PSN 0xbf578f, GID fe80::b226:28ff:fee0:4d11</span><br><span class="line">81919991808 bytes <span class="keyword">in</span> 56.09 seconds = 11684.59 Mbit/sec</span><br><span class="line">9999999 iters <span class="keyword">in</span> 56.09 seconds = 5.61 usec/iter</span><br></pre></td></tr></table></figure>

<h5 id="qperf-1"><a href="#qperf-1" class="headerlink" title="qperf"></a>qperf</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Server A $ qerf</span><br><span class="line">Server B $ qperf -cm1 -t 3600 -oo msg_size:64 192.168.0.2 rc_lat</span><br><span class="line"></span><br><span class="line">Server A $ qperf -lp 4002</span><br><span class="line">Server B $ qperf -cm1 -lp 4002 -t 3600 -oo msg_size:64 192.168.0.2 rc_bw</span><br></pre></td></tr></table></figure>

<h5 id="perftest"><a href="#perftest" class="headerlink" title="perftest"></a>perftest</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">size: 2, 64, 4096, 16384, tps and latency</span><br><span class="line">server: ib_read_lat -d mlx5_0 -p 18515 -F -s 2 -D 300 -n 100000 --cpu_util --rdma_cm</span><br><span class="line">client: ib_read_lat -d bnxt_re1 -p 18515 -F -s 2 -D 300 -n 100000 --cpu_util --rdma_cm 192.168.0.2</span><br><span class="line"></span><br><span class="line">size: 262144, 1048576, bw and latency</span><br><span class="line">server: ib_read_bw -d mlx5_0 -p 18525 -b -F -s 1048576 -D 300 -n 100000 --cpu_util --rdma_cm</span><br><span class="line">client: ib_read_bw -d bnxt_re1 -p 18525 -b -F -s 1048576 -D 300 -n 100000 --cpu_util --rdma_cm 192.168.0.2</span><br><span class="line"><span class="comment">#ib_write, ib_send....</span></span><br><span class="line"></span><br><span class="line">port_num=18515</span><br><span class="line">time_out=300</span><br><span class="line">server_dev=mlx5_0</span><br><span class="line">client_dev=bnxt_re1</span><br><span class="line">server_testip=192.168.0.2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> ------------- lat</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 2 64 4096 16384</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_read_lat -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_read_lat -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_write_lat -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_write_lat -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> ------------- bw</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 262144 1048576</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_read_bw -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_read_bw -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_write_bw -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm </span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_write_bw -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="MEM"><a href="#MEM" class="headerlink" title="MEM"></a>MEM</h4><h5 id="lmbench"><a href="#lmbench" class="headerlink" title="lmbench"></a>lmbench</h5><p>lat_mem_rd  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#compare diff cores</span></span><br><span class="line">$ numactl -C 38 -m 0 ./lat_mem_rd  -N 5 -W 5 -t 128M</span><br><span class="line">$ numactl -C 38 -m 1 ./lat_mem_rd  -N 5 -W 5 -t 128M</span><br><span class="line">$ numactl -C 38 -m 2 ./lat_mem_rd  -N 5 -W 5 -t 128M</span><br><span class="line">$ numactl -C 38 -m 3 ./lat_mem_rd  -N 5 -W 5 -t 128M</span><br><span class="line"></span><br><span class="line"><span class="comment">#-t test TLB miss and Cache miss for memory latency</span></span><br><span class="line">$ numactl -C 0 -m 0 ./bin/lat_mem_rd -W 5 -N 5 -t 2000M</span><br><span class="line"></span><br><span class="line">1 Cycle per Microsecond</span><br><span class="line">A period of 1 Microsecond(µs)= is equal to 1 000 000 Hertz frequency</span><br><span class="line"></span><br><span class="line">https://www.genci.fr/sites/default/files/PhysiqueChimie_CALMIP-Scemama.pdf</span><br><span class="line">2x Xeon E5-2670 @ 2.6 GHz, 1x cycle = 0.38ns</span><br><span class="line">L1 : 1.2 ns (3-4 cycles)</span><br><span class="line">L2 : 3.6 ns (9-10 cycles)</span><br><span class="line">L3 : 16 ns (42 cycles)</span><br><span class="line">RAM : 86 / 155 ns (224-403 cycles)</span><br><span class="line"></span><br><span class="line">Intel Xeon E7-8837 @ 2.67 GHz</span><br><span class="line">1 cycle CPU: 0.37 ns</span><br><span class="line">  Au maximum 8 flops/cycle (SP), donc 1 flop ~ 0.047 ns</span><br><span class="line">L1 : 1.5 ns (4 cycles)</span><br><span class="line">L2 : 3.7 ns (10 cycles)</span><br><span class="line">L3 : 16 ns (43 cycles)</span><br><span class="line">RAM : 195 / 228 / 570 / 670 / 760 / 875 / 957 ns (520-2555 cycles), looks like 4x socket ?</span><br><span class="line">Infiniband: 1200 ns (3204 cycles)</span><br><span class="line"></span><br><span class="line"><span class="comment">#in my test</span></span><br><span class="line">RoCEv2, 2 Bytes: 3270 ns(8606 cycles)</span><br><span class="line"></span><br><span class="line">https://web.eecs.umich.edu/~chshibo/files/microkiller_report.pdf</span><br><span class="line">average direct cost of user-level context switch time is 1.18µs=1180 ns</span><br><span class="line"></span><br><span class="line">https://lenovopress.lenovo.com/lp1362-thinksystem-kioxia-cm6-r-entry-nvme-pcie-40-x4-ssd</span><br><span class="line">KIOXIA CM6 SSD PCIE Gen4 random <span class="built_in">read</span> 90µs, random write 20µs, power:20w</span><br><span class="line"></span><br><span class="line">SSD <span class="built_in">read</span> 1MB data 85µs(calculate by HDD), 4KiB iops 1,400,000</span><br><span class="line">HDD seek time 10ms</span><br><span class="line">HDD <span class="built_in">read</span> 1MB data 20ms, 4KiB <span class="built_in">seq</span> iops about 6000+  </span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/QNgMS0gOXhZml8l_towAbw">mem-lat.c</a>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ONE p = (char **)*p;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIVE    ONE ONE ONE ONE ONE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEN FIVE FIVE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIFTY   TEN TEN TEN TEN TEN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HUNDRED FIFTY FIFTY</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">usage</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: ./mem-lat -b xxx -n xxx -s xxx\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -b buffer size in KB\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -n number of read\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -s stride skipped before the next access\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please don&#x27;t use non-decimal based number\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> i, j, size, tmp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> memsize = <span class="number">0x800000</span>; <span class="comment">/* 1/4 LLC size of skylake, 1/5 of broadwell */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> count = <span class="number">1048576</span>; <span class="comment">/* memsize / 64 * 8 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> stride = <span class="number">64</span>; <span class="comment">/* skipped amount of memory before the next access */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sec, usec;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv1</span>, <span class="title">tv2</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timezone</span> <span class="title">tz</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *indices;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*argv)[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;  <span class="comment">/* look at first char of next */</span></span><br><span class="line">            <span class="keyword">switch</span> ((*argv)[<span class="number">1</span>]) &#123;   <span class="comment">/* look at second */</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                    argv++;</span><br><span class="line">                    argc--;</span><br><span class="line">                    memsize = atoi(*argv) * <span class="number">1024</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">                    argv++;</span><br><span class="line">                    argc--;</span><br><span class="line">                    count = atoi(*argv);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                    argv++;</span><br><span class="line">                    argc--;</span><br><span class="line">                    stride = atoi(*argv);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    usage();</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        argv++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="type">char</span>* mem = mmap(<span class="literal">NULL</span>, memsize, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// trick3: init pointer chasing, per stride=8 byte</span></span><br><span class="line">    size = memsize / stride;</span><br><span class="line">    indices = <span class="built_in">malloc</span>(size * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        indices[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trick 2: fill mem with pointer references</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size - <span class="number">1</span>; i++)</span><br><span class="line">        *(<span class="type">char</span> **)&amp;mem[indices[i]*stride]= (<span class="type">char</span>*)&amp;mem[indices[i+<span class="number">1</span>]*stride];</span><br><span class="line">    *(<span class="type">char</span> **)&amp;mem[indices[size<span class="number">-1</span>]*stride]= (<span class="type">char</span>*)&amp;mem[indices[<span class="number">0</span>]*stride];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shuffle indices</span></span><br><span class="line">    <span class="comment">/* for (i = 0; i &lt; size; i++) &#123;</span></span><br><span class="line"><span class="comment">         j = i +  rand() % (size - i);</span></span><br><span class="line"><span class="comment">         if (i != j) &#123;</span></span><br><span class="line"><span class="comment">             tmp = indices[i];</span></span><br><span class="line"><span class="comment">             indices[i] = indices[j];</span></span><br><span class="line"><span class="comment">             indices[j] = tmp;</span></span><br><span class="line"><span class="comment">         &#125;</span></span><br><span class="line"><span class="comment">     &#125; */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> **p = (<span class="type">char</span> **) mem;</span><br><span class="line">    <span class="comment">//register char **p = (char **)mem;</span></span><br><span class="line"></span><br><span class="line">    tmp = count / <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gettimeofday (&amp;tv1, &amp;tz);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmp; ++i) &#123;</span><br><span class="line">        HUNDRED;  <span class="comment">//trick 1</span></span><br><span class="line">    &#125;</span><br><span class="line">    gettimeofday (&amp;tv2, &amp;tz);</span><br><span class="line">    <span class="keyword">if</span> (tv2.tv_usec &lt; tv1.tv_usec) &#123;</span><br><span class="line">        usec = <span class="number">1000000</span> + tv2.tv_usec - tv1.tv_usec;</span><br><span class="line">        sec = tv2.tv_sec - tv1.tv_sec - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        usec = tv2.tv_usec - tv1.tv_usec;</span><br><span class="line">        sec = tv2.tv_sec - tv1.tv_sec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Buffer size: %ld KB, stride %d, time %d.%06d s, latency %.2f ns\n&quot;</span>,</span><br><span class="line">            memsize/<span class="number">1024</span>, stride, sec, usec, (sec * <span class="number">1000000</span>  + usec) * <span class="number">1000.0</span> / (tmp *<span class="number">100</span>));</span><br><span class="line">    munmap(mem, memsize);</span><br><span class="line">    <span class="built_in">free</span>(indices);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">work=./mem-lat</span><br><span class="line">buffer_size=1</span><br><span class="line">stride=8</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">seq</span> 1 15`; <span class="keyword">do</span></span><br><span class="line">    taskset -ac 0 <span class="variable">$work</span> -b <span class="variable">$buffer_size</span> -s <span class="variable">$stride</span></span><br><span class="line">    buffer_size=$((<span class="variable">$buffer_size</span>*<span class="number">2</span>))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><a href="">pause.c</a></p>
<ul>
<li>Decrease the switch context</li>
<li>The another HT logic core could be use</li>
<li>Keep power save</li>
<li>The PAUSE instruction is first introduced for Intel Pentium 4 processor to improve the performance of “spin-wait loop”. The PAUSE instruction is typically used with software threads executing on two logical processors located in the same processor core, waiting for a lock to be released. Such short wait loops tend to last between tens and a few hundreds of cycles. When the wait loop is expected to last for thousands of cycles or more, it is preferable to yield to the operating system by calling one of the OS synchronization API functions, such as WaitForSingleObject on Windows OS.</li>
<li>An Intel® processor suffers a severe performance penalty when exiting the loop because it detects a possible memory order violation. The PAUSE instruction provides a hint to the processor that the code sequence is a spin-wait loop. The processor uses this hint to avoid the memory order violation in most situations. The PAUSE instruction can improve the performance of the processors supporting Intel Hyper-Threading Technology when executing “spin-wait loops”. With pause instruction, processors are able to avoid the memory order violation and pipeline flush, and reduce power consumption through pipeline stall.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">$ perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./pause</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMES 5</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title function_">rdtsc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> low, high;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdtsc&quot;</span> : <span class="string">&quot;=a&quot;</span> (low), <span class="string">&quot;=d&quot;</span> (high) )</span>;</span><br><span class="line">    <span class="keyword">return</span> ((low) | (high) &lt;&lt; <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pause_test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TIMES; i++) &#123;</span><br><span class="line">        <span class="keyword">asm</span>(</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span></span><br><span class="line">                ::</span><br><span class="line">                :);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">pause_cycle</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start, finish, elapsed;</span><br><span class="line">    start = rdtsc();</span><br><span class="line">    pause_test();</span><br><span class="line">    finish = rdtsc();</span><br><span class="line">    elapsed = finish - start;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Pause的cycles约为:%ld\n&quot;</span>, elapsed / <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    pause_cycle();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">long</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      count++;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ perf top --<span class="keyword">asm</span>-raw -p  <span class="number">70832</span></span><br><span class="line"></span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">12.03</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">25.51</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">23.43</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">24.81</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line"> <span class="number">14.22</span> │     eb     f6                   jmp    <span class="number">400400</span> &lt;main&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>intel x86 cpu bound and memory bound   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ sudo perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores -a ./memory_bound</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emmintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">memory_bound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="type">unsigned</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">register</span> <span class="type">char</span> b;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;(<span class="number">1u</span>&lt;&lt;<span class="number">24</span>);i++) &#123;</span><br><span class="line">                <span class="comment">// evict cacheline containing a</span></span><br><span class="line">                 _mm_clflush(&amp;a);</span><br><span class="line">                 b = a;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">cpu_bound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="type">unsigned</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;(<span class="number">1u</span>&lt;&lt;<span class="number">31</span>);i++) &#123;</span><br><span class="line">                __asm__ (<span class="string">&quot;nop\nnop\nnop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">          <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>; ++i)&#123;</span><br><span class="line">                 <span class="comment">//cpu_bound();</span></span><br><span class="line">                 memory_bound();</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="uarch-bench"><a href="#uarch-bench" class="headerlink" title="uarch-bench"></a><a target="_blank" rel="noopener" href="https://github.com/travisdowns/uarch-bench">uarch-bench</a></h4><h4 id="contextswitch"><a href="#contextswitch" class="headerlink" title="contextswitch"></a><a target="_blank" rel="noopener" href="https://github.com/tsuna/contextswitch">contextswitch</a></h4><h4 id="X-mem"><a href="#X-mem" class="headerlink" title="X-mem"></a><a target="_blank" rel="noopener" href="https://nanocad-lab.github.io/X-Mem/">X-mem</a></h4><p>####<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/tool/intelr-memory-latency-checker.html">intel mlc</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlc -c2c_latency -c2 -w22 -b200000 -C128</span><br></pre></td></tr></table></figure>
<p>The above command is used to measure the time taken to transfer a modified line from L2 cache to another core on a different socket. Writer thread ‘w’ pinned to cpu 22 modifies 128KB of data (as specified in –C parameter) and transfers control to reader thread ‘c’ on cpu 2. Now, this thread reads the same 128KB of data that is currently resident in L2 of thread 22. Since those lines are in M state, the snoop responses would be Hit-modified (aka HITM) and the line would be transferred from the cache to the requester. Then the control is transferred back to the writer thread and this thread would move the window to another 128KB range in the buffer specified by –b parameter and the process will be repeated.</p>
<h4 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h4><p>Show the issues of the toshiba and seagate NLSAS HDD   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scsi_dev=/dev/disk/by-id/scsi-35000ff12727bd315</span><br><span class="line">bsize=$(($(blockdev --getsz <span class="variable">$scsi_dev</span>)*<span class="number">512</span>))</span><br><span class="line">start_t=$(<span class="built_in">date</span> +%s)</span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;=999;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">dd</span> <span class="keyword">if</span>=<span class="variable">$scsi_dev</span> of=<span class="variable">$scsi_dev</span> bs=1 seek=$(<span class="built_in">shuf</span> -i 1-<span class="variable">$bsize</span> -n 1) skip=$(<span class="built_in">shuf</span> -i 1-<span class="variable">$bsize</span> -n 1) iflag=<span class="built_in">sync</span> oflag=<span class="built_in">sync</span> count=3 &gt;/dev/null 2&gt;/dev/null &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"><span class="built_in">echo</span> $(($(date +%s)-start_t))<span class="string">&quot; secs&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> k <span class="keyword">in</span> &#123;0..19&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;---------HDD------------&quot;</span> <span class="variable">$k</span> ; sh test16.sh; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>


  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jemalloc-TCMalloc"><span class="toc-number">1.</span> <span class="toc-text">Jemalloc TCMalloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calculate-upload-x2F-download-speed-by-ping"><span class="toc-number">2.</span> <span class="toc-text">calculate upload&#x2F;download speed by ping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openssl"><span class="toc-number">3.</span> <span class="toc-text">openssl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bash"><span class="toc-number">4.</span> <span class="toc-text">bash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sysbech"><span class="toc-number">5.</span> <span class="toc-text">sysbech</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#test-mysql"><span class="toc-number">5.1.</span> <span class="toc-text">test mysql</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis"><span class="toc-number">6.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linpack-for-x86"><span class="toc-number">7.</span> <span class="toc-text">Linpack for x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AVX"><span class="toc-number">8.</span> <span class="toc-text">AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP"><span class="toc-number">9.</span> <span class="toc-text">UDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RFC6349-TCP-benchmark"><span class="toc-number">10.</span> <span class="toc-text">RFC6349 TCP benchmark</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pkggen-kernel-mode"><span class="toc-number">11.</span> <span class="toc-text">pkggen kernel mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nc-test"><span class="toc-number">12.</span> <span class="toc-text">nc test</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iperf3"><span class="toc-number">13.</span> <span class="toc-text">iperf3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qperf"><span class="toc-number">14.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#netperf"><span class="toc-number">15.</span> <span class="toc-text">netperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sockperf"><span class="toc-number">16.</span> <span class="toc-text">sockperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fio-test-multiple-nodes"><span class="toc-number">17.</span> <span class="toc-text">fio test multiple nodes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-softlock-and-hardlock-in-kernel"><span class="toc-number">18.</span> <span class="toc-text">test softlock and hardlock in kernel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ab"><span class="toc-number">19.</span> <span class="toc-text">ab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoCEv2-benchmark"><span class="toc-number">20.</span> <span class="toc-text">RoCEv2 benchmark</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rping"><span class="toc-number">20.1.</span> <span class="toc-text">rping</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ibv-rc-pingpong"><span class="toc-number">20.2.</span> <span class="toc-text">ibv_rc_pingpong</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#qperf-1"><span class="toc-number">20.3.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#perftest"><span class="toc-number">20.4.</span> <span class="toc-text">perftest</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MEM"><span class="toc-number">21.</span> <span class="toc-text">MEM</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lmbench"><span class="toc-number">21.1.</span> <span class="toc-text">lmbench</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uarch-bench"><span class="toc-number">22.</span> <span class="toc-text">uarch-bench</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#contextswitch"><span class="toc-number">23.</span> <span class="toc-text">contextswitch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X-mem"><span class="toc-number">24.</span> <span class="toc-text">X-mem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dd"><span class="toc-number">25.</span> <span class="toc-text">dd</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/14/benchmark/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/14/benchmark/&text=benchmark"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/14/benchmark/&is_video=false&description=benchmark"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=benchmark&body=Check out this article: http://example.com/2022/11/14/benchmark/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/14/benchmark/&name=benchmark&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/14/benchmark/&t=benchmark"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

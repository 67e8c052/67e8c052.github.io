<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="benchmark settingFor all benchmarks I recommend to turn off frequency scaling, hyper-threading, Turbo mode, address space randomization and other stuff that can increase noise. I’m using the following">
<meta property="og:type" content="article">
<meta property="og:title" content="benchmark">
<meta property="og:url" content="http://example.com/2022/11/14/benchmark/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="benchmark settingFor all benchmarks I recommend to turn off frequency scaling, hyper-threading, Turbo mode, address space randomization and other stuff that can increase noise. I’m using the following">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-14T07:35:11.000Z">
<meta property="article:modified_time" content="2024-01-03T01:08:06.098Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="bench">
<meta property="article:tag" content="test">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>benchmark</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/14/mem/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/14/lsi/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/14/benchmark/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/14/benchmark/&text=benchmark"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/14/benchmark/&is_video=false&description=benchmark"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=benchmark&body=Check out this article: http://example.com/2022/11/14/benchmark/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/14/benchmark/&name=benchmark&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/14/benchmark/&t=benchmark"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#benchmark-setting"><span class="toc-number">1.</span> <span class="toc-text">benchmark setting</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jemalloc-TCMalloc"><span class="toc-number">2.</span> <span class="toc-text">Jemalloc TCMalloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calculate-upload-download-speed-by-ping"><span class="toc-number">3.</span> <span class="toc-text">calculate upload&#x2F;download speed by ping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stress-ng"><span class="toc-number">4.</span> <span class="toc-text">stress-ng</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openssl"><span class="toc-number">5.</span> <span class="toc-text">openssl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bash"><span class="toc-number">6.</span> <span class="toc-text">bash</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#posgresql"><span class="toc-number"></span> <span class="toc-text">posgresql</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sysbech"><span class="toc-number">1.</span> <span class="toc-text">sysbech</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#test-mysql-mariadb-posgresql"><span class="toc-number">1.1.</span> <span class="toc-text">test mysql&#x2F;mariadb&#x2F;posgresql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#install"><span class="toc-number">1.2.</span> <span class="toc-text">install</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis"><span class="toc-number">2.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linpack-for-x86"><span class="toc-number">3.</span> <span class="toc-text">Linpack for x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AVX"><span class="toc-number">4.</span> <span class="toc-text">AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP"><span class="toc-number">5.</span> <span class="toc-text">UDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RFC6349-TCP-benchmark"><span class="toc-number">6.</span> <span class="toc-text">RFC6349 TCP benchmark</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pkggen-kernel-mode"><span class="toc-number">7.</span> <span class="toc-text">pkggen kernel mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nc-test"><span class="toc-number">8.</span> <span class="toc-text">nc test</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iperf3"><span class="toc-number">9.</span> <span class="toc-text">iperf3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qperf"><span class="toc-number">10.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pktgen-DPDK"><span class="toc-number">11.</span> <span class="toc-text">Pktgen-DPDK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#netperf"><span class="toc-number">12.</span> <span class="toc-text">netperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sockperf"><span class="toc-number">13.</span> <span class="toc-text">sockperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fio-test-multiple-nodes"><span class="toc-number">14.</span> <span class="toc-text">fio test multiple nodes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#NVIDIA-GPU-Direct-Storage"><span class="toc-number">14.1.</span> <span class="toc-text">NVIDIA GPU Direct Storage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-softlock-and-hardlock-in-kernel"><span class="toc-number">15.</span> <span class="toc-text">test softlock and hardlock in kernel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ab"><span class="toc-number">16.</span> <span class="toc-text">ab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoCEv2-benchmark"><span class="toc-number">17.</span> <span class="toc-text">RoCEv2 benchmark</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rping"><span class="toc-number">17.1.</span> <span class="toc-text">rping</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ibv-rc-pingpong"><span class="toc-number">17.2.</span> <span class="toc-text">ibv_rc_pingpong</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#qperf-1"><span class="toc-number">17.3.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#perftest"><span class="toc-number">17.4.</span> <span class="toc-text">perftest</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MEM"><span class="toc-number">18.</span> <span class="toc-text">MEM</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lmbench"><span class="toc-number">18.1.</span> <span class="toc-text">lmbench</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uarch-bench"><span class="toc-number">19.</span> <span class="toc-text">uarch-bench</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#contextswitch"><span class="toc-number">20.</span> <span class="toc-text">contextswitch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X-mem"><span class="toc-number">21.</span> <span class="toc-text">X-mem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dd"><span class="toc-number">22.</span> <span class="toc-text">dd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Emulate-simulate-some-errors-to-test-the-block-device"><span class="toc-number">23.</span> <span class="toc-text">Emulate&#x2F;simulate some errors to test the block device</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dm-delay"><span class="toc-number">23.1.</span> <span class="toc-text">dm-delay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dm-linear"><span class="toc-number">23.2.</span> <span class="toc-text">dm-linear</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dm-flakey"><span class="toc-number">24.</span> <span class="toc-text">dm-flakey</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Switch-off-quiet-mode"><span class="toc-number"></span> <span class="toc-text">Switch off quiet mode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MPI-test"><span class="toc-number"></span> <span class="toc-text">MPI test</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IOR"><span class="toc-number">1.</span> <span class="toc-text">IOR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDTEST"><span class="toc-number">2.</span> <span class="toc-text">MDTEST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stream"><span class="toc-number">3.</span> <span class="toc-text">stream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HPL-linpack"><span class="toc-number">4.</span> <span class="toc-text">HPL linpack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO500"><span class="toc-number">5.</span> <span class="toc-text">IO500</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Microsoft-virtual-client"><span class="toc-number">6.</span> <span class="toc-text">Microsoft virtual client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-SPEC-features-example"><span class="toc-number">7.</span> <span class="toc-text">test SPEC features example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fault-injection"><span class="toc-number"></span> <span class="toc-text">Fault-injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#overloading-test"><span class="toc-number"></span> <span class="toc-text">overloading test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#For-GPU"><span class="toc-number"></span> <span class="toc-text">For GPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenBLAS"><span class="toc-number">1.</span> <span class="toc-text">OpenBLAS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pthread-not-working"><span class="toc-number">1.1.</span> <span class="toc-text">pthread not working</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tiering-cache"><span class="toc-number"></span> <span class="toc-text">tiering cache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bcache"><span class="toc-number">1.</span> <span class="toc-text">bcache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-LVM-cache-with-zfs"><span class="toc-number">2.</span> <span class="toc-text">test LVM cache with zfs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dm-cache"><span class="toc-number">3.</span> <span class="toc-text">dm-cache</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#data-integrity"><span class="toc-number"></span> <span class="toc-text">data integrity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#metadata-consistent"><span class="toc-number">1.</span> <span class="toc-text">metadata consistent</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mpiFileUtils"><span class="toc-number"></span> <span class="toc-text">mpiFileUtils</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NVME-SSD-Certification"><span class="toc-number"></span> <span class="toc-text">NVME SSD Certification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FIO-block-test-Third-Party"><span class="toc-number"></span> <span class="toc-text">FIO block test Third Party</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#becnhmark-workflow"><span class="toc-number"></span> <span class="toc-text">becnhmark workflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bio-software"><span class="toc-number"></span> <span class="toc-text">bio software</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#split-sam-file"><span class="toc-number">1.</span> <span class="toc-text">split sam file</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SPDK-benchmark"><span class="toc-number"></span> <span class="toc-text">SPDK benchmark</span></a>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        benchmark
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-14T07:35:11.000Z" itemprop="datePublished">2022-11-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Benchmark/">Benchmark</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/bench/" rel="tag">bench</a>, <a class="tag-link-link" href="/tags/test/" rel="tag">test</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h4 id="benchmark-setting"><a href="#benchmark-setting" class="headerlink" title="benchmark setting"></a><a target="_blank" rel="noopener" href="https://github.com/Kobzol/hardware-effects">benchmark setting</a></h4><p>For all benchmarks I recommend to turn off frequency scaling, hyper-threading, Turbo mode, address space randomization and other stuff that can increase noise. I’m using the following commands  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### $ sudo bash -c &quot;echo 1 &gt; /sys/devices/system/cpu/intel_pstate/no_turbo&quot; # Turbo mode</span></span><br><span class="line">$ sudo bash -c <span class="string">&quot;echo 0 &gt; /sys/devices/system/cpu/cpuX/online&quot;</span>           <span class="comment"># hyper-threading</span></span><br><span class="line">$ sudo bash -c <span class="string">&quot;echo 0 &gt; /proc/sys/kernel/randomize_va_space&quot;</span>           <span class="comment"># address randomization</span></span><br><span class="line">$ ...                                                                   <span class="comment"># for all hyper-threading CPUs</span></span><br><span class="line">$ sudo cpupower frequency-set --governor performance                    <span class="comment"># frequency scaling</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># not disable Turbo mode, and disable all idle mode, BIOS setting &quot;OS control&quot;</span></span><br><span class="line">$ cpupower idle-set -d 4</span><br><span class="line">$ cpupower idle-set -d 3</span><br><span class="line">$ cpupower idle-set -d 2</span><br><span class="line">$ cpupower idle-set -d 1</span><br><span class="line">$ cpupower idle-set -d 0</span><br></pre></td></tr></table></figure>


<h4 id="Jemalloc-TCMalloc"><a href="#Jemalloc-TCMalloc" class="headerlink" title="Jemalloc TCMalloc"></a>Jemalloc TCMalloc</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gperftools-libs</span><br><span class="line">$ exprot TCMALLOC_RELEASE_RATE = 0~10 (10 means the fastest reclaim)</span><br><span class="line">$ LD_PRELOAD=/usr/lib64/libtcmalloc.so.4 sh ./test.sh</span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=/usr/local/lib/libjemalloc.so.2 sh ./test.sh</span><br><span class="line">$ LD_PRELOAD=/opt/rh/rh-varnish6/root/usr/lib64/libjemalloc.so.2 ./test.sh</span><br><span class="line">$ LD_PRELOAD=mimalloc-2.0.0-src/out/release/libmimalloc.so.2.0 sh ./test.sh</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/google/tcmalloc/issues/40">benchmark</a></p>
<h4 id="calculate-upload-download-speed-by-ping"><a href="#calculate-upload-download-speed-by-ping" class="headerlink" title="calculate upload&#x2F;download speed by ping"></a><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping">calculate upload&#x2F;download speed by ping</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                 bs=1MiB  numjobs=64</span><br><span class="line">                   |        |</span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;print 1/0.005*64/1024&#125;&#x27;</span></span><br><span class="line">                      |        |</span><br><span class="line">                     5ms    convert MiB to GiB</span><br><span class="line">12.5 GB/s = throughput</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping -f -c 10000 -s 1472 10.100.100.100</span><br></pre></td></tr></table></figure>
<p>At the end of the result i get: round-trip min&#x2F;avg&#x2F;max&#x2F;stddev &#x3D; 0.174&#x2F;0.219&#x2F;2.078&#x2F;0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, that’s 24 kb. 24 kb &#x2F; 0.219 ms &#x3D; 110 Mb&#x2F;s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it won’t take too long to finish.</p>
<p>1500 TX Bytes + 1500 RX Bytes&#x3D; 3000 Bytes &#x3D; 3000 * 8 &#x3D; 24000 bits<br>24000 &#x2F; 0.219 &#x3D; 109.589 Mb&#x2F;s</p>
<p>It ‘s not represent full throughput. just test single link in your ethernet adapter. not parallel.   </p>
<h4 id="stress-ng"><a href="#stress-ng" class="headerlink" title="stress-ng"></a>stress-ng</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line">$ stress-ng --cpu <span class="variable">$cores_num</span> --<span class="built_in">timeout</span> 900 --metrics-brief</span><br><span class="line">$ stress-ng --mq 0 -t 30s --<span class="built_in">times</span>  --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment"># The matrix stressor is a good way to exercise the CPU floating point operations as well as memory and processor data cache. Of all the tests, this one generally heats x86 CPUs the best.</span></span><br><span class="line">$ stress-ng --matrix 0 -t 1m --<span class="built_in">times</span> --metrics-brief</span><br><span class="line"></span><br><span class="line"><span class="comment">#mix mode</span></span><br><span class="line">$ stress-ng --cpu 2 --matrix 1 --mq 3</span><br><span class="line">$ stress-ng --all 2</span><br><span class="line"></span><br><span class="line">$ stress-ng --<span class="built_in">seq</span> 1 -x numa,matrix,hdd</span><br><span class="line"><span class="comment">#        --sequential N</span></span><br><span class="line">sequentially run all the stressors one by one <span class="keyword">for</span> a default of 60 seconds. The number of instances of each of the individual stressors to be started is N.  If N  is  less than  zero, <span class="keyword">then</span> the number of CPUs online is used <span class="keyword">for</span> the number of instances.  If N is zero, <span class="keyword">then</span> the number of CPUs <span class="keyword">in</span> the system is used.  Use the --<span class="built_in">timeout</span> option to specify the duration to run each stressor.</span><br><span class="line"></span><br><span class="line">$ stress-ng --<span class="built_in">seq</span> 1 -x numa, --<span class="built_in">sched</span> fifo  -t 30s --<span class="built_in">times</span> --metrics-brief</span><br><span class="line">$ stress-ng --vm 16 --vm-bytes 90% -t 1h --metrics-brief</span><br><span class="line">$ stress-ng --cpu 8 --cpu-ops 800000</span><br><span class="line">$ stress-ng --cpu 4 --cpu-method fft --cpu-ops 10000 --metrics-brief</span><br><span class="line">$ stress-ng --cpu 0 --cpu-method all -t 1h</span><br><span class="line">$ stress-ng --random 64</span><br><span class="line"><span class="comment">#run 64 stressors that are randomly chosen from all the available stressors.</span></span><br><span class="line"></span><br><span class="line">$ stress-ng --cpu 64 --cpu-method all --verify -t 10m --metrics-brief</span><br><span class="line"><span class="comment">#run 64 instances of all the different cpu stressors and verify that the computations are correct for 10 minutes with a bogo operations summary at the end.</span></span><br><span class="line"></span><br><span class="line">$ stress-ng --sequential 8 --class io -t 5m --<span class="built_in">times</span></span><br><span class="line"><span class="comment"># run  all  the stressors in the io class one by one for 5 minutes each, with 8 instances of each stressor running concurrently and show overall time utilisation statistics at the end of the run.</span></span><br><span class="line"></span><br><span class="line">$ stress-ng --all 0 --maximize --aggressive</span><br><span class="line"><span class="comment">#run all the stressors (1 instance of each per CPU) simultaneously, maximize the settings (memory sizes, file allocations, etc.) and select the  most  demanding/aggressive options.</span></span><br><span class="line"></span><br><span class="line">$ stress-ng --sequential 4 --class vm --exclude bigheap,brk,stack</span><br><span class="line"><span class="comment">#run 4 instances of the VM stressors one after each other, excluding the bigheap, brk and stack stressors</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cache</span></span><br><span class="line">$ stress-ng --taskset 0,2-3 --cpu 3</span><br><span class="line"><span class="comment">#run 3 instances of the CPU stressor and pin them to CPUs 0, 2 and 3.</span></span><br><span class="line"></span><br><span class="line">$ stress-ng --sequential 8 --class cpu-cache -t 5m</span><br><span class="line">stress-ng: info:  [13341] apparmor stressor will be skipped, AppArmor is not available</span><br><span class="line">stress-ng: info:  [13341] dispatching hogs: 8 bsearch, 8 cache, 8 heapsort, 8 hsearch, 8 icache, 8 lockbus, 8 lsearch, 8 malloc, 8 matrix, 8 membarrier, 8 memcpy, 8 mergesort, 8 qsort, 8 str, 8 stream, 8 tsearch, 8 vecmath, 8 wcs, 8 zlib</span><br><span class="line"></span><br><span class="line">$ stress-ng --cpu 4 --cache-level 2 --cache-ways 4 -t 30s --metrics-brief</span><br><span class="line">$ stress-ng --cpu 4 --cache-level 3 --cache-ways 4 -t 30s --metrics-brief</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ stress-ng --all 0 --class cpu-cache -t 5m --metrics-brief</span><br><span class="line"></span><br><span class="line">$ stress-ng --cpu 1 --cpu-method matrixprod -t 1m --metrics-brief</span><br><span class="line">$ <span class="keyword">for</span> m <span class="keyword">in</span> double longdouble matrixprod nsqrt cfloat clongdouble decimal32 decimal128 explog bitops ln2 int64 int128 ackermann int128decimal128 gray euler fibonacci; <span class="keyword">do</span> stress-ng --cpu 0 --cpu-method <span class="variable">$m</span> -t 10s --metrics-brief; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># float</span></span><br><span class="line">double           1000 iterations of a mix of double precision floating point operations</span><br><span class="line">longdouble       1000 iterations of a mix of long double precision floating point operations</span><br><span class="line">matrixprod       matrix  product  of  two  128 × 128 matrices of double floats. Testing on 64 bit x86 hardware shows that this is provides a good mix of memory, cache and floating point operations and is probably the best CPU method to use to make a CPU run hot.</span><br><span class="line">nsqrt            compute sqrt() of long doubles using Newton-Raphson</span><br><span class="line">cfloat           1000 iterations of a mix of floating point complex operations</span><br><span class="line">clongdouble      1000 iterations of a mix of long double floating point complex operations</span><br><span class="line">decimal32        1000 iterations of a mix of 32 bit decimal floating point operations (GCC only)</span><br><span class="line">decimal128       1000 iterations of a mix of 128 bit decimal floating point operations (GCC only)</span><br><span class="line">explog           iterate on n = exp(<span class="built_in">log</span>(n) ÷ 1.00002)</span><br><span class="line"></span><br><span class="line"><span class="comment">#int</span></span><br><span class="line">int64            1000 iterations of a mix of 64 bit <span class="built_in">integer</span> operations</span><br><span class="line">int128           1000 iterations of a mix of 128 bit <span class="built_in">integer</span> operations (GCC only)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#logic</span></span><br><span class="line">jmp              Simple unoptimised compare &gt;, &lt;, == and jmp branching</span><br><span class="line">ackermann        Ackermann <span class="keyword">function</span>: compute A(3, 10), <span class="built_in">where</span>:</span><br><span class="line">                 A(m, n) = n + 1 <span class="keyword">if</span> m = 0;</span><br><span class="line">                 A(m - 1, 1) <span class="keyword">if</span> m &gt; 0 and n = 0;</span><br><span class="line">                 A(m - 1, A(m, n - 1)) <span class="keyword">if</span> m &gt; 0 and n &gt; 0</span><br><span class="line"><span class="comment"># bit</span></span><br><span class="line">bitops           various bit operations from bithack, namely: reverse bits, parity check, bit count, round to nearest power of 2</span><br><span class="line"><span class="comment"># int</span></span><br><span class="line">gray             calculate binary to gray code and gray code back to binary <span class="keyword">for</span> integers from 0 to 65535</span><br><span class="line">fibonacci        compute Fibonacci sequence of 0, 1, 1, 2, 5, 8...</span><br><span class="line"></span><br><span class="line"><span class="comment">#float</span></span><br><span class="line">euler            compute e using n = (1 + (1 ÷ n)) ↑ n</span><br><span class="line">ln2              compute <span class="built_in">ln</span>(2) based on series:</span><br><span class="line"><span class="comment">#mix</span></span><br><span class="line">int128decimal32 1000 iterations of a mix of 128 bit <span class="built_in">integer</span> and 128 bit decimal floating point operations (GCC only)</span><br><span class="line"><span class="comment">#rand hash</span></span><br><span class="line">djb2a            128 rounds of <span class="built_in">hash</span> DJB2a (Dan Bernstein <span class="built_in">hash</span> using the xor variant) on 128 to 1 bytes of random strings</span><br><span class="line">dither           Floyd–Steinberg dithering of a 1024 × 768 random image from 8 bits down to 1 bit of depth.</span><br><span class="line">crc16            compute 1024 rounds of CCITT CRC16 on random data</span><br><span class="line"></span><br><span class="line"><span class="comment">#C</span></span><br><span class="line">callfunc         recursively call 8 argument C <span class="keyword">function</span> to a depth of 1024 calls and unwind</span><br><span class="line"></span><br><span class="line"><span class="comment">#random, hash</span></span><br><span class="line">jenkin        Jenkin<span class="string">&#x27;s integer hash on 128 rounds of 128..1 bytes of random data</span></span><br><span class="line"><span class="string">hanoi         solve a 21 disc Towers of Hanoi stack using the recursive solution</span></span><br><span class="line"><span class="string">              hamming          compute Hamming H(8,4) codes on 262144 lots of 4 bit data. This turns 4 bit data into 8 bit Hamming code containing 4 parity bits. For data bits  d1..d4,</span></span><br><span class="line"><span class="string">                               parity bits are computed as:</span></span><br><span class="line"><span class="string">                                 p1 = d2 + d3 + d4</span></span><br><span class="line"><span class="string">                                 p2 = d1 + d3 + d4</span></span><br><span class="line"><span class="string">                                 p3 = d1 + d2 + d4</span></span><br><span class="line"><span class="string">                                 p4 = d1 + d2 + d3</span></span><br><span class="line"><span class="string">correlate        perform a 16384 × 1024 correlation of random doubles</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--memthrash-method method</span></span><br><span class="line"><span class="string">              specify a memthrash stress method. Available memthrash stress methods are described</span></span><br><span class="line"><span class="string">              as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">              Method           Description</span></span><br><span class="line"><span class="string">              all              iterate over all the below memthrash methods</span></span><br><span class="line"><span class="string">              chunk1           memset 1 byte chunks of random data into random locations</span></span><br><span class="line"><span class="string">              chunk8           memset 8 byte chunks of random data into random locations</span></span><br><span class="line"><span class="string">              chunk64          memset 64 byte chunks of random data into random locations</span></span><br><span class="line"><span class="string">              chunk256         memset 256 byte chunks of random data into random locations</span></span><br><span class="line"><span class="string">              chunkpage        memset page size chunks of random data into random locations</span></span><br><span class="line"><span class="string">              flip             flip (invert) all bits in ramdom locations</span></span><br><span class="line"><span class="string">              flush            flush cache line in random locations</span></span><br><span class="line"><span class="string">              lock             lock randomly choosing locations (Intel x86 CPUs only)</span></span><br><span class="line"><span class="string">              matrix           treat memory as a 2 × 2 matrix and swap random elements</span></span><br><span class="line"><span class="string">              memset           memset the memory with random data</span></span><br><span class="line"><span class="string">              mfence           stores with write serialization (Intel x86 CPUs only)</span></span><br><span class="line"><span class="string">              prefetch         prefetch data at random memory locations</span></span><br><span class="line"><span class="string">              random           randomly  run any of the memthrash methods except for &#x27;</span>random<span class="string">&#x27; and</span></span><br><span class="line"><span class="string">                               &#x27;</span>all<span class="string">&#x27;</span></span><br><span class="line"><span class="string">              spinread         spin loop read the same random location 2^19 times</span></span><br><span class="line"><span class="string">              spinwrite        spin loop write the same random location 2^19 times</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The stress-ng stressors are grouped together in different classes:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cpu - CPU intensive</span></span><br><span class="line"><span class="string">cpu-cache - stress CPU instruction and/or data caches</span></span><br><span class="line"><span class="string">device - raw device driver stressors</span></span><br><span class="line"><span class="string">io - generic input/output</span></span><br><span class="line"><span class="string">interrupt - high interrupt load generators</span></span><br><span class="line"><span class="string">filesystem - file system activity</span></span><br><span class="line"><span class="string">memory - stack, heap, memory mapping, shared memory stressors</span></span><br><span class="line"><span class="string">network - TCP/IP, UDP and UNIX domain socket stressors</span></span><br><span class="line"><span class="string">os - core kernel stressors</span></span><br><span class="line"><span class="string">pipe - pipe and UNIX socket stressors</span></span><br><span class="line"><span class="string">scheduler - force high levels of context switching</span></span><br><span class="line"><span class="string">security - AppArmor stressor</span></span><br><span class="line"><span class="string">vm - Virtual Memory stressor (paging and memory)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--matrix-method method</span></span><br><span class="line"><span class="string">       specify a matrix stress method. Available matrix stress methods are described as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Method           Description</span></span><br><span class="line"><span class="string">       all              iterate over all the below matrix stress methods</span></span><br><span class="line"><span class="string">       add              add two N × N matrices</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       copy             copy one N × N matrix to another</span></span><br><span class="line"><span class="string">       div              divide an N × N matrix by a scalar</span></span><br><span class="line"><span class="string">       hadamard         Hadamard product of two N × N matrices</span></span><br><span class="line"><span class="string">       frobenius        Frobenius product of two N × N matrices</span></span><br><span class="line"><span class="string">       mean             arithmetic mean of two N × N matrices</span></span><br><span class="line"><span class="string">       mult             multiply an N × N matrix by a scalar</span></span><br><span class="line"><span class="string">       prod             product of two N × N matrices</span></span><br><span class="line"><span class="string">       sub              subtract one N × N matrix from another N × N matrix</span></span><br><span class="line"><span class="string">       trans            transpose an N × N matrix</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stress-ng --mq 0 -t 30s --times --perf</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895] dispatching hogs: 16 mq</span></span><br><span class="line"><span class="string">^Cstress-ng: info:  [68895] unsuccessful run completed in 15.95s</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895] mq:</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]            667,942,869,088 CPU Cycles                    41.88 B/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]            343,598,563,312 Instructions                  21.54 B/sec (0.514 instr. per cycle)</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]              4,273,568,592 Cache References               0.27 B/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                108,195,424 Cache Misses                   6.78 M/sec ( 2.53%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]             62,069,485,136 Branch Instructions            3.89 B/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]              1,391,055,360 Branch Misses                 87.21 M/sec ( 2.24%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]              4,911,414,496 Bus Cycles                     0.31 B/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]            510,787,333,888 Total Cycles                  32.02 B/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                      3,184 Page Faults Minor            199.61 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                          0 Page Faults Major              0.00 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                  3,924,080 Context Switches               0.25 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    718,208 CPU Migrations                45.03 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                          0 Alignment Faults               0.00 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                      3,088 Page Faults User             193.60 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                         96 Page Faults Kernel             6.02 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                 92,731,952 System Call Enter              5.81 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                 92,731,952 System Call Exit               5.81 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                 54,434,816 Kmalloc                        3.41 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    399,904 Kmalloc Node                  25.07 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                231,994,672 Kfree                         14.54 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    139,904 Kmem Cache Alloc               8.77 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                     88,848 Kmem Cache Alloc Node          5.57 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    181,568 Kmem Cache Free               11.38 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                     59,856 MM Page Alloc                  3.75 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    158,720 MM Page Free                   9.95 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                  8,842,656 RCU Utilization                0.55 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    764,352 Sched Migrate Task            47.92 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                          0 Sched Move NUMA                0.00 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                  6,617,648 Sched Wakeup                   0.41 M/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                         16 Signal Generate                1.00 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                         80 Signal Deliver                 5.02 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                        672 IRQ Entry                     42.13 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                        672 IRQ Exit                      42.13 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    664,704 Soft IRQ Entry                41.67 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                    664,704 Soft IRQ Exit                 41.67 K/sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                         16 Writeback Dirty Inode          1.00 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]                          0 Writeback Dirty Page           0.00 /sec</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895] for a 15.95s run time:</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]     255.21s available CPU time</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]      25.73s user time   ( 10.08%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]     181.50s system time ( 71.12%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895]     207.23s total time  ( 81.20%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [68895] load average: 5.35 1.73 1.08</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Verify mode</span></span><br><span class="line"><span class="string">Some stressors have a verification mode. A stress test is run and the results are checked, if the results are incorrect then stress-ng will flag up a warning error message. Suppose we want to run some exhaustive memory checks on a blob of virtually mapped memory via the vm stressor, enable the --verify mode and this will sanity check that the read/write results on the memory:</span></span><br><span class="line"><span class="string">Note that not all stressors have a verify mode, and enabling it will reduce the bogo op stats as there is an extra verification step being invoked.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stress-ng --vm 1 --vm-bytes 2G --verify -v</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Running timers at high frequency can generate a large interrupt load. The timer stressor with an appropriately selected timer frequency can be used to force many hundreds of thousands of interrupts per second, for example, 32 instances at 1MHz:</span></span><br><span class="line"><span class="string">$ stress-ng --timer 32 --timer-freq 1000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Filesystem  </span></span><br><span class="line"><span class="string">#meta</span></span><br><span class="line"><span class="string">$ stress-ng --sequential 16 --class filesystem --timeout 60 --times --metrics-brief</span></span><br><span class="line"><span class="string">stress-ng: info:  [27612] apparmor stressor will be skipped, AppArmor is not available</span></span><br><span class="line"><span class="string">stress-ng: info:  [27612] dispatching hogs: 16 chdir, 16 chmod, 16 chown, 16 copy-file, 16 dentry, 16 dir, 16 dirdeep, 16 dnotify, 16 dup, 16 eventfd, 16 fallocate, 16 fanotify, 16 fcntl, 16 fiemap, 16 filename, 16 flock, 16 fstat, 16 getdent, 16 handle, 16 inotify, 16 io, 16 iomix, 16 ioprio, 16 lease, 16 link, 16 locka, 16 lockf, 16 lockofd, 16 mknod, 16 open, 16 procfs, 16 rename, 16 symlink, 16 sync-file, 16 utime, 16 xattr</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#https://fossies.org/linux/stress-ng/example-jobs/filesystem.job</span></span><br><span class="line"><span class="string">$ stress-ng --timeout 600s --temp-path /mnt/ --metrics --chdir $i --aio $i --brk $i --chdir $i --chmod $i --chown $i --chroot $i --copy-file $i --dentry $i --dir $i --dirdeep $i --dirmany $i --dnotify $i --dup $i --eventfd $i --fallocate $i --fanotify $i --fcntl $i --fiemap $i --filename $i --flock $i --fstat $i --getdent $i --handle $i --inotify $i --io $i --iomix $i --ioprio $i --lease $i --link $i --locka $i --lockf $i --lockofd $i --mknod $i --open $i --procfs $i --rename $i --symlink $i --sync-file $i --utime $i --xattr $i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">timeout=100</span></span><br><span class="line"><span class="string">test_path=/mnt</span></span><br><span class="line"><span class="string">for i in aio brk chdir chmod chown chroot copy-file dentry dir dirdeep dirmany dnotify dup eventfd fallocate fanotify fcntl fiemap filename flock fstat getdent handle inotify io iomix ioprio lease link locka lockf lockofd mknod open procfs rename symlink sync-file utime xattr</span></span><br><span class="line"><span class="string">for i in aio brk chdir chmod chown chroot copy-file dentry dir dirdeep dirmany dnotify dup eventfd fallocate fanotify fcntl fiemap filename flock fstat getdent handle inotify ioprio lease link locka lockf lockofd mknod open rename symlink sync-file utime xattr</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#the fanotify show inconsistent in some bad filesystem</span></span><br><span class="line"><span class="string">#fanotify fail</span></span><br><span class="line"><span class="string">#stress-ng: fail:  [2723643] fanotify: rmdir &#x27;</span>/mnt/test100/stress/tmp-stress-ng-fanotify-2723643-1<span class="string">&#x27; failed, errno=39 (Directory not empty)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#xattr</span></span><br><span class="line"><span class="string">#stress-ng: info:  [2724854] xattr stressor will be skipped, filesystem does not support xattr, filesystem type: nfs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#write</span></span><br><span class="line"><span class="string">#dnotify openat,write,fcntl-SETSIG,fcntl-NOTIFY,chmod,close</span></span><br><span class="line"><span class="string">#ioprio ioprio_set pwritev fsync</span></span><br><span class="line"><span class="string">#link symlink statfs unlink</span></span><br><span class="line"><span class="string">#sync-file sync_file_range, high throughput</span></span><br><span class="line"><span class="string">$t1=4;t2=16; stress-ng --timeout 600s --temp-path /mnt/ --metrics --dnotify $t1 --ioprio $t1 --link $t1 --sync-file $t1 --copy-file $t2 --eventfd $t2 --inotify $t2 --mknod $t2 --open $t2 --rename $t2 --dentry $t2 --chdir $t2 --chmod $t2 --chown $t2 --aio $2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#read</span></span><br><span class="line"><span class="string">#copy-file</span></span><br><span class="line"><span class="string">#eventfd openat read </span></span><br><span class="line"><span class="string">#inotify openat read fstat getdents64 rename unlink rmdir</span></span><br><span class="line"><span class="string">#mknod mknodat mknod unlink statfs</span></span><br><span class="line"><span class="string">#open openat futimesat unlink chdir openat read close</span></span><br><span class="line"><span class="string">#rename statfs rename</span></span><br><span class="line"><span class="string">#utime utime utimes utimensat</span></span><br><span class="line"><span class="string">#dentry statfs openat close</span></span><br><span class="line"><span class="string">#chdir mkdir openat statfs rmdir</span></span><br><span class="line"><span class="string">#chmod</span></span><br><span class="line"><span class="string">#chown</span></span><br><span class="line"><span class="string">#aio pread64 pwrite64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#lustre not support fiemap: ioctl FS_IOC_FIEMAP failed, errno=22 (Invalid argument)</span></span><br><span class="line"><span class="string">#open: using a maximum of 102400 file descriptors</span></span><br><span class="line"><span class="string">#for i in aio chdir chmod chown chroot copy-file dentry dir dnotify fallocate fanotify lease fcntl fiemap filename flock lockf locka lockofd fstat getdent handle inotify ioprio link mknod open rename symlink utime xattr</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for i in for i in aio chdir chmod chown chroot copy-file dentry dir dnotify fallocate fanotify lease fcntl filename flock lockf locka lockofd fstat getdent handle inotify ioprio link mknod open rename symlink utime xattr</span></span><br><span class="line"><span class="string">do</span></span><br><span class="line"><span class="string"> echo</span></span><br><span class="line"><span class="string"> #output=$(stress-ng --timeout $&#123;timeout&#125;s --temp-path $test_path --$i 8 --perf 2&gt;&amp;1)</span></span><br><span class="line"><span class="string"> output=$(stress-ng --timeout $&#123;timeout&#125;s --temp-path $test_path --$i 8 --metrics-brief 2&gt;&amp;1)</span></span><br><span class="line"><span class="string"> if echo &quot;$output&quot; | grep -i &quot;not implemented&quot; &gt; /dev/null</span></span><br><span class="line"><span class="string"> then</span></span><br><span class="line"><span class="string">   echo &quot;$i not implemented&quot;</span></span><br><span class="line"><span class="string"> else</span></span><br><span class="line"><span class="string">   echo &quot;$output&quot;</span></span><br><span class="line"><span class="string"> fi</span></span><br><span class="line"><span class="string"> sleep 1</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#some filesystem rmdir failed</span></span><br><span class="line"><span class="string">https://github.com/ColinIanKing/stress-ng/blob/b57e637c08b7f123dbd8f9840d376e46d4946633/stress-fanotify.c#L731</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#syscall test, no real IO</span></span><br><span class="line"><span class="string">$ stress-ng --chdir 8 --chmod 8 --chown 8 --fcntl 8 --filename 8 --flock 8 --fstat 8 --getdent 8 --handle 8 --io 8 -- lockf 8 --timeout 60 --times --metrics-brief</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># parallel running</span></span><br><span class="line"><span class="string"># if you want test IO performance, got the high IO loading from these.</span></span><br><span class="line"><span class="string">$ stress-ng --fallocate 8 --xattr 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --times --metrics-brief</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># a lot of NFS not support xattr</span></span><br><span class="line"><span class="string">$ stress-ng --fallocate 8 --dir 8 --mknod 8 --symlink 8 --timeout 60 --times --metrics-brief</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># the high IO loading test could got the high IOPS in ext4 with SATA SSD</span></span><br><span class="line"><span class="string">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span></span><br><span class="line"><span class="string">sdb               0.00 100284.00    0.00 15955.50     0.00   452.52    58.08    97.34    6.05    0.00    6.05   0.06  95.05</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stress-ng  --hdd 16 --hdd-opts rd-rnd --hdd-opts wr-rnd --hdd-opts fadv-rnd --hdd-write-size 128k --timeout 60 --times --metrics-brief</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477] dispatching hogs: 16 hdd</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477] successful run completed in 60.17s (1 min, 0.17 secs)</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477] stressor       bogo ops real time  usr time  sys time   bogo ops/s   bogo ops/s</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477]                           (secs)    (secs)    (secs)   (real time) (usr+sys time)</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477] hdd            19033866     60.12    381.16    575.50    316618.18     19896.17</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477] for a 60.17s run time:</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477]     962.79s available CPU time</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477]     381.24s user time   ( 39.60%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477]     575.57s system time ( 59.78%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477]     956.81s total time  ( 99.38%)</span></span><br><span class="line"><span class="string">stress-ng: info:  [67477] load average: 11.29 4.72 1.86</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#CPU</span></span><br><span class="line"><span class="string">p90_fmem=$(awk &#x27;</span><span class="variable">$1</span>~/MemAvailable/&#123;<span class="built_in">print</span> <span class="variable">$2</span>&#125;<span class="string">&#x27; /proc/meminfo)</span></span><br><span class="line"><span class="string">for m in jmp bitops fibonacci int64longdouble djb2a crc16 nsqrt;</span></span><br><span class="line"><span class="string">do</span></span><br><span class="line"><span class="string">        stress-ng --cpu $NCPU --cpu-method $m -t 300s --metrics-brief</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string">stress-ng --mincore $NCPU --mincore-random -t 600s --metrics-brief</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Generating major page faults</span></span><br><span class="line"><span class="string">$ stress-ng --fault 0 --perf -t 1m</span></span><br><span class="line"><span class="string">$ stress-ng --userfaultfd 0 --perf -t 1m</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#cpu cache</span></span><br><span class="line"><span class="string">$ stress-ng --cpu 4 --cache 4 --icache 2 --cache-level 2 --cache-ways 4  --heapsort 4 --heapsort-size 1048576 --lsearch 4 --lsearch-size 4M  --poll 4 --locka 4 --cache-ways 4 --bsearch 4  --bsearch-size 4K -t 30s --metrics-brief</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#system call</span></span><br><span class="line"><span class="string">$ stress-ng  --sem 2 --clone 2 --fork 2 --switch 2 --sleep 2 --context 2 --userfaultfd 2 -t 30s --metrics-brief</span></span><br><span class="line"><span class="string">$ stress-ng  --futex 2 --msg 2 --udp 2 --sctp 2 --sock 2 -t 30s --metrics-brief</span></span><br><span class="line"><span class="string">https://www.betriebssysteme.org/wp-content/uploads/2021/09/FGBS_Herbst2021_Folien_Herzog.pdf</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#MEM performance</span></span><br><span class="line"><span class="string">$ stress-ng --malloc $(grep memtotal -i /proc/meminfo | awk &#x27;</span>&#123;<span class="built_in">printf</span>  <span class="string">&quot;%d\n&quot;</span>,<span class="variable">$2</span>/1024/1024*0.9/2/16.7&#125;<span class="string">&#x27;) --malloc-bytes 2M --mremap $(grep memtotal -i /proc/meminfo | awk &#x27;</span>&#123;<span class="built_in">printf</span>  <span class="string">&quot;%d\n&quot;</span>,<span class="variable">$2</span>/1024/1024*0.9/2/24&#125;<span class="string">&#x27;) --mremap-bytes 24g -t 600s  --metrics-brief; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for m in flip move-inv;</span></span><br><span class="line"><span class="string">do</span></span><br><span class="line"><span class="string">        stress-ng -m $NCPU --vm-method $m  --vm-bytes $((p90_fmem/NCPU))k -t 300s --metrics-brief</span></span><br><span class="line"><span class="string">done</span></span><br></pre></td></tr></table></figure>

<h4 id="openssl"><a href="#openssl" class="headerlink" title="openssl"></a>openssl</h4><p><a target="_blank" rel="noopener" href="https://plantegg.github.io/2020/11/15/Linux%E5%86%85%E5%AD%98--%E7%A2%8E%E7%89%87/">In this page, the openssl speed slow when malloc the big page, you could compare with diff servers</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./openssl speed -multi <span class="variable">$cores</span> -seconds 300 -bytes 1048576 aes-256-ige whirlpool des-ede3 sha512 hmac <span class="comment"># after 1.1.1h</span></span><br></pre></td></tr></table></figure>

<h4 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;7^999999&quot;</span> | bc &gt; /dev/null</span><br><span class="line">$ bash -c <span class="string">&#x27;echo &quot;scale=5000; 4*a(1)&quot; | bc -l -q &gt;/dev/null&#x27;</span> <span class="comment">#pi</span></span><br><span class="line">$ perf <span class="built_in">stat</span> -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores -- bash -c <span class="string">&#x27;echo &quot;7^999999&quot; | bc &gt; /dev/null&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The sysbench prime number can ‘t got the consistent result     </p>
<h3 id="posgresql"><a href="#posgresql" class="headerlink" title="posgresql"></a>posgresql</h3><p>Disable barrier and set data is writeback  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ext4/xfs -o barrier=0,data=writeback</span><br><span class="line">zfs <span class="built_in">disable</span> <span class="built_in">sync</span> write</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 /dev/sdXX1</span><br><span class="line">$ rpm -Uvh https://yum.postgresql.org/11/redhat/rhel-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">$ yum install postgresql11-server</span><br><span class="line">$ mount /dev/sdXX1 /var/lib/pgsql -o barrier=0,data=writeback</span><br><span class="line">$ <span class="built_in">chown</span> -R postgres.postgres /var/lib/pgsql</span><br><span class="line">$ /usr/pgsql-11/bin/postgresql-11-setup initdb</span><br><span class="line"><span class="comment"># data is in /var/lib/pgsql/11/data</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> postgresql-11</span><br><span class="line">$ systemctl start postgresql-11</span><br></pre></td></tr></table></figure>

<p>Disable PostgreSQL WAL(Write-Ahead Log)<br><a target="_blank" rel="noopener" href="https://blog.nukomeet.com/faster-inserts-how-to-increase-postgresql-write-performance-24d76bd56f75">The WAL guarantees that the table data is persisted in the event of an unclean shutdown. In other words, unlogged tables are automatically cleared if the server crashes.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">CREATE UNLOGGED TABLE user_clicks (</span><br><span class="line">  <span class="built_in">id</span> uuid PRIMARY KEY,</span><br><span class="line">  time timestamptz,</span><br><span class="line">  user_id int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE UNLOGGED TABLE name (</span><br><span class="line">…</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">ALTER TABLE user_clicks SET LOGGED</span><br><span class="line">ALTER TABLE user_clicks SET UNLOGGED</span><br><span class="line"></span><br><span class="line"><span class="comment"># List all unlogged tables within the current database.</span></span><br><span class="line">SELECT relname FROM pg_class WHERE relpersistence = <span class="string">&#x27;u&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres psql -U postgres -c <span class="string">&quot;CREATE DATABASE pgbench1;&quot;</span></span><br><span class="line">$ <span class="built_in">mkdir</span> /var/lib/pgsql/11/index</span><br><span class="line">$ <span class="built_in">chown</span> postgres.postgres /var/lib/pgsql/11/index</span><br><span class="line">$ sudo -u postgres psql -U postgres -c <span class="string">&quot;CREATE TABLESPACE index LOCATION &#x27;/var/lib/pgsql/11/index&#x27;;&quot;</span></span><br><span class="line"><span class="comment"># init table in pgbench1</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -U postgres -i pgbench1</span><br><span class="line"></span><br><span class="line"><span class="comment"># go to postgresql terminal</span></span><br><span class="line">$ sudo -u postgres psql</span><br><span class="line"></span><br><span class="line">postgres <span class="comment"># postgres=# \l</span></span><br><span class="line"><span class="comment"># list databases;</span></span><br><span class="line">                             List of databases</span><br><span class="line">   Name    |  Owner   | Encoding  | Collate | Ctype |   Access privileges</span><br><span class="line">-----------+----------+-----------+---------+-------+-----------------------</span><br><span class="line"> pgbench1  | postgres | SQL_ASCII | C       | C     |</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \c pgbench1</span></span><br><span class="line">You are now connected to database <span class="string">&quot;pgbench1&quot;</span> as user <span class="string">&quot;postgres&quot;</span>.</span><br><span class="line"></span><br><span class="line">pgbench1=<span class="comment"># \dt;</span></span><br><span class="line">              List of relations</span><br><span class="line"> Schema |       Name       | Type  |  Owner</span><br><span class="line">--------+------------------+-------+----------</span><br><span class="line"> public | pgbench_accounts | table | postgres</span><br><span class="line"> public | pgbench_branches | table | postgres</span><br><span class="line"> public | pgbench_history  | table | postgres</span><br><span class="line"> public | pgbench_tellers  | table | postgres</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line"><span class="comment">#create table</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -U postgres -i pgbench1 --index-tablespace=index</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_accounts(abalance,aid) TABLESPACE index;&quot;</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_history(mtime) TABLESPACE index;&quot;</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;CREATE INDEX ON pgbench_history(aid,delta) TABLESPACE index;&quot;</span></span><br><span class="line">CREATE INDEX</span><br><span class="line"></span><br><span class="line"><span class="comment">## Disable test table WAL log</span></span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_accounts SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_branches SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_history SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_tellers SET UNLOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line"></span><br><span class="line"><span class="comment">#to test</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended --random-seed=rand pgbench1</span><br><span class="line">...</span><br><span class="line">progress: 1160.0 s, 50.0 tps, lat 1184.948 ms stddev 1421.433</span><br><span class="line">progress: 1168.0 s, 50.1 tps, lat 1205.856 ms stddev 1672.771</span><br><span class="line">progress: 1176.0 s, 49.0 tps, lat 1359.426 ms stddev 1864.131</span><br><span class="line">progress: 1184.0 s, 47.5 tps, lat 1365.739 ms stddev 1912.132</span><br><span class="line">progress: 1192.0 s, 49.5 tps, lat 1341.149 ms stddev 1631.751</span><br><span class="line">progress: 1200.0 s, 48.9 tps, lat 1308.528 ms stddev 1643.086</span><br><span class="line">transaction <span class="built_in">type</span>: &lt;<span class="built_in">builtin</span>: TPC-B (<span class="built_in">sort</span> of)&gt;</span><br><span class="line">scaling <span class="built_in">factor</span>: 1</span><br><span class="line">query mode: extended</span><br><span class="line">number of clients: 64</span><br><span class="line">number of threads: 64</span><br><span class="line">duration: 1200 s</span><br><span class="line">number of transactions actually processed: 2750119</span><br><span class="line">latency average = 27.940 ms</span><br><span class="line">latency stddev = 181.635 ms</span><br><span class="line">tps = 2289.444326 (including connections establishing)</span><br><span class="line">tps = 2289.485134 (excluding connections establishing)</span><br></pre></td></tr></table></figure>
<p>hot plugin the device mount at &#x2F;var&#x2F;lib&#x2F;pgsql<br>after recovery to check   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_dumpall &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://mysql.taobao.org/monthly/2016/10/07/">Enable WAL test to test file system</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_accounts SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_branches SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_history SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line">$ sudo -u postgres psql -U postgres -d pgbench1 -c <span class="string">&quot;ALTER TABLE pgbench_tellers SET LOGGED&quot;</span></span><br><span class="line">ALTER TABLE</span><br><span class="line"></span><br><span class="line"><span class="comment">### After enable WAL in my zfs test env, no zil</span></span><br><span class="line">progress: 792.0 s, 3699.0 tps, lat 17.227 ms stddev 20.965</span><br><span class="line">progress: 800.0 s, 3592.0 tps, lat 17.867 ms stddev 23.278</span><br><span class="line">progress: 808.0 s, 3502.7 tps, lat 18.292 ms stddev 25.962</span><br><span class="line">progress: 816.0 s, 3560.8 tps, lat 17.972 ms stddev 24.924</span><br><span class="line">progress: 824.0 s, 3628.1 tps, lat 17.656 ms stddev 23.070</span><br><span class="line">progress: 832.0 s, 3617.6 tps, lat 17.655 ms stddev 22.472</span><br><span class="line">progress: 840.0 s, 2590.1 tps, lat 21.832 ms stddev 30.337</span><br><span class="line">progress: 848.0 s, 46.5 tps, lat 1283.200 ms stddev 1202.214</span><br><span class="line">progress: 856.0 s, 5.7 tps, lat 1130.780 ms stddev 1334.794</span><br><span class="line">progress: 864.0 s, 21.3 tps, lat 5008.063 ms stddev 6756.387</span><br><span class="line">progress: 872.0 s, 48.1 tps, lat 1666.621 ms stddev 2890.584</span><br><span class="line">progress: 880.0 s, 49.1 tps, lat 1269.726 ms stddev 1383.484</span><br><span class="line">progress: 888.0 s, 50.4 tps, lat 1277.642 ms stddev 1514.558</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended --random-seed=rand pgbench1</span><br><span class="line">setting random seed to 4859633172491879446</span><br><span class="line">starting vacuum...end.</span><br><span class="line">progress: 8.0 s, 46.1 tps, lat 1104.991 ms stddev 997.076</span><br><span class="line">progress: 16.0 s, 48.0 tps, lat 1344.463 ms stddev 1467.943</span><br><span class="line">progress: 24.0 s, 49.9 tps, lat 1285.797 ms stddev 1509.956</span><br><span class="line">progress: 32.0 s, 47.4 tps, lat 1277.344 ms stddev 1487.591</span><br><span class="line">progress: 40.0 s, 48.8 tps, lat 1406.851 ms stddev 1789.872</span><br><span class="line">progress: 48.0 s, 38.1 tps, lat 1477.057 ms stddev 1411.267</span><br><span class="line">progress: 56.0 s, 39.0 tps, lat 1695.951 ms stddev 2172.428</span><br><span class="line">progress: 64.0 s, 51.5 tps, lat 1270.484 ms stddev 2008.514</span><br><span class="line">progress: 72.0 s, 48.1 tps, lat 1260.300 ms stddev 1831.611</span><br><span class="line">progress: 80.0 s, 42.6 tps, lat 1605.049 ms stddev 2572.170</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable it immediate</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_ctl stop  -D /var/lib/pgsql/11/data -m immediate</span><br><span class="line"></span><br><span class="line">waiting <span class="keyword">for</span> server to shut down.... <span class="keyword">done</span></span><br><span class="line">server stopped</span><br><span class="line"></span><br><span class="line">progress: 768.0 s, 41.1 tps, lat 1562.948 ms stddev 1996.733</span><br><span class="line">progress: 776.0 s, 48.3 tps, lat 1258.457 ms stddev 1728.933</span><br><span class="line">WARNING:  terminating connection because of crash of another server process</span><br><span class="line">DETAIL:  The postmaster has commanded this server process to roll back the current transaction and <span class="built_in">exit</span>, because another server process exited abnormally and possibly corrupted shared memory.</span><br><span class="line">HINT:  In a moment you should be able to reconnect to the database and repeat your <span class="built_in">command</span>.</span><br><span class="line">WARNING:  terminating connection because of crash of another server process</span><br><span class="line">DETAIL:  The postmaster has commanded this server process to roll back the current transaction and <span class="built_in">exit</span>, because another server process exited abnormally and possibly corrupted shared memory.</span><br><span class="line"><span class="comment">### postgresql log</span></span><br><span class="line">$ <span class="built_in">tail</span> -f /var/lib/pgsql/11/data/log/postgresql-Mon.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] WARNING:  terminating connection because of crash of another server process</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] DETAIL:  The postmaster has commanded this server process to roll back the current transaction and <span class="built_in">exit</span>, because another server process exited abnormally and possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] HINT:  In a moment you should be able to reconnect to the database and repeat your <span class="built_in">command</span>.</span><br><span class="line">2019-04-29 07:43:53.582 UTC [11284] CONTEXT:  <span class="keyword">while</span> rechecking updated tuple (3,17) <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span></span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] WARNING:  terminating connection because of crash of another server process</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] DETAIL:  The postmaster has commanded this server process to roll back the current transaction and <span class="built_in">exit</span>, because another server process exited abnormally and possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] HINT:  In a moment you should be able to reconnect to the database and repeat your <span class="built_in">command</span>.</span><br><span class="line">2019-04-29 07:43:53.584 UTC [11304] CONTEXT:  <span class="keyword">while</span> updating tuple (17,116) <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span></span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] WARNING:  terminating connection because of crash of another server process</span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] DETAIL:  The postmaster has commanded this server process to roll back the current transaction and <span class="built_in">exit</span>, because another server process exited abnormally and possibly corrupted shared memory.</span><br><span class="line">2019-04-29 07:43:53.653 UTC [11282] HINT:  In a moment you should be able to reconnect to the database and repeat your <span class="built_in">command</span>.</span><br><span class="line">2019-04-29 07:43:53.667 UTC [450] LOG:  database system is shut down</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /var/lib/pgsql/11/data/pg_wal</span><br><span class="line"><span class="comment">#let &#x27;s test 14834480</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_waldump -b 00000001000000010000008D | grep Transaction | <span class="built_in">tail</span> | <span class="built_in">head</span> -n 1</span><br><span class="line">pg_waldump: FATAL:  error <span class="keyword">in</span> WAL record at 1/8DEFE4B0: invalid record length at 1/8DEFE4D8: wanted 24, got 0</span><br><span class="line">rmgr: Transaction len (rec/tot):     34/    34, tx:   14834480, lsn: 1/8DEFCAF8, prev 1/8DEFCAB8, desc: COMMIT 2019-04-29 07:43:53.168178 UTC</span><br><span class="line"></span><br><span class="line">$ pgbench1=<span class="comment"># select xmin,* from pgbench_history where xmin in (14834480);</span></span><br><span class="line">   xmin   | tid | bid |  aid  | delta |           mtime            | filler</span><br><span class="line">----------+-----+-----+-------+-------+----------------------------+--------</span><br><span class="line"> 14834480 |  10 |   1 | 57633 |  1859 | 2019-04-29 08:41:26.458402 |</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=./00000001000000010000008D bs=1 count=10000 skip=100</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">tail</span> -f /var/lib/pgsql/11/data/log/postgresql-Mon.<span class="built_in">log</span></span><br><span class="line">2019-04-29 07:57:03.979 UTC [11634] LOG:  database system was interrupted; last known up at 2019-04-29 07:41:55 UTC</span><br><span class="line">2019-04-29 07:57:04.050 UTC [11634] LOG:  invalid primary checkpoint record</span><br><span class="line">2019-04-29 07:57:04.051 UTC [11634] PANIC:  could not locate a valid checkpoint record</span><br><span class="line">2019-04-29 07:57:04.171 UTC [11632] LOG:  startup process (PID 11634) was terminated by signal 6: Aborted</span><br><span class="line">2019-04-29 07:57:04.171 UTC [11632] LOG:  aborting startup due to startup process failure</span><br><span class="line">2019-04-29 07:57:04.173 UTC [11632] LOG:  database system is shut down</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_resetwal -f /var/lib/pgsql/11/data</span><br><span class="line">Write-ahead <span class="built_in">log</span> reset</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pg_ctl start  -D /var/lib/pgsql/11/data</span><br><span class="line">waiting <span class="keyword">for</span> server to start....2019-04-29 08:17:18.990 UTC [11662] LOG:  listening on IPv6 address <span class="string">&quot;::1&quot;</span>, port 5432</span><br><span class="line">2019-04-29 08:17:18.990 UTC [11662] LOG:  listening on IPv4 address <span class="string">&quot;127.0.0.1&quot;</span>, port 5432</span><br><span class="line">2019-04-29 08:17:19.000 UTC [11662] LOG:  listening on Unix socket <span class="string">&quot;/var/run/postgresql/.s.PGSQL.5432&quot;</span></span><br><span class="line">2019-04-29 08:17:19.026 UTC [11662] LOG:  listening on Unix socket <span class="string">&quot;/tmp/.s.PGSQL.5432&quot;</span></span><br><span class="line">2019-04-29 08:17:19.050 UTC [11662] LOG:  redirecting <span class="built_in">log</span> output to logging collector process</span><br><span class="line">2019-04-29 08:17:19.050 UTC [11662] HINT:  Future <span class="built_in">log</span> output will appear <span class="keyword">in</span> directory <span class="string">&quot;log&quot;</span>.</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line">server started</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">tail</span> -f /var/lib/pgsql/11/data/log/postgresql-Mon.<span class="built_in">log</span></span><br><span class="line">2019-04-29 08:17:19.064 UTC [11664] LOG:  database system was shut down at 2019-04-29 08:17:11 UTC</span><br><span class="line">2019-04-29 08:17:19.104 UTC [11662] LOG:  database system is ready to accept connections</span><br><span class="line">2019-04-29 08:17:31.640 UTC [11671] WARNING:  page is not marked all-visible but visibility map bit is <span class="built_in">set</span> <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span> page 0</span><br><span class="line">2019-04-29 08:17:31.640 UTC [11671] WARNING:  page is not marked all-visible but visibility map bit is <span class="built_in">set</span> <span class="keyword">in</span> relation <span class="string">&quot;pgbench_tellers&quot;</span> page 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can&#x27;t found it</span></span><br><span class="line">$ pgbench1=<span class="comment"># select xmin,* from pgbench_history where xmin in (14834480);</span></span><br><span class="line"> xmin | tid | bid | aid | delta | mtime | filler</span><br><span class="line">------+-----+-----+-----+-------+-------+--------</span><br><span class="line">(0 rows)</span><br><span class="line"></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -c 64 -j 64 -T 1200 -P 8 -M extended --random-seed=rand pgbench1</span><br><span class="line">setting random seed to 4384533976954680126</span><br><span class="line">starting vacuum...end.</span><br><span class="line">empty range given to random</span><br><span class="line">client 1 aborted <span class="keyword">in</span> <span class="built_in">command</span> 0 (<span class="built_in">set</span>) of script 0; evaluation of meta-command failed</span><br><span class="line">......</span><br><span class="line">empty range given to random</span><br><span class="line">client 40 aborted <span class="keyword">in</span> <span class="built_in">command</span> 0 (<span class="built_in">set</span>) of script 0; evaluation of meta-command failed</span><br><span class="line">transaction <span class="built_in">type</span>: &lt;<span class="built_in">builtin</span>: TPC-B (<span class="built_in">sort</span> of)&gt;</span><br><span class="line">scaling <span class="built_in">factor</span>: 0</span><br><span class="line">query mode: extended</span><br><span class="line">number of clients: 64</span><br><span class="line">number of threads: 64</span><br><span class="line">duration: 1200 s</span><br><span class="line">number of transactions actually processed: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">## re-init</span></span><br><span class="line">$ sudo -u postgres /usr/pgsql-11/bin/pgbench -i pgbench1</span><br><span class="line">dropping old tables...</span><br><span class="line">creating tables...</span><br><span class="line">generating data...</span><br><span class="line">100000 of 100000 tuples (100%) <span class="keyword">done</span> (elapsed 0.12 s, remaining 0.00 s)</span><br><span class="line">vacuuming...</span><br><span class="line">creating primary keys...</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">https://github.com/winlibs/postgresql/blob/master/src/backend/commands/vacuumlazy.c</span><br><span class="line">/*</span><br><span class="line">                 * As of PostgreSQL 9.2, the visibility map bit should never be <span class="built_in">set</span> <span class="keyword">if</span></span><br><span class="line">                 * the page-level bit is clear.  However, it<span class="string">&#x27;s possible that the bit</span></span><br><span class="line"><span class="string">                 * got cleared after we checked it and before we took the buffer</span></span><br><span class="line"><span class="string">                 * content lock, so we must recheck before jumping to the conclusion</span></span><br><span class="line"><span class="string">                 * that something bad has happened.</span></span><br><span class="line"><span class="string">                 */</span></span><br><span class="line"><span class="string">                else if (all_visible_according_to_vm &amp;&amp; !PageIsAllVisible(page)</span></span><br><span class="line"><span class="string">                                 &amp;&amp; VM_ALL_VISIBLE(onerel, blkno, &amp;vmbuffer))</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                        elog(WARNING, &quot;page is not marked all-visible but visibility map bit is set in relation \&quot;%s\&quot; page %u&quot;,</span></span><br><span class="line"><span class="string">                                 relname, blkno);</span></span><br><span class="line"><span class="string">                        visibilitymap_clear(onerel, blkno, vmbuffer,</span></span><br><span class="line"><span class="string">                                                                VISIBILITYMAP_VALID_BITS);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="sysbech"><a href="#sysbech" class="headerlink" title="sysbech"></a>sysbech</h4><h5 id="test-mysql-mariadb-posgresql"><a href="#test-mysql-mariadb-posgresql" class="headerlink" title="test mysql&#x2F;mariadb&#x2F;posgresql"></a>test mysql&#x2F;mariadb&#x2F;posgresql</h5><p>Disable barrier and set data is writeback    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ext4/xfs -o barrier=0,data=writeback   </span><br><span class="line">zfs <span class="built_in">disable</span> <span class="built_in">sync</span> write</span><br></pre></td></tr></table></figure>

<h5 id="install"><a href="#install" class="headerlink" title="install"></a>install</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> /var/lib/mysql &amp;&amp; mount /dev/sdb1 /var/lib/mysql</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;deadline&quot;</span> &gt; /sys/class/block/sdb/queue/scheduler</span><br><span class="line">$ yum install git automake libtool</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/hgxl64/sysbench-mariadb.git</span><br><span class="line">$ <span class="built_in">cd</span> sysbench-mariadb</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">cd</span> sysbech/</span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:$(<span class="built_in">pwd</span>)/</span><br><span class="line">$ sysbench --version</span><br><span class="line">sysbench 0.5</span><br><span class="line"></span><br><span class="line">https://downloads.mariadb.org/mariadb/repositories/<span class="comment">#mirror=syringa&amp;distro=CentOS&amp;distro_release=centos7-amd64--centos7&amp;version=10.1</span></span><br><span class="line"><span class="comment"># MariaDB 10.1 CentOS repository list - created 2016-03-02 02:05 UTC</span></span><br><span class="line"><span class="comment"># http://mariadb.org/mariadb/repositories/</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.1/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br><span class="line"></span><br><span class="line">$ yum install mariadb-server mariadb-client mariadb-devel</span><br><span class="line"></span><br><span class="line">*               soft    nofile          1048576</span><br><span class="line">*               hard    nofile          1048576</span><br><span class="line">*               soft    <span class="built_in">nproc</span>           524280</span><br><span class="line">*               hard    <span class="built_in">nproc</span>           524280</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /etc/mysql/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">lc_messages     = en_US</span><br><span class="line">skip-log-bin</span><br><span class="line">skip-external-locking</span><br><span class="line">default_storage_engine  = InnoDB</span><br><span class="line">innodb_flush_method     = O_DIRECT</span><br><span class="line">innodb_use_trim=ON</span><br><span class="line">innodb_use_fallocate=ON</span><br><span class="line">innodb_page_size=16k</span><br><span class="line">innodb_thread_concurrency=0</span><br><span class="line">innodb_doublewrite=0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_safe --defaults-file=/etc/my.cnf</span><br><span class="line">$ mysql -u root -e <span class="string">&quot;create database sbtest&quot;</span></span><br><span class="line"><span class="comment">#If you have password, please add &quot;--mysql-password=yourpass&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#prepare</span></span><br><span class="line">$ sysbench --<span class="built_in">test</span>=tests/db/parallel_prepare.lua --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --oltp-tables-count=128 --oltp-table-size=500000 --num-threads=128 --max-time=300 run</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">$ sysbench --<span class="built_in">test</span>=<span class="string">&#x27;/usr/share/doc/sysbench/tests/db/select.lua&#x27;</span> --oltp_tables_count=1 --report-interval=1 --oltp-table-size=10000000  --mysql-port=3307 --mysql-db=sysbench_single --mysql-user=root --mysql-password=<span class="string">&#x27;your-mysql-pass&#x27;</span>  --max-requests=0   --oltp_skip_trx=on --oltp_auto_inc=on  --oltp_range_size=5  --mysql-table-engine=innodb --rand-init=on   --max-time=300 --mysql-host=x86.51 --num-threads=4 run</span><br><span class="line"></span><br><span class="line"><span class="comment">#read</span></span><br><span class="line">$ sysbench --<span class="built_in">test</span>=tests/db/oltp.lua --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-db=sbtest --oltp_tables_count=128 --oltp-table-size=500000  --rand-type=uniform --oltp-read-only=on --num-threads=128 --max-requests=0 --max-time=300 --report-interval=3 run</span><br><span class="line"></span><br><span class="line"><span class="comment">#rw</span></span><br><span class="line">$ sysbench --<span class="built_in">test</span>=tests/db/oltp.lua --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-db=sbtest --oltp_tables_count=128 --oltp-table-size=500000  --rand-type=uniform --oltp-read-only=off --num-threads=128 --max-requests=0 --max-time=300 --report-interval=3 run</span><br><span class="line"></span><br><span class="line"><span class="comment">#update</span></span><br><span class="line">$ sysbench --<span class="built_in">test</span>=tests/db/update_non_index.lua --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-db=sbtest --oltp_tables_count=128 --oltp-table-size=500000  --rand-type=uniform --oltp-read-only=off --num-threads=128 --max-requests=0 --max-time=300 --report-interval=3 run</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete</span></span><br><span class="line">$ sysbench --<span class="built_in">test</span>=tests/db/delete.lua --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-db=sbtest --oltp_tables_count=128 --oltp-table-size=500000  --rand-type=uniform --oltp-read-only=off --num-threads=128 --max-requests=0 --max-time=300 --report-interval=3 run</span><br><span class="line"></span><br><span class="line">OLTP <span class="built_in">test</span> statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        <span class="built_in">read</span>:                            492604</span><br><span class="line">        write:                           140744</span><br><span class="line">        other:                           70372</span><br><span class="line">        total:                           703720</span><br><span class="line">    transactions:                        35186  (117.12 per sec.)</span><br><span class="line">    <span class="built_in">read</span>/write requests:                 633348 (2108.17 per sec.)</span><br><span class="line">    other operations:                    70372  (234.24 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          300.4258s</span><br><span class="line">    total number of events:              35186</span><br><span class="line">    total time taken by event execution: 9603.6924s</span><br><span class="line">    response time:</span><br><span class="line">         min:                                 53.39ms</span><br><span class="line">         avg:                                272.94ms</span><br><span class="line">         max:                               1713.77ms</span><br><span class="line">         approx.  95 percentile:             496.65ms</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           1099.5625/11.17</span><br><span class="line">    execution time (avg/stddev):   300.1154/0.12</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE <span class="string">&quot;innodb_page_size&quot;</span>;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| innodb_page_size | 16384 |</span><br><span class="line">+------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/ZFS#Database">zfs db</a><br><a target="_blank" rel="noopener" href="https://www-304.ibm.com/partnerworld/wps/servlet/download/DownloadServlet?id=YxooL$U5GZkiPCA$cnt&attachmentName=primer_to_run_sysbench_and_mariadb_benchmarks_on_lop.pdf&token=MTQ1NjgyMjIzMTcyNA==&locale=en_ALL_ZZ">sysbench_and_mariadb_benchmarks_on_lop</a><br><a target="_blank" rel="noopener" href="https://mariadb.org/using-lua-enabled-sysbench/">using-lua-enabled-sysbench</a></p>
<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>Just test CPU&#x2F;MEM&#x2F;NET, not write to disk</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">create a demo file to avoid redis <span class="built_in">exit</span></span><br><span class="line">$ <span class="built_in">mkdir</span> demo </span><br><span class="line">or</span><br><span class="line">$ <span class="built_in">touch</span> demo</span><br><span class="line"></span><br><span class="line"><span class="comment">#server, or add numactl</span></span><br><span class="line">pkill redis-server</span><br><span class="line">j=6001</span><br><span class="line">count=0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..31&#125;; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  <span class="keyword">if</span> [[ $((count%<span class="number">2</span>)) -eq 0 ]]; </span><br><span class="line">  <span class="keyword">then</span>   </span><br><span class="line">    <span class="built_in">echo</span> -n  <span class="string">&quot;numactl -C &quot;</span><span class="variable">$i</span><span class="string">&quot;,&quot;</span>; </span><br><span class="line">  <span class="keyword">else</span>   </span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span><span class="string">&quot; redis-server demo --save \&quot;\&quot; --appendonly no --io-threads 2 --port <span class="variable">$j</span> &amp;&quot;</span>; </span><br><span class="line">    ((j++))</span><br><span class="line">  <span class="keyword">fi</span> </span><br><span class="line">  ((count++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#client</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;start_time=$(date +%s)&#x27;</span> &gt; run_client.sh </span><br><span class="line">j=6001</span><br><span class="line">dsize=2</span><br><span class="line">incr_num=20</span><br><span class="line">count=0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;31..63&#125;;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [[ $((count%<span class="number">2</span>)) -eq 0 ]];</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -n  <span class="string">&quot;numactl -C &quot;</span><span class="variable">$i</span><span class="string">&quot;,&quot;</span> &gt;&gt; run_client.sh</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span><span class="string">&quot; redis-benchmark -r 123456789 -c 32 --threads 2 -q -n 100000000 -t set,get,incr,lpush -d <span class="variable">$dsize</span> -q -p <span class="variable">$j</span> &gt; /tmp/redist_<span class="variable">$&#123;i&#125;</span>.log &amp;&quot;</span>  &gt;&gt; run_client.sh</span><br><span class="line">    ((dsize=dsize+incr_num))</span><br><span class="line">    ((j++))</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  ((count++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">wait</span> &gt;&gt; run_client.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;end_time=$(date +%s)&#x27;</span> &gt;&gt; run_client.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;echo &quot;redis bench time: &quot;$((end_time-start_time)) | tee  /tmp/redis.$(openssl rand -hex 4).log&#x27;</span> &gt;&gt; run_client.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#test results</span></span><br><span class="line">SET: 403063.28 requests per second</span><br><span class="line">GET: 508388.41 requests per second</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> -v redis_*.<span class="built_in">log</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;^M&#x27;</span> | awk <span class="string">&#x27;&#123;if($0~/SET/) &#123;sum_set+=$(NF-5);c1++&#125;; if($0~/GET/) &#123;sum_get+=$(NF-5);c2++&#125;; if($0~/INCR/) &#123;sum_incr+=$(NF-5);c3++&#125;; if($0~/LPUSH/) &#123;sum_push+=$(NF-5);c4++&#125;&#125; END&#123;print sum_set/c1,sum_get/c2,sum_incr/c3,sum_push/c4&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>redis mode2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server --port 7777  --protected-mode no --maxmemory 12000mb --maxmemory-samples 10 --maxmemory-policy allkeys-lru</span><br><span class="line">Client $ numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,<span class="built_in">set</span>,lpush,lpop,incr -P 16 -q -h 192.168.0.201 -p 7777 -d 16</span><br></pre></td></tr></table></figure>

<h4 id="Linpack-for-x86"><a href="#Linpack-for-x86" class="headerlink" title="Linpack for x86"></a><a target="_blank" rel="noopener" href="https://www.ngohq.com/linpack-xtreme.html">Linpack for x86</a></h4><p>Auto calculte the problem size</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mem_var=$(awk <span class="string">&#x27;/MemAvailable/ &#123;printf &quot;%d\n&quot;, $2/1024/1024&#125;&#x27;</span> /proc/meminfo)</span><br><span class="line">$ cpu_cores=$(grep MHz /proc/cpuinfo  -c)</span><br><span class="line">$ test_size=$(awk -v cpu_cores=<span class="variable">$cpu_cores</span> -v mem_var=<span class="variable">$mem_var</span> <span class="string">&#x27;BEGIN&#123;print sqrt(((mem_var-0.067*cpu_cores)/18)*2)*35000&#125;&#x27;</span>)</span><br><span class="line">                                                                                             |              |       |</span><br><span class="line">                                                      one thread will take 0.067GB memory-----              |       |</span><br><span class="line">                                                                 problem size-------------------------------|--------</span><br><span class="line">                                                                                                            |</span><br><span class="line">                                                                                                            |</span><br><span class="line">                                                                                                            |</span><br><span class="line">take away the threads mem size, 35000 problem size will take 18Gx1 memory, 7000 problem will take 18G*2------</span><br><span class="line">105000 will take 18G*4, 140000 = 18G*8</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> default</span><br><span class="line">Linpack data file</span><br><span class="line">Linpack Xtreme v1.1.5 by Regeneration</span><br><span class="line">1</span><br><span class="line"><span class="variable">$test_size</span> <span class="comment"># problem size</span></span><br><span class="line"><span class="variable">$test_size</span> <span class="comment"># leading dimensions</span></span><br><span class="line">1 <span class="comment"># number of times to run LINPACK</span></span><br><span class="line">4</span><br></pre></td></tr></table></figure>
<p>AMD EPYC2(2x 7742, 16 x 32G DDR 3200MHz) proportion to the performance not across the extra NUMA, and internal NUMA has the impact too<br>If the benchmark malloc 90% memory or more, the EPYC2 will from 2000GFLOPS down to 1000+GFLOPS, only half performance<br>It ‘s not used be in the random Memory-intensive tasks, maybe single socket is the better choice<br>In the same case(90%+ mem), the EPYC2 has the long latency than intel system   </p>
<h4 id="AVX"><a href="#AVX" class="headerlink" title="AVX"></a>AVX</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////////////////////////////</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> ARR_SIZE=<span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> A[ARR_SIZE],C[ARR_SIZE]; </span><br><span class="line">  <span class="type">int</span> B[ARR_SIZE];</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; ARR_SIZE; i++)</span><br><span class="line">    A[B[i]] += <span class="number">1.0f</span>/C[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Broadwell</span><br><span class="line">$ icc CD.c -xCORE-AVX2 -O3 -qopt-report=<span class="number">5</span> -fp-model fast=<span class="number">2</span> -S</span><br><span class="line"></span><br><span class="line"><span class="meta"># skylake</span></span><br><span class="line">$ icc CD.c -xCORE-AVX512 -O3 -qopt-report=<span class="number">5</span> -fp-model fast=<span class="number">2</span> -S</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//The example in the listing below shows a benchmark of the fused multiply-add (FMA) operation.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> n_trials = <span class="number">1000000000</span>; <span class="comment">// Enough to keep cores busy for a while and observe a steady state</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> flops_per_calc = <span class="number">2</span>; <span class="comment">// Multiply + add = 2 instructions</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> n_chained_fmas = <span class="number">10</span>; <span class="comment">// Must be tuned for architectures here and in blocks (R) and in (E)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">  &#123; &#125; <span class="comment">// Warm up the threads</span></span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> t0 = omp_get_wtime(); <span class="comment">// start timer</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line"></span><br><span class="line">  &#123; <span class="comment">// Benchmark in all threads</span></span><br><span class="line">    <span class="type">double</span> fa[VECTOR_WIDTH*n_chained_fmas], fb[VECTOR_WIDTH], fc[VECTOR_WIDTH];</span><br><span class="line"></span><br><span class="line">    fa[<span class="number">0</span>:VECTOR_WIDTH*n_chained_fmas] = <span class="number">0.0</span>; <span class="comment">// prototype of a memory-based array</span></span><br><span class="line">    fb[<span class="number">0</span>:VECTOR_WIDTH] = <span class="number">0.5</span>; <span class="comment">// fixed</span></span><br><span class="line">    fc[<span class="number">0</span>:VECTOR_WIDTH] = <span class="number">1.0</span>; <span class="comment">// fixed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa01 = fa +  <span class="number">0</span>*VECTOR_WIDTH; <span class="comment">// This is block (R)</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa02 = fa +  <span class="number">1</span>*VECTOR_WIDTH; <span class="comment">// To tune for a specific architecture,</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa03 = fa +  <span class="number">2</span>*VECTOR_WIDTH; <span class="comment">// more or fewer fa* variables</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa04 = fa +  <span class="number">3</span>*VECTOR_WIDTH; <span class="comment">// must be used</span></span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa05 = fa +  <span class="number">4</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa06 = fa +  <span class="number">5</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa07 = fa +  <span class="number">6</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa08 = fa +  <span class="number">7</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa09 = fa +  <span class="number">8</span>*VECTOR_WIDTH;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">double</span> *fa10 = fa +  <span class="number">9</span>*VECTOR_WIDTH;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> nounroll <span class="comment">// Prevents automatic unrolling by compiler to avoid skewed benchmarks</span></span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n_trials; i++)</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp simd <span class="comment">// Ensures that vectorization does occur</span></span></span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; VECTOR_WIDTH; j++) &#123; <span class="comment">// VECTOR_WIDTH=4 for AVX2, =8 for AVX-512</span></span><br><span class="line">        fa01[j] = fa01[j]*fb[j] + fc[j]; <span class="comment">// This is block (E)</span></span><br><span class="line">        fa02[j] = fa02[j]*fb[j] + fc[j]; <span class="comment">// To tune for a specific architecture,</span></span><br><span class="line">        fa03[j] = fa03[j]*fb[j] + fc[j]; <span class="comment">// more or fewer such FMA constructs</span></span><br><span class="line">        fa04[j] = fa04[j]*fb[j] + fc[j]; <span class="comment">// must be used</span></span><br><span class="line">        fa05[j] = fa05[j]*fb[j] + fc[j];</span><br><span class="line">        fa06[j] = fa06[j]*fb[j] + fc[j];</span><br><span class="line">        fa07[j] = fa07[j]*fb[j] + fc[j];</span><br><span class="line">        fa08[j] = fa08[j]*fb[j] + fc[j];</span><br><span class="line">        fa09[j] = fa09[j]*fb[j] + fc[j];</span><br><span class="line">        fa10[j] = fa10[j]*fb[j] + fc[j];</span><br><span class="line">      &#125;</span><br><span class="line">    fa[<span class="number">0</span>:VECTOR_WIDTH*n_chained_fmas] *= <span class="number">2.0</span>; <span class="comment">// Prevent dead code elimination</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> t1 = omp_get_wtime();</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">double</span> gflops = <span class="number">1.0e-9</span>*(<span class="type">double</span>)VECTOR_WIDTH*(<span class="type">double</span>)n_trials*(<span class="type">double</span>)flops_per_calc*</span><br><span class="line">                        (<span class="type">double</span>)omp_get_max_threads()*(<span class="type">double</span>)n_chained_fmas;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Chained FMAs=%d, vector width=%d, GFLOPs=%.1f, time=%.6f s, performance=%.1f GFLOP/s\n&quot;</span>, </span><br><span class="line">                        n_chained_fmas, VECTOR_WIDTH, gflops, t1 - t0, gflops/(t1 - t0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ icpc -qopenmp -DVECTOR_WIDTH=<span class="number">4</span> -xCORE-AVX2 -S -o fma_avx2_10.s fma_10.c</span><br><span class="line">$ icpc -qopenmp -DVECTOR_WIDTH=<span class="number">8</span> -xCORE-AVX512 -S -o fma_avx512_08.s fma_08.c</span><br></pre></td></tr></table></figure>

<h4 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h4><p><a target="_blank" rel="noopener" href="https://github.com/majek/dump/blob/master/how-to-receive-a-million-packets/udpsender.c">udp sender</a><br><a target="_blank" rel="noopener" href="https://github.com/majek/dump/blob/master/how-to-receive-a-million-packets/udpreceiver1.c">udp receiver</a>   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> ((i=<span class="number">4</span>;i&lt;=<span class="number">96</span>;i=i+<span class="number">10</span>)); <span class="keyword">do</span> <span class="built_in">echo</span> CPU core:<span class="variable">$i</span>; <span class="built_in">timeout</span> 5 taskset -c <span class="variable">$i</span> ./receiver 0.0.0.0:4321; <span class="keyword">done</span></span><br><span class="line">CPU core:4</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">  0.456M pps  13.922MiB / 116.785Mb</span><br><span class="line">CPU core:14</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.411M pps  12.538MiB / 105.177Mb</span><br><span class="line">  0.455M pps  13.891MiB / 116.523Mb</span><br><span class="line">  0.452M pps  13.797MiB / 115.737Mb</span><br><span class="line">  0.430M pps  13.109MiB / 109.969Mb</span><br><span class="line">CPU core:54</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.719M pps  21.929MiB / 183.950Mb</span><br><span class="line">  0.685M pps  20.907MiB / 175.383Mb</span><br><span class="line">  0.680M pps  20.766MiB / 174.199Mb</span><br><span class="line">  0.544M pps  16.611MiB / 139.345Mb</span><br><span class="line">....</span><br><span class="line">CPU core:74</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.936M pps  28.571MiB / 239.668Mb</span><br><span class="line">  0.935M pps  28.540MiB / 239.410Mb</span><br><span class="line">  0.936M pps  28.563MiB / 239.602Mb</span><br><span class="line">  0.948M pps  28.928MiB / 242.669Mb</span><br><span class="line">CPU core:84</span><br><span class="line">[*] Starting udpreceiver on 0.0.0.0:4321, recv buffer 4KiB</span><br><span class="line">  0.616M pps  18.786MiB / 157.585Mb</span><br><span class="line">  0.622M pps  18.976MiB / 159.180Mb</span><br><span class="line">  0.618M pps  18.847MiB / 158.102Mb</span><br><span class="line">  0.615M pps  18.780MiB / 157.541Mb</span><br></pre></td></tr></table></figure>

<h4 id="RFC6349-TCP-benchmark"><a href="#RFC6349-TCP-benchmark" class="headerlink" title="RFC6349 TCP benchmark"></a><a target="_blank" rel="noopener" href="https://www.viavisolutions.com/zh-cn/literature/rfc-6349-testing-truespeed-viavi-solutions-experience-your-network-your-custom-application-notes-zh.pdf">RFC6349 TCP benchmark</a></h4><ul>
<li>RFC 4821 through PLPMTUD make sure network path mtu</li>
<li>benchmark RRT(Round-Trip Time) and BB(bottle neck bandwidth)<ul>
<li>example:RRT&#x3D;25ms, bandwidth&#x3D;45Mbps, window&#x3D;64KB, receiver take 12.5ms to sender BDP(bandwidth-delay product) &#x3D; BB * RRT &#x2F;8 &#x3D; 140.625 KB, double sender ‘s window size</li>
<li>TCP global synchronization</li>
<li>RWND(Receive Window)</li>
<li>CWND(Congestion Window)</li>
<li>LFN(Long fat network)</li>
<li>RTD(round-trip delay time)</li>
<li>TDP(Tail drop polocy)</li>
<li>tcp transfer time<ul>
<li>In the 500Mbps netowrk, start 5x transmit services, each transmit means 100Mbps, actually, the 5 x tansmit bandwith are not balancing. 5 x sender transfer 100MB file.<ul>
<li>500MB&#x2F;(500Mbps&#x2F;8)&#x3D;8 sec, in fact, the test use 12sec, that means 12sec&#x2F;8sec&#x3D;1.5, 1.5x late than the theoretically</li>
</ul>
</li>
</ul>
</li>
<li>tcp efficiency<ul>
<li>(total bytes - retrans bytes)&#x2F;total bytes * 100 &#x3D; 98%, in our data center , there are 2 percent tcp retrans. that too bad in some times.</li>
</ul>
</li>
<li>tcp cache latency percent, (test average rrt - base rrt)&#x2F;base rrt * 100, if base rrt&#x3D; 25ms, in the test, the average rrt&#x3D;32ms, (32-25)&#x2F;25*100&#x3D;28%, tcp RTD increase 28%(congestion)</li>
</ul>
</li>
<li>if the tcp performance not reach your expect<ul>
<li>re-gen tcp connection, and modify tcp rwnd size, mtu size</li>
<li>speed limit cause tail drop polocy and cause too many tcp retrans</li>
<li>the maximum tcp cache size, it limit by OS memory size, and to check tcp queue</li>
<li>socket buffer size, a lot of OS could modify the each connection receive and transmit buffer limit. the socket buffer must be large enough.</li>
</ul>
</li>
</ul>
<h4 id="pkggen-kernel-mode"><a href="#pkggen-kernel-mode" class="headerlink" title="pkggen kernel mode"></a>pkggen kernel mode</h4><p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/629155/">The problem, Jesper said, is that the kernel developers have focused on scaling out to large numbers of cores. In the process, they have been able to hide regressions in per-core efficiency. The networking stack, as a result, works well for many workloads, but workloads that are especially latency-sensitive have suffered. The kernel, today, can only forward something between 1M and 2M packets per core every second, while some of the bypass alternatives approach a rate of 15M packets per core per second. Then there is the cost of performing a system call. On a system with SELinux and auditing enabled, that cost is just over 75ns — over the time budget on its own. Disabling auditing and SELinux reduces the time required to just under 42ns, which is better, but that is still a big part of the time budget. There are ways of amortizing that cost over multiple packets; they include system calls like sendmmsg(), recvmmsg(), sendfile(), and splice().</a><br>10GbE Full-duplex, about 2M      </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Result: OK: 958748771(c958745900+d2871) usec, 2000000000 (42byte,0frags)</span><br><span class="line">  2086052pps 700Mb/sec (700913472bps) errors: 0</span><br><span class="line"></span><br><span class="line">Result: OK: 939714052(c939699215+d14836) usec, 2000000000 (42byte,0frags)</span><br><span class="line">  2128307pps 715Mb/sec (715111152bps) errors: 0</span><br><span class="line"></span><br><span class="line">pgset <span class="string">&quot;count 2000000000&quot;</span></span><br><span class="line">pgset <span class="string">&quot;delay 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 8&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pgset <span class="string">&quot;count 2000000000&quot;</span></span><br><span class="line">pgset <span class="string">&quot;delay 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;clone_skb 0&quot;</span></span><br><span class="line">pgset <span class="string">&quot;pkt_size 8&quot;</span></span><br><span class="line"></span><br><span class="line">Result: OK: 184502252(c184496912+d5340) usec, 274564113 (42byte,0frags)</span><br><span class="line">  1488134pps 500Mb/sec (500013024bps) errors: 0</span><br><span class="line"></span><br><span class="line">Result: OK: 183209415(c183209277+d138) usec, 272639542 (42byte,0frags)</span><br><span class="line">  1488130pps 500Mb/sec (500011680bps) errors: 0</span><br></pre></td></tr></table></figure>

<h4 id="nc-test"><a href="#nc-test" class="headerlink" title="nc test"></a>nc test</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ nc -l 22222 &lt; /dev/zero</span><br><span class="line">Client $ nc <span class="variable">$serverip</span> 22222 &gt; /dev/null</span><br></pre></td></tr></table></figure>

<h4 id="iperf3"><a href="#iperf3" class="headerlink" title="iperf3"></a>iperf3</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Server $ iperf3 -s -D -p 520<span class="variable">$i</span></span><br><span class="line">Client $ iperf3 -c <span class="variable">$client_ip</span> -P 1 -t 360000 -p 520<span class="variable">$i</span></span><br></pre></td></tr></table></figure>

<h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server $ qperf -lp <span class="variable">$port</span> &amp;</span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 36000 -oo msg_size:1K:4K:*2 <span class="variable">$server_ip</span> tcp_bw</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">Client $ qperf -lp <span class="variable">$port</span> -t 60 -oo msg_size:64:1024K:*4 <span class="variable">$server_ip</span> tcp_lat</span><br></pre></td></tr></table></figure>

<h4 id="Pktgen-DPDK"><a href="#Pktgen-DPDK" class="headerlink" title="Pktgen-DPDK"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/154066913">Pktgen-DPDK</a></h4><p><a target="_blank" rel="noopener" href="http://ssdxiao.github.io/linux/2017/08/23/Docker-Pktgen.html">reference</a></p>
<h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Server $ taskset -c 5 netserver &amp;</span><br><span class="line">Client $ netperf -H <span class="variable">$ipaddr</span> -l 200 -t TCP_STREAM</span><br><span class="line"></span><br><span class="line">Server $ numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br><span class="line">Client $ numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 -- -m $((<span class="number">2</span>**<span class="variable">$i</span>))</span><br></pre></td></tr></table></figure>

<h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./sockperf server --tcp -p 11111</span><br><span class="line">./sockperf server -p 11111 #udp</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br><span class="line">numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</span><br></pre></td></tr></table></figure>
<h4 id="fio-test-multiple-nodes"><a href="#fio-test-multiple-nodes" class="headerlink" title="fio test multiple nodes"></a>fio test multiple nodes</h4><p><a target="_blank" rel="noopener" href="https://github.com/spdk/spdk/tree/master/examples/nvme/fio_plugin">fio spdk</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#command line example</span></span><br><span class="line"><span class="comment">#however only defined for true and false (1 and 0)</span></span><br><span class="line"><span class="comment">#--random_distribution=zoned_abs:60/2g:30/5g:10/2g</span></span><br><span class="line"></span><br><span class="line">$ fio --rw=randrw --bs=4K --numjobs=16 --iodepth=128 --loops=1 --ioengine=libaio --direct=1 --fsync_on_close=1 --allrandrepeat=1 --exitall --name 55555 --directory=/mnt5 --size=100G --group_reporting --refill_buffers</span><br><span class="line"></span><br><span class="line">$ fio --rw=randwrite --bs=4k --numjobs=64 --iodepth=8 --runtime=30 --time_based --loops=1 --ioengine=libaio --direct=1 --invalidate=1 --fsync_on_close=1 --randrepeat=1 --norandommap --exitall --name rw --directory=/mnt1/192.168.0.17/ --size=10G</span><br><span class="line"></span><br><span class="line">$ fio --server</span><br><span class="line"><span class="comment">## start fio process in each test server</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> fio-test</span><br><span class="line">Server-A-ip</span><br><span class="line">Server-B-ip</span><br><span class="line">Server-C-ip</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> fio.cfg</span><br><span class="line">[global]</span><br><span class="line">rw=<span class="built_in">read</span></span><br><span class="line">ioengine=libaio</span><br><span class="line">iodepth=128</span><br><span class="line">direct=1</span><br><span class="line">fallocate=none</span><br><span class="line">gtod_reduce=1</span><br><span class="line">size=65G</span><br><span class="line">numjobs=8</span><br><span class="line">group_reporting</span><br><span class="line">bssplit=1M/100</span><br><span class="line">[rw]</span><br><span class="line">directory=/mnt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ fio --client=fio_hosts.list /mnt/fio.cfg</span><br><span class="line"></span><br><span class="line">All clients: (groupid=0, <span class="built_in">jobs</span>=8): err= 0: pid=0: Fri Mar  6 17:08:04 2020</span><br><span class="line">   <span class="built_in">read</span>: IOPS=1147, BW=1148Mi (1203M)(1011GiB/902172msec)</span><br><span class="line">    slat (nsec): min=58, max=368519, avg=450.92, stdev=799.19</span><br><span class="line">    clat (usec): min=1355, max=4778.4k, avg=58198.62, stdev=114448.04</span><br><span class="line">     lat (usec): min=1356, max=4778.4k, avg=58199.07, stdev=114448.07</span><br><span class="line">   bw (  KiB/s): min= 2043, max=2654208, per=12.74%, avg=149910.02, stdev=178032.72, samples=14109</span><br><span class="line">   iops        : min=    1, max= 2592, avg=146.33, stdev=173.87, samples=14109</span><br><span class="line">  write: IOPS=1146, BW=1146Mi (1202M)(1010GiB/902172msec)</span><br><span class="line">    slat (nsec): min=162, max=916488, avg=799.05, stdev=783.74</span><br><span class="line">    clat (usec): min=1345, max=3839.9k, avg=52775.15, stdev=105530.38</span><br><span class="line">     lat (usec): min=1346, max=3839.9k, avg=52775.95, stdev=105530.41</span><br></pre></td></tr></table></figure>
<p>Test block dev <a target="_blank" rel="noopener" href="https://github.com/axboe/fio/issues/1110">lat</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slat (usec): min=4, max=6154, avg=48.82, stdev=56.38：</span><br></pre></td></tr></table></figure>
<ul>
<li>slat<ul>
<li>Submission latency (min being the minimum, max being the maximum, avg being the average, stdev being the standard deviation). This is the time it took to submit the I&#x2F;O.<ul>
<li>For sync I&#x2F;O this row is not displayed as the slat is really the completion latency (since queue&#x2F;complete is one operation there).</li>
<li>This value can be in nanoseconds, microseconds or milliseconds — fio will choose the most appropriate base and print that (in the example above nanoseconds was the best scale).</li>
<li>Note: in –minimal mode latencies are always expressed in microseconds.</li>
</ul>
</li>
</ul>
</li>
<li>clat<ul>
<li>Completion latency (after submission to completion). Same names as slat, this denotes the time from submission to completion of the I&#x2F;O pieces. For sync I&#x2F;O, clat will usually be equal (or very close) to 0, as the time from submit to complete is basically just CPU time (I&#x2F;O has already been done, see slat explanation).</li>
<li>For sync I&#x2F;O, clat will usually be equal (or very close) to 0, as the time from submit to complete is basically just CPU time (I&#x2F;O has already been done, see slat explanation).</li>
</ul>
</li>
<li>lat<ul>
<li>Total latency. Same names as slat and clat, this denotes the time from when fio created the I&#x2F;O unit to completion of the I&#x2F;O operation.</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">directory=./</span><br><span class="line">iodepth=8</span><br><span class="line">rwmixread=50</span><br><span class="line">numjobs=32</span><br><span class="line">size=100M</span><br><span class="line">norandommap=1</span><br><span class="line">group_reporting</span><br><span class="line">refill_buffers</span><br><span class="line">end_fsync=1</span><br><span class="line">disable_slat=1</span><br><span class="line">exitall</span><br><span class="line"><span class="built_in">timeout</span>=36000</span><br><span class="line">direct=0</span><br><span class="line">nrfiles=8</span><br><span class="line">bssplit=4k/10:32k/20:64k/20:128k/20:256k/20:1024k/10</span><br><span class="line">[job1]</span><br><span class="line">rw=write</span><br><span class="line">ioengine=libaio</span><br><span class="line">[job2]</span><br><span class="line">rw=<span class="built_in">read</span></span><br><span class="line">ioengine=psync</span><br></pre></td></tr></table></figure>
<ul>
<li>randseed&#x3D;int<ul>
<li>Seed the random number generators based on this seed value, to be able to control what sequence of output is being generated. If not set, the random sequence depends on the randrepeat setting.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ fio -rw=randread -ioengine=libaio -name=rw -numjobs=1 -runtime=10 -filename=/dev/sda1 --debug=random | <span class="built_in">head</span></span><br><span class="line">fio: <span class="built_in">set</span> debug option random</span><br><span class="line">rw: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1</span><br><span class="line">fio-3.7</span><br><span class="line">Starting 1 process</span><br><span class="line">random   37700 off rand 259043585</span><br><span class="line">random   37700 off rand 3179521932</span><br><span class="line">random   37700 off rand 3621444214</span><br><span class="line">random   37700 off rand 2018697059</span><br><span class="line">random   37700 off rand 1726199243</span><br><span class="line">random   37700 off rand 3608323581</span><br><span class="line">fio: pid=37700, got signal=13</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">- fio verify  </span><br><span class="line">  - verify=crc64</span><br><span class="line">  - do_verify=1 (<span class="built_in">enable</span> verify, default enabled)</span><br><span class="line">  - verify_pattern=<span class="string">&#x27;xxxxxx&#x27;</span></span><br><span class="line">  - verify=meta(This  option  is deprecated)</span><br></pre></td></tr></table></figure>
   verify&#x3D;str<br>      If writing to a file, fio can verify the file contents after each iteration of the job. Each verification method also implies<br>      verification  of special header, which is written to the beginning of each block. This header also includes meta information,<br>      like offset of the block, block number, timestamp when block was written, etc. verify can  be  combined  with  verify_pattern<br>      option. The allowed values are:<br>             crc64  Use an experimental crc64 sum of the data area and store it in the header of each block.<br>             crc32c Use  a  crc32c sum of the data area and store it in the header of each block. This will automatically use hard‐<br>                    ware acceleration (e.g. SSE4.2 on an x86 or CRC crypto extensions on ARM64) but  will  fall  back  to  software<br>                    crc32c if none is found. Generally the fastest checksum fio supports when hardware accelerated.<br>             crc32c-intel<br>                    Synonym for crc32c.<br>             crc32  Use a crc32 sum of the data area and store it in the header of each block.</li>
</ul>
</li>
</ul>
<p>$ fio –ioengine&#x3D;libaio –name&#x3D;test –direct&#x3D;1 –directory&#x3D;$filepath –bs&#x3D;512 –iodepth&#x3D;1 –readwrite&#x3D;randwrite –size&#x3D;1G –numjobs&#x3D;1 –verify&#x3D;crc64 –do_verify&#x3D;1 –verify_state_save&#x3D;1 –group_reporting –verify_backlog&#x3D;8192<br>$ fio –ioengine&#x3D;libaio –name&#x3D;test –direct&#x3D;1 –directory&#x3D;$filepath –bs&#x3D;512 –iodepth&#x3D;1 –readwrite&#x3D;randread  –size&#x3D;1G –numjobs&#x3D;1 –verify&#x3D;crc64 –group_reporting –verify_only –verify_dump&#x3D;1 –verify_state_load&#x3D;1 –do_verify&#x3D;1 –verify_backlog&#x3D;8192</p>
<p>$ fio –ioengine&#x3D;libaio –name&#x3D;test –direct&#x3D;1 –directory&#x3D;$filepath –bs&#x3D;4K –iodepth&#x3D;1 –readwrite&#x3D;randwrite –size&#x3D;4G –numjobs&#x3D;1 –verify&#x3D;crc64 –do_verify&#x3D;1 –verify_state_save&#x3D;1 –group_reporting –verify_backlog&#x3D;8192<br>$ fio –ioengine&#x3D;libaio –name&#x3D;test –direct&#x3D;1 –directory&#x3D;$filepath –bs&#x3D;4K –iodepth&#x3D;1 –readwrite&#x3D;randread  –size&#x3D;4G –numjobs&#x3D;1 –verify&#x3D;crc64 –group_reporting –verify_only –verify_dump&#x3D;1 –verify_state_load&#x3D;1 –do_verify&#x3D;1 –verify_backlog&#x3D;8192</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">- fio test metadata</span><br><span class="line">```bash</span><br><span class="line">--ioengine=posixaio --openfiles=10000 --numjobs=$DP_NUM --filesize=64k --lockfile=readwrite</span><br></pre></td></tr></table></figure>
<p>fio io_uring<br><a target="_blank" rel="noopener" href="https://github.com/Linkerist/blog/issues/25">libaio issues</a></p>
<ul>
<li>just support direct IO, no cache and alignment issue, direct IO is good for high-performance device<ul>
<li>not cache means simply</li>
</ul>
</li>
<li>block too in some cases<ul>
<li>io_getevents(2) —&gt; read_events to read AIO finished events<ul>
<li>wait_event_interruptible_hrtimeout of the read_events cause the blocked (sleep by __wait_event_hrtimeout)</li>
</ul>
</li>
</ul>
</li>
<li>copy overhead<ul>
<li>each IO will copy 64 + 8 Bytes when submit</li>
<li>each IO completed copy 32 Bytes</li>
<li>Total 104 Bytes<ul>
<li>not good for the small IO</li>
</ul>
</li>
</ul>
</li>
<li>API<ul>
<li>each IO has 2 x system call<ul>
<li>submit</li>
<li>wait for completion</li>
<li>events loss carefully</li>
<li>CVE-2017-5754 cause performance degraded</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/block_dump</span><br><span class="line">$ fio --name=randread --rw=randread --bs=4K --ioengine=io_uring --sqthread_poll=1 --size=1000G --numjobs=1 --filename=/dev/disk/by-id/ata-ST31000340NS_9QJ1CAAA-part1 --direct=1 --group_reporting</span><br><span class="line"></span><br><span class="line">fio(2039789): READ block 21187832 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 27664240 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 20709568 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 17529624 on sdb1 (8 sectors)</span><br><span class="line">fio(2039789): READ block 27647664 on sdb1 (8 sectors)</span><br></pre></td></tr></table></figure>

<h5 id="NVIDIA-GPU-Direct-Storage"><a href="#NVIDIA-GPU-Direct-Storage" class="headerlink" title="NVIDIA GPU Direct Storage"></a><a target="_blank" rel="noopener" href="https://developer.nvidia.com/zh-cn/blog/boosting-data-ingest-throughput-with-gpudirect-storage-and-rapids-cudf/">NVIDIA GPU Direct Storage</a></h5><ul>
<li>no GPU to test cudf</li>
</ul>
<h4 id="test-softlock-and-hardlock-in-kernel"><a href="#test-softlock-and-hardlock-in-kernel" class="headerlink" title="test softlock and hardlock in kernel"></a>test softlock and hardlock in kernel</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">hog.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kthread.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">hog_thread</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hogging a CPU now\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* unreached */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init</span><br><span class="line"><span class="title function_">hog_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, <span class="literal">NULL</span>, <span class="string">&quot;hog&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line"><span class="meta">#makefile</span></span><br><span class="line">obj-m += hog.o</span><br><span class="line"> </span><br><span class="line">all:</span><br><span class="line">    make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) modules</span><br><span class="line">clean:</span><br><span class="line">    make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) clean</span><br><span class="line"></span><br><span class="line"><span class="meta"># in centos </span></span><br><span class="line">$ cat Makefile</span><br><span class="line">obj-m += hog.o</span><br><span class="line"></span><br><span class="line">all: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">clean: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$ make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">$ ls </span><br><span class="line">hog.c  hog.ko  hog.mod.c  hog.mod.o  hog.o  Makefile  modules.order  Module.symvers</span><br><span class="line"></span><br><span class="line">$ insmod hog.ko</span><br><span class="line">$ lsmod | grep hog</span><br><span class="line">hog                    <span class="number">12386</span>  <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> kernel:NMI watchdog: BUG: soft lockup - CPU#<span class="number">0</span> stuck <span class="keyword">for</span> <span class="number">23</span>s! [hog:<span class="number">2308</span>]</span><br><span class="line"></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] NMI watchdog: BUG: soft lockup - CPU#<span class="number">0</span> stuck <span class="keyword">for</span> <span class="number">23</span>s! [hog:<span class="number">2308</span>]</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Modules linked in: hog(OE) dell_rbu dcdbas sunrpc nfit libnvdimm zfs(POE) zunicode(POE) zavl(POE) icp(POE) ppdev iosf_mbi crc32_pclmul ghash_clmulni_intel joydev zcommon(POE) znvpair(POE) spl(OE) sg aesni_intel virtio_balloon virtio_rng lrw gf128mul glue_helper ablk_helper cryptd pcspkr i2c_piix4 parport_pc parport binfmt_misc ip_tables xfs libcrc32c sr_mod sd_mod cdrom crc_t10dif crct10dif_generic ata_generic pata_acpi virtio_console virtio_net virtio_blk virtio_scsi qxl drm_kms_helper syscopyarea sysfillrect sysimgblt fb_sys_fops ttm drm crct10dif_pclmul crct10dif_common crc32c_intel ata_piix ahci libahci libata serio_raw virtio_pci virtio_ring virtio floppy drm_panel_orientation_quirks dm_mirror dm_region_hash dm_log dm_mod</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] CPU: <span class="number">0</span> PID: <span class="number">2308</span> Comm: hog Kdump: loaded Tainted: P           OE  ------------   <span class="number">3.10</span><span class="number">.0</span><span class="number">-1062.1</span><span class="number">.1</span>.el7.x86_64 #<span class="number">1</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Hardware name: Red Hat KVM, BIOS <span class="number">1.11</span><span class="number">.1</span><span class="number">-4.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">189</span>+f9babebb <span class="number">04</span>/<span class="number">01</span>/<span class="number">2014</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] task: ffff9c0335878000 ti: ffff9c03356a4000 task.ti: ffff9c03356a4000</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RIP: <span class="number">0010</span>:[&lt;ffffffffc0721017&gt;]  [&lt;ffffffffc0721017&gt;] hog_thread+<span class="number">0x17</span>/<span class="number">0x1000</span> [hog]</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RSP: <span class="number">0018</span>:ffff9c03356a7ec0  EFLAGS: <span class="number">00000246</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RAX: <span class="number">0000000000000011</span> RBX: ffff9c03356a7e50 RCX: <span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RDX: <span class="number">0000000000000000</span> RSI: ffff9c033dc13898 RDI: ffff9c033dc13898</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] RBP: ffff9c03356a7ec0 R08: <span class="number">0000000000000000</span> R09: <span class="number">0000000000000040</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] R10: <span class="number">000000000000029</span>a R11: <span class="number">0000000000</span>aaaaaa R12: <span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] R13: ffffffffc0721000 R14: <span class="number">0000000000000000</span> R15: ffff9c03352ebc90</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] FS:  <span class="number">0000000000000000</span>(<span class="number">0000</span>) GS:ffff9c033dc00000(<span class="number">0000</span>) knlGS:<span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] CS:  <span class="number">0010</span> DS: <span class="number">0000</span> ES: <span class="number">0000</span> CR0: <span class="number">0000000080050033</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] CR2: <span class="number">0000561560589e20</span> CR3: <span class="number">0000000006010000</span> CR4: <span class="number">00000000003606f</span>0</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] DR0: <span class="number">0000000000000000</span> DR1: <span class="number">0000000000000000</span> DR2: <span class="number">0000000000000000</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] DR3: <span class="number">0000000000000000</span> DR6: <span class="number">00000000f</span>ffe0ff0 DR7: <span class="number">0000000000000400</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Call Trace:</span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa08c50d1&gt;] kthread+<span class="number">0xd1</span>/<span class="number">0xe0</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa08c5000&gt;] ? insert_kthread_work+<span class="number">0x40</span>/<span class="number">0x40</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa0f8cd37&gt;] ret_from_fork_nospec_begin+<span class="number">0x21</span>/<span class="number">0x21</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>]  [&lt;ffffffffa08c5000&gt;] ? insert_kthread_work+<span class="number">0x40</span>/<span class="number">0x40</span></span><br><span class="line">[Mon Jun  <span class="number">8</span> <span class="number">03</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2020</span>] Code: &lt;eb&gt; fe <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>Enable nmi_watchdog&#x3D;1 in kernel  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat hard.c</span><br><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/kernel.h&gt;</span><br><span class="line">#include &lt;linux/kthread.h&gt;</span><br><span class="line">#include &lt;linux/spinlock.h&gt;</span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"> </span><br><span class="line">static int</span><br><span class="line">hog_thread(void *data)</span><br><span class="line">&#123;</span><br><span class="line">    static DEFINE_SPINLOCK(lock);</span><br><span class="line">    unsigned long flags;</span><br><span class="line"> </span><br><span class="line">    printk(KERN_INFO &quot;Hogging a CPU now\n&quot;);</span><br><span class="line">    spin_lock_irqsave(&amp;lock, flags);</span><br><span class="line">    while (1);</span><br><span class="line"> </span><br><span class="line">    /* unreached */</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">static int __init</span><br><span class="line">hog_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    kthread_run(hog_thread, NULL, &quot;hog&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hog_init);</span><br><span class="line"></span><br><span class="line">obj-m += hard.o</span><br><span class="line"></span><br><span class="line">all: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">clean: make -C /lib/modules/$(uname -r)/build/ M=$(pwd) clean</span><br><span class="line"></span><br><span class="line">$ make -C /lib/modules/$(uname -r)/build/ M=$(pwd) modules</span><br><span class="line">make: Entering directory `/usr/src/kernels/3.10.0-1062.1.1.el7.x86_64&#x27;</span><br><span class="line">  CC [M]  /root/hardhog/hard.o</span><br><span class="line">  Building modules, stage 2.</span><br><span class="line">  MODPOST 1 modules</span><br><span class="line">  CC      /root/hardhog/hard.mod.o</span><br><span class="line">  LD [M]  /root/hardhog/hard.ko</span><br><span class="line"></span><br><span class="line">$ insmod hard.ko</span><br><span class="line"></span><br><span class="line"># after insmod, the KVM ssh not respond too.</span><br></pre></td></tr></table></figure>

<h4 id="ab"><a href="#ab" class="headerlink" title="ab"></a>ab</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 10000 -c 300 http://xx.xx.xx.xx/test.php</span><br></pre></td></tr></table></figure>

<h4 id="RoCEv2-benchmark"><a href="#RoCEv2-benchmark" class="headerlink" title="RoCEv2 benchmark"></a>RoCEv2 benchmark</h4><h5 id="rping"><a href="#rping" class="headerlink" title="rping"></a>rping</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Server A $ rping -s</span><br><span class="line">Server B $ rping -c -a 192.168.0.2 -v</span><br><span class="line">ping data: rdma-ping-0: ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqr</span><br><span class="line">ping data: rdma-ping-1: BCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrs</span><br></pre></td></tr></table></figure>

<h5 id="ibv-rc-pingpong"><a href="#ibv-rc-pingpong" class="headerlink" title="ibv_rc_pingpong"></a>ibv_rc_pingpong</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Server A $ ibv_rc_pingpong -g 0 -d bnxt_re1 -i 1 -r 1000 -n 9999999 -l 10</span><br><span class="line">  <span class="built_in">local</span> address:  LID 0x0000, QPN 0x000609, PSN 0xbf578f, GID fe80::b226:28ff:fee0:4d11</span><br><span class="line">  remote address: LID 0x0000, QPN 0x0003ec, PSN 0xdbc936, GID fe80::9a03:9bff:fe90:8040</span><br><span class="line">81919991808 bytes <span class="keyword">in</span> 56.09 seconds = 11684.77 Mbit/sec</span><br><span class="line">9999999 iters <span class="keyword">in</span> 56.09 seconds = 5.61 usec/iter</span><br><span class="line"></span><br><span class="line">Server B $  ibv_rc_pingpong -g 0 -d mlx5_0 -r 1000 -n 9999999 -l 10 192.168.0.2</span><br><span class="line">  <span class="built_in">local</span> address:  LID 0x0000, QPN 0x0003ec, PSN 0xdbc936, GID fe80::9a03:9bff:fe90:8040</span><br><span class="line">  remote address: LID 0x0000, QPN 0x000609, PSN 0xbf578f, GID fe80::b226:28ff:fee0:4d11</span><br><span class="line">81919991808 bytes <span class="keyword">in</span> 56.09 seconds = 11684.59 Mbit/sec</span><br><span class="line">9999999 iters <span class="keyword">in</span> 56.09 seconds = 5.61 usec/iter</span><br></pre></td></tr></table></figure>

<h5 id="qperf-1"><a href="#qperf-1" class="headerlink" title="qperf"></a>qperf</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Server A $ qerf</span><br><span class="line">Server B $ qperf -cm1 -t 3600 -oo msg_size:64 192.168.0.2 rc_lat</span><br><span class="line"></span><br><span class="line">Server A $ qperf -lp 4002</span><br><span class="line">Server B $ qperf -cm1 -lp 4002 -t 3600 -oo msg_size:64 192.168.0.2 rc_bw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ qperf -vvs &lt;server_hostname_or_ip_address&gt; tcp_lat</span><br></pre></td></tr></table></figure>

<h5 id="perftest"><a href="#perftest" class="headerlink" title="perftest"></a>perftest</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">size: 2, 64, 4096, 16384, tps and latency</span><br><span class="line">server: ib_read_lat -d mlx5_0 -p 18515 -F -s 2 -D 300 -n 100000 --cpu_util --rdma_cm</span><br><span class="line">client: ib_read_lat -d bnxt_re1 -p 18515 -F -s 2 -D 300 -n 100000 --cpu_util --rdma_cm 192.168.0.2</span><br><span class="line"></span><br><span class="line">size: 262144, 1048576, bw and latency</span><br><span class="line">server: ib_read_bw -d mlx5_0 -p 18525 -b -F -s 1048576 -D 300 -n 100000 --cpu_util --rdma_cm</span><br><span class="line">client: ib_read_bw -d bnxt_re1 -p 18525 -b -F -s 1048576 -D 300 -n 100000 --cpu_util --rdma_cm 192.168.0.2</span><br><span class="line"><span class="comment">#ib_write, ib_send....</span></span><br><span class="line"></span><br><span class="line">port_num=18515</span><br><span class="line">time_out=300</span><br><span class="line">server_dev=mlx5_0</span><br><span class="line">client_dev=bnxt_re1</span><br><span class="line">server_testip=192.168.0.2</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> ------------- lat</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 2 64 4096 16384</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_read_lat -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_read_lat -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_write_lat -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_write_lat -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> ------------- bw</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 262144 1048576</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_read_bw -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_read_bw -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;server: &quot;</span>ib_write_bw -d <span class="variable">$server_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span>  -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm </span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: &quot;</span>ib_write_bw -d <span class="variable">$client_dev</span> -p <span class="variable">$port_num</span> -b -F -s <span class="variable">$i</span> -D <span class="variable">$time_out</span> -n 100000 --cpu_util --rdma_cm <span class="variable">$server_testip</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;client: sleep 3&quot;</span></span><br><span class="line"> ((port_num++))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="MEM"><a href="#MEM" class="headerlink" title="MEM"></a>MEM</h4><h5 id="lmbench"><a href="#lmbench" class="headerlink" title="lmbench"></a>lmbench</h5><p>lat_mem_rd  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#install el8</span></span><br><span class="line">$ <span class="built_in">cd</span> src</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=<span class="variable">$C_INCLUDE_PATH</span>:/usr/include/tirpc;make results LDFLAGS=-ltirpc</span><br><span class="line">$ ctrl + c <span class="built_in">exit</span> the benchmark</span><br><span class="line"></span><br><span class="line"><span class="comment">#compare diff cores</span></span><br><span class="line"><span class="comment">#-t test TLB miss and Cache miss for memory latency</span></span><br><span class="line">$ numactl -C 38 -m 0 ./lat_mem_rd  -N 5 -W 5 -t 2048M</span><br><span class="line">$ numactl -C 38 -m 1 ./lat_mem_rd  -N 5 -W 5 -t 2048M</span><br><span class="line">$ numactl -C 38 -m 2 ./lat_mem_rd  -N 5 -W 5 -t 2048M</span><br><span class="line">$ numactl -C 38 -m 3 ./lat_mem_rd  -N 5 -W 5 -t 2048M</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> run.lm</span><br><span class="line">numa_arr=($(numactl --show | grep nodebind: | grep -Eo [0-9]))</span><br><span class="line">test_size=<span class="string">&quot;2048M&quot;</span></span><br><span class="line">lscpu | awk -F <span class="string">&#x27;[ ,-]+&#x27;</span> <span class="string">&#x27;$0~/NUMA node.*CPU/&#123;print $4,$NF&#125;&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  core1=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">  core2=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> node <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;numa_arr[@]&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    [[ -d /proc/sys/kernel/sched_domain/cpu<span class="variable">$&#123;core1&#125;</span>/domain<span class="variable">$&#123;node&#125;</span> ]] &amp;&amp; core_node=<span class="variable">$&#123;node&#125;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;core: <span class="variable">$core1</span> node: <span class="variable">$&#123;node&#125;</span>&quot;</span>;</span><br><span class="line">    [[ -d /proc/sys/kernel/sched_domain/cpu<span class="variable">$&#123;core2&#125;</span>/domain<span class="variable">$&#123;node&#125;</span> ]] &amp;&amp; core_node=<span class="variable">$&#123;node&#125;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;core: <span class="variable">$core2</span> node: <span class="variable">$&#123;node&#125;</span>&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;numactl -C <span class="variable">$core1</span> -m <span class="variable">$node</span> /root/lm/lmbench/bin/x86_64-linux-gnu/lat_mem_rd -N 5 -W 5 -t <span class="variable">$test_size</span>&quot;</span></span><br><span class="line">    numactl -C <span class="variable">$core1</span> -m <span class="variable">$node</span> /root/lm/lmbench/bin/x86_64-linux-gnu/lat_mem_rd -N 5 -W 5 -t <span class="variable">$test_size</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;numactl -C <span class="variable">$core2</span> -m <span class="variable">$node</span> /root/lm/lmbench/bin/x86_64-linux-gnu/lat_mem_rd -N 5 -W 5 -t <span class="variable">$test_size</span>&quot;</span></span><br><span class="line">    numactl -C <span class="variable">$core2</span> -m <span class="variable">$node</span> /root/lm/lmbench/bin/x86_64-linux-gnu/lat_mem_rd -N 5 -W 5 -t <span class="variable">$test_size</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ sh run.lm 2&gt;&amp;1 | <span class="built_in">tee</span> lm.6336Y</span><br><span class="line">$ <span class="built_in">cat</span> lm.6336Y | grep -E <span class="string">&quot;^[0-9]&quot;</span> | awk <span class="string">&#x27;&#123;min=(NR==1 || $2&lt;min ? $2 : min);max=(NR==1 || $2&gt;max ? $2 : max);sum+=$2;c++; if($1&gt;=128)&#123;sum1+=$2;c1++&#125; &#125; END&#123;print sum/c,sum1/c1,min,max&#125;&#x27;</span></span><br><span class="line">35.8213 83.0324 1.673 89.474</span><br><span class="line"></span><br><span class="line">1 Cycle per Microsecond</span><br><span class="line">A period of 1 Microsecond(µs)= is equal to 1 000 000 Hertz frequency</span><br><span class="line"></span><br><span class="line">https://www.genci.fr/sites/default/files/PhysiqueChimie_CALMIP-Scemama.pdf</span><br><span class="line">2x Xeon E5-2670 @ 2.6 GHz, 1x cycle = 0.38ns</span><br><span class="line">L1 : 1.2 ns (3-4 cycles)</span><br><span class="line">L2 : 3.6 ns (9-10 cycles)</span><br><span class="line">L3 : 16 ns (42 cycles)</span><br><span class="line">RAM : 86 / 155 ns (224-403 cycles)</span><br><span class="line"></span><br><span class="line">Intel Xeon E7-8837 @ 2.67 GHz</span><br><span class="line">1 cycle CPU: 0.37 ns</span><br><span class="line">  Au maximum 8 flops/cycle (SP), donc 1 flop ~ 0.047 ns</span><br><span class="line">L1 : 1.5 ns (4 cycles)</span><br><span class="line">L2 : 3.7 ns (10 cycles)</span><br><span class="line">L3 : 16 ns (43 cycles)</span><br><span class="line">RAM : 195 / 228 / 570 / 670 / 760 / 875 / 957 ns (520-2555 cycles), looks like 4x socket ?</span><br><span class="line">Infiniband: 1200 ns (3204 cycles)</span><br><span class="line"></span><br><span class="line"><span class="comment">#in my test</span></span><br><span class="line">RoCEv2, 2 Bytes: 3270 ns(8606 cycles)</span><br><span class="line"></span><br><span class="line">https://web.eecs.umich.edu/~chshibo/files/microkiller_report.pdf</span><br><span class="line">average direct cost of user-level context switch time is 1.18µs=1180 ns</span><br><span class="line"></span><br><span class="line">https://lenovopress.lenovo.com/lp1362-thinksystem-kioxia-cm6-r-entry-nvme-pcie-40-x4-ssd</span><br><span class="line">KIOXIA CM6 SSD PCIE Gen4 random <span class="built_in">read</span> 90µs, random write 20µs, power:20w</span><br><span class="line"></span><br><span class="line">SSD <span class="built_in">read</span> 1MB data 85µs(calculate by HDD), 4KiB iops 1,400,000</span><br><span class="line">HDD seek time 10ms</span><br><span class="line">HDD <span class="built_in">read</span> 1MB data 20ms, 4KiB <span class="built_in">seq</span> iops about 6000+  </span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/QNgMS0gOXhZml8l_towAbw">mem-lat.c</a>  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ONE p = (char **)*p;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIVE    ONE ONE ONE ONE ONE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEN FIVE FIVE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIFTY   TEN TEN TEN TEN TEN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HUNDRED FIFTY FIFTY</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">usage</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: ./mem-lat -b xxx -n xxx -s xxx\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -b buffer size in KB\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -n number of read\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   -s stride skipped before the next access\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please don&#x27;t use non-decimal based number\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> i, j, size, tmp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> memsize = <span class="number">0x800000</span>; <span class="comment">/* 1/4 LLC size of skylake, 1/5 of broadwell */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> count = <span class="number">1048576</span>; <span class="comment">/* memsize / 64 * 8 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> stride = <span class="number">64</span>; <span class="comment">/* skipped amount of memory before the next access */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sec, usec;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv1</span>, <span class="title">tv2</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timezone</span> <span class="title">tz</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *indices;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*argv)[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;  <span class="comment">/* look at first char of next */</span></span><br><span class="line">            <span class="keyword">switch</span> ((*argv)[<span class="number">1</span>]) &#123;   <span class="comment">/* look at second */</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                    argv++;</span><br><span class="line">                    argc--;</span><br><span class="line">                    memsize = atoi(*argv) * <span class="number">1024</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">                    argv++;</span><br><span class="line">                    argc--;</span><br><span class="line">                    count = atoi(*argv);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                    argv++;</span><br><span class="line">                    argc--;</span><br><span class="line">                    stride = atoi(*argv);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    usage();</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        argv++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="type">char</span>* mem = mmap(<span class="literal">NULL</span>, memsize, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// trick3: init pointer chasing, per stride=8 byte</span></span><br><span class="line">    size = memsize / stride;</span><br><span class="line">    indices = <span class="built_in">malloc</span>(size * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        indices[i] = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trick 2: fill mem with pointer references</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size - <span class="number">1</span>; i++)</span><br><span class="line">        *(<span class="type">char</span> **)&amp;mem[indices[i]*stride]= (<span class="type">char</span>*)&amp;mem[indices[i+<span class="number">1</span>]*stride];</span><br><span class="line">    *(<span class="type">char</span> **)&amp;mem[indices[size<span class="number">-1</span>]*stride]= (<span class="type">char</span>*)&amp;mem[indices[<span class="number">0</span>]*stride];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shuffle indices</span></span><br><span class="line">    <span class="comment">/* for (i = 0; i &lt; size; i++) &#123;</span></span><br><span class="line"><span class="comment">         j = i +  rand() % (size - i);</span></span><br><span class="line"><span class="comment">         if (i != j) &#123;</span></span><br><span class="line"><span class="comment">             tmp = indices[i];</span></span><br><span class="line"><span class="comment">             indices[i] = indices[j];</span></span><br><span class="line"><span class="comment">             indices[j] = tmp;</span></span><br><span class="line"><span class="comment">         &#125;</span></span><br><span class="line"><span class="comment">     &#125; */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> **p = (<span class="type">char</span> **) mem;</span><br><span class="line">    <span class="comment">//register char **p = (char **)mem;</span></span><br><span class="line"></span><br><span class="line">    tmp = count / <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gettimeofday (&amp;tv1, &amp;tz);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tmp; ++i) &#123;</span><br><span class="line">        HUNDRED;  <span class="comment">//trick 1</span></span><br><span class="line">    &#125;</span><br><span class="line">    gettimeofday (&amp;tv2, &amp;tz);</span><br><span class="line">    <span class="keyword">if</span> (tv2.tv_usec &lt; tv1.tv_usec) &#123;</span><br><span class="line">        usec = <span class="number">1000000</span> + tv2.tv_usec - tv1.tv_usec;</span><br><span class="line">        sec = tv2.tv_sec - tv1.tv_sec - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        usec = tv2.tv_usec - tv1.tv_usec;</span><br><span class="line">        sec = tv2.tv_sec - tv1.tv_sec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Buffer size: %ld KB, stride %d, time %d.%06d s, latency %.2f ns\n&quot;</span>,</span><br><span class="line">            memsize/<span class="number">1024</span>, stride, sec, usec, (sec * <span class="number">1000000</span>  + usec) * <span class="number">1000.0</span> / (tmp *<span class="number">100</span>));</span><br><span class="line">    munmap(mem, memsize);</span><br><span class="line">    <span class="built_in">free</span>(indices);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">work=./mem-lat</span><br><span class="line">buffer_size=1</span><br><span class="line">stride=8</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">seq</span> 1 15`; <span class="keyword">do</span></span><br><span class="line">    taskset -ac 0 <span class="variable">$work</span> -b <span class="variable">$buffer_size</span> -s <span class="variable">$stride</span></span><br><span class="line">    buffer_size=$((<span class="variable">$buffer_size</span>*<span class="number">2</span>))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><a href="">pause.c</a></p>
<ul>
<li>Decrease the switch context</li>
<li>The another HT logic core could be use</li>
<li>Keep power save</li>
<li>The PAUSE instruction is first introduced for Intel Pentium 4 processor to improve the performance of “spin-wait loop”. The PAUSE instruction is typically used with software threads executing on two logical processors located in the same processor core, waiting for a lock to be released. Such short wait loops tend to last between tens and a few hundreds of cycles. When the wait loop is expected to last for thousands of cycles or more, it is preferable to yield to the operating system by calling one of the OS synchronization API functions, such as WaitForSingleObject on Windows OS.</li>
<li>An Intel® processor suffers a severe performance penalty when exiting the loop because it detects a possible memory order violation. The PAUSE instruction provides a hint to the processor that the code sequence is a spin-wait loop. The processor uses this hint to avoid the memory order violation in most situations. The PAUSE instruction can improve the performance of the processors supporting Intel Hyper-Threading Technology when executing “spin-wait loops”. With pause instruction, processors are able to avoid the memory order violation and pipeline flush, and reduce power consumption through pipeline stall.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">$ perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./pause</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMES 5</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title function_">rdtsc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> low, high;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdtsc&quot;</span> : <span class="string">&quot;=a&quot;</span> (low), <span class="string">&quot;=d&quot;</span> (high) )</span>;</span><br><span class="line">    <span class="keyword">return</span> ((low) | (high) &lt;&lt; <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pause_test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TIMES; i++) &#123;</span><br><span class="line">        <span class="keyword">asm</span>(</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span>\</span><br><span class="line">                <span class="string">&quot;pause\n&quot;</span></span><br><span class="line">                ::</span><br><span class="line">                :);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">pause_cycle</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start, finish, elapsed;</span><br><span class="line">    start = rdtsc();</span><br><span class="line">    pause_test();</span><br><span class="line">    finish = rdtsc();</span><br><span class="line">    elapsed = finish - start;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Pause的cycles约为:%ld\n&quot;</span>, elapsed / <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    pause_cycle();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">long</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">      count++;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ perf top --<span class="keyword">asm</span>-raw -p  <span class="number">70832</span></span><br><span class="line"></span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">12.03</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">25.51</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">23.43</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line">       │         __asm__ __volatile__(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"> <span class="number">24.81</span> │     f3     <span class="number">90</span>                   pause</span><br><span class="line"> <span class="number">14.22</span> │     eb     f6                   jmp    <span class="number">400400</span> &lt;main&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>intel x86 cpu bound and memory bound   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ sudo perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores -a ./memory_bound</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;emmintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">memory_bound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="type">unsigned</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">register</span> <span class="type">char</span> b;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;(<span class="number">1u</span>&lt;&lt;<span class="number">24</span>);i++) &#123;</span><br><span class="line">                <span class="comment">// evict cacheline containing a</span></span><br><span class="line">                 _mm_clflush(&amp;a);</span><br><span class="line">                 b = a;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">cpu_bound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">register</span> <span class="type">unsigned</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;(<span class="number">1u</span>&lt;&lt;<span class="number">31</span>);i++) &#123;</span><br><span class="line">                __asm__ (<span class="string">&quot;nop\nnop\nnop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">          <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>; ++i)&#123;</span><br><span class="line">                 <span class="comment">//cpu_bound();</span></span><br><span class="line">                 memory_bound();</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="uarch-bench"><a href="#uarch-bench" class="headerlink" title="uarch-bench"></a><a target="_blank" rel="noopener" href="https://github.com/travisdowns/uarch-bench">uarch-bench</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">$ yum install devtoolset-9-toolchain</span><br><span class="line">$ scl <span class="built_in">enable</span> devtoolset-9 bash</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/obilaniu/libpfc</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/nemequ/portable-snippets</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/andikleen/pmu-tools</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/bombela/backward-cpp/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/travisdowns/nasm-utils</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/wcohen/libpfm4</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/travisdowns/avx-turbo</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfc ./</span><br><span class="line">$ <span class="built_in">cp</span> -a nasm-utils uarch-benchs</span><br><span class="line">$ <span class="built_in">cp</span> -a ../pmu-tools ./</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfm4 ./</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.o ./</span><br><span class="line">$ vi isa-support.cpp</span><br><span class="line">$ vi perf-timer.cpp</span><br><span class="line">$ vi main.cpp</span><br><span class="line">$ vi libpfm4-support.cpp</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">avx-turbo  backward-cpp  libpfc  libpfm4  nasm-utils  pmu-tools  portable-snippets  uarch-bench</span><br><span class="line">$ <span class="built_in">cd</span> avx-turbo</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../libpfc</span><br><span class="line">$ make</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=<span class="variable">$C_INCLUDE_PATH</span>:/opt/lib/el7/mpich-3.2.1/include/:/opt/lib/el7/libtool-2.4.6/include:~/uarch/libpfc/include:~/uarch/avx-turbo:~/uarch/libpfc/include</span><br><span class="line">$ <span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:/local/nvme/uarch/libpfc</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../uarch-bench</span><br><span class="line">$ <span class="built_in">rmdir</span> libpfc</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfc ./</span><br><span class="line">$ <span class="built_in">mkdir</span> cpu</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.c cpu</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.h cpu</span><br><span class="line">$ <span class="built_in">rmdir</span> pmu-tools</span><br><span class="line">$ <span class="built_in">cp</span> -a ../pmu-tools ./</span><br><span class="line">$ <span class="built_in">rmdir</span> backward-cpp</span><br><span class="line">$ <span class="built_in">cp</span> -a ../backward-cpp ./</span><br><span class="line">$ <span class="built_in">rmdir</span> nasm-utils/</span><br><span class="line">$ <span class="built_in">cp</span> -a ../nasm-utils ./</span><br><span class="line">$ <span class="built_in">rmdir</span> libpfm4</span><br><span class="line">$ <span class="built_in">cp</span> -a ../libpfm4 ./</span><br><span class="line">$ <span class="built_in">rmdir</span> pmu-tools</span><br><span class="line">$ <span class="built_in">cp</span> -a ../pmu-tools ./</span><br><span class="line">$ <span class="built_in">cp</span> ../avx-turbo/cpu.o ./</span><br><span class="line">$ make</span><br><span class="line"></span><br><span class="line">$ ./uarch-bench</span><br><span class="line">Welcome to uarch-bench (f88a3a8-dirty)</span><br><span class="line">Supported CPU features: SSE3 PCLMULQDQ VMX SMX EST TM2 SSSE3 FMA CX16 SSE4_1 SSE4_2 MOVBE POPCNT AES AVX RDRND TSC_ADJ SGX BMI1 HLE AVX2 BMI2 ERMS RTM MPX RDSEED ADX CLFLUSHOPT INTEL_PT</span><br><span class="line">Pinned to CPU 0</span><br><span class="line">Median CPU speed: 3.987 GHz</span><br><span class="line">Running benchmarks <span class="built_in">groups</span> using timer clock</span><br><span class="line"></span><br><span class="line">** Running group basic : Basic Benchmarks **</span><br><span class="line">                               Benchmark    Cycles     Nanos</span><br><span class="line">                     Dependent add chain      1.00      0.25</span><br><span class="line">                   Independent add chain      0.25      0.06</span><br><span class="line">                  Dependent imul 64-&gt;128      3.00      0.75</span><br><span class="line">                   Dependent imul 64-&gt;64      3.00      0.75</span><br><span class="line">                Independent imul 64-&gt;128      1.01      0.25</span><br><span class="line">                 Independent imul 64-&gt;64      1.00      0.25</span><br><span class="line">                    Same location stores      1.00      0.25</span><br><span class="line">                Disjoint location stores      1.00      0.25</span><br><span class="line">                Dependent push/pop chain      4.42      1.11</span><br><span class="line">              Independent push/pop chain      1.04      0.26</span><br><span class="line">     Back-to-back call of empty <span class="keyword">function</span>      4.37      1.10</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">$ $ ./uarch-bench.sh --test-name=memory/load-parallel/parallel-load-128</span><br><span class="line">Driver: intel_pstate, governor: performance</span><br><span class="line">Vendor ID: GenuineIntel</span><br><span class="line">Model name: Intel(R) Xeon(R) CPU E5-2643 v3 @ 3.40GHz</span><br><span class="line">intel_pstate/no_turbo reports that turbo is already disabled</span><br><span class="line">Using timer: clock</span><br><span class="line">Welcome to uarch-bench (f88a3a8-dirty)</span><br><span class="line">Supported CPU features: SSE3 PCLMULQDQ VMX SMX EST TM2 SSSE3 FMA CX16 SSE4_1 SSE4_2 MOVBE POPCNT AES AVX RDRND TSC_ADJ BMI1 AVX2 BMI2 ERMS</span><br><span class="line">Pinned to CPU 0</span><br><span class="line">Median CPU speed: 3.399 GHz</span><br><span class="line">Running benchmarks <span class="built_in">groups</span> using timer clock</span><br><span class="line"></span><br><span class="line">** Running group memory/load-parallel : Random(ish) parallel loads from fixed-size regions **</span><br><span class="line">                               Benchmark    Cycles     Nanos</span><br><span class="line">                   128-KiB parallel load      2.27      0.67</span><br><span class="line">Finished <span class="keyword">in</span> 315 ms (memory/load-parallel)</span><br><span class="line"></span><br><span class="line">$./uarch-bench.sh --timer=perf --test-name=cpp/sum-halves --extra-events=uops_issued.any</span><br><span class="line">./uarch-bench.sh --test-name=cpp/sum-halves --extra-events=uops_issued.any</span><br><span class="line">$./uarch-bench.sh --timer=perf --test-name=cpp/mul-4 --extra-events=uops_issued.any,uops_retired.retire_slots</span><br><span class="line">./uarch-bench.sh --test-name=cpp/mul-4 --extra-events=uops_issued.any,uops_retired.retire_slots</span><br><span class="line">$./uarch-bench.sh --timer=perf --test-name=cpp/mul-4 --extra-events=uops_dispatched_port.port_0<span class="comment">#p0,uops_dispatched_port.port_1#p1,uops_dispatched_port.port_2#p2,uops_dispatched_port.port_3#p3,uops_dispatched_port.port_4#p4,uops_dispatched_port.port_5#p5,uops_dispatched_port.port_6#p6,uops_dispatched_port.port_7#p7</span></span><br><span class="line">$ ./uarch-bench.sh --test-name=cpp/mul-4 --extra-events=uops_dispatched_port.port_0<span class="comment">#p0,uops_dispatched_port.port_1#p1,uops_dispatched_port.port_2#p2,uops_dispatched_port.port_3#p3,uops_dispatched_port.port_4#p4,uops_dispatched_port.port_5#p5,uops_dispatched_port.port_6#p6,uops_dispatched_port.port_7#p7</span></span><br><span class="line">$ ./uarch-bench.sh --test-name=cpp/mul-chain --extra-events=uops_dispatched_port.port_0<span class="comment">#p0,uops_dispatched_port.port_1#p1,uops_dispatched_port.port_2#p2,uops_dispatched_port.port_3#p3,uops_dispatched_port.port_4#p4,uops_dispatched_port.port_5#p5,uops_dispatched_port.port_6#p6</span></span><br></pre></td></tr></table></figure>

<h4 id="contextswitch"><a href="#contextswitch" class="headerlink" title="contextswitch"></a><a target="_blank" rel="noopener" href="https://github.com/tsuna/contextswitch">contextswitch</a></h4><h4 id="X-mem"><a href="#X-mem" class="headerlink" title="X-mem"></a><a target="_blank" rel="noopener" href="https://nanocad-lab.github.io/X-Mem/">X-mem</a></h4><p>####<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/tool/intelr-memory-latency-checker.html">intel mlc</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlc -c2c_latency -c2 -w22 -b200000 -C128</span><br></pre></td></tr></table></figure>
<p>The above command is used to measure the time taken to transfer a modified line from L2 cache to another core on a different socket. Writer thread ‘w’ pinned to cpu 22 modifies 128KB of data (as specified in –C parameter) and transfers control to reader thread ‘c’ on cpu 2. Now, this thread reads the same 128KB of data that is currently resident in L2 of thread 22. Since those lines are in M state, the snoop responses would be Hit-modified (aka HITM) and the line would be transferred from the cache to the requester. Then the control is transferred back to the writer thread and this thread would move the window to another 128KB range in the buffer specified by –b parameter and the process will be repeated.</p>
<h4 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h4><p>Show the issues of the toshiba and seagate NLSAS HDD   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">time <span class="built_in">seq</span> -w 1 2000 | xargs -n1 -I% sh -c <span class="string">&#x27;sudo dd if=/dev/zero of=file.% bs=1KB count=1 oflag=dsync&#x27;</span></span><br><span class="line"></span><br><span class="line">scsi_dev=/dev/disk/by-id/scsi-35000ff12727bd315</span><br><span class="line">bsize=$(($(blockdev --getsz <span class="variable">$scsi_dev</span>)*<span class="number">512</span>))</span><br><span class="line">start_t=$(<span class="built_in">date</span> +%s)</span><br><span class="line"><span class="keyword">for</span> ((i=<span class="number">0</span>;i&lt;=<span class="number">999</span>;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">dd</span> <span class="keyword">if</span>=<span class="variable">$scsi_dev</span> of=<span class="variable">$scsi_dev</span> bs=1 seek=$(<span class="built_in">shuf</span> -i 1-<span class="variable">$bsize</span> -n 1) skip=$(<span class="built_in">shuf</span> -i 1-<span class="variable">$bsize</span> -n 1) iflag=<span class="built_in">sync</span> oflag=<span class="built_in">sync</span> count=3 &gt;/dev/null 2&gt;/dev/null &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"><span class="built_in">echo</span> $(($(date +%s)-start_t))<span class="string">&quot; secs&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> k <span class="keyword">in</span> &#123;0..19&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;---------HDD------------&quot;</span> <span class="variable">$k</span> ; sh test16.sh; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="Emulate-simulate-some-errors-to-test-the-block-device"><a href="#Emulate-simulate-some-errors-to-test-the-block-device" class="headerlink" title="Emulate&#x2F;simulate some errors to test the block device"></a>Emulate&#x2F;simulate some errors to test the block device</h4><h5 id="dm-delay"><a href="#dm-delay" class="headerlink" title="dm-delay"></a><a target="_blank" rel="noopener" href="https://enodev.fr/posts/emulate-a-slow-block-device-with-dm-delay.html#">dm-delay</a></h5><p>Device-Mapper’s “delay” target delays reads and&#x2F;or writes and maps them to different devices.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ sudo modprobe brd rd_nr=1 rd_size=1048576</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=4k</span><br><span class="line">ioengine=sync</span><br><span class="line">filename=/dev/ram0</span><br><span class="line">time_based=1</span><br><span class="line">runtime=10</span><br><span class="line"></span><br><span class="line">DDR 1333</span><br><span class="line">Jobs: 1 (f=1): [r(1)][100.0%][r=1471MiB/s,w=0KiB/s][r=377k,w=0 IOPS][eta 00m:00s]</span><br><span class="line">rw: (groupid=0, jobs=1): err= 0: pid=13487: Thu Jun  4 22:43:25 2020</span><br><span class="line">   read: IOPS=361k, BW=1411MiB/s (1480MB/s)(13.8GiB/10001msec)</span><br><span class="line">    clat (nsec): min=790, max=124854, avg=1563.39, stdev=935.07</span><br><span class="line">     lat (nsec): min=984, max=125042, avg=1757.85, stdev=978.84</span><br><span class="line">    clat percentiles (nsec):</span><br><span class="line">     |  1.00th=[ 1240],  5.00th=[ 1304], 10.00th=[ 1336], 20.00th=[ 1368],</span><br><span class="line">     | 30.00th=[ 1384], 40.00th=[ 1400], 50.00th=[ 1432], 60.00th=[ 1464],</span><br><span class="line">     | 70.00th=[ 1496], 80.00th=[ 1560], 90.00th=[ 1752], 95.00th=[ 2352],</span><br><span class="line">     | 99.00th=[ 3376], 99.50th=[ 4080], 99.90th=[14784], 99.95th=[24960],</span><br><span class="line">     | 99.99th=[31360]</span><br><span class="line">   bw (  MiB/s): min= 1004, max= 1476, per=99.79%, avg=1408.26, stdev=144.72, samples=19</span><br><span class="line">   iops        : min=257224, max=377934, avg=360514.11, stdev=37048.52, samples=19</span><br><span class="line">  lat (nsec)   : 1000=0.01%</span><br><span class="line">  lat (usec)   : 2=91.75%, 4=7.64%, 10=0.49%, 20=0.03%, 50=0.09%</span><br><span class="line">  lat (usec)   : 100=0.01%, 250=0.01%</span><br><span class="line">  cpu          : usr=27.40%, sys=72.48%, ctx=954, majf=0, minf=9</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwt: total=3613043,0,0, short=0,0,0, dropped=0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=1411MiB/s (1480MB/s), 1411MiB/s-1411MiB/s (1480MB/s-1480MB/s), io=13.8GiB (14.8GB), run=10001-10001msec</span><br><span class="line"></span><br><span class="line"># Create device delaying rw operation for 500ms</span><br><span class="line">$ echo &quot;0 $(blockdev --getsz /dev/ram0) delay /dev/ram0 0 500&quot; | dmsetup create delayed</span><br><span class="line">$ ls -l /dev/mapper/delayed</span><br><span class="line">lrwxrwxrwx 1 root root 7 6   4 22:47 /dev/mapper/delayed -&gt; ../dm-0</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">filename=/dev/dm-0</span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=4k</span><br><span class="line">ioengine=sync</span><br><span class="line">time_based=1</span><br><span class="line">runtime=10</span><br><span class="line"></span><br><span class="line">Starting 1 process</span><br><span class="line">Jobs: 1 (f=1): [r(1)][100.0%][r=8KiB/s,w=0KiB/s][r=2,w=0 IOPS][eta 00m:00s]</span><br><span class="line">random: (groupid=0, jobs=1): err= 0: pid=13873: Thu Jun  4 22:56:44 2020</span><br><span class="line">   read: IOPS=1, BW=8007B/s (8007B/s)(80.0KiB/10231msec)</span><br><span class="line">    clat (msec): min=503, max=516, avg=511.50, stdev= 2.97</span><br><span class="line">     lat (msec): min=503, max=516, avg=511.50, stdev= 2.97</span><br><span class="line">    clat percentiles (msec):</span><br><span class="line">     |  1.00th=[  506],  5.00th=[  506], 10.00th=[  510], 20.00th=[  510],</span><br><span class="line">     | 30.00th=[  514], 40.00th=[  514], 50.00th=[  514], 60.00th=[  514],</span><br><span class="line">     | 70.00th=[  514], 80.00th=[  514], 90.00th=[  514], 95.00th=[  518],</span><br><span class="line">     | 99.00th=[  518], 99.50th=[  518], 99.90th=[  518], 99.95th=[  518],</span><br><span class="line">     | 99.99th=[  518]</span><br><span class="line">   bw (  KiB/s): min=    8, max=    8, per=100.00%, avg= 8.00, stdev= 0.00, samples=19</span><br><span class="line">   iops        : min=    2, max=    2, avg= 2.00, stdev= 0.00, samples=19</span><br><span class="line">  lat (msec)   : 750=100.00%</span><br><span class="line">  cpu          : usr=0.00%, sys=0.02%, ctx=20, majf=0, minf=6</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwt: total=20,0,0, short=0,0,0, dropped=0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">   READ: bw=8007B/s (8007B/s), 8007B/s-8007B/s (8007B/s-8007B/s), io=80.0KiB (81.9kB), run=10231-10231msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm-0: ios=20/0, merge=0/0, ticks=9720/0, in_queue=10140, util=99.14%, aggrios=0/0, aggrmerge=0/0, aggrticks=0/0, aggrin_queue=0, aggrutil=0.00%</span><br><span class="line">  ram0: ios=0/0, merge=0/0, ticks=0/0, in_queue=0, util=0.00%</span><br><span class="line"></span><br><span class="line"># Create a block device that delays reads for 500 ms and writes for 300 ms</span><br><span class="line">size=$(blockdev --getsize /dev/ram0) # Size in 512-bytes sectors</span><br><span class="line">$ echo &quot;0 $(blockdev --getsize /dev/ram0) delay /dev/ram0 0 500 /dev/ram0 0 300&quot; | dmsetup create delayed</span><br><span class="line"></span><br><span class="line">$ dmsetup remove /dev/mapper/delayed</span><br></pre></td></tr></table></figure>
<h5 id="dm-linear"><a href="#dm-linear" class="headerlink" title="dm-linear"></a>dm-linear</h5><p>The dm-linear target maps a linear range of blocks of the device-mapper device onto a linear range of a backend device. dm-linear is the basic building block of logical volume managers such as LVM.</p>
<h4 id="dm-flakey"><a href="#dm-flakey" class="headerlink" title="dm-flakey"></a>dm-flakey</h4><p>This target is the same as the linear target except that it exhibits unreliable behaviour periodically.  It’s been found useful in simulating failing devices for testing purposes.</p>
<ul>
<li>drop_writes All write I&#x2F;Os are silently ignored and dropped. Read I&#x2F;Os are handled correctly.</li>
<li>error_writes All write I&#x2F;Os are failed with an error signaled. Read I&#x2F;Os are handled correctly.</li>
<li>corrupt_bio_byte During the down time, replace the Nth byte of the data of each read or write block I&#x2F;O with a specified value.<br>The default error mode is to fail all I&#x2F;O requests during the down time of the simulation cycle.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">tabled parameters:</span><br><span class="line">&lt;dev path&gt; &lt;offset&gt; &lt;up interval&gt; &lt;down interval&gt;  [&lt;num_features&gt; [&lt;feature arguments&gt;]]</span><br><span class="line">$ dmsetup create test --table &#x27;0 123 flakey /dev/sda1 0 4 8&#x27;</span><br><span class="line">$  file /dev/mapper/dm_test0</span><br><span class="line">/dev/mapper/dm_test0: symbolic link to ../dm-0</span><br><span class="line"></span><br><span class="line">[random]</span><br><span class="line">filename=/dev/dm-0</span><br><span class="line">#readwrite=randrw</span><br><span class="line">readwrite=randread</span><br><span class="line">blocksize=4k</span><br><span class="line">ioengine=sync</span><br><span class="line">time_based=1</span><br><span class="line">runtime=130</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fio-3.1</span><br><span class="line">Starting 1 process</span><br><span class="line">fio: io_u error on file /dev/dm-0: Input/output error: read offset=0, buflen=4096</span><br><span class="line">random: No I/O performed by sync, perhaps try --debug=io option for details?</span><br><span class="line">fio: pid=16261, err=5/file:io_u.c:1756, func=io_u error, error=Input/output error</span><br><span class="line"></span><br><span class="line">random: (groupid=0, jobs=1): err= 5 (file:io_u.c:1756, func=io_u error, error=Input/output error): pid=16261: Fri Jun  5 00:29:08 2020</span><br><span class="line">  cpu          : usr=0.00%, sys=0.00%, ctx=0, majf=0, minf=17</span><br><span class="line">  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=50.0%, 4=50.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwt: total=1,0,0, short=0,0,0, dropped=0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=1</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm-0: ios=0/0, merge=0/0, ticks=0/0, in_queue=0, util=0.00%, aggrios=0/0, aggrmerge=0/0, aggrticks=0/0, aggrin_queue=0, aggrutil=0.00%</span><br><span class="line">  sda: ios=0/0, merge=0/0, ticks=0/0, in_queue=0, util=0.00%</span><br><span class="line"></span><br><span class="line">[18800.528564] buffer_io_error: 110 callbacks suppressed</span><br><span class="line">[18800.528569] Buffer I/O error on dev dm-0, logical block 0, async page read</span><br><span class="line">[18800.528582] Buffer I/O error on dev dm-0, logical block 1, async page read</span><br><span class="line">[18800.528587] Buffer I/O error on dev dm-0, logical block 2, async page read</span><br><span class="line">[18800.528591] Buffer I/O error on dev dm-0, logical block 3, async page read</span><br><span class="line">[18800.528596] Buffer I/O error on dev dm-0, logical block 4, async page read</span><br><span class="line">[18800.528600] Buffer I/O error on dev dm-0, logical block 5, async page read</span><br><span class="line">[18800.528604] Buffer I/O error on dev dm-0, logical block 6, async page read</span><br><span class="line">[18800.528608] Buffer I/O error on dev dm-0, logical block 7, async page read</span><br></pre></td></tr></table></figure>
<p>$ dmsetup suspend &#x2F;dev&#x2F;dm-0<br>$ dmsetup resume &#x2F;dev&#x2F;dm-0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dm-linear  </span><br><span class="line">dm-zoned    </span><br><span class="line">[dm-dust](https://www.kernel.org/doc/Documentation/device-mapper/dm-dust.txt)     </span><br><span class="line"></span><br><span class="line">#### [dm-dust](https://blogs.oracle.com/linux/post/error-injection-using-dm-dust)</span><br></pre></td></tr></table></figure>
<p>$ blockdev –getsz &#x2F;dev&#x2F;sdb<br>33552384</p>
<p>$ dmsetup create dust1 –table ‘0 33552384 dust &#x2F;dev&#x2F;sdb 0 512’<br>$ lsblk<br> NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br> sdb       8:16   0  500M  0 disk<br>  dust1 252:0    0  500M  0 dm<br> sda       8:0    0 46.6G  0 disk<br>  sda2    8:2    0    8G  0 part [SWAP]<br>  sda3    8:3    0 38.4G  0 part &#x2F;<br>  sda1    8:1    0  200M  0 part &#x2F;boot&#x2F;efi</p>
<p>$ dmsetup status dust1<br>0 33552384 dust 252:17 bypass</p>
<p>$ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;mapper&#x2F;dust1 bs&#x3D;512 count&#x3D;128 oflag&#x3D;direct</p>
<p>128+0 records in<br>128+0 records out</p>
<p>$ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;mapper&#x2F;dust1 bs&#x3D;512 count&#x3D;128 oflag&#x3D;direct</p>
<p>128+0 records in<br>128+0 records out</p>
<p>$ dmsetup message dust1 0 addbadblock 90<br>$ dmsetup message dust1 0 addbadblock 80<br>$ dmsetup message dust1 0 addbadblock 55<br>$ dmsetup message dust1 0 addbadblock 75</p>
<p>O&#x2F;P in dmesg:<br>[89684.543718] device-mapper: dust: dust_add_block: badblock added at block 90<br>[89684.573391] device-mapper: dust: dust_add_block: badblock added at block 80<br>[89684.602177] device-mapper: dust: dust_add_block: badblock added at block 55<br>[89684.630031] device-mapper: dust: dust_add_block: badblock added at block 76</p>
<p>$ dmsetup message dust1 0 enable</p>
<p>O&#x2F;P in dmesg:<br>kernel: device-mapper: dust: enabling read failures on bad sectors</p>
<p>$ dd if&#x3D;&#x2F;dev&#x2F;mapper&#x2F;dust1 of&#x3D;&#x2F;dev&#x2F;null bs&#x3D;512 count&#x3D;100 iflag&#x3D;direct<br>dd: error reading ‘&#x2F;dev&#x2F;mapper&#x2F;dust1’: Input&#x2F;output error<br>55+0 records in<br>55+0 records out<br>28160 bytes (28 kB) copied, 0.0431255 s, 653 kB&#x2F;s</p>
<p>$ dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;mapper&#x2F;dust1 bs&#x3D;512 count&#x3D;100 oflag&#x3D;direct<br>100+0 records in<br>100+0 records out<br>51200 bytes (51 kB) copied, 0.403964 s, 127 kB&#x2F;s</p>
<p>O&#x2F;P dmesg:<br>[90251.095584] device-mapper: dust: block 55 removed from badblocklist by write<br>[90251.252730] device-mapper: dust: block 76 removed from badblocklist by write<br>[90251.303287] device-mapper: dust: block 80 removed from badblocklist by write<br>[90251.369163] device-mapper: dust: block 90 removed from badblocklist by write</p>
<p>$ dmsetup message dust1 0 removebadblock 90<br>$ dmsetup message dust1 0 removebadblock 80<br>$ dmsetup message dust1 0 removebadblock 55<br>$ dmsetup message dust1 0 removebadblock 76</p>
<p>O&#x2F;P dmesg:<br>  [154826.777999] device-mapper: dust: dust_remove_block: badblock removed at block 90<br>  [154835.161356] device-mapper: dust: dust_remove_block: badblock removed at block 80<br>  [154839.143604] device-mapper: dust: dust_remove_block: badblock removed at block 55<br>  [154844.424102] device-mapper: dust: dust_remove_block: badblock removed at block 76</p>
<p>$ dmsetup message dust1 0 countbadblocks<br>O&#x2F;P dmesg:<br> [155543.511012] device-mapper: dust: countbadblocks: 4 badblock(s) found</p>
<p>$ dmsetup message dust1 0 queryblock 90<br>$ dmsetup message dust1 0 queryblock 45</p>
<p>O&#x2F;P dmesg:<br> [155770.624834] device-mapper: dust: dust_query_block: block 90 found in badblocklist<br> [155776.975519] device-mapper: dust: dust_query_block: block 45 not found in badblocklist</p>
<p>$ dmsetup message dust1 0 clearbadblocks<br>O&#x2F;P dmesg:<br> [156008.800436] device-mapper: dust: dust_clear_badblocks: badblocks cleared</p>
<p>#Quiet mode<br>$ dmsetup message dust1 0 quiet<br>$ dmsetup status dust1</p>
<p>O&#x2F;P dmesg:<br> 0 1024000 dust 8:16 fail_read_on_bad_block quiet</p>
<h1 id="Switch-off-quiet-mode"><a href="#Switch-off-quiet-mode" class="headerlink" title="Switch off quiet mode"></a>Switch off quiet mode</h1><p>$ dmsetup message dust1 0 quiet<br>$ dmsetup status dust1<br> 0 1024000 dust 8:16 fail_read_on_bad_block verbose</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### [NPB 3.4](https://www.nas.nasa.gov/software/npb.html)</span><br><span class="line">[EPYC test NPB](https://documentation.suse.com/sbp/all/html/SBP-AMD-EPYC-3-SLES15SP2/index.html)</span><br><span class="line">kernel sched setting</span><br><span class="line">```bash</span><br><span class="line">Compiler	gcc (SUSE Linux Enterprise) 10.2.1</span><br><span class="line">OpenMPI	openmpi2-2.1.6-10.19.x86_64</span><br><span class="line">Default compiler flags	-m64 -O3 -mcmodel=large</span><br><span class="line">Default number processes	256</span><br><span class="line">Selective number processes	bt=256 sp=256 mg=32 lu=121 ep=256 cg=32</span><br><span class="line">Fortran compiler flags	-fallow-argument-mismatch -fallow-invalid-boz</span><br><span class="line">Tuned compiler flags	-Ofast -march=znver2 -mtune=znver2 -ftree-vectorize</span><br><span class="line">CPU governor performance	cpupower frequency-set -g performance</span><br><span class="line">Scheduler parameters	sysctl -w kernel.sched_migration_cost_ns=5000000</span><br><span class="line">                   	sysctl -w kernel.sched_min_granularity_ns=10000000</span><br><span class="line">mpirun parameters	-mca btl ^openib,udapl -np 64 --bind-to l3cache:overload-allowed</span><br><span class="line">mpirun environment	TMPDIR=/xfs-data-partition</span><br><span class="line"></span><br><span class="line">default_hugepagesz=1GB hugepagesz=1GB hugepages=&lt;number of hugepages&gt;</span><br><span class="line">The value &lt;number of hugepages&gt; can be computed by taking the amount of memory we want to devoted to VMs, and dividing it by the page size (1 GB). For example on our host with 256 GB of RAM, creating 200 Huge Pages means we can accommodate up to 210 GB of VMs&#x27; RAM, and leave plenty (~50GB) to the host OS.</span><br><span class="line"></span><br><span class="line">On KVM, NUMAB can be useful in dynamic virtualization scenarios, where VMs are created, destroyed and re-created relatively quickly. Or, in general, it can be useful in cases where it is not possible or desirable to statically partition the host resources and assign them explicitly to VMs. This, however, comes at the price of some latency being introduced. Plus, NUMAB&#x27;s own operation can interfere with VMs&#x27; execution and cause further performance degradation. In any case, this document focuses on achieving the best possible performance for VMs, through specific tuning and static resource allocation, therefore it is recommended to leave NUMAB turned off. This can be done by adding the following parameter to the host kernel command line:</span><br><span class="line"></span><br><span class="line">$ echo 0 &gt; /proc/sys/kernel/numa_balancing</span><br><span class="line"></span><br><span class="line">Secure Encrypted Virtualization (SEV)</span><br><span class="line">grub set mem_encrypt=on kvm_amd.sev=1</span><br><span class="line"></span><br><span class="line"># KVM</span><br><span class="line">the VM has a vCPU topology:</span><br><span class="line">&lt;cpu mode=&#x27;custom&#x27; match=&#x27;exact&#x27; check=&#x27;none&#x27;&gt;</span><br><span class="line">  &lt;model fallback=&#x27;allow&#x27;&gt;EPYC&lt;/model&gt;</span><br><span class="line">  &lt;topology sockets=&#x27;2&#x27; cores=&#x27;64&#x27; threads=&#x27;2&#x27;/&gt;</span><br><span class="line">  &lt;numa&gt;</span><br><span class="line">    &lt;cell id=&#x27;0&#x27; cpus=&#x27;0-127&#x27; memory=&#x27;104857600&#x27; unit=&#x27;KiB&#x27;&gt;</span><br><span class="line">      &lt;distances&gt;</span><br><span class="line">        &lt;sibling id=&#x27;0&#x27; value=&#x27;10&#x27;/&gt;</span><br><span class="line">        &lt;sibling id=&#x27;1&#x27; value=&#x27;32&#x27;/&gt;</span><br><span class="line">      &lt;/distances&gt;</span><br><span class="line">    &lt;/cell&gt;</span><br><span class="line">    &lt;cell id=&#x27;1&#x27; cpus=&#x27;128-255&#x27; memory=&#x27;104857600&#x27; unit=&#x27;KiB&#x27;&gt;</span><br><span class="line">      &lt;distances&gt;</span><br><span class="line">        &lt;sibling id=&#x27;0&#x27; value=&#x27;32&#x27;/&gt;</span><br><span class="line">        &lt;sibling id=&#x27;1&#x27; value=&#x27;10&#x27;/&gt;</span><br><span class="line">      &lt;/distances&gt;</span><br><span class="line">    &lt;/cell&gt;</span><br><span class="line">   &lt;/numa&gt;</span><br><span class="line">&lt;/cpu&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$ yum install centos-release-scl-rh</span><br><span class="line">$ yum install devtoolset-9-toolchain</span><br><span class="line"></span><br><span class="line">$ scl <span class="built_in">enable</span> devtoolset-9 bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#el8 </span></span><br><span class="line">$ dnf install gcc-toolset-11.x86_64</span><br><span class="line">$ scl <span class="built_in">enable</span> gcc-toolset-11 bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#el9 </span></span><br><span class="line">$ dnf install gcc-toolset-12.x86_64</span><br><span class="line">$ scl <span class="built_in">enable</span> gcc-toolset-12 bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ vi config/make.def <span class="comment"># add -mcmodel=large</span></span><br><span class="line">FFLAGS	= -O3 -fopenmp -mcmodel=large</span><br><span class="line">CFLAGS	= -O3 -fopenmp -mcmodel=large</span><br><span class="line"></span><br><span class="line">$ vi config/suite.def</span><br><span class="line"><span class="comment"># config/suite.def</span></span><br><span class="line"><span class="comment"># This file is used to build several benchmarks with a single command.</span></span><br><span class="line"><span class="comment"># Typing &quot;make suite&quot; in the main directory will build all the benchmarks</span></span><br><span class="line"><span class="comment"># specified in this file.</span></span><br><span class="line"><span class="comment"># Each line of this file contains a benchmark name and the class.</span></span><br><span class="line"><span class="comment"># The name is one of &quot;cg&quot;, &quot;is&quot;, &quot;ep&quot;, mg&quot;, &quot;ft&quot;, &quot;sp&quot;,</span></span><br><span class="line"><span class="comment">#  &quot;bt&quot;, &quot;lu&quot;, and &quot;ua&quot;.</span></span><br><span class="line"><span class="comment"># The class is one of &quot;S&quot;, &quot;W&quot;, &quot;A&quot; through &quot;E&quot;</span></span><br><span class="line"><span class="comment"># (except that no class E for IS and UA).</span></span><br><span class="line"><span class="comment"># No blank lines.</span></span><br><span class="line"><span class="comment"># The following example builds sample sizes of all benchmarks.</span></span><br><span class="line"><span class="comment">## Unstructured Adaptive mesh, dynamic and irregular memory access</span></span><br><span class="line">ua      E</span><br><span class="line"></span><br><span class="line"><span class="comment">## Conjugate Gradient, irregular memory access and communication</span></span><br><span class="line">cg      E</span><br><span class="line"></span><br><span class="line"><span class="comment">## random memory, Integer Sort</span></span><br><span class="line">is      E</span><br><span class="line"></span><br><span class="line"><span class="comment">## Embarrassingly Parallel</span></span><br><span class="line">ep      E</span><br><span class="line"></span><br><span class="line"><span class="comment">#Multi-Grid on a sequence of meshes, long- and short-distance communication, memory intensive</span></span><br><span class="line">mg      E</span><br><span class="line"></span><br><span class="line"><span class="comment">#Block Tri-diagonal solver</span></span><br><span class="line">bt      E</span><br><span class="line"></span><br><span class="line"><span class="comment">#Data Cube</span></span><br><span class="line">dc      E</span><br><span class="line"></span><br><span class="line"><span class="comment">#Scalar Penta-diagonal solver</span></span><br><span class="line">sp      E</span><br><span class="line"></span><br><span class="line"><span class="comment">#discrete 3D fast Fourier Transform, all-to-all communication</span></span><br><span class="line">ft      E</span><br><span class="line"></span><br><span class="line"><span class="comment">#Lower-Upper Gauss-Seidel solver</span></span><br><span class="line">lu      E</span><br><span class="line"></span><br><span class="line">$ make suite</span><br></pre></td></tr></table></figure>

<h3 id="MPI-test"><a href="#MPI-test" class="headerlink" title="MPI test"></a>MPI test</h3><p>disable selinux  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/lib/el7/src/automake-1.15</span><br><span class="line">./configure --prefix=/opt/lib/el7/automake-1.15; make -j 8 ;make install</span><br><span class="line"><span class="built_in">export</span> PATH=/opt/lib/el7/automake-1.15/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> ACLOCAL_PATH=<span class="string">&quot;/opt/lib/el7/automake-1.15/share/aclocal&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /opt/lib/el7/src/libtool-2.4.4</span><br><span class="line">./configure --prefix=/opt/lib/el7/libtool-2.4.6; make -j 8 ;make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/lib/el7/mpich-3.2.1/bin:/opt/lib/el7/automake-1.15/bin:/opt/lib/el7/libtool-2.4.6/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/opt/lib/el7/libtool-2.4.6/lib:/opt/lib/el7/mpich-3.2.1/lib::<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> C_INCLUDE_PATH=/opt/lib/el7/libtool-2.4.6/include:/opt/lib/el7/mpich-3.2.1/include/:<span class="variable">$C_INCLUDE_PATH</span></span><br><span class="line"></span><br><span class="line">yum install wget -y</span><br><span class="line"><span class="built_in">mkdir</span> src;<span class="built_in">cd</span> src</span><br><span class="line">wget http://www.mpich.org/static/downloads/3.2.1/mpich-3.2.1.tar.gz</span><br><span class="line">yum install gcc gcc-c++ gcc-fortran kernel-devel -y</span><br><span class="line">tar -xvf mpich-3.2.1.tar.gz</span><br><span class="line">./configure --prefix=/opt/lib/el7/mpich-3.2.1 --enable-debug --enable-debug-symbols ; make -j 8; make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/lib/el8/mpich-4.1.0/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/opt/lib/el8/mpich-4.1.0/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> C_INCLUDE_PATH=/opt/lib/el8/mpich-4.1.0/include/:~/uarch/avx-turbo:/local/nvme/libpfc/include:~/uarch/uarch-bench/pmu-tools/jevents/examples:<span class="variable">$C_INCLUDE_PATH</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> mpi_hosts</span><br><span class="line">10.xx.xx.1 server-1 <span class="comment">## mpirun ior xxxxx</span></span><br><span class="line">10.xx.xx.2 server-2 <span class="comment">## ior running</span></span><br><span class="line">10.xx.xx.3 server-3 <span class="comment">## ior running</span></span><br><span class="line">10.xx.xx.4 server-4 <span class="comment">## ior running</span></span><br><span class="line"></span><br><span class="line">10.xx.xx.1 $ mpirun -f mpi_hosts -n 8 <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"><span class="comment"># export the env from mpirun nodes</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/lib64/openmpi/bin/:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"></span><br><span class="line">$ mpirun --allow-run-as-root -np 8 --hostfile test_hosts hostname </span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line">test-server-123</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="IOR"><a href="#IOR" class="headerlink" title="IOR"></a>IOR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">$ dnf install libatomic glibc glibc-devel glibc-gconv-extra</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/LLNL/ior.git</span><br><span class="line"><span class="built_in">cd</span> ior</span><br><span class="line">module load mpi/openmpi-x86_64 (failed)</span><br><span class="line">./bootstrap</span><br><span class="line">./configure --prefix=/opt/lib/el7/ior-3.2.1 --with-lustre &amp;&amp; make clean &amp;&amp; make</span><br><span class="line"></span><br><span class="line">./src/ior</span><br><span class="line">IOR-3.0.1: MPI Coordinated Test of Parallel I/O</span><br><span class="line"></span><br><span class="line">Began: Mon Apr  9 04:03:16 2018</span><br><span class="line">Command line used: src/ior</span><br><span class="line">Machine: Linux bgi-sz1-homerl-test73</span><br><span class="line"></span><br><span class="line">Test 0 started: Mon Apr  9 04:03:16 2018</span><br><span class="line">Summary:</span><br><span class="line">        api                = POSIX</span><br><span class="line">        <span class="built_in">test</span> filename      = testFile</span><br><span class="line">        access             = single-shared-file</span><br><span class="line">        ordering <span class="keyword">in</span> a file = sequential offsets</span><br><span class="line">        ordering inter file= no tasks offsets</span><br><span class="line">        clients            = 1 (1 per node)</span><br><span class="line">        repetitions        = 1</span><br><span class="line">        xfersize           = 262144 bytes</span><br><span class="line">        blocksize          = 1 MiB</span><br><span class="line">        aggregate filesize = 1 MiB</span><br><span class="line"></span><br><span class="line">access    bw(MiB/s)  block(KiB) xfer(KiB)  open(s)    wr/rd(s)   close(s)   total(s)   iter</span><br><span class="line">------    ---------  ---------- ---------  --------   --------   --------   --------   ----</span><br><span class="line">write     1621.30    1024.00    256.00     0.000077   0.000537   0.000003   0.000617   0</span><br><span class="line"><span class="built_in">read</span>      4810       1024.00    256.00     0.000003   0.000204   0.000001   0.000208   0</span><br><span class="line">remove    -          -          -          -          -          -          0.000099   0</span><br><span class="line"></span><br><span class="line">Max Write: 1621.30 MiB/sec (1700.06 MB/sec)</span><br><span class="line">Max Read:  4809.98 MiB/sec (5043.63 MB/sec)</span><br><span class="line"></span><br><span class="line">Summary of all tests:</span><br><span class="line">Operation   Max(MiB)   Min(MiB)  Mean(MiB)     StdDev    Mean(s) Test<span class="comment"># #Tasks tPN reps fPP reord reordoff reordrand seed segcnt blksiz xsize aggsize API RefNum</span></span><br><span class="line">write        1621.30    1621.30    1621.30       0.00    0.00062 0 1 1 1 0 0 1 0 0 1 1048576 262144 1048576 POSIX 0</span><br><span class="line"><span class="built_in">read</span>         4809.98    4809.98    4809.98       0.00    0.00021 0 1 1 1 0 0 1 0 0 1 1048576 262144 1048576 POSIX 0</span><br><span class="line"></span><br><span class="line">Finished: Mon Apr  9 04:03:16 2018</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys=57</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;56,48,24,8&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">filesize=$((sys/i))</span><br><span class="line">[[ <span class="variable">$xfersize</span> -eq 0 ]] &amp;&amp; filesize=1</span><br><span class="line">mpich-3.2.1/bin/mpirun -f mpi2_hosts ior/src/ior -v -a POSIX -N <span class="variable">$i</span> -i1 -g -w -W -r -s <span class="variable">$i</span> -b <span class="variable">$&#123;filesize&#125;</span>g -T 1200 -F -l o -t 1m -o <span class="variable">$iorpath</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">mpirun -f mpi_hosts  /src/ior -v -a MPIIO -N 8 -i3 -g -w -W -r -s 5 -b 10g -T 100 -F -l -C -t 1m -o /lustre/test/testFile1</span><br><span class="line">IOR-3.0.1: MPI Coordinated Test of Parallel I/O</span><br><span class="line"></span><br><span class="line">Began: Mon Apr  9 21:31:07 2018</span><br><span class="line">Command line used: /src/ior -v -a MPIIO -N 8 -i3 -g -w -W -r -s 5 -b 20g -T 3600 -F -l -C -t 1m -o /lustre/test/testFile1</span><br><span class="line">Machine: Linux cngb-rbh-m20-1</span><br><span class="line">Start time skew across all tasks: 32.29 sec</span><br><span class="line"></span><br><span class="line">Test 0 started: Mon Apr  9 21:31:07 2018</span><br><span class="line">Path: /lustre/test</span><br><span class="line">FS: 972.2 TiB   Used FS: 26.7%   Inodes: 113.9 Mi   Used Inodes: 25.8%</span><br><span class="line">Participating tasks: 8</span><br><span class="line">Using reorderTasks <span class="string">&#x27;-C&#x27;</span> (expecting block, not cyclic, task assignment)</span><br><span class="line">Summary:</span><br><span class="line">        api                = MPIIO (version=3, subversion=1)</span><br><span class="line">        <span class="built_in">test</span> filename      = /lustre/test/testFile1</span><br><span class="line">        access             = file-per-process, independent</span><br><span class="line">        pattern            = strided (5 segments)</span><br><span class="line">        ordering <span class="keyword">in</span> a file = sequential offsets</span><br><span class="line">        ordering inter file= constant task offsets = 1</span><br><span class="line">        clients            = 8 (4 per node)</span><br><span class="line">        repetitions        = 3</span><br><span class="line">        xfersize           = 1 MiB</span><br><span class="line">        blocksize          = 20 GiB</span><br><span class="line">        aggregate filesize = 800 GiB</span><br><span class="line"></span><br><span class="line">access    bw(MiB/s)  block(KiB) xfer(KiB)  open(s)    wr/rd(s)   close(s)   total(s)   iter</span><br><span class="line">------    ---------  ---------- ---------  --------   --------   --------   --------   ----</span><br><span class="line">write     2801.92    20971520   1024.00    0.050119   292.31     0.006433   292.37     0</span><br><span class="line">Verifying contents of the file(s) just written.</span><br><span class="line">Mon Apr  9 21:36:00 2018</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span>      1410.24    20971520   1024.00    0.020212   580.86     0.037729   580.89     0</span><br><span class="line">remove    -          -          -          -          -          -          0.060562   0</span><br><span class="line">write     2499.73    20971520   1024.00    0.042546   327.65     0.056297   327.72     1</span><br><span class="line">Verifying contents of the file(s) just written.</span><br><span class="line">Mon Apr  9 22:01:19 2018</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span>      1290.26    20971520   1024.00    0.049267   634.89     0.065045   634.91     1</span><br><span class="line">remove    -          -          -          -          -          -          0.037253   1</span><br><span class="line">write     2788.98    20971520   1024.00    0.067497   293.71     0.070010   293.73     2</span><br><span class="line">Verifying contents of the file(s) just written.</span><br><span class="line">Mon Apr  9 22:27:01 2018</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span>      1455.20    20971520   1024.00    0.096816   562.92     0.087327   562.95     2</span><br><span class="line">remove    -          -          -          -          -          -          0.003740   2</span><br><span class="line"></span><br><span class="line">Max Write: 2801.92 MiB/sec (2938.03 MB/sec)</span><br><span class="line">Max Read:  1455.20 MiB/sec (1525.89 MB/sec)</span><br><span class="line"></span><br><span class="line">Summary of all tests:</span><br><span class="line">Operation   Max(MiB)   Min(MiB)  Mean(MiB)     StdDev    Mean(s) Test<span class="comment"># #Tasks tPN reps fPP reord reordoff reordrand seed segcnt blksiz xsize aggsize API RefNum</span></span><br><span class="line">write        2801.92    2499.73    2696.88     139.50  304.60461 0 8 4 3 1 1 1 0 0 5 21474836480 1048576 858993459200 MPIIO 0</span><br><span class="line"><span class="built_in">read</span>         1455.20    1290.26    1385.23      69.62  592.91649 0 8 4 3 1 1 1 0 0 5 21474836480 1048576 858993459200 MPIIO 0</span><br><span class="line"></span><br><span class="line">Finished: Mon Apr  9 22:45:55 2018</span><br></pre></td></tr></table></figure>

<h4 id="MDTEST"><a href="#MDTEST" class="headerlink" title="MDTEST"></a>MDTEST</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##N x nodes to 1 file</span></span><br><span class="line">$ mpirun -f mpi_hosts  /ior/src/mdtest -a MPIIO –S -C -T -r -n 1 -F -d /lustre/test</span><br><span class="line"></span><br><span class="line">$ mpirun -f mpi_hosts /ior/src/mdtest -a POSIX -E -F -C -T -r -I 10 -L -b 10 -z 4 -N 96 -d /test/96</span><br><span class="line">Path: /test/96</span><br><span class="line">FS: 1141.4 TiB   Used FS: 0.0%   Inodes: 281.6 Mi   Used Inodes: 0.0%</span><br><span class="line"></span><br><span class="line">96 tasks, 10666560 files</span><br><span class="line"></span><br><span class="line">SUMMARY: (of 1 iterations)</span><br><span class="line">   Operation                      Max            Min           Mean        Std Dev</span><br><span class="line">   ---------                      ---            ---           ----        -------</span><br><span class="line">   File creation     :      35479.737      35479.737      35479.737          0.000</span><br><span class="line">   File <span class="built_in">stat</span>         :      78316.725      78316.725      78316.725          0.000</span><br><span class="line">   File <span class="built_in">read</span>         :      53341.961      53341.961      53341.961          0.000</span><br><span class="line">   File removal      :      31167.502      31167.502      31167.502          0.000</span><br><span class="line">   Tree creation     :       3778.503       3778.503       3778.503          0.000</span><br><span class="line">   Tree removal      :       2295.413       2295.413       2295.413          0.000</span><br><span class="line"></span><br><span class="line">-- finished at 09/10/2019 14:23:06 --</span><br><span class="line"></span><br><span class="line">$ mpich-3.2.1/bin/mpirun -f mpi_hosts -np 16 ior-3.2.1/src/mdtest -a POSIX -E -F -C -T -r -I 10 -L -b 10 -z 4 -d /TESTH400/mdtest/16</span><br><span class="line"></span><br><span class="line"><span class="comment">#hard</span></span><br><span class="line">$ mpich-3.2.1/bin/mpirun -f mpi_hosts -np 16 ior-3.2.1/src/mdtest -a POSIX -t -E -F -C -T -r --random-seed=1024 -w 60327 -e 60327 -n 160000 -d /TESTH400/mdtest/16</span><br><span class="line"></span><br><span class="line"><span class="comment">#el7 issue</span></span><br><span class="line">Note: There is currently a bug <span class="keyword">in</span> some versions of the libfabric library, notably version 1.3.0, that can cause a delay <span class="keyword">in</span> starting MPI applications. When this occurs the following warning will appear <span class="keyword">in</span> the <span class="built_in">command</span> output:</span><br><span class="line">hfi_wait_for_device: The /dev/hfi1_0 device failed to appear after 15.0 seconds: Connection timed out</span><br><span class="line">This issue affects RHEL and CentOS 7.3, and is resolved <span class="keyword">in</span> RHEL / CentOS 7.4+ and the upstream project. Details can be found here:</span><br><span class="line">https://bugzilla.redhat.com/show_bug.cgi?<span class="built_in">id</span>=1408316</span><br></pre></td></tr></table></figure>

<h4 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#89.9% memory usage</span></span><br><span class="line">mem=$(awk <span class="string">&#x27;$0~/MemTotal/ &#123;printf &quot;%d\n&quot;, $(NF-1)/1024/1024/10*9*44599177&#125;&#x27;</span> /proc/meminfo)</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;BASEPATH&#125;</span></span><br><span class="line">tar xjvf  stream.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> stream</span><br><span class="line"><span class="built_in">cat</span> stream.c_bak &gt; stream.c</span><br><span class="line">sed -i <span class="string">&quot;s/524335808/<span class="variable">$&#123;mem&#125;</span>/&quot;</span> stream.c</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;run STREAM...&quot;</span></span><br><span class="line">make &gt; /dev/zero;</span><br><span class="line">bin/stream &gt; <span class="variable">$&#123;CPULOG&#125;</span>/stream.log 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">gcc -O3 -fopenmp stream.c -DSTREAM_ARRAY_SIZE=100000000 -DNTIMES=100 -o stream_om.100M.O3</span><br><span class="line"><span class="built_in">export</span> OMP_NUM_THREADS=32</span><br></pre></td></tr></table></figure>

<h4 id="HPL-linpack"><a href="#HPL-linpack" class="headerlink" title="HPL linpack"></a>HPL linpack</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#the compute node</span></span><br><span class="line">$ wget http://www.netlib.org/benchmark/hpl/hpl-2.3.tar.gz</span><br><span class="line">$ tar zxf hpl-2.3.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> hpl-2.3/</span><br><span class="line">$ ./configure --prefix=/test/hpl-2.3</span><br><span class="line">$ make -j 8</span><br><span class="line">$ make install</span><br><span class="line">$ <span class="built_in">ls</span> -l ~/HPL.dat <span class="comment">## put the config file in the home dir</span></span><br><span class="line">$ ./hpldatgen.py -n 2 -c 6 -m 50000 -o ~/HPL.dat</span><br><span class="line"></span><br><span class="line"><span class="comment">#the manage node, not compute</span></span><br><span class="line">$ <span class="built_in">cat</span> hpl.sh</span><br><span class="line"><span class="built_in">export</span> PATH=/opt/mpich-3.2.1/bin:/opt/automake-1.15/bin:/opt/libtool-2.4.4/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/opt/mpich-3.2.1/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> C_INCLUDE_PATH=/opt/mpich-3.2.1/include/:<span class="variable">$C_INCLUDE_PATH</span></span><br><span class="line">/opt/mpich-3.2.1/bin/mpirun -f mpi_hosts -np 24 /opt/hpl-2.3/bin/xhpl</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">HPLinpack 2.3  --  High-Performance Linpack benchmark  --   December 2, 2018</span><br><span class="line">Written by A. Petitet and R. Clint Whaley,  Innovative Computing Laboratory, UTK</span><br><span class="line">Modified by Piotr Luszczek, Innovative Computing Laboratory, UTK</span><br><span class="line">Modified by Julien Langou, University of Colorado Denver</span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">An explanation of the input/output parameters follows:</span><br><span class="line">T/V    : Wall time / encoded variant.</span><br><span class="line">N      : The order of the coefficient matrix A.</span><br><span class="line">NB     : The partitioning blocking <span class="built_in">factor</span>.</span><br><span class="line">P      : The number of process rows.</span><br><span class="line">Q      : The number of process columns.</span><br><span class="line">Time   : Time <span class="keyword">in</span> seconds to solve the linear system.</span><br><span class="line">Gflops : Rate of execution <span class="keyword">for</span> solving the linear system.</span><br><span class="line"></span><br><span class="line">The following parameter values will be used:</span><br><span class="line"></span><br><span class="line">N      :   93696</span><br><span class="line">NB     :     384</span><br><span class="line">PMAP   : Row-major process mapping</span><br><span class="line">P      :       4</span><br><span class="line">Q      :       3</span><br><span class="line">PFACT  :   Right</span><br><span class="line">NBMIN  :       4</span><br><span class="line">NDIV   :       2</span><br><span class="line">RFACT  :   Crout</span><br><span class="line">BCAST  :  1ringM</span><br><span class="line">DEPTH  :       1</span><br><span class="line">SWAP   : Mix (threshold = 64)</span><br><span class="line"></span><br><span class="line">L1     : transposed form</span><br><span class="line">U      : transposed form</span><br><span class="line">EQUIL  : <span class="built_in">yes</span></span><br><span class="line">ALIGN  : 8 double precision words</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">- The matrix A is randomly generated <span class="keyword">for</span> each <span class="built_in">test</span>.</span><br><span class="line">- The following scaled residual check will be computed:</span><br><span class="line">      ||Ax-b||_oo / ( eps * ( || x ||_oo * || A ||_oo + || b ||_oo ) * N )</span><br><span class="line">- The relative machine precision (eps) is taken to be               1.110223e-16</span><br><span class="line">- Computational tests pass <span class="keyword">if</span> scaled residuals are less than                16.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> mpi_hosts</span><br><span class="line">192.168.10.23:24</span><br><span class="line"></span><br><span class="line">https://github.com/prehensilecode/hpldatgen/blob/main/hpldatgen.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">import math</span><br><span class="line">import argparse</span><br><span class="line">from pathlib import Path</span><br><span class="line"></span><br><span class="line">debug_p = False</span><br><span class="line"></span><br><span class="line">def getBaseN(nodes, mpn):</span><br><span class="line">    <span class="comment"># from experimenting, 1300000 (i.e. 0.67) will not result in OOM</span></span><br><span class="line">    <span class="built_in">return</span> int(math.sqrt((((mpn * <span class="number">0.67</span>) * nodes) * <span class="number">1024</span> * <span class="number">1024</span>) / <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getNFromNb(baseN, nb):</span><br><span class="line">    <span class="built_in">factor</span> = int(baseN/nb)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">factor</span> % 2) != 0:</span><br><span class="line">        <span class="built_in">factor</span> -= 1</span><br><span class="line">    <span class="built_in">return</span> int(nb * <span class="built_in">factor</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getGrid(nodes, ppn):</span><br><span class="line">    cores = nodes * ppn</span><br><span class="line">    sqrt_cores = int(math.sqrt(cores))</span><br><span class="line">    factors = []</span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> range(2, sqrt_cores+1):</span><br><span class="line">        <span class="keyword">if</span> (cores % num) == 0:</span><br><span class="line">            factors.append(num)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(factors) == 0:</span><br><span class="line">        factors.append(1)</span><br><span class="line"></span><br><span class="line">    diff = 0</span><br><span class="line">    keep = 0</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> factors:</span><br><span class="line">        <span class="keyword">if</span> diff == 0:</span><br><span class="line">            diff = cores - f</span><br><span class="line">        <span class="keyword">if</span> keep == 0:</span><br><span class="line">            keep = f</span><br><span class="line">        tmpDiff = cores - f</span><br><span class="line">        <span class="keyword">if</span> tmpDiff &lt; diff:</span><br><span class="line">            diff = tmpDiff</span><br><span class="line">            keep = f</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> (keep, int(cores/keep))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def calchpl(nodes=1, cpn=48, mpn=192000, nb=384, outfile=<span class="string">&#x27;HPL.dat&#x27;</span>):</span><br><span class="line">    global debug_p</span><br><span class="line"></span><br><span class="line">    baseN = getBaseN(nodes, mpn)</span><br><span class="line">    realN = getNFromNb(baseN, nb)</span><br><span class="line">    pQ = getGrid(nodes, cpn)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug_p:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;DEBUG&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;baseN = &#123;&#125;&#x27;</span>.format(baseN))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;realN = &#123;&#125;&#x27;</span>.format(realN))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;pQ = &#123;&#125;&#x27;</span>.format(pQ))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;nb = &#123;&#125;&#x27;</span>.format(nb))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;outfile = &#123;&#125;&#x27;</span>.format(outfile))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># from experimenting, best performance when Q is set to cores-per-node</span></span><br><span class="line">    contents = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;HPLinpack benchmark input file\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;Innovative Computing Laboratory, University of Tennessee\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;HPL.out      output file name (if any) \n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;6            device out (6=stdout,7=stderr,file)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of problems sizes (N)\n&#x27;</span></span><br><span class="line">    contents += str(realN) + <span class="string">&#x27;         Ns\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of NBs\n&#x27;</span></span><br><span class="line">    contents += str(nb) + <span class="string">&#x27;           NBs\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;0            PMAP process mapping (0=Row-,1=Column-major)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of process grids (P x Q)\n&#x27;</span></span><br><span class="line">    contents += str(pQ[1]) + <span class="string">&#x27;            Ps\n&#x27;</span></span><br><span class="line">    contents += str(pQ[0]) + <span class="string">&#x27;            Qs\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;16.0         threshold\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of panel fact\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;2            PFACTs (0=left, 1=Crout, 2=Right)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of recursive stopping criterium\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;4            NBMINs (&gt;= 1)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of panels in recursion\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;2            NDIVs\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of recursive panel fact.\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            RFACTs (0=left, 1=Crout, 2=Right)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of broadcast\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            # of lookahead depth\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            DEPTHs (&gt;=0)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;2            SWAP (0=bin-exch,1=long,2=mix)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;64           swapping threshold\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;0            L1 in (0=transposed,1=no-transposed) form\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;0            U  in (0=transposed,1=no-transposed) form\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1            Equilibration (0=no,1=yes)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;8            memory alignment in double (&gt; 0)\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;##### This line (no. 32) is ignored (it serves as a separator). ######\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;0                               Number of additional problem sizes for PTRANS\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;1200 10000 30000                values of N\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;0                               number of additional blocking sizes for PTRANS\n&#x27;</span></span><br><span class="line">    contents += <span class="string">&#x27;40 9 8 13 13 20 16 32 64        values of NB\n&#x27;</span></span><br><span class="line"></span><br><span class="line">    cnt = 2</span><br><span class="line">    <span class="keyword">while</span> Path(outfile).is_file():</span><br><span class="line">        lastoutfile = outfile</span><br><span class="line">        outfile = <span class="string">&#x27;HPL.dat.&#123;&#125;&#x27;</span>.format(cnt)</span><br><span class="line">        cnt += 1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cnt &gt; 2:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; file already exists. Writing to &#123;&#125; instead.&#x27;</span>.format(lastoutfile, outfile))</span><br><span class="line"></span><br><span class="line">    with open(outfile, <span class="string">&#x27;w&#x27;</span>) as f:</span><br><span class="line">        f.write(contents)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--debug&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Debugging output&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-n&#x27;</span>, <span class="string">&#x27;--nodes&#x27;</span>, <span class="built_in">type</span>=int, default=1, <span class="built_in">help</span>=<span class="string">&#x27;Number of nodes; default 1&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--cores-per-node&#x27;</span>, <span class="built_in">type</span>=int, default=48, <span class="built_in">help</span>=<span class="string">&#x27;Number of cores per node; default 48&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-m&#x27;</span>, <span class="string">&#x27;--memory-per-node&#x27;</span>, <span class="built_in">type</span>=int, default=192000, <span class="built_in">help</span>=<span class="string">&#x27;Memory per node in MB; default 192000&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-b&#x27;</span>, <span class="string">&#x27;--block-size&#x27;</span>, <span class="built_in">type</span>=int, default=384, <span class="built_in">help</span>=<span class="string">&#x27;Block size (NB); default 384&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output-file&#x27;</span>, default=<span class="string">&#x27;HPL.dat&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Output file name; default &quot;HPL.dat&quot;&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    debug_p = args.debug</span><br><span class="line"></span><br><span class="line">    calchpl(args.nodes, args.cores_per_node, args.memory_per_node, args.block_size, args.output_file)</span><br></pre></td></tr></table></figure>

<h4 id="IO500"><a href="#IO500" class="headerlink" title="IO500"></a>IO500</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/VI4IO/io500-app</span><br><span class="line">$ <span class="built_in">cd</span> io500-app</span><br><span class="line">$ <span class="built_in">cd</span> io500-app/build</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/hpc/ior.git ior</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/VI4IO/pfind.git</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/VI4IO/io-500-dev io500-dev</span><br><span class="line">$ <span class="built_in">cd</span> -</span><br><span class="line">$ <span class="built_in">cd</span> io500-app</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/JulianKunkel/md-real-io build/io500-dev/site-configs/sandia/old/</span><br><span class="line">$ <span class="built_in">cd</span> io500-app/build/pfind</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/lz4/lz4.git</span><br><span class="line">$ ./prepare.sh</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> config-minimal.ini</span><br><span class="line">[global]</span><br><span class="line">datadir = /lustre/test</span><br><span class="line"></span><br><span class="line">$ mpich-3.2.1/bin/mpirun -f mpi_hosts io500-app/io500 io500-app/config-minimal.ini</span><br></pre></td></tr></table></figure>

<h4 id="Microsoft-virtual-client"><a href="#Microsoft-virtual-client" class="headerlink" title="Microsoft virtual client"></a><a target="_blank" rel="noopener" href="https://microsoft.github.io/VirtualClient/docs/category/workloads/">Microsoft virtual client</a></h4><p><a target="_blank" rel="noopener" href="https://microsoft.github.io/VirtualClient/docs/category/monitors/">monitor</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">AspNetBenchmark</span><br><span class="line">Compression</span><br><span class="line">CoreMark</span><br><span class="line">DeathStarBench</span><br><span class="line">DiskSpd</span><br><span class="line">Flexible IO Tester (FIO)</span><br><span class="line">GeekBench5</span><br><span class="line">Graph500</span><br><span class="line">HPCG</span><br><span class="line">LAPACK</span><br><span class="line">LMbench</span><br><span class="line">Memcached</span><br><span class="line">MLPerf</span><br><span class="line">NAS Parallel</span><br><span class="line">Network Ping/ICMP</span><br><span class="line">Network Suite</span><br><span class="line">OpenFOAM</span><br><span class="line">OpenSSL</span><br><span class="line">PostgreSQL</span><br><span class="line">Prime95</span><br><span class="line">Redis</span><br><span class="line">SPECcpu</span><br><span class="line">SPECjbb</span><br><span class="line">SPECjvm</span><br><span class="line">SPECpower</span><br><span class="line">Stress-ng</span><br><span class="line">StressAppTest</span><br><span class="line">SuperBenchmark</span><br><span class="line">Sysbench OLTP</span><br></pre></td></tr></table></figure>

<h4 id="test-SPEC-features-example"><a href="#test-SPEC-features-example" class="headerlink" title="test SPEC features example"></a><a target="_blank" rel="noopener" href="https://www.opencompute.org/documents/datacenter-sas-sata-device-specification-rev-1-0-pdf">test SPEC features example</a></h4><p><a target="_blank" rel="noopener" href="https://www.opencompute.org/documents/datacenter-nvme-ssd-specification-v2-0r21-pdf">nvme open copmute project spec</a><br>Mode Pages</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Requirement ID Description</span><br><span class="line">SAS-MOD-1 SAS devices shall support the following Mode pages and parameters:</span><br><span class="line">• M = Mandatory. Mode Page shall be supported.</span><br><span class="line">• P = Prohibited. Mode Page shall not be supported (<span class="built_in">command</span> rejected with</span><br><span class="line">ILLEGAL_FIELD_IN_CDB).</span><br><span class="line">• O = Optional. Mode Page support is optional.</span><br><span class="line">Page Code Page Description Standard Support</span><br><span class="line">00h Vendor Specific (Does not require page</span><br><span class="line">format)</span><br><span class="line">SPC-6 O</span><br><span class="line">Requirement ID Description</span><br><span class="line">01h Read-Write Error Recovery SBC-5 M</span><br><span class="line">02h Disconnect-Reconnect (SAS specific) SPC-6 and</span><br><span class="line">SAS-5</span><br><span class="line">M</span><br><span class="line">07h Verify Error Recovery SBC-5 M</span><br><span class="line">08h Caching SBC-5 M</span><br><span class="line">0Ah Control SPC-6 M</span><br><span class="line">0Ah/01h Control Extensions SPC-6 M</span><br><span class="line">0Ah/02h Application Tag SBC-5 O</span><br><span class="line">0Ah/FFh Return all subpages of page 0Ah (MODE</span><br><span class="line">SENSE only)</span><br><span class="line">SPC-6 M</span><br><span class="line">18h Protocol-Specific Logical Unit SAS-5 M</span><br><span class="line">19h Protocol-Specific Port - short format SAS-5 M</span><br><span class="line">19h/01h Protocol-Specific Port - PHY Control and</span><br><span class="line">Discover</span><br><span class="line">SAS-5 M</span><br><span class="line">19h/02h Shared Port Control SAS-5 M</span><br><span class="line">19h/03h Enhanced PHY Control SAS-5 M</span><br><span class="line">19h/FFh Return all subpages of page 19h (MODE</span><br><span class="line">SENSE only)</span><br><span class="line">SPC-6 M</span><br><span class="line">1Ah Power Condition SPC-6 M</span><br><span class="line">1Ah/01h Power Consumption SPC-6 M</span><br><span class="line">1Ch Informational Exceptions Control SPC-6 M</span><br><span class="line">1Ch/01h Background Control SBC-5 M</span><br><span class="line">1Ch/02h Logical Block Provisioning SBC-5 M</span><br><span class="line">3Fh Return All Pages (MODE SENSE only) SPC-6 M</span><br><span class="line">SAS-MOD-2 If the host sends a MODE SENSE (6) <span class="built_in">command</span> with SUBPAGE CODE field value of 00h, the</span><br><span class="line">device shall NOT terminate the <span class="built_in">command</span> with CHECK CONDITION due to more information</span><br><span class="line">than allowed by the one-byte allocation length. The amount of data returned shall be equal</span><br><span class="line">to or less than allowed by the one-byte allocation length, and NO MODE PAGE SHALL BE</span><br><span class="line">TRUNCATED. The device shall <span class="built_in">return</span> ALL supported subpage 00h mode pages <span class="keyword">in</span> page_0</span><br><span class="line">format.</span><br><span class="line">SAS-MOD-3 The device shall have the following default parameters from the factory <span class="keyword">for</span> byte 02h of the</span><br><span class="line">Read-Write Error Recovery mode page (01h):</span><br><span class="line">Bit Description Default</span><br><span class="line">7 Automatic Write Reassignment Enabled (AWRE) 1b</span><br><span class="line">6 Automatic Read Reassignment Enabled (ARRE) 1b</span><br><span class="line">5 Transfer Block (TB) 0b</span><br><span class="line">4 Read Continuous (RC) 0b</span><br><span class="line">2 Post Error (PER) 1b</span><br></pre></td></tr></table></figure>

<h3 id="Fault-injection"><a href="#Fault-injection" class="headerlink" title="Fault-injection"></a>Fault-injection</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kernel source tools/testing/fault-injection/failcmd.sh</span></span><br><span class="line">$ ./failcmd.sh --<span class="built_in">times</span>=-1 --interval=1 --verbose=2</span><br><span class="line">failslab is not available</span><br></pre></td></tr></table></figure>

<h3 id="overloading-test"><a href="#overloading-test" class="headerlink" title="overloading test"></a>overloading test</h3><ul>
<li>1024x read in single client</li>
</ul>
<h3 id="For-GPU"><a href="#For-GPU" class="headerlink" title="For GPU"></a>For GPU</h3><ul>
<li>Worked under RX580 with ROCm<ul>
<li>radeontop show the high temp and loading in the GPU</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/ROCmSoftwarePlatform/pytorch-micro-benchmarking">pytorch micro benchmark</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ python3 micro_benchmarking_pytorch.py --network resnet50 --batch-size=64 --iterations=5</span><br><span class="line">INFO: running forward and backward <span class="keyword">for</span> warmup.</span><br><span class="line">INFO: running the benchmark..</span><br><span class="line">OK: finished running benchmark..</span><br><span class="line">--------------------SUMMARY--------------------------</span><br><span class="line">Microbenchmark <span class="keyword">for</span> network : resnet50</span><br><span class="line">Num devices: 1</span><br><span class="line">Dtype: FP32</span><br><span class="line">Mini batch size [img] : 64</span><br><span class="line">Time per mini-batch : 2.095881795883179</span><br><span class="line">Throughput [img/sec] : 30.536073229755395</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tensorflow/benchmarks">tensorflow benchmark</a>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ python ./scripts/tf_cnn_benchmarks/tf_cnn_benchmarks.py --num_gpus=1 --batch_size=64 --model=resnet50</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">I0605 22:10:27.740044 140609957779264 session_manager.py:527] Running local_init_op.</span><br><span class="line">2023-06-05 22:10:27.766647: I tensorflow/core/common_runtime/gpu_fusion_pass.cc:507] ROCm Fusion is enabled.</span><br><span class="line">INFO:tensorflow:Done running local_init_op.</span><br><span class="line">I0605 22:10:27.795318 140609957779264 session_manager.py:530] Done running local_init_op.</span><br><span class="line">2023-06-05 22:10:27.992071: I tensorflow/core/common_runtime/gpu_fusion_pass.cc:507] ROCm Fusion is enabled.</span><br><span class="line">2023-06-05 22:10:28.037118: I tensorflow/core/common_runtime/gpu_fusion_pass.cc:507] ROCm Fusion is enabled.</span><br><span class="line">2023-06-05 22:10:28.054641: I tensorflow/core/common_runtime/gpu_fusion_pass.cc:507] ROCm Fusion is enabled.</span><br><span class="line">Running warm up</span><br><span class="line">2023-06-05 22:10:28.769240: I tensorflow/core/common_runtime/gpu_fusion_pass.cc:507] ROCm Fusion is enabled.</span><br><span class="line">Done warm up</span><br><span class="line">Step Img/sec total_loss</span><br><span class="line">1 images/sec: 37.4 +/- 0.0 (jitter = 0.0) 7.608</span><br><span class="line">10 images/sec: 37.4 +/- 0.1 (jitter = 0.3) 7.849</span><br><span class="line">20 images/sec: 37.4 +/- 0.1 (jitter = 0.3) 8.013</span><br><span class="line">30 images/sec: 37.3 +/- 0.1 (jitter = 0.3) 7.940</span><br><span class="line">40 images/sec: 37.3 +/- 0.0 (jitter = 0.2) 8.137</span><br><span class="line">50 images/sec: 37.2 +/- 0.0 (jitter = 0.2) 8.052</span><br><span class="line">60 images/sec: 37.2 +/- 0.0 (jitter = 0.2) 7.783</span><br><span class="line">70 images/sec: 37.1 +/- 0.0 (jitter = 0.3) 7.855</span><br><span class="line">80 images/sec: 37.1 +/- 0.0 (jitter = 0.3) 8.011</span><br><span class="line">90 images/sec: 37.0 +/- 0.0 (jitter = 0.3) 7.843</span><br><span class="line">100 images/sec: 37.0 +/- 0.0 (jitter = 0.4) 8.089</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">total images/sec: 36.96</span><br><span class="line">----------------------------------------------------------------</span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/RadeonOpenCompute/ROCm/issues/1786">the others and not make sure</a>  </p>
<h4 id="OpenBLAS"><a href="#OpenBLAS" class="headerlink" title="OpenBLAS"></a><a target="_blank" rel="noopener" href="https://github.com/bgeneto/build-install-compile-openblas">OpenBLAS</a></h4><p><a target="_blank" rel="noopener" href="https://github.com/xianyi/OpenBLAS/blob/develop/USAGE.md">USAGE</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> LD_LIBRARY_PATH=/path/to/OpenBLAS:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">$ <span class="built_in">export</span> BLAS=/path/to/libopenblas.a</span><br><span class="line">$ <span class="built_in">export</span> ATLAS=/path/to/libopenblas.a</span><br><span class="line">    </span><br><span class="line"><span class="comment"># compile the library</span></span><br><span class="line"><span class="built_in">cd</span> OpenBLAS &amp;&amp; make FC=gfortran</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> OPENBLAS_INCX=10000</span><br><span class="line">$ <span class="built_in">export</span> OPENBLAS_INCX=10000000</span><br><span class="line">$ <span class="built_in">export</span> OPENBLAS_INCY=10000000</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> benchmark</span><br><span class="line">$ gcc -O3 her2k.c -o her2k -g -lpthread -lgfortran /opt/OpenBLAS-0.3.23/lib/libopenblas_threaded.so.0</span><br></pre></td></tr></table></figure>

<h5 id="pthread-not-working"><a href="#pthread-not-working" class="headerlink" title="pthread not working"></a>pthread not working</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ vi interface/zhemv.c</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SMP</span></span><br><span class="line">  nthreads = num_cpu_avail(); <span class="comment">//or set the number</span></span><br><span class="line">  or</span><br><span class="line">  nthreads = <span class="number">32</span>;  &lt;----not working</span><br><span class="line">$ export OPENBLAS_NUM_THREADS=<span class="number">16</span> GOTO_NUM_THREADS=<span class="number">16</span> OMP_NUM_THREADS=<span class="number">16</span> &lt;---not working</span><br><span class="line"></span><br><span class="line">$ make CC=gcc FC=gfortran HOSTCC=gcc LIBNAMESUFFIX=threaded</span><br><span class="line"><span class="meta">#kill the test</span></span><br><span class="line">$ make PREFIX=/opt/OpenBLAS<span class="number">-0.3</span><span class="number">.23</span> LIBNAMESUFFIX=threaded install</span><br><span class="line"></span><br><span class="line">$ export OPENBLAS_NUM_THREADS=<span class="number">16</span> OMP_NUM_THREADS=<span class="number">16</span> GOTO_NUM_THREADS=<span class="number">16</span> OPENBLAS_INCX=<span class="number">10000</span> OPENBLAS_INCY=<span class="number">10000</span></span><br><span class="line">$ cd benchmark</span><br><span class="line">$ gcc -o rotm rotm.c -I /opt/OpenBLAS<span class="number">-0.3</span><span class="number">.23</span>/include -L/opt/OpenBLAS<span class="number">-0.3</span><span class="number">.23</span>/lib -lopenblas</span><br><span class="line">or</span><br><span class="line">$ gcc -lpthread -lgfortran rotm.c -o rotm /opt/OpenBLAS<span class="number">-0.3</span><span class="number">.23</span>/lib/libopenblas_threaded.so</span><br><span class="line">$ ./rotm &lt;---worked, becuase too fast cause looks like single core worked, you could got the average cpu usage by ps aux, CPU usage about <span class="number">300</span>~<span class="number">1000</span> , larger the <span class="number">100</span></span><br><span class="line"><span class="meta">#replace test by python and R</span></span><br><span class="line">$ cd scripts</span><br><span class="line">$ ls -l</span><br><span class="line">total <span class="number">16</span></span><br><span class="line">drwxrwxr-x <span class="number">2</span> root root <span class="number">4096</span> Apr  <span class="number">2</span> <span class="number">04</span>:<span class="number">18</span> NUMPY</span><br><span class="line">drwxrwxr-x <span class="number">2</span> root root <span class="number">4096</span> Apr  <span class="number">2</span> <span class="number">04</span>:<span class="number">18</span> OCTAVE</span><br><span class="line">drwxrwxr-x <span class="number">2</span> root root <span class="number">4096</span> Jul <span class="number">10</span> <span class="number">13</span>:<span class="number">58</span> R</span><br><span class="line">drwxrwxr-x <span class="number">2</span> root root <span class="number">4096</span> Jul <span class="number">10</span> <span class="number">16</span>:<span class="number">29</span> SCIPY</span><br></pre></td></tr></table></figure>

<h3 id="tiering-cache"><a href="#tiering-cache" class="headerlink" title="tiering cache"></a>tiering cache</h3><h4 id="bcache"><a href="#bcache" class="headerlink" title="bcache"></a>bcache</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b v1.0.8</span><br><span class="line">bcache.c:115</span><br><span class="line">-inline uint64_t crc64(const void *_data, size_t len)</span><br><span class="line">+uint64_t crc64(const void *_data, size_t len)</span><br><span class="line"></span><br><span class="line">$ make</span><br><span class="line">Redhat linux there is no kernel module, re-compile ? switch dm-cache or lvm-cache</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.thomas-krenn.com/de/wiki/Dm-cache">dm-cache-1</a><br><a target="_blank" rel="noopener" href="https://blog.kylemanna.com/linux/ssd-caching-using-dmcache-tutorial/">dm-cache-2</a><br><a target="_blank" rel="noopener" href="https://forum.level1techs.com/t/a-bcached-zfs-pool-weekend-project-what-how-and-benches/173141">bcache-1</a><br><a target="_blank" rel="noopener" href="https://fedoramagazine.org/linux-bcache-with-writeback-cache-how-it-works-and-doesnt-work/">bcache-2</a><br><a target="_blank" rel="noopener" href="https://rudeigerc.dev/posts/bcache/">bcache-3</a><br><a target="_blank" rel="noopener" href="https://documentation.suse.com/sles/12-SP4/html/SLES-all/cha-multitiercache.html">lvm-cache-1</a><br><a target="_blank" rel="noopener" href="https://blog.delouw.ch/2020/01/29/using-lvm-cache-for-storage-tiering/">lvm-cache-2</a><br><a target="_blank" rel="noopener" href="https://docs.kernel.org/admin-guide/bcache.html">In the parastor,found the bcache info</a>   </p>
<h4 id="test-LVM-cache-with-zfs"><a href="#test-LVM-cache-with-zfs" class="headerlink" title="test LVM cache with zfs"></a>test LVM cache with zfs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;d..l&#125; o r; do pvcreate /dev/sd$&#123;i&#125;1; done #hdd</span><br><span class="line">pvcreate /dev/sdal&#123;1..6&#125; #ssd 24Gbps, JBOD slot 6Gbps</span><br><span class="line">pvcreate /dev/sdao&#123;1..5&#125; #ssd 12Gbps, JBOD slot 6Gbps</span><br><span class="line">vi /etc/lvm/lvm.conf </span><br><span class="line">allow_mixed_block_sizes = 1</span><br><span class="line">        cache_settings &#123;</span><br><span class="line">          chunk_size=128</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">for i in a b c ao ar au al; do wipefs -a /dev/sd$i ; parted -s /dev/sd$i mklabel gpt; parted -s /dev/sd$i mkpart p1 ext4 2048s 10G; parted -s /dev/sd$i mkpart p2 ext4 10G 20G; parted -s /dev/sd$i mkpart p3 ext4 20G 220G; parted -s /dev/sd$i mkpart p4 ext4 220G 420G; wipefs -a /dev/sd$&#123;i&#125;1; wipefs -a /dev/sd$&#123;i&#125;2; wipefs -a /dev/sd$&#123;i&#125;3 ; wipefs -a /dev/sd$&#123;i&#125;4; done</span><br><span class="line"></span><br><span class="line">for i in a b c ao ar au al; do pvcreate /dev/sd$&#123;i&#125;1; pvcreate /dev/sd$&#123;i&#125;2; pvcreate /dev/sd$&#123;i&#125;3; pvcreate /dev/sd$&#123;i&#125;4; done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vgcreate vg_data1 /dev/sdd1 /dev/sdal1</span><br><span class="line">vgcreate vg_data2 /dev/sde1 /dev/sdal2</span><br><span class="line">vgcreate vg_data3 /dev/sdf1 /dev/sdal3</span><br><span class="line">vgcreate vg_data4 /dev/sdg1 /dev/sdal4</span><br><span class="line">vgcreate vg_data5 /dev/sdh1 /dev/sdal5</span><br><span class="line">vgcreate vg_data6 /dev/sdi1 /dev/sdal6</span><br><span class="line">vgcreate vg_data7 /dev/sdj1 /dev/sdao1</span><br><span class="line">vgcreate vg_data8 /dev/sdk1 /dev/sdao2</span><br><span class="line">vgcreate vg_data9 /dev/sdl1 /dev/sdao3</span><br><span class="line">vgcreate vg_data10 /dev/sdo1 /dev/sdao4</span><br><span class="line">vgcreate vg_data11 /dev/sdr1 /dev/sdao5</span><br><span class="line"></span><br><span class="line">lvcreate -l 100%FREE -n lv_data1 vg_data1 /dev/sdd1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data2 vg_data2 /dev/sde1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data3 vg_data3 /dev/sdf1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data4 vg_data4 /dev/sdg1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data5 vg_data5 /dev/sdh1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data6 vg_data6 /dev/sdi1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data7 vg_data7 /dev/sdj1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data8 vg_data8 /dev/sdk1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data9 vg_data9 /dev/sdl1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data10 vg_data10 /dev/sdo1 </span><br><span class="line">lvcreate -l 100%FREE -n lv_data11 vg_data11 /dev/sdr1 </span><br><span class="line"></span><br><span class="line">lvcreate -n cachepool_meta1 -L 100M vg_data1 /dev/sdal1</span><br><span class="line">lvcreate -n cachepool_meta2 -L 100M vg_data2 /dev/sdal2</span><br><span class="line">lvcreate -n cachepool_meta3 -L 100M vg_data3 /dev/sdal3</span><br><span class="line">lvcreate -n cachepool_meta4 -L 100M vg_data4 /dev/sdal4</span><br><span class="line">lvcreate -n cachepool_meta5 -L 100M vg_data5 /dev/sdal5</span><br><span class="line">lvcreate -n cachepool_meta6 -L 100M vg_data6 /dev/sdal6</span><br><span class="line">lvcreate -n cachepool_meta7 -L 100M vg_data7 /dev/sdao1</span><br><span class="line">lvcreate -n cachepool_meta8 -L 100M vg_data8 /dev/sdao2</span><br><span class="line">lvcreate -n cachepool_meta9 -L 100M vg_data9 /dev/sdao3</span><br><span class="line">lvcreate -n cachepool_meta10 -L 100M vg_data10 /dev/sdao4</span><br><span class="line">lvcreate -n cachepool_meta11 -L 100M vg_data11 /dev/sdao5</span><br><span class="line"></span><br><span class="line">lvcreate -n cachepool1 -L 140G vg_data1 /dev/sdal1 #&lt;--- here is GiB</span><br><span class="line">lvcreate -n cachepool2 -L 140G vg_data2 /dev/sdal2</span><br><span class="line">lvcreate -n cachepool3 -L 140G vg_data3 /dev/sdal3</span><br><span class="line">lvcreate -n cachepool4 -L 140G vg_data4 /dev/sdal4</span><br><span class="line">lvcreate -n cachepool5 -L 140G vg_data5 /dev/sdal5</span><br><span class="line">lvcreate -n cachepool6 -L 140G vg_data6 /dev/sdal6</span><br><span class="line">lvcreate -n cachepool7 -L 140G vg_data7 /dev/sdao1</span><br><span class="line">lvcreate -n cachepool8 -L 140G vg_data8 /dev/sdao2</span><br><span class="line">lvcreate -n cachepool9 -L 140G vg_data9 /dev/sdao3</span><br><span class="line">lvcreate -n cachepool10 -L 140G vg_data10 /dev/sdao4</span><br><span class="line">lvcreate -n cachepool11 -L 140G vg_data11 /dev/sdao5</span><br><span class="line"></span><br><span class="line">for i in &#123;1..11&#125;; do lvconvert --type cache-pool -c 128K --poolmetadata cachepool_meta$i vg_data$i/cachepool$i; done </span><br><span class="line">Chunk size 64.00 KiB is less than required minimal chunk size 576.00 KiB for a cache pool of 520.00 GiB size and limit 1000000 chunks.</span><br><span class="line">To allow use of more chunks, see setting allocation/cache_pool_max_chunks.</span><br><span class="line"></span><br><span class="line">lvmconfig</span><br><span class="line">allocation &#123;</span><br><span class="line">	cache_settings &#123;</span><br><span class="line">		chunk_size=128</span><br><span class="line">	&#125;</span><br><span class="line">	cache_pool_max_chunks=5000000</span><br><span class="line">	physical_extent_size=1024</span><br><span class="line">&#125;</span><br><span class="line">devices &#123;</span><br><span class="line">	allow_mixed_block_sizes=1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in &#123;1..11&#125;; do lvconvert --type cache -c 128K --cache-pool cachepool$i --cachemode writethrough vg_data$i/lv_data$i; done</span><br><span class="line"></span><br><span class="line">zpool create -f -O canmount=on -O xattr=sa -O acltype=posixacl -O dnodesize=1k -o ashift=12 -o multihost=on tank-11 raidz3 /dev/mapper/vg_data1-lv_data1 /dev/mapper/vg_data2-lv_data2 /dev/mapper/vg_data3-lv_data3 /dev/mapper/vg_data4-lv_data4 /dev/mapper/vg_data5-lv_data5 /dev/mapper/vg_data6-lv_data6 /dev/mapper/vg_data7-lv_data7 /dev/mapper/vg_data8-lv_data8 /dev/mapper/vg_data9-lv_data9 /dev/mapper/vg_data10-lv_data10 /dev/mapper/vg_data11-lv_data11</span><br><span class="line"></span><br><span class="line">#detach</span><br><span class="line">$ lvconvert --splitcache vg_data1/lv_data1</span><br><span class="line"></span><br><span class="line">#remove cache only</span><br><span class="line">lvremove vg_data1/cachepool1</span><br><span class="line">lvconvert --uncache vg_data1/lv_data1</span><br><span class="line"></span><br><span class="line">$ lvs -o +lv_name,cache_read_hits,cache_read_misses</span><br><span class="line">  LV        VG                   Attr       LSize  Pool                Origin            Data%  Meta%  Move Log Cpy%Sync Convert LV        CacheReadHits    CacheReadMisses </span><br><span class="line">  swap      almalinux_test3-1gbe -wi-ao----  4.00g                                                                               swap                                       </span><br><span class="line">  lv_data1  vg_data1             Cwi-aoC--- &lt;5.46t [cachepool1_cpool]  [lv_data1_corig]  63.08  4.52            0.00             lv_data1           3290899           471876</span><br><span class="line">  lv_data10 vg_data10            Cwi-aoC--- &lt;5.46t [cachepool10_cpool] [lv_data10_corig] 65.65  4.52            0.00             lv_data10          4977529           571807</span><br><span class="line">  lv_data11 vg_data11            Cwi-aoC--- &lt;5.46t [cachepool11_cpool] [lv_data11_corig] 64.43  4.52            0.00             lv_data11          5031087           538079</span><br><span class="line">  lv_data2  vg_data2             Cwi-aoC--- &lt;5.46t [cachepool2_cpool]  [lv_data2_corig]  61.15  4.52            0.00             lv_data2           3186832           455512</span><br><span class="line">  lv_data3  vg_data3             Cwi-aoC--- &lt;5.46t [cachepool3_cpool]  [lv_data3_corig]  61.62  4.52            0.00             lv_data3           3196847           454944</span><br><span class="line">  lv_data4  vg_data4             Cwi-aoC--- &lt;5.46t [cachepool4_cpool]  [lv_data4_corig]  62.83  4.52            0.00             lv_data4           3247019           468659</span><br><span class="line">  lv_data5  vg_data5             Cwi-aoC--- &lt;5.46t [cachepool5_cpool]  [lv_data5_corig]  63.62  4.52            0.00             lv_data5           3269402           479193</span><br><span class="line">  lv_data6  vg_data6             Cwi-aoC--- &lt;5.46t [cachepool6_cpool]  [lv_data6_corig]  62.41  4.52            0.00             lv_data6           3213675           457579</span><br><span class="line">  lv_data7  vg_data7             Cwi-aoC--- &lt;5.46t [cachepool7_cpool]  [lv_data7_corig]  60.96  4.52            0.00             lv_data7           4759051           493754</span><br><span class="line">  lv_data8  vg_data8             Cwi-aoC--- &lt;5.46t [cachepool8_cpool]  [lv_data8_corig]  62.39  4.52            0.00             lv_data8           4779036           511468</span><br><span class="line">  lv_data9  vg_data9             Cwi-aoC--- &lt;5.46t [cachepool9_cpool]  [lv_data9_corig]  63.91  4.52            0.00             lv_data9           4814786           534425</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lvs</span><br><span class="line">  LV        VG                   Attr       LSize  Pool                Origin            Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  swap      almalinux_test3-1gbe -wi-ao----  4.00g                                                                              </span><br><span class="line">  lv_data1  vg_data1             Cwi-a-C--- &lt;5.46t [cachepool1_cpool]  [lv_data1_corig]  65.39  4.52            0.00            </span><br><span class="line">  lv_data10 vg_data10            Cwi-a-C--- &lt;5.46t [cachepool10_cpool] [lv_data10_corig] 68.01  4.52            0.00            </span><br><span class="line">  lv_data11 vg_data11            Cwi-a-C--- &lt;5.46t [cachepool11_cpool] [lv_data11_corig] 66.80  4.52            0.00            </span><br><span class="line">  lv_data2  vg_data2             Cwi-a-C--- &lt;5.46t [cachepool2_cpool]  [lv_data2_corig]  63.44  4.52            0.00            </span><br><span class="line">  lv_data3  vg_data3             Cwi-a-C--- &lt;5.46t [cachepool3_cpool]  [lv_data3_corig]  63.96  4.52            0.00            </span><br><span class="line">  lv_data4  vg_data4             Cwi-a-C--- &lt;5.46t [cachepool4_cpool]  [lv_data4_corig]  65.12  4.52            0.00            </span><br><span class="line">  lv_data5  vg_data5             Cwi-a-C--- &lt;5.46t [cachepool5_cpool]  [lv_data5_corig]  65.96  4.52            0.00            </span><br><span class="line">  lv_data6  vg_data6             Cwi-a-C--- &lt;5.46t [cachepool6_cpool]  [lv_data6_corig]  64.72  4.52            0.00            </span><br><span class="line">  lv_data7  vg_data7             Cwi-a-C--- &lt;5.46t [cachepool7_cpool]  [lv_data7_corig]  63.39  4.52            0.00            </span><br><span class="line">  lv_data8  vg_data8             Cwi-a-C--- &lt;5.46t [cachepool8_cpool]  [lv_data8_corig]  64.65  4.52            0.00            </span><br><span class="line">  lv_data9  vg_data9             Cwi-a-C--- &lt;5.46t [cachepool9_cpool]  [lv_data9_corig]  66.27  4.52            0.00   </span><br><span class="line"></span><br><span class="line"># after detach</span><br><span class="line">$ lvs</span><br><span class="line">   LV          VG                   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  swap        almalinux_test3-1gbe -wi-ao----   4.00g                                                    </span><br><span class="line">  cachepool1  vg_data1             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data1    vg_data1             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool10 vg_data10            Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data10   vg_data10            -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool11 vg_data11            Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data11   vg_data11            -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool2  vg_data2             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data2    vg_data2             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool3  vg_data3             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data3    vg_data3             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool4  vg_data4             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data4    vg_data4             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool5  vg_data5             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data5    vg_data5             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool6  vg_data6             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data6    vg_data6             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool7  vg_data7             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data7    vg_data7             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool8  vg_data8             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data8    vg_data8             -wi-a-----  &lt;5.46t                                                    </span><br><span class="line">  cachepool9  vg_data9             Cwi---C--- 140.00g                                                    </span><br><span class="line">  lv_data9    vg_data9             -wi-a-----  &lt;5.46t                 </span><br><span class="line"></span><br><span class="line">$ for i in &#123;1..11&#125;; do lvremove vg_data$i/cachepool$i; done</span><br><span class="line">  Logical volume &quot;cachepool1&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool2&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool3&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool4&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool5&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool6&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool7&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool8&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool9&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool10&quot; successfully removed.</span><br><span class="line">  Logical volume &quot;cachepool11&quot; successfully removed.</span><br><span class="line"></span><br><span class="line">$ lvconvert --type cache --chunksize 32K --cachedevice /dev/sdb vg/lv</span><br><span class="line">or</span><br><span class="line">$ lvcreate --cache -Lsizeofcache -c 32K vg/LV_ORIGIN /dev/sdb</span><br><span class="line"></span><br><span class="line">$ lvconvert --type cache --cachepool lv_cache vg/lv</span><br><span class="line"></span><br><span class="line">#modify cache mode</span><br><span class="line">$ lvchange --cachemode writeback vg/lv</span><br><span class="line">$ lvchange --cachemode writethrough vg/lv</span><br><span class="line"></span><br><span class="line">#show</span><br><span class="line">$ lvs -o+cache_mode vg/lv</span><br><span class="line"></span><br><span class="line">#resize cache size</span><br><span class="line">$ lvconvert --splitcache vg/lv</span><br><span class="line">$ lvresize -L 300G vg/lv /dev/sdb</span><br><span class="line">$ lvconvert --type cache --cachevol vg/lv-cache vg/lv --cachemode writethrough</span><br><span class="line">$ lvs -a</span><br></pre></td></tr></table></figure>

<h4 id="dm-cache"><a href="#dm-cache" class="headerlink" title="dm-cache"></a>dm-cache</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">$ dmsetup remove /dev/mapper/ssd_meta</span><br><span class="line"></span><br><span class="line">$ dmsetup create hdd_cached --table <span class="string">&#x27;0  $(blockdev --getsz /dev/hdd_data_dev) cache /dev/sda1  /dev/sda3 /dev/sdd1 512 1 writethrough smq 0  migration_threshold 4096&#x27;</span></span><br><span class="line">or</span><br><span class="line">$ dmsetup create hdd_cached --table <span class="string">&#x27;0 46883045376 cache /dev/md1p1 /dev/md1p2 /dev/md0 512 1 writethrough default 0&#x27;</span> <span class="comment">#default is the smq</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make every IO to random IOs, each IO will hit the SSD cache</span></span><br><span class="line">$ dmsetup create hdd_cached --table <span class="string">&#x27;0 46883045376 cache /dev/md1p1 /dev/md1p2 /dev/md0 512 1 writethrough smq 0 read_promote_adjustment 1 migration_threshold 8192 random_threshold 1&#x27;</span></span><br><span class="line"></span><br><span class="line">migration_threshold</span><br><span class="line">I’ve tried cheating by setting the smq’s migration_threshold to zero—low values also seem to work. This often silences the writes to the cached disks, so at least I’m on the right track. Sometimes, the cached disks still see several small writes each minute.</span><br><span class="line"></span><br><span class="line">sequential_threshold</span><br><span class="line">The sequential threshold indicates the number of contiguous I/Os required before a stream is treated as sequential</span><br><span class="line"></span><br><span class="line">random_threshold</span><br><span class="line">The random threshold is the number of intervening non-contiguous I/Os that must be seen before the stream is treated as random again</span><br><span class="line"></span><br><span class="line"><span class="comment">#like my case</span></span><br><span class="line">https://linux-lvm.redhat.narkive.com/dEx8cjEW/caching-policy-in-machine-learning-context</span><br><span class="line"></span><br><span class="line">$ dmsetup create hdd_cached --table <span class="string">&#x27;0 46883045376 cache /dev/md1p1 /dev/md1p2 /dev/md0 512 1 writethrough mq 4 sequential_threshold 1024 random_threshold 4 read_promote_adjustment 2&#x27;</span></span><br><span class="line"><span class="comment">#could not modify 512 to 256</span></span><br><span class="line"><span class="comment">#could not modify mq 4 to mq 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#modify worked</span></span><br><span class="line">$ dmsetup message hdd_cached 0 migration_threshold 8192</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">$ dmsetup create my_cache --table <span class="string">&#x27;0 41943040 cache /dev/mapper/metadata /dev/mapper/ssd /dev/mapper/origin 256 1 writethrough mq 4 sequential_threshold 1024 random_threshold 8&#x27;</span></span><br><span class="line">$ dmsetup create hdd_cached --table <span class="string">&#x27;0 41943040 cache /dev/md1p1 /dev/md1p2 /dev/md0 256 1 writethrough no_discard_passdown 2 read_promote_adjustment 2 random_threshold 4 sequential_threshold 512&#x27;</span></span><br><span class="line">The values I use there are far from what is recommended. </span><br><span class="line">As a size, 512 is used everywhere instead of 8192 as sequential_threshold 1024 or 512 instead of 4 and as random_threshold 4 or 8 instead of my 3.</span><br><span class="line"></span><br><span class="line">sequential_threshold 4 random_threshold 3</span><br><span class="line">They don<span class="string">&#x27;t want to have sequential IO in the cache, because that&#x27;</span>s also the fastest on HDDs.</span><br><span class="line">Only since sequential IO is faster than random on SSDs does every better file system optimize that little or nothing <span class="keyword">else</span> occurs.</span><br><span class="line">According to the documentation, mq was dropped <span class="keyword">in</span> kernel 3.16, but debian 4.5.4-1~bpo8+4 still seems to be able to <span class="keyword">do</span> it.</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $(($(blockdev --getsize64 /dev/md0)/512)) = 46883045376</span></span><br><span class="line"><span class="comment">#md1p1 = dm-cache ssd dev for dm-cache metadata</span></span><br><span class="line"><span class="comment">#md1p2 = dm-cache ssd dev for data</span></span><br><span class="line"><span class="comment">#md0 = HDDs</span></span><br><span class="line"><span class="comment">#256 = 256 x 512 Bytes= 128KiB </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cache &lt;metadata dev&gt; &lt;cache dev&gt; &lt;origin dev&gt; &lt;block size&gt; &lt;#feature args&gt; [&lt;feature arg&gt;]* &lt;policy&gt; &lt;#policy args&gt; [policy args]*</span></span><br><span class="line">https://www.kernel.org/doc/Documentation/device-mapper/cache.txt</span><br><span class="line">https://www.kernel.org/doc/Documentation/device-mapper/cache-policies.txt</span><br><span class="line">https://blog.patshead.com/2016/03/using-dm-cache-lvmcache-on-my-homelab-virtual-machine-host-to-improve-performance.html</span><br><span class="line"></span><br><span class="line">The dm-cache subsystem has additional per-LV parameters: the cache policy to use, and possibly tunable parameters <span class="keyword">for</span> the cache policy. Three policies are currently available: <span class="string">&quot;smq&quot;</span> is the default policy, <span class="string">&quot;mq&quot;</span> is an older implementation, and <span class="string">&quot;cleaner&quot;</span> is used to force the cache to write back (flush) all cached writes to the origin LV.</span><br><span class="line"></span><br><span class="line">$ dmsetup <span class="built_in">ls</span></span><br><span class="line">almalinux_test3--1gbe-swap      (253:0)</span><br><span class="line">hdd_cached      (253:1)</span><br><span class="line">$ dmsetup info /dev/mapper/hdd_cached</span><br><span class="line"></span><br><span class="line"><span class="comment">#remove device if writeback</span></span><br><span class="line">$ umount /dev/mapper/hdd_cached</span><br><span class="line">$ dmsetup table hdd_cached</span><br><span class="line">0 46883045376 cache 259:8 259:9 9:0 512 1 writethrough default 0</span><br><span class="line"></span><br><span class="line">$ dmsetup status hdd_cached</span><br><span class="line">0 46883045376 cache 8 11097/4161600 512 233851/5493304 241 81 514130 1411349 0 233849 0 2 writethrough no_discard_passdown 2 migration_threshold 2048 smq 0 rw -</span><br><span class="line"></span><br><span class="line">$ dmsetup <span class="built_in">suspend</span> hdd_cached</span><br><span class="line"><span class="comment">#modify config</span></span><br><span class="line">$ dmsetup reload hdd_cached --table <span class="string">&#x27;0 46883045376 cache 259:8 259:9 9:0 256 0 writethrough cleaner 0&#x27;</span></span><br><span class="line">$ dmsetup resume hdd_cached</span><br><span class="line"></span><br><span class="line"><span class="comment">#wait for dirty data flush</span></span><br><span class="line">$ dmsetup <span class="built_in">wait</span> hdd_cached</span><br><span class="line"></span><br><span class="line"><span class="comment">#data loss in the cache</span></span><br><span class="line">$ dmsetup remove hdd_cached</span><br></pre></td></tr></table></figure>

<h3 id="data-integrity"><a href="#data-integrity" class="headerlink" title="data integrity"></a>data integrity</h3><p>The same with ext4&#x2F;xfs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=test_vfat bs=1M count=0 seek=8388608</span><br><span class="line">$ mount.vfat /mnt/test_vfat /test_fs</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..23&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  (dracut /test_fs/initramfs_test-<span class="variable">$&#123;i&#125;</span>.img 5.14.0-162.12.1.el9_1.x86_64 &amp;&amp; <span class="built_in">md5sum</span> /test_fs/initramfs_test-<span class="variable">$&#123;i&#125;</span>.md5 &gt;/mnt2/initramfs_test-<span class="variable">$&#123;i&#125;</span>.md5) &amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="metadata-consistent"><a href="#metadata-consistent" class="headerlink" title="metadata consistent"></a>metadata consistent</h4><p>2 x nfs&#x2F;lustre&#x2F;gpfs clients</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">client1 mount1 $ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..33333&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; <span class="built_in">echo</span> $(openssl rand -hex 4) &gt; $(<span class="built_in">date</span> +%s).$(openssl rand -hex 4).<span class="variable">$i</span> ; <span class="keyword">done</span></span><br><span class="line">client2 mount1 $ <span class="built_in">date</span> +%s ; <span class="built_in">ls</span> -lt --time=atime --time-style=<span class="string">&#x27;+%s&#x27;</span> | <span class="built_in">head</span>  ;<span class="built_in">date</span> +%s</span><br><span class="line">1691044850</span><br><span class="line">total 195077</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044865 1691044855.57ff91f0.7932 &lt;---out of order, isilon 10s</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044855.6e0c904b.7888</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044855.0b3a2fe9.7885</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044855.c97d8f8b.7875</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044855.04509eda.7868</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044855.3ee071b4.7866</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044854.6df891c4.7851</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044854.8cca3089.7849</span><br><span class="line">-rw-r--r-- 1 root root 9 1691044864 1691044854.541f9387.7835</span><br><span class="line">                              |         |</span><br><span class="line">                              -----------</span><br><span class="line">                                   |</span><br><span class="line">                                 delayed</span><br><span class="line"></span><br><span class="line">client1 mount2 $ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..33333&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; <span class="built_in">echo</span> $(openssl rand -hex 4) &gt; $(<span class="built_in">date</span> +%s).$(openssl rand -hex 4).<span class="variable">$i</span> ; <span class="keyword">done</span></span><br><span class="line">client2 mount2 $ <span class="built_in">date</span> +%s ; <span class="built_in">ls</span> -lt --time=atime --time-style=<span class="string">&#x27;+%s&#x27;</span> | <span class="built_in">head</span>  ;<span class="built_in">date</span> +%s</span><br><span class="line">1691045040</span><br><span class="line">total 214</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.5eaa2760.428 &lt;---order</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.e143315a.427</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.f9b3138a.426</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.e201c749.424 </span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.2d5ec1d0.423</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.26b30977.422</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.3a720ede.421</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.05dd2b6f.420</span><br><span class="line">-rw-r--r-- 1 nobody nobody 9 1691045040 1691045040.9020f4c1.419</span><br><span class="line">                                 |          |</span><br><span class="line">                                 -----------</span><br><span class="line">                                      |</span><br><span class="line">                                 consistent  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#here is the lustre result</span></span><br><span class="line">client1 mount3 $ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..33333&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; <span class="built_in">echo</span> $(openssl rand -hex 4) &gt; $(<span class="built_in">date</span> +%s).$(openssl rand -hex 4).<span class="variable">$i</span> ; <span class="keyword">done</span></span><br><span class="line">client2 mount3 $ <span class="built_in">date</span> +%s ; <span class="built_in">ls</span> -lt --time-style=<span class="string">&#x27;+%s&#x27;</span> | <span class="built_in">head</span> ;<span class="built_in">date</span> +%s</span><br><span class="line">1691045726</span><br><span class="line">total 53618</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045727 1691045727.0a6cc4bf.6871</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045727 1691045727.2cf79768.6866</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045727 1691045727.2d80f23f.6861</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045727 1691045727.6734806b.6867</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045727 1691045727.950388e0.6858</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045726 1691045726.04eb3870.6850</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045726 1691045726.11576ddd.6839</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045726 1691045726.1e611dd1.6840</span><br><span class="line">-rw-r--r-- 1 99 99 9 1691045726 1691045726.2aee8385.6821</span><br><span class="line">1691045727</span><br></pre></td></tr></table></figure>

<h3 id="mpiFileUtils"><a href="#mpiFileUtils" class="headerlink" title="mpiFileUtils"></a><a target="_blank" rel="noopener" href="https://mpifileutils.readthedocs.io/en/latest/tools.html">mpiFileUtils</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/pmodels/mpich/releases/download/v4.1.2/mpich-4.1.2.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ../src/mpich-4.1.2</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure --prefix=/opt/lib/el9/mpich-4.1.2 --enable-debug --enable-debug-symbols</span><br><span class="line">$ make -j 40</span><br><span class="line">$ make install</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/lib/el9/mpich-4.1.2/bin:/opt/lib/el9/mpifileutils-v0.11.1/bin</span><br><span class="line">$ <span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:/opt/lib/el9/mpich-4.1.2/lib:/opt/lib/el9/mpifileutils-v0.11.1/lib</span><br><span class="line">$ <span class="built_in">export</span> C_INCLUDE_PATH=<span class="variable">$C_INCLUDE_PATH</span>:/opt/lib/el9/mpich-4.1.2/include:/opt/lib/el9/mpifileutils-v0.11.1/include</span><br><span class="line"></span><br><span class="line">$ wget https://github.com/hpc/libcircle/releases/download/v0.3/libcircle-0.3.0.tar.gz https://github.com/llnl/lwgrp/releases/download/v1.0.3/lwgrp-1.0.3.tar.gz https://github.com/llnl/dtcmp/releases/download/v1.1.1/dtcmp-1.1.1.tar.gz https://github.com/libarchive/libarchive/releases/download/3.5.1/libarchive-3.5.1.tar.gz</span><br><span class="line">$ dnf install -y libarchive-devel <span class="comment">#el9 support 3.5.3</span></span><br><span class="line"></span><br><span class="line">$ install=/opt/lib/el9/mpifileutils-v0.11.1</span><br><span class="line">$ <span class="built_in">cd</span> libcircle-0.3.0</span><br><span class="line">$ ./configure --prefix=<span class="variable">$installdir</span> ; make install</span><br><span class="line">$ <span class="built_in">cd</span> ../lwgrp-1.0.3</span><br><span class="line">$ ./configure --prefix=<span class="variable">$installdir</span> ; make install</span><br><span class="line">$ <span class="built_in">cd</span> ../dtcmp-1.1.1</span><br><span class="line">$ ./configure --prefix=<span class="variable">$installdir</span> --with-lwgrp=<span class="variable">$installdir</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../libarchive-3.7.2 <span class="comment">#el9 dnf install libarchive-devel</span></span><br><span class="line">$ ./configure --prefix=<span class="variable">$installdir</span> ; make install</span><br><span class="line">$ dnf install libattr-devel bzip2-devel libcap-devel</span><br><span class="line">$ apt install libattr libbz2-dev</span><br><span class="line"></span><br><span class="line">$ cmake ../ -DWITH_DTCMP_PREFIX=../../../mpifileutils-v0.11.1  -DWITH_LibCircle_PREFIX=../../../mpifileutils-v0.11.1 -DCMAKE_INSTALL_PREFIX=../../../mpifileutils-v0.11.1 -DENABLE_LUSTRE=ON</span><br><span class="line"></span><br><span class="line">el7</span><br><span class="line">$ cmake3 .. -DWITH_LibArchive_PREFIX=/opt/lib/el7/mpifileutils-v0.11.1 -DWITH_DTCMP_PREFIX=/opt/lib/el7/mpifileutils-v0.11.1 -DWITH_LibCircle_PREFIX=/opt/lib/el7/mpifileutils-v0.11.1 -DCMAKE_INSTALL_PREFIX=/opt/lib/el7/mpifileutils-v0.11.1 -DENABLE_LUSTRE=ON -DENABLE_XATTRS=ON  -DWITH_DTCMP_PREFIX=/opt/lib/el7/mpifileutils-v0.11.1 -DWITH_LibCircle_PREFIX=/opt/lib/el7/mpifileutils-v0.11.1</span><br><span class="line"></span><br><span class="line">$ make -j install</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../</span><br><span class="line">$ rsync -avP include/* /opt/lib/el9/mpifileutils-v0.11.1/include/</span><br><span class="line">$ rsync -avP lib64/* /opt/lib/el9/mpifileutils-v0.11.1/lib64/</span><br><span class="line">$ rsync -avP share/* /opt/lib/el9/mpifileutils-v0.11.1/share/</span><br><span class="line"></span><br><span class="line"><span class="comment">#single node</span></span><br><span class="line">$ time /opt/lib/el9/mpich-4.1.2/bin/mpirun -np 8 /opt/lib/el9/mpifileutils-v0.11.1/bin/dtar -cf test.tar /tank/test_file/el9</span><br><span class="line">$ time /opt/lib/el9/mpich-4.1.2/bin/mpirun -np 8 /opt/lib/el9/mpifileutils-v0.11.1/bin/dsync /usr /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment">#multiple nodes</span></span><br><span class="line">$ mpirun -f mpi_hosts --allow-run-as-root -n 16 /opt/lib/el7/mpifileutils/bin/dsync /lustre1/data_test1 /lustre2/</span><br><span class="line">$ mpirun -f mpi_hosts -n 16 /opt/lib/el7/mpifileutils/bin/dtar cf test.tar /lustre2/data_test1</span><br></pre></td></tr></table></figure>

<h3 id="NVME-SSD-Certification"><a href="#NVME-SSD-Certification" class="headerlink" title="NVME SSD Certification"></a>NVME SSD Certification</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.opencompute.org/documents/nvme-cloud-ssd-specification-v1-0-3-pdf">opencompute project nvme cloud - 6 Reliability</a></li>
<li>UNH-IOL<ul>
<li><a target="_blank" rel="noopener" href="https://www.iol.unh.edu/sites/default/files/testsuites/nvme/UNH-IOL_NVM_Command_Set_Conformance_v17.0.pdf">UNH-IOL</a></li>
<li><a target="_blank" rel="noopener" href="https://www.iol.unh.edu/registry/nvme">UNH-IOL NVME SSD list</a></li>
<li><a target="_blank" rel="noopener" href="https://www.iol.unh.edu/registry/nvmeof">UNH-IOL NVME OF list</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://pcisig.com/developers/integrators-list">PCI-SIG</a></li>
</ul>
<h3 id="FIO-block-test-Third-Party"><a href="#FIO-block-test-Third-Party" class="headerlink" title="FIO block test Third Party"></a>FIO block test Third Party</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kpmckay/fio-scripts">ScaleFlux</a><ul>
<li><a target="_blank" rel="noopener" href="https://scaleflux.cn/blog/ssd-testing-quick-and-simple-approach/">Link</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ccrssaa/py-sss-pts">SINA sss-pts</a></li>
<li><a target="_blank" rel="noopener" href="https://bluexp.netapp.com/blog/aws-netapp-baseline-performance-testing">Netapp</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mchad1/fio-parser.git">fio-parser</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mchad1/fio-parser/blob/master/how-to-run-fio">how to run</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="becnhmark-workflow"><a href="#becnhmark-workflow" class="headerlink" title="becnhmark workflow"></a>becnhmark workflow</h3><ul>
<li><a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/sql-server-blog/sql-server-on-linux-forced-unit-access-fua-internals/ba-p/3199102">SQL Server On Linux: Forced Unit Access (Fua) Internals</a></li>
<li>hardware<ul>
<li>Fua &#x3D; Forced Unit Access.  Fua is the standard used to issue an I&#x2F;O write command in stable data storage.  Fua has been a long-standing part of the SCSI specifications. <ul>
<li>Caution: Non-SCSI storage implementations often silently ignore the request.</li>
</ul>
</li>
<li>Device Flush, A device level flush forces any dirty buffer located in volatile storage onto stable media.  Flushing a non-battery backed disk or cache device can be performance impacting and repeated device flush commands reduce the optimized capabilities, such as, writes near current head placement, wear level reduction, caching mechanisms, etc.</li>
</ul>
</li>
<li>Concept<ul>
<li>Write-Ahead Logging or journaling.  The log records, which can be used to recreate the data, are stored in stable media before the data buffers are written and data buffers are stored in stable media before the supporting log records can be deleted.</li>
<li>O_DIRECT Linux open command flag used to bypass file system cache.<ul>
<li>Warning: The flag causes the file system cache of a guest VM to be bypassed but the VM or container may not pass the option to the host.</li>
</ul>
</li>
<li>O_DSYNC | fdatasync | RWF_ODSYNC The O_DSYNC | RWF_ODSYNC | fdatasync indicate to the Linux file systems that the ‘data integrity standard’ is to be upheld for I&#x2F;O operations.  The data integrity standard makes sure the data and supporting meta data, needed to retrieve the data, are stored in stable media.<ul>
<li>O_SYNC and fsync indicate to the Linux file system to uphold the ‘file integrity standard.’  O_SYNC is a superset of the O_DSYNC as the standard indicates that all file metadata (access timestamps for example) are stored in stable media.</li>
<li>RWF_ODSYNC is a newer variation of O_DSYNC.  The RWF_ODSYNC can be set as a flag for each I&#x2F;O request.  Whereas, opening the file with O_DSYNC establishes flushing behavior for all writes to the file.  SQL Server does NOT make use of RWF_ODSYNC.</li>
</ul>
</li>
<li>AIO | io_submit | Kernel I&#x2F;O (kio) Linux provides different system calls (syscall)&#x2F;commands for asynchronous behavior.<ul>
<li>write command – synchronous syscall, does not return until the write completes.</li>
<li>aio_write | io_submit – asynchronous syscall, returning control as soon as the I&#x2F;O request is queued. SQL Server uses aio* for asynchronous I&#x2F;O operations.</li>
</ul>
</li>
<li>O_NONBLOCK Linux open command flag value to avoid blocking during an I&#x2F;O call.  This is not a FILE_FLAG_OVERLAPPED implementation for the Linux ABIs.  Instead, the flag is used to decide if a wait will occur while attempting to issue the I&#x2F;O request.  If the thread would become blocked the attempt to issue the request is aborted and control is returned to the caller.<ul>
<li>Overlapped will issue the I&#x2F;O and return STATUS_PENDING, whereas the O_NONBLOCK returns EAGAIN(-11, retry) and the caller must retry the entire I&#x2F;O operation.</li>
</ul>
</li>
<li>O_NOATIME Linux open command flag to avoid updating the time of last access which can reduce metadata writes.  The O_NOATIME flag does NOT disable MTIME or CTIME modifications.</li>
<li>REQ_FUA<ul>
<li>Block device write request using the Fua capabilities when performing a write.  The Fua bit is sent with the write signaling stable media storage is required.</li>
</ul>
</li>
<li>REQ_PREFLUSH&#x2F;REQ_POSTFLUSH A block device write request (0 bytes – write[10, 12 or 16 bytes] SCSI command) requesting a device flush.</li>
<li>DpoFua <ul>
<li>DPO &#x3D; Disable Page Out (for writes instructs I&#x2F;O subsystem to avoid adding write data to the cache, for reads prevents replacing existing entries in cache.)</li>
<li>Fua and Dpo are separate bit values in the SCSI SCB.  SQL Server only requires Fua and not DPO capabilities.</li>
</ul>
</li>
</ul>
</li>
<li>Note: The 4.18 Linux Kernel updates allow the XFS file system and a device supporting Fua writes to avoid the additional block device flush request.</li>
</ul>
<p>make sure by blktrace</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ blktrace -d /dev/sda -o – | blkparse -i – -f “%5T.%9t %10p %-10S %D %2c %8s %2a %3d %10n %32C\n“</span><br><span class="line"></span><br><span class="line">Timestamp PID Sector Device Cmd Seq Act Flags Block Count</span><br><span class="line">3.636934795       3348 16518176     8,0    7      443  3348  A  WS         16                       IOPerfTest &lt;—I/O started</span><br><span class="line">3.636935395       3348 18617376     8,0    7      444  3348  A  WS         16                       IOPerfTest</span><br><span class="line">3.636936095       3348 18617376     8,0    7      445  3348  Q  WS         16                       IOPerfTest</span><br><span class="line">3.636941795       3348 18617376     8,0    7      446  3348  G  WS         16                       IOPerfTest</span><br><span class="line">3.636942295       3348 0            8,0    7      447  3348  P   N          0                       IOPerfTest</span><br><span class="line">3.636945195       3348 18617376     8,0    7      448  3348  I  WS         16                       IOPerfTest</span><br><span class="line">3.636946295       3348 0            8,0    7      449  3348  U   N          0                       IOPerfTest</span><br><span class="line">3.636947795       3348 18617376     8,0    7      450  3348  D  WS         16                       IOPerfTest</span><br><span class="line">3.638838077       3054 0            8,0    7      452  3054  A FWS          0                      kworker/7:2</span><br><span class="line">3.638838677       3054 0            8,0    7      453  3054  Q FWS          0                      kworker/7:2</span><br><span class="line">3.638843177       3054 0            8,0    7      454  3054  G FWS          0                      kworker/7:2</span><br><span class="line">3.638844377       3054 0            8,0    7      455  3054  I FWS          0                      kworker/7:2 &lt;-I/O completed</span><br><span class="line"></span><br><span class="line">The sample output shows an O_DIRECT | O_DSYNC write from the IOPerfTest application (<span class="built_in">source</span> contained at end of this blog) on a non-optimized, Linux file system.</span><br><span class="line">The WS flags indicate (W)rite at sector 16518176 with (S)ynchronized behavior (buffer and storage match.) The (Act)ion column shows the I/O request being (I)nserted into the (Q)ueue and the system workers performing, (G)etting, the FWS request.</span><br><span class="line"></span><br><span class="line">A FWS with block count of 0 is the block device flush <span class="built_in">command</span></span><br><span class="line">A WFS is a REQ_WRITE with the REQ_FUA request</span><br><span class="line"></span><br><span class="line">When the ‘FW’ pattern is present it shows a REQ_PREFLUSH | REQ_WRITE being sent to the device. What we are really looking <span class="keyword">for</span> is a ‘WFS’ request showing a REQ_WRITE with REQ_FUA, without the secondary FWS request, using optimized Fua capabilities and avoiding the secondary flush.</span><br><span class="line"></span><br><span class="line">13.944683500 2948 25671928 8,0 0 120245 I WFS 8 IOPerfTest &lt;- D=Issued, WFS=Write,REQ_FUA &lt;—I/O started</span><br><span class="line">13.944683500 2948 25671928 8,0 0 120246 D WFS 8 IOPerfTest &lt;- D=Completed, WFS=Write,REQ_FUA &lt;-I/O completed</span><br></pre></td></tr></table></figure>

<p>Using O_DIRECT and O_DSYNC Properly</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Enabling Trace (xfs, ext4, block device tracing)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/block/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/xfs/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/ext4/enable</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line"></span><br><span class="line">      IOPerfTest-2733  [004] ….   264.566322: xfs_file_direct_write: dev 253:2 ino 0x69 size 0x100000 offset 0xae000 count 0x2000</span><br><span class="line">      IOPerfTest-2733  [004] ….   264.566324: xfs_ilock: dev 253:2 ino 0x69 flags ILOCK_EXCL <span class="built_in">caller</span> xfs_file_iomap_begin [xfs]</span><br><span class="line">      IOPerfTest-2733  [004] ….   264.566325: xfs_iunlock: dev 253:2 ino 0x69 flags ILOCK_EXCL <span class="built_in">caller</span> xfs_file_iomap_begin [xfs]</span><br><span class="line">      IOPerfTest-2733  [004] ….   264.566325: xfs_iomap_found: dev 253:2 ino 0x69 size 0x100000 offset 0xae000 count 8192 <span class="built_in">type</span> invalid startoff 0xae startblock 272 blockcount 0x2</span><br><span class="line">      IOPerfTest-2733  [004] ….   264.566345: xfs_iunlock: dev 253:2 ino 0x69 flags IOLOCK_SHARED <span class="built_in">caller</span> xfs_file_dio_aio_write [xfs]</span><br><span class="line">     kworker/4:1-110   [004] ….   264.566761: xfs_end_io_direct_write: dev 253:2 ino 0x69 isize 0x100000 disize 0x100000 offset 0xae000 count 8192</span><br><span class="line">     kworker/4:1-110   [004] ….   264.566763: xfs_file_fsync: dev 253:2 ino 0x69</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">On Linux, you need a file system that provides DpuFua=1 enablement or you have confirmed your system is O_DIRECT safe.  </span><br><span class="line">By enabling the trace flag you <span class="built_in">disable</span> the batch flush requests from SQL Server and are trusting SQLPAL, HE and the I/O subsystem configuration to achieve durability.</span><br><span class="line"></span><br><span class="line">When running on Linux kernels or file systems that <span class="keyword">do</span> not support optimized Fua capabilities.</span><br><span class="line">The trace flag and forced flush behavior is intended to be a workaround <span class="keyword">for</span> Linux installations <span class="keyword">until</span> the SQL Server instance <span class="built_in">id</span> deployed on a system providing optimized, Fua capabilities.</span><br><span class="line"></span><br><span class="line">“Request Fua Writes”</span><br><span class="line">SQL Server opens database data and <span class="built_in">log</span> files with FILE_FLAG_WRITE_THROUGH,</span><br><span class="line"></span><br><span class="line">“Avoid Fua Writes”</span><br><span class="line">Forces SQL Server to open database data and <span class="built_in">log</span> files without FILE_FLAG_WRITE_THROUGH and issue the FlushFileBuffers calls to complete transactions and checkpoint activities.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Caution:</span><br><span class="line">Unless you are using an updated file system, it is unsafe to assume the REQ_FUA behavior.  SQL Server automatically enables -T3982 (forced flush behavior) on SQL Server <span class="keyword">for</span> Linux.  If you are able to, verify that a write on your system meets the following criteria, you may be able to achieve data integrity compliance without Fua capabilities as long as you are able to make sure the O_DIRECT path supports write completion when the data has been stored on stable media. – “O_DIRECT Safe.”</span><br><span class="line"></span><br><span class="line">I/O subsystem and drivers <span class="keyword">do</span> not cache FILE_FLAG_NO_BUFFERING (O_DIRECT) <span class="keyword">in</span> volatile cache. All cache involvement must be power outage hardened.</span><br><span class="line">All files <span class="keyword">in</span> the database are on these stable media, compliant I/O paths (data, <span class="built_in">log</span>, checkpoint files, standby recovery files, backups, …)</span><br><span class="line">All SQL Server support files are on the stable media (cluster files, registry files, …)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/">fsync posix 2017</a><br><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/62bad54b26db8bc98e28749cd76b2d890edb4258/fs/ext4/fsync.c#L129-L187">ext4 fsync file</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://puzpuzpuz.dev/the-secret-life-of-fsync">First, it writes all dirty pages belonging to the file that corresponds to the input file descriptor to the disk. That’s done by the <code>file_write_and_wait_range()</code> function. As a result, the data may be sitting in the disk volatile cache, so that’s not what we’re looking for.</a></li>
<li>Next, it writes the inode’s metadata to the disk. Depending on whether journaling is enabled on the FS or not, it’s done via a specific function, e.g. <code>ext4_fsync_journal()</code>. Again, not something we’re in search of.</li>
<li>Finally, if the needs_barrier variable is true, it calls the blkdev_issue_flush() function. That’s probably what we need, isn’t it?</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In addition the REQ_PREFLUSH flag can be set on an otherwise empty bio structure, which causes only an explicit cache flush without any dependent I/O. It is recommend to use the blkdev_issue_flush() helper for a pure cache flush.</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.kernel.org/block/writeback_cache_control.html#implementation-details-for-request-fn-based-block-drivers">Explicit volatile write back cache control</a></p>
<ul>
<li><p>Many storage devices, especially in the consumer market, come with volatile write back caches. That means the devices signal I&#x2F;O completion to the operating system before data actually has hit the non-volatile storage. This behavior obviously speeds up various workloads, but it means the operating system needs to force data out to the non-volatile storage when it performs a data integrity operation like fsync, sync or an unmount. The Linux block layer provides two simple mechanisms that let filesystems control the caching behavior of the storage device. These mechanisms are a forced cache flush, and the Force Unit Access (FUA) flag for requests.</p>
</li>
<li><p>Forced Unit Access</p>
<ul>
<li>The REQ_FUA flag can be OR ed into the r&#x2F;w flags of a bio submitted from the filesystem and will make sure that I&#x2F;O completion for this request is only signaled after the data has been committed to non-volatile storage.</li>
<li>Implementation details for filesystems<ul>
<li>Filesystems can simply set the REQ_PREFLUSH and REQ_FUA bits and do not have to worry if the underlying devices need any explicit cache flushing and how the Forced Unit Access is implemented. The REQ_PREFLUSH and REQ_FUA flags may both be set on a single bio.</li>
</ul>
</li>
<li>Implementation details for bio based block drivers<ul>
<li>These drivers will always see the REQ_PREFLUSH and REQ_FUA bits as they sit directly below the submit_bio interface. For remapping drivers the REQ_FUA bits need to be propagated to underlying devices, and a global flush needs to be implemented for bios with the REQ_PREFLUSH bit set. For real device drivers that do not have a volatile cache the REQ_PREFLUSH and REQ_FUA bits on non-empty bios can simply be ignored, and REQ_PREFLUSH requests without data can be completed successfully without doing any work. Drivers for devices with volatile caches need to implement the support for these flags themselves without any help from the block layer</li>
</ul>
</li>
<li>Implementation details for bio based block drivers<ul>
<li>Drivers for devices with volatile caches need to implement the support for these flags themselves without any help from the block layer.</li>
</ul>
</li>
<li>Implementation details for request_fn based block drivers<ul>
<li>For devices with volatile write caches the driver needs to tell the block layer that it supports flushing caches by doing: blk_queue_write_cache(sdkp-&gt;disk-&gt;queue, true, false);</li>
<li>For devices that also support the FUA bit the block layer needs to be told to pass through the REQ_FUA bit using: blk_queue_write_cache(sdkp-&gt;disk-&gt;queue, true, true);<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Linux 中REQ_&#123;PREFLUSH | FUA&#125;</span><br><span class="line">根据请求的属性和硬件的能力，REQ_&#123;PREFLUSH | FUA&#125; request 分解成由三个可选的步骤：PREFLUSH， DATA，和 POSTFLUSH。</span><br><span class="line">i. 若 request没有数据，只需要REQ_PREFLUSH 才起作用，表示只是一个flush request.</span><br><span class="line">ii. 如果有数据，REQ_PREFLUSH 表示device cache 必须在data 处理前FLUSH 进device. REQ_FUA 表示一旦request 完成，数据必须写入Non-Volatile 介质中。</span><br><span class="line">iii. 若device 没有writecache, PREFLUSH 和FUA 没什么区别。请求要么立即完成</span><br><span class="line">vi. 若device 有writecache, 并支持FUA，REQ_PREFLUSH 转化成PREFLUSH,REQ_FUA 直接和数据一起传给device.</span><br><span class="line">v. 若device 有writecache, 但不支持FUA,REQ_PREFLUSH 转化成PREFLUSH, REQ_FUA 则转换成POSTFLUSH。</span><br><span class="line"></span><br><span class="line">static unsigned int blk_flush_policy(unsigned long fflags, struct request *rq)</span><br><span class="line">&#123;</span><br><span class="line">    unsigned int policy = 0;</span><br><span class="line"></span><br><span class="line">    if (blk_rq_sectors(rq))</span><br><span class="line">        policy |= REQ_FSEQ_DATA;</span><br><span class="line"></span><br><span class="line">    if (fflags &amp; (1UL &lt;&lt; QUEUE_FLAG_WC)) &#123;</span><br><span class="line">        if (rq-&gt;cmd_flags &amp; REQ_PREFLUSH)</span><br><span class="line">            policy |= REQ_FSEQ_PREFLUSH;</span><br><span class="line">        if (!(fflags &amp; (1UL &lt;&lt; QUEUE_FLAG_FUA)) &amp;&amp;</span><br><span class="line">            (rq-&gt;cmd_flags &amp; REQ_FUA))</span><br><span class="line">            policy |= REQ_FSEQ_POSTFLUSH;</span><br><span class="line">    &#125;</span><br><span class="line">    return policy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="bio-software"><a href="#bio-software" class="headerlink" title="bio software"></a>bio software</h3><h4 id="split-sam-file"><a href="#split-sam-file" class="headerlink" title="split sam file"></a>split sam file</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ samtools view -H yourfile.bam &gt; header</span><br><span class="line">$ samtools view yourfile.bam | <span class="built_in">split</span> - yourprefix -l 8000000 --filter=<span class="string">&#x27;cat header - &gt; $FILE.sam&#x27;</span></span><br><span class="line">or</span><br><span class="line">$ samtools view yourfile.bam | <span class="built_in">split</span> - yourprefix -l 8000000 --filter=<span class="string">&#x27;cat header - | samtools view -b - &gt; $FILE.bam&#x27;</span> </span><br><span class="line"></span><br><span class="line">$ samtools <span class="built_in">sort</span> -O BAM | samtools index - sorted.bam.bai</span><br><span class="line"></span><br><span class="line">or </span><br><span class="line">time (/root/samtools-1.18/samtools view --threads 8 -bS 953ae304f4f5a971.sam | /root/samtools-1.18/samtools view --threads 4 -h -  | /root/samtools-1.18/samtools view --threads 8 -bS -  | /root/samtools-1.18/samtools view --threads 4 -h - | /root/samtools-1.18/samtools view --threads 8 -bS -  | /root/samtools-1.18/samtools view --threads 4 -h - | /root/samtools-1.18/samtools  <span class="built_in">sort</span> --threads 8 -O BAM - | /root/samtools-1.18/samtools <span class="built_in">stat</span> -d -s --threads 8 -&gt; /dev/null)</span><br></pre></td></tr></table></figure>

<h3 id="SPDK-benchmark"><a href="#SPDK-benchmark" class="headerlink" title="SPDK benchmark"></a><a target="_blank" rel="noopener" href="https://github.com/spdk/spdk/issues/661">SPDK benchmark</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pre-condition the ssd using:</span><br><span class="line"> ./perf /dev/nvme0n1 -q 32 -s 131072 -w write -t 1200</span><br><span class="line"><span class="keyword">for</span> aio run scripts as:</span><br><span class="line"><span class="keyword">for</span> QD <span class="keyword">in</span> 1 2 4 8 16 32 64 128 256</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sync</span>; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;QD=<span class="variable">$&#123;QD&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    ./perf /dev/nvme0n1 -L -q <span class="variable">$QD</span> -s 4096 -w randread -t 600 &gt; aio_QD<span class="variable">$&#123;QD&#125;</span>.<span class="built_in">log</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> spdk nvme driver, run:</span><br><span class="line"><span class="keyword">for</span> QD <span class="keyword">in</span> 1 2 4 8 16 32 64 128 256</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sync</span>; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;QD=<span class="variable">$&#123;QD&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    ./perf -L -q <span class="variable">$&#123;QD&#125;</span> -s 4096 -w randread -r <span class="string">&#x27;trtype:PCIe traddr:0000:01:00.0&#x27;</span> -t 600 &gt; spdk_QD<span class="variable">$&#123;QD&#125;</span>.<span class="built_in">log</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ sudo HUGE_EVEN_ALLOC=<span class="built_in">yes</span> NRHUGE=32768  DRIVER_OVERRIDE=vfio-pci ./setup.sh</span><br></pre></td></tr></table></figure>



  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#benchmark-setting"><span class="toc-number">1.</span> <span class="toc-text">benchmark setting</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jemalloc-TCMalloc"><span class="toc-number">2.</span> <span class="toc-text">Jemalloc TCMalloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calculate-upload-download-speed-by-ping"><span class="toc-number">3.</span> <span class="toc-text">calculate upload&#x2F;download speed by ping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stress-ng"><span class="toc-number">4.</span> <span class="toc-text">stress-ng</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openssl"><span class="toc-number">5.</span> <span class="toc-text">openssl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bash"><span class="toc-number">6.</span> <span class="toc-text">bash</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#posgresql"><span class="toc-number"></span> <span class="toc-text">posgresql</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sysbech"><span class="toc-number">1.</span> <span class="toc-text">sysbech</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#test-mysql-mariadb-posgresql"><span class="toc-number">1.1.</span> <span class="toc-text">test mysql&#x2F;mariadb&#x2F;posgresql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#install"><span class="toc-number">1.2.</span> <span class="toc-text">install</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis"><span class="toc-number">2.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linpack-for-x86"><span class="toc-number">3.</span> <span class="toc-text">Linpack for x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AVX"><span class="toc-number">4.</span> <span class="toc-text">AVX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP"><span class="toc-number">5.</span> <span class="toc-text">UDP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RFC6349-TCP-benchmark"><span class="toc-number">6.</span> <span class="toc-text">RFC6349 TCP benchmark</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pkggen-kernel-mode"><span class="toc-number">7.</span> <span class="toc-text">pkggen kernel mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nc-test"><span class="toc-number">8.</span> <span class="toc-text">nc test</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iperf3"><span class="toc-number">9.</span> <span class="toc-text">iperf3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qperf"><span class="toc-number">10.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pktgen-DPDK"><span class="toc-number">11.</span> <span class="toc-text">Pktgen-DPDK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#netperf"><span class="toc-number">12.</span> <span class="toc-text">netperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sockperf"><span class="toc-number">13.</span> <span class="toc-text">sockperf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fio-test-multiple-nodes"><span class="toc-number">14.</span> <span class="toc-text">fio test multiple nodes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#NVIDIA-GPU-Direct-Storage"><span class="toc-number">14.1.</span> <span class="toc-text">NVIDIA GPU Direct Storage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-softlock-and-hardlock-in-kernel"><span class="toc-number">15.</span> <span class="toc-text">test softlock and hardlock in kernel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ab"><span class="toc-number">16.</span> <span class="toc-text">ab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoCEv2-benchmark"><span class="toc-number">17.</span> <span class="toc-text">RoCEv2 benchmark</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rping"><span class="toc-number">17.1.</span> <span class="toc-text">rping</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ibv-rc-pingpong"><span class="toc-number">17.2.</span> <span class="toc-text">ibv_rc_pingpong</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#qperf-1"><span class="toc-number">17.3.</span> <span class="toc-text">qperf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#perftest"><span class="toc-number">17.4.</span> <span class="toc-text">perftest</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MEM"><span class="toc-number">18.</span> <span class="toc-text">MEM</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lmbench"><span class="toc-number">18.1.</span> <span class="toc-text">lmbench</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uarch-bench"><span class="toc-number">19.</span> <span class="toc-text">uarch-bench</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#contextswitch"><span class="toc-number">20.</span> <span class="toc-text">contextswitch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X-mem"><span class="toc-number">21.</span> <span class="toc-text">X-mem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dd"><span class="toc-number">22.</span> <span class="toc-text">dd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Emulate-simulate-some-errors-to-test-the-block-device"><span class="toc-number">23.</span> <span class="toc-text">Emulate&#x2F;simulate some errors to test the block device</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dm-delay"><span class="toc-number">23.1.</span> <span class="toc-text">dm-delay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dm-linear"><span class="toc-number">23.2.</span> <span class="toc-text">dm-linear</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dm-flakey"><span class="toc-number">24.</span> <span class="toc-text">dm-flakey</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Switch-off-quiet-mode"><span class="toc-number"></span> <span class="toc-text">Switch off quiet mode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MPI-test"><span class="toc-number"></span> <span class="toc-text">MPI test</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IOR"><span class="toc-number">1.</span> <span class="toc-text">IOR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDTEST"><span class="toc-number">2.</span> <span class="toc-text">MDTEST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stream"><span class="toc-number">3.</span> <span class="toc-text">stream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HPL-linpack"><span class="toc-number">4.</span> <span class="toc-text">HPL linpack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO500"><span class="toc-number">5.</span> <span class="toc-text">IO500</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Microsoft-virtual-client"><span class="toc-number">6.</span> <span class="toc-text">Microsoft virtual client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-SPEC-features-example"><span class="toc-number">7.</span> <span class="toc-text">test SPEC features example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fault-injection"><span class="toc-number"></span> <span class="toc-text">Fault-injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#overloading-test"><span class="toc-number"></span> <span class="toc-text">overloading test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#For-GPU"><span class="toc-number"></span> <span class="toc-text">For GPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenBLAS"><span class="toc-number">1.</span> <span class="toc-text">OpenBLAS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pthread-not-working"><span class="toc-number">1.1.</span> <span class="toc-text">pthread not working</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tiering-cache"><span class="toc-number"></span> <span class="toc-text">tiering cache</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bcache"><span class="toc-number">1.</span> <span class="toc-text">bcache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#test-LVM-cache-with-zfs"><span class="toc-number">2.</span> <span class="toc-text">test LVM cache with zfs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dm-cache"><span class="toc-number">3.</span> <span class="toc-text">dm-cache</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#data-integrity"><span class="toc-number"></span> <span class="toc-text">data integrity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#metadata-consistent"><span class="toc-number">1.</span> <span class="toc-text">metadata consistent</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mpiFileUtils"><span class="toc-number"></span> <span class="toc-text">mpiFileUtils</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NVME-SSD-Certification"><span class="toc-number"></span> <span class="toc-text">NVME SSD Certification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FIO-block-test-Third-Party"><span class="toc-number"></span> <span class="toc-text">FIO block test Third Party</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#becnhmark-workflow"><span class="toc-number"></span> <span class="toc-text">becnhmark workflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bio-software"><span class="toc-number"></span> <span class="toc-text">bio software</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#split-sam-file"><span class="toc-number">1.</span> <span class="toc-text">split sam file</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SPDK-benchmark"><span class="toc-number"></span> <span class="toc-text">SPDK benchmark</span></a>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/14/benchmark/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/14/benchmark/&text=benchmark"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/14/benchmark/&is_video=false&description=benchmark"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=benchmark&body=Check out this article: http://example.com/2022/11/14/benchmark/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/14/benchmark/&title=benchmark"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/14/benchmark/&name=benchmark&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/14/benchmark/&t=benchmark"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

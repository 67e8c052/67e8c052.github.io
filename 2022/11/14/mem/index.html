<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="HardwareHost Memory Buffer (HMB) HMB vs DRAM-less DRAM-less has the lower BW and OPS HMB has the more stable throughput for a long time    Linuxx86_64 5-level page tableLinear-address Translation Usin">
<meta property="og:type" content="article">
<meta property="og:title" content="memory">
<meta property="og:url" content="http://example.com/2022/11/14/mem/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="HardwareHost Memory Buffer (HMB) HMB vs DRAM-less DRAM-less has the lower BW and OPS HMB has the more stable throughput for a long time    Linuxx86_64 5-level page tableLinear-address Translation Usin">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/top-mem1.png">
<meta property="og:image" content="http://example.com/img/slabtop1.png">
<meta property="article:published_time" content="2022-11-14T07:35:11.000Z">
<meta property="article:modified_time" content="2022-11-15T00:49:21.122Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="mem">
<meta property="article:tag" content="memory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/top-mem1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>memory</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2022/11/14/issues/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/14/lsi/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/14/mem/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/14/mem/&text=memory"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/14/mem/&is_video=false&description=memory"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=memory&body=Check out this article: http://example.com/2022/11/14/mem/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/14/mem/&name=memory&description=&lt;h3 id=&#34;Hardware&#34;&gt;&lt;a href=&#34;#Hardware&#34; class=&#34;headerlink&#34; title=&#34;Hardware&#34;&gt;&lt;/a&gt;Hardware&lt;/h3&gt;&lt;h4 id=&#34;Host-Memory-Buffer-HMB&#34;&gt;&lt;a href=&#34;#Host-Memory-Buffer-HMB&#34; class=&#34;headerlink&#34; title=&#34;Host Memory Buffer (HMB)&#34;&gt;&lt;/a&gt;Host Memory Buffer (HMB)&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.virtium.com/knowledge-base/how-to-select-between-dram-vs-dram-less-ssds/&#34;&gt;HMB vs DRAM-less&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;DRAM-less has the lower BW and OPS&lt;/li&gt;
&lt;li&gt;HMB has the more stable throughput for a long time&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Linux&#34;&gt;&lt;a href=&#34;#Linux&#34; class=&#34;headerlink&#34; title=&#34;Linux&#34;&gt;&lt;/a&gt;Linux&lt;/h3&gt;&lt;h4 id=&#34;x86-64-5-level-page-table&#34;&gt;&lt;a href=&#34;#x86-64-5-level-page-table&#34; class=&#34;headerlink&#34; title=&#34;x86_64 5-level page table&#34;&gt;&lt;/a&gt;x86_64 5-level page table&lt;/h4&gt;&lt;p&gt;Linear-address Translation Using 5-level paging   &lt;/p&gt;
&lt;h4 id=&#34;slabtop&#34;&gt;&lt;a href=&#34;#slabtop&#34; class=&#34;headerlink&#34; title=&#34;slabtop&#34;&gt;&lt;/a&gt;slabtop&lt;/h4&gt;&lt;p&gt;In-kernel data structures cache&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#slab &amp;gt; 100M object&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /proc/slabinfo |awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;if($3*$4/1024/1024 &amp;gt; 100)&amp;#123;print $1,$3*$4/1024/1024&amp;#125; &amp;#125;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2554 x slabs&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56 x obj &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; a slab&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;total 8128 = 254 x 32, obj sieze=1K&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8128 x 1K = cache size = 8128K&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; 8128   7360  90%    1.00K    254        32      8128K kmalloc-1024&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;To free pagecache:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 1 &amp;gt; /proc/sys/vm/drop_caches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;To free dentries and inodes:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 2 &amp;gt; /proc/sys/vm/drop_caches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;To free pagecache, dentries and inodes:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 3 &amp;gt; /proc/sys/vm/drop_caches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#Got the free pages from buddyinfo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;sum=0;for(i=5;i&amp;lt;=NF;i++) sum+=$i*(2^(i-5))&amp;#125;;&amp;#123;total+=sum*4096/1024/1024&amp;#125;;&amp;#123;print $1 &amp;quot; &amp;quot; $2 &amp;quot; &amp;quot; $3 &amp;quot; &amp;quot; $4 &amp;quot;\t : &amp;quot; sum*4096/1024/1024 &amp;quot;M&amp;quot;&amp;#125; END &amp;#123;print &amp;quot;total\t\t\t : &amp;quot; total &amp;quot;M&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/buddyinfo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;All processes mem= $(grep Pss /proc/[1-9]*/smaps | awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;total+=$2&amp;#125;; END &amp;#123;print total&amp;#125;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RSS mem = awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;sum+=$2&amp;#125; END&amp;#123;print sum*4&amp;quot; KiB&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/[1-9]*/statm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#there are little diff result with python version, because awk and python is not the same application, malloc diff mem&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;slab size = awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;sum=sum+$3*$4;&amp;#125;END&amp;#123;print sum/1024&amp;quot; KiB&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/slabinfo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pagetable size = awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;$0~/PageTables/&amp;#123;print $2&amp;quot; KiB&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/meminfo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The RSS contains some of duplicate part, some share lib, if you want the real value, get it from pmap    &lt;/p&gt;
&lt;h5 id=&#34;slab-exhaust-all-memory-because-a-lot-of-scan&#34;&gt;&lt;a href=&#34;#slab-exhaust-all-memory-because-a-lot-of-scan&#34; class=&#34;headerlink&#34; title=&#34;slab exhaust all memory because a lot of scan&#34;&gt;&lt;/a&gt;slab exhaust all memory because a lot of scan&lt;/h5&gt;&lt;p&gt;&lt;img src=&#34;/img/top-mem1.png&#34;&gt;&lt;br&gt;Why Slab&amp;#x3D;24021820 kB (24GB)&lt;br&gt;slabtop&lt;br&gt;&lt;img src=&#34;/img/slabtop1.png&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;Single-process-memory&#34;&gt;&lt;a href=&#34;#Single-process-memory&#34; class=&#34;headerlink&#34; title=&#34;Single process memory&#34;&gt;&lt;/a&gt;Single process memory&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;       /proc/[pid]/statm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              Provides information about memory usage, measured &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; pages.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              The columns are:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  size       (1) total program size&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                             (same as VmSize &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; /proc/[pid]/status)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  resident   (2) resident &lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt; size&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                             (same as VmRSS &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; /proc/[pid]/status)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  shared     (3) number of resident shared pages (i.e., backed by a file)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                             (same as RssFile+RssShmem &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; /proc/[pid]/status)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  text       (4) text (code)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  lib        (5) library (unused since Linux 2.6; always 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  data       (6) data + stack&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  dt         (7) dirty pages (unused since Linux 2.6; always 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /proc/3760/statm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;400865 96456 37653 27355 0 157019 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Second field means res (resident)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pmap $(pgrep bash)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;There are some of share library &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; each resident&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;If you want get share library memory consumption.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/proc/[pid]/smaps (since Linux 2.6.14)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              This file shows memory consumption &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; each of the process&lt;span class=&#34;string&#34;&gt;&amp;#x27;s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;              mappings.  (The pmap(1) command displays similar information,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;              in a form that may be easier for parsing.)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;h4 id=&#34;Struct-page&#34;&gt;&lt;a href=&#34;#Struct-page&#34; class=&#34;headerlink&#34; title=&#34;Struct page&#34;&gt;&lt;/a&gt;Struct page&lt;/h4&gt;&lt;p&gt;page frame minimum unit. every page frame has a struct page to point&lt;br&gt;&lt;a href=&#34;https://stackoverflow.com/questions/34836806/how-to-get-physical-address-from-struct-page-in-linux-kernel&#34;&gt;struct page could mapping page frame to physical address&lt;/a&gt;&lt;br&gt;all page frame in the LUR list.&lt;br&gt;There are 2.3%(96&amp;#x2F;4096) usage in linux 2.6.32&lt;/p&gt;
&lt;h4 id=&#34;smem&#34;&gt;&lt;a href=&#34;#smem&#34; class=&#34;headerlink&#34; title=&#34;smem&#34;&gt;&lt;/a&gt;smem&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ smem -u&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User     Count     Swap      USS      PSS      RSS&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chrony       1        0      584      621     1316&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;rpc          1        0      604      633     1120&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -m&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -w&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -t&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -c &lt;span class=&#34;string&#34;&gt;&amp;quot;name user pss&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem --bar &lt;span class=&#34;variable&#34;&gt;$pid&lt;/span&gt; -c &lt;span class=&#34;string&#34;&gt;&amp;quot;pss uss&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&#34;Kernel-Memory-Leak-Detector&#34;&gt;&lt;a href=&#34;#Kernel-Memory-Leak-Detector&#34; class=&#34;headerlink&#34; title=&#34;Kernel Memory Leak Detector&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://www.kernel.org/doc/html/latest/dev-tools/kmemleak.html&#34;&gt;Kernel Memory Leak Detector&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ modprobe kmemleak-test&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; scan &amp;gt; /sys/kernel/debug/kmemleak&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /sys/kernel/debug/kmemleak&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## centos not enabled by defualt&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ grep CONFIG_DEBUG_KMEMLEAK /boot/config-4.18.0-305.el8.x86_64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ CONFIG_DEBUG_KMEMLEAK is not &lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&#34;zram&#34;&gt;&lt;a href=&#34;#zram&#34; class=&#34;headerlink&#34; title=&#34;zram&#34;&gt;&lt;/a&gt;&lt;a href=&#34;http://www.wowotech.net/memory_management/zram.html&#34;&gt;zram&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;CentOS 7 only work for lzo and the performance was not good enough  &lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; lz4 &amp;gt; /sys/block/zram0/comp_algorithm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-bash: &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt;: write error: Invalid argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /sys/block/zram0/comp_algorithm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[lzo]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ modprobe zram num_devices=2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 8589934592 &amp;gt; /sys/block/zram0/disksize&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 8589934592 &amp;gt; /sys/block/zram1/disksize&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ swapoff -a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ mkswap /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ mkswap /dev/zram1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ swapon /dev/zram0 /dev/zram1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;or&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ modprobe zram num_devices=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 68719476736 &amp;gt; /sys/block/zram0/disksize&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ mkfs.ext4 /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ tune2fs -m0 /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tune2fs 1.42.9 (28-Dec-2013)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Setting reserved blocks percentage to 0% (0 blocks)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## no compression function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ zpool create -o ashift=0 -o multihost=off -O compression=zstd -O primarycache=none -O secondarycache=none tank /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ sh zram.info&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Physical memory:     134,928,179,200 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Buffers and cache:       812,810,240 bytes /  0.6% of physical memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Unallocated:             825,503,744 bytes /  0.6% of physical memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Compressed:           19,495,145,472 bytes / 14.4% of physical memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Decompressed size:    33,168,183,296 bytes / 22.3% of decompressed memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Compression ratio: 1.701&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#!/bin/sh -eu&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TOTAL_DATA=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TOTAL_COMP=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HAS_ZRAM=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# Iterate through swap devices searching for compressed ones&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; NAME _; &lt;span class=&#34;keyword&#34;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# Filter zram swaps and let&amp;#x27;s hope your ordinary swap doesn&amp;#x27;t have&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# &amp;quot;zram&amp;quot; in its name :D&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$NAME&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        *zram*) ;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        *) &lt;span class=&#34;built_in&#34;&gt;continue&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;esac&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    DIR=/sys`udevadm info --query=path --name=&lt;span class=&#34;variable&#34;&gt;$NAME&lt;/span&gt;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    DATA=$(awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;print $1&amp;#125;&amp;#x27;&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$DIR&lt;/span&gt;/mm_stat)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    COMP=$(awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;print $3&amp;#125;&amp;#x27;&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$DIR&lt;/span&gt;/mm_stat)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    TOTAL_DATA=$((TOTAL_DATA + DATA))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    TOTAL_COMP=$((TOTAL_COMP + COMP))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    HAS_ZRAM=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;done&lt;/span&gt; &amp;lt;/proc/swaps&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# Extract physical memory in kibibytes and scale back to bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ MEM_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ FREE_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ BUF_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ CACHE_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &amp;lt;/proc/meminfo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/bin/printf &lt;span class=&#34;string&#34;&gt;&amp;quot;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Physical memory:   %&amp;#x27;17d bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Buffers and cache: %&amp;#x27;17d bytes / %4.1f%% of physical memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Unallocated:       %&amp;#x27;17d bytes / %4.1f%% of physical memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;/span&gt; `&lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;scale=6; 1024*&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;; 1024*(&lt;span class=&#34;variable&#34;&gt;$BUF_KIB&lt;/span&gt;+&lt;span class=&#34;variable&#34;&gt;$CACHE_KIB&lt;/span&gt;); 100*(&lt;span class=&#34;variable&#34;&gt;$BUF_KIB&lt;/span&gt;+&lt;span class=&#34;variable&#34;&gt;$CACHE_KIB&lt;/span&gt;)/&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;; 1024*&lt;span class=&#34;variable&#34;&gt;$FREE_KIB&lt;/span&gt;; 100*&lt;span class=&#34;variable&#34;&gt;$FREE_KIB&lt;/span&gt;/&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;&amp;quot;&lt;/span&gt;|bc`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;span class=&#34;variable&#34;&gt;$HAS_ZRAM&lt;/span&gt;&amp;quot;&lt;/span&gt;; &lt;span class=&#34;keyword&#34;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    /usr/bin/printf &lt;span class=&#34;string&#34;&gt;&amp;quot;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Compressed:        %&amp;#x27;17d bytes / %4.1f%% of physical memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Decompressed size: %&amp;#x27;17d bytes / %4.1f%% of decompressed memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Compression ratio: %.3f&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;/span&gt; `&lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;scale=6; &lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;; 100*&lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;/&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;/1024; &lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;; 100*&lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;/(1024*&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;-&lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;+&lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;); &lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;/&lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;&amp;quot;&lt;/span&gt;|bc`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Compressed:                        0 bytes / zram not in use&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;fi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&#34;Make-sure-the-ECC-work-in-Linux&#34;&gt;&lt;a href=&#34;#Make-sure-the-ECC-work-in-Linux&#34; class=&#34;headerlink&#34; title=&#34;Make sure the ECC work in Linux&#34;&gt;&lt;/a&gt;Make sure the ECC work in Linux&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ dmidecode -t memory  | grep -Ei &lt;span class=&#34;string&#34;&gt;&amp;#x27;error correction type&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Error Correction Type: Single-bit ECC&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ dmidecode -t memory  | grep -Ei &lt;span class=&#34;string&#34;&gt;&amp;#x27;error correction type&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Error Correction Type: Multi-bit ECC&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/14/mem/&t=memory"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hardware"><span class="toc-number">1.</span> <span class="toc-text">Hardware</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Host-Memory-Buffer-HMB"><span class="toc-number">1.1.</span> <span class="toc-text">Host Memory Buffer (HMB)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-64-5-level-page-table"><span class="toc-number">2.1.</span> <span class="toc-text">x86_64 5-level page table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#slabtop"><span class="toc-number">2.2.</span> <span class="toc-text">slabtop</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#slab-exhaust-all-memory-because-a-lot-of-scan"><span class="toc-number">2.2.1.</span> <span class="toc-text">slab exhaust all memory because a lot of scan</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Single-process-memory"><span class="toc-number">2.3.</span> <span class="toc-text">Single process memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Struct-page"><span class="toc-number">2.4.</span> <span class="toc-text">Struct page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#smem"><span class="toc-number">2.5.</span> <span class="toc-text">smem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kernel-Memory-Leak-Detector"><span class="toc-number">2.6.</span> <span class="toc-text">Kernel Memory Leak Detector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zram"><span class="toc-number">2.7.</span> <span class="toc-text">zram</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Make-sure-the-ECC-work-in-Linux"><span class="toc-number">2.8.</span> <span class="toc-text">Make sure the ECC work in Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Monitor-ECC-error"><span class="toc-number">2.9.</span> <span class="toc-text">Monitor ECC error</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#From-OS"><span class="toc-number">2.9.1.</span> <span class="toc-text">From OS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#From-IPMI"><span class="toc-number">2.9.2.</span> <span class="toc-text">From IPMI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Export-from-OS"><span class="toc-number">2.9.3.</span> <span class="toc-text">Export from OS</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memory-fragment"><span class="toc-number">2.10.</span> <span class="toc-text">memory fragment</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#check-the-fragment"><span class="toc-number">2.10.1.</span> <span class="toc-text">check the fragment</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ZRAM"><span class="toc-number">2.11.</span> <span class="toc-text">ZRAM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numa"><span class="toc-number">2.12.</span> <span class="toc-text">numa</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage"><span class="toc-number">2.12.1.</span> <span class="toc-text">Soft lockup detected on a large NUMA system under a heavy memory usage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transparent-Huge-Page"><span class="toc-number">2.13.</span> <span class="toc-text">Transparent Huge Page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Use-hugetlbfs"><span class="toc-number">2.14.</span> <span class="toc-text">Use hugetlbfs</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#set-hugepage"><span class="toc-number">2.14.1.</span> <span class="toc-text">set hugepage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#free-hugepage"><span class="toc-number">2.14.2.</span> <span class="toc-text">free hugepage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memlock"><span class="toc-number">2.15.</span> <span class="toc-text">memlock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-pagesize"><span class="toc-number">2.16.</span> <span class="toc-text">get pagesize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memmap"><span class="toc-number">2.17.</span> <span class="toc-text">memmap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mapping-x2F-dev-x2F-pmemX-can-be-used-to-create-a-DAX-filesystem"><span class="toc-number">2.17.1.</span> <span class="toc-text">mapping &#x2F;dev&#x2F;pmemX can be used to create a DAX filesystem</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Benchmark-mem-by-perf"><span class="toc-number">2.18.</span> <span class="toc-text">Benchmark mem by perf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dirty-page"><span class="toc-number">2.19.</span> <span class="toc-text">dirty page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#meminfo"><span class="toc-number">2.20.</span> <span class="toc-text">meminfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x2F-proc-x2F-vmstat"><span class="toc-number">2.21.</span> <span class="toc-text">&#x2F;proc&#x2F;vmstat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OOM"><span class="toc-number">2.22.</span> <span class="toc-text">OOM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show-the-swap"><span class="toc-number">2.23.</span> <span class="toc-text">show the swap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#valgrind"><span class="toc-number">2.24.</span> <span class="toc-text">valgrind</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vmtouch"><span class="toc-number">2.25.</span> <span class="toc-text">vmtouch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#java-malloc"><span class="toc-number">2.26.</span> <span class="toc-text">java malloc</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        memory
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-14T07:35:11.000Z" itemprop="datePublished">2022-11-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Buffer/">Buffer</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/mem/" rel="tag">mem</a>, <a class="tag-link-link" href="/tags/memory/" rel="tag">memory</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h3><h4 id="Host-Memory-Buffer-HMB"><a href="#Host-Memory-Buffer-HMB" class="headerlink" title="Host Memory Buffer (HMB)"></a>Host Memory Buffer (HMB)</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.virtium.com/knowledge-base/how-to-select-between-dram-vs-dram-less-ssds/">HMB vs DRAM-less</a><ul>
<li>DRAM-less has the lower BW and OPS</li>
<li>HMB has the more stable throughput for a long time</li>
</ul>
</li>
</ul>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="x86-64-5-level-page-table"><a href="#x86-64-5-level-page-table" class="headerlink" title="x86_64 5-level page table"></a>x86_64 5-level page table</h4><p>Linear-address Translation Using 5-level paging   </p>
<h4 id="slabtop"><a href="#slabtop" class="headerlink" title="slabtop"></a>slabtop</h4><p>In-kernel data structures cache</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#slab &gt; 100M object</span></span><br><span class="line">$ <span class="built_in">cat</span> /proc/slabinfo |awk <span class="string">&#x27;&#123;if($3*$4/1024/1024 &gt; 100)&#123;print $1,$3*$4/1024/1024&#125; &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">2554 x slabs</span><br><span class="line">56 x obj <span class="keyword">in</span> a slab</span><br><span class="line">total 8128 = 254 x 32, obj sieze=1K</span><br><span class="line">8128 x 1K = cache size = 8128K</span><br><span class="line">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME</span><br><span class="line"> 8128   7360  90%    1.00K    254        32      8128K kmalloc-1024</span><br><span class="line"></span><br><span class="line">To free pagecache:</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">To free dentries and inodes:</span><br><span class="line">$ <span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">To free pagecache, dentries and inodes:</span><br><span class="line">$ <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line"><span class="comment">#Got the free pages from buddyinfo</span></span><br><span class="line">$ awk <span class="string">&#x27;&#123;sum=0;for(i=5;i&lt;=NF;i++) sum+=$i*(2^(i-5))&#125;;&#123;total+=sum*4096/1024/1024&#125;;&#123;print $1 &quot; &quot; $2 &quot; &quot; $3 &quot; &quot; $4 &quot;\t : &quot; sum*4096/1024/1024 &quot;M&quot;&#125; END &#123;print &quot;total\t\t\t : &quot; total &quot;M&quot;&#125;&#x27;</span> /proc/buddyinfo</span><br><span class="line"></span><br><span class="line">All processes mem= $(grep Pss /proc/[1-9]*/smaps | awk <span class="string">&#x27;&#123;total+=$2&#125;; END &#123;print total&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">RSS mem = awk <span class="string">&#x27;&#123;sum+=$2&#125; END&#123;print sum*4&quot; KiB&quot;&#125;&#x27;</span> /proc/[1-9]*/statm</span><br><span class="line"><span class="comment">#there are little diff result with python version, because awk and python is not the same application, malloc diff mem</span></span><br><span class="line"></span><br><span class="line">slab size = awk <span class="string">&#x27;&#123;sum=sum+$3*$4;&#125;END&#123;print sum/1024&quot; KiB&quot;&#125;&#x27;</span> /proc/slabinfo</span><br><span class="line"></span><br><span class="line">pagetable size = awk <span class="string">&#x27;$0~/PageTables/&#123;print $2&quot; KiB&quot;&#125;&#x27;</span> /proc/meminfo</span><br></pre></td></tr></table></figure>
<p>The RSS contains some of duplicate part, some share lib, if you want the real value, get it from pmap    </p>
<h5 id="slab-exhaust-all-memory-because-a-lot-of-scan"><a href="#slab-exhaust-all-memory-because-a-lot-of-scan" class="headerlink" title="slab exhaust all memory because a lot of scan"></a>slab exhaust all memory because a lot of scan</h5><p><img src="/img/top-mem1.png"><br>Why Slab&#x3D;24021820 kB (24GB)<br>slabtop<br><img src="/img/slabtop1.png"></p>
<h4 id="Single-process-memory"><a href="#Single-process-memory" class="headerlink" title="Single process memory"></a>Single process memory</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">       /proc/[pid]/statm</span><br><span class="line">              Provides information about memory usage, measured <span class="keyword">in</span> pages.</span><br><span class="line">              The columns are:</span><br><span class="line"></span><br><span class="line">                  size       (1) total program size</span><br><span class="line">                             (same as VmSize <span class="keyword">in</span> /proc/[pid]/status)</span><br><span class="line">                  resident   (2) resident <span class="built_in">set</span> size</span><br><span class="line">                             (same as VmRSS <span class="keyword">in</span> /proc/[pid]/status)</span><br><span class="line">                  shared     (3) number of resident shared pages (i.e., backed by a file)</span><br><span class="line">                             (same as RssFile+RssShmem <span class="keyword">in</span> /proc/[pid]/status)</span><br><span class="line">                  text       (4) text (code)</span><br><span class="line">                  lib        (5) library (unused since Linux 2.6; always 0)</span><br><span class="line">                  data       (6) data + stack</span><br><span class="line">                  dt         (7) dirty pages (unused since Linux 2.6; always 0)</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/3760/statm</span><br><span class="line">400865 96456 37653 27355 0 157019 0</span><br><span class="line"></span><br><span class="line">Second field means res (resident)</span><br><span class="line">pmap $(pgrep bash)</span><br><span class="line"></span><br><span class="line">There are some of share library <span class="keyword">in</span> each resident</span><br><span class="line"></span><br><span class="line">If you want get share library memory consumption.</span><br><span class="line">/proc/[pid]/smaps (since Linux 2.6.14)</span><br><span class="line">              This file shows memory consumption <span class="keyword">for</span> each of the process<span class="string">&#x27;s</span></span><br><span class="line"><span class="string">              mappings.  (The pmap(1) command displays similar information,</span></span><br><span class="line"><span class="string">              in a form that may be easier for parsing.)</span></span><br></pre></td></tr></table></figure>


<h4 id="Struct-page"><a href="#Struct-page" class="headerlink" title="Struct page"></a>Struct page</h4><p>page frame minimum unit. every page frame has a struct page to point<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34836806/how-to-get-physical-address-from-struct-page-in-linux-kernel">struct page could mapping page frame to physical address</a><br>all page frame in the LUR list.<br>There are 2.3%(96&#x2F;4096) usage in linux 2.6.32</p>
<h4 id="smem"><a href="#smem" class="headerlink" title="smem"></a>smem</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ smem -u</span><br><span class="line">User     Count     Swap      USS      PSS      RSS</span><br><span class="line">chrony       1        0      584      621     1316</span><br><span class="line">rpc          1        0      604      633     1120</span><br><span class="line">...</span><br><span class="line">$ smem -m</span><br><span class="line">$ smem -w</span><br><span class="line">$ smem -t</span><br><span class="line">$ smem -c <span class="string">&quot;name user pss&quot;</span></span><br><span class="line">$ smem --bar <span class="variable">$pid</span> -c <span class="string">&quot;pss uss&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Kernel-Memory-Leak-Detector"><a href="#Kernel-Memory-Leak-Detector" class="headerlink" title="Kernel Memory Leak Detector"></a><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/dev-tools/kmemleak.html">Kernel Memory Leak Detector</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe kmemleak-test</span><br><span class="line">$ <span class="built_in">echo</span> scan &gt; /sys/kernel/debug/kmemleak</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/kmemleak</span><br><span class="line"></span><br><span class="line"><span class="comment">## centos not enabled by defualt</span></span><br><span class="line">$ grep CONFIG_DEBUG_KMEMLEAK /boot/config-4.18.0-305.el8.x86_64</span><br><span class="line">$ CONFIG_DEBUG_KMEMLEAK is not <span class="built_in">set</span></span><br></pre></td></tr></table></figure>

<h4 id="zram"><a href="#zram" class="headerlink" title="zram"></a><a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/zram.html">zram</a></h4><p>CentOS 7 only work for lzo and the performance was not good enough  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> lz4 &gt; /sys/block/zram0/comp_algorithm</span><br><span class="line">-bash: <span class="built_in">echo</span>: write error: Invalid argument</span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/zram0/comp_algorithm</span><br><span class="line">[lzo]</span><br><span class="line"></span><br><span class="line">$ modprobe zram num_devices=2</span><br><span class="line">$ <span class="built_in">echo</span> 8589934592 &gt; /sys/block/zram0/disksize</span><br><span class="line">$ <span class="built_in">echo</span> 8589934592 &gt; /sys/block/zram1/disksize</span><br><span class="line">$ swapoff -a</span><br><span class="line">$ mkswap /dev/zram0</span><br><span class="line">$ mkswap /dev/zram1</span><br><span class="line">$ swapon /dev/zram0 /dev/zram1</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">$ modprobe zram num_devices=1</span><br><span class="line">$ <span class="built_in">echo</span> 68719476736 &gt; /sys/block/zram0/disksize</span><br><span class="line">$ mkfs.ext4 /dev/zram0</span><br><span class="line">$ tune2fs -m0 /dev/zram0</span><br><span class="line">tune2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Setting reserved blocks percentage to 0% (0 blocks)</span><br><span class="line"><span class="comment">## no compression function</span></span><br><span class="line">$ zpool create -o ashift=0 -o multihost=off -O compression=zstd -O primarycache=none -O secondarycache=none tank /dev/zram0</span><br><span class="line"></span><br><span class="line">$ sh zram.info</span><br><span class="line">Physical memory:     134,928,179,200 bytes</span><br><span class="line">Buffers and cache:       812,810,240 bytes /  0.6% of physical memory</span><br><span class="line">Unallocated:             825,503,744 bytes /  0.6% of physical memory</span><br><span class="line">Compressed:           19,495,145,472 bytes / 14.4% of physical memory</span><br><span class="line">Decompressed size:    33,168,183,296 bytes / 22.3% of decompressed memory</span><br><span class="line">Compression ratio: 1.701</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/sh -eu</span></span><br><span class="line"></span><br><span class="line">TOTAL_DATA=0</span><br><span class="line">TOTAL_COMP=0</span><br><span class="line">HAS_ZRAM=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Iterate through swap devices searching for compressed ones</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> NAME _; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Filter zram swaps and let&#x27;s hope your ordinary swap doesn&#x27;t have</span></span><br><span class="line">    <span class="comment"># &quot;zram&quot; in its name :D</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$NAME</span> <span class="keyword">in</span></span><br><span class="line">        *zram*) ;;</span><br><span class="line">        *) <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    DIR=/sys`udevadm info --query=path --name=<span class="variable">$NAME</span>`</span><br><span class="line">    DATA=$(awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="variable">$DIR</span>/mm_stat)</span><br><span class="line">    COMP=$(awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> <span class="variable">$DIR</span>/mm_stat)</span><br><span class="line">    TOTAL_DATA=$((TOTAL_DATA + DATA))</span><br><span class="line">    TOTAL_COMP=$((TOTAL_COMP + COMP))</span><br><span class="line">    HAS_ZRAM=1</span><br><span class="line"><span class="keyword">done</span> &lt;/proc/swaps</span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract physical memory in kibibytes and scale back to bytes</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span> _ MEM_KIB _</span><br><span class="line">    <span class="built_in">read</span> _ FREE_KIB _</span><br><span class="line">    <span class="built_in">read</span> _ BUF_KIB _</span><br><span class="line">    <span class="built_in">read</span> _ CACHE_KIB _</span><br><span class="line">&#125; &lt;/proc/meminfo</span><br><span class="line"></span><br><span class="line">/usr/bin/printf <span class="string">&quot;\</span></span><br><span class="line"><span class="string">Physical memory:   %&#x27;17d bytes</span></span><br><span class="line"><span class="string">Buffers and cache: %&#x27;17d bytes / %4.1f%% of physical memory</span></span><br><span class="line"><span class="string">Unallocated:       %&#x27;17d bytes / %4.1f%% of physical memory</span></span><br><span class="line"><span class="string">&quot;</span> `<span class="built_in">echo</span> <span class="string">&quot;scale=6; 1024*<span class="variable">$MEM_KIB</span>; 1024*(<span class="variable">$BUF_KIB</span>+<span class="variable">$CACHE_KIB</span>); 100*(<span class="variable">$BUF_KIB</span>+<span class="variable">$CACHE_KIB</span>)/<span class="variable">$MEM_KIB</span>; 1024*<span class="variable">$FREE_KIB</span>; 100*<span class="variable">$FREE_KIB</span>/<span class="variable">$MEM_KIB</span>&quot;</span>|bc`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$HAS_ZRAM</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/printf <span class="string">&quot;\</span></span><br><span class="line"><span class="string">Compressed:        %&#x27;17d bytes / %4.1f%% of physical memory</span></span><br><span class="line"><span class="string">Decompressed size: %&#x27;17d bytes / %4.1f%% of decompressed memory</span></span><br><span class="line"><span class="string">Compression ratio: %.3f</span></span><br><span class="line"><span class="string">&quot;</span> `<span class="built_in">echo</span> <span class="string">&quot;scale=6; <span class="variable">$TOTAL_COMP</span>; 100*<span class="variable">$TOTAL_COMP</span>/<span class="variable">$MEM_KIB</span>/1024; <span class="variable">$TOTAL_DATA</span>; 100*<span class="variable">$TOTAL_DATA</span>/(1024*<span class="variable">$MEM_KIB</span>-<span class="variable">$TOTAL_COMP</span>+<span class="variable">$TOTAL_DATA</span>); <span class="variable">$TOTAL_DATA</span>/<span class="variable">$TOTAL_COMP</span>&quot;</span>|bc`</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Compressed:                        0 bytes / zram not in use&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h4 id="Make-sure-the-ECC-work-in-Linux"><a href="#Make-sure-the-ECC-work-in-Linux" class="headerlink" title="Make sure the ECC work in Linux"></a>Make sure the ECC work in Linux</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmidecode -t memory  | grep -Ei <span class="string">&#x27;error correction type&#x27;</span></span><br><span class="line">        Error Correction Type: Single-bit ECC</span><br><span class="line">$ dmidecode -t memory  | grep -Ei <span class="string">&#x27;error correction type&#x27;</span></span><br><span class="line">        Error Correction Type: Multi-bit ECC</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h4 id="Monitor-ECC-error"><a href="#Monitor-ECC-error" class="headerlink" title="Monitor ECC error"></a>Monitor ECC error</h4><h5 id="From-OS"><a href="#From-OS" class="headerlink" title="From OS"></a>From OS</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Intel x86 scalable</span></span><br><span class="line">skx_edac</span><br><span class="line"></span><br><span class="line"><span class="comment">#Intel x86 E3</span></span><br><span class="line">ie31200-edac</span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers are loaded. 1 MC detected:</span><br><span class="line">  mc0:IE31200</span><br><span class="line"></span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers loaded. No memory controllers found</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ edac-util -v</span><br><span class="line">mc0: 0 Uncorrected Errors with no DIMM info</span><br><span class="line">mc0: 0 Corrected Errors with no DIMM info</span><br><span class="line">mc0: csrow0: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow0: mc<span class="comment">#0csrow#0channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow0: mc<span class="comment">#0csrow#0channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow1: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow1: mc<span class="comment">#0csrow#1channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow1: mc<span class="comment">#0csrow#1channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow2: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow2: mc<span class="comment">#0csrow#2channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow2: mc<span class="comment">#0csrow#2channel#1: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow3: 0 Uncorrected Errors</span><br><span class="line">mc0: csrow3: mc<span class="comment">#0csrow#3channel#0: 0 Corrected Errors</span></span><br><span class="line">mc0: csrow3: mc<span class="comment">#0csrow#3channel#1: 0 Corrected Errors</span></span><br><span class="line">edac-util: No errors to report.</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 7.7 not support Xeon E2000, the kernel merge the patch at 2019-06, maybe wait CentOS 7.8</span></span><br><span class="line"><span class="comment">#Intel x86 E2000</span></span><br><span class="line">ie31200-edac</span><br><span class="line">$ edac-util -vs</span><br><span class="line">edac-util: EDAC drivers loaded. No memory controllers found</span><br></pre></td></tr></table></figure>
<h5 id="From-IPMI"><a href="#From-IPMI" class="headerlink" title="From IPMI"></a>From IPMI</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipmitool sel elist</span><br></pre></td></tr></table></figure>

<h5 id="Export-from-OS"><a href="#Export-from-OS" class="headerlink" title="Export from OS"></a>Export from OS</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg -T |  grep -Ei <span class="string">&quot;Err.*bit ECC&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor multiple bit</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/devices/system/edac/mc/mc*/[u,c]e_count | <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span> [[ ! <span class="variable">$line</span> -eq 0 ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Got DRAM ecc error&quot;</span> &amp;&amp; <span class="built_in">exit</span> 2; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>


<h4 id="memory-fragment"><a href="#memory-fragment" class="headerlink" title="memory fragment"></a>memory fragment</h4><p>kswapd high cpu usage in some of not enough memory case<br>reslove the issue temporary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">sar -rB 2 <span class="comment"># check system vm status</span></span><br><span class="line"></span><br><span class="line">sar -r 2</span><br><span class="line">               ------------------free --&gt; malloc --&gt; release or reclaim</span><br><span class="line">               |</span><br><span class="line">03:32:14 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">03:32:26 PM 122884328   8881472      6.74      1968     68528 118503440     88.53   5951984     60828         4</span><br><span class="line">03:33:22 PM  29706588 102059212     77.46      1968     75940 118507844     88.53  98904256     67008         0</span><br><span class="line">03:33:30 PM 128777516   2988284      2.27      1968     75940    282000      0.21     63112     66988         0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/compact_memory</span><br><span class="line"><span class="comment">#Available only when CONFIG_COMPACTION is set. When 1 is written to the file, all zones are compacted such that free memory is available in contiguous blocks where possible</span></span><br><span class="line"><span class="comment">#reduce memory compaction ratio</span></span><br><span class="line"><span class="built_in">echo</span> 1000 &gt;  /proc/sys/vm/extfrag_threshold <span class="comment"># 0~1000 ,1000 means the minimum trigger memory compaction operation, it means kernel memory is required to be a contiguous block of a certain size. The kernel memory may be all consumed or fragmented, hence why a contiguous block could not be allocated.</span></span><br><span class="line"></span><br><span class="line">This parameter affects whether the kernel will compact memory or direct reclaim to satisfy a high-order allocation.</span><br><span class="line">The extfrag/extfrag_index file <span class="keyword">in</span> debugfs shows what the fragmentation index <span class="keyword">for</span> each order is <span class="keyword">in</span> each zone <span class="keyword">in</span> the system.</span><br><span class="line">Values tending towards 0 imply allocations would fail due to lack of memory, values towards 1000 imply failures are due to fragmentation and -1 implies that the allocation will succeed as long as watermarks are met.</span><br><span class="line"></span><br><span class="line">The kernel will not compact memory <span class="keyword">in</span> a zone <span class="keyword">if</span> the fragmentation index is &lt;= extfrag_threshold. The default value is 500</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Index is between 0 and 1000</span><br><span class="line">         *</span><br><span class="line">         * 0 =&gt; allocation would fail due to lack of memory</span><br><span class="line">         * 1000 =&gt; allocation would fail due to fragmentation</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">sar -r -B -S 2</span><br><span class="line">Average:     pgpgin/s pgpgout/s   fault/s  majflt/s  pgfree/s pgscank/s pgscand/s pgsteal/s    %vmeff</span><br><span class="line">Average:         0.00      8.92 3163363.44      0.00 177917.30      0.00  39200.92  39093.80     99.73</span><br><span class="line"></span><br><span class="line">Average:    kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty</span><br><span class="line">Average:     17337774 510492746     96.72    140728 342605322 133693955     24.93 266439056 230275118    344656</span><br><span class="line"></span><br><span class="line">Average:    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad</span><br><span class="line">Average:      8075700    312904      3.73      1948      0.62</span><br><span class="line"></span><br><span class="line">pgscank/s: Number of pages scanned by the kswapd daemon per second.</span><br><span class="line">pgscand/s: Number of pages scanned directly per second.</span><br><span class="line">%vmeff = pgsteal / pgscanin, In the kswapd scan pages(pagecache and swapcache), how many page banned and re-use the pages ratio</span><br><span class="line">pgsteal/s: Number of pages the system has reclaimed from cache (pagecache and swapcache)  per  second  to  satisfy  its  memory demands.</span><br><span class="line"></span><br><span class="line">Linux memory allocate base the buddy algorithm, When allocate a huge page and no free, trigger direct reclaim or memory compaction</span><br></pre></td></tr></table></figure>

<h5 id="check-the-fragment"><a href="#check-the-fragment" class="headerlink" title="check the fragment"></a>check the fragment</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/kernel/debug/extfrag/unusable_index</span><br><span class="line">Node 0, zone      DMA 0.000 0.000 0.000 0.000 0.000 0.008 0.016 0.032 0.032 0.097 0.226</span><br><span class="line">Node 0, zone    DMA32 0.000 0.000 0.039 0.236 0.328 0.353 0.365 0.376 0.390 0.406 0.414</span><br><span class="line">Node 0, zone   Normal 0.000 0.003 0.011 0.020 0.048 0.091 0.152 0.205 0.258 0.383 1.000</span><br><span class="line">Node 1, zone   Normal 0.000 0.001 0.007 0.008 0.044 0.115 0.180 0.240 0.383 0.544 0.611</span><br><span class="line">unusable index=(free pagesfree blocks suitable)/free pages</span><br><span class="line">        /*</span><br><span class="line">         * Index should be a value between 0 and 1. Return a value to 3</span><br><span class="line">         * decimal places.</span><br><span class="line">         *</span><br><span class="line">         * 0 =&gt; no fragmentation</span><br><span class="line">         * 1 =&gt; high fragmentation</span><br><span class="line">         */</span><br><span class="line"></span><br><span class="line">$ numactl --hardware; <span class="built_in">cat</span> /sys/kernel/debug/extfrag/extfrag_index /proc/pagetypeinfo /proc/buddyinfo</span><br><span class="line">        /*</span><br><span class="line">         * Index is between 0 and 1 so <span class="built_in">return</span> within 3 decimal places</span><br><span class="line">         *</span><br><span class="line">         * 0 =&gt; allocation would fail due to lack of memory</span><br><span class="line">         * 1 =&gt; allocation would fail due to fragmentation</span><br><span class="line">         */</span><br><span class="line">        <span class="keyword">if</span> (info-&gt;free_blocks_suitable) //enough mem</span><br><span class="line">                <span class="built_in">return</span> -1000;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Each zone has the watermark, <span class="built_in">cat</span> /proc/zoneinfo</span><br><span class="line"> |</span><br><span class="line"> |                availlable memory back to high watermark level, swapd goes <span class="built_in">sleep</span></span><br><span class="line"> |                                   |    .</span><br><span class="line"> |      kswapd work up               |   .</span><br><span class="line"> |    .     |      direct reclam     | ..</span><br><span class="line">f|     .    |            |           v.</span><br><span class="line">r|------.----------------------------.----------- high watermark</span><br><span class="line">e|       .  |            |          .</span><br><span class="line">e|        . |            |         .</span><br><span class="line"> |         .V            |        .</span><br><span class="line">p|----------.--------------------.--------------- low watermark</span><br><span class="line">a|            ......     |    ..</span><br><span class="line">g|                ^ ..   |  ..</span><br><span class="line">e|                |   .. v..</span><br><span class="line">s|-----------------------.----------------------- min watermark</span><br><span class="line"> |                |</span><br><span class="line"> |                |</span><br><span class="line"> ------------------------------------------------</span><br><span class="line">                 |</span><br><span class="line">           kswapd running still rate of allocation is high</span><br><span class="line"></span><br><span class="line">https://farseerfc.me/zhs/followup-about-swap.html</span><br><span class="line"></span><br><span class="line">$ grep <span class="string">&quot;pages free&quot;</span> -B 1 -A  6 /proc/zoneinfo</span><br><span class="line">      nr_kernel_stack 10512</span><br><span class="line">  pages free     3975</span><br><span class="line">        min      17</span><br><span class="line">        low      21</span><br><span class="line">        high     25</span><br><span class="line">        spanned  4095</span><br><span class="line">        present  3996</span><br><span class="line">        managed  3975</span><br><span class="line">--</span><br><span class="line">Node 0, zone    DMA32</span><br><span class="line">  pages free     297942</span><br><span class="line">        min      1242</span><br><span class="line">        low      1552</span><br><span class="line">        high     1862</span><br><span class="line">        spanned  1044480</span><br><span class="line">        present  314699</span><br><span class="line">        managed  298315</span><br><span class="line">--</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">  pages free     2075318</span><br><span class="line">        min      15635</span><br><span class="line">        low      19543</span><br><span class="line">        high     23451</span><br><span class="line">        spanned  3596288</span><br><span class="line">        present  3596288</span><br><span class="line">        managed  3520874</span><br><span class="line"></span><br><span class="line">$ sysctl vm.min_free_kbytes vm.watermark_scale_factor vm.watermark_boost_factor</span><br><span class="line">vm.min_free_kbytes = 67584</span><br><span class="line">vm.watermark_scale_factor = 10</span><br><span class="line">vm.watermark_boost_factor = 15000</span><br><span class="line"></span><br><span class="line">spanned = (4095 + 1044480 + 3596288)*4/1024 = 18144 MiB</span><br><span class="line">present = (3996 + 314699 + 3596288)*4/1024 = 15292.9 MiB</span><br><span class="line">free    = (3975 + 297942 + 2075318)*4/1024 = 9286.07 MiB</span><br><span class="line">high    = (25 + 1862 + 23451)*4/1024 = 98.97 MiB</span><br><span class="line">low     = (21 + 1552 + 19543)*4/1024 = 82.48 MiB</span><br><span class="line">min     = (17 + 1242 + 15635)*4/1024 = 65.99 MiB</span><br><span class="line"></span><br><span class="line">wmark_high * watermark_boost_factor / 10000</span><br><span class="line"></span><br><span class="line">watermark_scale_factor:</span><br><span class="line">The unit is <span class="keyword">in</span> fractions of 10,000. The default value of 10 means the distances between watermarks are 0.1% of the available memory <span class="keyword">in</span> the node/system. The maximum value is 1000, or 10% of memory.</span><br><span class="line"></span><br><span class="line">Node 0 DMA min = 17 low = 21 high = 25; present = 3996 ; 3996*0.001=3.997 = 4, 17+4 = 21, 21 + 4 = 25</span><br><span class="line"></span><br><span class="line"><span class="comment">##there is the different algorithms in the low memory system</span></span><br><span class="line">cgroup v2</span><br><span class="line">memory.min</span><br><span class="line">memory.low</span><br><span class="line">memory.high</span><br><span class="line">memory.max</span><br><span class="line">memory.swap.high</span><br><span class="line">memory.swap.max</span><br><span class="line">kernel parameter systemd.unified_cgroup_hierarchy=1</span><br><span class="line"></span><br><span class="line"><span class="comment">#limit mem</span></span><br><span class="line">$ systemctl edit user@1000.service</span><br><span class="line">[Service]</span><br><span class="line">Delegate=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> ~/.config/systemd/user/limit-mem.slice</span><br><span class="line">[Slice]</span><br><span class="line">MemoryHigh=3G</span><br><span class="line">MemoryMax=4G</span><br><span class="line">MemorySwapMax=2G</span><br><span class="line"></span><br><span class="line">$ systemd-run --user --slice=limit-mem.slice --shell</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">type</span> limit-mem</span><br><span class="line">limit-mem is an <span class="built_in">alias</span> <span class="keyword">for</span> /usr/bin/time systemd-run --user --pty --same-dir --<span class="built_in">wait</span> --collect --slice=limit-mem.slice</span><br><span class="line">$ limit-mem <span class="built_in">cp</span> some-large-file dest/</span><br><span class="line"></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class="line">node 0 size: 257436 MB</span><br><span class="line">node 0 free: 3644 MB</span><br><span class="line">node 1 cpus: 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95</span><br><span class="line">node 1 size: 258023 MB</span><br><span class="line">node 1 free: 428 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10</span><br><span class="line">Node 0, zone      DMA -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000</span><br><span class="line">Node 0, zone    DMA32 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 -1.000 0.986 0.993</span><br><span class="line">Node 0, zone   Normal -1.000 -1.000 -1.000 -1.000 0.925 0.963 0.982 0.991 0.996 0.998 0.999</span><br><span class="line">Node 1, zone   Normal -1.000 -1.000 0.750 0.875 0.938 0.969 0.985 0.993 0.997 0.999 1.000</span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate <span class="built_in">type</span> at order       0      1      2      3      4      5      6      7      8      9     10</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>    Unmovable      1      0      1      1      1      1      1      0      1      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>  Reclaimable      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Movable      0      0      0      0      0      0      0      0      0      1      3</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone      DMA, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>    Unmovable    301   1638   1860      0   1252     75    303    228     15      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>  Reclaimable      0     24     13   1900   1473    399      2      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Movable   7829   8977   8590   6422   3501   1001     98      2      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone    DMA32, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>    Unmovable &gt;100000  64223   7587      3      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>  Reclaimable  45808  13050    380      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Movable  12480    373      4      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Reserve      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>          CMA      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line">Node    0, zone   Normal, <span class="built_in">type</span>      Isolate      0      0      0      0      0      0      0      0      0      0      0</span><br><span class="line"></span><br><span class="line">Number of blocks <span class="built_in">type</span>     Unmovable  Reclaimable      Movable      Reserve          CMA      Isolate</span><br><span class="line">Node 0, zone      DMA            1            0            7            0            0            0</span><br><span class="line">Node 0, zone    DMA32          593          192          615            0            0            0</span><br><span class="line">Node 0, zone   Normal         9082          899       119555            0            0            0</span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">memory compaction.  , Linux: /proc/sys/vm/extfrag_threshold  0 ~ 1000. , Linux</span><br><span class="line">, extfrag_threshold, kswapdmemory compaction .  , 1000, , ; </span><br><span class="line">0, memory compaction.   </span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/compact_memory</span><br><span class="line">memory compaction</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In heavey loading, it s too slow, go to memory compaction   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &gt; /proc/sys/vm/compact_memory</span><br></pre></td></tr></table></figure>

<p>Got the free pages from buddyinfo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ awk <span class="string">&#x27;&#123;sum=0;for(i=5;i&lt;=NF;i++) sum+=$i*(2^(i-5))&#125;;&#123;total+=sum*4096/1024/1024&#125;;&#123;print $1 &quot; &quot; $2 &quot; &quot; $3 &quot; &quot; $4 &quot;\t : &quot; sum*4096/1024/1024 &quot;M&quot;&#125; END &#123;print &quot;total\t\t\t : &quot; total &quot;M&quot;&#125;&#x27;</span> /proc/buddyinfo</span><br></pre></td></tr></table></figure>
<p>memory compaction cause system responding slow, but it s not cause the TcpExtPFMemallocDrop     </p>
<h4 id="ZRAM"><a href="#ZRAM" class="headerlink" title="ZRAM"></a><a target="_blank" rel="noopener" href="http://liujunming.top/2016/07/04/Linux%E5%86%85%E6%A0%B8%E4%B8%ADzram%E6%A8%A1%E5%9D%97%E7%9A%84%E7%90%86%E8%A7%A3/">ZRAM</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">description <span class="string">&quot;Initializes zram swaping&quot;</span></span><br><span class="line">start on runlevel [2345]</span><br><span class="line">stop on runlevel [!2345]</span><br><span class="line">pre-start script</span><br><span class="line"><span class="comment"># load dependency modules</span></span><br><span class="line">modprobe zram num_devices=2</span><br><span class="line"><span class="comment"># initialize the devices</span></span><br><span class="line"><span class="built_in">echo</span> 1073741824 &gt; /sys/block/zram0/disksize</span><br><span class="line"><span class="built_in">echo</span> 1073741824 &gt; /sys/block/zram1/disksize</span><br><span class="line"><span class="comment"># Creating swap filesystems</span></span><br><span class="line">mkswap /dev/zram0</span><br><span class="line">mkswap /dev/zram1</span><br><span class="line"><span class="comment"># Switch the swaps on</span></span><br><span class="line">swapon -p 5 /dev/zram0</span><br><span class="line">swapon -p 5 /dev/zram1</span><br><span class="line">end script</span><br><span class="line">post-stop script</span><br><span class="line"><span class="comment"># Switching off swap</span></span><br><span class="line">swapoff /dev/zram0</span><br><span class="line">swapoff /dev/zram1</span><br><span class="line">rmmod zram</span><br><span class="line">end script</span><br><span class="line"></span><br><span class="line"><span class="comment">##test zram</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line">int <span class="function"><span class="title">main</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">        //printf(<span class="string">&quot;%d\n&quot;</span>, sizeof(int));</span><br><span class="line">        int  *mem;</span><br><span class="line">        int i, size;</span><br><span class="line">        size = 0x70000000;</span><br><span class="line">        mem = (int*)malloc(size*sizeof(int));</span><br><span class="line">        <span class="keyword">for</span>(i = 0; i &lt; size; i++)</span><br><span class="line">                mem[i] = (i%1024);</span><br><span class="line">        getchar();</span><br><span class="line">        free(mem);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="numa"><a href="#numa" class="headerlink" title="numa"></a>numa</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">numactl --interleave=all <span class="comment">#Two/Four socket CPU will share all memory, but you can&#x27; t got the best performance except you need more memory</span></span><br><span class="line">vm.zone_reclaim_mode = 0  <span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> -15 &gt; /proc/&lt;pid&gt;/oom_adj <span class="comment">#reduce OOM kill ratio</span></span><br><span class="line">huge page will not be swaped</span><br><span class="line"><span class="comment">#numa info in /proc/vmstat</span></span><br><span class="line">https://documentation.suse.com/sles/12-SP3/html/SLES-all/cha-tuning-numactl.html</span><br><span class="line"></span><br><span class="line">numa_pte_updates</span><br><span class="line">The amount of base pages that were marked <span class="keyword">for</span> NUMA hinting faults.</span><br><span class="line"></span><br><span class="line">numa_huge_pte_updates</span><br><span class="line">The amount of transparent huge pages that were marked <span class="keyword">for</span> NUMA hinting faults. In combination with numa_pte_updates the total address space that was marked can be calculated.</span><br><span class="line"></span><br><span class="line">numa_hint_faults</span><br><span class="line">Records how many NUMA hinting faults were trapped.</span><br><span class="line"></span><br><span class="line">numa_hint_faults_local</span><br><span class="line">Shows how many of the hinting faults were to <span class="built_in">local</span> nodes. In combination with numa_hint_faults, the percentage of <span class="built_in">local</span> versus remote faults can be calculated. A high percentage of <span class="built_in">local</span> hinting faults indicates that the workload is closer to being converged.</span><br><span class="line"></span><br><span class="line">numa_pages_migrated</span><br><span class="line">Records how many pages were migrated because they were misplaced. As migration is a copying operation, it contributes the largest part of the overhead created by NUMA balancing.</span><br><span class="line"></span><br><span class="line"><span class="comment">#check the process</span></span><br><span class="line">$ grep -e AnonHugePages  /proc/*/smaps | awk -F <span class="string">&#x27;[/ ]+&#x27;</span> <span class="string">&#x27;$(NF-1)&gt;4 &#123;system(&quot;ps -fp  &quot;$3)&#125;&#x27;</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">nobody    5023  5016  3 Jun07 ?        22:28:27 /sbin/lustre_exporter --collector.ost=disabled --collector.mdt=core</span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">polkitd    743     1  0 Jun07 ?        00:00:19 /usr/lib/polkit-1/polkitd --no-debug</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage"><a href="#Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage" class="headerlink" title="Soft lockup detected on a large NUMA system under a heavy memory usage"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/1560893">Soft lockup detected on a large NUMA system under a heavy memory usage</a></h5><p>Systems with numa factor lower than or equal to 30 may hang under the high load.<br>Soft lockup detected under a heavy memory pressure on a large NUMA system.</p>
<p>For RHEL 7, users must be aware of the following steps that can avoid the soft lockup from occurring. Disable Transparent Huge Page (THP) to avoid such busy memory-compaction, and add numa_balancing&#x3D;disable to the kernel parameter followed by reboot, OR set &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;zone_reclaim_mode to 1.<br>For RHEL 6,<br>disable Transparent Huge Page (THP) to avoid such busy memory-compaction OR set &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;zone_reclaim_mode to 1.</p>
<p>The default value(zero) of &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;zone_reclaim_mode results in the CPUs running on the memory exhausted nodes to skip over to the next node with available memory to attempt the memory allocation.</p>
<h4 id="Transparent-Huge-Page"><a href="#Transparent-Huge-Page" class="headerlink" title="Transparent Huge Page"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/46111">Transparent Huge Page</a></h4><p>The transparent Huge Page implementation in the Linux kernel includes functionality that provides compaction. Compaction operations are system level processes that are resource intensive</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##### Enable or disable</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">[always] madvise never</span><br><span class="line"></span><br><span class="line">$ grep AnonHugePages /proc/meminfo</span><br><span class="line">AnonHugePages:  19523584 kB</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/meminfo|grep Huge</span><br><span class="line">AnonHugePages:  1681086464 kB</span><br><span class="line">HugePages_Total:       0</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line"></span><br><span class="line"><span class="comment">#means 1681086464/2048 = 820843x 2MB huge pages</span></span><br><span class="line"></span><br><span class="line">$ grep -Ei <span class="string">&#x27;trans|thp&#x27;</span> /proc/vmstat</span><br><span class="line">nr_anon_transparent_hugepages 9533</span><br><span class="line">thp_fault_alloc 24017</span><br><span class="line">thp_fault_fallback 16231</span><br><span class="line">thp_collapse_alloc 1687</span><br><span class="line">thp_collapse_alloc_failed 39449</span><br><span class="line">thp_split 2926</span><br><span class="line">thp_zero_page_alloc 1</span><br><span class="line">thp_zero_page_alloc_failed 0</span><br></pre></td></tr></table></figure>

<h4 id="Use-hugetlbfs"><a href="#Use-hugetlbfs" class="headerlink" title="Use hugetlbfs"></a><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/tuning_and_optimizing_red_hat_enterprise_linux_for_oracle_9i_and_10g_databases/sect-oracle_9i_and_10g_tuning_guide-large_memory_optimization_big_pages_and_huge_pages-configuring_huge_pages_in_red_hat_enterprise_linux_4_or_5">Use hugetlbfs</a></h4><h5 id="set-hugepage"><a href="#set-hugepage" class="headerlink" title="set hugepage"></a><a target="_blank" rel="noopener" href="https://paolozaino.wordpress.com/2016/10/02/how-to-force-any-linux-application-to-use-hugepages-without-modifying-the-source-code/">set hugepage</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">        a) hugeadm --create-global-mounts</span><br><span class="line">        b) hugeadm --pool-pages-max DEFAULT:8G</span><br><span class="line">        c) hugeadm --set-recommended-min_free_kbytes</span><br><span class="line">        d) hugeadm --set-recommended-shmmax</span><br><span class="line"></span><br><span class="line">$ yum -y install libhugetlbfs-utils libhugetlbfs</span><br><span class="line"><span class="comment"># To set the 2MB pool minimum to 512 pages:</span></span><br><span class="line">$ hugeadm --pool-pages-min 2MB:512</span><br><span class="line">$ hugeadm --pool-pages-max 2MB:2048</span><br><span class="line">$ hugeadm --pool-list</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> -p /mnt/hugetlbfs-64K</span><br><span class="line">$ mount -t hugetlbfs none -opagesize=64k /mnt/hugetlbfs-64K</span><br><span class="line">or</span><br><span class="line">$ mount -t hugetlbfs none /mnt/hugetlbfs -o uid=postfix -o gid=postfix</span><br><span class="line">$ hugeadm --set-recommended-shmmax</span><br><span class="line">$ hugeadm --explain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ LD_PRELOAD=libhugetlbfs.so HUGETLB_MORECORE=<span class="built_in">yes</span> ./run_your_cmd</span><br><span class="line"><span class="comment">## looks like it &#x27;s ok</span></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">31723 root      20   0  642.7g  94996   1348 S  1734  0.0 101:41.53 ./ft.E.x</span><br><span class="line"></span><br><span class="line"><span class="comment">#ftrace</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kmem/mm_page_alloc_extfrag/enable</span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/tracing/trace</span><br><span class="line"></span><br><span class="line">           &lt;...&gt;-48794 [003] d... 29700.500381: mm_page_alloc_extfrag: page=ffffe547d61d0000 pfn=22574080 alloc_order=9 fallback_order=10 pageblock_order=9 alloc_migratetype=2 fallback_migratetype=2 fragmenting=0 change_ownership=1</span><br><span class="line">           &lt;...&gt;-48794 [003] d... 29701.045678: mm_page_alloc_extfrag: page=ffffe547d60e0000 pfn=22558720 alloc_order=9 fallback_order=10 pageblock_order=9 alloc_migratetype=2 fallback_migratetype=2 fragmenting=0 change_ownership=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ grep Hugepagesize /proc/meminfo</span><br><span class="line">Hugepagesize:       2048 kB</span><br><span class="line">$ <span class="built_in">echo</span> 512 &gt; /proc/sys/vm/nr_hugepages</span><br><span class="line">This means <span class="keyword">if</span> a 1GB Huge Pages pool should be allocated, <span class="keyword">then</span> 512 Huge Pages need to be allocated</span><br><span class="line">it <span class="string">&#x27;s the static huge page</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 1000 &gt; /proc/sys/vm/hugetlb_shm_group</span></span><br><span class="line"><span class="string">##means only members of group testuser(1000) can allocate &quot;huge&quot; Shared memory segment</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o uid=1000,gid=1000,mode=775,size=10g none /data/hugeshm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#kernel parameter, 4x1G, 1024x2M</span></span><br><span class="line"><span class="string">default_hugepagesz=1G hugepagesz=1G hugepages=4 hugepagesz=2M hugepages=1024</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o pagesize=1G none /dev/hugepages1G</span></span><br><span class="line"><span class="string">mount -t hugetlbfs -o pagesize=2M none /dev/hugepages2M</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 4 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"><span class="string">echo 1024 &gt; /sys/devices/system/node/node3/hugepages/hugepages-2048kB/nr_hugepages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/proc/sys/vm/nr_overcommit_hugepages</span></span><br><span class="line"><span class="string">Defines the maximum number of additional huge pages that can be created and used by the system through overcommitting memory. Writing any non-zero value into this file indicates that the system obtains that number of huge pages from the kernel&#x27;</span>s normal page pool <span class="keyword">if</span> the persistent huge page pool is exhausted. As these surplus huge pages become unused, they are <span class="keyword">then</span> freed and returned to the kernel<span class="string">&#x27;s normal page pool.</span></span><br></pre></td></tr></table></figure>
<h5 id="free-hugepage"><a href="#free-hugepage" class="headerlink" title="free hugepage"></a>free hugepage</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/vm/nr_hugepages</span><br></pre></td></tr></table></figure>

<ul>
<li>Hugepages is a feature that allows the Linux kernel to utilize the multiple page size capabilities of<br>modern hardware architectures.<br>  * A page is the basic unit of virtual memory, with the default page size being 4 KB in the x86 architecture.</li>
<li>Leave sufficient memory for OS use<br>  * no longer subject to normal memory allocations</li>
<li>Huge Pages are pinned to physical RAM and cannot be swapped&#x2F;paged out.<br>  * Preference is for 1G hugepages.<br>  * Each hugepage requires a TLB entry. Smaller hugepages &#x3D;&gt; more TLBs and TLB lookups due to page faults &#x3D;&gt; higher probability of packet drop blips</li>
</ul>
<p>hugepagesz<br>[HW,IA-64,PPC,X86-64] The size of the HugeTLB pages.<br>On x86-64 and powerpc, this option can be specified multiple times interleaved with hugepages&#x3D; to reserve huge pages of different sizes. Valid pages sizes on x86-64 are 2M (when the CPU supports pse) and 1G (when the CPU supports the pdpe1gb cpuinfo flag).    </p>
<p>hugepages<br>[HW,X86-32,IA-64] HugeTLB pages to allocate at boot.     </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hugepagesz=1G hugepages=224</span><br></pre></td></tr></table></figure>

<h4 id="memlock"><a href="#memlock" class="headerlink" title="memlock"></a>memlock</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oracle           soft    memlock         1048576</span><br><span class="line">oracle           hard    memlock         1048576</span><br></pre></td></tr></table></figure>
<p>The memlock parameter specifies how much memory the oracle user can lock into its address space. Note that Huge Pages are locked in physical memory. The memlock setting is specified in KB and must match the memory size of the number of Huge Pages that Oracle should be able to allocate. So if the Oracle database should be able to use 512 Huge Pages, then memlock must be set to at least 512 * Hugepagesize, which on this system would be 1048576 KB (512<em>1024</em>2). If memlock is too small, then no single Huge Page will be allocated when the Oracle database starts </p>
<h4 id="get-pagesize"><a href="#get-pagesize" class="headerlink" title="get pagesize"></a>get pagesize</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getconf PAGESIZE</span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<h4 id="memmap"><a href="#memmap" class="headerlink" title="memmap"></a><a target="_blank" rel="noopener" href="https://docs.pmem.io/getting-started-guide/creating-development-environments/linux-environments/linux-memmap">memmap</a></h4><p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt">https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">memmap=exactmap [KNL,X86] Enable setting of an exact</span><br><span class="line">                        E820 memory map, as specified by the user.</span><br><span class="line">                        Such memmap=exactmap lines can be constructed based on</span><br><span class="line">                        BIOS output or other requirements. See the memmap=nn@ss</span><br><span class="line">                        option description.</span><br><span class="line"></span><br><span class="line">        memmap=nn[KMG]@ss[KMG]</span><br><span class="line">                        [KNL] Force usage of a specific region of memory.</span><br><span class="line">                        Region of memory to be used is from ss to ss+nn.</span><br><span class="line">                        If @ss[KMG] is omitted, it is equivalent to mem=nn[KMG],</span><br><span class="line">                        <span class="built_in">which</span> limits max address to nn[KMG].</span><br><span class="line">                        Multiple different regions can be specified,</span><br><span class="line">                        comma delimited.</span><br><span class="line">                        Example:</span><br><span class="line">                                memmap=100M@2G,100M<span class="comment">#3G,1G!1024G</span></span><br><span class="line"></span><br><span class="line">        memmap=nn[KMG]<span class="comment">#ss[KMG]</span></span><br><span class="line">                        [KNL,ACPI] Mark specific memory as ACPI data.</span><br><span class="line">                        Region of memory to be marked is from ss to ss+nn.</span><br><span class="line"></span><br><span class="line">        memmap=nn[KMG]<span class="variable">$ss</span>[KMG]</span><br><span class="line">                        [KNL,ACPI] Mark specific memory as reserved.</span><br><span class="line">                        Region of memory to be reserved is from ss to ss+nn.</span><br><span class="line">                        Example: Exclude memory from 0x18690000-0x1869ffff</span><br><span class="line">                                 memmap=64K<span class="variable">$0x18690000</span></span><br><span class="line">                                 or</span><br><span class="line">                                 memmap=0x10000<span class="variable">$0x18690000</span></span><br><span class="line">                        Some bootloaders may need an escape character before <span class="string">&#x27;$&#x27;</span>,</span><br><span class="line">                        like Grub2, otherwise <span class="string">&#x27;$&#x27;</span> and the following number</span><br><span class="line">                        will be eaten.</span><br><span class="line"></span><br><span class="line">        memmap=nn[KMG]!ss[KMG]</span><br><span class="line">                        [KNL,X86] Mark specific memory as protected.</span><br><span class="line">                        Region of memory to be used, from ss to ss+nn.</span><br><span class="line">                        The memory region may be marked as e820 <span class="built_in">type</span> 12 (0xc)</span><br><span class="line">                        and is NVDIMM or ADR memory.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg | grep e820</span><br><span class="line">$ grubby --args=<span class="string">&quot;memmap=96G:32G&quot;</span> --update-kernel=ALL</span><br></pre></td></tr></table></figure>

<h5 id="mapping-x2F-dev-x2F-pmemX-can-be-used-to-create-a-DAX-filesystem"><a href="#mapping-x2F-dev-x2F-pmemX-can-be-used-to-create-a-DAX-filesystem" class="headerlink" title="mapping &#x2F;dev&#x2F;pmemX can be used to create a DAX filesystem"></a>mapping &#x2F;dev&#x2F;pmemX can be used to create a DAX filesystem</h5><ul>
<li>DAX bypass the pagecache<ul>
<li>DAX use NVRAM for pagecache</li>
<li>DAX can map pagecache NVRAM into user buffer</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ sudo parted /dev/pmem0</span><br><span class="line">(parted) mkpart</span><br><span class="line">Partition type?  primary/extended? p</span><br><span class="line">File system type?  [ext2]? ext4</span><br><span class="line">Start? 2MiB</span><br><span class="line">End? 100GiB</span><br><span class="line">(parted)</span><br><span class="line"></span><br><span class="line">(parted) mkpart</span><br><span class="line">Partition type?  primary/extended? p</span><br><span class="line">File system type?  [ext2]? ext4</span><br><span class="line">Start? 100GiB</span><br><span class="line">End? 200GiB</span><br><span class="line"></span><br><span class="line">$  getconf PAGE_SIZE</span><br><span class="line">4096</span><br><span class="line"></span><br><span class="line">$ sudo mkfs.ext4 -b 4096 -E stride=512 -F /dev/pmem0</span><br><span class="line">$ sudo mkdir /pmem</span><br><span class="line">$ sudo mount -o dax /dev/pmem0p1 /pmem</span><br><span class="line">$ sudo mount -v | grep /pmem</span><br><span class="line">$ fallocate --length 1G /pmem/data</span><br><span class="line">$ echo 1 &gt; /sys/kernel/debug/tracing/events/fs_dax/dax_pmd_fault_done/enable</span><br><span class="line">$ echo 0 &gt; /sys/kernel/debug/tracing/events/fs_dax/dax_pmd_fault_done/enable</span><br><span class="line"></span><br><span class="line"># Verify the namespace is in fsdax mode</span><br><span class="line">$ ndctl list -u</span><br><span class="line">$ cat /proc/iomem</span><br></pre></td></tr></table></figure>

<h4 id="Benchmark-mem-by-perf"><a href="#Benchmark-mem-by-perf" class="headerlink" title="Benchmark mem by perf"></a>Benchmark mem by perf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">......</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10,12,14,16,18</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11,13,15,17,19</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 1,3,5,7,9,11,13,15,17,19 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          8.837 secs slowest (max) thread-runtime</span><br><span class="line">          8.000 secs fastest (min) thread-runtime</span><br><span class="line">          8.182 secs average thread-runtime</span><br><span class="line">          4.738 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.702 nsecs/byte/thread runtime</span><br><span class="line">          1.424 GB/sec/thread speed</span><br><span class="line">         14.239 GB/sec total speed</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 10  -T 12000  -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0</span><br><span class="line"><span class="comment"># Running &#x27;numa/mem&#x27; benchmark:</span></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Running main, &quot;perf bench numa numa-mem -p 1 -t 10 -T 12000 -Irq -H 1 -C 0,2,4,6,8,10,12,14,16,18 -M 0,0,0,0,0,0,0,0,0,0&quot;</span></span><br><span class="line">          5.528 secs slowest (max) thread-runtime</span><br><span class="line">          5.000 secs fastest (min) thread-runtime</span><br><span class="line">          5.084 secs average thread-runtime</span><br><span class="line">          4.776 % difference between max/avg runtime</span><br><span class="line">         12.584 GB data processed, per thread</span><br><span class="line">        125.840 GB data processed, total</span><br><span class="line">          0.439 nsecs/byte/thread runtime</span><br><span class="line">          2.276 GB/sec/thread speed</span><br><span class="line">         22.764 GB/sec total speed</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ dmidecode -t memory | grep -Ei <span class="string">&#x27;1638|32&#x27;</span></span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line">        Size: 16384 MB</span><br><span class="line">        Speed: 3200 MT/s</span><br><span class="line">        Configured Memory Speed: 3200 MT/s</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;5..8&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; perf bench numa mem  -p 1 -t 2  -T 15000  -Irq -H 1 -C 4,<span class="variable">$i</span> | grep <span class="string">&quot;sec total speed&quot;</span>; <span class="keyword">done</span></span><br><span class="line">5</span><br><span class="line">         12.818 GB/sec total speed</span><br><span class="line">6</span><br><span class="line">         12.757 GB/sec total speed</span><br><span class="line">7</span><br><span class="line">         12.810 GB/sec total speed</span><br><span class="line">8</span><br><span class="line">         13.142 GB/sec total speed</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;21..24&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; perf bench numa mem  -p 1 -t 2  -T 15000  -Irq -H 1 -C 20,<span class="variable">$i</span> | grep <span class="string">&quot;sec total speed&quot;</span>; <span class="keyword">done</span></span><br><span class="line">21</span><br><span class="line">         12.836 GB/sec total speed</span><br><span class="line">22</span><br><span class="line">         12.824 GB/sec total speed</span><br><span class="line">23</span><br><span class="line">         12.847 GB/sec total speed</span><br><span class="line">24</span><br><span class="line">         13.183 GB/sec total speed</span><br><span class="line"></span><br><span class="line">$ perf bench numa mem  -p 1 -t 2  -T 15000  -Irq -H 1 -C 20,46 | grep <span class="string">&quot;sec total speed&quot;</span></span><br><span class="line">         13.125 GB/sec total speed</span><br><span class="line">$ perf bench numa mem  -p 1 -t 2  -T 15000  -Irq -H 1 -C 20,47 | grep <span class="string">&quot;sec total speed&quot;</span></span><br><span class="line">         13.137 GB/sec total speed</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>AMD roma looks like 4 cores share a mem channel, 2 threads x 15000MB &#x3D; 30G , 12GB&#x2F;s means 1x channel, 13GB&#x2F;s means pass 2x channels</p>
<h4 id="dirty-page"><a href="#dirty-page" class="headerlink" title="dirty page"></a>dirty page</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a | grep dirty</span><br><span class="line">vm.dirty_background_bytes = 0</span><br><span class="line">vm.dirty_background_ratio = 10</span><br><span class="line">vm.dirty_bytes = 0</span><br><span class="line">vm.dirty_expire_centisecs = 3000</span><br><span class="line">vm.dirty_ratio = 20</span><br><span class="line">vm.dirty_writeback_centisecs = 500</span><br><span class="line"></span><br><span class="line">vfs_cache_pressure</span><br><span class="line">------------------</span><br><span class="line">This percentage value controls the tendency of the kernel to reclaim the memory <span class="built_in">which</span> is used <span class="keyword">for</span> caching of directory and inode objects.</span><br><span class="line"></span><br><span class="line">At the default value of vfs_cache_pressure=100 the kernel will attempt to reclaim dentries and inodes at a <span class="string">&quot;fair&quot;</span> rate with respect to pagecache and swapcache reclaim.  Decreasing vfs_cache_pressure causes the kernel to prefer to retain dentry and inode caches. When vfs_cache_pressure=0, the kernel will never reclaim dentries and inodes due to memory pressure and this can easily lead to out-of-memory conditions. Increasing vfs_cache_pressure beyond 100 causes the kernel to prefer to reclaim dentries and inodes.</span><br><span class="line"></span><br><span class="line">Increasing vfs_cache_pressure significantly beyond 100 may have negative performance impact. Reclaim code needs to take various locks to find freeable directory and inode objects. With vfs_cache_pressure=1000, it will look <span class="keyword">for</span> ten <span class="built_in">times</span> more freeable objects than there are.</span><br><span class="line"></span><br><span class="line">sysctl -w vm.vfs_cache_pressure=200</span><br></pre></td></tr></table></figure>

<ul>
<li><p>writeback</p>
<ul>
<li>On very large memory systems, consider using more granularity by using<ul>
<li>&#x2F;proc&#x2F;sys&#x2F;vm&#x2F;dirty_background_ratio</li>
<li>&#x2F;proc&#x2F;sys&#x2F;vm&#x2F;dirty_ratio</li>
</ul>
</li>
<li>If there is a lot of pagecache pressure one would want to start background flushing sooner and delay the synchronous writes<ul>
<li>lower diretry_background_ratio</li>
<li>increase the dirty_ratio</li>
</ul>
</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22370102/difference-between-kmalloc-and-kmem-cache-alloc">Kmalloc</a> - allocates contiguous region from the physical memory. But keep in mind, allocating and freeing memory is a lot of work.</p>
</li>
<li><p>Kmem_cache_alloc - Here, your process keeps some copies of the some pre-defined size objects pre-allocated. Say you have struct that you know you will be requiring very frequently, so instead of allocating it from the main memory (kmalloc) when you need it, you already keep multiple copies of it allocated &amp; when you want it, it returns the address of the block already allocated (saves a lot of time). Similarly, when you free it, you dont give it back, it actually isnt freed, it goes back to the allocated pool so that if some process again asks for it, you can return this address of the already allocated struct.</p>
</li>
<li><p>Reclaim ratios</p>
<ul>
<li>swappiness</li>
<li>min_free_kbytes</li>
<li>vfs_cache_pressure</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">GFP_ATOMIC  (__GFP_HIGH|__GFP_ATIOMIC|__GFP_KSWAPD_RECLAIM eg:alloc_skb) could malloc some memory under the lower watermark   </span><br><span class="line"><span class="keyword">if</span> under lower watermark, you could see the PF_MEMALLOC, <span class="keyword">in</span> our <span class="keyword">case</span> ,it <span class="string">&#x27;s the PF_MEMALLOC failed (out of memory)  </span></span><br><span class="line"><span class="string">but it could failed too, because some memory will to scan and reclaim   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[reference](https://github.com/haiwei-li/study/blob/3f40f1406620fb0bb7300a1d3ff7320b180875bc/Linux/Memory/zone%20%E6%B0%B4%E4%BD%8D/zone%20watermask.md)</span></span><br><span class="line"><span class="string">direct reclaim   </span></span><br><span class="line"><span class="string"> PF_MEMALLOC    </span></span><br><span class="line"><span class="string">PF_MEMALLOC(&quot;PF&quot;per-process flag)watermarkALLOC_NO_WATERMARK&quot;min&quot;process</span></span><br><span class="line"><span class="string">GFP__GFP_MEMALLOC     </span></span><br><span class="line"><span class="string">```c</span></span><br><span class="line"><span class="string">if (gfp_mask &amp; __GFP_MEMALLOC)</span></span><br><span class="line"><span class="string">        return ALLOC_NO_WATERMARKS;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if (alloc_flags &amp; ALLOC_NO_WATERMARKS)</span></span><br><span class="line"><span class="string">        set_page_pfmemalloc(page);</span></span><br><span class="line"><span class="string">kswapdkswapd()</span></span><br><span class="line"><span class="string">()    </span></span><br><span class="line"><span class="string">kswapd&quot;low&quot;&quot;min&quot;&quot;min&quot;&quot;min&quot;kswapd</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#linux-3.10.0-1127.el7/mm/page_alloc.c</span></span><br><span class="line"><span class="string">int __meminit init_per_zone_wmark_min(void)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">        unsigned long lowmem_kbytes;</span></span><br><span class="line"><span class="string">        int new_min_free_kbytes;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        lowmem_kbytes = nr_free_buffer_pages() * (PAGE_SIZE &gt;&gt; 10);</span></span><br><span class="line"><span class="string">        new_min_free_kbytes = int_sqrt(lowmem_kbytes * 16);  &lt;------------------min_free_kbytes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (new_min_free_kbytes &gt; user_min_free_kbytes) &#123;</span></span><br><span class="line"><span class="string">                min_free_kbytes = new_min_free_kbytes;</span></span><br><span class="line"><span class="string">                if (min_free_kbytes &lt; 128)</span></span><br><span class="line"><span class="string">                        min_free_kbytes = 128;</span></span><br><span class="line"><span class="string">                if (min_free_kbytes &gt; 65536)</span></span><br><span class="line"><span class="string">                        min_free_kbytes = 65536;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">                pr_warn(&quot;min_free_kbytes is not updated to %d because user defined value %d is preferred\n&quot;,</span></span><br><span class="line"><span class="string">                                new_min_free_kbytes, user_min_free_kbytes);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        setup_per_zone_wmarks();</span></span><br><span class="line"><span class="string">        refresh_zone_stat_thresholds();</span></span><br><span class="line"><span class="string">        setup_per_zone_lowmem_reserve();</span></span><br><span class="line"><span class="string">        setup_per_zone_inactive_ratio();</span></span><br><span class="line"><span class="string">        return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">static void __setup_per_zone_wmarks(void)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">        unsigned long pages_min = min_free_kbytes &gt;&gt; (PAGE_SHIFT - 10);</span></span><br><span class="line"><span class="string">        unsigned long lowmem_pages = 0;</span></span><br><span class="line"><span class="string">        struct zone *zone;</span></span><br><span class="line"><span class="string">        unsigned long flags;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        /* Calculate total number of !ZONE_HIGHMEM pages */ &lt;--------------------------------------</span></span><br><span class="line"><span class="string">        for_each_zone(zone) &#123;</span></span><br><span class="line"><span class="string">                if (!is_highmem(zone))</span></span><br><span class="line"><span class="string">                        lowmem_pages += zone-&gt;managed_pages;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        for_each_zone(zone) &#123;</span></span><br><span class="line"><span class="string">                u64 tmp;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> zone  wmark_min  min_free_kbytes.  zone  wmark_min  min_free_kbytes</span></span><br><span class="line"><span class="string">wmark_low = 5/4 * wmark_min</span></span><br><span class="line"><span class="string">wmark_high = 3/2 * wmark_min</span></span><br><span class="line"><span class="string">zone reserve page,  high level zone , low level zone page.</span></span><br><span class="line"><span class="string">setup_per_zone_lowmem_reserve()</span></span><br><span class="line"><span class="string">wmark_min, wmark_low, wmark_high .</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">min_free_kbytes kernel __GFP_ATOMIC , , cpu , handling an interrupt or executing code inside an critical region. kernel .  min_free_kbytes __GFP_ATOMIC </span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">wmark_min  page frame , , , , kernel,  __alloc_pages_high_priority() &gt;, </span></span><br><span class="line"><span class="string">wmark_low  kswap , __alloc_pages  free page fram  wmark_low , kswapd ,  page reclaim</span></span><br><span class="line"><span class="string">wmark_high  kswapd  page reclaim , ,  page frame  pagh_high , kswapd , sleep </span></span><br><span class="line"><span class="string">wmark_min, wmark_low, wmark_high kernel atomic </span></span><br><span class="line"><span class="string">.......</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://github.com/baotiao/baotiao.github.com/blob/6448a8ba675cbb6ea9ec002c4d8792a2b50226d5/_posts/2016-06-02-page-reclaim.md</span></span><br></pre></td></tr></table></figure>


<p>The burst allocation cause the high latency direct reclaim, for prevent this situation ..    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">    &lt;---allocate | reclaim---&gt;                               used    RAM</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">        ------------------------watermark_scale_factor increase min to high</span><br><span class="line">        |                   |</span><br><span class="line">        |-------------------|---extra_free_kbytes increase this area from min to low</span><br><span class="line">        |        |          |</span><br><span class="line">  wmark min  wmark low    wmark high</span><br><span class="line">--------|--------|----------|-------------------------------------</span><br><span class="line">        --delta--</span><br><span class="line">    &lt;---allocate | reclaim---&gt;                               used    RAM</span><br><span class="line">----|-------------------|-----------------------------------------</span><br><span class="line">    -----alloc size------</span><br><span class="line"></span><br><span class="line">Lower the wmark low will wake up the kswapd...</span><br><span class="line">In the android add the extra_free_kbytes for increase the memory size from wmark min to the wmark low</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/93841288">about avaiable memory</a><br>si_mem_available   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">             |---unreclaimble</span><br><span class="line">page cache &lt;-----reclaimble --------------|</span><br><span class="line">                 SReclaimable  -------------&gt; available</span><br><span class="line">             |---free   ------------------|</span><br><span class="line">free pages &lt;-----zone watermark (low? or high)</span><br><span class="line">             |---lowmem reserve (min)</span><br><span class="line"></span><br><span class="line">avaiable = free pages - all zone lowmem reserve - high watermark + page cache + could be reclaim from slab</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## too high lru_lock--- &gt; lru cache once write a lot of pages to inactive list</span><br><span class="line">2 x list in linux ----&gt; active FIFO list (PG_active=1 in the flag, PG_referenced means used it recently ?)</span><br><span class="line">                   |--&gt; inactive FIFO list (PG_active=0)</span><br><span class="line"></span><br><span class="line">anonymous pagesswap areapage cachediscardelftextdatacleandirtywrite back</span><br><span class="line"></span><br><span class="line">flusher threadwrite backdirtypage cachepage cache</span><br><span class="line">page cache anonymous pages&quot;/proc/sys/vm/swappiness&quot;anonymous pagespage cache</span><br></pre></td></tr></table></figure>

<h4 id="meminfo"><a href="#meminfo" class="headerlink" title="meminfo"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/93228929">meminfo</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|------------------------buff/cache-----------------------------|             ---&gt; some of swapcached</span><br><span class="line">           |---buffers---|------------cached(mapped)------------|             |</span><br><span class="line">|---slab---|---Active(file)+Inactive(file)---|---shmem shared---|---anonpages---|</span><br><span class="line">                                             |---active(anon)+Inactive(anon)----|</span><br><span class="line"></span><br><span class="line">$ dmesg  | grep Memory</span><br><span class="line">                                                                            <span class="built_in">read</span>,write      <span class="built_in">readonly</span>              not init</span><br><span class="line">[    0.059168] Memory: 7776940K/8200176K available (14345K kernel code, 3481K rwdata, 10348K rodata, 2688K init, 5976K bss, 422976K reserved, 0K cma-reserved)</span><br><span class="line">[    0.112476] x86/mm: Memory block size: 128MB</span><br><span class="line"></span><br><span class="line">- KernelStack</span><br><span class="line">  - grep -i stack /proc/meminfo</span><br><span class="line">- kernel heap   </span><br><span class="line">  - kmalloc() samll block by slab allocator</span><br><span class="line">  - alloc_page or __get_free_page or kmalloc big part or vmalloc</span><br><span class="line">    - /proc/vmallocinfo</span><br><span class="line">- Page tables</span><br><span class="line">  - All: grep pagetables /proc/meminfo -i</span><br><span class="line">  - single process: grep -E <span class="string">&#x27;VmPTE|VmPMD&#x27;</span> /proc/[PID]/status</span><br><span class="line"></span><br><span class="line">- cache:           file cache page + shm page</span><br><span class="line">- rss:             anonymous page + swap cache page</span><br><span class="line">- (<span class="keyword">in</span>)active_anon: anonymous page + swap cache page + shm page</span><br><span class="line">- (<span class="keyword">in</span>)active_file: file cache page</span><br><span class="line">- rss + cache = (<span class="keyword">in</span>)active_anon + (<span class="keyword">in</span>)active_file</span><br><span class="line"></span><br><span class="line">The memory does not automatically count by alloc_pages assigned, unless alloc_pages kernel module or driver calls the initiative to statistics, otherwise we can only see free memory is reduced, but the /proc/meminfo was not clear <span class="built_in">where</span> their specific use went. For example, there is a FAQ on the VMware guest, is the opportunity to take up guest VMWare ESX host memory via Balloon driver (vmware_balloon module) on the guest, and sometimes take up too much will cause no guest memory is available, <span class="keyword">then</span> the guest to check the /proc/meminfo MemFree see only rarely, but can not see the whereabouts of memory, reason is Balloon driver by alloc_pages allocate memory, leaving no statistical value <span class="keyword">in</span> /proc/meminfo <span class="keyword">in</span>, it is difficult to track.    </span><br><span class="line"></span><br><span class="line">[meminfo with Linux kernel](http://linuxperf.com/?p=142)</span><br><span class="line">```bash</span><br><span class="line">   reserved (dmesg -T | grep reserved)</span><br><span class="line">   slab</span><br><span class="line">     SReclaimable</span><br><span class="line">     SUnreclaim</span><br><span class="line">   VmallocUsed (grep vmalloc /proc/vmallocinfo)  kernel/module.c</span><br><span class="line">      awk <span class="string">&#x27;$0~/vmalloc/&#123;total+=$2&#125;; END &#123;print total&#125;&#x27;</span> /proc/vmallocinfo</span><br><span class="line">      kernel modules (lsmod size field)</span><br><span class="line">        seq_printf(m, <span class="string">&quot;%s %u&quot;</span>,mod-&gt;name, mod-&gt;init_size + mod-&gt;core_size)</span><br><span class="line">   HardwareCorrupted (mm/memory-failure.c: memory_failure())</span><br><span class="line">   PageTables</span><br><span class="line">      not contains Page Frame, it <span class="string">&#x27;s the base unit by physical memory</span></span><br><span class="line"><span class="string">   KernelStack (2048k)</span></span><br><span class="line"><span class="string">   Bounce( bounce buffering in the old device)</span></span><br><span class="line"><span class="string">   Hugepages( diff with Transparent HugePage)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     HugePages_Total = vm.nr_hugepages</span></span><br><span class="line"><span class="string">       $ echo 128 &gt; /proc/sys/vm/nr_hugepages</span></span><br><span class="line"><span class="string">       $ cat /proc/meminfo</span></span><br><span class="line"><span class="string">       HugePages_Total: 128</span></span><br><span class="line"><span class="string">       HugePages_Free: 128</span></span><br><span class="line"><span class="string">       Hugepagesize: 2048 kB</span></span><br><span class="line"><span class="string">       hugetlbfs mmap() or read(), not support write()</span></span><br><span class="line"><span class="string">       not count by PSS and RSS, not in RU Active/Inactive, not in cache/buffer</span></span><br><span class="line"><span class="string">       VmFlags: xxx ht(hugepages) in smaps</span></span><br><span class="line"><span class="string">       THP will count by PSS and RSS</span></span><br><span class="line"><span class="string">       AnonHugePages count in AnonPages and in PSS/RSS</span></span><br><span class="line"><span class="string">       $ cat /sys/devices/node/*/hugepages/*/nrhugepages</span></span><br><span class="line"><span class="string">       Used via hugetlbfs</span></span><br><span class="line"><span class="string">   LUR (Struct of Page Frame Reclaiming)</span></span><br><span class="line"><span class="string">     LRU_INACTIVE_ANON &lt;--&gt; Inactive(anon)</span></span><br><span class="line"><span class="string">     LRU_ACTIVE_ANON &lt;--&gt; Active(anon)</span></span><br><span class="line"><span class="string">     LRU_INACTIVE_FILE &lt;--&gt; Inactive(file)</span></span><br><span class="line"><span class="string">     LRU_ACTIVE_FILE &lt;--&gt; Active(file)</span></span><br><span class="line"><span class="string">     LRU_UNEVICTABLE &lt;--&gt; Unevictable</span></span><br><span class="line"><span class="string">     Cached+AnonPages</span></span><br><span class="line"><span class="string">       User process</span></span><br><span class="line"><span class="string">         /proc/&lt;pid&gt;/smaps</span></span><br><span class="line"><span class="string">       Page cache</span></span><br><span class="line"><span class="string">   Shmem (page cache or Mapped(attach shmem))</span></span><br><span class="line"><span class="string">     Inactive(anon) or Active(anon), in anon list but not count by AnonPages()</span></span><br><span class="line"><span class="string">     share mem</span></span><br><span class="line"><span class="string">     tmpfs</span></span><br><span class="line"><span class="string">     devtmpfs</span></span><br><span class="line"><span class="string">     used size, allocate not means used</span></span><br><span class="line"><span class="string">   AnonPages</span></span><br><span class="line"><span class="string">     User pages: 1. Anonpages; 2. file-backed page</span></span><br><span class="line"><span class="string">     Anonymous Pages release when the user process exit</span></span><br><span class="line"><span class="string">     page cache(Cached) is the file-backed page, not Anonymous pages</span></span><br><span class="line"><span class="string">     anonymous pages</span></span><br><span class="line"><span class="string">     AnonPages not in share memory, it&#x27;</span>s the Cached</span><br><span class="line">     mmap private anonymous pages is AnonPages(Anonymous Pages),mmap shared anonymous pages is Cached(file-backed pages),shared anonymous mmap is tmpfs</span><br><span class="line">     the Transparent HugePages (THP) AnonHugePages (fs/proc/meminfo.c meminfo_proc_show)</span><br><span class="line">       Transparent HugePages</span><br><span class="line">         <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepages=never</span><br><span class="line">         <span class="built_in">echo</span> always &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</span><br><span class="line">   Cached</span><br><span class="line">     Mapped</span><br><span class="line">       User file-backed pages</span><br><span class="line">       Share lib file/mmap file/executable file</span><br><span class="line">       All process PSS == Mapped + AnonPages</span><br><span class="line">     Unmapped (Cached - Mapped)</span><br><span class="line">       The process <span class="built_in">exit</span> and the file-backed pages will not be reclaimed</span><br><span class="line">     tmpfs</span><br><span class="line">       POSIX/SysV shared memory</span><br><span class="line">       shared anonymous mmap</span><br><span class="line">         not swap-out</span><br><span class="line">   SwapCached ( fs/proc/meminfo.c, meminfo_proc_show, total_swapcache_pages )</span><br><span class="line">     AnonPages( make sure the mapping when swap-out;mm/vmscan.c: shrink_page_list() )</span><br><span class="line">     Shmem</span><br><span class="line">     the pages swap-out -&gt; swap-in, the swapcache will not be reclaimed right now, it <span class="string">&#x27;s the cache too</span></span><br><span class="line"><span class="string">   Mlocked</span></span><br><span class="line"><span class="string">     From Active/Inactive LRU list move to the Unevictable LRU list</span></span><br><span class="line"><span class="string">     It could not page-out and swap-out</span></span><br><span class="line"><span class="string">     location: Contain in the LRU UnevictableAnonPagesShmemMapped</span></span><br><span class="line"><span class="string">   Buffer (the block dev cache page, filemap.c: do_generic_file_read &gt; add_to_page_cache_lru)</span></span><br><span class="line"><span class="string">     read/write/metadata cache, the diff with cache, it &#x27;</span>s not linux file cache, just block dev</span><br><span class="line">     location: LRU list/Active(file)/Inactive(file)</span><br><span class="line">   DirectMap (4K,2M,1G..)</span><br><span class="line">     TLB(Translation Lookaside Buffer) efficiency</span><br><span class="line">   Dirty pages</span><br><span class="line">     dirty pages = Dirty + NFS_Unstable + Writeback</span><br><span class="line">     Active(file) + Inactive(file) + Shmem + mlock_file== Cached + Buffers</span><br><span class="line">     Slab+ VmallocUsed + PageTables + KernelStack + HardwareCorrupted + Bounce + X(black hole, alloc_pages/__get_free_page not count <span class="keyword">in</span> meminfo)</span><br><span class="line">   The user used</span><br><span class="line">     (Active + Inactive + Unevictable) + (HugePages_Total * Hugepagesize)</span><br><span class="line">     <span class="keyword">if</span> swapcache=0 (Cached + AnonPages + Buffers) + (HugePages_Total * Hugepagesize)</span><br><span class="line">     All processes = $(grep Pss /proc/[1-9]*/smaps | awk <span class="string">&#x27;&#123;total+=$2&#125;; END &#123;print total&#125;&#x27;</span>)</span><br><span class="line">     All processes + (Cached - mapped) + Buffers + (HugePages_Total * Hugepagesize)</span><br><span class="line">   The collectl info</span><br><span class="line">     <span class="built_in">dd</span> wirte file: collectl Inact(file)</span><br><span class="line">     user process: collectl Anon(contains AnonH)</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[lower watermark is min_free_kbytes 125%, hiher watermark is min_free_kbytes 150%](http://linux.laoqinren.net/kernel/vm-sysctl-min_free_kbytes/)</span><br><span class="line">```bash</span><br><span class="line">/*</span><br><span class="line"> * Initialise min_free_kbytes.</span><br><span class="line"> *</span><br><span class="line"> * For small machines we want it small (128k min).  For large machines</span><br><span class="line"> * we want it large (64MB max).  But it is not linear, because network</span><br><span class="line"> * bandwidth does not increase linearly with machine size.  We use</span><br><span class="line"> *</span><br><span class="line"> *      min_free_kbytes = 4 * sqrt(lowmem_kbytes), for better accuracy:</span><br><span class="line"> *      min_free_kbytes = sqrt(lowmem_kbytes * 16)</span><br><span class="line"> *</span><br><span class="line"> * which yields</span><br><span class="line"> *</span><br><span class="line"> * 16MB:        512k</span><br><span class="line"> * 32MB:        724k</span><br><span class="line"> * 64MB:        1024k</span><br><span class="line"> * 128MB:       1448k</span><br><span class="line"> * 256MB:       2048k</span><br><span class="line"> * 512MB:       2896k</span><br><span class="line"> * 1024MB:      4096k</span><br><span class="line"> * 2048MB:      5792k</span><br><span class="line"> * 4096MB:      8192k</span><br><span class="line"> * 8192MB:      11584k</span><br><span class="line"> * 16384MB:     16384k</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">watermark[high] - watermark[low] </span><br><span class="line">                = watermark[min] * 3 / 2 - watermark[min] * 5 / 4</span><br><span class="line">                = watermark[min] * 1 / 4</span><br><span class="line">                = per_zone_min_free_pages * 1/4</span><br><span class="line"></span><br><span class="line">$ systctl -w vm.min_free_kbytes=70336</span><br><span class="line">$ grep -A 3 -B 1 &quot;  pages free&quot; /proc/zoneinfo</span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">  pages free     3969</span><br><span class="line">        min      2</span><br><span class="line">        low      2</span><br><span class="line">        high     3</span><br><span class="line">--</span><br><span class="line">Node 0, zone    DMA32</span><br><span class="line">  pages free     451904</span><br><span class="line">        min      241</span><br><span class="line">        low      301 (125%)</span><br><span class="line">        high     361 (150%)</span><br><span class="line">--</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">  pages free     15162636</span><br><span class="line">        min      8533</span><br><span class="line">        low      10666 (125%)</span><br><span class="line">        high     12799 (150%)</span><br><span class="line">--</span><br><span class="line">Node 1, zone   Normal</span><br><span class="line">  pages free     15810809</span><br><span class="line">        min      8806</span><br><span class="line">        low      11007</span><br><span class="line">        high     13209</span><br><span class="line">$ sysctl -w vm.min_free_kbytes=570336</span><br><span class="line">vm.min_free_kbytes = 570336</span><br><span class="line"></span><br><span class="line">$ grep -A 3 -B 1 &quot;  pages free&quot; /proc/zoneinfo</span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">  pages free     3969</span><br><span class="line">        min      17</span><br><span class="line">        low      21</span><br><span class="line">        high     25</span><br><span class="line">--</span><br><span class="line">Node 0, zone    DMA32</span><br><span class="line">  pages free     451904</span><br><span class="line">        min      1957</span><br><span class="line">        low      2446</span><br><span class="line">        high     2935</span><br><span class="line">--</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">  pages free     15162723</span><br><span class="line">        min      69196</span><br><span class="line">        low      86495</span><br><span class="line">        high     103794</span><br><span class="line">--</span><br><span class="line">Node 1, zone   Normal</span><br><span class="line">  pages free     15810673</span><br><span class="line">        min      71413</span><br><span class="line">        low      89266</span><br><span class="line">        high     107119</span><br><span class="line">$ grep -A 3 -B 1 &quot;  pages free&quot; /proc/zoneinfo  | awk &#x27;$0~/min/&#123;sum+=$NF&#125; END&#123;print sum*4+4&#125;&#x27;</span><br><span class="line">570336</span><br><span class="line"></span><br><span class="line"># you could see the same ratio from min to low</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">linux<span class="number">-3.10</span><span class="number">.0</span><span class="number">-1127.</span>el7/mm/vmscan.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The background pageout daemon, started as a kernel thread</span></span><br><span class="line"><span class="comment"> * from the init process.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This basically trickles out pages so that we have _some_</span></span><br><span class="line"><span class="comment"> * free memory available even if there is no other activity</span></span><br><span class="line"><span class="comment"> * that frees anything up. This is needed for things like routing</span></span><br><span class="line"><span class="comment"> * etc, where we otherwise might have all activity going on in</span></span><br><span class="line"><span class="comment"> * asynchronous contexts that cannot page things out.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If there are applications that are active memory-allocators</span></span><br><span class="line"><span class="comment"> * (most normal use), this basically shouldn&#x27;t matter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">kswapd</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> order, new_order;</span><br><span class="line">        <span class="type">unsigned</span> balanced_order;</span><br><span class="line">        <span class="type">int</span> classzone_idx, new_classzone_idx;</span><br><span class="line">        <span class="type">int</span> balanced_classzone_idx;</span><br><span class="line">        <span class="type">pg_data_t</span> *pgdat = (<span class="type">pg_data_t</span>*)p;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span> =</span> current;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">reclaim_state</span> <span class="title">reclaim_state</span> =</span> &#123;</span><br><span class="line">                .reclaimed_slab = <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cpumask</span> *<span class="title">cpumask</span> =</span> cpumask_of_node(pgdat-&gt;node_id);</span><br><span class="line"></span><br><span class="line">        lockdep_set_current_reclaim_state(GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cpumask_empty(cpumask))</span><br><span class="line">                set_cpus_allowed_ptr(tsk, cpumask);</span><br><span class="line">        current-&gt;reclaim_state = &amp;reclaim_state;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Tell the memory management that we&#x27;re a &quot;memory allocator&quot;,</span></span><br><span class="line"><span class="comment">         * and that if we need more memory we should get access to it</span></span><br><span class="line"><span class="comment">         * regardless (see &quot;__alloc_pages()&quot;). &quot;kswapd&quot; should</span></span><br><span class="line"><span class="comment">         * never get caught in the normal page freeing logic.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * (Kswapd normally doesn&#x27;t need memory anyway, but sometimes</span></span><br><span class="line"><span class="comment">         * you need a small amount of memory in order to be able to</span></span><br><span class="line"><span class="comment">         * page out something else, and this flag essentially protects</span></span><br><span class="line"><span class="comment">         * us from recursively trying to free more memory as we&#x27;re</span></span><br><span class="line"><span class="comment">         * trying to free the first piece of memory in the first place).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tsk-&gt;flags |= PF_MEMALLOC | PF_SWAPWRITE | PF_KSWAPD;</span><br><span class="line">        set_freezable();</span><br></pre></td></tr></table></figure>
<ul>
<li>vm.min_free_kbytes: kernel reserve for emergency</li>
<li>vm.extra_free_kbytes: reserve for application emergency<ul>
<li>not in centos 7 and ubuntu 20.04</li>
<li>work in centos 6<br>free mem &lt; vm.min_free_kbytes + vm.extra_free_kbytes &gt; kswapd scan and reclaim pages until high in &#x2F;proc&#x2F;zoneinfo</li>
</ul>
</li>
</ul>
<h4 id="x2F-proc-x2F-vmstat"><a href="#x2F-proc-x2F-vmstat" class="headerlink" title="&#x2F;proc&#x2F;vmstat"></a>&#x2F;proc&#x2F;vmstat</h4><ul>
<li>pgscan_kswapd reclaim<ul>
<li>pgscan_kswapd<ul>
<li>kswapd background scan page numbers</li>
</ul>
</li>
<li>pgsteal_kswapd<ul>
<li>kswapd background reclaim page numbers</li>
</ul>
</li>
<li>pgscan_direct<ul>
<li>Number of pages scanned by the kswapd daemon per second</li>
</ul>
</li>
<li>pgsteal_direct<ul>
<li>Number of pages scanned directly per second</li>
</ul>
</li>
</ul>
</li>
<li>fragmentation<ul>
<li>compact_stall</li>
<li>compact_fail</li>
<li>compact_success</li>
</ul>
</li>
<li>nr_dirty</li>
<li>drop_cache<ul>
<li>drop_pagecache<ul>
<li>drop page cache number</li>
</ul>
</li>
<li>drop_slab<ul>
<li>drop slab number</li>
</ul>
</li>
<li>pginodesteal<ul>
<li>direct reclaim inode page cache number</li>
</ul>
</li>
<li>kswapd_inodesteal<ul>
<li>kswapd background reclaim page cache number</li>
</ul>
</li>
</ul>
</li>
<li>IO<ul>
<li>pgpgin</li>
<li>pgpgout</li>
</ul>
</li>
<li>SWAP IO<ul>
<li>pswpin</li>
<li>pswpout</li>
</ul>
</li>
<li>workingset<ul>
<li>workingset_refault<ul>
<li>release pages read from disk to memory</li>
</ul>
</li>
<li>workingset_restore<ul>
<li>How many pages avoid to reclaimed, before release the page re-use<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Ei &#x27;drop|inodesteal|nr_dirty_&#x27; /proc/vmstat</span><br><span class="line">nr_dirty_threshold 48600882</span><br><span class="line">nr_dirty_background_threshold 24300441</span><br><span class="line">pginodesteal 255519573</span><br><span class="line">kswapd_inodesteal 902259110</span><br><span class="line">drop_pagecache 32</span><br><span class="line">drop_slab 48</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="OOM"><a href="#OOM" class="headerlink" title="OOM"></a>OOM</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -15 &gt; /proc/&lt;pid&gt;/oom_adj #reduce OOM kill ratio</span><br><span class="line"></span><br><span class="line">[Mon Apr 19 13:38:55 2021] Node 0 DMA free:14400kB min:28kB low:32kB high:40kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:15984kB managed:15900kB mlocked:0kB dirty:0kB writeback:0kB mapped:0kB shmem:0kB slab_reclaimable:0kB slab_unreclaimable:0kB kernel_stack:0kB pagetables:0kB unstable:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_unreclaimable? yes</span><br><span class="line">[Mon Apr 19 13:38:55 2021] lowmem_reserve[]: 0 1408 22531 22531</span><br></pre></td></tr></table></figure>

<p>lowmem_reserve<a href="22531*4kB">2</a> + low_watermark(low: 32kB) &gt; free pages(14400kB) - malloc N x pages (no enough malloc 1 page, because 22531*4kB &gt; free pages 14400kB)<br>failed to get memory from DMA    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Mon Apr 19 13:38:55 2021] Node 0 DMA32 free:87208kB min:2716kB low:3392kB high:4072kB active_anon:94576kB inactive_anon:94732kB active_file:328kB inactive_file:2784kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:1675200kB managed:1442720kB mlocked:0kB dirty:0kB writeback:0kB mapped:120kB shmem:4kB slab_reclaimable:114200kB slab_unreclaimable:32456kB kernel_stack:992kB pagetables:4212kB unstable:0kB bounce:0kB free_pcp:124kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:5910 all_unreclaimable? yes</span><br><span class="line">[Mon Apr 19 13:38:55 2021] lowmem_reserve[]: 0 0 21122 21122</span><br><span class="line">......</span><br><span class="line">[Mon Apr 19 13:38:55 2021] Free swap  = 0kB</span><br><span class="line">[Mon Apr 19 13:38:55 2021] Total swap = 16383996kB</span><br><span class="line">[Mon Apr 19 13:38:55 2021] 12219276 pages RAM</span><br><span class="line">[Mon Apr 19 13:38:55 2021] 0 pages HighMem/MovableOnly</span><br><span class="line">[Mon Apr 19 13:38:55 2021] 262387 pages reserved</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lowmem_reserve<a href="21122*4kB">2</a> + low_watermark(low: 3392kB) &gt; free pages(87208kB) - malloc N x pages (no enough malloc 1 page, because 87208-21122*4-3392&#x3D;-672)<br>For a memory request to be granted&#x2F;allocated the following check must pass:<br>low watermark + lowmem_reserve[2] &lt; free pages - n pages<br>low watermark - is the low watermark value in the zone;<br>lowmem_reserve - is a buffer watermark value to protect lower zones;<br>n pages - is the number of pages requested, in this case, it is 1;    </p>
<h4 id="show-the-swap"><a href="#show-the-swap" class="headerlink" title="show the swap"></a>show the swap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Get current swap usage for all running processes</span></span><br><span class="line"><span class="comment"># Erik Ljungstrom 27/05/2011</span></span><br><span class="line"><span class="comment"># Modified by Mikko Rantalainen 2012-08-09</span></span><br><span class="line"><span class="comment"># Pipe the output to &quot;sort -nk3&quot; to get sorted output</span></span><br><span class="line"><span class="comment"># Modified by Marc Methot 2014-09-18</span></span><br><span class="line"><span class="comment"># removed the need for sudo</span></span><br><span class="line"></span><br><span class="line">SUM=0</span><br><span class="line">OVERALL=0</span><br><span class="line"><span class="keyword">for</span> DIR <span class="keyword">in</span> `find /proc/ -maxdepth 1 -<span class="built_in">type</span> d -regex <span class="string">&quot;^/proc/[0-9]+&quot;</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    PID=`<span class="built_in">echo</span> <span class="variable">$DIR</span> | <span class="built_in">cut</span> -d / -f 3`</span><br><span class="line">    PROGNAME=`ps -p <span class="variable">$PID</span> -o <span class="built_in">comm</span> --no-headers`</span><br><span class="line">    <span class="keyword">for</span> SWAP <span class="keyword">in</span> `grep VmSwap <span class="variable">$DIR</span>/status 2&gt;/dev/null | awk <span class="string">&#x27;&#123; print $2 &#125;&#x27;</span>`</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">let</span> SUM=<span class="variable">$SUM</span>+<span class="variable">$SWAP</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">if</span> (( <span class="variable">$SUM</span> &gt; 0 )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;PID=<span class="variable">$PID</span> swapped <span class="variable">$SUM</span> KB (<span class="variable">$PROGNAME</span>)&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">let</span> OVERALL=<span class="variable">$OVERALL</span>+<span class="variable">$SUM</span></span><br><span class="line">    SUM=0</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Overall swap used: <span class="variable">$OVERALL</span> KB&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="valgrind"><a href="#valgrind" class="headerlink" title="valgrind"></a>valgrind</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valgrind --tool=memcheck --leak-check=yes --show-reachable=yes --num-callers=20 --track-fds=yes ./lustre_exporter</span><br></pre></td></tr></table></figure>

<h4 id="vmtouch"><a href="#vmtouch" class="headerlink" title="vmtouch"></a>vmtouch</h4><p>Show the pagecahe for the file   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ vmtouch  ixgbe-5.12.5.tar.gz</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 0/127  0/508K  0%</span><br><span class="line">         Elapsed: 4.1e-05 seconds</span><br><span class="line">$ cat ixgbe-5.12.5.tar.gz &gt; /dev/null</span><br><span class="line">$ vmtouch  ixgbe-5.12.5.tar.gz</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 127/127  508K/508K  100%</span><br><span class="line">         Elapsed: 5.2e-05 seconds</span><br><span class="line"></span><br><span class="line">$ dd if=ixgbe-5.12.5.tar.gz of=/dev/null bs=1M iflag=nocache</span><br><span class="line">0+1 records in</span><br><span class="line">0+1 records out</span><br><span class="line">518142 bytes (518 kB, 506 KiB) copied, 0.000246479 s, 2.1 GB/s</span><br><span class="line"></span><br><span class="line">$ vmtouch  ixgbe-5.12.5.tar.gz</span><br><span class="line">           Files: 1</span><br><span class="line">     Directories: 0</span><br><span class="line">  Resident Pages: 0/127  0/508K  0%</span><br><span class="line">         Elapsed: 4.1e-05 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="java-malloc"><a href="#java-malloc" class="headerlink" title="java malloc"></a>java malloc</h4><ul>
<li>glibc ptmalloc2</li>
<li>google tcmalloc</li>
<li>facebook jemalloc<ul>
<li>compare with ptmalloc2, In the multiple threads apps(fixed threads number), could get the beeter malloc(litt x bytes ~ xxx bytes) free performance</li>
<li>reduce the mem fragment, not test</li>
</ul>
</li>
<li>reduce arenas<ul>
<li>glibc ptmalloc2<ul>
<li>malloc per-thread memory arenas will case the mem fragment</li>
<li>MALLOC_ARENA_MAX &#x3D; 1 # disable per thread arena, and all threads share the main arena</li>
<li>MALLOC_ARENA_MAX &#x3D; 2</li>
<li><a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/tuning-glibc-memory-behavior">Setting MALLOC_ARENA_MAX to 2 or 1 makes glibc use fewer memory pools and potentially less memory, but this may reduce performance</a></li>
</ul>
</li>
<li>Switch to jemalloc</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://yoloz.github.io/2018/12/14/java/java%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8virt%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E9%AB%98%E7%9A%84%E9%97%AE%E9%A2%98%E7%A0%94%E7%A9%B6/">java</a><ul>
<li>limit mem by -Xmx, looks like there is no help</li>
<li>pmap -x $java_pid<ul>
<li>too many anon 64M memory<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Address           Kbytes     RSS   Dirty Mode  Mapping</span><br><span class="line">00007ff638021000   65404       0       0 -----    [ anon ]</span><br><span class="line">00007ff63c000000     132      36      36 rw---    [ anon ]</span><br><span class="line">00007ff63c021000   65404       0       0 -----    [ anon ]</span><br><span class="line">00007ff640000000     132      28      28 rw---    [ anon ]</span><br><span class="line">00007ff640021000   65404       0       0 -----    [ anon ]</span><br><span class="line">00007ff644000000     132       8       8 rw---    [ anon ]</span><br><span class="line">00007ff644021000   65404       0       0 -----    [ anon ]</span><br><span class="line">00007ff648000000     184     184     184 rw---    [ anon ]</span><br><span class="line">00007ff64802e000   65352       0       0 -----    [ anon ]</span><br><span class="line">00007ff64c000000     132     100     100 rw---    [ anon ]</span><br><span class="line">00007ff64c021000   65404       0       0 -----    [ anon ]</span><br><span class="line">00007ff650000000     132      56      56 rw---    [ anon ]</span><br><span class="line">00007ff650021000   65404       0       0 -----    [ anon ]</span><br><span class="line">00007ff654000000     132      16      16 rw---    [ anon ]</span><br><span class="line">00007ff654021000   65404       0       0 -----    [ anon ]</span><br><span class="line"></span><br><span class="line">These memory pools are called arenas and the implementation is in arena.c. The first important macro is HEAP_MAX_SIZE which is the maximum size of an arena and it is basically 1MB on 32-bit and 64MB on 64-bit:</span><br><span class="line"></span><br><span class="line">HEAP_MAX_SIZE = (2 * DEFAULT_MMAP_THRESHOLD_MAX)</span><br><span class="line">32-bit [DEFAULT_MMAP_THRESHOLD_MAX = (512 * 1024)] = 1, 048, 576 (1MB)</span><br><span class="line">64-bit [DEFAULT_MMAP_THRESHOLD_MAX = (4 1024 1024 * sizeof(long))] = 67, 108, 864 (64MB)</span><br><span class="line"></span><br><span class="line">p2 = (char *)mmap(aligned_heap_area, HEAP_MAX_SIZE, PROT_NONE,MAP_NORESERVE | MAP_ANONYMOUS | MAP_PRIVATE, -1, 0)</span><br><span class="line"></span><br><span class="line">export MALLOC_ARENA_MAX=1 means disable per thread arena, and all threads share the main arena</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hardware"><span class="toc-number">1.</span> <span class="toc-text">Hardware</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Host-Memory-Buffer-HMB"><span class="toc-number">1.1.</span> <span class="toc-text">Host Memory Buffer (HMB)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">2.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-64-5-level-page-table"><span class="toc-number">2.1.</span> <span class="toc-text">x86_64 5-level page table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#slabtop"><span class="toc-number">2.2.</span> <span class="toc-text">slabtop</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#slab-exhaust-all-memory-because-a-lot-of-scan"><span class="toc-number">2.2.1.</span> <span class="toc-text">slab exhaust all memory because a lot of scan</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Single-process-memory"><span class="toc-number">2.3.</span> <span class="toc-text">Single process memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Struct-page"><span class="toc-number">2.4.</span> <span class="toc-text">Struct page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#smem"><span class="toc-number">2.5.</span> <span class="toc-text">smem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kernel-Memory-Leak-Detector"><span class="toc-number">2.6.</span> <span class="toc-text">Kernel Memory Leak Detector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zram"><span class="toc-number">2.7.</span> <span class="toc-text">zram</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Make-sure-the-ECC-work-in-Linux"><span class="toc-number">2.8.</span> <span class="toc-text">Make sure the ECC work in Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Monitor-ECC-error"><span class="toc-number">2.9.</span> <span class="toc-text">Monitor ECC error</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#From-OS"><span class="toc-number">2.9.1.</span> <span class="toc-text">From OS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#From-IPMI"><span class="toc-number">2.9.2.</span> <span class="toc-text">From IPMI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Export-from-OS"><span class="toc-number">2.9.3.</span> <span class="toc-text">Export from OS</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memory-fragment"><span class="toc-number">2.10.</span> <span class="toc-text">memory fragment</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#check-the-fragment"><span class="toc-number">2.10.1.</span> <span class="toc-text">check the fragment</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ZRAM"><span class="toc-number">2.11.</span> <span class="toc-text">ZRAM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#numa"><span class="toc-number">2.12.</span> <span class="toc-text">numa</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Soft-lockup-detected-on-a-large-NUMA-system-under-a-heavy-memory-usage"><span class="toc-number">2.12.1.</span> <span class="toc-text">Soft lockup detected on a large NUMA system under a heavy memory usage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transparent-Huge-Page"><span class="toc-number">2.13.</span> <span class="toc-text">Transparent Huge Page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Use-hugetlbfs"><span class="toc-number">2.14.</span> <span class="toc-text">Use hugetlbfs</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#set-hugepage"><span class="toc-number">2.14.1.</span> <span class="toc-text">set hugepage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#free-hugepage"><span class="toc-number">2.14.2.</span> <span class="toc-text">free hugepage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memlock"><span class="toc-number">2.15.</span> <span class="toc-text">memlock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-pagesize"><span class="toc-number">2.16.</span> <span class="toc-text">get pagesize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memmap"><span class="toc-number">2.17.</span> <span class="toc-text">memmap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mapping-x2F-dev-x2F-pmemX-can-be-used-to-create-a-DAX-filesystem"><span class="toc-number">2.17.1.</span> <span class="toc-text">mapping &#x2F;dev&#x2F;pmemX can be used to create a DAX filesystem</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Benchmark-mem-by-perf"><span class="toc-number">2.18.</span> <span class="toc-text">Benchmark mem by perf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dirty-page"><span class="toc-number">2.19.</span> <span class="toc-text">dirty page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#meminfo"><span class="toc-number">2.20.</span> <span class="toc-text">meminfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x2F-proc-x2F-vmstat"><span class="toc-number">2.21.</span> <span class="toc-text">&#x2F;proc&#x2F;vmstat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OOM"><span class="toc-number">2.22.</span> <span class="toc-text">OOM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show-the-swap"><span class="toc-number">2.23.</span> <span class="toc-text">show the swap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#valgrind"><span class="toc-number">2.24.</span> <span class="toc-text">valgrind</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vmtouch"><span class="toc-number">2.25.</span> <span class="toc-text">vmtouch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#java-malloc"><span class="toc-number">2.26.</span> <span class="toc-text">java malloc</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/11/14/mem/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/11/14/mem/&text=memory"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/11/14/mem/&is_video=false&description=memory"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=memory&body=Check out this article: http://example.com/2022/11/14/mem/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/11/14/mem/&title=memory"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/11/14/mem/&name=memory&description=&lt;h3 id=&#34;Hardware&#34;&gt;&lt;a href=&#34;#Hardware&#34; class=&#34;headerlink&#34; title=&#34;Hardware&#34;&gt;&lt;/a&gt;Hardware&lt;/h3&gt;&lt;h4 id=&#34;Host-Memory-Buffer-HMB&#34;&gt;&lt;a href=&#34;#Host-Memory-Buffer-HMB&#34; class=&#34;headerlink&#34; title=&#34;Host Memory Buffer (HMB)&#34;&gt;&lt;/a&gt;Host Memory Buffer (HMB)&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.virtium.com/knowledge-base/how-to-select-between-dram-vs-dram-less-ssds/&#34;&gt;HMB vs DRAM-less&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;DRAM-less has the lower BW and OPS&lt;/li&gt;
&lt;li&gt;HMB has the more stable throughput for a long time&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Linux&#34;&gt;&lt;a href=&#34;#Linux&#34; class=&#34;headerlink&#34; title=&#34;Linux&#34;&gt;&lt;/a&gt;Linux&lt;/h3&gt;&lt;h4 id=&#34;x86-64-5-level-page-table&#34;&gt;&lt;a href=&#34;#x86-64-5-level-page-table&#34; class=&#34;headerlink&#34; title=&#34;x86_64 5-level page table&#34;&gt;&lt;/a&gt;x86_64 5-level page table&lt;/h4&gt;&lt;p&gt;Linear-address Translation Using 5-level paging   &lt;/p&gt;
&lt;h4 id=&#34;slabtop&#34;&gt;&lt;a href=&#34;#slabtop&#34; class=&#34;headerlink&#34; title=&#34;slabtop&#34;&gt;&lt;/a&gt;slabtop&lt;/h4&gt;&lt;p&gt;In-kernel data structures cache&lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#slab &amp;gt; 100M object&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /proc/slabinfo |awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;if($3*$4/1024/1024 &amp;gt; 100)&amp;#123;print $1,$3*$4/1024/1024&amp;#125; &amp;#125;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2554 x slabs&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56 x obj &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; a slab&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;total 8128 = 254 x 32, obj sieze=1K&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8128 x 1K = cache size = 8128K&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; 8128   7360  90%    1.00K    254        32      8128K kmalloc-1024&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;To free pagecache:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 1 &amp;gt; /proc/sys/vm/drop_caches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;To free dentries and inodes:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 2 &amp;gt; /proc/sys/vm/drop_caches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;To free pagecache, dentries and inodes:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 3 &amp;gt; /proc/sys/vm/drop_caches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#Got the free pages from buddyinfo&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;sum=0;for(i=5;i&amp;lt;=NF;i++) sum+=$i*(2^(i-5))&amp;#125;;&amp;#123;total+=sum*4096/1024/1024&amp;#125;;&amp;#123;print $1 &amp;quot; &amp;quot; $2 &amp;quot; &amp;quot; $3 &amp;quot; &amp;quot; $4 &amp;quot;\t : &amp;quot; sum*4096/1024/1024 &amp;quot;M&amp;quot;&amp;#125; END &amp;#123;print &amp;quot;total\t\t\t : &amp;quot; total &amp;quot;M&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/buddyinfo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;All processes mem= $(grep Pss /proc/[1-9]*/smaps | awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;total+=$2&amp;#125;; END &amp;#123;print total&amp;#125;&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;RSS mem = awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;sum+=$2&amp;#125; END&amp;#123;print sum*4&amp;quot; KiB&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/[1-9]*/statm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#there are little diff result with python version, because awk and python is not the same application, malloc diff mem&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;slab size = awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;sum=sum+$3*$4;&amp;#125;END&amp;#123;print sum/1024&amp;quot; KiB&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/slabinfo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pagetable size = awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;$0~/PageTables/&amp;#123;print $2&amp;quot; KiB&amp;quot;&amp;#125;&amp;#x27;&lt;/span&gt; /proc/meminfo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;The RSS contains some of duplicate part, some share lib, if you want the real value, get it from pmap    &lt;/p&gt;
&lt;h5 id=&#34;slab-exhaust-all-memory-because-a-lot-of-scan&#34;&gt;&lt;a href=&#34;#slab-exhaust-all-memory-because-a-lot-of-scan&#34; class=&#34;headerlink&#34; title=&#34;slab exhaust all memory because a lot of scan&#34;&gt;&lt;/a&gt;slab exhaust all memory because a lot of scan&lt;/h5&gt;&lt;p&gt;&lt;img src=&#34;/img/top-mem1.png&#34;&gt;&lt;br&gt;Why Slab&amp;#x3D;24021820 kB (24GB)&lt;br&gt;slabtop&lt;br&gt;&lt;img src=&#34;/img/slabtop1.png&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;Single-process-memory&#34;&gt;&lt;a href=&#34;#Single-process-memory&#34; class=&#34;headerlink&#34; title=&#34;Single process memory&#34;&gt;&lt;/a&gt;Single process memory&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;       /proc/[pid]/statm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              Provides information about memory usage, measured &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; pages.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              The columns are:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  size       (1) total program size&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                             (same as VmSize &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; /proc/[pid]/status)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  resident   (2) resident &lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt; size&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                             (same as VmRSS &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; /proc/[pid]/status)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  shared     (3) number of resident shared pages (i.e., backed by a file)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                             (same as RssFile+RssShmem &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; /proc/[pid]/status)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  text       (4) text (code)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  lib        (5) library (unused since Linux 2.6; always 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  data       (6) data + stack&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                  dt         (7) dirty pages (unused since Linux 2.6; always 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /proc/3760/statm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;400865 96456 37653 27355 0 157019 0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Second field means res (resident)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;pmap $(pgrep bash)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;There are some of share library &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; each resident&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;If you want get share library memory consumption.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/proc/[pid]/smaps (since Linux 2.6.14)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;              This file shows memory consumption &lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; each of the process&lt;span class=&#34;string&#34;&gt;&amp;#x27;s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;              mappings.  (The pmap(1) command displays similar information,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;              in a form that may be easier for parsing.)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;h4 id=&#34;Struct-page&#34;&gt;&lt;a href=&#34;#Struct-page&#34; class=&#34;headerlink&#34; title=&#34;Struct page&#34;&gt;&lt;/a&gt;Struct page&lt;/h4&gt;&lt;p&gt;page frame minimum unit. every page frame has a struct page to point&lt;br&gt;&lt;a href=&#34;https://stackoverflow.com/questions/34836806/how-to-get-physical-address-from-struct-page-in-linux-kernel&#34;&gt;struct page could mapping page frame to physical address&lt;/a&gt;&lt;br&gt;all page frame in the LUR list.&lt;br&gt;There are 2.3%(96&amp;#x2F;4096) usage in linux 2.6.32&lt;/p&gt;
&lt;h4 id=&#34;smem&#34;&gt;&lt;a href=&#34;#smem&#34; class=&#34;headerlink&#34; title=&#34;smem&#34;&gt;&lt;/a&gt;smem&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ smem -u&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;User     Count     Swap      USS      PSS      RSS&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chrony       1        0      584      621     1316&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;rpc          1        0      604      633     1120&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -m&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -w&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -t&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem -c &lt;span class=&#34;string&#34;&gt;&amp;quot;name user pss&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ smem --bar &lt;span class=&#34;variable&#34;&gt;$pid&lt;/span&gt; -c &lt;span class=&#34;string&#34;&gt;&amp;quot;pss uss&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&#34;Kernel-Memory-Leak-Detector&#34;&gt;&lt;a href=&#34;#Kernel-Memory-Leak-Detector&#34; class=&#34;headerlink&#34; title=&#34;Kernel Memory Leak Detector&#34;&gt;&lt;/a&gt;&lt;a href=&#34;https://www.kernel.org/doc/html/latest/dev-tools/kmemleak.html&#34;&gt;Kernel Memory Leak Detector&lt;/a&gt;&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ modprobe kmemleak-test&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; scan &amp;gt; /sys/kernel/debug/kmemleak&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /sys/kernel/debug/kmemleak&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## centos not enabled by defualt&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ grep CONFIG_DEBUG_KMEMLEAK /boot/config-4.18.0-305.el8.x86_64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ CONFIG_DEBUG_KMEMLEAK is not &lt;span class=&#34;built_in&#34;&gt;set&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&#34;zram&#34;&gt;&lt;a href=&#34;#zram&#34; class=&#34;headerlink&#34; title=&#34;zram&#34;&gt;&lt;/a&gt;&lt;a href=&#34;http://www.wowotech.net/memory_management/zram.html&#34;&gt;zram&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;CentOS 7 only work for lzo and the performance was not good enough  &lt;/p&gt;
&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; lz4 &amp;gt; /sys/block/zram0/comp_algorithm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-bash: &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt;: write error: Invalid argument&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;cat&lt;/span&gt; /sys/block/zram0/comp_algorithm&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[lzo]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ modprobe zram num_devices=2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 8589934592 &amp;gt; /sys/block/zram0/disksize&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 8589934592 &amp;gt; /sys/block/zram1/disksize&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ swapoff -a&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ mkswap /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ mkswap /dev/zram1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ swapon /dev/zram0 /dev/zram1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;or&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ modprobe zram num_devices=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; 68719476736 &amp;gt; /sys/block/zram0/disksize&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ mkfs.ext4 /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ tune2fs -m0 /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;tune2fs 1.42.9 (28-Dec-2013)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Setting reserved blocks percentage to 0% (0 blocks)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;## no compression function&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ zpool create -o ashift=0 -o multihost=off -O compression=zstd -O primarycache=none -O secondarycache=none tank /dev/zram0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ sh zram.info&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Physical memory:     134,928,179,200 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Buffers and cache:       812,810,240 bytes /  0.6% of physical memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Unallocated:             825,503,744 bytes /  0.6% of physical memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Compressed:           19,495,145,472 bytes / 14.4% of physical memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Decompressed size:    33,168,183,296 bytes / 22.3% of decompressed memory&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Compression ratio: 1.701&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;#!/bin/sh -eu&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TOTAL_DATA=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;TOTAL_COMP=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HAS_ZRAM=0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# Iterate through swap devices searching for compressed ones&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; NAME _; &lt;span class=&#34;keyword&#34;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# Filter zram swaps and let&amp;#x27;s hope your ordinary swap doesn&amp;#x27;t have&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;# &amp;quot;zram&amp;quot; in its name :D&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$NAME&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        *zram*) ;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        *) &lt;span class=&#34;built_in&#34;&gt;continue&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;esac&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    DIR=/sys`udevadm info --query=path --name=&lt;span class=&#34;variable&#34;&gt;$NAME&lt;/span&gt;`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    DATA=$(awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;print $1&amp;#125;&amp;#x27;&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$DIR&lt;/span&gt;/mm_stat)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    COMP=$(awk &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#123;print $3&amp;#125;&amp;#x27;&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$DIR&lt;/span&gt;/mm_stat)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    TOTAL_DATA=$((TOTAL_DATA + DATA))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    TOTAL_COMP=$((TOTAL_COMP + COMP))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    HAS_ZRAM=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;done&lt;/span&gt; &amp;lt;/proc/swaps&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# Extract physical memory in kibibytes and scale back to bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ MEM_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ FREE_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ BUF_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;read&lt;/span&gt; _ CACHE_KIB _&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &amp;lt;/proc/meminfo&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;/usr/bin/printf &lt;span class=&#34;string&#34;&gt;&amp;quot;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Physical memory:   %&amp;#x27;17d bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Buffers and cache: %&amp;#x27;17d bytes / %4.1f%% of physical memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Unallocated:       %&amp;#x27;17d bytes / %4.1f%% of physical memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;/span&gt; `&lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;scale=6; 1024*&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;; 1024*(&lt;span class=&#34;variable&#34;&gt;$BUF_KIB&lt;/span&gt;+&lt;span class=&#34;variable&#34;&gt;$CACHE_KIB&lt;/span&gt;); 100*(&lt;span class=&#34;variable&#34;&gt;$BUF_KIB&lt;/span&gt;+&lt;span class=&#34;variable&#34;&gt;$CACHE_KIB&lt;/span&gt;)/&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;; 1024*&lt;span class=&#34;variable&#34;&gt;$FREE_KIB&lt;/span&gt;; 100*&lt;span class=&#34;variable&#34;&gt;$FREE_KIB&lt;/span&gt;/&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;&amp;quot;&lt;/span&gt;|bc`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;span class=&#34;variable&#34;&gt;$HAS_ZRAM&lt;/span&gt;&amp;quot;&lt;/span&gt;; &lt;span class=&#34;keyword&#34;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    /usr/bin/printf &lt;span class=&#34;string&#34;&gt;&amp;quot;\&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Compressed:        %&amp;#x27;17d bytes / %4.1f%% of physical memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Decompressed size: %&amp;#x27;17d bytes / %4.1f%% of decompressed memory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;Compression ratio: %.3f&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;&lt;/span&gt; `&lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;scale=6; &lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;; 100*&lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;/&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;/1024; &lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;; 100*&lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;/(1024*&lt;span class=&#34;variable&#34;&gt;$MEM_KIB&lt;/span&gt;-&lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;+&lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;); &lt;span class=&#34;variable&#34;&gt;$TOTAL_DATA&lt;/span&gt;/&lt;span class=&#34;variable&#34;&gt;$TOTAL_COMP&lt;/span&gt;&amp;quot;&lt;/span&gt;|bc`&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;Compressed:                        0 bytes / zram not in use&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;fi&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&#34;Make-sure-the-ECC-work-in-Linux&#34;&gt;&lt;a href=&#34;#Make-sure-the-ECC-work-in-Linux&#34; class=&#34;headerlink&#34; title=&#34;Make sure the ECC work in Linux&#34;&gt;&lt;/a&gt;Make sure the ECC work in Linux&lt;/h4&gt;&lt;figure class=&#34;highlight bash&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;$ dmidecode -t memory  | grep -Ei &lt;span class=&#34;string&#34;&gt;&amp;#x27;error correction type&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Error Correction Type: Single-bit ECC&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;$ dmidecode -t memory  | grep -Ei &lt;span class=&#34;string&#34;&gt;&amp;#x27;error correction type&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        Error Correction Type: Multi-bit ECC&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/11/14/mem/&t=memory"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Read XC Series Lustre Administration Guide_CLE 7.0.UP04_S-2572Key word MGS Management Server  MGT Management Target  MDS Metadata Server  MDT Metadata Target  OSS Object Storage Server  OST Object Sto">
<meta property="og:type" content="article">
<meta property="og:title" content="lfs command">
<meta property="og:url" content="http://example.com/2019/12/29/lfs_cmd-u1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Read XC Series Lustre Administration Guide_CLE 7.0.UP04_S-2572Key word MGS Management Server  MGT Management Target  MDS Metadata Server  MDT Metadata Target  OSS Object Storage Server  OST Object Sto">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-12-29T07:41:16.000Z">
<meta property="article:modified_time" content="2025-02-24T09:54:39.381Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="fs">
<meta property="article:tag" content="filesys">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>lfs command</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2019/12/29/lfs_cmd/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2019/11/26/xfs/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2019/12/29/lfs_cmd-u1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2019/12/29/lfs_cmd-u1/&text=lfs command"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2019/12/29/lfs_cmd-u1/&is_video=false&description=lfs command"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=lfs command&body=Check out this article: http://example.com/2019/12/29/lfs_cmd-u1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2019/12/29/lfs_cmd-u1/&name=lfs command&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2019/12/29/lfs_cmd-u1/&t=lfs command"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-XC-Series-Lustre-Administration-Guide-CLE-7-0-UP04-S-2572"><span class="toc-number">1.</span> <span class="toc-text">Read XC Series Lustre Administration Guide_CLE 7.0.UP04_S-2572</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-word"><span class="toc-number">2.</span> <span class="toc-text">Key word</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#INSTALLAION"><span class="toc-number">3.</span> <span class="toc-text">INSTALLAION</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFS-PARAMETERS"><span class="toc-number">4.</span> <span class="toc-text">LFS PARAMETERS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ALL-NORMAL-OTHERS"><span class="toc-number">4.1.</span> <span class="toc-text">ALL NORMAL OTHERS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DUMP"><span class="toc-number">4.1.1.</span> <span class="toc-text">DUMP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NORMAL-COMMAND"><span class="toc-number">4.1.2.</span> <span class="toc-text">NORMAL COMMAND</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PARTITION"><span class="toc-number">4.1.3.</span> <span class="toc-text">PARTITION</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#lloger"><span class="toc-number">4.1.4.</span> <span class="toc-text">lloger</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TIMEOUT-timeout"><span class="toc-number">4.1.5.</span> <span class="toc-text">TIMEOUT timeout</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#KENREL-MODULE"><span class="toc-number">4.1.6.</span> <span class="toc-text">KENREL MODULE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CLIENT"><span class="toc-number">4.2.</span> <span class="toc-text">CLIENT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#check-status"><span class="toc-number">4.2.1.</span> <span class="toc-text">check status</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lustre-stripe"><span class="toc-number">4.2.2.</span> <span class="toc-text">Lustre stripe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NFS-export"><span class="toc-number">4.2.3.</span> <span class="toc-text">NFS export</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#METADATA-Increase-dir-traversal"><span class="toc-number">4.2.4.</span> <span class="toc-text">METADATA Increase dir traversal</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Client-monitor-CLIENT-MONITOR"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">Client monitor CLIENT MONITOR</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MEMORY"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">MEMORY</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDS"><span class="toc-number">4.3.</span> <span class="toc-text">MDS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mkfs-ldiskfs-options"><span class="toc-number">4.3.1.</span> <span class="toc-text">mkfs ldiskfs options</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSS"><span class="toc-number">4.4.</span> <span class="toc-text">OSS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OSS-parameters"><span class="toc-number">4.4.1.</span> <span class="toc-text">OSS parameters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OSS-index"><span class="toc-number">4.4.2.</span> <span class="toc-text">OSS index</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FEATURES"><span class="toc-number">5.</span> <span class="toc-text">FEATURES</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Progressive-File-Layout-PFL"><span class="toc-number">5.1.</span> <span class="toc-text">Progressive File Layout (PFL)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NODEMAP-nodemap"><span class="toc-number">5.2.</span> <span class="toc-text">NODEMAP nodemap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROUTER"><span class="toc-number">5.3.</span> <span class="toc-text">ROUTER</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BUG-ISSUE-CASES"><span class="toc-number">6.</span> <span class="toc-text">BUG ISSUE CASES</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-15-3"><span class="toc-number">6.1.</span> <span class="toc-text">2.15.3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDS-wait-OST-because-little-number-of-OST-OST-precreate-slow"><span class="toc-number">6.2.</span> <span class="toc-text">MDS wait OST because little number of OST, OST precreate slow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HOT-FILE"><span class="toc-number">6.3.</span> <span class="toc-text">HOT FILE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HOT-FILE-CASE1"><span class="toc-number">6.3.1.</span> <span class="toc-text">HOT FILE CASE1</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HOT-FILE-CASE2"><span class="toc-number">6.4.</span> <span class="toc-text">HOT FILE CASE2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HOT-FILE-cache-read-write"><span class="toc-number">6.5.</span> <span class="toc-text">HOT FILE cache read&#x2F;write</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        lfs command
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-12-29T07:41:16.000Z" itemprop="datePublished">2019-12-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Storage/">Storage</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/filesys/" rel="tag">filesys</a>, <a class="tag-link-link" href="/tags/fs/" rel="tag">fs</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="Read-XC-Series-Lustre-Administration-Guide-CLE-7-0-UP04-S-2572"><a href="#Read-XC-Series-Lustre-Administration-Guide-CLE-7-0-UP04-S-2572" class="headerlink" title="Read XC Series Lustre Administration Guide_CLE 7.0.UP04_S-2572"></a>Read <a target="_blank" rel="noopener" href="https://support.hpe.com/hpesc/public/docDisplay?docId=sd00002130en_us&docLocale=en_US&page=Standard-Remote_support.html">XC Series Lustre Administration Guide_CLE 7.0.UP04_S-2572</a></h3><h3 id="Key-word"><a href="#Key-word" class="headerlink" title="Key word"></a>Key word</h3><ul>
<li><p>MGS Management Server</p>
</li>
<li><p>MGT Management Target</p>
</li>
<li><p>MDS Metadata Server</p>
</li>
<li><p>MDT Metadata Target</p>
</li>
<li><p>OSS Object Storage Server</p>
</li>
<li><p>OST Object Storage Target</p>
</li>
<li><p>FDR Fourteen Data Rate </p>
</li>
<li><p>IB Infiniband</p>
</li>
<li><p>OPA Omni-Path Architecture</p>
</li>
<li><p>LNet Lustre Networking</p>
</li>
<li><p>RAID Redundant Array of Independent Disks</p>
</li>
<li><p>PFL Progressive File Layout</p>
</li>
<li><p>DoM Data on MDT</p>
</li>
<li><p>SEL Self Extending Layout</p>
</li>
<li><p>DNE Distributed Namespace </p>
</li>
<li><p>EA Extended Attribute</p>
</li>
<li><p>OSC Object Storage Client </p>
</li>
<li><p>LMV Logical Metadata Volume</p>
</li>
<li><p>VFS Virtual File System</p>
</li>
<li><p>LOV Logical Object Volume</p>
</li>
<li><p>PTL-RPC Portal Remote Procedure Call</p>
</li>
<li><p>LDLM Lustre Distributed Lock Manager</p>
</li>
<li><p>OBD Object Based Disk</p>
</li>
<li><p>OFD OBD Filter Device</p>
</li>
<li><p>OSD Object Storage Device</p>
</li>
<li><p>MDC Metadata Client</p>
</li>
<li><p>LTS Lustre Test Suites</p>
</li>
<li><p>HSM Hierarchical Storage Manager</p>
</li>
<li><p>IOR Interleaved or Random</p>
</li>
<li><p>MGC Management Client</p>
</li>
<li><p>LRU Least Recently Used</p>
</li>
<li><p>FLD FID Location Database</p>
</li>
<li><p>FID File Identifier</p>
</li>
<li><p>LWP Light Weight Proxy     </p>
</li>
<li><p>CPT CPU Partition Table</p>
</li>
<li><p>NUMA Non-Uniform Memory Access</p>
</li>
<li><p>SMP Symmetric Multi-Processing</p>
</li>
<li><p>OSP Object Storage Proxy</p>
</li>
<li><p>OI Object Index</p>
</li>
<li><p>IGIF Inode and Generation In FID</p>
</li>
<li><p>IDIF Object ID In FID</p>
</li>
<li><p>UUID Universally Unique Identifier</p>
</li>
<li><p>NID Network Identifier</p>
</li>
<li><p>LND lnet_lnd_timeout</p>
</li>
<li><p>AFR Asymmetric Router Failure</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://hpcf.umbc.edu/general-productivity/lfs-best-practices/">The lfs server can only handle about 15,000 remote procedure calls (RPCs, inter-process communications that allow the client to cause a procedure to be executed on the server) per second. Contention slows the performance of your applications and weakens the overall health of the lfs filesystem</a></p>
<ul>
<li>Avoid Using ls -l</li>
<li>Avoid Having a Large Number of Files in a Single Directory</li>
<li>Avoid Accessing Small Files</li>
<li>Avoid Repetitive “stat” Operations</li>
<li>Avoid Having Multiple Processes Open the Same File(s) at the Same Time</li>
<li>Avoid Repetitive Open&#x2F;Close Operations</li>
</ul>
</li>
</ul>
<h3 id="INSTALLAION"><a href="#INSTALLAION" class="headerlink" title="INSTALLAION"></a>INSTALLAION</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find /usr /var /etc/ -<span class="built_in">type</span> d | grep 4.18.0-553.5.1 <span class="comment">#&lt;---kernel version</span></span><br></pre></td></tr></table></figure>
<p>Deleting in preparation for a symlink<br>remove all installation directory, because some of kernel module link not removed cause create link failed in reinstall</p>
<h3 id="LFS-PARAMETERS"><a href="#LFS-PARAMETERS" class="headerlink" title="LFS PARAMETERS"></a>LFS PARAMETERS</h3><h4 id="ALL-NORMAL-OTHERS"><a href="#ALL-NORMAL-OTHERS" class="headerlink" title="ALL NORMAL OTHERS"></a>ALL NORMAL OTHERS</h4><h5 id="DUMP"><a href="#DUMP" class="headerlink" title="DUMP"></a>DUMP</h5><ul>
<li>echo 1 &gt; &#x2F;sys&#x2F;fs&#x2F;lustre&#x2F;dump_on_eviction<ul>
<li>Triggers a dump of the Lustre debug log when an eviction occurs. The default value of 0 (zero) means a dump of the Lustre debug log will not be triggered.</li>
</ul>
</li>
<li>echo 1 &gt; &#x2F;sys&#x2F;fs&#x2F;lustre&#x2F;dump_on_timeout<ul>
<li>Triggers a dump of the Lustre debug log when a timeout occurs. The default value of 0 (zero) means a dump of the Lustre debug log will not be triggered</li>
</ul>
</li>
</ul>
<h5 id="NORMAL-COMMAND"><a href="#NORMAL-COMMAND" class="headerlink" title="NORMAL COMMAND"></a>NORMAL COMMAND</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e2label /dev/sdb1</span><br><span class="line">lustre-MDT0000</span><br></pre></td></tr></table></figure>

<h5 id="PARTITION"><a href="#PARTITION" class="headerlink" title="PARTITION"></a>PARTITION</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#lustre mdt show backup block</span></span><br><span class="line">$ dumpe2fs /dev/sdb1  | grep  -E <span class="string">&#x27;Primary|backup&#x27;</span> -i</span><br><span class="line">dumpe2fs 1.47.1-wc1 (28-May-2024)</span><br><span class="line">Journal backup:           inode blocks</span><br><span class="line">  Primary superblock at 0, Group descriptors at 1-22</span><br><span class="line">  Backup superblock at 20480, Group descriptors at 20481-20502</span><br><span class="line">  Backup superblock at 61440, Group descriptors at 61441-61462</span><br><span class="line">  Backup superblock at 102400, Group descriptors at 102401-102422</span><br><span class="line">  Backup superblock at 143360, Group descriptors at 143361-143382</span><br><span class="line">  Backup superblock at 184320, Group descriptors at 184321-184342</span><br><span class="line">  Backup superblock at 512000, Group descriptors at 512001-512022</span><br><span class="line">  Backup superblock at 552960, Group descriptors at 552961-552982</span><br><span class="line">  Backup superblock at 1003520, Group descriptors at 1003521-1003542</span><br><span class="line">  Backup superblock at 1658880, Group descriptors at 1658881-1658902</span><br><span class="line">  Backup superblock at 2560000, Group descriptors at 2560001-2560022</span><br><span class="line">  Backup superblock at 4976640, Group descriptors at 4976641-4976662</span><br><span class="line">  Backup superblock at 7024640, Group descriptors at 7024641-7024662</span><br><span class="line">  Backup superblock at 12800000, Group descriptors at 12800001-12800022</span><br><span class="line">  Backup superblock at 14929920, Group descriptors at 14929921-14929942</span><br><span class="line">  Backup superblock at 44789760, Group descriptors at 44789761-44789782</span><br><span class="line">  Backup superblock at 49172480, Group descriptors at 49172481-49172502</span><br><span class="line"></span><br><span class="line">$ e2fsck -b 20480 /dev/sdb1  &lt;--------------------------- <span class="built_in">return</span> error too, that why <span class="keyword">for</span> loop not found it, it could not be mount, must be fsck, when the primary superblock fixed, mount it</span><br><span class="line">e2fsck 1.47.1-wc1 (28-May-2024)</span><br><span class="line">e2fsck: MMP: e2fsck being run <span class="keyword">while</span> checking MMP block</span><br><span class="line">MMP check failed: If you are sure the filesystem is not <span class="keyword">in</span> use on any node, run:</span><br><span class="line"><span class="string">&#x27;tune2fs -f -E clear_mmp lustre1-MDT0000&#x27;</span>  &lt;-------------------------------------------<span class="built_in">disable</span> MMP</span><br><span class="line">MMP_block:</span><br><span class="line">    mmp_magic: 0x4d4d50</span><br><span class="line">    mmp_check_interval: 5</span><br><span class="line">    mmp_sequence: e24d4d50</span><br><span class="line">    mmp_update_date: Mon Nov 18 14:00:29 2024</span><br><span class="line">    mmp_update_time: 1731909629</span><br><span class="line">    mmp_node_name: linux_test_46-231</span><br><span class="line">    mmp_device_name: /dev/sdb1</span><br><span class="line">$  e2fsck -b 20481 /dev/sdb1</span><br><span class="line">e2fsck 1.47.1-wc1 (28-May-2024)</span><br><span class="line">e2fsck: Bad magic number <span class="keyword">in</span> super-block <span class="keyword">while</span> trying to open /dev/sdb1</span><br><span class="line"></span><br><span class="line">The superblock could not be <span class="built_in">read</span> or does not describe a valid ext2/ext3/ext4</span><br><span class="line">filesystem.  If the device is valid and it really contains an ext2/ext3/ext4</span><br><span class="line">filesystem (and not swap or ufs or something <span class="keyword">else</span>), <span class="keyword">then</span> the superblock</span><br><span class="line">is corrupt, and you might try running e2fsck with an alternate superblock:</span><br><span class="line">    e2fsck -b 8193 &lt;device&gt;</span><br><span class="line"></span><br><span class="line">e2fsck -b 20480 /dev/sdb1 2&gt;&amp;1 | hexdump -C  &lt;---------------------------------------means you can<span class="string">&#x27;t filter by grep</span></span><br><span class="line"><span class="string">00000000  65 32 66 73 63 6b 20 31  2e 34 37 2e 31 2d 77 63  |e2fsck 1.47.1-wc|</span></span><br><span class="line"><span class="string">00000010  31 20 28 32 38 2d 4d 61  79 2d 32 30 32 34 29 0a  |1 (28-May-2024).|</span></span><br><span class="line"><span class="string">00000020  65 32 66 73 63 6b 3a 20  6e 65 65 64 20 74 65 72  |e2fsck: need ter|</span></span><br><span class="line"><span class="string">00000030  6d 69 6e 61 6c 20 66 6f  72 20 69 6e 74 65 72 61  |minal for intera|</span></span><br><span class="line"><span class="string">00000040  63 74 69 76 65 20 72 65  70 61 69 72 73 0a        |ctive repairs.|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">############ -----------------------------------------------------------&gt; resolve it by script command</span></span><br><span class="line"><span class="string">$ script --timing=time.txt script.log</span></span><br><span class="line"><span class="string">Script started, file is script.log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ for i in &#123;20479..20480&#125;; do echo &quot;offset: $i&quot;; e2fsck -b $i /dev/sdb1; done</span></span><br><span class="line"><span class="string">offset: 20479</span></span><br><span class="line"><span class="string">e2fsck 1.47.1-wc1 (28-May-2024)</span></span><br><span class="line"><span class="string">e2fsck: Bad magic number in super-block while trying to open /dev/sdb1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The superblock could not be read or does not describe a valid ext2/ext3/ext4</span></span><br><span class="line"><span class="string">filesystem.  If the device is valid and it really contains an ext2/ext3/ext4</span></span><br><span class="line"><span class="string">filesystem (and not swap or ufs or something else), then the superblock</span></span><br><span class="line"><span class="string">is corrupt, and you might try running e2fsck with an alternate superblock:</span></span><br><span class="line"><span class="string">    e2fsck -b 8193 &lt;device&gt;</span></span><br><span class="line"><span class="string"> or</span></span><br><span class="line"><span class="string">    e2fsck -b 32768 &lt;device&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">offset: 20480</span></span><br><span class="line"><span class="string">e2fsck 1.47.1-wc1 (28-May-2024)</span></span><br><span class="line"><span class="string">e2fsck: MMP: e2fsck being run while checking MMP block</span></span><br><span class="line"><span class="string">MMP check failed: If you are sure the filesystem is not in use on any node, run:</span></span><br><span class="line"><span class="string">&#x27;</span>tune2fs -f -E clear_mmp lustre1-MDT0000<span class="string">&#x27;</span></span><br><span class="line"><span class="string">MMP_block:</span></span><br><span class="line"><span class="string">    mmp_magic: 0x4d4d50</span></span><br><span class="line"><span class="string">    mmp_check_interval: 5</span></span><br><span class="line"><span class="string">    mmp_sequence: e24d4d50</span></span><br><span class="line"><span class="string">    mmp_update_date: Mon Nov 18 14:00:29 2024</span></span><br><span class="line"><span class="string">    mmp_update_time: 1731909629</span></span><br><span class="line"><span class="string">    mmp_node_name: linux_test_46-231</span></span><br><span class="line"><span class="string">    mmp_device_name: /dev/sdb1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">lustre1-MDT0000: ***** FILE SYSTEM WAS MODIFIED *****</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">lustre1-MDT0000: ********** WARNING: Filesystem still has errors **********</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ exit</span></span><br><span class="line"><span class="string">Script done, file is script.log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ grep -B 4 clear_mmp script.log  | grep offset</span></span><br><span class="line"><span class="string">offset: 20480</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#reference: https://unix.stackexchange.com/questions/180036/how-do-i-use-yes-with-e2fsck</span></span><br><span class="line"><span class="string">$ (echo n; yes) | script --return -c &quot;e2fsck /dev/sda1&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># if partition table</span></span><br><span class="line"><span class="string">Number  Start  End         Size        File system  Name  Flags</span></span><br><span class="line"><span class="string"> 1      2048s  106493951s  106491904s  ext4         p1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ parted /dev/sda rm 1</span></span><br><span class="line"><span class="string">$ mount -t lustre -o offset=$((512*2048)) /dev/sda /mnt #worked</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### step 3</span></span><br><span class="line"><span class="string">because ext4 filesystem default is 4KiB, some block device is 512Bytes sector, it means you convert it</span></span><br><span class="line"><span class="string">if you want to skip partition table</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#if you force fix it, maybe the whole partition table will be override by ext4 superblock...... dangerous !!!</span></span><br><span class="line"><span class="string">&quot;e2fsck -b $((512*2048/4096+32768)) /dev/sda&quot; not full same with &quot;e2fsck -b 32768 /dev/sda1&quot;</span></span><br><span class="line"><span class="string">                 |                                                          |</span></span><br><span class="line"><span class="string">     after fixed, could not mount                                 after fixed, mount successful</span></span><br><span class="line"><span class="string">     but, you can mount it by -t ldiskfs ,backup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#recovery backup GPT table no help, because all metadata are moved, re-part and e2fsck -b 32768 /dev/sda1 not working</span></span><br><span class="line"><span class="string">Error: The primary GPT table is corrupt, but the backup appears OK, so that will be used.</span></span><br><span class="line"><span class="string">OK/Cancel? OK</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### another option is , when the parition table lost, you can re-part it directly, the fix destroy primary gpt partition , when you re-part it ,show this warn... and select OK</span></span><br><span class="line"><span class="string">after format</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ parted /dev/sda rm 1</span></span><br><span class="line"><span class="string">$ parted /dev/sda mkpart p1 ext4 2048s 100%</span></span><br><span class="line"><span class="string">$ mount -t lustre /dev/sda1 /test/test_mgt0 #successful</span></span><br></pre></td></tr></table></figure>

<h5 id="lloger"><a href="#lloger" class="headerlink" title="lloger"></a><a target="_blank" rel="noopener" href="https://lustre-discuss.lustre.narkive.com/umKcSrmP/how-to-view-all-config-param">lloger</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t ldiskfs /dev/sda /mnt/mgs</span><br><span class="line">$ /usr/sbin/llog-reader /mnt/mgs/CONFIGS/testfs-client</span><br><span class="line"></span><br><span class="line"><span class="comment">#not umount, direct read</span></span><br><span class="line">$ debugfs -c -R <span class="string">&#x27;dump CONFIGS/testfs-client /tmp/testfs-client&#x27;</span> /dev/sda llog_reader /tmp/testfs-client</span><br></pre></td></tr></table></figure>

<h5 id="TIMEOUT-timeout"><a href="#TIMEOUT-timeout" class="headerlink" title="TIMEOUT timeout"></a>TIMEOUT <a target="_blank" rel="noopener" href="https://www.opensfs.org/wp-content/uploads/LUG23_Understanding_Timeouts.pdf">timeout</a></h5><ul>
<li>lctl set_param -P timeout&#x3D;300<ul>
<li>The time that a client waits for a server to complete an RPC (default 100s).</li>
<li>Servers wait half this time for a normal client RPC to complete and a quarter of this time for a single bulk request (read or write of up to 4MB) to complete.</li>
<li>The client pings recoverable targets (MDS and OSTs) at one quarter of the timeout, and the server waits one and a half times the timeout before evicting a client for being “stale.”</li>
<li>Lustre client sends periodic ‘ping’ messages to servers with which it has had no communication for the specified period of time</li>
<li>Any network activity between a client and a server in the file system also serves as a ping</li>
<li>Imperative recovery timeout &#x3D; 4 * obd_timeout</li>
<li>LDLM completion AST timeout &#x3D; obd_timeout</li>
<li>LDLM blocking AST timeout &#x3D; obd_timeout &#x2F; 2</li>
<li>Time to wait for OSC connection to become active &#x3D; obd_timeout</li>
<li>OBD ping interval &#x3D; obd_timeout &#x2F; 4</li>
<li>Time server waits for client reply to AST callback &#x3D; obd_timeout &#x2F; 2</li>
<li>PTLRPC health check &#x3D; obd_timeout * 3 &#x2F; 2 (instead of at_max)</li>
<li>Watchdog timeout &#x3D; 10 * obd_timeout</li>
</ul>
</li>
<li>ldlm_timeout<ul>
<li>(default &#x3D; 20 s&#x2F;6 s for OST&#x2F;MDS)</li>
<li>Time that server waits for client to reply to a lock cancellation request</li>
<li>The time that a server waits for a client to reply to an initial AST (lock cancellation request). The default is 20s for an OST and 6s for an MDS. If the client replies to the AST, the server will give it a normal timeout (half the client timeout) to flush any dirty data and release the lock</li>
<li>PTLRPC requests set a static time based on ldlm_timeout and obd_timeout<ul>
<li>min( ldlm_timeout, obd_timeout &#x2F; 3 )</li>
</ul>
</li>
<li>But there are restrictions on setting ldlm_timeout<ul>
<li>If ldlm_timeout &gt; obd_timeout, then ldlm_timeout &#x3D; obd_timeout &#x2F; 3</li>
</ul>
</li>
</ul>
</li>
<li>Bulk IO Timeou<ul>
<li>lctl get_param bulk_timeout (default &#x3D; 100 s)</li>
<li>If the deadline set in the RPC request is &gt; bulk_timeout, bulk_timeout is used for the deadline instead<ul>
<li>Sets a hard limit on time for bulk IO regardless of other timeout values</li>
<li>Lustre code doesn’t seem to alter the deadline in the RPC request itself</li>
</ul>
</li>
</ul>
</li>
<li>lnet timeout<ul>
<li>lnet_transaction_timeout (default &#x3D; 50 s)<ul>
<li>Message dropped if not sent when timeout expires and retry count not reached</li>
<li>If response expected, message dropped if response not received within the timeout</li>
</ul>
</li>
<li>lnet_lnd_timeout<ul>
<li>Not independently set; derived from lnet_transaction_timeout</li>
<li>lnet_lnd_timeout &#x3D; (lnet_transaction_timeout – 1)&#x2F;(lnet_retry_count+1)<ul>
<li>default 2.15.6<ul>
<li>&#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;accept_timeout &#x3D; 5</li>
<li>&#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;lnet_retry_count &#x3D; 2</li>
<li>&#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;lnet_transaction_timeout &#x3D; 150 </li>
<li>lnet_lnd_timeout &#x3D; (150 -1)&#x2F;(2+1) &#x3D; 49</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>route timeout <ul>
<li>Frequency of pings is controlled by live_router_check_interval and dead_router_check_interval</li>
<li>If a reply is not received before router_ping_timeout expires, the router is considered dead</li>
<li>router_ping_timeout (default &#x3D; 50 s)<ul>
<li>Should be consistent with LND timeout</li>
<li>If LND timeout is increased, may need to also increase router_ping_timeout</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="KENREL-MODULE"><a href="#KENREL-MODULE" class="headerlink" title="KENREL MODULE"></a>KENREL MODULE</h5><ul>
<li>libcfs_panic_on_lbug<ul>
<li>cat &#x2F;sys&#x2F;module&#x2F;libcfs&#x2F;parameters&#x2F;libcfs_panic_on_lbug &#x3D; 1 (enabled)</li>
</ul>
</li>
<li>ptlrpc<ul>
<li>cat &#x2F;sys&#x2F;module&#x2F;ptlrpc&#x2F;parameters&#x2F;at_min &#x3D; 0(default 2.15.6)<ul>
<li>cray &#x3D; 40 </li>
<li>Minimum time server will report for processing RPC, Not the actual time taken to handle an RPC, Can be increased to avoid timeouts for transient issues</li>
<li>lfs manual modify : 50</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ptlrpc&#x2F;parameters&#x2F;at_max &#x3D; 600 (default 2.15.6)<ul>
<li>cray &#x3D; 400<ul>
<li>Upper limit of any service time estimate,If reached, the RPC will time out </li>
<li>Lowering this value could detect problems faster, but setting it too low will just result in spurious timeouts for minor slowdowns</li>
<li>Setting at_max &#x3D; 0 will disable adaptive timeouts</li>
</ul>
</li>
<li>lfs manulal modify &#x3D; 320, updtee to 360<ul>
<li>update to 360s : ptlrpc_server_handle_request()) @@@ Request took longer than estimated (360&#x2F;5s); client may timeout<ul>
<li>:ptlrpc_server_handle_request()) @@@ Dropping timed-out request from 12345-10.53.129.152@tcp: deadline 360&#x2F;1s ago &lt;– at-max</li>
<li>ptlrpc_server_handle_req_in()) @@@ Slow req_in handling 8s</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ptlrpc&#x2F;parameters&#x2F;ldlm_enqueue_min &#x3D; 100 (default 2.15.6)<ul>
<li>cray &#x3D; 260<ul>
<li>Minimum timeout to enqueue a lock request</li>
<li>Lock requests can be more complicated than other RPCs (ex – may need to revoke lock on another client)</li>
<li>Using same minimum as other RPC requests (at_min) doesn’t necessarily make sense</li>
<li>Lock enqueue timeout minimum(sec), the minimum amount of time a server will wait to see traffic on a lock before it assumes a client is misbehaving and acts to revoke the lock by evicting the client</li>
</ul>
</li>
<li>lfs manual modify &#x3D; 240, update to 290</li>
<li>This value should be large enough that clients are able to resend an RPC from scratch without—in the event that the first RPC was lost—being evicted. The time it takes for an RPC to be sent is the sum of the network latency and the time needed for the server to process the request</li>
<li>cray : ldlm_enqueue_min &#x3D; max(2<em>at_min, at_min + quiesce duration) + 2</em>service time &#x3D; max(2<em>40, 40 + 140) + 2</em>40 &#x3D; 180 + 80 &#x3D; 260</li>
<li><a target="_blank" rel="noopener" href="https://cug.org/proceedings/cug2015_proceedings/includes/files/pap101-file2.pdf">lfs quiesce duration &#x3D; 124s</a><ul>
<li>lfs ldlm_enqueue_min &#x3D; max(2<em>at_min, at_min + quiesce duration) + 2</em>service time &#x3D; max(2<em>50, 50 + 140) + 2</em>50 &#x3D; 190 + 100 &#x3D; 290</li>
<li>after modify Lustre: MGS: haven’t heard from client 96ea32b4-e870-40eb-8869-3cd5ca4f6e15 (at 10.53.129.146@tcp) in 340 seconds. I think it’s dead (get_param timeout&#x3D;150)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ko2iblnd<ul>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;concurrent_sends &#x3D; 0 (default 2.15.6)<ul>
<li>cray &#x3D; 63<ul>
<li>Determines send work queue sizing. If this option is omitted, the default is calculated based on the values of peer_credits and map_on_demand</li>
<li>This value must be the same on all external login clients and the Lustre file system servers on the IB network</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;peer_credits &#x3D; 8 (default 2.15.6)<ul>
<li>cray &#x3D; 126, Clients &#x3D; 16<ul>
<li>Number of concurrent sends to a single peer. This value must be the same on all external login clients and the Lustre file system servers on the IB network</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;timeout &#x3D; 0 (default 2.15.6)<ul>
<li>cray &#x3D; 10<ul>
<li>The o2iblnd timeout in seconds</li>
<li>How long to wait on transmissions before considering them failed</li>
<li>If not specified, value will be set to lnet_lnd_timeout discussed earlier</li>
<li>Setting timeout lower can cause problems to be detected sooner, but setting too low could lead to spurious timeouts</li>
<li>Should be based on properties of local fabric (size, congestion, etc.)</li>
<li>Recommendations can vary from 10s to 100s</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;peer_timeout &#x3D; 180 (default 2.15.6)<ul>
<li>cray &#x3D; 40, Clients &#x3D; 0( only peer_credits and peer_timeout diff with server setting)<ul>
<li>Used to determine when a peer is down</li>
<li>Default values comes from generic LNet layer,  but value set for ko2iblnd module will propagate up to LNet layer</li>
<li>In a routed environment, peer_timeout should be enabled only on the routers (set peer_timeout &#x3D; 0 on clients and servers)</li>
<li>In general, peer_timeout should not be less than LND(lnet_lnd_timeout) timeout</li>
<li>For ko2iblnd, peer_timeout should be at least twice the value of the keepalive option</li>
<li>When the Lustre network driver (LND) completes a transmit, receive, or connection setup operation for a peer, it records the current time in a last_alive field associated with the peer. When a client of LNet (for example, ptlrpc ) attempts to send anything to a particular peer, the last_alive value for that peer is inspected and, if necessary, updated by querying the LND. The LND queryserves a dual purpose—in addition to dropping a message, it causes the LND to attempt a new connection to a dead peer. If the last_alive is more than peer_timeout seconds (plus a fudge factor for gnilnd ), then the peer is considered dead and the message is dropped</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;credits<ul>
<li>cray &#x3D; 2048<ul>
<li>Number of concurrent sends allowed by o2iblnd . Shared by all CPU partitions (CPT)</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;ntx &#x3D; 512 (default 2.15.6)<ul>
<li>cray &#x3D; 2048<ul>
<li>Number of message descriptors allocated for each pool</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;keepalive &#x3D; 100 (default 2.15.6)<ul>
<li>cray &#x3D; 30 <ul>
<li>Idle time in seconds before sending a keepalive</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;credits &#x3D; 256 (default 2.15.6)<ul>
<li>cray &#x3D; 2048<ul>
<li>Number of concurrent sends allowed</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;peer_buffer_credits &#x3D; 0<ul>
<li>cray &#x3D; 128<ul>
<li>Number of per-peer router buffer credits</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;peer_credits_hiw &#x3D; 0<ul>
<li>cray &#x3D; 0<ul>
<li>The peer_credits_hiw parameter defines when to eagerly return credits</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;map_on_demand &#x3D; 1<ul>
<li>cray &#x3D; 0<ul>
<li>Controls the use of fast memory registration (FMR). recommends setting this value to 0 for InfiniBand HCAs or a value of 32 for Intel® Omni-Path (OPA) host fabric interfaces (HFI)</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;fmr_pool_size &#x3D; 512<ul>
<li>cray &#x3D; 512<ul>
<li>Size of FMR pool on each CPT ( &gt;&#x3D;ntx&#x2F;4 )</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;fmr_flush_trigger &#x3D; 384<ul>
<li>cray &#x3D; 384 <ul>
<li>Number of dirty FMRs that triggers a pool flush.</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;ko2iblnd&#x2F;parameters&#x2F;fmr_cache &#x3D; 1<ul>
<li>cray &#x3D; 1<ul>
<li>Used to enable FMR caching</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>lnet<ul>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;router_ping_timeout &#x3D; 50<ul>
<li>cray &#x3D; 10<ul>
<li>Number of seconds to wait for the reply to a router health query</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;dead_router_check_interval &#x3D; -2147483648<ul>
<li>cray &#x3D; 35 <ul>
<li>Number of seconds between dead router health checks</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;live_router_check_interval &#x3D; -2147483648<ul>
<li>cray &#x3D; 35 <ul>
<li>Number of seconds between live router health checks</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;large_router_buffers &#x3D; 0<ul>
<li>cray &#x3D; 1024 <ul>
<li>Number of large (greater than one [1] page) messages to buffer in the router</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;small_router_buffers &#x3D; 0<ul>
<li>cray &#x3D; 16384<ul>
<li>Number of small (1 page) messages to buffer in the router</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;avoid_asym_router_failure &#x3D; 1<ul>
<li>cray &#x3D; 1<ul>
<li>Asymmetric router failure (ARF) detection enables Lustre networking (LNet) peers to determine if a route to a remote network is alive</li>
<li>Peers use only known good routes. Attempting to send a message via a bad route generally results in a communication failure and requires a resend. Sending via a bad route also consumes router resources that could be utilized for other communication</li>
</ul>
</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;router_ping_timeout &#x3D; 50 <ul>
<li>cray &#x3D; 10</li>
</ul>
</li>
<li>cat &#x2F;sys&#x2F;module&#x2F;lnet&#x2F;parameters&#x2F;dead_router_check_interval &#x3D; not enable -2147483648<ul>
<li>cray &#x3D; 35</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>For Lustre setups using InfiniBand, the peer_credits setting must be consistent across all InfiniBand (IB) peers on the Lustre network. When routers and&#x2F;or external Lustre clients have mlx5-based Host Channel Adapters (HCAs), map_on_demand must be set to 0.<br>except that map_on_demand must be set to 0, and peer_credits and concurrent_sends should be set to 16 for all IB peers on the Lustre network (CRAY)</p>
<p>If an IB peer must have access to an mlx4-based file system (i.e. Sonexion 900, Sonexion 1600, and Sonexion 2000) and an mlx5-based file system (i.e. Sonexion 3000), the ko2iblnd parameters of all mlx4 peers must match the ko2iblnd mlx5-peer parameters to ensure shared mlx4- and mlx5-peer function. For example, in a system where an external Login node needs access to a Sonexion 2000 and Sonexion 3000, all mlx4- and mlx5-peer ko2iblnd parameters should match the LNet parameters recommended for a Sonexion 3000.</p>
<p>For systems that have a Sonexion 3000&#x2F;ClusterStor L300 running at running software version 2.1-SU003 or greater, peer_credits can be increased to 84 and concurrent_sends can be increased to 42. All IB peers within the Lustre network must be able to support these same values if they are to be used.</p>
<h4 id="CLIENT"><a href="#CLIENT" class="headerlink" title="CLIENT"></a>CLIENT</h4><h5 id="check-status"><a href="#check-status" class="headerlink" title="check status"></a>check status</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lfs osts</span><br><span class="line">$ lfs check osts</span><br><span class="line">$ lfs check servers</span><br></pre></td></tr></table></figure>

<h5 id="Lustre-stripe"><a href="#Lustre-stripe" class="headerlink" title="Lustre stripe"></a>Lustre stripe</h5><ul>
<li>stripe_size&#x3D;0<ul>
<li>Uses the file system default for stripe size</li>
</ul>
</li>
<li>stripe_start&#x3D;-1<ul>
<li>Uses the default behavior for setting OST values</li>
</ul>
</li>
<li>stripe_count&#x3D;0<ul>
<li>Uses the file system default for stripe count</li>
</ul>
</li>
<li>stripe_count&#x3D;-1<ul>
<li>Uses all OSTs</li>
</ul>
</li>
</ul>
<h5 id="NFS-export"><a href="#NFS-export" class="headerlink" title="NFS export"></a>NFS export</h5><ul>
<li>rsize&#x3D;1048576,wsize&#x3D;1048576,soft,intr,async,proto&#x3D;tcp,relatime,timeo&#x3D;600,local_lock&#x3D;none,nfsvers&#x3D;3<ul>
<li>rsize&#x3D;1048576,wsize&#x3D;1048576<ul>
<li>Set the read and write buffer sizes from the server at 1MiB</li>
</ul>
</li>
<li>soft,intr<ul>
<li>Use a soft interruptible mount request</li>
</ul>
</li>
<li>async<ul>
<li>Use asynchronous NFS I&#x2F;O. Once the NFS server has acknowledged receipt of an operation, let the NFS client move along even though the physical write to disk on the NFS server has not been confirmed. </li>
<li>For sites that need end-to-end write-commit validation, set this option to sync instead</li>
</ul>
</li>
<li>proto&#x3D;tcp<ul>
<li>This option reduces the potential for UDP retransmit occurrences, which improves end-to-end performance</li>
</ul>
</li>
<li>relatime,timeo&#x3D;600,local_lock&#x3D;none<ul>
<li>Lock and time stamp handling, transaction timeout at 10 minutes</li>
</ul>
</li>
<li>nfsvers&#x3D;3<ul>
<li>Use NFSv3 specifically</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="METADATA-Increase-dir-traversal"><a href="#METADATA-Increase-dir-traversal" class="headerlink" title="METADATA Increase dir traversal"></a>METADATA Increase dir traversal</h5><ul>
<li><p>The MDC max_rpcs_in_flight parameter defines the maximum number of metadata RPCs, both modifying and non-modifying RPCs, that can be sent in parallel by a client to a MDT target. This includes every file system metadata operations, such as file or directory stat, creation, unlink. The default setting is 8, minimum setting is 1 and maximum setting is 256.</p>
<ul>
<li>client$ lctl set_param mdc.*.max_rpcs_in_flight&#x3D;16</li>
</ul>
</li>
<li><p>The MDC max_mod_rpcs_in_flight parameter defines the maximum number of file system modifying RPCs that can be sent in parallel by a client to a MDT target. For example, the Lustre client sends modify RPCs when it performs file or directory creation, unlink, access permission modification or ownership modification. The default setting is 7, minimum setting is 1 and maximum setting is 256.</p>
<ul>
<li>client$ lctl set_param mdc.*.max_mod_rpcs_in_flight&#x3D;12</li>
</ul>
</li>
<li><p>The max_mod_rpcs_in_flight value must be strictly &lt; the max_rpcs_in_flight. It must also &lt;&#x3D; MDT max_mod_rpcs(cat &#x2F;sys&#x2F;module&#x2F;mdt&#x2F;parameters&#x2F;max_mod_rpcs_per_client &#x3D; 8)_per_client value</p>
<ul>
<li>client$ lctl get_param mdc.*.max_mod_rpcs_in_flight &#x3D;7 (default)<ul>
<li>MDS echo 12 &gt; &#x2F;sys&#x2F;module&#x2F;mdt&#x2F;parameters&#x2F;max_mod_rpcs_per_client</li>
<li>Client lctl set_param mdc.*.max_mod_rpcs_in_flight&#x3D;12</li>
</ul>
</li>
</ul>
</li>
<li><p>Many system commands, such as ls –l, du, and find, traverse a directory sequentially. To make these commands run efficiently, the directory statahead can be enabled to improve the performance of directory traversal  </p>
<ul>
<li>statahead_max - Controls the maximum number of file attributes that will be prefetched by the statahead thread. By default, statahead is enabled and statahead_max is 32 files</li>
<li>lctl set_param llite.*.statahead_max&#x3D;N (N&lt;&#x3D;512)<ul>
<li>Bad statahead_max value 1024. Valid values are in the range [0, 512]</li>
</ul>
</li>
</ul>
</li>
<li><p>The directory statahead thread will also prefetch the file size&#x2F;block attributes from the OSTs, so that all file attributes are available on the client when requested by an application. This is controlled by the asynchronous glimpse lock (AGL) setting. The AGL behaviour can be disabled by setting</p>
<ul>
<li>lctl set_param llite.*.statahead_agl&#x3D;0</li>
</ul>
</li>
<li><p>statahead_stats - A read-only interface that provides current statahead and AGL statistics, such as how many times statahead&#x2F;AGL has been triggered since the last mount, how many statahead&#x2F;AGL failures have occurred due to an incorrect prediction or other causes</p>
<ul>
<li>lctl get_param llite.*.statahead_stats</li>
</ul>
</li>
</ul>
<h6 id="Client-monitor-CLIENT-MONITOR"><a href="#Client-monitor-CLIENT-MONITOR" class="headerlink" title="Client monitor CLIENT MONITOR"></a>Client monitor CLIENT MONITOR</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#meta test, normal loading , mv and rm -rf</span></span><br><span class="line"></span><br><span class="line">$ lctl get_param mdc.*.rpc_stats</span><br><span class="line">mdc.testfs-MDT0000-mdc-ffff88ec8f22a800.rpc_stats=</span><br><span class="line">snapshot_time:            1739411235.910854325 secs.nsecs</span><br><span class="line">start_time:               1739352439.695492376 secs.nsecs</span><br><span class="line">elapsed_time:             58796.215361949 secs.nsecs</span><br><span class="line">modify_RPCs_in_flight:  0</span><br><span class="line"></span><br><span class="line">			modify</span><br><span class="line">rpcs <span class="keyword">in</span> flight        rpcs   % cum %</span><br><span class="line">0:		         0   0   0</span><br><span class="line">1:		  67746159  42  42</span><br><span class="line">2:		  53662866  33  75</span><br><span class="line">3:		  25399893  15  91</span><br><span class="line">4:		   9527185   5  97</span><br><span class="line">5:		   3073597   1  99</span><br><span class="line">6:		   1093518   0  99</span><br><span class="line">7:		    345575   0  99</span><br><span class="line">8:		     27351   0 100</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> RPCs <span class="keyword">in</span> flight:  0</span><br><span class="line">write RPCs <span class="keyword">in</span> flight: 0</span><br><span class="line">pending write pages:  0</span><br><span class="line">pending <span class="built_in">read</span> pages:   0</span><br><span class="line"></span><br><span class="line">			<span class="built_in">read</span>			write</span><br><span class="line">pages per rpc         rpcs   % cum % |       rpcs   % cum %</span><br><span class="line">1:		         0   0   0   |          0   0   0</span><br><span class="line"></span><br><span class="line">			<span class="built_in">read</span>			write</span><br><span class="line">rpcs <span class="keyword">in</span> flight        rpcs   % cum % |       rpcs   % cum %</span><br><span class="line">1:		         0   0   0   |          0   0   0</span><br><span class="line"></span><br><span class="line">			<span class="built_in">read</span>			write</span><br><span class="line">offset                rpcs   % cum % |       rpcs   % cum %</span><br><span class="line">0:		         0   0   0   |          0   0   0</span><br><span class="line"></span><br><span class="line"><span class="comment">#modify_RPCs_in_flight - Number of modify RPCs issued by the MDC, but not completed at the time of the snapshot. This value should always be less than or equal to max_mod_rpcs_in_flight.</span></span><br><span class="line"><span class="comment">#rpcs in flight - Number of modify RPCs that are pending when a RPC is sent, the relative percentage (%) of total modify RPCs, and the cumulative percentage (cum %) to that point.</span></span><br><span class="line"><span class="comment">#If a large proportion of modify metadata RPCs are issued with a number of pending metadata RPCs close to the max_mod_rpcs_in_flight value, it means the max_mod_rpcs_in_flight value could be increased to improve the modify metadata performance</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#lustrefs_exporter</span></span><br><span class="line">$ <span class="built_in">cat</span> test.sh</span><br><span class="line"><span class="keyword">while</span> :</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    pid=$(ps aux |grep <span class="string">&#x27;lctl get_param&#x27;</span> | grep -v grep | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">    [[ ! -z <span class="variable">$pid</span> ]] &amp;&amp; pstree -aps <span class="variable">$pid</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ sh test.sh</span><br><span class="line">systemd,1 --switched-root --system --deserialize 17</span><br><span class="line">  └─lustrefs_export,407047 -p 9169</span><br><span class="line">      └─lctl,2492183 get_param memused memused_max lnet_memused health_check mdt/*/exports/*/uuid osd-*/*/filesfree osd-*/*/filestotal osd-*/*/fstype osd-*/*/kbytesavail osd-*/*/kbytesfree ...</span><br><span class="line"></span><br><span class="line">root     2484794  0.0  0.0  33832  4820 ?        R    16:37   0:00 lctl get_param memused memused_max lnet_memused health_check mdt/*/exports/*/uuid osd-*/*/filesfree osd-*/*/filestotal osd-*/*/fstype osd-*/*/kbytesavail osd-*/*/kbytesfree osd-*/*/kbytestotal osd-*/*/brw_stats osd-*/*/quota_slave/acct_group osd-*/*/quota_slave/acct_user osd-*/*/quota_slave/acct_project mgs/*/mgs/stats mgs/*/mgs/threads_max mgs/*/mgs/threads_min mgs/*/mgs/threads_started mgs/*/num_exports obdfilter/*OST*/job_stats obdfilter/*OST*/stats obdfilter/*OST*/num_exports obdfilter/*OST*/tot_dirty obdfilter/*OST*/tot_granted obdfilter/*OST*/tot_pending obdfilter/*OST*/exports/*/stats ost.OSS.ost.stats ost.OSS.ost_io.stats ost.OSS.ost_create.stats ost.OSS.ost_out.stats ost.OSS.ost_seq.stats mds.MDS.mdt.stats mds.MDS.mdt_fld.stats mds.MDS.mdt_io.stats mds.MDS.mdt_out.stats mds.MDS.mdt_readpage.stats mds.MDS.mdt_seqm.stats mds.MDS.mdt_seqs.stats mds.MDS.mdt_setattr.stats mdt.*.job_stats mdt.*.md_stats mdt.*MDT*.num_exports mdt.*MDT*.exports.*.stats ldlm.namespaces.&#123;mdt-,filter-&#125;*.contended_locks ldlm.namespaces.&#123;mdt-,filter-&#125;*.contention_seconds ldlm.namespaces.&#123;mdt-,filter-&#125;*.ctime_age_limit ldlm.namespaces.&#123;mdt-,filter-&#125;*.early_lock_cancel ldlm.namespaces.&#123;mdt-,filter-&#125;*.lock_count ldlm.namespaces.&#123;mdt-,filter-&#125;*.lock_timeouts ldlm.namespaces.&#123;mdt-,filter-&#125;*.lock_unused_count ldlm.namespaces.&#123;mdt-,filter-&#125;*.lru_max_age ldlm.namespaces.&#123;mdt-,filter-&#125;*.lru_size ldlm.namespaces.&#123;mdt-,filter-&#125;*.max_nolock_bytes ldlm.namespaces.&#123;mdt-,filter-&#125;*.max_parallel_ast ldlm.namespaces.&#123;mdt-,filter-&#125;*.resource_count ldlm.services.ldlm_canceld.stats ldlm.services.ldlm_cbd.stats llite.*.stats mdd.*.changelog_users qmt.*.*.glb-usr qmt.*.*.glb-prj qmt.*.*.glb-grp</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="MEMORY"><a href="#MEMORY" class="headerlink" title="MEMORY"></a>MEMORY</h6><ul>
<li>obdclass<ul>
<li>[Sun Dec 29 11:35:54 2024] obd_memory max: 10329033436, obd_memory current: 2712230680<ul>
<li><a target="_blank" rel="noopener" href="https://jira.whamcloud.com/browse/LU-13594">https://jira.whamcloud.com/browse/LU-13594</a></li>
</ul>
</li>
<li>lu_cache_nr &#x3D; 13157680</li>
<li>lu_cache_percent &#x3D; 20</li>
<li>lprocfs_no_percpu_stats &#x3D; 0</li>
</ul>
</li>
</ul>
<h4 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#options lnet accept_backlog=512 accept_timeout=15 lnet_retry_count=6 lnet_transaction_timeout=120 networks=tcp(bond0) </span></span><br><span class="line">options lnet accept_backlog=1024 networks=tcp(bond0) </span><br><span class="line">options ptlrpc at_max=360 at_min=50 ldlm_enqueue_min=290</span><br><span class="line">options mdt max_mod_rpcs_per_client=32</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lctl get_param mds.MDS.*.nrs_policies</span><br><span class="line">00000020:00100000:14.0:1739433167.119049:0:144309:0:(genops.c:2339:obd_get_mod_rpc_slot()) testfs-MDT0000-mdc-ff4a004481ec8800: modify RPC slot 7 is allocated opc 101, max 8</span><br></pre></td></tr></table></figure>
<h5 id="mkfs-ldiskfs-options"><a href="#mkfs-ldiskfs-options" class="headerlink" title="mkfs ldiskfs options"></a>mkfs ldiskfs options</h5><ul>
<li>auto_fo: yes<ul>
<li>Set this parameter to yes to enable automatic failover when failover is configured. Set to no to select manual failover. The default setting is yes . Automatic failover on direct-attached file systems is only supported for combined MGS&#x2F;MDT configurations.</li>
</ul>
</li>
<li>stripe_size: 1048576<ul>
<li>Stripe size in bytes. This is automatically added to the relevant mkfs.lustre format parameters. Cray recommends a default value of 1048576 (1MB).</li>
</ul>
</li>
<li>stripe_count: 1<ul>
<li>Integer count of the default number of OSTs used for a file. This is automatically added to the relevant mkfs.lustre format parameters. Valid range is 1 to the number of OSTs. A value of -1 specifies striping across all OSTs. Cray recommends a stripe count of 2 to 4 OSTs.</li>
</ul>
</li>
<li>journal_size: 400<ul>
<li>Journal size, in megabytes, on underlying ldiskfs file systems. This is automatically added to the relevant mkfs.lustre format parameters. The default value is 400 . In addition to the general journal_size keyword, users can define specific journal values for mdt_journal_size and&#x2F;or ost_journal_size . If a target specific journal size is not defined then the value of journal_size is used.</li>
</ul>
</li>
<li>journal_block_size: 4096<ul>
<li>Journal block size, in bytes, for the journal device. This is automatically added to the relevant mkfs.lustre format parameters. The default value is 4096 (4KB).</li>
</ul>
</li>
<li>back_fs_type: ldiskfs<ul>
<li>Lustre backing file system type. This is automatically added to the relevant mkfs.lustre format parameters. The default is ldiskfs</li>
</ul>
</li>
<li>mgt|mdt|ost_format_params<ul>
<li>These “catchall” options, such as –device-size or –param are passed to mkfs.lustre. Multiple lines are additive. For more information on available options, see the mkfs.lustre man page.</li>
</ul>
</li>
<li>mgt|mdt|ost_mkfs_mount_options:<ul>
<li>These options are passed to mkfs.lustre via –mkfsoptions&#x3D;”options” . Mount options specified here replace the default mount options. Multiple lines are additive. The defaults for ldskfs are:</li>
<li>OST: errors&#x3D;remout-ro</li>
<li>MGT&#x2F;MDT: error&#x3D;remout-ro,iopen_nopriv,user_xattr</li>
</ul>
</li>
<li>mgt|mdt|ost_mount_options<br>Optional arguments used when starting a target. Default is no options. For more information on mount options for Lustre file systems, see the mount.lustre man page. If OSTs are larger than 8TB in size, the force_over_8tb option may need to be added to this parameter for Lustre to start properly. For Lustre 2.x, if OSTs are larger than 128TB in size, add the force_over_128tb option.</li>
<li>quota: no<ul>
<li>Deprecated for Lustre 2.4.0 or greater. To enable quota support, set quota : yes (the default value is no ). For more information on quotas in Lustre file systems, see the lfs(8) man page.</li>
</ul>
</li>
<li>quota_type: ugp (new version add project quota)<ul>
<li>Deprecated for Lustre 2.4.0 or greater. If quotas are enabled, set quota_type to u for user quotas, g for group quotas, or ug for both user and group quotas.</li>
</ul>
</li>
</ul>
<h4 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h4><h5 id="OSS-parameters"><a href="#OSS-parameters" class="headerlink" title="OSS parameters"></a>OSS parameters</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ lctl get_param obdfilter.*.precreate_batch</span><br><span class="line"></span><br><span class="line">#The OSS asynchronous journal commit feature asynchronously writes data to disk without forcing a journal flush. This reduces the number of seeks and significantly improves performance on some hardware</span><br><span class="line">$ lctl get_param obdfilter.*.sync_journal (default)</span><br><span class="line">obdfilter.testfs-OST0000.sync_journal=0</span><br><span class="line"></span><br><span class="line">#An associated sync-on-lock-cancel feature (enabled by default) addresses a data consistency issue that can result if an OSS crashes after multiple clients have written data into intersecting regions of an object, and then one of the clients also crashes. A condition is created in which the POSIX requirement for continuous writes is violated along with a potential for corrupted data. With sync-on-lock-cancel enabled, if a cancelled lock has any volatile writes attached to it, the OSS synchronously writes the journal to disk on lock cancellation. Disabling the sync-on-lock-cancel feature may enhance performance for concurrent write workloads, but it is recommended that you not disable this feature</span><br><span class="line"></span><br><span class="line">always - Always force a journal flush on lock cancellation (default when async_journal is enabled)</span><br><span class="line">blocking - Force a journal flush only when the local cancellation is due to a blocking callback</span><br><span class="line">never - Do not force any journal flush (default when async_journal is disabled)</span><br><span class="line"></span><br><span class="line">$ lctl get_param obdfilter.*.sync_on_lock_cancel</span><br><span class="line">obdfilter.testfs-OST0000.sync_on_lock_cancel=never</span><br></pre></td></tr></table></figure>

<h5 id="OSS-index"><a href="#OSS-index" class="headerlink" title="OSS index"></a><a href="(https://www.scc.kit.edu/scc/docs/Lustre/kit_lad15_20150922.pdf">OSS index</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> OST$(<span class="built_in">printf</span> %04X <span class="variable">$i</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get object IDs for file name:</span></span><br><span class="line">[user@client]$ lfs getstripe myfile</span><br><span class="line">lmm_stripe_count: 2</span><br><span class="line"> obdidx objid objid group</span><br><span class="line"> 0 71666856 0x4458ca8 0  &lt;-----------71666856 = 0x4458ca8</span><br><span class="line"> 2 72574780 0x453673c 0</span><br><span class="line"></span><br><span class="line">[user@client]$ lfs getstripe -v myfile</span><br><span class="line"></span><br><span class="line">[user@client]$ lfs getstripe -y myfile</span><br><span class="line"></span><br><span class="line">[user@client]$ <span class="built_in">stat</span> --format=<span class="string">&quot;%u %g&quot;</span> myfile</span><br><span class="line">8972 12345</span><br><span class="line"></span><br><span class="line">[root@OST0]<span class="comment"># statcmd=&quot;stat \</span></span><br><span class="line"> /O/0/d$((<span class="number">71666856</span> % <span class="number">32</span>))/71666856<span class="string">&quot;   &lt;--------------71666856 = 0x4458ca8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@OST0]# debugfs -c -R &quot;</span><span class="variable">$statcmd</span><span class="string">&quot; \</span></span><br><span class="line"><span class="string"> /dev/mapper/ost_pfs2wor2_0</span></span><br><span class="line"><span class="string">User: 8972 Group: 12345 Size: 5</span></span><br><span class="line"><span class="string"> fid: parent=[0x200018a62:0x8a4d:0x0] stripe=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[user@client]$ lfs path2fid myfile</span></span><br><span class="line"><span class="string">[0x200018a62:0x8a4d:0x0]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@client]# lfs fid2path pfs2wor2 [0x200018a62:0x8a4d:0x0]</span></span><br><span class="line"><span class="string">&lt;path_to_myfile&gt;/myfile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ls -i test_file</span></span><br><span class="line"><span class="string">144116513912193025 test_file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ stat -c %i test_file</span></span><br><span class="line"><span class="string">144116513912193025</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ printf &quot;</span>%<span class="comment">#x\n&quot; $(stat -c %i test_file)</span></span><br><span class="line">0x2000134b2010001</span><br><span class="line"></span><br><span class="line">$ lfs fid2path /lustre1 [0x2000134b2:0x010001:0x0]</span><br><span class="line">/lutre/test/test_file</span><br></pre></td></tr></table></figure>

<h3 id="FEATURES"><a href="#FEATURES" class="headerlink" title="FEATURES"></a>FEATURES</h3><h4 id="Progressive-File-Layout-PFL"><a href="#Progressive-File-Layout-PFL" class="headerlink" title="Progressive File Layout (PFL)"></a>Progressive File Layout (PFL)</h4><ul>
<li>The way PFL achieves this is by defining a Lustre layout that changes striping parameters at certain points in the file extents</li>
<li>As a write progresses and the file gets larger, the stripe count, OST selection, and so on change, at fixed file sizes. Early components of a PFL layout therefore should be striped to optimize smaller files, and later components optimized for larger files. A file that never grows beyond the “small” component will never instantiate the objects specified in the “large” component</li>
<li><a target="_blank" rel="noopener" href="https://wiki.lustre.org/images/9/94/LUG2018-Lustre_Data_on_MDT_An_Early_Look-Leers.pdf">reference</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/DDNStorage/lustre_manual_markdown/blob/master/03.11-File%20Level%20Redundancy%20(FLR).md">reference</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">$ lfs setstripe -E1M -c1 -S1M --pool=pool1 -E2M -E-1 -c2 -S2M --pool=pool2 testfile</span><br><span class="line"></span><br><span class="line">#The first component is one stripe, with a stripe size of 1 megabyte and an end of 1 megabyte, on pool pool1. </span><br><span class="line">#The second component ends at 2MiB (-E2m is the entire component description) and has no stripe size or stripe count info set, so it defaults to one stripe and 1 MiB. The third component goes to infinity ( -E-1 ), has two stripes with a stripe size of 2 MiB, and uses pool2</span><br><span class="line"></span><br><span class="line">$ lfs setstripe -E 100M -c 1 -E 10G -c 8 -E 100G -c 16 -E -1 -c 32 /mountname/directory</span><br><span class="line">#The first component (-E 100M -c 1) indicates a stripe count value of 1 for files up to 100MiB in size.</span><br><span class="line">#The second component (-E 10G -c 8) indicates a stripe count of 8 for files up to 10GiB in size.</span><br><span class="line">#The third component (-E 100G -c 16) indicates a stripe count of 16 for files up to 100GiB in size.</span><br><span class="line">#The fourth component (-E -1 -c 32) indicates a stripe count of 32 for files larger than 100GiB.</span><br><span class="line"></span><br><span class="line">$ client $ lfs setstripe -E 1M -L mdt -E 64M -c1 -S 1M -E 8G -c4 -E -1 -c -1 -S 4M DNE.PFL.file1</span><br><span class="line">DoM.PFL.file1</span><br><span class="line">lcm_layout_gen: 6</span><br><span class="line">lcm_mirror_count: 1</span><br><span class="line">lcm_entry_count: 4</span><br><span class="line">lcme_id: 1 </span><br><span class="line">lcme_mirror_id: 0</span><br><span class="line">lcme_flags: init  -------&gt;0-1MB on DoM MDT</span><br><span class="line">lcme_extent.e_start: 0</span><br><span class="line">lcme_extent.e_end: 1048576</span><br><span class="line">lmm_stripe_count: 0</span><br><span class="line">lmm_stripe_size: 1048576</span><br><span class="line">lmm_pattern: mdt</span><br><span class="line">lmm_layout_gen: 0</span><br><span class="line">lmm_stripe_offset: 0</span><br><span class="line">           </span><br><span class="line">lcme_id: 2  </span><br><span class="line">lcme_mirror_id: 0</span><br><span class="line">lcme_flags: init</span><br><span class="line">lcme_extent.e_start: 1048576  -------&gt; 1-64MB on 1 stripe of 1MB stripesz</span><br><span class="line">lcme_extent.e_end: 67108864</span><br><span class="line">lmm_stripe_count: 1</span><br><span class="line">lmm_stripe_size: 1048576</span><br><span class="line">lmm_pattern: raid0</span><br><span class="line">lmm_layout_gen: 0</span><br><span class="line">lmm_stripe_offset: 10</span><br><span class="line">lmm_objects:</span><br><span class="line">- 0: &#123; l_ost_idx: 10, l_fid: [0x1000a0000:0x349339:0x0] &#125;</span><br><span class="line"></span><br><span class="line">lcme_id: 3</span><br><span class="line">lcme_mirror_id: 0</span><br><span class="line">lcme_flags: init</span><br><span class="line">lcme_extent.e_start: 67108864 -------&gt; 64M-8GB on 4 OSTs at default stripesz</span><br><span class="line">lcme_extent.e_end: 8589934592</span><br><span class="line">lmm_stripe_count: 4</span><br><span class="line">lmm_stripe_size: 1048576</span><br><span class="line">lmm_pattern: raid0</span><br><span class="line">lmm_layout_gen: 0</span><br><span class="line">lmm_stripe_offset: 0</span><br><span class="line">lmm_objects:</span><br><span class="line">- 0: &#123; l_ost_idx: 0, l_fid: [0x100000000:0x345c67:0x0] &#125;</span><br><span class="line">- 1: &#123; l_ost_idx: 7, l_fid: [0x100070000:0x34967a:0x0] &#125;</span><br><span class="line">- 2: &#123; l_ost_idx: 3, l_fid: [0x100030000:0x3475ea:0x0] &#125;</span><br><span class="line">- 3: &#123; l_ost_idx: 9, l_fid: [0x100090000:0x34612a:0x0] &#125;</span><br><span class="line"></span><br><span class="line">lcme_id: 4</span><br><span class="line">lcme_mirror_id: 0</span><br><span class="line">lcme_flags: init</span><br><span class="line">lcme_extent.e_start: 8589934592  ------&gt; 8GB-EOF across all OSTs at 4MB stripesz</span><br><span class="line">lcme_extent.e_end: EOF</span><br><span class="line">lmm_stripe_count: 14</span><br><span class="line">lmm_stripe_size: 4194304</span><br><span class="line">lmm_pattern: raid0</span><br><span class="line">lmm_layout_gen: 0</span><br><span class="line">lmm_stripe_offset: 13</span><br><span class="line">lmm_objects:</span><br><span class="line">- 0: &#123; l_ost_idx: 13, l_fid: [0x1000d0000:0x34682a:0x0] &#125;</span><br><span class="line">- 1: &#123; l_ost_idx: 5, l_fid: [0x100050000:0x36420a:0x0] &#125;</span><br><span class="line">- 2: &#123; l_ost_idx: 11, l_fid: [0x1000b0000:0x34874a:0x0] &#125;</span><br><span class="line">- 3: &#123; l_ost_idx: 6, l_fid: [0x100060000:0x34540a:0x0] &#125;</span><br><span class="line">- 4: &#123; l_ost_idx: 12, l_fid: [0x1000c0000:0x34989a:0x0] &#125;</span><br><span class="line">- 5: &#123; l_ost_idx: 1, l_fid: [0x100010000:0x34b78a:0x0] &#125;</span><br><span class="line">- 6: &#123; l_ost_idx: 8, l_fid: [0x100080000:0x34963b:0x0] &#125;</span><br><span class="line">- 7: &#123; l_ost_idx: 4, l_fid: [0x100040000:0x34d339:0x0] &#125;</span><br><span class="line">- 8: &#123; l_ost_idx: 2, l_fid: [0x100020000:0x3471aa:0x0] &#125;</span><br><span class="line">- 9: &#123; l_ost_idx: 10, l_fid: [0x1000a0000:0x34933a:0x0] &#125;</span><br><span class="line">- 10: &#123; l_ost_idx: 0, l_fid: [0x100000000:0x345c68:0x0] &#125;</span><br><span class="line">- 11: &#123; l_ost_idx: 7, l_fid: [0x100070000:0x34967b:0x0] &#125;</span><br><span class="line">- 12: &#123; l_ost_idx: 3, l_fid: [0x100030000:0x3475eb:0x0] &#125;</span><br><span class="line">- 13: &#123; l_ost_idx: 9, l_fid: [0x100090000:0x34612b:0x0] &#125;</span><br><span class="line"></span><br><span class="line">#Note: For redundancy and fault-tolerance, users need to make sure that different mirrors must be on different OSTs, even OSSs and racks. An understanding of cluster topology is necessary to achieve this architecture. In the initial implementation the use of the existing OST pools mechanism will allow separating OSTs by any arbitrary criteria: i.e. fault domain. In practice, users can take advantage of OST pools by grouping OSTs by topological information. Therefore, when creating a mirrored file, users can indicate which OST pools can be used by mirrors.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ lfs mirror create -N -S 4M -c 2 -p flash -N -c -1 -p archive /mnt/testfs/file1</span><br><span class="line">#The first mirror has 4MB stripe size and two stripes across OSTs in the “flash” OST pool. The second mirror has 4MB stripe size inherited from the first mirror, and stripes across all of the available OSTs in the “archive” OST pool.</span><br><span class="line"></span><br><span class="line">#init - indicates mirrored component has been initialized (has allocated OST objects).</span><br><span class="line">#stale - indicates mirrored component does not have up-to-date data. Stale components will not be used for read or write operations, and need to be resynchronized by running lfs mirror resync command before they can be accessed again.</span><br><span class="line">#prefer - indicates mirrored component is preferred for read or write. For example, the mirror is located on SSD-based OSTs or is closer, fewer hops, on the network to the client. This flag can be set by users at mirror creation time.</span><br><span class="line"></span><br><span class="line">#The following command creates a mirrored file with 3 PFL mirrors</span><br><span class="line">$ lfs mirror create -N -E 4M -p flash --flags=prefer -E eof -c 2 \</span><br><span class="line">                    -N -E 16M -S 8M -c 4 -p archive --comp-flags=prefer -E eof -c -1 \</span><br><span class="line">                    -N -E 32M -c 1 -p none -E eof -c -1 /mnt/testfs/file2</span><br><span class="line"></span><br><span class="line">$ lfs setstripe -E256K -L mdt -E8M -c2 -p &quot;flash&quot; -E128M -c4 -p &quot;disk&quot; -E-1 -c-1 -p &quot;disk&quot; /mnt/lustre</span><br><span class="line">#The majority of files in a typical filesystem are less than 1MB, &quot;small&quot; in Lustre terms. We want DoM only for these small files to avoid overloading the MDS with IO requests. Again using our historical data, if 1% of our filesystem is available for DoM, all files 256KiB or less should fit. (If 5% is available, files 1MiB or less can be put on DoM,) The next component is placed on a flash pool, again limited to 8MiB for 10% of our capacity</span><br></pre></td></tr></table></figure>

<h4 id="NODEMAP-nodemap"><a href="#NODEMAP-nodemap" class="headerlink" title="NODEMAP nodemap"></a>NODEMAP nodemap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set no root squash, mapping the root to 99 (nobody)</span></span><br><span class="line">mds216$ lctl set_param mdt.<span class="variable">$fsname</span>-MDT0000.root_squash=99:99</span><br><span class="line">mds216$ lctl set_param mdt.<span class="variable">$fsname</span>-MDT0000.nosquash_nids=<span class="string">&quot;192.168.0.219@tcp&quot;</span></span><br><span class="line"></span><br><span class="line">client219$ lctl get_param llite.<span class="variable">$fsname</span>-*.nosquash_nids</span><br><span class="line">llite.lus11-ffff8f6dadc90000.nosquash_nids=192.168.0.219@tcp</span><br><span class="line"></span><br><span class="line">client219$ <span class="built_in">mkdir</span> /mnt/lustre/test100</span><br><span class="line">client219$ chattr +P /mnt/lustre/test100</span><br><span class="line">client219$ chattr -p 100 /mnt/lustre/test100</span><br><span class="line">client219$ lfs setquota -p 100 -B 20G /lustre</span><br><span class="line"></span><br><span class="line">mds216$ lctl nodemap_activate 1</span><br><span class="line">mds216$ lctl nodemap_add test100</span><br><span class="line">mds216$ lctl nodemap_add_range --name test100 --range <span class="string">&#x27;192.168.0.217@tcp&#x27;</span> <span class="comment">#client217 no in no_root_squash list, mapping to nobody, client219 in the no_root_squash list, and mapping to root</span></span><br><span class="line">mds216$ lctl nodemap_modify --name test100 --property admin --value 1</span><br><span class="line">mds216$ lctl nodemap_modify --name test100 --property trusted --value 1</span><br><span class="line">mds216$ lctl nodemap_modify --name test100 --property squash_projid --value 100</span><br><span class="line">mds216$ lctl nodemap_modify --name test100 --property map_mode --value projid</span><br><span class="line">mds216$ lctl nodemap_set_fileset --name test100 --fileset /test100</span><br><span class="line"></span><br><span class="line"><span class="comment">#https://github.com/stackhpc/lustre-tools/blob/master/nodemap.py</span></span><br><span class="line">mds216$ dnf install -y python2-yaml</span><br><span class="line">mds216$ ./nodemap.py <span class="built_in">export</span> </span><br><span class="line">nodemap:</span><br><span class="line">  active: 1</span><br><span class="line">  default:</span><br><span class="line">    admin_nodemap: 1</span><br><span class="line">    audit_mode: 1</span><br><span class="line">    deny_unknown: 0</span><br><span class="line">    exports:</span><br><span class="line">    - nid: 0@lo</span><br><span class="line">      uuid: lus11-MDT0000-lwp-MDT0000_UUID</span><br><span class="line">    - nid: 192.168.0.218@tcp</span><br><span class="line">      uuid: lus11-MDT0000-lwp-OST0000_UUID</span><br><span class="line">    - nid: 192.168.0.218@tcp</span><br><span class="line">      uuid: lus11-MDT0000-lwp-OST0001_UUID</span><br><span class="line">    - nid: 192.168.0.218@tcp</span><br><span class="line">      uuid: lus11-MDT0000-lwp-OST0002_UUID</span><br><span class="line">    - nid: 192.168.0.219@tcp</span><br><span class="line">      uuid: 1d8e159a-6cb6-49a0-859b-016ac51f786b</span><br><span class="line">    fileset: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    forbid_encryption: 0</span><br><span class="line">    <span class="built_in">id</span>: 0</span><br><span class="line">    map_mode: all</span><br><span class="line">    squash_gid: 99</span><br><span class="line">    squash_projid: 99</span><br><span class="line">    squash_uid: 99</span><br><span class="line">    trusted_nodemap: 1</span><br><span class="line">  test100:</span><br><span class="line">    admin_nodemap: 1</span><br><span class="line">    audit_mode: 1</span><br><span class="line">    deny_unknown: 0</span><br><span class="line">    exports:</span><br><span class="line">    - nid: 192.168.0.217@tcp</span><br><span class="line">      uuid: 28979313-57c2-4c53-afe0-724cae3b508d</span><br><span class="line">    fileset: /test100</span><br><span class="line">    forbid_encryption: 0</span><br><span class="line">    <span class="built_in">id</span>: 1</span><br><span class="line">    idmap: []</span><br><span class="line">    map_mode: projid</span><br><span class="line">    ranges:</span><br><span class="line">    - end_nid: 192.168.0.217@tcp</span><br><span class="line">      <span class="built_in">id</span>: 3</span><br><span class="line">      start_nid: 192.168.0.217@tcp</span><br><span class="line">    sepol: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    squash_gid: 99</span><br><span class="line">    squash_projid: 100</span><br><span class="line">    squash_uid: 99 &lt;-------------- <span class="keyword">in</span> el8 default, nobody is 65534, modify nobody user and group to 99</span><br><span class="line">    trusted_nodemap: 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#if mds has no this user, nodemap policy root mapping will failed, 219 and 217 client root will be mapping to nobody, no_root_squash not woring</span></span><br><span class="line"></span><br><span class="line">client217$ mount.lustre 192.168.0.217@tcp:/lus11 /lustre</span><br><span class="line">client217$ <span class="built_in">df</span> -hT /lustre</span><br><span class="line">Filesystem               Type    Size  Used Avail Use% Mounted on</span><br><span class="line">192.168.0.216@tcp:/lus11 lustre   20G   60K   20G   1% /lustre</span><br><span class="line"></span><br><span class="line">client219$ mount.lustre 192.168.0.217@tcp:/lus11 /lustre</span><br><span class="line">client219$ <span class="built_in">df</span> -hT /lustre</span><br><span class="line">Filesystem               Type    Size  Used Avail Use% Mounted on</span><br><span class="line">192.168.0.216@tcp:/lus11 lustre  577G   11M  577G   1% /lustre</span><br><span class="line"></span><br><span class="line">client217$ <span class="built_in">touch</span> /lustre/testfile_217 </span><br><span class="line">client219$ <span class="built_in">touch</span> /lustre/test100/testfile_219</span><br><span class="line">client217$ <span class="built_in">ls</span> -l /lustre <span class="comment">#same with ls -l /lustre/test100</span></span><br><span class="line">total 1</span><br><span class="line">-rw-r--r-- 1 nobody      nobody 0 Feb 24 17:12 testfile_217</span><br><span class="line">-rw-r--r-- 1 root        root   0 Feb 24 17:12 testfile_219</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ROUTER"><a href="#ROUTER" class="headerlink" title="ROUTER"></a>ROUTER</h4><ul>
<li>Servers are on LAN1, a Mellanox based InfiniBand network – 10.10.0.0&#x2F;24</li>
<li>Clients are LAN2, an Intel OPA network – 10.20.0.0&#x2F;24</li>
<li>Routers on LAN1 and LAN2 at 10.10.0.20, 10.10.0.21 and 10.20.0.29, 10.20.0.30 respectively<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Servers:</span><br><span class="line">options lnet networks=<span class="string">&quot;o2ib1(ib0)&quot;</span> routes=<span class="string">&quot;o2ib2 10.10.0.20@o2ib1&quot;</span></span><br><span class="line"> </span><br><span class="line">Routers:</span><br><span class="line">options lnet networks=<span class="string">&quot;o2ib1(ib0),o2ib2(ib1)&quot;</span> <span class="string">&quot;forwarding=enabled&quot;</span></span><br><span class="line"> </span><br><span class="line">Clients:</span><br><span class="line">options lnet networks=<span class="string">&quot;o2ib2(ib0)&quot;</span> routes=<span class="string">&quot;o2ib1 10.20.0.29@o2ib2&quot;</span> </span><br><span class="line"></span><br><span class="line">// To unload and load LNet module</span><br><span class="line">modprobe -r lnet</span><br><span class="line">modprobe lnet</span><br><span class="line">  </span><br><span class="line">// To unconfigure and reconfigure LNet</span><br><span class="line">lnetctl lnet unconfigure</span><br><span class="line">lnetctl lnet configure </span><br><span class="line"></span><br><span class="line">Servers:</span><br><span class="line">lnetctl net add --net o2ib1 --<span class="keyword">if</span> ib0</span><br><span class="line">lnetctl route add --net o2ib2 --gateway 10.10.0.20@o2ib1</span><br><span class="line">lnetctl peer add --nid 10.10.0.20@o2ib1</span><br><span class="line"> </span><br><span class="line">Routers:</span><br><span class="line">lnetctl net add --net o2ib1 --<span class="keyword">if</span> ib0</span><br><span class="line">lnetctl net add --net o2ib2 --<span class="keyword">if</span> ib1</span><br><span class="line">lnetctl peer add --nid 10.10.0.1@o2ib1</span><br><span class="line">lnetctl peer add --nid 10.20.0.1@o2ib2</span><br><span class="line">lnetctl <span class="built_in">set</span> routing 1</span><br><span class="line">   </span><br><span class="line">Clients:</span><br><span class="line">lnetctl net add --net o2ib2 --<span class="keyword">if</span> ib0</span><br><span class="line">lnetctl route add --net o2ib1 --gateway 10.20.0.29@o2ib2</span><br><span class="line">lnetctl peer add --nid 10.20.0.29@o2ib2 </span><br><span class="line"></span><br><span class="line">// To <span class="built_in">export</span> the current configuration to a YAML file</span><br><span class="line">lnetctl <span class="built_in">export</span> FILE.yaml</span><br><span class="line">lnetctl <span class="built_in">export</span> &gt; FILE.yaml</span><br><span class="line">  </span><br><span class="line">// To import the configuration from a YAML file</span><br><span class="line">lnetctl import FILE.yaml</span><br><span class="line">lnetctl import &lt; FILE.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment">#If the routers are MR enabled, we can add the routers as peers with multiple interfaces to the clients and the servers, the MR algorithm will ensure that both interfaces of the routers are used while sending traffic to the router</span></span><br><span class="line">Servers:</span><br><span class="line">lnetctl net add --net o2ib1 --<span class="keyword">if</span> ib0,ib1</span><br><span class="line">lnetctl route add --net o2ib2 --gateway 10.10.0.20@o2ib1</span><br><span class="line">lnetctl peer add --nid 10.10.0.20@o2ib1,10.10.0.21@o2ib1</span><br><span class="line"> </span><br><span class="line">Routers:</span><br><span class="line">lnetctl net add --net o2ib1 --<span class="keyword">if</span> ib0,ib1</span><br><span class="line">lnetctl net add --net o2ib2 --<span class="keyword">if</span> ib2,ib3</span><br><span class="line">lnetctl peer add --nid 10.10.0.1@o2ib1,10.10.0.2@o2ib1</span><br><span class="line">lnetctl peer add --nid 10.20.0.1@o2ib2,10.20.0.2@o2ib2</span><br><span class="line">lnetctl <span class="built_in">set</span> routing 1</span><br><span class="line">   </span><br><span class="line">Clients:</span><br><span class="line">lnetctl net add --net o2ib2 --<span class="keyword">if</span> ib0,ib1</span><br><span class="line">lnetctl route add --net o2ib1 --gateway 10.20.0.29@o2ib2</span><br><span class="line">lnetctl peer add --nid 10.20.0.29@o2ib2,10.20.0.30@o2ib2 </span><br><span class="line"></span><br><span class="line">https://wiki.lustre.org/LNet_Router_Config_Guide</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="BUG-ISSUE-CASES"><a href="#BUG-ISSUE-CASES" class="headerlink" title="BUG ISSUE CASES"></a>BUG ISSUE CASES</h3><h4 id="2-15-3"><a href="#2-15-3" class="headerlink" title="2.15.3"></a>2.15.3</h4><ul>
<li><a target="_blank" rel="noopener" href="https://jira.whamcloud.com/browse/LU-17229">can ‘t skip the tgt recovery</a></li>
<li><a target="_blank" rel="noopener" href="https://jira.whamcloud.com/browse/LU-16408">LU-16408</a></li>
<li><a target="_blank" rel="noopener" href="https://jira.whamcloud.com/browse/LU-10851">lustre client data corruption</a><ul>
<li>Lustre: 4066:0:(llite_lib.c:2676:ll_dirty_page_discard_warn()) lustre: dirty page discard: 10.9.4.84@tcp:&#x2F;lustre&#x2F;fid: [0x200000406:0x3e42:0x0]&#x2F; may get corrupted (rc -108)</li>
<li>the same issue in the OST overloading cause lustre client error</li>
</ul>
</li>
</ul>
<h4 id="MDS-wait-OST-because-little-number-of-OST-OST-precreate-slow"><a href="#MDS-wait-OST-because-little-number-of-OST-OST-precreate-slow" class="headerlink" title="MDS wait OST because little number of OST, OST precreate slow"></a>MDS wait OST because little number of OST, OST precreate slow</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">root        2407  0.0  0.0      0     0 ?        D    09:38   0:02 [mdt01_001]</span><br><span class="line">[&lt;0&gt;] ptlrpc_set_wait+0x5c0/0x740 [ptlrpc]</span><br><span class="line">[&lt;0&gt;] ptlrpc_queue_wait+0x81/0x230 [ptlrpc]</span><br><span class="line">[&lt;0&gt;] ldlm_cli_enqueue+0x5eb/0xa70 [ptlrpc]</span><br><span class="line">[&lt;0&gt;] mdc_enqueue_base+0x386/0x1470 [mdc]</span><br><span class="line">[&lt;0&gt;] mdc_intent_lock+0x219/0x560 [mdc]</span><br><span class="line">[&lt;0&gt;] lmv_intent_open+0x29e/0xb80 [lmv]</span><br><span class="line">[&lt;0&gt;] lmv_intent_lock+0x19c/0x390 [lmv]</span><br><span class="line">[&lt;0&gt;] ll_lookup_it+0x6b5/0x19a0 [lustre]</span><br><span class="line">[&lt;0&gt;] ll_atomic_open+0x24a/0x1940 [lustre]</span><br><span class="line">[&lt;0&gt;] path_openat+0x97f/0x1580</span><br><span class="line">[&lt;0&gt;] do_filp_open+0x93/0x100</span><br><span class="line">[&lt;0&gt;] do_sys_openat2+0x211/0x2b0</span><br><span class="line">[&lt;0&gt;] do_sys_open+0x4b/0x80</span><br><span class="line">[&lt;0&gt;] do_syscall_64+0x5b/0x1a0</span><br><span class="line">[&lt;0&gt;] entry_SYSCALL_64_after_hwframe+0x66/0xcb</span><br><span class="line"></span><br><span class="line">$ bpftrace -e <span class="string">&#x27;kretprobe:lod_ost_alloc_qos.constprop.24 &#123; printf(&quot;return: \&quot;%d\&quot;\n&quot;, retval);&#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line"><span class="built_in">return</span>: <span class="string">&quot;-11&quot;</span></span><br><span class="line"><span class="built_in">return</span>: <span class="string">&quot;-11&quot;</span></span><br><span class="line">....</span><br><span class="line"><span class="comment">#define EAGAIN      11  /* Try again */</span></span><br><span class="line"></span><br><span class="line">the same <span class="keyword">in</span> el7, looks like <span class="built_in">wait</span> OST</span><br><span class="line">[&lt;ffffffff81326d77&gt;] call_rwsem_down_write_failed+0x17/0x30</span><br><span class="line">[&lt;ffffffffa1393b07&gt;] lod_alloc_qos.constprop.15+0x187/0x1400 [lod]</span><br><span class="line">[&lt;ffffffffa139675d&gt;] lod_qos_prep_create+0x10cd/0x1fbc [lod]</span><br><span class="line">[&lt;ffffffffa138ff3d&gt;] lod_declare_striped_object+0x1fd/0x810 [lod]</span><br><span class="line">[&lt;ffffffffa13915c1&gt;] lod_declare_object_create+0x231/0x4b0 [lod]</span><br><span class="line">[&lt;ffffffffa12f96af&gt;] mdd_declare_object_create_internal+0xdf/0x2f0 [mdd]</span><br><span class="line">[&lt;ffffffffa12ee038&gt;] mdd_declare_create+0x48/0xef0 [mdd]</span><br><span class="line">[&lt;ffffffffa12ef669&gt;] mdd_create+0x789/0x12a0 [mdd]</span><br><span class="line">[&lt;ffffffffa124f8c2&gt;] mdt_reint_open+0x1f92/0x2e00 [mdt]</span><br><span class="line">[&lt;ffffffffa1242ab0&gt;] mdt_reint_rec+0x80/0x210 [mdt]</span><br><span class="line">[&lt;ffffffffa12236d1&gt;] mdt_reint_internal+0x5e1/0xb20 [mdt]</span><br><span class="line">[&lt;ffffffffa1223d72&gt;] mdt_intent_reint+0x162/0x420 [mdt]</span><br><span class="line">[&lt;ffffffffa122776d&gt;] mdt_intent_opc+0x20d/0xa10 [mdt]</span><br><span class="line">[&lt;ffffffffa122f128&gt;] mdt_intent_policy+0x138/0x320 [mdt]</span><br><span class="line">[&lt;ffffffffa0e2e1f7&gt;] ldlm_lock_enqueue+0x357/0x9c0 [ptlrpc]</span><br><span class="line">[&lt;ffffffffa0e547e2&gt;] ldlm_handle_enqueue0+0x4f2/0x16f0 [ptlrpc]</span><br><span class="line">[&lt;ffffffffa0ee1d32&gt;] tgt_enqueue+0x62/0x210 [ptlrpc]</span><br><span class="line">[&lt;ffffffffa0ee5adb&gt;] tgt_request_handle+0x8fb/0x11f0 [ptlrpc]</span><br><span class="line">[&lt;ffffffffa0e89b7b&gt;] ptlrpc_server_handle_request+0x21b/0xa90 [ptlrpc]</span><br><span class="line">[&lt;ffffffffa0e8d4a0&gt;] ptlrpc_main+0xc00/0x1f60 [ptlrpc]</span><br><span class="line">[&lt;ffffffff810b052f&gt;] kthread+0xcf/0xe0</span><br><span class="line">[&lt;ffffffff81696658&gt;] ret_from_fork+0x58/0x90</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff </span><br><span class="line"></span><br><span class="line"><span class="comment">#OSS lctl dk shows</span></span><br><span class="line">00002000:00080000:20.0:1739502163.197890:0:9189:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0002: reserve 128 objects <span class="keyword">in</span> group 0x0 at 21101090</span><br><span class="line">00002000:00080000:19.0:1739502163.449400:0:9171:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0001: reserve 128 objects <span class="keyword">in</span> group 0x0 at 21304002</span><br><span class="line">00002000:00080000:18.0:1739502163.668701:0:9188:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0005: reserve 128 objects <span class="keyword">in</span> group 0x0 at 20909362</span><br><span class="line">00002000:00080000:18.0:1739502163.742424:0:9181:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0000: reserve 128 objects <span class="keyword">in</span> group 0x0 at 21099762</span><br><span class="line">00002000:00080000:23.0:1739502163.917002:0:9179:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0003: reserve 128 objects <span class="keyword">in</span> group 0x0 at 21093666</span><br><span class="line">00002000:00080000:22.0:1739502164.042360:0:9174:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0004: reserve 128 objects <span class="keyword">in</span> group 0x0 at 21440882</span><br><span class="line">00002000:00080000:18.0:1739502164.063917:0:9189:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0002: reserve 128 objects <span class="keyword">in</span> group 0x0 at 21101218</span><br><span class="line"></span><br><span class="line"><span class="comment">#default 128</span></span><br><span class="line"><span class="comment">#Maximum number of objects that can be included in a single transaction</span></span><br><span class="line"></span><br><span class="line">OSS$ lctl get_param obdfilter.*.precreate_batch</span><br><span class="line">obdfilter.testfs-OST0000.precreate_batch=4096</span><br><span class="line">obdfilter.testfs-OST0001.precreate_batch=4096</span><br><span class="line">obdfilter.testfs-OST0002.precreate_batch=4096</span><br><span class="line">obdfilter.testfs-OST0003.precreate_batch=4096</span><br><span class="line">obdfilter.testfs-OST0004.precreate_batch=4096</span><br><span class="line">obdfilter.testfs-OST0005.precreate_batch=4096</span><br><span class="line">00002000:00080000:20.0:1739502668.607971:0:9192:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0005: reserve 4096 objects <span class="keyword">in</span> group 0x0 at 20969650</span><br><span class="line">00002000:00080000:19.0:1739502668.760714:0:9187:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0003: reserve 4096 objects <span class="keyword">in</span> group 0x0 at 21169570</span><br><span class="line">00002000:00080000:20.0:1739502668.767706:0:9181:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0002: reserve 4096 objects <span class="keyword">in</span> group 0x0 at 21170466</span><br><span class="line">00002000:00080000:20.0:1739502668.854610:0:9171:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0000: reserve 4096 objects <span class="keyword">in</span> group 0x0 at 21172210</span><br><span class="line">00002000:00080000:21.0:1739502669.010717:0:9190:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0004: reserve 4096 objects <span class="keyword">in</span> group 0x0 at 21494258</span><br><span class="line">00002000:00080000:20.0:1739502669.277634:0:9169:0:(ofd_dev.c:1706:ofd_create_hdl()) testfs-OST0001: reserve 4096 objects <span class="keyword">in</span> group 0x0 at 21368514</span><br><span class="line"></span><br><span class="line"><span class="comment">#important</span></span><br><span class="line"><span class="comment">#4096 will hang too, you could set more size, I set it too 65536, 131072 failed, if not overflow, the tiny files create quickly, if full and RPC respond slow,  hang too.</span></span><br><span class="line"><span class="comment">#the number deps OSS setting(which parameter ?) and OSS number, set 2048 is good, if too large, cause many request lost cause too many retry request</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#in the test env, there is no more OST cause this issue shows , make the value larger better for openzfs</span></span><br><span class="line"><span class="comment"># in the metadata test , 2x 4410Y CPU rate reach 80%.......</span></span><br><span class="line">top - 11:46:09 up  1:10,  2 <span class="built_in">users</span>,  load average: 176.81, 149.62, 111.03</span><br><span class="line">Tasks: 4309 total, 113 running, 4196 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.1 us, 82.6 sy,  0.0 ni, 10.8 <span class="built_in">id</span>,  3.5 wa,  2.1 hi,  0.8 si,  0.0 st</span><br><span class="line">MiB Mem : 515539.3 total,  77489.6 free, 437650.9 used,    398.7 buff/cache</span><br><span class="line">MiB Swap:   4096.0 total,   4095.5 free,      0.5 used.  75849.0 avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                                     </span><br><span class="line">   9186 root      20   0       0      0      0 R  43.6   0.0   0:24.55 ll_ost03_088                                                                                                                                </span><br><span class="line">   8130 root       0 -20       0      0      0 R  28.2   0.0   1:43.92 z_wr_int_3                                                                                                                                  </span><br><span class="line">   6221 root       1 -19       0      0      0 D  25.6   0.0   1:30.87 z_wr_iss                                                                                                                                    </span><br><span class="line">   6222 root       1 -19       0      0      0 D  25.6   0.0   1:31.12 z_wr_iss                                                                                                                                    </span><br><span class="line">   6240 root       0 -20       0      0      0 S  25.6   0.0   1:43.10 z_wr_int_0                                                                                                                                  </span><br><span class="line">   6248 root       0 -20       0      0      0 S  25.6   0.0   1:43.02 z_wr_int_2                                                                                                                                  </span><br><span class="line">   6252 root       0 -20       0      0      0 S  25.6   0.0   1:41.92 z_wr_int_3                                                                                                                                  </span><br><span class="line">   6253 root       0 -20       0      0      0 S  25.6   0.0   1:42.87 z_wr_int_3                                                                                                                                  </span><br><span class="line">   8125 root       0 -20       0      0      0 S  25.6   0.0   1:44.90 z_wr_int_2                                                                                                                                  </span><br><span class="line">   6223 root       1 -19       0      0      0 R  23.1   0.0   1:30.48 z_wr_iss                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Cursor respond: </span><br><span class="line">diff represents:</span><br><span class="line">￼</span><br><span class="line">   diff = oid - ofd_seq_last_oid(oseq)</span><br><span class="line">Where:</span><br><span class="line">oid is the requested object ID from the client</span><br><span class="line">ofd_seq_last_oid(oseq) returns the last used object ID on the OST</span><br><span class="line">When diff &gt; 0:</span><br><span class="line"> diff = oid - ofd_seq_last_oid(oseq)</span><br><span class="line"></span><br><span class="line">  It means we need to pre-create objects because the requested ID is higher than what we have</span><br><span class="line">  The code will create new objects to fill this gap</span><br><span class="line">  This is part of Lustre<span class="string">&#x27;s object pre-creation mechanism to improve performance</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The subsequent code:</span></span><br><span class="line"><span class="string">Sets a timeout for the pre-creation operation</span></span><br><span class="line"><span class="string">Initializes variables for tracking the pre-creation process</span></span><br><span class="line"><span class="string">Will create objects in batches until either:</span></span><br><span class="line"><span class="string">  The gap is filled (diff becomes 0)</span></span><br><span class="line"><span class="string">  We hit the timeout</span></span><br><span class="line"><span class="string">  We encounter an error</span></span><br><span class="line"><span class="string">This pre-creation mechanism is important for Lustre&#x27;</span>s performance as it allows the system to prepare objects ahead of time rather than creating them one by one as needed.</span><br></pre></td></tr></table></figure>

<h4 id="HOT-FILE"><a href="#HOT-FILE" class="headerlink" title="HOT FILE"></a>HOT FILE</h4><h5 id="HOT-FILE-CASE1"><a href="#HOT-FILE-CASE1" class="headerlink" title="HOT FILE CASE1"></a>HOT FILE CASE1</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ lctl set_param debug=+rpctrace</span><br><span class="line"></span><br><span class="line">root     30566  0.1  0.0      0     0 ?        D     2022 1115:24 [ll_ost_io01_005]</span><br><span class="line">root     30775  0.1  0.0      0     0 ?        D     2022 1111:28 [ll_ost_io01_006]</span><br><span class="line">root     31300  0.1  0.0      0     0 ?        D     2022 1119:45 [ll_ost_io01_007]</span><br><span class="line">root     33170  0.0  0.0      0     0 ?        D     2022 128:45 [ll_ost00_034]</span><br><span class="line">root     33187  0.0  0.0      0     0 ?        D     2022 138:51 [ll_ost00_050]</span><br><span class="line">root     37776  0.1  0.0      0     0 ?        D     2022 1126:04 [ll_ost_io01_008]</span><br><span class="line">root     37778  0.1  0.0      0     0 ?        D     2022 1122:12 [ll_ost_io01_009]</span><br><span class="line">root     37781  0.1  0.0      0     0 ?        D     2022 1112:57 [ll_ost_io01_010]</span><br><span class="line">root     37784  0.1  0.0      0     0 ?        D     2022 1100:38 [ll_ost_io01_013]</span><br><span class="line">root     37785  0.1  0.0      0     0 ?        D     2022 1114:08 [ll_ost_io01_014]</span><br><span class="line">root     37793  0.1  0.0      0     0 ?        D     2022 1127:13 [ll_ost_io01_016]</span><br><span class="line">root     37795  0.1  0.0      0     0 ?        D     2022 1118:31 [ll_ost_io01_017]</span><br><span class="line">root     38259  0.0  0.0      0     0 ?        D     2022 145:08 [ll_ost01_029]</span><br><span class="line">root     38262  0.0  0.0      0     0 ?        D     2022 142:34 [ll_ost01_032]</span><br><span class="line">root     38289  0.0  0.0      0     0 ?        D     2022 144:00 [ll_ost01_050]</span><br><span class="line">root     38293  0.0  0.0      0     0 ?        D     2022 138:26 [ll_ost01_054]</span><br><span class="line">root     38398  0.1  0.0      0     0 ?        D     2022 1108:31 [ll_ost_io01_022]</span><br><span class="line">root     38399  0.1  0.0      0     0 ?        D     2022 1102:46 [ll_ost_io01_023]</span><br><span class="line">root     38401  0.1  0.0      0     0 ?        D     2022 1121:16 [ll_ost_io01_025]</span><br><span class="line">root     38404  0.1  0.0      0     0 ?        D     2022 1121:55 [ll_ost_io01_027]</span><br><span class="line">root     38407  0.1  0.0      0     0 ?        D     2022 1114:40 [ll_ost_io01_030]</span><br><span class="line">root     38411  0.1  0.0      0     0 ?        D     2022 1140:46 [ll_ost_io01_034]</span><br><span class="line">root     38451  0.1  0.0      0     0 ?        D     2022 1155:12 [ll_ost_io01_036]</span><br><span class="line">root     38456  0.1  0.0      0     0 ?        D     2022 1130:14 [ll_ost_io01_039]</span><br><span class="line">root     38459  0.1  0.0      0     0 ?        D     2022 1107:47 [ll_ost_io01_040]</span><br><span class="line">root     38460  0.1  0.0      0     0 ?        D     2022 1135:06 [ll_ost_io01_041]</span><br><span class="line">root     38466  0.1  0.0      0     0 ?        D     2022 1129:21 [ll_ost_io01_046]</span><br><span class="line">root     38468  0.1  0.0      0     0 ?        D     2022 1119:59 [ll_ost_io01_048]</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/38262/stack</span><br><span class="line">[&lt;ffffffffc1488945&gt;] ptlrpc_wait_event+0x345/0x360 [ptlrpc]</span><br><span class="line">[&lt;ffffffffc148f0c2&gt;] ptlrpc_main+0xa02/0x1470 [ptlrpc]</span><br><span class="line">[&lt;ffffffff87ac5c21&gt;] kthread+0xd1/0xe0</span><br><span class="line">[&lt;ffffffff88193df7&gt;] ret_from_fork_nospec_end+0x0/0x39</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/38451/stack</span><br><span class="line">[&lt;ffffffffc084c085&gt;] wait_transaction_locked+0x85/0xd0 [jbd2]</span><br><span class="line">[&lt;ffffffffc084c378&gt;] add_transaction_credits+0x278/0x310 [jbd2]</span><br><span class="line">[&lt;ffffffffc084c601&gt;] start_this_handle+0x1a1/0x430 [jbd2]</span><br><span class="line">[&lt;ffffffffc084cab3&gt;] jbd2__journal_start+0xf3/0x1f0 [jbd2]</span><br><span class="line">[&lt;ffffffffc0ee8459&gt;] __ldiskfs_journal_start_sb+0x69/0xe0 [ldiskfs]</span><br><span class="line">[&lt;ffffffffc12ede6e&gt;] osd_trans_start+0x20e/0x4e0 [osd_ldiskfs]</span><br><span class="line">[&lt;ffffffffc1726425&gt;] ofd_trans_start+0x75/0xf0 [ofd]</span><br><span class="line">[&lt;ffffffffc172d701&gt;] ofd_commitrw_write+0xa31/0x1db0 [ofd]</span><br><span class="line">[&lt;ffffffffc1731c8c&gt;] ofd_commitrw+0x47c/0xa50 [ofd]</span><br><span class="line">[&lt;ffffffffc14e0c2c&gt;] obd_commitrw+0x9c/0x370 [ptlrpc]</span><br><span class="line">[&lt;ffffffffc14e50d2&gt;] tgt_brw_write+0xf02/0x1ad0 [ptlrpc]</span><br><span class="line">[&lt;ffffffffc14e6f1a&gt;] tgt_request_handle+0xada/0x1570 [ptlrpc]</span><br><span class="line">[&lt;ffffffffc148b88b&gt;] ptlrpc_server_handle_request+0x24b/0xab0 [ptlrpc]</span><br><span class="line">[&lt;ffffffffc148f1f4&gt;] ptlrpc_main+0xb34/0x1470 [ptlrpc]</span><br><span class="line">[&lt;ffffffff87ac5c21&gt;] kthread+0xd1/0xe0</span><br><span class="line">[&lt;ffffffff88193df7&gt;] ret_from_fork_nospec_end+0x0/0x39</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span><br><span class="line"></span><br><span class="line">$ grep lock dk | grep OST0049 -c</span><br><span class="line">609</span><br><span class="line">$ grep lock dk | grep OST0048 -c</span><br><span class="line">714 &lt;------the highest random IOPS, at least this one is the hot file, random write 8 Bytes, the real hot op not <span class="keyword">in</span> max rpc request</span><br><span class="line">$ grep lock dk | grep OST004b -c</span><br><span class="line">4350 &lt;----- hot but not busy , it <span class="string">&#x27;s the seq IO</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">analysis the client by perf trace with OSS blktrace IO model, not debug from lustre log</span></span><br><span class="line"><span class="string">next from lustre log</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    71.837 ( 0.039 ms): Test2/338984 write(fd: 5762, buf: 0x2b8ab3c0a100, count: 8                         ) = 8</span></span><br><span class="line"><span class="string">    71.880 ( 0.004 ms): Test2/338984 lseek(fd: 5762, offset: 107202192440, whence: SET                     ) = 107202192440</span></span><br><span class="line"><span class="string">    71.894 ( 0.007 ms): Test2/338984 write(fd: 5762, buf: 0x2b8ab3c0a100, count: 8                         ) = 8</span></span><br><span class="line"><span class="string">    71.905 ( 0.004 ms): Test2/338984 lseek(fd: 5762, offset: 107202197640, whence: SET                     ) = 107202197640</span></span><br><span class="line"><span class="string">    71.914 ( 0.044 ms): Test2/338984 write(fd: 5762, buf: 0x2b8ab3c0a100, count: 8                         ) = 8</span></span><br><span class="line"><span class="string">    71.963 ( 0.004 ms): Test2/338984 lseek(fd: 5762, offset: 107202198320, whence: SET                     ) = 107202198320</span></span><br><span class="line"><span class="string">    71.975 ( 0.007 ms): Test2/338984 write(fd: 5762, buf: 0x2b8ab3c0a100, count: 8                         ) = 8</span></span><br><span class="line"><span class="string">    71.987 ( 0.004 ms): Test2/338984 lseek(fd: 5762, offset: 107202199560, whence: SET                     ) = 107202199560</span></span><br><span class="line"><span class="string">    71.999 ( 0.035 ms): Test2/338984 write(fd: 5762, buf: 0x2b8ab3c0a100, count: 8                         ) = 8</span></span><br><span class="line"><span class="string">    72.038 ( 0.004 ms): Test2/338984 lseek(fd: 5762, offset: 107202201784, whence: SET                     ) = 107202201784</span></span><br></pre></td></tr></table></figure>

<h4 id="HOT-FILE-CASE2"><a href="#HOT-FILE-CASE2" class="headerlink" title="HOT FILE CASE2"></a>HOT FILE CASE2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">/usr/src/debug/lustre<span class="number">-2.15</span><span class="number">.5</span><span class="number">-1.</span>el8.x86_64/lustre/include/uapi/linux/lustre/lustre_fid.h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* convert an OST objid into an IDIF FID SEQ number */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u64 <span class="title function_">fid_idif_seq</span><span class="params">(__u64 id, __u32 ost_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> FID_SEQ_IDIF | (ost_idx &lt;&lt; <span class="number">16</span>) | ((id &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xffff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* convert a packed IDIF FID into an OST objid */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u64 <span class="title function_">fid_idif_id</span><span class="params">(__u64 seq, __u32 oid, __u32 ver)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> ((__u64)ver &lt;&lt; <span class="number">48</span>) | ((seq &amp; <span class="number">0xffff</span>) &lt;&lt; <span class="number">32</span>) | oid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u32 <span class="title function_">idif_ost_idx</span><span class="params">(__u64 seq)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> (seq &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* extract ost index from IDIF FID */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u32 <span class="title function_">fid_idif_ost_idx</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> lu_fid *fid)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> idif_ost_idx(fid_seq(fid));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** returns fid object sequence */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> __u64 <span class="title function_">fid_seq</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> lu_fid *fid)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> fid-&gt;f_seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/usr/src/debug/lustre-client<span class="number">-2.15</span><span class="number">.5</span><span class="number">-1.</span>el8.x86_64/lustre/include/uapi/linux/lustre/lustre_ostid.h</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">ostid_to_fid</span><span class="params">(<span class="keyword">struct</span> lu_fid *fid, <span class="type">const</span> <span class="keyword">struct</span> ost_id *ostid,</span></span><br><span class="line"><span class="params">                               __u32 ost_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">        __u64 seq = ostid_seq(ostid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ost_idx &gt; <span class="number">0xffff</span>)</span><br><span class="line">                <span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fid_seq_is_mdt0(seq)) &#123;</span><br><span class="line">                __u64 oid = ostid_id(ostid);</span><br><span class="line">…….</span><br><span class="line"></span><br><span class="line">                fid-&gt;f_seq = fid_idif_seq(oid, ost_idx);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/usr/src/debug/lustre<span class="number">-2.15</span><span class="number">.5</span><span class="number">-1.</span>el8.x86_64/lustre/include/uapi/linux/lustre/lustre_idl.h</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">fid_seq</span> &#123;</span></span><br><span class="line">……</span><br><span class="line">        FID_SEQ_IDIF            = <span class="number">0x100000000</span>ULL,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/usr/src/debug/lustre<span class="number">-2.15</span><span class="number">.5</span><span class="number">-1.</span>el8.x86_64/lustre/include/uapi/linux/lustre/lustre_user.h</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * File IDentifier.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * FID is a cluster-wide unique identifier of a file or an object (stripe).</span></span><br><span class="line"><span class="comment"> * FIDs are never reused.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">struct</span> lu_fid &#123;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * FID sequence. Sequence is a unit of migration: all files (objects)</span></span><br><span class="line"><span class="comment">        * with FIDs from a given sequence are stored on the same server.</span></span><br><span class="line"><span class="comment">        * Lustre should support 2^64 objects, so even if each sequence</span></span><br><span class="line"><span class="comment">        * has only a single object we can still enumerate 2^64 objects.</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">        __u64 f_seq;</span><br><span class="line">        <span class="comment">/* FID number within sequence. */</span></span><br><span class="line">        __u32 f_oid;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * FID version, used to distinguish different versions (in the sense</span></span><br><span class="line"><span class="comment">         * of snapshots, etc.) of the same file system object. Not currently</span></span><br><span class="line"><span class="comment">         * used.</span></span><br><span class="line"><span class="comment">         **/</span></span><br><span class="line">        __u32 f_ver;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/usr/src/debug/lustre<span class="number">-2.15</span><span class="number">.5</span><span class="number">-1.</span>el8.x86_64/lustre/include/uapi/linux/lustre/lustre_user.h</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OST object IDentifier.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ost_id</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">                        __u64   oi_id;</span><br><span class="line">                        __u64   oi_seq;</span><br><span class="line">                &#125; oi;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">lu_fid</span> <span class="title">oi_fid</span>;</span></span><br><span class="line">        &#125;;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<p>perf detect</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">$ perf probe -m <span class="string">&quot;/lib/modules/4.18.0-553.5.1.el8_lustre.x86_64/extra/lustre/fs/ofd.ko&quot;</span> --add <span class="string">&quot;ofd_commitrw_write f_fid=fid-&gt;f_seq:u64 f_oid=fid-&gt;f_oid:u32 f_ver=fid-&gt;f_ver:u32&quot;</span></span><br><span class="line">$ perf record -e probe:ofd_commitrw_write -aR <span class="built_in">sleep</span> 5</span><br><span class="line">$ perf script</span><br><span class="line"> ll_ost_io00_115 136653 [000] 2858721.923680: probe:ofd_commitrw_write: (ffffffffc1604df0) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line"> ll_ost_io00_086 136624 [003] 2858721.926640: probe:ofd_commitrw_write: (ffffffffc1604df0) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line"> ll_ost_io00_124 136662 [003] 2858721.926760: probe:ofd_commitrw_write: (ffffffffc1604df0) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line"></span><br><span class="line">$ perf probe -d probe:ofd_commitrw_write</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;a=0x100000000;b=lshift(0x1,16);c=rshift(0x2aae,32); d=0xffff; e=or(a,b);f=and(c,d);g=or(e,f); printf &quot;0x%x %d\n&quot;, g, g&#125;&#x27;</span></span><br><span class="line">0x100010000 4295032832</span><br><span class="line"></span><br><span class="line"><span class="comment">#Get OST index from c code</span></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;a=0x100010000;b=rshift(a,16); c=and(b,0xffff);printf &quot;index: 0x%x %d\n&quot;, c, c&#125;&#x27;</span></span><br><span class="line">index: 0x1 1</span><br><span class="line"></span><br><span class="line">f_oid=10926</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;O/0/d<span class="subst">$((10926%32)</span>)/10926&quot;</span></span><br><span class="line">O/0/d14/10926</span><br><span class="line"></span><br><span class="line">$ lfs getstripe test_2</span><br><span class="line">test_2</span><br><span class="line">lmm_stripe_count:  1</span><br><span class="line">lmm_stripe_size:   1048576</span><br><span class="line">lmm_pattern:       raid0</span><br><span class="line">lmm_layout_gen:    0</span><br><span class="line">lmm_stripe_offset: 1</span><br><span class="line">	obdidx		 objid		 objid		 group</span><br><span class="line">	     1	         10926	       0x2aae	             0</span><br><span class="line"></span><br><span class="line">$ lfs path2fid test_2</span><br><span class="line">[0x200000401:0x1001d:0x0]</span><br><span class="line"></span><br><span class="line">$ zpool <span class="built_in">set</span> multihost=off test_ost1</span><br><span class="line"></span><br><span class="line">$ zdb -vv -bbbb -O test_ost1/test_ost1 O/0/d14/10926</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">     11674    3   128K     1M  9.17G     512  9.17G  100.00  ZFS plain file</span><br><span class="line">                                               192   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED SPILL_BLKPTR</span><br><span class="line">	dnode maxblkid: 9388</span><br><span class="line">	uid     0</span><br><span class="line">	gid     0</span><br><span class="line">	atime	Thu Jan  1 08:00:00 1970</span><br><span class="line">	mtime	Tue Dec  3 15:43:45 2024</span><br><span class="line">	ctime	Tue Dec  3 15:43:45 2024</span><br><span class="line">	crtime	Tue Dec  3 15:12:15 2024</span><br><span class="line">	gen	11104</span><br><span class="line">	mode	100666</span><br><span class="line">	size	9845080064</span><br><span class="line">	parent	582</span><br><span class="line">	links	1</span><br><span class="line">	pflags	800000000000</span><br><span class="line">	rdev	0x0000000000000000</span><br><span class="line">	SA xattrs: 204 bytes, 3 entries</span><br><span class="line"></span><br><span class="line">		trusted.lma = \010\000\000\000\000\000\000\000\000\000\001\000\001\000\000\000\256\052\000\000\000\000\000\000</span><br><span class="line">		trusted.fid = \001\004\000\000\002\000\000\000\035\000\001\000\000\000\000\000\000\000\020\000\001\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000</span><br><span class="line">		trusted.version = \351\335\272\000\001\000\000\000</span><br><span class="line"></span><br><span class="line"><span class="comment">#Trusted.fid found by ll_decode_filter_fid.c</span></span><br><span class="line"></span><br><span class="line">trusted.fid = \001\004\000\000\002\000\000\000</span><br><span class="line">\035\000\001\000</span><br><span class="line">\000\000\000\000</span><br><span class="line"></span><br><span class="line">\000\000\020\000\001\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\001\004\000\000\002\000\000\000\ = 0x0000000200000401  u64</span><br><span class="line">035\000\001\000 = 0x0001001d  u32</span><br><span class="line">\000\000\000\000 =0x00000000  u32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\000\000\020\000\001\000\000\000</span><br><span class="line">  00   00   10   00    1    00    00  00</span><br><span class="line">&lt;---------------------------------对了 100010000 (算的是1~最大值, 最大值就是ff, 而不是01, 不应该多加一个0)</span><br><span class="line"></span><br><span class="line">\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000</span><br><span class="line"></span><br><span class="line">\000\000\020\000\001\000\000\000</span><br><span class="line">0000   1000   0100   0000 = 100001000000</span><br><span class="line">0000   0001   0010   0000 = 100100000</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">&#x27;BEGIN&#123;a=0x100000000;b=lshift(0x1,16);c=rshift(0x2aae,32); d=0xffff; e=or(a,b);f=and(c,d);g=or(e,f); printf &quot;0x%x %d\n&quot;, g, g&#125;&#x27;</span></span><br><span class="line">0x100010000 4295032832</span><br><span class="line">就是100010000</span><br><span class="line"></span><br><span class="line">这个对映trusted.lma</span><br><span class="line"></span><br><span class="line">trusted.lma = \010\000\000\000\000\000\000\000\000\000\001\000\001\000\000\000\256\052\000\000\000\000\000\000</span><br><span class="line"></span><br><span class="line">\010\000\000\000 &lt;&lt;&lt;&lt; <span class="string">lma_compat</span></span><br><span class="line"><span class="string">\000\000\000\000  &lt;&lt;&lt;&lt; lma_incompat</span></span><br><span class="line"><span class="string">\000\000\001\000\001\000\000\000\256\052\000\000\000\000\000\000 &lt;&lt;&lt;struct lu_fid  lma_self_fid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\000\000\001\000\001\000\000\000</span></span><br><span class="line"><span class="string">  00   00    1   00    01  00   00   00</span></span><br><span class="line"><span class="string">&lt;---------------------------------对了 100010000 (算的是1~最大值, 最大值就是ff, 而不是01, 不应该多加一个0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\256\052\000\000 &lt;&lt;&lt; objid</span></span><br><span class="line"><span class="string"> AE  2A    00   00</span></span><br><span class="line"><span class="string">2aae=10926 &lt;&lt;&lt; objid</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\000\000\000\000 &lt;&lt;&lt; version</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/usr/src/debug/lustre-2.15.5-1.el8.x86_64/lustre/utils/ll_decode_filter_fid.c</span></span><br><span class="line"><span class="string">/usr/src/debug/lustre-2.15.5-1.el8.x86_64/lustre/include/uapi/linux/lustre/lustre_user.h</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">可以看到这个数据结构对映下面这个数据结构</span></span><br><span class="line"><span class="string">/**</span></span><br><span class="line"><span class="string"> * Following struct for object attributes, that will be kept inode&#x27;s EA.</span></span><br><span class="line"><span class="string"> * Introduced in 2.0 release (please see b15993, for details)</span></span><br><span class="line"><span class="string"> * Added to all objects since Lustre 2.4 as contains self FID</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">struct lustre_mdt_attrs &#123;</span></span><br><span class="line"><span class="string">        /**</span></span><br><span class="line"><span class="string">         * Bitfield for supported data in this structure. From enum lma_compat</span>.</span><br><span class="line">         * lma_self_fid and lma_flags are always available.</span><br><span class="line">         */</span><br><span class="line">        __u32   lma_compat;</span><br><span class="line">        /**</span><br><span class="line">         * Per-file incompat feature list. Lustre version should support all</span><br><span class="line">         * flags <span class="built_in">set</span> <span class="keyword">in</span> this field. The supported feature mask is available <span class="keyword">in</span></span><br><span class="line">         * LMA_INCOMPAT_SUPP.</span><br><span class="line">         */</span><br><span class="line">        __u32   lma_incompat;</span><br><span class="line">        /** FID of this inode */</span><br><span class="line">        struct lu_fid  lma_self_fid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="HOT-FILE-cache-read-write"><a href="#HOT-FILE-cache-read-write" class="headerlink" title="HOT FILE cache read&#x2F;write"></a>HOT FILE cache read&#x2F;write</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line">ofd_commitrw_read 貌似优化了看下面, 换个角度</span><br><span class="line">http://lists.onebuilding.org/pipermail/lustre-devel-lustre.org/2016-December/005136.html</span><br><span class="line"></span><br><span class="line">&gt; The <span class="built_in">functions</span> I find the most relevant to study are:</span><br><span class="line">&gt; <span class="string">&quot;lustre/ofd/ofd_io.c&quot;</span>:</span><br><span class="line">&gt;     ofd_preprw() -&gt; ofd_preprw_read() / ofd_preprw_write()</span><br><span class="line"> * Prepare buffers <span class="keyword">for</span> <span class="built_in">read</span> request processing.</span><br><span class="line"> *</span><br><span class="line"> * This <span class="keyword">function</span> converts remote buffers from client to <span class="built_in">local</span> buffers</span><br><span class="line"> * and prepares the latter.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; their counterparts:</span><br><span class="line">&gt; <span class="string">&quot;lustre/ofd/ofd_io.c&quot;</span>:</span><br><span class="line">&gt;     ofd_commitrw() -&gt; ofd_commitrw_read() / ofd_commitrw_write()</span><br><span class="line"> * Drop reference on <span class="built_in">local</span> buffers <span class="keyword">for</span> <span class="built_in">read</span> bulk IO.</span><br><span class="line"> *</span><br><span class="line"> * This will free all <span class="built_in">local</span> buffers use by this <span class="built_in">read</span> request.</span><br><span class="line"></span><br><span class="line">&gt;</span><br><span class="line">&gt; the handlers of the proc files </span><br><span class="line">&gt; <span class="string">&quot;/proc/fs/lustre/obdfilter/*/&#123;read,writethrough&#125;_cache_enable&quot;</span>:</span><br><span class="line">&gt; <span class="string">&quot;lustre/osd-ldiskfs/osd_lproc.c&quot;</span>:</span><br><span class="line">&gt;     ldiskfs_osd_cache_seq_write(), ldiskfs_osd_wcache_seq_write()</span><br><span class="line">&gt;</span><br><span class="line">&gt; and the only places that use the variables <span class="built_in">set</span> by the proc files </span><br><span class="line">&gt; (<span class="built_in">where</span> generic_error_remove_page() is used):</span><br><span class="line">&gt; <span class="string">&quot;lustre/osd-ldiskfs/osd_io.c&quot;</span>:</span><br><span class="line">&gt;     osd_read_prep(), osd_write_prep()</span><br><span class="line">&gt;</span><br><span class="line">&gt; (I suspect I am missing something really important about what </span><br><span class="line">&gt; generic_error_remove_page() does)</span><br><span class="line"></span><br><span class="line">只能查看 ofd_commitrw 这个还能看读写, perf top 显示确实使用率会随着客户端增加而增加</span><br><span class="line">perf probe -m <span class="string">&quot;/lib/modules/4.18.0-553.5.1.el8_lustre.x86_64/extra/lustre/fs/ofd.ko&quot;</span> --add <span class="string">&quot;ofd_commitrw f_fid=oa-&gt;o_oi.oi_fid.f_seq:u64 f_oid=oa-&gt;o_oi.oi_fid.f_oid:u32 rwtype=cmd:u32&quot;</span></span><br><span class="line"></span><br><span class="line">现在是<span class="built_in">dd</span> 读取, flag=nocache, flag=direct也是</span><br><span class="line"> ll_ost_io00_029 136567 [000] 2942576.604155: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_119 136657 [003] 2942576.604877: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_116 136654 [000] 2942576.605182: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_121 136659 [001] 2942576.605700: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ll_ost_io00_126 136664 [002] 2943038.299428: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"> ll_ost_io00_090 136628 [002] 2943038.300037: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"> ll_ost_io00_127 136665 [000] 2943038.302504: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"> ll_ost_io00_026 136564 [003] 2943038.303065: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"></span><br><span class="line">混合读写</span><br><span class="line"> ll_ost_io00_124 136662 [003] 2944725.609229: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"> ll_ost_io00_123 136661 [001] 2944725.609864: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_121 136659 [000] 2944725.610209: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_083 136621 [002] 2944725.610606: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_124 136662 [003] 2944725.611154: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_124 136662 [003] 2944725.614402: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"> ll_ost_io00_083 136621 [002] 2944725.617131: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_123 136661 [001] 2944725.617459: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_124 136662 [003] 2944725.617708: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_121 136659 [000] 2944725.617858: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=1</span><br><span class="line"> ll_ost_io00_121 136659 [000] 2944725.621790: probe:ofd_commitrw: (ffffffffc160a830) f_fid=4295032832 f_oid=10926 rwtype=2</span><br><span class="line"></span><br><span class="line">读写类型倒是可以参考此文件</span><br><span class="line">./lustre/include/uapi/linux/lustre/lustre_idl.h:1379:<span class="comment">#define OBD_BRW_WRITE           0x02</span></span><br><span class="line">./lustre/include/uapi/linux/lustre/lustre_idl.h:1378:<span class="comment">#define OBD_BRW_READ            0x01</span></span><br><span class="line"></span><br><span class="line">Direct, nocache , <span class="built_in">sync</span> <span class="built_in">read</span> write没啥区别</span><br><span class="line"></span><br><span class="line">问题是<span class="built_in">sync</span> IO很慢, 我想看到全部的<span class="built_in">sync</span>请求</span><br><span class="line"></span><br><span class="line">Osd_object_sync 会调用 vfs_fsync_range</span><br><span class="line">直接查看vfs_fsync_range</span><br><span class="line"></span><br><span class="line">perf probe --add <span class="string">&quot;inode_wait_for_writeback inode_no=inode-&gt;i_ino:u64&quot;</span></span><br><span class="line"></span><br><span class="line"> perf script </span><br><span class="line">           <span class="built_in">sleep</span> 797967 [000] 2947312.869785: probe:inode_wait_for_writeback: (ffffffff85fa5810) inode_no=3288228  </span><br><span class="line">搞错了, 是某个<span class="built_in">sleep</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">看是否能看到ext4 的inode number, zfs不行, zfs是</span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">     11674    3   128K     1M  97.5G     512  97.5G  100.00  ZFS plain file</span><br><span class="line"></span><br><span class="line">那通过OST_RPC仍旧可以看到 OST <span class="built_in">sync</span> write, ZFS性能杀手</span><br><span class="line">$ perf probe -m <span class="string">&quot;/lib/modules/4.18.0-553.5.1.el8_lustre.x86_64/extra/lustre/fs/ofd.ko&quot;</span> --add <span class="string">&quot;ofd_sync_hdl f_fid=tsi-&gt;tsi_fid.f_seq:u64 f_oid=tsi-&gt;tsi_fid.f_oid:u32 f_ver=tsi-&gt;tsi_fid.f_ver:u32&quot;</span></span><br><span class="line"></span><br><span class="line">    ll_ost00_019 420891 [001] 2949072.963700: probe:ofd_sync_hdl: (ffffffffc15ea400) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line">    ll_ost00_019 420891 [001] 2949072.979283: probe:ofd_sync_hdl: (ffffffffc15ea400) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line">    ll_ost00_019 420891 [001] 2949072.994232: probe:ofd_sync_hdl: (ffffffffc15ea400) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line">    ll_ost00_019 420891 [001] 2949073.009241: probe:ofd_sync_hdl: (ffffffffc15ea400) f_fid=4295032832 f_oid=10926 f_ver=0</span><br><span class="line"></span><br><span class="line">Zfs写入的情况下可以通过获取dnode <span class="built_in">id</span></span><br><span class="line">bpftrace  -e <span class="string">&#x27;kprobe:dnode_hold &#123;printf(&quot;%d\n&quot;, arg1);&#125;&#x27;</span></span><br><span class="line">11674</span><br><span class="line">11674</span><br><span class="line">11674</span><br><span class="line"></span><br><span class="line">我<span class="built_in">chown</span> 99.99 test_2 了, 所以权限也变化了</span><br><span class="line"></span><br><span class="line">zdb -vv -dddd test_ost1/test_ost1 11674 | <span class="built_in">head</span> -n 40</span><br><span class="line">Dataset test_ost1/test_ost1 [ZPL], ID 68, cr_txg 11, 1001M, 360 objects, rootbp DVA[0]=&lt;0:21dec2e000:200&gt; DVA[1]=&lt;0:2240036a00:200&gt; [L0 DMU objset] fletcher4 lz4 unencrypted LE contiguous unique double size=1000L/200P birth=294075L/294075P fill=360 <span class="built_in">cksum</span>=14f6fd741d:72e6f6e24eb:14ee06c92868c:2ac524559b12b4</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">     11674    3   128K     1M   998M     512   998M  100.00  ZFS plain file (K=inherit) (Z=inherit=uncompressed)</span><br><span class="line">                                               192   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED SPILL_BLKPTR</span><br><span class="line">	dnode maxblkid: 997</span><br><span class="line">	path	/O/0/d14/10926</span><br><span class="line">	uid     99</span><br><span class="line">	gid     99</span><br><span class="line">	atime	Wed Dec  4 15:37:16 2024</span><br><span class="line">	mtime	Mon Dec  9 14:24:44 2024</span><br><span class="line">	ctime	Mon Dec  9 14:24:44 2024</span><br><span class="line">	crtime	Tue Dec  3 15:12:15 2024</span><br><span class="line">	gen	11104</span><br><span class="line">	mode	100666</span><br><span class="line">	size	1046478848</span><br><span class="line">	parent	582</span><br><span class="line">	links	1</span><br><span class="line">	pflags	800000000000</span><br><span class="line">	rdev	0x0000000000000000</span><br><span class="line">	SA xattrs: 204 bytes, 3 entries</span><br><span class="line"></span><br><span class="line">		trusted.lma = \010\000\000\000\000\000\000\000\000\000\001\000\001\000\000\000\256\052\000\000\000\000\000\000</span><br><span class="line">		trusted.fid = \001\004\000\000\002\000\000\000\035\000\001\000\000\000\000\000\000\000\020\000\001\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000</span><br><span class="line">		trusted.version = \222\075\001\000\002\000\000\000</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L2   0:228ad34c00:400 0:2369847c00:400 20000L/400P F=998 B=294075/294075 <span class="built_in">cksum</span>=85032b6b05:53acc794b09a:1c1e9bd8453934:6abc8cd582f1f9a</span><br><span class="line">               0  L1  0:21dec2c400:1600 0:2240035200:1600 20000L/1600P F=998 B=294075/294075 <span class="built_in">cksum</span>=17ffd1c4c50:4741966d22328:832af389c462659:421ad6b417315b0e</span><br><span class="line">               0   L0 0:a85500a00:100000 100000L/100000P F=1 B=294074/294074 <span class="built_in">cksum</span>=0:0:0:0</span><br><span class="line">          100000   L0 0:a85700a00:100000 100000L/100000P F=1 B=294074/294074 <span class="built_in">cksum</span>=0:0:0:0</span><br><span class="line">          200000   L0 0:a85600a00:100000 100000L/100000P F=1 B=294074/294074 <span class="built_in">cksum</span>=0:0:0:0</span><br><span class="line">          300000   L0 0:a85800a00:100000 100000L/100000P F=1 B=294074/294074 <span class="built_in">cksum</span>=0:0:0:0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">重新编译安装后, 因为zfs.ko.debug</span><br><span class="line"></span><br><span class="line">$ perf probe -m zfs <span class="string">&quot;dnode_hold dnode_id=object:u64&quot;</span></span><br><span class="line"> ll_ost_io00_005 847091 [001] 98533.908154: probe:dnode_hold: (ffffffffc09f70a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_019 1332438 [001] 98533.909732: probe:dnode_hold: (ffffffffc09f70a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_006 847124 [001] 98533.911015: probe:dnode_hold: (ffffffffc09f70a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_008 847557 [000] 98533.911987: probe:dnode_hold: (ffffffffc09f70a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_018 1332437 [003] 98533.913078: probe:dnode_hold: (ffffffffc09f70a0) dnode_id=8785</span><br><span class="line"></span><br><span class="line">test_3 这个文件, 并且uid gid刚修改为100 100</span><br><span class="line"></span><br><span class="line">zdb -vv -dddd test_ost1/test_ost1 8785 | <span class="built_in">head</span> -n 40</span><br><span class="line">Dataset test_ost1/test_ost1 [ZPL], ID 137, cr_txg 12090, 33.0G, 348 objects, rootbp DVA[0]=&lt;0:1580089a00:200&gt; DVA[1]=&lt;0:1600089a00:200&gt; [L0 DMU objset] fletcher4 lz4 unencrypted LE contiguous unique double size=1000L/200P birth=18797L/18797P fill=348 <span class="built_in">cksum</span>=10a944ba4d:5642efc3e2b:f01255cac483:1da91cdc552ee0</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">      8785    3   128K     1M  33.0G     512  32.9G  100.00  ZFS plain file (K=inherit) (Z=inherit=uncompressed)</span><br><span class="line">                                               192   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED SPILL_BLKPTR</span><br><span class="line">	dnode maxblkid: 33739</span><br><span class="line">	path	/O/0/d13/8013</span><br><span class="line">	uid     100</span><br><span class="line">	gid     100</span><br><span class="line">	atime	Thu Jan  1 08:00:00 1970</span><br><span class="line">	mtime	Wed Dec 11 19:53:52 2024</span><br><span class="line">	ctime	Wed Dec 11 19:54:11 2024</span><br><span class="line">	crtime	Wed Dec 11 10:29:29 2024</span><br><span class="line">	gen	12163</span><br><span class="line">	mode	100666</span><br><span class="line">	size	35378569216</span><br><span class="line">	parent	796</span><br><span class="line">	links	1</span><br><span class="line">	pflags	800000000000</span><br><span class="line">	rdev	0x0000000000000000</span><br><span class="line">	SA xattrs: 204 bytes, 3 entries</span><br><span class="line"></span><br><span class="line">		trusted.lma = \010\000\000\000\000\000\000\000\000\000\001\000\001\000\000\000\115\037\000\000\000\000\000\000</span><br><span class="line">		trusted.fid = \001\004\000\000\002\000\000\000\344\135\000\000\000\000\000\000\000\000\020\000\001\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000</span><br><span class="line">		trusted.version = \144\302\000\000\001\000\000\000</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L2   0:1580083000:a00 0:1600083000:a00 20000L/a00P F=33740 B=18795/18795 <span class="built_in">cksum</span>=110ea814bc5:113631e604dce:cdf5f28425b76e:7bac305ebf6f53ea</span><br><span class="line">               0  L1  0:188000f400:a400 0:190000e200:a400 20000L/a400P F=1024 B=18769/18769 <span class="built_in">cksum</span>=1197ff76b090:169af54c1a07ce6:3791bffa8ebcff6a:21bc2b6c684557c6</span><br><span class="line">               0   L0 0:1780000e00:100000 100000L/100000P F=1 B=18767/18767 <span class="built_in">cksum</span>=0:0:0:0</span><br><span class="line">          100000   L0 0:1780100e00:100000 100000L/100000P F=1 B=18767/18767 <span class="built_in">cksum</span>=200339341fbd4:32e7091e287df9:d1478a68fbc0b23a:11be7f66829f28d2</span><br><span class="line">          200000   L0 0:1780300e00:100000 100000L/100000P F=1 B=18767/18767 <span class="built_in">cksum</span>=1ffde6f6935dc:204b4361f183f1:a779d9df9be1b006:bcda99d0ecbd5f9b</span><br><span class="line">          300000   L0 0:1780200e00:100000 100000L/100000P F=1 B=18767/18767 <span class="built_in">cksum</span>=2004fc603c260:f8a37f19e7fdc6:9b2275ece95aba8d:baba08c8ed658e08</span><br><span class="line">          400000   L0 0:1780400e00:100000 100000L/100000P F=1 B=18767/18767 <span class="built_in">cksum</span>=1ffaf8b800175:fff236b2ea5bb94e:73f49d36861362d2:6cf570196386d06</span><br><span class="line">          500000   L0 0:1780500e00:100000 100000L/100000P F=1 B=18767/18767 <span class="built_in">cksum</span>=200c9ee7668e7:13695303ce734fe:843f306a0394d2ee:cef5bd2a08c6d538</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ perf probe -m zfs <span class="string">&quot;dmu_buf_hold_array_by_dnode dnode_id=dn-&gt;dn_object:u64&quot;</span></span><br><span class="line">$ perf record -e probe:dmu_buf_hold_array_by_dnode -aR <span class="built_in">sleep</span> 5</span><br><span class="line">$ Perf script</span><br><span class="line"> ll_ost_io00_002 843094 [001] 101440.655149: probe:dmu_buf_hold_array_by_dnode: (ffffffffc09d97a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_009 847558 [000] 101440.660840: probe:dmu_buf_hold_array_by_dnode: (ffffffffc09d97a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_007 847137 [001] 101440.661388: probe:dmu_buf_hold_array_by_dnode: (ffffffffc09d97a0) dnode_id=8785</span><br><span class="line"> ll_ost_io00_001 843093 [000] 101440.663374: probe:dmu_buf_hold_array_by_dnode: (ffffffffc09d97a0) dnode_id=8785</span><br></pre></td></tr></table></figure>



  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-XC-Series-Lustre-Administration-Guide-CLE-7-0-UP04-S-2572"><span class="toc-number">1.</span> <span class="toc-text">Read XC Series Lustre Administration Guide_CLE 7.0.UP04_S-2572</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-word"><span class="toc-number">2.</span> <span class="toc-text">Key word</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#INSTALLAION"><span class="toc-number">3.</span> <span class="toc-text">INSTALLAION</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFS-PARAMETERS"><span class="toc-number">4.</span> <span class="toc-text">LFS PARAMETERS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ALL-NORMAL-OTHERS"><span class="toc-number">4.1.</span> <span class="toc-text">ALL NORMAL OTHERS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DUMP"><span class="toc-number">4.1.1.</span> <span class="toc-text">DUMP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NORMAL-COMMAND"><span class="toc-number">4.1.2.</span> <span class="toc-text">NORMAL COMMAND</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PARTITION"><span class="toc-number">4.1.3.</span> <span class="toc-text">PARTITION</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#lloger"><span class="toc-number">4.1.4.</span> <span class="toc-text">lloger</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TIMEOUT-timeout"><span class="toc-number">4.1.5.</span> <span class="toc-text">TIMEOUT timeout</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#KENREL-MODULE"><span class="toc-number">4.1.6.</span> <span class="toc-text">KENREL MODULE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CLIENT"><span class="toc-number">4.2.</span> <span class="toc-text">CLIENT</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#check-status"><span class="toc-number">4.2.1.</span> <span class="toc-text">check status</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lustre-stripe"><span class="toc-number">4.2.2.</span> <span class="toc-text">Lustre stripe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NFS-export"><span class="toc-number">4.2.3.</span> <span class="toc-text">NFS export</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#METADATA-Increase-dir-traversal"><span class="toc-number">4.2.4.</span> <span class="toc-text">METADATA Increase dir traversal</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Client-monitor-CLIENT-MONITOR"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">Client monitor CLIENT MONITOR</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MEMORY"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">MEMORY</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDS"><span class="toc-number">4.3.</span> <span class="toc-text">MDS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mkfs-ldiskfs-options"><span class="toc-number">4.3.1.</span> <span class="toc-text">mkfs ldiskfs options</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OSS"><span class="toc-number">4.4.</span> <span class="toc-text">OSS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OSS-parameters"><span class="toc-number">4.4.1.</span> <span class="toc-text">OSS parameters</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#OSS-index"><span class="toc-number">4.4.2.</span> <span class="toc-text">OSS index</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FEATURES"><span class="toc-number">5.</span> <span class="toc-text">FEATURES</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Progressive-File-Layout-PFL"><span class="toc-number">5.1.</span> <span class="toc-text">Progressive File Layout (PFL)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NODEMAP-nodemap"><span class="toc-number">5.2.</span> <span class="toc-text">NODEMAP nodemap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROUTER"><span class="toc-number">5.3.</span> <span class="toc-text">ROUTER</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BUG-ISSUE-CASES"><span class="toc-number">6.</span> <span class="toc-text">BUG ISSUE CASES</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-15-3"><span class="toc-number">6.1.</span> <span class="toc-text">2.15.3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MDS-wait-OST-because-little-number-of-OST-OST-precreate-slow"><span class="toc-number">6.2.</span> <span class="toc-text">MDS wait OST because little number of OST, OST precreate slow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HOT-FILE"><span class="toc-number">6.3.</span> <span class="toc-text">HOT FILE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HOT-FILE-CASE1"><span class="toc-number">6.3.1.</span> <span class="toc-text">HOT FILE CASE1</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HOT-FILE-CASE2"><span class="toc-number">6.4.</span> <span class="toc-text">HOT FILE CASE2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HOT-FILE-cache-read-write"><span class="toc-number">6.5.</span> <span class="toc-text">HOT FILE cache read&#x2F;write</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2019/12/29/lfs_cmd-u1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2019/12/29/lfs_cmd-u1/&text=lfs command"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2019/12/29/lfs_cmd-u1/&is_video=false&description=lfs command"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=lfs command&body=Check out this article: http://example.com/2019/12/29/lfs_cmd-u1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2019/12/29/lfs_cmd-u1/&title=lfs command"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2019/12/29/lfs_cmd-u1/&name=lfs command&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2019/12/29/lfs_cmd-u1/&t=lfs command"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>

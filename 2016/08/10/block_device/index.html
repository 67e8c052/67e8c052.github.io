<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="block: hook up writeback throttling1echo 0 &gt; wbt_lat_usec  wbt_lat_usec disable it for increase nvme ssd buffer IO If the device is registered for writeback throttling, then this file shows the tar">
<meta property="og:type" content="article">
<meta property="og:title" content="The block device">
<meta property="og:url" content="http://example.com/2016/08/10/block_device/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="block: hook up writeback throttling1echo 0 &gt; wbt_lat_usec  wbt_lat_usec disable it for increase nvme ssd buffer IO If the device is registered for writeback throttling, then this file shows the tar">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/GUID_Partition_Table_Scheme.png">
<meta property="article:published_time" content="2016-08-09T16:04:26.000Z">
<meta property="article:modified_time" content="2025-04-19T02:51:52.711Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="block">
<meta property="article:tag" content="scsi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/GUID_Partition_Table_Scheme.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>The block device</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2016/09/04/kcptun/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2016/04/01/blktrace/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2016/08/10/block_device/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2016/08/10/block_device/&text=The block device"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2016/08/10/block_device/&is_video=false&description=The block device"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=The block device&body=Check out this article: http://example.com/2016/08/10/block_device/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2016/08/10/block_device/&name=The block device&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2016/08/10/block_device/&t=The block device"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#block-hook-up-writeback-throttling"><span class="toc-number">1.</span> <span class="toc-text">block: hook up writeback throttling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hardware"><span class="toc-number">2.</span> <span class="toc-text">Hardware</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#QLC-performance"><span class="toc-number">2.1.</span> <span class="toc-text">QLC performance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#firmware-cause-performance-distance"><span class="toc-number">3.</span> <span class="toc-text">firmware cause performance distance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#512-byte-Emulation-512e-Disk-Compatibility-Update"><span class="toc-number">3.1.</span> <span class="toc-text">512-byte Emulation (512e) Disk Compatibility Update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#here-is-the-5-years-not-worked-free-volume-not-mapping"><span class="toc-number">3.2.</span> <span class="toc-text">here is the 5 years not worked (free volume, not mapping)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Qlogic-driver-setting"><span class="toc-number">4.</span> <span class="toc-text">Qlogic driver setting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SAN-controller-setting-MD3460"><span class="toc-number">5.</span> <span class="toc-text">SAN controller setting MD3460</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rebuild-feature"><span class="toc-number">6.</span> <span class="toc-text">rebuild feature</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">7.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#block-driver"><span class="toc-number">7.1.</span> <span class="toc-text">block driver</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parted-alignment"><span class="toc-number">8.</span> <span class="toc-text">parted alignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#power-save-ATA"><span class="toc-number">9.</span> <span class="toc-text">power save (ATA)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Advance-reformat-4Kn-SCSI-devs-to-512-Bytes-sector"><span class="toc-number">10.</span> <span class="toc-text">Advance reformat 4Kn SCSI devs to 512 Bytes sector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iostat"><span class="toc-number">11.</span> <span class="toc-text">iostat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-IO-schduler"><span class="toc-number">12.</span> <span class="toc-text">Linux IO schduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#deadline-parameters"><span class="toc-number">12.1.</span> <span class="toc-text">deadline parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scsi-driver-error-handaling-EH"><span class="toc-number">13.</span> <span class="toc-text">scsi_driver error handaling (EH)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#long-data-sector"><span class="toc-number">14.</span> <span class="toc-text">long-data-sector</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#T10-DIF-PI"><span class="toc-number">14.1.</span> <span class="toc-text">T10 DIF&#x2F;PI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#About-DIF-520-Bytes"><span class="toc-number">14.2.</span> <span class="toc-text">About DIF 520 Bytes</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#models-with-PI-bytes-the-page-only-show-512-or-4096-bytes-the-extra-space-overhead-hide-in-HDD"><span class="toc-number"></span> <span class="toc-text">models with PI bytes, the page only show 512 or 4096 bytes, the extra space overhead hide in HDD</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#modlls-w-o-PI-bytes-smartctl-could-get-520-524-4160-4192-4224-from-logic-sector-bytes"><span class="toc-number"></span> <span class="toc-text">modlls w&#x2F;o PI bytes, smartctl could get 520,524,4160,4192,4224 from logic sector bytes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-erasing"><span class="toc-number">1.</span> <span class="toc-text">Security erasing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable-the-blk-mq-and-scsi-mq"><span class="toc-number">2.</span> <span class="toc-text">Enable the blk_mq and scsi_mq</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lsscsi"><span class="toc-number">3.</span> <span class="toc-text">lsscsi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#udevinfo"><span class="toc-number">4.</span> <span class="toc-text">udevinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Encrypt-block-device"><span class="toc-number">5.</span> <span class="toc-text">Encrypt block device</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Input-password"><span class="toc-number">5.1.</span> <span class="toc-text">Input password</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapper-test-device"><span class="toc-number">5.2.</span> <span class="toc-text">mapper test device</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-remove-key"><span class="toc-number">5.3.</span> <span class="toc-text">Add&#x2F;remove key</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Back-restore-header"><span class="toc-number">5.4.</span> <span class="toc-text">Back&#x2F;restore header</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#is-luks-partition"><span class="toc-number">5.5.</span> <span class="toc-text">is luks partition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Clean-luks-partition"><span class="toc-number">5.6.</span> <span class="toc-text">Clean luks partition</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smart-err-health-info"><span class="toc-number">6.</span> <span class="toc-text">smart err health info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Re-assign-bad-block"><span class="toc-number">7.</span> <span class="toc-text">Re-assign bad block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-block-integrity"><span class="toc-number">8.</span> <span class="toc-text">linux block integrity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seagate-HDD-smart-issue"><span class="toc-number">9.</span> <span class="toc-text">Seagate HDD smart issue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Seagate-SATA"><span class="toc-number">9.1.</span> <span class="toc-text">Seagate SATA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plugin-out-the-device"><span class="toc-number">10.</span> <span class="toc-text">plugin out the device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMR-device"><span class="toc-number">11.</span> <span class="toc-text">SMR device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-Explicit-volatile-write-back-cache-control"><span class="toc-number">12.</span> <span class="toc-text">Linux Explicit volatile write back cache control</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Explicit-cache-flushes"><span class="toc-number">12.1.</span> <span class="toc-text">Explicit cache flushes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Forced-Unit-Access"><span class="toc-number">12.2.</span> <span class="toc-text">Forced Unit Access</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mbr-info"><span class="toc-number">13.</span> <span class="toc-text">mbr info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Persisten-memory-to-block"><span class="toc-number">14.</span> <span class="toc-text">Persisten memory to block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-bad-seek-performance-for-the-block-device"><span class="toc-number">15.</span> <span class="toc-text">the bad seek performance for the block device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vendor-tools"><span class="toc-number">16.</span> <span class="toc-text">Vendor tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NVRAM-dev-in-the-megaraid"><span class="toc-number">17.</span> <span class="toc-text">NVRAM dev in the megaraid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WDC-upgrade-firmware"><span class="toc-number">18.</span> <span class="toc-text">WDC upgrade firmware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zone-device"><span class="toc-number">19.</span> <span class="toc-text">zone device</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        The block device
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2016-08-09T16:04:26.000Z" itemprop="datePublished">2016-08-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Storage/">Storage</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/block/" rel="tag">block</a>, <a class="tag-link-link" href="/tags/scsi/" rel="tag">scsi</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="block-hook-up-writeback-throttling"><a href="#block-hook-up-writeback-throttling" class="headerlink" title="block: hook up writeback throttling"></a><a target="_blank" rel="noopener" href="https://git.kernel.dk/cgit/linux-block/commit/?h=wb-buf-throttle">block: hook up writeback throttling</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; wbt_lat_usec</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v5.15/block/queue-sysfs.html#wbt-lat-usec-rw">wbt_lat_usec</a><ul>
<li>disable it for increase nvme ssd buffer IO</li>
<li>If the device is registered for writeback throttling, then this file shows the target minimum read latency. If this latency is exceeded in a given window of time (see wb_window_usec), then the writeback throttling will start scaling back writes. Writing a value of ‘0’ to this file disables the feature. Writing a value of ‘-1’ to this file resets the value to the default setting.</li>
</ul>
</li>
<li>throttle_sample_time<ul>
<li>This is the time window that blk-throttle samples data, in millisecond. blk-throttle makes decision based on the samplings. Lower time means cgroups have more smooth throughput, but higher CPU overhead. This exists only when CONFIG_BLK_DEV_THROTTLING_LOW is enabled.</li>
</ul>
</li>
</ul>
<h3 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h3><h4 id="QLC-performance"><a href="#QLC-performance" class="headerlink" title="QLC performance"></a><a target="_blank" rel="noopener" href="https://www.storagereview.com/review/solidigm-p5430-ssd-review">QLC performance</a></h4><ul>
<li>the P5430 delivers up to 971K IOPS 4K random read performance and 120K IOPS random write. With 128K sequential, Solidigm posts up to 7,000MB&#x2F;s read and 3,000MB&#x2F;s write. The drives’ endurance is listed at .58 DWPD for random writes and 1.83 DWPD for sequential writes.</li>
<li><a target="_blank" rel="noopener" href="https://www.tomshardware.com/features/ssd-benchmarks-hierarchy">consumer SSD</a></li>
</ul>
<h3 id="firmware-cause-performance-distance"><a href="#firmware-cause-performance-distance" class="headerlink" title="firmware cause performance distance"></a>firmware cause performance distance</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util</span><br><span class="line">sdd            132.00    0.00     33.00      0.00     0.00     0.00   0.00   0.00    0.36    0.00   0.05   256.00     0.00   0.52   6.90</span><br><span class="line">sdam             0.00  435.00      0.00     88.80     0.00     4.00   0.00   0.91    0.00   24.01  10.44     0.00   209.05   2.17  94.60</span><br><span class="line">sdal             0.00  412.00      0.00     87.10     0.00     6.00   0.00   1.44    0.00   25.83  10.64     0.00   216.49   2.21  91.20</span><br><span class="line">sdan             0.00  439.00      0.00     89.04     0.00     4.00   0.00   0.90    0.00   25.04  10.99     0.00   207.68   2.05  89.90</span><br><span class="line">sdao             0.00  461.00      0.00     85.89     0.00     8.00   0.00   1.71    0.00   22.73  10.48     0.00   190.78   2.01  92.50 &lt;------LS17</span><br><span class="line">sdap             0.00  429.00      0.00     84.54     0.00     2.00   0.00   0.46    0.00   25.00  10.72     0.00   201.79   2.13  91.20</span><br><span class="line">sdar             0.00  467.00      0.00     87.91     0.00     7.00   0.00   1.48    0.00   22.45  10.48     0.00   192.76   2.01  94.00</span><br><span class="line">sdaq             0.00  391.00      0.00     85.68     0.00     2.00   0.00   0.51    0.00   25.25   9.87     0.00   224.40   2.32  90.80</span><br><span class="line">sdas             0.00  468.00      0.00     90.16     0.00     2.00   0.00   0.43    0.00   23.01  10.77     0.00   197.27   1.91  89.30</span><br><span class="line">sdat             0.00  433.00      0.00     89.56     0.00     3.00   0.00   0.69    0.00   25.91  11.22     0.00   211.80   2.16  93.60</span><br><span class="line">sdau             0.00  408.00      0.00     90.96     0.00     1.00   0.00   0.24    0.00   27.30  11.14     0.00   228.28   2.31  94.30</span><br><span class="line">sdaw             0.00 1898.00      0.00     84.73     0.00    28.00   0.00   1.45    0.00    1.60   3.03     0.00    45.71   0.27  51.60</span><br><span class="line">sdav             0.00 1889.00      0.00     84.68     0.00    47.00   0.00   2.43    0.00    1.61   3.04     0.00    45.90   0.28  52.50</span><br><span class="line">sdax             0.00 1724.00      0.00     84.80     0.00    41.00   0.00   2.32    0.00    1.95   3.37     0.00    50.37   0.31  54.10</span><br><span class="line">sdaz             0.00 1752.00      0.00     84.73     0.00    41.00   0.00   2.29    0.00    1.92   3.37     0.00    49.52   0.32  55.80</span><br><span class="line">sday             0.00 1788.00      0.00     84.44     0.00    26.00   0.00   1.43    0.00    1.91   3.41     0.00    48.36   0.31  55.50 &lt;------AC92</span><br><span class="line">sdbd             0.00 1744.00      0.00     84.38     0.00    35.00   0.00   1.97    0.00    1.90   3.31     0.00    49.54   0.31  54.40</span><br><span class="line">sdbc             0.00 1721.00      0.00     84.51     0.00    37.00   0.00   2.10    0.00    1.94   3.34     0.00    50.28   0.32  55.20</span><br><span class="line">sdba             0.00 1760.00      0.00     84.42     0.00    33.00   0.00   1.84    0.00    1.89   3.32     0.00    49.12   0.31  54.60</span><br><span class="line">sdbe             0.00 1769.00      0.00     84.52     0.00    39.00   0.00   2.16    0.00    1.87   3.31     0.00    48.92   0.31  54.30</span><br><span class="line"></span><br><span class="line">^C</span><br><span class="line">$ lsscsi -gis | grep sdam</span><br><span class="line">[1:0:35:0]   disk    HGST     HUH721010AL5200  LS17  /dev/sdam  35000cca251a841b4  /dev/sg39  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdal</span><br><span class="line">[1:0:34:0]   disk    HGST     HUH721010AL5200  LS17  /dev/sdal  35000cca251a84ccc  /dev/sg38  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdan</span><br><span class="line">[1:0:36:0]   disk    HGST     HUH721010AL5200  LS17  /dev/sdan  35000cca251a84a90  /dev/sg40  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdao</span><br><span class="line">[1:0:37:0]   disk    HGST     HUH721010AL5200  LS17  /dev/sdao  35000cca251a957cc  /dev/sg41  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdav</span><br><span class="line">[1:0:44:0]   disk    HGST     HUH721010AL5200  LS17  /dev/sdav  35000cca251a8b730  /dev/sg48  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdax</span><br><span class="line">[1:0:46:0]   disk    HGST     HUH721010AL5200  A92C  /dev/sdax  35000cca251aca954  /dev/sg50  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdaz</span><br><span class="line">[1:0:48:0]   disk    HGST     HUH721010AL5200  A92C  /dev/sdaz  35000cca251ae4d88  /dev/sg52  10.0TB</span><br><span class="line">$ lsscsi -gis | grep sdbc</span><br><span class="line">[1:0:51:0]   disk    HGST     HUH721010AL5200  A92C  /dev/sdbc  35000cca2518c7e08  /dev/sg55  10.0TB</span><br></pre></td></tr></table></figure>


<h4 id="512-byte-Emulation-512e-Disk-Compatibility-Update"><a href="#512-byte-Emulation-512e-Disk-Compatibility-Update" class="headerlink" title="512-byte Emulation (512e) Disk Compatibility Update"></a><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/win7appqual/512-byte-emulation--512e--disk-compatibility-update">512-byte Emulation (512e) Disk Compatibility Update</a></h4><ul>
<li><p>4-KB native (4Kn) HDDs</p>
<ul>
<li>The 4Kn HDD directly maps 4-KB logical sectors (or blocks) to the 4-KB physical sectors.</li>
</ul>
</li>
<li><p>512-byte emulation (512e) HDDs</p>
<ul>
<li>The 512e HDD transparently translates 512-byte logical block I&#x2F;O requests into 4-KB physical sector operations. Each physical sector contains eight logical blocks.</li>
<li>512e Write operations use the “read-modify-write” method:<ul>
<li>The host would like to write a 512-byte block.</li>
<li>The controller selects a suitable 4KB sector and loads it completely. (read)</li>
<li>The controller modifies 512 bytes in the 4KB sector. (modify)</li>
<li>The controller writes the modified 4KB sector to the hard drive. (write)<ul>
<li>Issue 1: The partition is not aligned to a physical sector boundary</li>
<li>Issue 2: Unbuffered Writes not aligned to Physical Sector Size</li>
<li>Issue 3: File Formats relying on 512-byte Sectors</li>
<li>Issue 4: The reported Physical Sector size can change between sessions</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Compatibility</p>
<ul>
<li>In order to keep performance constant, it is necessary that partitions on 512e hard drives be properly aligned (see also Partition Alignment) so that a 4KB sector contains exactly eight 512-byte blocks. Newer operating systems already correctly align the partitions (Windows &gt; Vista SP1; Linux &gt; 2.6.31 (fdisk &gt; 1.2.3))[1]. With the correct alignment, write operations can be optimally cached by the hard drive controller, which optimizes performance</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://lwn.net/Articles/322777/">Linux and 4K disk sectors</a></p>
<ul>
<li>Synchronization&#x2F;Data Address Mark (Sync&#x2F;DAM)<ul>
<li>The Sync&#x2F;DAM field indicates the beginning of the sector and identifies the sector’s number, location, and status.</li>
</ul>
</li>
<li>User data<ul>
<li>The User data field contains actual stored data.</li>
</ul>
</li>
<li>Error correcting code (ECC)<ul>
<li>The ECC field contains error-correcting code that is used to recover user data that mightbe damaged during the read or write operation.</li>
</ul>
</li>
<li>Gap<ul>
<li>The Gap field is used to separate sectors from each other.</li>
</ul>
</li>
<li>Physical sector<ul>
<li>Physical sector is the minimum amount of data that the HDD can read from or write to the physical media in a single I&#x2F;O operation. For Advanced Format HDDs, the physical sector size is 4 KB.</li>
</ul>
</li>
<li>Logical sector<ul>
<li>Logical sector is the addressable logical block, which is the minimum amount of data that the HDD can address. This amount is also the minimum amount of data that the host system can deliver to or request from the HDD in a single I&#x2F;O operation. Advanced Format HDDs support 512-bytes and 4-KB logical sector sizes.</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------</span><br><span class="line">|P|D|  Data Bytes(512/4096Bytes  | ECC |G|</span><br><span class="line">------------------------------------------</span><br><span class="line">P= Preamble</span><br><span class="line">D= Data <span class="built_in">sync</span> mark</span><br><span class="line">ECC= Error Correcting Code</span><br><span class="line">G= Inter Sector Gap</span><br></pre></td></tr></table></figure>
<p>long-data-sector (512,520,528,4096,4112,4160,4224) will show size in logic sector   </p>
<h4 id="here-is-the-5-years-not-worked-free-volume-not-mapping"><a href="#here-is-the-5-years-not-worked-free-volume-not-mapping" class="headerlink" title="here is the 5 years not worked (free volume, not mapping)"></a>here is the 5 years not worked (free volume, not mapping)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#md3460 check process: 18T read and 3T write, not enable scrub</span></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        8         0         8    1207352      18404.172           0</span><br><span class="line">write:         0        0         0         0       1268       3180.446           0</span><br><span class="line">verify:        0        0         0         0      11321          1.095           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0        4         0         5     374715       8530.771           0</span><br><span class="line">write:         0        0         0         0       1593       1703.294           0</span><br><span class="line">verify:        0        0         0         0      20802          1.095           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br></pre></td></tr></table></figure>


<h3 id="Qlogic-driver-setting"><a href="#Qlogic-driver-setting" class="headerlink" title="Qlogic driver setting"></a>Qlogic driver setting</h3><p>Adpater reset time e.g. Qlogic reset time<br>echo options qla2xxx ql2xextended_error_logging&#x3D;1 qlport_down_retry&#x3D;10 ql2xloginretrycount&#x3D;10 &gt;&gt;  &#x2F;etc&#x2F;modprobe.d&#x2F;qlogic.conf<br>Multipath check_timeout  (reduce to 10 seconds from default 60 seconds)</p>
<p>Set the max_segments for HBA driver</p>
<table>
<thead>
<tr>
<th>HBA</th>
<th align="center">Module Parameter</th>
</tr>
</thead>
<tbody><tr>
<td>LSI</td>
<td align="center">max_sgl_entries</td>
</tr>
<tr>
<td>Emulex</td>
<td align="center">lpfc_sg_seg_cnt</td>
</tr>
<tr>
<td>ib_srp</td>
<td align="center">cmd_sg_entries</td>
</tr>
<tr>
<td>Brocade</td>
<td align="center">bfa_io_max_sge</td>
</tr>
</tbody></table>
<p>Set max_hw_sectors_kb for HBA driver</p>
<table>
<thead>
<tr>
<th>HBA</th>
<th align="center">Module Parameter</th>
</tr>
</thead>
<tbody><tr>
<td>LSI</td>
<td align="center">max_sectors</td>
</tr>
<tr>
<td>ib_srp</td>
<td align="center">max_sect</td>
</tr>
<tr>
<td>Brocade</td>
<td align="center">max_xfer_size</td>
</tr>
</tbody></table>
<p>mpt3sas<br>max_sectors:max sectors, range 64 to 32767  default&#x3D;32767 (ushort)</p>
<h3 id="SAN-controller-setting-MD3460"><a href="#SAN-controller-setting-MD3460" class="headerlink" title="SAN controller setting MD3460"></a>SAN controller setting MD3460</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RAID 6               8+2</span><br><span class="line">segment              128K</span><br><span class="line">cache block size     32K</span><br><span class="line">cache flush          90%</span><br><span class="line">Write cache mirror   enabled</span><br><span class="line">Read cache           disabled</span><br></pre></td></tr></table></figure>

<h3 id="rebuild-feature"><a href="#rebuild-feature" class="headerlink" title="rebuild feature"></a>rebuild feature</h3><p>In May 2012, with 3.5-inch hard drive capacities reaching 4TB, the T10 working group approved including Rebuild Assist in the SCSI SBC-3 specification. In August 2013, the SATA-IO committee adopted TPR-045 (Rebuild Assist) as part of the SATA 3.2 specification.”) so with a Rebuild Assist supported RAID controller: can copy good data from a failing drive to a new drive and only need to rebuild the ‘bad’ portion, supposably resulting in quicker rebuild times</p>
<p>Dell PERC not recommand enable it, because it will cause data loss.</p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><h4 id="block-driver"><a href="#block-driver" class="headerlink" title="block driver"></a>block driver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/block/sdX/device/state</span><br><span class="line">running</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/class/scsi_generic/sg1/device/state</span><br><span class="line">running</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdz/device/queue_depth</span><br><span class="line">254</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sda/queue/nomerges</span><br><span class="line"><span class="comment">#set nomerges to 0 for HDDs or to 1 for SSDs, looks like worked for nvme ssd, lustre mdt IO, nr_request=1024, 2048 not good</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdd/queue/add_random</span><br><span class="line"><span class="comment">#The default value is 1. Set add_random=0 for SSDs because random entropy pool does not optimize SSD performance</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check scsi state</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdX/device/state</span><br><span class="line">running</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 30 &gt; /sys/block/sdX/device/timeout</span><br><span class="line"><span class="comment"># I don &#x27;t think set the value too long</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /etc/udev/rules.d/50-udev.rules</span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, SUBSYSTEM==<span class="string">&quot;scsi&quot;</span> , SYSFS&#123;<span class="built_in">type</span>&#125;==<span class="string">&quot;0|7|14&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 60 &gt; /sys/block/%k/device/timeout&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### another exapmle</span></span><br><span class="line">KERNEL==<span class="string">&quot;sdc5&quot;</span>, OWNER=<span class="string">&quot;student&quot;</span>, GROUP=<span class="string">&quot;student&quot;</span>, MODE=<span class="string">&quot;0600&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*&quot;</span>, SYSFS==<span class="string">&quot;4317210A2880EF89&quot;</span>, SYMLINK+=<span class="string">&quot;fedora%n&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, RUN=<span class="string">&quot;/usr/bin/wall  SCSI DEVICE ADDED&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;remove&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, RUN=<span class="string">&quot;/usr/bin/wall SCSI DEVICE REMOVED&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, SYMLINK=<span class="string">&quot;scsi%n&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;remove&quot;</span>, KERNEL==<span class="string">&quot;sdb[1-9]&quot;</span>, SYMLINK=<span class="string">&quot;scsi%n&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, SYSFS&#123;vendor&#125;==<span class="string">&quot;WDC WD32&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 128 &gt; /sys/block/%k/queue/max_sectors_kb&#x27;&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, SYSFS&#123;vendor&#125;==<span class="string">&quot;WDC WD32&quot;</span>, RUN+=<span class="string">&quot;/usr/bin/wall /sys/block/%k/queue/max_sectors_kb set to 128&quot;</span></span><br><span class="line"></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>,SUBSYSTEM==<span class="string">&quot;block&quot;</span>,ATTR&#123;device/vendor&#125;==<span class="string">&quot;FUSIONIO&quot;</span>,ATTR&#123;queue/scheduler&#125;=<span class="string">&quot;noop&quot;</span>,ATTR&#123;queue/rq_affinity&#125;=<span class="string">&quot;2&quot;</span>,ATTR&#123;queue/add_random&#125;=<span class="string">&quot;0&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>,KERNEL==<span class="string">&quot;dm-­‐*&quot;</span>,PROGRAM=<span class="string">&quot;/bin/bash­‐c &#x27;cat /sys/block/<span class="variable">$name</span>/slaves/*/device/vendor | grep FUSIONIO&#x27;&quot;</span>,ATTR&#123;queue/scheduler&#125;=<span class="string">&quot;noop&quot;</span>,ATTR&#123;queue/rq_affinity&#125;=<span class="string">&quot;2&quot;</span>,ATTR&#123;queue/add_random&#125;=<span class="string">&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#becareful args limit</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>, KERNEL==<span class="string">&quot;sd*&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 1 &gt; /sys/block/<span class="subst">$(ls -l /dev/disk/by-id/scsi-358cccccccccccccc | cut -d/ -f7)</span>/device/delete; \</span></span><br><span class="line"><span class="string">echo 1 &gt; /sys/block/<span class="subst">$(ls -l /dev/disk/by-id/scsi-358dddddddddddd | cut -d/ -f7)</span>/device/delete; \</span></span><br><span class="line"><span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="comment">## reload udevadm</span></span><br><span class="line">udevadm control --reload-rules; udevadm trigger --<span class="built_in">type</span>=devices --action=add</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## disable single SAS port</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNELS==<span class="string">&quot;port-0:1&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 1 &gt; /sys/block/%k/device/delete&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#becasue RHEL not support sub parameters</span></span><br><span class="line">ubuntu $ udevadm info -a -p $(udevadm info -q path -n /dev/sdd)  | grep -i rota</span><br><span class="line">         ATTR&#123;queue/rotational&#125;==<span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rhel by script</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>, SUBSYSTEM==<span class="string">&quot;scsi_disk&quot;</span>, ATTR&#123;max_write_same_blocks&#125;=<span class="string">&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ban single dev</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, ATTRS&#123;wwid&#125;==<span class="string">&quot;naa.5000cca251ad0380&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;echo 1 &gt; /sys/block/%k/device/delete&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, DRIVERS==<span class="string">&quot;mpt3sas&quot;</span>, RUN+=<span class="string">&quot;/bin/bash -c &#x27;[[ <span class="subst">$(cat /sys/block/%k/queue/rotational)</span> -eq 1 ]] &amp;&amp; sdparm -p ca -s WCE=1,RCD=0 /dev/%k &amp;&amp; sdparm -p bc -s EN_BMS=0 /dev/%k &#x27;&quot;</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, DRIVERS==<span class="string">&quot;mpt3sas&quot;</span>, RUN+=<span class="string">&quot;/bin/bash -c &#x27;[[ <span class="subst">$(cat /sys/block/%k/queue/rotational)</span> -eq 0 ]] &amp;&amp; sdparm -p ca -s WCE=0,RCD=0 /dev/%k &amp;&amp; sdparm -p bc -s EN_BMS=0 /dev/%k &#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reset some HDD vendor default value</span></span><br><span class="line">ACTION==<span class="string">&quot;add&quot;</span>, KERNEL==<span class="string">&quot;sd*[!0-9]&quot;</span>, RUN+=<span class="string">&quot;/bin/sh -c &#x27;sdparm -p ca -s WCE=1 /dev/%k &amp;&amp; sdparm -p bc -s EN_BMS=0 /dev/%k&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## for SAS SSD to /etc/udev/rules.d/</span></span><br><span class="line"><span class="comment"># Use noop elevator for high-performance solid-state storage</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>,SUBSYSTEM==<span class="string">&quot;block&quot;</span>,ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;PURE&quot;</span>,ATTR&#123;queue/scheduler&#125;=<span class="string">&quot;noop&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reduce CPU overhead due to entropy collection, This file allows to turn off the disk entropy contribution. Default value of this file is ‘1’(on).</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>, SUBSYSTEM==<span class="string">&quot;block&quot;</span>,ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;PURE&quot;</span>,ATTR&#123;queue/add_random&#125;=<span class="string">&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Schedule I/O on the core that initiated the process</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>,SUBSYSTEM==<span class="string">&quot;block&quot;</span>,ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;PURE&quot;</span>,ATTR&#123;queue/rq_affinity&#125;=<span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># block readahead ,/sys/block/*/queue/read_ahead_kb</span></span><br><span class="line">ACTION==<span class="string">&quot;add|change&quot;</span>,SUBSYSTEM==<span class="string">&quot;block&quot;</span>,ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;PURE&quot;</span>,ATTR&#123;queue/read_ahead_kb&#125;=<span class="string">&quot;256&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># another example------</span></span><br><span class="line">ACTION!=<span class="string">&quot;add&quot;</span>, GOTO=<span class="string">&quot;deauthorize_end&quot;</span></span><br><span class="line">SUBSYSTEM!=<span class="string">&quot;usb&quot;</span>, GOTO=<span class="string">&quot;deauthorize_end&quot;</span></span><br><span class="line">TEST!=<span class="string">&quot;authorized&quot;</span>, GOTO=<span class="string">&quot;deauthorize_end&quot;</span></span><br><span class="line"><span class="comment">## make hubs deauthorize all devices by default</span></span><br><span class="line">TEST==<span class="string">&quot;authorized_default&quot;</span>, ATTR&#123;authorized_default&#125;=<span class="string">&quot;0&quot;</span>, GOTO=<span class="string">&quot;deauthorize_end&quot;</span></span><br><span class="line"><span class="comment">## whitelist specific devices</span></span><br><span class="line">ENV&#123;ID_VENDOR&#125;==<span class="string">&quot;Yubico&quot;</span>, ENV&#123;ID_MODEL&#125;==<span class="string">&quot;Yubikey_NEO*&quot;</span>, ENV&#123;valid&#125;=<span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="comment">## authorize matched devices, warn about the rest</span></span><br><span class="line">ENV&#123;valid&#125;==<span class="string">&quot;1&quot;</span>, ENV&#123;valid&#125;=<span class="string">&quot;&quot;</span>, ATTR&#123;authorized&#125;=<span class="string">&quot;1&quot;</span>, GOTO=<span class="string">&quot;deauthorize_end&quot;</span></span><br><span class="line">RUN+=<span class="string">&quot;/usr/local/bin/usb-unauthorized <span class="variable">$devpath</span>&quot;</span></span><br><span class="line">LABEL=<span class="string">&quot;deauthorize_end&quot;</span></span><br><span class="line"></span><br><span class="line">https://usbguard.github.io/blog/2015/USBGuard-vs-UDev</span><br><span class="line"><span class="variable">$cat</span> /etc/usbguard/rules.conf</span><br><span class="line">allow 1050:0010 serial <span class="string">&quot;0001234567&quot;</span> name <span class="string">&quot;Yubico Yubikey II&quot;</span> with-interface <span class="string">&quot;03:01:01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#lvm for SAS SSD</span></span><br><span class="line">$ lvchange --readahead none/auto/8m/8192k /dev/mapper/vg_sas-lSASDATA</span><br><span class="line"></span><br><span class="line"><span class="comment">#disable or enable not impact too much in RHEL 7</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"> always madvise [never]</span><br><span class="line"></span><br><span class="line"><span class="comment">#nvme dev only 256K readahead size, same with the SAS SSD</span></span><br><span class="line">$ blockdev --report</span><br><span class="line">RO    RA   SSZ   BSZ   StartSec            Size   Device</span><br><span class="line">rw   256  4096  4096          0   2000398934016   /dev/nvme0n1</span><br><span class="line">rw  8192   512  4096          0    299439751168   /dev/sda</span><br><span class="line"></span><br><span class="line">$ blockdev --getra /dev/nvme0n1</span><br><span class="line">256</span><br></pre></td></tr></table></figure>
<p>Attach scsi device failed  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[1452899.796454] sd 2:0:61:0: attempting task abort!scmd(0x000000006e5496f7), outstanding for 30199 ms &amp; timeout 30000 ms</span><br><span class="line">[1452899.797565] sd 2:0:61:0: [sdaj] tag#3372 CDB: Read capacity(16) 9e 10 00 00 00 00 00 00 00 00 00 00 00 20 00 00</span><br><span class="line">[1452899.798126] scsi target2:0:61: handle(0x004c), sas_address(0x5000039728427d5b), phy(7)</span><br><span class="line">[1452899.798713] scsi target2:0:61: enclosure logical id(0x50080e545aa1403f), slot(7) </span><br><span class="line">[1452899.799291] scsi target2:0:61: enclosure level(0x0001), connector name(     )</span><br><span class="line">[1452900.483476] ....</span><br><span class="line">[1452903.573466] sd 2:0:61:0: task abort: SUCCESS scmd(0x000000006e5496f7)</span><br><span class="line">[1452904.579467] .</span><br><span class="line">[1452904.822575] mpt3sas_cm0: log_info(0x31110e05): originator(PL), code(0x11), sub_code(0x0e05)</span><br><span class="line">[1452905.130270] sd 2:0:61:0: Power-on or device reset occurred</span><br><span class="line">[1452905.138387] sd 2:0:61:0: [sdaj] Read Capacity(16) failed: Result: hostbyte=DID_OK driverbyte=DRIVER_OK</span><br><span class="line">[1452905.139350] sd 2:0:61:0: [sdaj] Sense Key : Not Ready [current] [descriptor] </span><br><span class="line">[1452905.140147] sd 2:0:61:0: [sdaj] Add. Sense: Logical unit is in process of becoming ready</span><br><span class="line">[1452905.163684] sd 2:0:61:0: [sdaj] Read Capacity(10) failed: Result: hostbyte=DID_OK driverbyte=DRIVER_OK</span><br><span class="line">[1452905.164944] sd 2:0:61:0: [sdaj] Sense Key : Not Ready [current] [descriptor] </span><br><span class="line">[1452905.166037] sd 2:0:61:0: [sdaj] Add. Sense: Logical unit is in process of becoming ready</span><br><span class="line">[1452905.167141] sd 2:0:61:0: [sdaj] 0 512-byte logical blocks: (0 B/0 B)</span><br><span class="line">[1452905.167940] sd 2:0:61:0: [sdaj] 0-byte physical blocks</span><br><span class="line">[1452905.189321] sd 2:0:61:0: [sdaj] Test WP failed, assume Write Enabled</span><br><span class="line">[1452905.507651] sd 2:0:61:0: [sdaj] Asking for cache data failed</span><br><span class="line">[1452905.508391] sd 2:0:61:0: [sdaj] Assuming drive cache: write through</span><br><span class="line">[1452905.603462] .</span><br><span class="line">[1452905.978650] sd 2:0:61:0: [sdaj] Attached SCSI disk</span><br><span class="line">[1452906.627462] .</span><br><span class="line">[1452907.331473] .</span><br><span class="line">[1452907.651475] .</span><br><span class="line">[1452908.355482] .</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://support.sas.com/resources/papers/proceedings17/1377-2017.pdf">Optimizing SAS® on RHEL 6&#x2F;7</a></p>
<p>KERNELS - match against the kernel name for the device, or the kernel name for any of the parent devices<br>SUBSYSTEMS - match against the subsystem of the device, or the subsystem of any of the parent devices<br>DRIVERS - match against the name of the driver backing the device, or the name of the driver backing any of the parent devices<br>ATTRS - match a sysfs attribute of the device, or a sysfs attribute of any of the parent devices</p>
<p>udevadm info -a -n &#x2F;dev&#x2F;sda<br>udevadm info -a -p $(udevadm info -q path -n &#x2F;dev&#x2F;sda)</p>
<p>About <a target="_blank" rel="noopener" href="https://library.netapp.com/ecmdocs/ECMP1196980/html/GUID-A055B184-0876-4376-9C75-35FE8C9BE832.html#:~:text=Queue%20depth%20is%20the%20number,depth%20equates%20to%20better%20performance.">queue_depth</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Note: To estimate the queue depth needed to achieve a certain I/O per second throughput, use this formula.</span><br><span class="line">Needed queue depth = (Number of I/O per second) x (Response time)</span><br><span class="line">For example, <span class="keyword">if</span> you need 40,000 I/O per second with a response time of 3 milliseconds, the needed queue depth = 40,000 x (0.003) = 120.</span><br></pre></td></tr></table></figure>

<p>For some nvme devices, verify the block driver value<br><a target="_blank" rel="noopener" href="https://library.netapp.com/ecmdocs/ECMP12404601/html/GUID-436F7286-AD26-4A8D-A2D1-2BC8B5CFC023.html">netapp reference</a><br><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/43861">redhat reference</a>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Intel give up the some of nvme SSD performance</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/nvme0n1/alignment_offset           <span class="comment">#(0)  0 , first parameter is intel P5316, second is the intel P3520</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/nvme0n1/nvme0n1p1/alignment_offset <span class="comment">#(0)  0</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/nvme0n1/queue/physical_block_size  <span class="comment">#(512) 4096</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/nvme0n1/queue/logical_block_size   <span class="comment">#(512)  4096</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/nvme0n1/queue/minimum_io_size      <span class="comment">#(65536)   4096</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/nvme0n1/queue/optimal_io_size      <span class="comment">#(65536)   0</span></span><br></pre></td></tr></table></figure>
<p>$ cat &#x2F;sys&#x2F;block&#x2F;sda&#x2F;queue&#x2F;optimal_io_size &lt;— if not zero<br>$ cat &#x2F;sys&#x2F;block&#x2F;sdb&#x2F;alignment_offset      &lt;— if not zero<br>$ cat &#x2F;sys&#x2F;block&#x2F;sda&#x2F;queue&#x2F;physical_block_size<br>Where (optimal_io_size + alignment_offset) &#x2F; physical_block_size should provide an ideal starting sector for the first partition.</p>
<p>LBA: logic addr<br>PBA: phy addr<br>The FTL( flash translation layer, it ‘s the Non-volatile cache, high cost) record the mapping relation (logical block address and phsical block address)<br>That means compare with MLC, the TCL need 2x FTL size , The QLC need 3x FTL size.     </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/2150101">max_sectors_kb</a> &#x3D; avgrq-sz(iostat)<ul>
<li>This parameter sets the maximum number of kilobytes that the block layer allows for a file system request. The value of this parameter must be less than or equal to the maximum size allowed by the hardware. The kernel also places an upper bound on this value with the BLK_DEF_MAX_SECTORS macro. This value varies from distribution to distribution, for example, it is 1024 on RHEL 6.3, 2048 on SLES 11 SP2.<ul>
<li>This specifies the maximum I&#x2F;O size that the host will issue to the target storage. linux 4.1x default value was 1280, Typically it is 512KiB (512 Bytes,1024 sectors, 4KN, 1024 sectors means 4096KiB)</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/block/sda/queue/max_sectors_kb</span><br><span class="line">1280</span><br><span class="line"></span><br><span class="line">#the PAGE_SIZE is architecture independent. It is 4096 for x86_64.</span><br><span class="line">#or you could set it from 1280 to 8192</span><br><span class="line">$ echo 8192 &gt; max_sectors_kb</span><br></pre></td></tr></table></figure>

<ul>
<li><p>max_segments (RO) - This parameter enables low level driver to set an upper limit on the number of hardware data segments in a request. In the HBA drivers, this is also known as sg_tablesize.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/block/sda/queue/max_segments</span><br><span class="line">128</span><br></pre></td></tr></table></figure>
</li>
<li><p>max_segment_size (RO) - This parameter enables low level driver to set an upper limit on the size of each data segment in an I&#x2F;O request in bytes. If clustering is enabled on the low level driver it is set to 65536 or it is set to system PAGE_SIZE by default, which is typically 4K. The maximum I&#x2F;O size is determined by the following:</p>
<ul>
<li>MAX_IO_SIZE_KB &#x3D; MIN(max_sectors_kb, (max_segment_size * max_segments)&#x2F;1024)</li>
<li>1280 KB       &#x3D; MIN(1280, (65536*128)&#x2F;1024) &#x3D; MIN(1280, 8192)</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/block/sda/queue/max_segment_size</span><br><span class="line">65536</span><br></pre></td></tr></table></figure>
<ul>
<li><p>physical_block_size</p>
<ul>
<li>Smallest internal unit on which the device can operate<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4KN HDD, there is no 512n in the large capacity HDD</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdj/queue/physical_block_size</span><br><span class="line">4096</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>logical_block_size</p>
<ul>
<li>Used externally to address a location on the device<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4KN</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdj/queue/logical_block_size</span><br><span class="line">4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 512e</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdi/queue/logical_block_size</span><br><span class="line">512</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>alignment_offset</p>
<ul>
<li>The number of bytes that the beginning of the Linux block device (partition&#x2F;MD&#x2F;LVM device) is offset from the underlying physical alignment<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/block/sdj/alignment_offset</span><br><span class="line">0</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>minimum_io_size</p>
<ul>
<li>The device’s preferred minimum unit for random I&#x2F;O</li>
<li>The minimum_io_size and optimal_io_size values for &#x2F;dev&#x2F;sdX devices are retrieved by the kernel by inquiring the storage vendor-provided I&#x2F;O Limits within the device VPD pages.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/block/sdj/queue/minimum_io_size</span><br><span class="line">4096</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="http://fibrevillage.com/storage/563-storage-i-o-alignment-and-size">optimal_io_size</a></p>
<ul>
<li>The device’s preferred unit for streaming I&#x2F;O<ul>
<li>Only one layer in the I&#x2F;O stack should adjust for a non-zero alignment_offset; once a layer adjusts accordingly, it will export a device with an alignment_offset of zero.</li>
<li>A striped Device Mapper (DM) device created with LVM must export a minimum_io_size and optimal_io_size relative to the stripe count (number of disks) and user-provided chunk size.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>Note:Red Hat Enterprise Linux 7 cannot distinguish between devices that don&#39;t provide I/O hints and those that do so with alignment_offset= 0 and optimal _io_size= 0</code>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Such a device might be a single SAS 4K device; as such, at worst 1MB of space is lost at the start of the disk.</span><br><span class="line">$ <span class="built_in">cat</span> /sys/block/sdj/queue/optimal_io_size</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">$ sg_inq -p 0xb0 /dev/sdacn</span><br><span class="line">VPD INQUIRY: Block limits page (SBC)</span><br><span class="line">  Optimal transfer length granularity: 1 blocks   &lt;&lt; [1] block-size x this field = minimal_io_size, block-size defined <span class="keyword">in</span> READCAP <span class="built_in">command</span> below.</span><br><span class="line">  Maximum transfer length: 8192 blocks</span><br><span class="line">  Optimal transfer length: 8192 blocks            &lt;&lt; [2] block-size x this field = optimal_io_size</span><br><span class="line">  Maximum prefetch, xdread, xdwrite transfer length: 0 blocks</span><br><span class="line"></span><br><span class="line">$ sg_readcap -16 /dev/sdacn</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=0, p_type=0, p_i_exponent=0</span><br><span class="line">   Thin provisioning: tpe=0, tprz=0</span><br><span class="line">   Last logical block address=4194303 (0x3fffff), Number of logical blocks=4194304</span><br><span class="line">   Logical block length=512 bytes                &lt;&lt; [3] this is block size (length), multiplier <span class="keyword">for</span> above fields.</span><br><span class="line">   Logical blocks per physical block exponent=0</span><br><span class="line">   Lowest aligned logical block address=0</span><br><span class="line">Hence:</span><br><span class="line">   Device size: 2147483648 bytes, 2048.0 MiB, 2.15 GB</span><br><span class="line"></span><br><span class="line">$ grep -v <span class="string">&quot;zz&quot;</span> /sys/block/sdacn/queue/*io_size</span><br><span class="line">/sys/block/sdacn/queue/minimum_io_size:512       &lt;&lt; [1] 1 block     x [3] 512-bytes/block =     512 bytes</span><br><span class="line">/sys/block/sdacn/queue/optimal_io_size:4194304   &lt;&lt; [2] 8192 blocks x [3] 512-bytes/block = 4194034 bytes</span><br></pre></td></tr></table></figure>

<ul>
<li>This does hint to the fact that it is possible to see different optimal_io_size for the same LUN across different access paths. This can happen (from storage controller configuration issues, manual changes (echo) or a trigger of udev rules), which could cause an exceptionally high optimal_io_size for the dm(multipath) device or paths which will not function. <ul>
<li>If this is seen, and the sg_readcap and sg_inq is lining up with what is in &#x2F;sys, it is likely due to a storage controller configuration issue, and the system’s SAN vendor should be contacted for analysis. </li>
<li>Below is an example of what this would look like, noting that 4278190080 is the LCM (least common multiple) of 4177920 and 16777216</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">$ multipath -ll disk1</span><br><span class="line">disk1 (wwid_entry_omitted) dm-108 3PARdata,VV</span><br><span class="line">size=80G features=<span class="string">&#x27;1 queue_if_no_path&#x27;</span> hwhandler=<span class="string">&#x27;1 alua&#x27;</span> wp=rw</span><br><span class="line">`-+- policy=<span class="string">&#x27;round-robin 0&#x27;</span> prio=1 status=active</span><br><span class="line">  |- 0:0:0:152 sdcg 69:64   active ready running</span><br><span class="line">  |- 1:0:0:152 sdjc 8:352   active ready running</span><br><span class="line">  |- 0:0:1:152 sdfr 130:208 active ready running</span><br><span class="line">  `- 1:0:1:152 sdmn 69:496  active ready running</span><br><span class="line"></span><br><span class="line">$ multipath -t <span class="comment">#export the config</span></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> dm-108 sdcg sdjc sdfr sdmn ; <span class="keyword">do</span> <span class="built_in">cat</span> /sys/block/<span class="variable">$i</span>/queue/optimal_io_size ; <span class="keyword">done</span></span><br><span class="line">4278190080     &lt;&lt; <span class="string">LCM of 16777216 and 4177920</span></span><br><span class="line"><span class="string">16777216       &lt;&lt; Optimal transfer length: 32768 blocks x Logical block length=512 bytes</span></span><br><span class="line"><span class="string">16777216       &lt;&lt; Optimal transfer length: 32768 blocks x Logical block length=512 bytes</span></span><br><span class="line"><span class="string">4177920        &lt;&lt; Optimal transfer length: 8160 blocks x Logical block length=512 bytes</span></span><br><span class="line"><span class="string">4177920        &lt;&lt; Optimal transfer length: 8160 blocks x Logical block length=512 bytes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mpathe: load table [0 2343177216 multipath  3 pg_init_retries 50 queue_if_no_path 1 rdac 2 1 round-robin 0 1 1 8:208 1 round-robin 0 1 1 8:160</span></span><br><span class="line"><span class="string">-----+              + ---------+ --------+  +---------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">     v              v          v         v  v</span></span><br><span class="line"><span class="string">   &quot;%s: load table [0       %llu        %s %s ]&quot;</span></span><br><span class="line"><span class="string">     +              +          +         +  +</span></span><br><span class="line"><span class="string">     |              |          |         |  |</span></span><br><span class="line"><span class="string">     |              |          |         |  +---&gt; [1] mpp-&gt;params, configuration attr settings for the device</span></span><br><span class="line"><span class="string">     |              |          |         +------&gt; TGT_MPATH,   #define TGT_MPATH &quot;multipath&quot;</span></span><br><span class="line"><span class="string">     |              |          +----------------&gt; mpp-&gt;size,   size or length of this multipath device in sectors</span></span><br><span class="line"><span class="string">     |              +---------------------------&gt;              starting LBA (sector) for this multipath device (always 0)</span></span><br><span class="line"><span class="string">     +------------------------------------------&gt; mpp-&gt;alias,  alias/name of the multipath device</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Recommendation is to use command multipath -ll mpathe to view the path information formatted more convienently.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                                                     1st                       2nd</span></span><br><span class="line"><span class="string">                           number of path groups +---+-------------------------+</span></span><br><span class="line"><span class="string">                                                 |   |                         |</span></span><br><span class="line"><span class="string">                                                 +   v                         v</span></span><br><span class="line"><span class="string">    3 pg_init_retries 50 queue_if_no_path 1 rdac 2 1 round-robin 0 1 1 8:208 1 round-robin 0 1 1 8:160 1</span></span><br><span class="line"><span class="string">    +-------------------------------------- +--- + + +------------------------ +------------------------</span></span><br><span class="line"><span class="string">    |                                       |    | | |</span></span><br><span class="line"><span class="string">    |                                       |    | | +-------&gt;                1st path information [2]</span></span><br><span class="line"><span class="string">    |                                       |    | +---------&gt; mpp-&gt;bestpg  , best path group to use</span></span><br><span class="line"><span class="string">    |                                       |    +-----------&gt; mpp-pg       , VECTOR_SIZE(mpp-&gt;pg) = number of path groups present</span></span><br><span class="line"><span class="string">    |                                       +----------------&gt; mpp-&gt;hwhander, path hardware handler is &#x27;rdac&#x27;</span></span><br><span class="line"><span class="string">    +--------------------------------------------------------&gt; mpp-&gt;features, [A] in this case pg_init_retries=50...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    round-robin 0 1 1 8:208 1 </span></span><br><span class="line"><span class="string">    round-robin 0 1 1 8:160 1</span></span><br><span class="line"><span class="string">    +------------ + + +---- +</span></span><br><span class="line"><span class="string">    |             | | |     | </span></span><br><span class="line"><span class="string">    |             | | |     +-----&gt; minimum number of io to send down this path before eval for path switch</span></span><br><span class="line"><span class="string">    |             | | +-----------&gt; path device major:minor number so 8:208=sdn and 8:160=sdk</span></span><br><span class="line"><span class="string">    |             | +-------------&gt; this path number in group = constant 1</span></span><br><span class="line"><span class="string">    |             +---------------&gt; pathgroup-&gt;paths[] length (aka number of paths in this group=1)</span></span><br><span class="line"><span class="string">    +-----------------------------&gt; mpp-&gt;selector, the path selector type, &#x27;round-robin&#x27; [A]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    shift = snprintf(p, freechar, &quot; %s %i 1&quot;, mp-&gt;selector, VECTOR_SIZE(pgp-&gt;paths));  </span></span><br><span class="line"><span class="string">    shift = snprintf(p, freechar, &quot; %s %d&quot;,   pp-&gt;dev_t,    tmp_minio);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If there there are multiple paths witin the group, then the major:minor and minimum number of io </span></span><br><span class="line"><span class="string">    for each path repeats, as in</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    round-robin 0 4 1  8:48 1  65:160 1 71:704 1 131:608 1</span></span><br><span class="line"><span class="string">                  +   +------ +-------- +------- +--------</span></span><br><span class="line"><span class="string">                  |   ^       ^         ^        ^</span></span><br><span class="line"><span class="string">                  |   |       |         |        |</span></span><br><span class="line"><span class="string">                  +---+-------+---------+--------+   </span></span><br><span class="line"><span class="string">                  |  1st     2nd       3rd      4th    </span></span><br><span class="line"><span class="string">                  v</span></span><br><span class="line"><span class="string">                  number of paths within this path group</span></span><br></pre></td></tr></table></figure>

<h3 id="parted-alignment"><a href="#parted-alignment" class="headerlink" title="parted alignment"></a>parted alignment</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/sdX <span class="string">&#x27;unit s print&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Is the partition align ?</span></span><br><span class="line">$ parted /dev/sdX align-check optimal 1</span><br><span class="line">1 aligned</span><br><span class="line"></span><br><span class="line"><span class="comment">#auto align</span></span><br><span class="line">$ parted -a optimal /dev/sdX mkpart primary 0% xxTB</span><br><span class="line"><span class="comment"># cylinder,none,minimal,optimal</span></span><br></pre></td></tr></table></figure>
<p>GUID Partition Table Scheme<br><img src="/img/GUID_Partition_Table_Scheme.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">LBA0 prrotective MBR</span><br><span class="line">-------------</span><br><span class="line">LBA1 Primary GPT header</span><br><span class="line">-------------</span><br><span class="line">LBA2 Entry1|Entry2|Entry3|Entry4</span><br><span class="line">-------------</span><br><span class="line">LBA3 Entries 5-128</span><br><span class="line">------------</span><br><span class="line">LBA34  Partirion1,2..</span><br><span class="line">LBA-34 remaining Partitions</span><br><span class="line">------------</span><br><span class="line">LBA-33  Entry1|Entry2|entry3|Entry4</span><br><span class="line">------------</span><br><span class="line">LBA-2   Entries 5-128</span><br><span class="line">------------</span><br><span class="line">LBA-1   Secondary GPT Header</span><br><span class="line">----</span><br></pre></td></tr></table></figure>

<h3 id="power-save-ATA"><a href="#power-save-ATA" class="headerlink" title="power save (ATA)"></a>power save (ATA)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">smartctl -i -n standby <span class="variable">$&#123;devices[0]&#125;</span> | grep -q <span class="string">&#x27;Device is in STANDBY&#x27;</span></span><br><span class="line"></span><br><span class="line">              never - check the device always, but <span class="built_in">print</span> the power mode <span class="keyword">if</span> <span class="string">&#x27;-i&#x27;</span> is specified.</span><br><span class="line">              <span class="built_in">sleep</span>[,STATUS] - check the device unless it is <span class="keyword">in</span> SLEEP mode.</span><br><span class="line">              standby[,STATUS]  -  check  the  device unless it is <span class="keyword">in</span> SLEEP or STANDBY mode.  In these modes most disks are not spinning, so <span class="keyword">if</span> you want to prevent a disk from spinning up, this is probably</span><br><span class="line">              what you want.</span><br><span class="line">              idle[,STATUS] - check the device unless it is <span class="keyword">in</span> SLEEP, STANDBY or IDLE mode.  In the IDLE state, most disks are still spinning, so this is probably not what you want.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Advance-reformat-4Kn-SCSI-devs-to-512-Bytes-sector"><a href="#Advance-reformat-4Kn-SCSI-devs-to-512-Bytes-sector" class="headerlink" title="Advance reformat 4Kn SCSI devs to 512 Bytes sector"></a>Advance reformat 4Kn SCSI devs to 512 Bytes sector</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl -a -d scsi /dev/sdd</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH728080AL4200</span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   4096 bytes</span><br><span class="line"></span><br><span class="line">$ smartctl -a -d scsi /dev/sdc</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST</span><br><span class="line">Product:              HUH728080AL4200</span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br></pre></td></tr></table></figure>

<p>Update: If you have a lot of drives to format, it may take a long time with sg_format as it wait until it finished before doing the next one (with a while loop I mean). Useful tip is to use the “-e” flag with sg_format then monitor operations with sg_turs -p but it may hang you tty as well.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/class/block/sdc/queue/hw_sector_size</span><br><span class="line">4096</span><br><span class="line"></span><br><span class="line">$ sg_format --format --size=512 /dev/sdc</span><br><span class="line">HGST      HUH728080AL4200   A7J0   peripheral_type: disk [0x0]</span><br><span class="line">&lt;&lt; <span class="string">supports protection information&gt;&gt;</span></span><br><span class="line"><span class="string">Mode Sense (block descriptor) data, prior to changes:</span></span><br><span class="line"><span class="string">  Number of blocks=1953506646 [0x74702556]</span></span><br><span class="line"><span class="string">  Block size=4096 [0x1000]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A FORMAT will commence in 10 seconds</span></span><br><span class="line"><span class="string">    ALL data on /dev/sdc will be DESTROYED</span></span><br><span class="line"><span class="string">        Press control-C to abort</span></span><br><span class="line"><span class="string">A FORMAT will commence in 5 seconds</span></span><br><span class="line"><span class="string">    ALL data on /dev/sdc will be DESTROYED</span></span><br><span class="line"><span class="string">        Press control-C to abort</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Format has started</span></span><br><span class="line"><span class="string">FORMAT Complete</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sg_turs -v /dev/sdb</span></span><br><span class="line"><span class="string">   test unit ready cdb: 00 00 00 00 00 00</span></span><br><span class="line"><span class="string">   test unit ready:  Descriptor format, current;  Sense key: Not Ready Additional sense: Logical unit not ready, format in progress</span></span><br><span class="line"><span class="string">   Descriptor type: Information    00 00 00 00 00 00 00 00 00 00</span></span><br><span class="line"><span class="string">   Descriptor type: Command specific    0x0000000000000000</span></span><br><span class="line"><span class="string">   device not ready</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sg_inq -v /dev/sdb</span></span><br><span class="line"><span class="string"># it will show the process of percent</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ cat /sys/class/block/sdc/queue/hw_sector_size</span></span><br><span class="line"><span class="string">512</span></span><br></pre></td></tr></table></figure>

<h3 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4458183/how-the-util-of-iostat-is-computed">iostat</a></h3><p>%util &#x3D; blkio.ticks &#x2F; deltams * 100%</p>
<p>deltams is the time elapsed since last snapshot in ms. It uses CPU stats from &#x2F;proc&#x2F;stat presumably because it gives better results than to rely on system time, but I don’t know for sure. (Side note: for some reason the times are divided by HZ, while the documentation states it’s in USER_HZ, I don’t understand that.)<br>blkio.ticks is “# of milliseconds spent doing I&#x2F;Os”, from &#x2F;proc&#x2F;diskstats docs:</p>
<p>Field  9 – # of I&#x2F;Os currently in progress<br>  The only field that should go to zero. Incremented as requests are<br>  given to appropriate struct request_queue and decremented as they finish.<br>Field 10 – # of milliseconds spent doing I&#x2F;Os<br>  This field increases so long as field 9 is nonzero.</p>
<p>struct ext_disk_stats *xds<br>xds-&gt;util   </p>
<p>Hypothesis:<br>Simple understand about util% &#x3D;  IO time&#x2F;the time(the clock) , if IO time &gt;&#x3D; the time, the utils &#x3D; 100%(in 1s), else, that means some times there is no IO ops in this second<br>Why no ops in this sec ? maybe something hang, maybe just no any IO loading   </p>
<p>In SAS arch, there are multiple lane&#x2F;phy in it, if single lane&#x2F;phy has full IO loading, the util% will reach 100%<br>Yes the device could be parallel, there are a lot of lane&#x2F;phy are free, but the single lane or phy has full. I think the util% was right  </p>
<ul>
<li>The single path(resource) was full (nvme,sas ssd)</li>
<li>If the block device ‘s performance is infinity,  All of CPU&#x2F;Mem&#x2F;NIC speed behind it. the bottle-neck not in the block device. some of syscall cause the util%&#x3D;100% too</li>
<li>Could the util% show the device are busy ? That right, util% is not enough, Could the iostat show the device are busy ? Yes, it can You can watch the await and util%, you could know the device busy or free. it ‘s so easy</li>
</ul>
<p>“iostat was not correct, it just show the wrong value”. That ‘s alarmist for iostat ,and it ‘s so funny     </p>
<p>This guy analyzed the code, but it ‘s not enough, he was not understand the iostat output.<br>The <a target="_blank" rel="noopener" href="https://bean-li.github.io/dive-into-iostat/">example</a> is good.   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ID      Time    Ops                                  in_flight  stamp   stamp_delta           io_ticks            time_in_queue</span><br><span class="line">0       100     new request in the queue                0       0       no need caculate          0                 0</span><br><span class="line">1       100.10  another request go to the queue         1       100     100.10-100 = 0.1        0.1                 0.1</span><br><span class="line">2       101.20  finish the first request                2       100.10  101.20-100.10 = 1.1     1.2(1.1+0.1)        0.1+1.1*2 (total 2x io requests) = 2.3</span><br><span class="line">3       103.60  finish the second request               1       101.20  103.60-101.20 = 2.4     3.6                 2.3+2.4*1=4.7</span><br><span class="line">4       153.60  The third request go to the queue       0       103.60  no need caculate        3.6                 4.7</span><br><span class="line">5       153.90  Finish the third request                1       153.60  153.90 - 153.60 = 0.3   3.9                 4.7+0.3 * 1= 5</span><br><span class="line"></span><br><span class="line">In 53.9s, All io requests in 3.9s, the other times has no any IO in the queue.  </span><br><span class="line">io_ticks  --&gt; util %    </span><br><span class="line">time_in_queue --&gt; avgqu-sz</span><br></pre></td></tr></table></figure>

<p>HDD IOPS   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Dwell time = <span class="number">0.5</span> x <span class="number">60</span>/RPM</span><br><span class="line">Seek rate = <span class="number">0.4</span> / (Average seek time + Dwell time)</span><br><span class="line"></span><br><span class="line">                                          -<span class="number">-60000</span>ms              ---half platter cycle</span><br><span class="line">                                          |                      |</span><br><span class="line">                                  ----<span class="number">-60</span>*<span class="number">1000</span>/<span class="number">7200</span>rpm per min/<span class="number">2</span>=<span class="number">4.17</span>ms</span><br><span class="line">                                  |</span><br><span class="line">IOPS = <span class="number">1000</span>ms / (average seek + Trotation + Transfer) = <span class="number">1000</span>/(<span class="number">10</span>+<span class="number">4.17</span>+<span class="number">1024</span>KB/<span class="number">160</span>KB)=<span class="number">48.61</span>  <span class="comment">//if I access 1024KB</span></span><br><span class="line">                   |                            |</span><br><span class="line">                   --vendor <span class="number">10</span>ms              ------<span class="number">-160</span>MB/s=<span class="number">160</span>MB/<span class="number">1000</span>ms=<span class="number">160</span>KB/ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="Linux-IO-schduler"><a href="#Linux-IO-schduler" class="headerlink" title="Linux IO schduler"></a>Linux IO schduler</h3><p>In the RedHat Enterprise 8, the mq-deadline is the default<br><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/30286/can-i-configure-my-linux-system-for-more-aggressive-file-system-caching">bfq setting not test</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">schdule = deadline</span><br><span class="line">nr_request = 1024</span><br><span class="line">max_sector_kb = 1024</span><br><span class="line">read_ahead_kb = 8192</span><br><span class="line">rq_affinity = 2</span><br><span class="line"><span class="comment"># For storage configurations that need to maximize distribution of completion processing setting this option to &#x27;2&#x27; forces the completion to run on the requesting cpu (bypassing the &quot;group&quot; aggregation logic).</span></span><br><span class="line"></span><br><span class="line">vm.dirty_ratio = 40</span><br><span class="line"><span class="comment"># dirty_ratio     &quot;Dirty&quot; memory is that waiting to be written to disk. dirty_ratio is the number of memory pages at which a process will start writing out dirty data, expressed as a percentage out of the total free and reclaimable pages. A default of 20 is reasonable. Increase to 40 to improve throughput, decrease it to 5 to 10 to improve latency, even lower on systems with a lot of memory.</span></span><br><span class="line"></span><br><span class="line">vm.dirty_background_ratio = 20</span><br><span class="line"><span class="comment"># dirty_background_ratio  Similar, but this is the number of memory pages at which the kernel background flusher thread will start writing out dirty data, expressed as a percentage out of the total free and reclaimable pages. Set this lower than dirty_ratio, dirty_ratio/2 makes sense and is what the kernel does by default. This page shows that dirty_ratio has the greater effect. Tune dirty_ratio for performance, then set dirty_background_ratio to half that value.</span></span><br><span class="line"></span><br><span class="line">vm.vfs_cache_pressure = 50</span><br><span class="line">This sets the <span class="string">&quot;pressure&quot;</span> or the importance the kernel places upon reclaiming memory used <span class="keyword">for</span> caching directory and inode objects. The default of 100 or relative <span class="string">&quot;fair&quot;</span> is appropriate <span class="keyword">for</span> compute servers. Set to lower than 100 <span class="keyword">for</span> file servers on <span class="built_in">which</span> the cache should be a priority. Set higher, maybe 500 to 1000, <span class="keyword">for</span> interactive systems.</span><br><span class="line"></span><br><span class="line">overcommit_memory       Allows <span class="keyword">for</span> poorly designed programs <span class="built_in">which</span> malloc() huge amounts of memory <span class="string">&quot;just in case&quot;</span> but never really use it. Set this to 0 (disabled) unless you really need it.</span><br></pre></td></tr></table></figure>

<h4 id="deadline-parameters"><a href="#deadline-parameters" class="headerlink" title="deadline parameters"></a><a target="_blank" rel="noopener" href="https://cromwell-intl.com/open-source/performance-tuning/disks.html">deadline parameters</a></h4><ul>
<li><p>fifo_batch</p>
<ul>
<li>Number of read or write operations to issue in one batch.  Lower values may further reduce latency. Higher values can increase throughput on rotating mechanical disks, but at the cost of worse latency. You selected the deadline scheduler to limit latency, so you probably don’t want to increase this, at least not by very much.</li>
</ul>
</li>
<li><p>read_expire</p>
<ul>
<li>Number of milliseconds within which a read request should be served. Reduce this from the default of 500 to 100 on a system with interactive users.</li>
</ul>
</li>
<li><p>rite_expire</p>
<ul>
<li>Number of milliseconds within which a write request should be served.</li>
<li>Leave at default of 5000, let write operations be done asynchronously in the background unless your specialized application uses many synchronous writes.</li>
</ul>
</li>
<li><p>writes_starved</p>
<ul>
<li>Number read batches that can be processed before handling a write batch. Increase this from default of 2 to give higher priority to read operations.</li>
</ul>
</li>
<li><p>nr_requests</p>
<ul>
<li>Maximum number of read and write requests that can be queued at one time before the next process requesting a read or write is put to sleep. Default value of 128 means 128 read requests and 128 write requests can be queued at once. Larger values may increase throughput for workloads writing many small files, smaller values increase throughput with larger I&#x2F;O operations. You could decrease this if you are using latency-sensitive applications, but then you shouldn’t be using NOOP if latency is sensitive!</li>
</ul>
</li>
<li><p>The maximum number of I&#x2F;O operations within the I&#x2F;O scheduler is nr_requests<em>2. As stated, nr_requests is applied separately for reads and writes. Note that nr_requests only applies to the I&#x2F;O operations within the I&#x2F;O scheduler and not to I&#x2F;O operations already dispatched to the underlying device. Therefore, the maximum outstanding limit of I&#x2F;O operations against a device is (nr_requests</em>2)+(queue_depth) where queue_depth is &#x2F;sys&#x2F;block&#x2F;sdN&#x2F;device&#x2F;queue_depth, sometimes also referred to as the LUN queue depth. You can see this total outstanding number of I&#x2F;O operations in, for example, the output of iostat in the avgqu-sz column.</p>
</li>
<li><p>read_ahead_kb   Number of kilobytes the kernel will read ahead during a sequential read operation. 128 kbytes by default, if the disk is used with LVM the device mapper may benefit from a higher value. If your workload does a lot of large streaming reads, larger values may improve performance.</p>
<ul>
<li>max_sectors_kb  Maximum allowed size of an I&#x2F;O request in kilobytes, which must be within these bounds:</li>
<li>Min value &#x3D; max(1, logical_block_size&#x2F;1024)</li>
<li>Max value &#x3D; max_hw_sectors_kb</li>
<li>Red Hat recommends max_sectors_kb to always be a multiple of the optimal I&#x2F;O size and the internal erase block size.</li>
</ul>
</li>
<li><p>optimal_io_size</p>
<ul>
<li>Some storage devices report an optimal I&#x2F;O size through this parameter. If this value is reported, Red Hat recommends that applications issue I&#x2F;O aligned to and in multiples of the optimal I&#x2F;O size wherever possible.</li>
</ul>
</li>
<li><p>rotational      Should be 0 (no) for solid-state disks, but some do not correctly report their status to the kernel. If incorrectly set to 1 for an SSD, set it to 0 to disable unneeded scheduler logic meant to reduce number of seeks.</p>
</li>
</ul>
<h3 id="scsi-driver-error-handaling-EH"><a href="#scsi-driver-error-handaling-EH" class="headerlink" title="scsi_driver error handaling (EH)"></a>scsi_driver error handaling (EH)</h3><ul>
<li>scsi driver error Handaling (EH) timeout – eh_timeout (from default 10 second to 5 seconds)<ul>
<li>HBA reset time - eh_deadline (from disable&#x2F;0 to 5 seconds, default was off)</li>
</ul>
</li>
<li>The SCSI error handling (EH) mechanism attempts to perform error recovery on failed SCSI devices. The SCSI host object eh_deadline parameter enables you to configure the maximum amount of time for the recovery. After the configured time expires, SCSI EH stops and resets the entire host bus adapter (HBA).</li>
</ul>
<h3 id="long-data-sector"><a href="#long-data-sector" class="headerlink" title="long-data-sector"></a>long-data-sector</h3><p>From vendor spec, only SAS device support this feature<br>You could format the driver logic sector to 4096,4112,4116,4224KB or 512,520 Bytes<br>SATA device only support 4096 or 512</p>
<p>You could get the logic sector size(4096,4112,4224), the size could be read from driver</p>
<h4 id="T10-DIF-PI"><a href="#T10-DIF-PI" class="headerlink" title="T10 DIF&#x2F;PI"></a><a target="_blank" rel="noopener" href="https://www.seagate.com/files/staticfiles/docs/pdf/whitepaper/safeguarding-data-from-corruption-technology-paper-tp621us.pdf">T10 DIF&#x2F;PI</a></h4><p>T10 DIF&#x2F;PI for avoid data corruption from some device no CRC&#x2F;ECC product, so it check the data consistency from the source to the destination</p>
<p>The user data in ecc memory(512B) —–&gt; SAS HBA&#x2F;iscsi driver(520B) -&gt; SAS IO expander&#x2F;or some very complicated network contains HBA or the others -&gt; Storage medium(520)<br>Because the hardware just check from input or output port from itself</p>
<p>The risk of corrupted data falling through the inherent cracks in this protection methodology is significant, and the havoc such undetected, silent data corruption could wreak (lost or inaccurate data, significant downtime) is substantial</p>
<h4 id="About-DIF-520-Bytes"><a href="#About-DIF-520-Bytes" class="headerlink" title="About DIF 520 Bytes"></a><a target="_blank" rel="noopener" href="https://lwn.net/Articles/280023/">About DIF 520 Bytes</a></h4><p>SCSI drives can usually be reformatted to 520-byte sectors, yielding 8 extra bytes per sector.  These 8 bytes have traditionally been used by RAID controllers to store internal protection information.</p>
<p>DIF (Data Integrity Field) is an extension to the SCSI Block Commands that standardizes the format of the 8 extra bytes and defines ways to interact with the contents at the protocol level.  We refer to the extra information as “integrity metadata” or “IMD”.<br>Each 8-byte DIF tuple is split into three chunks:<br>        * a 16-bit guard tag containing a CRC of the 512-byte data portion of the sector.<br>        * a 16-bit application tag which is up for grabs.<br>        * a 32-bit reference tag which contains an incrementing counter for each sector.  For DIF Type 1 it also needs to match the physical LBA on the drive.<br>There are three types of DIF defined: Type 1, Type 2, and Type 3.  My patches are Type 1 only, although Type 3 devices should work.  Type 2 depends on 32-byte CDBs and is in progress.<br>Since the DIF tuple format is standardized, both initiators and targets (as well as potentially transport switches in-between) to verify the integrity of the data going over the bus.<br>When writing, the HBA will DMA 512-byte sectors from host memory, generate the matching integrity metadata and send out 520-byte sectors on the wire.  The disk will verify the integrity of the data before committing it to stable storage<br>When reading, the drive will send 520-byte sectors to the HBA.  The HBA will verify the data integrity and DMA 512-byte sectors to host memory.<br>IOW, DIF provides means for added integrity protection between HBA and disk</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.seagate.com/files/staticfiles/docs/pdf/whitepaper/safeguarding-data-from-corruption-technology-paper-tp621us.pdf">type 0</a><br>  * Describes a drive that is not formatted with PI information bytes. This allows for legacy support in non-PI systems.</li>
<li>type 1<br>  * Provides support of PI protection using 10- and 16-byte commands. The RDPROTECT and WRTPROTECT bits allow for checking control through the CDB. Eight bytes of Protection Information are transmitted at sector boundaries across the interface if RDPROTECT and WRTPROTECT bits are non-zero values. Type I does not allow the use of 32-byte commands.</li>
<li>type 2<br>  * Provides checking control and additional expected fields within the 32-byte CDBs. Eight bytes of Protection Information are transmitted at sector boundaries across the interface if RDPROTECT and WRTPROTECT bits are non-zero values. Type II does allow the use of 10- and 16-byte commands with zero values in the RDPROTECT and WRTPROTECT fields. The drive will generate a dummy (for example, 0xFFFF) eight bytes of Protection Information in the media, but these eight bytes will not be transferred to the host during read.</li>
<li>type 3<br>  * seagate not support type 3</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">The T10-PI standard is an extension of the existing T10 SCSI Block Commands specification; covering communication between SCSI controllers and storage devices, Protection Information (PI) adds an extra eight bytes of information to the 512-byte sectors typical of enterprise hard drives. Increasing sector size to 520 bytes, these eight bytes of metadata consist of guard (GRD), application (APP) and reference (REF) tags that are used to verify the 512 bytes of data in the sector   </span><br><span class="line"></span><br><span class="line">512 bytes of data</span><br><span class="line">GRD-- 16-bit guard tag(crc of 512 byte data portion) 512-514 Bytes</span><br><span class="line">APP-- 16-bit application tag 514-516 Bytes (application custom)</span><br><span class="line">REF-- 32-bit reference tag 516-519 Bytes (For protect Misdirected Writes)</span><br><span class="line">    Misdirected Write: the ture write LAB was not match with the write LBA target</span><br><span class="line"></span><br><span class="line">DIF=512+8, DIF need apply a 520 bytes buffer</span><br><span class="line">DIX=512B*8 (data buffer), 8x8Bytes(pi buffer), two parts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A device that supports protection information (i.e. supports one or more protection types of 1 or higher) sets the &quot;PROTECT&quot; bit in its standard INQUIRY response. It  also  sets the  SPT  field  in the EXTENDED INQUIRY VPD page response to indicate which protection types it supports. The current protection type of a disk can be found in the &quot;P_TYPE&quot; and &quot;PROT_EN&quot; fields in the response of a READ CAPACITY (16) command (e.g. with the &#x27;sg_readcap --long&#x27; utility).</span><br><span class="line"></span><br><span class="line">type 0: No checking but target device must generate on WRITE</span><br><span class="line">type 1: GUARD + REF checking (LBA)</span><br><span class="line">type 2: GUARD + REF checking (Extended Indirect LBA)</span><br><span class="line">        READ(32)/WRITE(32) only</span><br><span class="line">type 3: GUARD tag</span><br><span class="line"></span><br><span class="line">Protection Information is intended as a standardized approach to system level LRC traditionally provided by systems using 520 byte formatted LBAs. Drives formatted with PI information provide the same, common LBA count (i.e. same capacity point) as non-PI formatted drives. Sequential performance of a PI drive will be reduced by approximately 1.56% due to the extra overhead of PI being transferred from the media that is not calculated as part of the data transferred to the host. To determine the full transfer rate of a PI drive, transfers should be calculated by adding the 8 extra bytes of PI to the transferred LBA length, i.e. 512 + 8 = 520. PI formatted drives are physically formatted to 520 byte sectors that store 512 bytes</span><br><span class="line">of customer data with 8 bytes of Protection Information appended to it. The advantage of PI is that the Protection Information bits can be managed at the HBA and HBA driver level. Allowing a system that typically does not support 520 LBA formats to integrate this level of protection. Protection Information is valid with any supported LBA size. 512 LBA size is used here as common example.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>520-Bytes Sector on Protection Information Disk Drive<br>512-Bytes  +  8 Bytes (metadata)<br>512-Bytes &#x3D; User data<br>8 Bytes &#x3D; End-to-End Check &#x3D; 2 Bytes(logical block guard, CRC) + 2 Bytes(logical block application guard) + 4 Bytes(logical block reference tag)</p>
<p>#smart  info<br>Vendor:               HGST<br>Product:              HUH721212AL5200<br>Revision:             NS05<br>Compliance:           SPC-4<br>User Capacity:        11,756,399,230,976 bytes [11.7 TB]<br>Logical block size:   512 bytes<br>Physical block size:  4096 bytes<br>Formatted with type 2 protection<br>8 bytes of protection information per logical block<br>LU is fully provisioned<br>Rotation Rate:        7200 rpm</p>
<p>#type 2 ,512 example<br>$ sg_readcap -l &#x2F;dev&#x2F;sdj<br>Read Capacity results:<br>   Protection: prot_en&#x3D;1, p_type&#x3D;1, p_i_exponent&#x3D;0 [type 2 protection]<br>   Logical block provisioning: lbpme&#x3D;0, lbprz&#x3D;0<br>   Last logical block address&#x3D;19134414847 (0x4747fffff), Number of logical blocks&#x3D;19134414848<br>   Logical block length&#x3D;512 bytes<br>   Logical blocks per physical block exponent&#x3D;3<br>   Lowest aligned logical block address&#x3D;0<br>Hence:<br>   Device size: 9796820402176 bytes, 9342976.0 MiB, 9796.82 GB</p>
<p>#type 0, 4K example<br>Read Capacity results:<br>   Protection: prot_en&#x3D;0, p_type&#x3D;0, p_i_exponent&#x3D;0<br>   Logical block provisioning: lbpme&#x3D;0, lbprz&#x3D;0<br>   Last LBA&#x3D;2441609215 (0x9187ffff), Number of logical blocks&#x3D;2441609216<br>   Logical block length&#x3D;4096 bytes<br>   Logical blocks per physical block exponent&#x3D;0<br>   Lowest aligned LBA&#x3D;0<br>Hence:<br>   Device size: 10000831348736 bytes, 9537536.0 MiB, 10000.83 GB, 10.00 TB</p>
<p>$ sg_readcap –16 -b &#x2F;dev&#x2F;sdj<br>0x474800000 0x200</p>
<p>10TB models with PI bytes<br>Sector   Dec           hex          10TB models w&#x2F;o PI bytes<br>512 19,134,414,848 474800000        19,532,873,728 48C400000 (10000831348736 &#x3D; 19,532,873,728 * 512 &#x3D; SATA 10TB raw size)<br>520 18,845,007,872 463400000        19,134,414,848 474800000<br>524 18,704,498,688 45AE00000        18,989,711,360 46BE00000<br>528 18,563,989,504 452800000        18,845,007,872 463400000<br>4096 2,424,569,856 90840000         2,441,609,216 91880000 (10000831348736 &#x3D; 2,441,609,216 * 4096 &#x3D; SATA 10TB raw size)<br>4160 2,387,345,408 8E4C0000         2,391,801,856 8E900000<br>4192 2,368,995,328 8D340000         2,373,713,920 8D7C0000 1<br>4224 2,351,169,536 8C240000         2,355,625,984 8C680000</p>
<h1 id="models-with-PI-bytes-the-page-only-show-512-or-4096-bytes-the-extra-space-overhead-hide-in-HDD"><a href="#models-with-PI-bytes-the-page-only-show-512-or-4096-bytes-the-extra-space-overhead-hide-in-HDD" class="headerlink" title="models with PI bytes, the page only show 512 or 4096 bytes, the extra space overhead hide in HDD"></a>models with PI bytes, the page only show 512 or 4096 bytes, the extra space overhead hide in HDD</h1><h1 id="modlls-w-o-PI-bytes-smartctl-could-get-520-524-4160-4192-4224-from-logic-sector-bytes"><a href="#modlls-w-o-PI-bytes-smartctl-could-get-520-524-4160-4192-4224-from-logic-sector-bytes" class="headerlink" title="modlls w&#x2F;o PI bytes, smartctl could get 520,524,4160,4192,4224 from logic sector bytes"></a>modlls w&#x2F;o PI bytes, smartctl could get 520,524,4160,4192,4224 from logic sector bytes</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### [T10 DIX and PI](https://sp.ts.fujitsu.com/dmsp/Publications/public/dx_s3_Oracle_Linux_T10_PI_E16G_en.pdf)</span><br><span class="line">```bash</span><br><span class="line">|--------------Server----------------|                  |-------Storage system----|</span><br><span class="line">Application -&gt; OS -&gt; IO controller/HBA -&gt; SAN/Switch -&gt; Controller/switch -&gt; Driver</span><br><span class="line">|--------------DIX------------||----------------------PI--------------------------| </span><br></pre></td></tr></table></figure>
<p>DIX end at HBA input ( add extra 8 Bytes for protect in every level )<br>PI start at HBA output ( add extra 8 Bytes for protect in every level )<br>DIX + PI means end to end data protection<br>In some case, maybe you just support T10 PI and not DIX support</p>
<h3 id="Security-erasing"><a href="#Security-erasing" class="headerlink" title="Security erasing"></a>Security erasing</h3><p>SAS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sg_format --format /dev/sdx</span><br></pre></td></tr></table></figure>

<p>SATA</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hdparm --user-master u --security-set-pass password /dev/sdx</span><br></pre></td></tr></table></figure>

<p>NVME<br><a target="_blank" rel="noopener" href="https://nvmexpress.org/wp-content/uploads/NVM-Express-1_4-2019.06.10-Ratified.pdf">for more info</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ nvme list</span><br><span class="line">Node             SN                   Model                                    Namespace Usage                      Format           FW Rev</span><br><span class="line">---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------</span><br><span class="line">/dev/nvme0n1     xxxxxxxxxxxxxxx      INTEL SSDPED1K375GA                      1         375.08  GB / 375.08  GB    512   B +  0 B   E2010324</span><br><span class="line"></span><br><span class="line">$ nvme id-ctrl -H  /dev/nvme0n1 | grep format -i</span><br><span class="line">  [1:1] : 0x1   Format NVM Supported</span><br><span class="line">  [0:0] : 0     Admin Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line">  [0:0] : 0     Format Applies to Single Namespace(s)</span><br><span class="line">  [0:0] : 0     NVM Vendor Specific Commands uses Vendor Specific Format</span><br><span class="line"></span><br><span class="line">$ --lbaf</span><br><span class="line">LBA Format: This field specifies the LBA format to apply to the NVM media. This corresponds to the LBA formats indicated <span class="keyword">in</span> the Identify Namespace <span class="built_in">command</span>. Defaults to 0.</span><br><span class="line"></span><br><span class="line">$ nvme format /dev/nvme0n1 --ses=1 -pi 1</span><br><span class="line"><span class="comment"># ses</span></span><br><span class="line"><span class="comment">#Format namespace 1 with user data secure erase settings and protection information</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0 (default) means No secure erase operation requested</span></span><br><span class="line"><span class="comment">#1 User Data Erase: All user data shall be erased, contents of the user data after the erase is indeterminate (e.g., the user data may be zero filled, one filled, etc). The controller may perform a cryptographic erase when a User Data Erase is requested if all user data is encrypted. </span></span><br><span class="line"><span class="comment">#2 Cryptographic Erase: All user data shall be erased cryptographically. This is accomplished by deleting the encryption key.</span></span><br><span class="line"><span class="comment">#3-7 Reserved</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pi </span></span><br><span class="line"><span class="comment"># 0 default, not enabled</span></span><br><span class="line"><span class="comment"># 1,type 1</span></span><br><span class="line"><span class="comment"># 2,type 2 </span></span><br><span class="line"><span class="comment"># 3,type 3</span></span><br><span class="line"><span class="comment"># 4-7 Reserved</span></span><br><span class="line"></span><br><span class="line">$ nvme id-ns /dev/nvme1n1 | grep LBA</span><br><span class="line">LBA Format  0 : Metadata Size: 0   bytes - Data Size: 512 bytes - Relative Performance: 0x1 Better</span><br><span class="line">LBA Format  1 : Metadata Size: 8   bytes - Data Size: 512 bytes - Relative Performance: 0x3 Degraded</span><br><span class="line">LBA Format  2 : Metadata Size: 0   bytes - Data Size: 4096 bytes - Relative Performance: 0 Best  (<span class="keyword">in</span> use)</span><br><span class="line">LBA Format  3 : Metadata Size: 8   bytes - Data Size: 4096 bytes - Relative Performance: 0x2 Good</span><br><span class="line"></span><br><span class="line">$ nvme format /dev/nvme1n1 -l 2</span><br></pre></td></tr></table></figure>

<h3 id="Enable-the-blk-mq-and-scsi-mq"><a href="#Enable-the-blk-mq-and-scsi-mq" class="headerlink" title="Enable the blk_mq and scsi_mq"></a>Enable the blk_mq and scsi_mq</h3><p>scsi-mq:specify scsi_mod.use_blk_mq&#x3D;y<br>blk-mq infrastructure if the dm_mod.use_blk_mq&#x3D;y</p>
<p>The scsi_mod.use_blk_mq&#x3D;1 parameter enables blk-mq for SCSI-type block devices at the kernel level (where 0 disables it).<br>The dm_mod.use_blk_mq&#x3D;y parameter enables blk-mq for device-mapper (DM) Linux native multipathing (where n disables it).<br>The current design omits I&#x2F;O reordering (scheduler) because NVM media performance is not affected by the I&#x2F;O pattern being random or sequential. However, I&#x2F;O scheduling can be introduced by using kernel I&#x2F;O scheduler such as ‘mq-deadline’ (RHEL 8).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /sys/module/scsi_mod/parameters/use_blk_mq</span><br><span class="line">N</span><br><span class="line">$ <span class="built_in">cat</span> /sys/module/dm_mod/parameters/use_blk_mq</span><br><span class="line">N</span><br><span class="line">$ grubby --update-kernel=ALL --args=<span class="string">&#x27;scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y&#x27;</span></span><br><span class="line">$ reboot</span><br><span class="line">$ <span class="built_in">cat</span>  /sys/block/dm-X/dm/use_blk_mq</span><br><span class="line">$ tree /sys/class/block/sdl/mq /sys/class/block/dm-0/mq</span><br></pre></td></tr></table></figure>

<h3 id="lsscsi"><a href="#lsscsi" class="headerlink" title="lsscsi"></a>lsscsi</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">$ lsscsi -t | grep sdio</span><br><span class="line">[4:1:8:0]   disk    sas:0x5000c657afc33e1d          /dev/sdio</span><br><span class="line"></span><br><span class="line">$ lsscsi -t -L 4:1:8:0</span><br><span class="line">[4:1:8:0]   disk    sas:0x5000c657afc33e1d          /dev/sdio</span><br><span class="line">  transport=sas</span><br><span class="line">  vendor=HGST</span><br><span class="line">  model=HUH721010AL5200</span><br><span class="line">  bay_identifier=7</span><br><span class="line">  enclosure_device:Slot07</span><br><span class="line">  enclosure_identifier=0x50030103403449ca</span><br><span class="line">  initiator_port_protocols=none</span><br><span class="line">  initiator_response_timeout=1744</span><br><span class="line">  I_T_nexus_loss_timeout=1744</span><br><span class="line">  phy_identifier=33</span><br><span class="line">  ready_led_meaning=0</span><br><span class="line">  sas_address=0x5000c657afc33e1d</span><br><span class="line">  target_port_protocols=ssp</span><br><span class="line">  tlr_enabled=0</span><br><span class="line">  tlr_supported=0</span><br><span class="line"></span><br><span class="line">$ lsscsi -gis | grep sdio</span><br><span class="line">[4:1:8:0]   disk    HGST     HUH721010AL5200  A21D  /dev/sdio  35000c657afc33e1c  /dev/sg180  10.0TB</span><br><span class="line"></span><br><span class="line">$ lsblk -o NAME,MODEL,SERIAL,SIZE,STATE,TYPE,WWN --nodeps | grep sdio</span><br><span class="line">sdio HUH721010AL5200  5000c657afc33e1c                   9.1T running disk 0x5000c657afc33e1c</span><br><span class="line"></span><br><span class="line">$ lsblk -d -o name,rota,size</span><br><span class="line">NAME    ROTA   SIZE</span><br><span class="line">sda        1 278.9G</span><br><span class="line"></span><br><span class="line">$ lsscsi -t -H</span><br><span class="line">[0]    megaraid_sas</span><br><span class="line">[10]    ahci          sata:</span><br><span class="line">[11]    ahci          sata:</span><br><span class="line">[12]    mpt3sas       sas:0x500605b00bfa0982</span><br><span class="line">[13]    mpt3sas       sas:0x500605b00acf0542</span><br><span class="line">[14]    mpt3sas       sas:0x500605b00bfac033</span><br><span class="line"></span><br><span class="line">$ lsscsi -tiv</span><br><span class="line">[0:0:7:0]    disk    sas:0x500056b3787358c7          /dev/sdh   -</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/0:0:7:0  [/sys/devices/pci0000:ae/0000:ae:00.0/0000:af:00.0/host0/port-0:0/expander-0:0/port-0:0:7/end_device-0:0:7/target0:0:7/0:0:7:0]</span><br><span class="line">[0:0:8:0]    disk    sas:0x500056b3787358c8          /dev/sdi   -</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/0:0:8:0  [/sys/devices/pci0000:ae/0000:ae:00.0/0000:af:00.0/host0/port-0:0/expander-0:0/port-0:0:8/end_device-0:0:8/target0:0:8/0:0:8:0]</span><br><span class="line">[0:0:9:0]    disk    sas:0x5000cca26c1b8631          /dev/sdj   35000cca26c1b8630</span><br><span class="line"><span class="comment"># get single port</span></span><br><span class="line">[1:0:0:0]    disk    sas:0x5000cca26fae54a6          /dev/sda   35000cca26fae54a4  11.7TB</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/1:0:0:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:0/expander-1:1/port-1:1:0/end_device-1:1:0/target1:0:0/1:0:0:0]</span><br><span class="line">[1:0:1:0]    enclosu sas:0x500c0ff00b40aa3e          -          -       -</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/1:0:1:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:4/end_device-1:0:4/target1:0:1/1:0:1:0]</span><br><span class="line">[1:0:2:0]    disk    sas:0x5000cca26fabd8c2          /dev/sdb   35000cca26fabd8c0  11.7TB</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/1:0:2:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:0/expander-1:1/port-1:1:1/end_device-1:1:1/target1:0:2/1:0:2:0]</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">[1:0:87:0]   disk    sas:0x5000cca26fbac14e          /dev/sdcf  35000cca26fbac14c  11.7TB</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/1:0:87:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:3/expander-1:4/port-1:4:27/end_device-1:4:27/target1:0:87/1:0:87:0]</span><br><span class="line">[1:0:88:0]   process sas:0x500c0ff5f12425fe          -          -       -</span><br><span class="line">  <span class="built_in">dir</span>: /sys/bus/scsi/devices/1:0:88:0  [/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/host1/port-1:0/expander-1:0/port-1:0:3/expander-1:4/port-1:4:28/end_device-1:4:28/target1:0:88/1:0:88:0]</span><br><span class="line"></span><br><span class="line">$ grep 11.7 /tmp/tmp</span><br><span class="line">[1:0:0:0]    disk    sas:0x5000cca26fae54a6          /dev/sda   35000cca26fae54a4  11.7TB</span><br><span class="line">[1:0:2:0]    disk    sas:0x5000cca26fabd8c2          /dev/sdb   35000cca26fabd8c0  11.7TB</span><br><span class="line">[1:0:3:0]    disk    sas:0x5000cca26fb405d2          /dev/sdc   35000cca26fb405d0  11.7TB</span><br><span class="line">[1:0:4:0]    disk    sas:0x5000cca26fb99436          /dev/sdd   35000cca26fb99434  11.7TB</span><br><span class="line">[1:0:5:0]    disk    sas:0x5000cca26fbac11a          /dev/sde   35000cca26fbac118  11.7TB</span><br><span class="line">[1:0:6:0]    disk    sas:0x5000cca26fbac962          /dev/sdf   35000cca26fbac960  11.7TB</span><br><span class="line">[1:0:7:0]    disk    sas:0x5000cca26fb5c9b2          /dev/sdg   35000cca26fb5c9b0  11.7TB</span><br><span class="line">[1:0:8:0]    disk    sas:0x5000cca26fad67be          /dev/sdh   35000cca26fad67bc  11.7TB</span><br><span class="line">[1:0:9:0]    disk    sas:0x5000cca26fb7d912          /dev/sdi   35000cca26fb7d910  11.7TB</span><br><span class="line">[1:0:10:0]   disk    sas:0x5000cca26fbacac2          /dev/sdj   35000cca26fbacac0  11.7TB</span><br><span class="line">[1:0:11:0]   disk    sas:0x5000cca26fbac81a          /dev/sdk   35000cca26fbac818  11.7TB</span><br><span class="line">.......</span><br><span class="line">[1:0:78:0]   disk    sas:0x5000cca26fa140aa          /dev/sdbw  35000cca26fa140a8  11.7TB</span><br><span class="line">[1:0:79:0]   disk    sas:0x5000cca26fbac816          /dev/sdbx  35000cca26fbac814  11.7TB</span><br><span class="line">[1:0:80:0]   disk    sas:0x5000cca26fb99fba          /dev/sdby  35000cca26fb99fb8  11.7TB</span><br><span class="line">[1:0:81:0]   disk    sas:0x5000cca26faa42da          /dev/sdbz  35000cca26faa42d8  11.7TB</span><br><span class="line">[1:0:82:0]   disk    sas:0x5000cca26fad6776          /dev/sdca  35000cca26fad6774  11.7TB</span><br><span class="line">[1:0:83:0]   disk    sas:0x5000cca26fa46c8e          /dev/sdcb  35000cca26fa46c8c  11.7TB</span><br><span class="line">[1:0:84:0]   disk    sas:0x5000cca26fbab7a6          /dev/sdcc  35000cca26fbab7a4  11.7TB</span><br><span class="line">[1:0:85:0]   disk    sas:0x5000cca26fbab7e2          /dev/sdcd  35000cca26fbab7e0  11.7TB</span><br><span class="line">[1:0:86:0]   disk    sas:0x5000cca26fb5ca42          /dev/sdce  35000cca26fb5ca40  11.7TB</span><br><span class="line">[1:0:87:0]   disk    sas:0x5000cca26fbac14e          /dev/sdcf  35000cca26fbac14c  11.7TB</span><br></pre></td></tr></table></figure>

<h3 id="udevinfo"><a href="#udevinfo" class="headerlink" title="udevinfo"></a><a target="_blank" rel="noopener" href="https://sites.google.com/site/itmyshare/system-admin-tips-and-tools/udevadm---useage-examples">udevinfo</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#reload</span></span><br><span class="line">$ udevadm control --reload-rules; udevadm trigger</span><br><span class="line"></span><br><span class="line"><span class="comment">#show all parameters</span></span><br><span class="line">$ udevadm info --attribute-walk --name=/dev/sdx | grep MG04SCA60EE -i</span><br><span class="line">    ATTRS&#123;model&#125;==<span class="string">&quot;MG04SCA60EE     &quot;</span></span><br><span class="line"></span><br><span class="line">$ udevadm info --query=property --name /dev/sdd</span><br><span class="line">$ udevadm info --query=path --name /dev/sdd</span><br><span class="line">$ udevadm info --query=symlink --name /dev/sdd</span><br><span class="line">$ udevadm info --a --name=/dev/sdd</span><br><span class="line">$ udevadm info --attribute-walk --name /dev/sdd</span><br><span class="line"></span><br><span class="line">$ udevadm info -a -p $(udevadm info -q path -n /dev/sda)</span><br><span class="line">$ udevadm info -a -p /sys/class/net/eth0</span><br><span class="line">$ udevadm info -q path -n /dev/sda1</span><br><span class="line"></span><br><span class="line"><span class="comment">#trigger, remember to have --dry-run option if you run it on production node.</span></span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=scsi_host</span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=scsi_disk</span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=scsi_tape</span><br><span class="line">$ udevadm trigger --verbose --dry-run --<span class="built_in">type</span>=devices --subsystem-match=fc_host </span><br><span class="line"></span><br><span class="line"><span class="comment">#This option only waits for events triggered by the same command to finish</span></span><br><span class="line">$ udevadm settle</span><br><span class="line"></span><br><span class="line"><span class="comment">#control </span></span><br><span class="line">$ udevadm control --reload-rules</span><br><span class="line">$ --log-priority=&lt;level&gt;   <span class="built_in">set</span> the udev <span class="built_in">log</span> level <span class="keyword">for</span> the daemon</span><br><span class="line"></span><br><span class="line"><span class="comment">#monitor, show logs</span></span><br><span class="line">$ udevadm monitor --<span class="built_in">help</span></span><br><span class="line">Usage: udevadm monitor [--property] [--kernel] [--udev] [--<span class="built_in">help</span>]</span><br><span class="line">  --property                    <span class="built_in">print</span> the event properties</span><br><span class="line">  --kernel                      <span class="built_in">print</span> kernel uevents</span><br><span class="line">  --udev                        <span class="built_in">print</span> udev events</span><br><span class="line">  --subsystem-match=&lt;subsystem&gt; filter events</span><br><span class="line">  --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">$ udevadm monitor --property</span><br><span class="line">$ udevadm monitor --kernel</span><br><span class="line">$ udevadm monitor --udev</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify log mode /etc/udev/rules.d/00-debug-block.rules</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;block&quot;</span>, OPTIONS=<span class="string">&quot;log_level=debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#test</span></span><br><span class="line">$ udevadm <span class="built_in">test</span> /block/sdd</span><br><span class="line"></span><br><span class="line"><span class="comment">#show block info</span></span><br><span class="line">$ hwinfo --block</span><br><span class="line">$ udevadm info -a -n /dev/sda</span><br><span class="line">$ lshw -class storage</span><br><span class="line">$ lsblk -o NAME,MODEL,SERIAL,SIZE,STATE,TYPE,WWN --nodeps</span><br><span class="line"></span><br><span class="line"><span class="comment">#and you could cat kernel driver replace linux command</span></span><br><span class="line">[dev info](https://www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_t_fcp_wrk_actinfo.html)</span><br><span class="line">/sys/class/scsi_device/&lt;device_name&gt;/device/&lt;attribute&gt;</span><br><span class="line"></span><br><span class="line">ioerr_cnt       The number of SCSI commands that completed with an error.</span><br><span class="line">scsi_level      The SCSI revision level, received from inquiry data.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>access_denied   Flag that indicates whether access to the device is restricted by the FCP channel.The value is 1 if access is denied and 0 if access is permitted.If access is denied to your Linux instance, confirm that your SCSI devices are configured as intended. Also, be sure that you really want to share a SCSI device. For shared access to a SCSI device, preferably use NPIV). You might also use different FCP channels or target ports.<br>access_shared   This attribute is obsolete. The value is always 0.<br>access_readonly This attribute is obsolete. The value is always 0.<br>ked     Flag that indicates whether the device is in blocked state (0 or 1).<br>iocounterbits   The number of bits used for I&#x2F;O counters.<br>iodone_cnt      The number of completed or rejected SCSI commands.<br>ioerr_cnt       The number of SCSI commands that completed with an error.<br>iorequest_cnt   The number of issued SCSI commands.<br>queue_type      The type of queue for the SCSI device. The value can be one of the following:<br>                none<br>                simple<br>                ordered<br>model   The model of the SCSI device, received from inquiry data.<br>rev     The revision of the SCSI device, received from inquiry data.<br>scsi_level      The SCSI revision level, received from inquiry data.<br>type    The type of the SCSI device, received from inquiry data.<br>vendor  The vendor of the SCSI device, received from inquiry data.<br>fcp_lun The LUN of the SCSI device in 64-bit format.<br>hba_id  The bus ID of the SCSI device.<br>wwpn    The WWPN of the remote port.<br>zfcp_access_denied      Flag that indicates whether access to the device is restricted by the FCP channel.The value is 1 if access is denied and 0 if access is permitted. If access is denied to your Linux instance, confirm that your SCSI devices are configured as intended. Also, be sure that you really want to share a SCSI device. For shared access to a SCSI device, preferably use NPIV). You might also use different FCP channels or target ports.<br>zfcp_in_recovery        Shows if unit is in recovery (0 or 1).Shows if unit is in recovery (2 or 1)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### flush buffer</span><br><span class="line">```bash</span><br><span class="line">#Flush fs buff</span><br><span class="line">$ blockdev --flushbufs /dev/sdxx</span><br><span class="line"></span><br><span class="line">#Flush the SAS dev buff</span><br><span class="line">$ sdparm --command=sync /dev/sdxx</span><br><span class="line"></span><br><span class="line">#spindown the device</span><br><span class="line">$ sdparm --command=stop /dev/sdxx</span><br><span class="line"></span><br><span class="line">#Flush the SATA dev buff</span><br><span class="line">$ hdparm -F /dev/sdxx</span><br><span class="line"></span><br><span class="line">$ storcli64 /c0 set flushwriteverify=on</span><br><span class="line">$ storcli64 /c0 show flushwriteverify</span><br><span class="line">$ storcli64 /c0 flushcache</span><br><span class="line">Description = Adapter and/or disk caches flushed successfully.</span><br></pre></td></tr></table></figure>

<h3 id="Encrypt-block-device"><a href="#Encrypt-block-device" class="headerlink" title="Encrypt block device"></a>Encrypt block device</h3><h4 id="Input-password"><a href="#Input-password" class="headerlink" title="Input password"></a><em>Input password</em></h4><p>or you can not use openssl          </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 512 --<span class="built_in">hash</span> sha256 /dev/vdb     </span><br><span class="line">WARNING!     </span><br><span class="line">========     </span><br><span class="line">This will overwrite data on /dev/vdb irrevocably.     </span><br><span class="line"></span><br><span class="line">Are you sure? (Type uppercase <span class="built_in">yes</span>): YES      </span><br><span class="line">Enter passphrase:      </span><br><span class="line">Verify passphrase:      </span><br></pre></td></tr></table></figure>

<h4 id="mapper-test-device"><a href="#mapper-test-device" class="headerlink" title="mapper test device"></a><em>mapper test device</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">Enter passphrase <span class="keyword">for</span> /dev/vdb:     </span><br></pre></td></tr></table></figure>
<p>or     </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /dev/shm     </span><br><span class="line">openssl rand 128 -hex -out ./key     </span><br><span class="line">openssl aes-256-cbc -<span class="keyword">in</span> ./key -out key.enc     </span><br><span class="line"></span><br><span class="line">Verifying - enter aes-256-cbc encryption password:</span><br><span class="line">openssl aes-256-cbc -d -<span class="keyword">in</span> ./key.enc | cryptsetup [--allow-discards] --key-file=- luksOpen /dev/vdb <span class="built_in">test</span>     </span><br></pre></td></tr></table></figure>

<p>If you have a SSD, you may want to use –allow-discards. It creates an information leak but it enhances your SSD’s lifetime.     </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/mapper/test     </span><br><span class="line">cryptsetup luksDump /dev/vdb     </span><br><span class="line"></span><br><span class="line">``` bash     </span><br><span class="line">LUKS header information <span class="keyword">for</span> /dev/vdb     </span><br><span class="line">Key Slot 0: ENABLED     </span><br><span class="line">        Iterations:             80604</span><br><span class="line">        Salt:                   c4 c0 08 9c 77 ef 57 a5 d2 62 f4 94 03 56 24 7a</span><br><span class="line">                                86 0c f4 c6 06 6f 9e 01 80 <span class="built_in">fc</span> 0f 1d 3b a9 59 87</span><br><span class="line">        Key material offset:    8</span><br><span class="line">        AF stripes:             4000</span><br><span class="line">Key Slot 1: DISABLED     </span><br></pre></td></tr></table></figure>

<h4 id="Add-remove-key"><a href="#Add-remove-key" class="headerlink" title="Add&#x2F;remove key"></a><em>Add&#x2F;remove key</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksAddKey --key-slot 1 /dev/vdb     </span><br><span class="line">cryptsetup luksRemoveKey /dev/vdb     </span><br></pre></td></tr></table></figure>

<h4 id="Back-restore-header"><a href="#Back-restore-header" class="headerlink" title="Back&#x2F;restore header"></a><em>Back&#x2F;restore header</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksHeaderBackup /dev/vdb --header-backup-file /root/vdb-header-backup     </span><br><span class="line">cryptsetup luksHeaderRestore /dev/vdb --header-backup-file /root/vdb-header-backup     </span><br></pre></td></tr></table></figure>

<h4 id="is-luks-partition"><a href="#is-luks-partition" class="headerlink" title="is luks partition"></a><em>is luks partition</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup -v isLuks /dev/vdb     </span><br></pre></td></tr></table></figure>

<h4 id="Clean-luks-partition"><a href="#Clean-luks-partition" class="headerlink" title="Clean luks partition"></a><em>Clean luks partition</em></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 3145728 /dev/zero &gt; /dev/vdb;<span class="built_in">sync</span>     </span><br></pre></td></tr></table></figure>
<p>The default LUKS header (with only one key-slot enabled) takes 1052672 bytes, what is slightly more than 1 MiB. Having 2 key-slots enabled this would extend the header almost twice (key-slots * stripes * keysize + offset bytes). Therefore overwriting the first 3 MiB would do the job for us </p>
<h3 id="smart-err-health-info"><a href="#smart-err-health-info" class="headerlink" title="smart err health info"></a><a target="_blank" rel="noopener" href="https://www.dell.com/support/kbdoc/en-za/000136245/how-to-troubleshoot-hard-drive-sense-errors-on-a-dell-poweredge-server">smart err health info</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    K - sense key - 4 bits, (byte 2 of Fixed sense data format)</span><br><span class="line">    C - additional sense code (ASC) - 8 bits, (byte 12 of Fixed sense data format</span><br><span class="line">    Q - additional sense code qualifier (ASCQ) - 8 bits, (byte 13 of Fixed sense data format)</span><br><span class="line"></span><br><span class="line">The initiator can take action based on just the K field <span class="built_in">which</span> indicates <span class="keyword">if</span> the error is minor or major. However all three fields are logically combined into a 20-bit field called Key Code Qualifier or KCQ. The specification <span class="keyword">for</span> the target device defines the list of possible KCQ values. In practice, there are many KCQ values <span class="built_in">which</span> are common between different SCSI device types and different SCSI device vendors.</span><br><span class="line"></span><br><span class="line">=== START OF READ SMART DATA SECTION ===</span><br><span class="line">SMART Health Status: FAILURE PREDICTION THRESHOLD EXCEEDED: ascq=0xfd [asc=5d, ascq=fd]</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Key_Code_Qualifier">list of common Key Code Qualifiers</a><br><a target="_blank" rel="noopener" href="https://www.t10.org/lists/asc-num.htm">listing of SCSI ASC&#x2F;ASCQ Assignments</a>   </p>
<h3 id="Re-assign-bad-block"><a href="#Re-assign-bad-block" class="headerlink" title="Re-assign bad block"></a><a target="_blank" rel="noopener" href="https://www.smartmontools.org/wiki/BadBlockHowto">Re-assign bad block</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dmesg error</span></span><br><span class="line"> sd 13:0:10:0: attempting task abort! scmd(ffff88bdf0eb8000)</span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#22 CDB: Read(16) 88 00 00 00 00 04 16 2b fa 66 00 00 00 6c 00 00</span></span><br><span class="line"> scsi target13:0:10: _scsih_tm_display_info: handle(0x0015), sas_address(0x5000cca251b4462e), phy(37)</span><br><span class="line"> scsi target13:0:10: enclosurelogical <span class="built_in">id</span>(0x500304800928dc3f), slot(10)</span><br><span class="line"> scsi target13:0:10: enclosure level(0x0000), connector name(     )</span><br><span class="line"> sd 13:0:10:0: task abort: SUCCESS scmd(ffff88bdf0eb8000)</span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#22 FAILED Result: hostbyte=DID_TIME_OUT driverbyte=DRIVER_OK</span></span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#22 CDB: Read(16) 88 00 00 00 00 04 16 2b fa 66 00 00 00 6c 00 00</span></span><br><span class="line"> blk_update_request: I/O error, dev sdff, sector 17551850086</span><br><span class="line"> sd 13:0:10:0: attempting task abort! scmd(ffff88b39ff33800)</span><br><span class="line"> sd 13:0:10:0: [sdff] tag<span class="comment">#21 CDB: Read(16) 88 00 00 00 00 04 16 2b f9 78 00 00 00 ee 00 00</span></span><br><span class="line"> scsi target13:0:10: _scsih_tm_display_info: handle(0x0015), sas_address(0x5000cca251b4462e), phy(37)</span><br><span class="line"> scsi target13:0:10: enclosurelogical <span class="built_in">id</span>(0x500304800928dc3f), slot(10)</span><br><span class="line"> scsi target13:0:10: enclosure level(0x0000), connector name(     )</span><br><span class="line"> sd 13:0:10:0: task abort: SUCCESS scmd(ffff88b39ff33800)</span><br><span class="line"></span><br><span class="line">SMART Self-<span class="built_in">test</span> <span class="built_in">log</span></span><br><span class="line">Num  Test              Status                 segment  LifeTime  LBA_first_err [SK ASC ASQ]</span><br><span class="line">     Description                              number   (hours)</span><br><span class="line"><span class="comment"># 1  Background long   Completed                   -   50503                 - [-   -    -]   &lt;-------------hot plugout and plugin, re-test, it &#x27;s OK, no failed in segment</span></span><br><span class="line"><span class="comment"># 2  Background long   Failed in segment --&gt;       7   50010          66949046 [0x3 0x11 0x0] &lt;-------------previous test failed</span></span><br><span class="line"><span class="comment"># 3  Background short  Completed                   -   50010                 - [-   -    -]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ smartctl -t long /dev/sdff</span><br><span class="line"></span><br><span class="line"><span class="comment">### after test</span></span><br><span class="line">smartctl -l selftest /dev/sdb</span><br><span class="line">smartctl version 5.37 [i686-pc-linux-gnu] Copyright (C) 2002-6 Bruce Allen</span><br><span class="line">Home page is http://smartmontools.sourceforge.net/</span><br><span class="line">SMART Self-<span class="built_in">test</span> <span class="built_in">log</span></span><br><span class="line">Num  Test              Status            segment  LifeTime  LBA_first_err [SK ASC ASQ]</span><br><span class="line">     Description                         number   (hours)</span><br><span class="line"><span class="comment"># 1  Background long   Failed in segment      -     354           1193046 [0x3 0x11 0x0]</span></span><br><span class="line"><span class="comment"># 2  Background short  Completed              -     323                 - [-   -    -]</span></span><br><span class="line"><span class="comment"># 3  Background short  Completed              -     194                 - [-   -    -]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#That means sometimes the connection quality was bad</span></span><br><span class="line">$ sg_verify --lba=1193046 /dev/sdff</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">0x123456=1193046</span><br><span class="line"></span><br><span class="line"><span class="comment">#The link case</span></span><br><span class="line">$ sg_verify --lba=1193046 /dev/sdb</span><br><span class="line">verify (10):  Fixed format, current;  Sense key: Medium Error</span><br><span class="line"> Additional sense: Unrecovered <span class="built_in">read</span> error</span><br><span class="line">  Info fld=0x123456 [1193046]</span><br><span class="line">  Field replaceable unit code: 228</span><br><span class="line">  Actual retry count: 0x008b</span><br><span class="line">medium or hardware error, reported lba=0x123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now the GLIST length is checked before the block reassignment:</span></span><br><span class="line"></span><br><span class="line">$ sg_reassign --grown /dev/sdb</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 0</span><br><span class="line"><span class="comment"># And now for the actual reassignment followed by another check of the GLIST length:</span></span><br><span class="line"></span><br><span class="line">$ sg_reassign --address=1193046 /dev/sdb</span><br><span class="line"></span><br><span class="line">$ sg_reassign --grown /dev/sdb</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 1</span><br><span class="line"><span class="comment"># The GLIST length has grown by one as expected. If the disk was unable to recover any data, then the &quot;new&quot; block at lba 0x123456 has vendor specific data in it. The sg_reassign utility can also do bulk reassigns, see man sg_reassign for more information.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The dd command could be used to read the contents of the &quot;new&quot; block:</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdb iflag=direct skip=1193046 of=blk.img bs=512 count=1</span><br><span class="line"><span class="comment"># and a hex editor [11] used to view and potentially change the blk.img file. An altered blk.img file (or /dev/zero) could be written back with:</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=blk.img of=/dev/sdb seek=1193046 oflag=direct bs=512 count=1</span><br><span class="line"><span class="comment"># More work may be needed at the file system level, especially if the reassigned block held critical file system information such as a superblock or a directory.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#case 2:</span></span><br><span class="line">$ badblocks -wsv -b 4096 /dev/sdaq</span><br><span class="line"></span><br><span class="line"><span class="comment">#dmesg show</span></span><br><span class="line">[2322064.974247] sd 2:0:41:0: [sdaq] tag<span class="comment">#716 FAILED Result: hostbyte=DID_OK driverbyte=DRIVER_OK cmd_age=0s</span></span><br><span class="line">[2322064.975367] sd 2:0:41:0: [sdaq] tag<span class="comment">#716 Sense Key : Medium Error [current] [descriptor] </span></span><br><span class="line">[2322064.976091] sd 2:0:41:0: [sdaq] tag<span class="comment">#716 Add. Sense: Unrecovered read error</span></span><br><span class="line">[2322064.976807] sd 2:0:41:0: [sdaq] tag<span class="comment">#716 CDB: Read(16) 88 00 00 00 00 00 01 1a 20 09 00 00 04 39 00 00</span></span><br><span class="line">[2322064.977464] critical medium error, dev sdaq, sector 18489839 op 0x0:(READ) flags 0x0 phys_seg 6 prio class 2</span><br><span class="line">$ sg_verify --lba=18489839 /dev/sdaq </span><br><span class="line">verify(10):</span><br><span class="line">Descriptor format, current; Sense key: Medium Error</span><br><span class="line">Additional sense: Unrecovered <span class="built_in">read</span> error</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Information: 0x00000000011a21ef</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Sense key specific: Actual retry count: 358</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Field replaceable unit code: 0x0</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Vendor specific [0x80]</span><br><span class="line">    f7 a7 </span><br><span class="line">  Descriptor <span class="built_in">type</span>: Vendor specific [0x81]</span><br><span class="line">    ff ff ff ff ff ff </span><br><span class="line">VERIFY(10) medium or hardware error, reported lba=0x11a21ef</span><br><span class="line">sg_verify failed: Medium or hardware error with Info</span><br><span class="line"></span><br><span class="line">$ sg_reassign --address=18489839 /dev/sdaq</span><br><span class="line">$ sg_verify --lba=18489839 /dev/sdaq</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line">$ sg_reassign --grown /dev/sdaq</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In my real env</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9366 FAILED Result: hostbyte=DID_OK driverbyte=DRIVER_OK cmd_age=2s</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9366 Sense Key : Medium Error [current] [descriptor] </span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9366 Add. Sense: Unrecovered read error</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9366 CDB: Read(16) 88 00 00 00 00 00 f6 0f 9c b8 00 00 00 08 00 00</span></span><br><span class="line">critical medium error, dev sdae, sector 4128218296 op 0x0:(READ) flags 0x80700 phys_seg 1 prio class 2</span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#23 FAILED Result: hostbyte=DID_OK driverbyte=DRIVER_OK cmd_age=2s</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#23 Sense Key : Medium Error [current] [descriptor] </span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#23 Add. Sense: Unrecovered read error</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#23 CDB: Read(16) 88 00 00 00 00 00 f6 0f 9c b8 00 00 00 08 00 00</span></span><br><span class="line">critical medium error, dev sdae, sector 4128218296 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 2</span><br><span class="line">Buffer I/O error on dev sdae, logical block 516027287, async page <span class="built_in">read</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9445 FAILED Result: hostbyte=DID_OK driverbyte=DRIVER_OK cmd_age=2s</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9445 Sense Key : Medium Error [current] [descriptor] </span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9445 Add. Sense: Unrecovered read error</span></span><br><span class="line">sd 1:0:58:0: [sdae] tag<span class="comment">#9445 CDB: Read(16) 88 00 00 00 00 00 f6 0f 9c c8 00 00 00 08 00 00</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> ((i=<span class="number">4128218296</span>;i&lt;=<span class="number">4128218596</span>;i++)); <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=<span class="variable">$i</span>; <span class="keyword">done</span></span><br><span class="line">4128218296</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.08392 s, 0.0 kB/s</span><br><span class="line">4128218297</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.10697 s, 0.0 kB/s</span><br><span class="line">4128218298</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.01492 s, 0.0 kB/s</span><br><span class="line">4128218299</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.09059 s, 0.0 kB/s</span><br><span class="line">4128218300</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.09824 s, 0.0 kB/s</span><br><span class="line">4128218301</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.14031 s, 0.0 kB/s</span><br><span class="line">4128218302</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.15689 s, 0.0 kB/s</span><br><span class="line">4128218303</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.12382 s, 0.0 kB/s</span><br><span class="line">4128218304</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.0203391 s, 25.2 kB/s</span><br><span class="line">4128218305</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000221631 s, 2.3 MB/s</span><br><span class="line">4128218306</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000206822 s, 2.5 MB/s</span><br><span class="line">4128218307</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000225032 s, 2.3 MB/s</span><br><span class="line">4128218308</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.00021395 s, 2.4 MB/s</span><br><span class="line">4128218309</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000202437 s, 2.5 MB/s</span><br><span class="line">4128218310</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000316098 s, 1.6 MB/s</span><br><span class="line">4128218311</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000204745 s, 2.5 MB/s</span><br><span class="line">4128218312</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 4.97664 s, 0.0 kB/s</span><br><span class="line">4128218313</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 4.99069 s, 0.0 kB/s</span><br><span class="line">4128218314</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.16517 s, 0.0 kB/s</span><br><span class="line">4128218315</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 4.98206 s, 0.0 kB/s</span><br><span class="line">4128218316</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.07356 s, 0.0 kB/s</span><br><span class="line">4128218317</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.06521 s, 0.0 kB/s</span><br><span class="line">4128218318</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.0739 s, 0.0 kB/s</span><br><span class="line">4128218319</span><br><span class="line"><span class="built_in">dd</span>: error reading <span class="string">&#x27;/dev/sdae&#x27;</span>: Input/output error</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 5.00657 s, 0.0 kB/s</span><br><span class="line">4128218320</span><br><span class="line">2+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000228731 s, 2.2 MB/s</span><br><span class="line">4128218321</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000210056 s, 2.4 MB/s</span><br><span class="line">4128218322</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000205151 s, 2.5 MB/s</span><br><span class="line">4128218323</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000205663 s, 2.5 MB/s</span><br><span class="line">4128218324</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line"></span><br><span class="line"> sg_verify --lba=4128218296 /dev/sdae</span><br><span class="line">verify(10):</span><br><span class="line">Descriptor format, current; Sense key: Medium Error</span><br><span class="line">Additional sense: Unrecovered <span class="built_in">read</span> error</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Information: 0x00000000f60f9cb8</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Sense key specific: Actual retry count: 358</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Field replaceable unit code: 0x0</span><br><span class="line">  Descriptor <span class="built_in">type</span>: Vendor specific [0x80]</span><br><span class="line">    f7 2d </span><br><span class="line">  Descriptor <span class="built_in">type</span>: Vendor specific [0x81]</span><br><span class="line">    01 28 20 02 01 9a </span><br><span class="line">VERIFY(10) medium or hardware error, reported lba=0xf60f9cb8</span><br><span class="line">sg_verify failed: Medium or hardware error with Info</span><br><span class="line"></span><br><span class="line">$ sg_verify --lba=4128218295 /dev/sdae</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line">$ sg_verify --lba=4128218304 /dev/sdae</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line">$ sg_verify --lba=4128218305 /dev/sdae</span><br><span class="line">$ <span class="built_in">echo</span> $?</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;4128218312..4128218319&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>; sg_reassign --address=<span class="variable">$i</span> /dev/sdae; sg_reassign --grown /dev/sdae; <span class="keyword">done</span> </span><br><span class="line">4128218312</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218313</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218314</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218315</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218316</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218317</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218318</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line">4128218319</span><br><span class="line">&gt;&gt; Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218312</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000309718 s, 1.7 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218313</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000242476 s, 2.1 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218314</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000252474 s, 2.0 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218315</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000239435 s, 2.1 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218316</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000237252 s, 2.2 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218317</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000224568 s, 2.3 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218318</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000230717 s, 2.2 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218319</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000245475 s, 2.1 MB/s</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sdae of=/dev/null bs=512 count=1 skip=4128218320</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">512 bytes copied, 0.000234513 s, 2.2 MB/s</span><br><span class="line"></span><br><span class="line"><span class="comment">#previous smart</span></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">Vendor:               WDC</span><br><span class="line">Product:              WUS721010AL5204</span><br><span class="line">Revision:             C980</span><br><span class="line">Compliance:           SPC-4</span><br><span class="line">User Capacity:        10,000,831,348,736 bytes [10.0 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br><span class="line">Physical block size:  4096 bytes</span><br><span class="line">LU is fully provisioned</span><br><span class="line">Rotation Rate:        7200 rpm</span><br><span class="line">Form Factor:          3.5 inches</span><br><span class="line">Logical Unit <span class="built_in">id</span>:      0x5000cca0b07ff9b0</span><br><span class="line">Serial number:        VCJ8BV1P</span><br><span class="line">Device <span class="built_in">type</span>:          disk</span><br><span class="line">Transport protocol:   SAS (SPL-3)</span><br><span class="line">Local Time is:        Fri Nov 17 15:35:13 2023 CST</span><br><span class="line">SMART support is:     Available - device has SMART capability.</span><br><span class="line">SMART support is:     Enabled</span><br><span class="line">Temperature Warning:  Enabled</span><br><span class="line"></span><br><span class="line">=== START OF READ SMART DATA SECTION ===</span><br><span class="line">SMART Health Status: OK</span><br><span class="line"></span><br><span class="line">Grown defects during certification &lt;not available&gt;</span><br><span class="line">Total blocks reassigned during format &lt;not available&gt;</span><br><span class="line">Total new blocks reassigned &lt;not available&gt;</span><br><span class="line">Power on minutes since format &lt;not available&gt;</span><br><span class="line">Current Drive Temperature:     33 C</span><br><span class="line">Drive Trip Temperature:        85 C</span><br><span class="line"></span><br><span class="line">Accumulated power on time, hours:minutes 4264:07</span><br><span class="line">Manufactured <span class="keyword">in</span> week 36 of year 2021</span><br><span class="line">Specified cycle count over device lifetime:  50000</span><br><span class="line">Accumulated start-stop cycles:  6</span><br><span class="line">Specified load-unload count over device lifetime:  600000</span><br><span class="line">Accumulated load-unload cycles:  631</span><br><span class="line">Elements <span class="keyword">in</span> grown defect list: 1</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0       10         0        10    1217417      51614.468           5</span><br><span class="line">write:         0        0         0         0     239849      18812.945           0</span><br><span class="line">verify:        0        0         0         0        206          0.000           0</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#after reassigned</span></span><br><span class="line"></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">Vendor:               WDC</span><br><span class="line">Product:              WUS721010AL5204</span><br><span class="line">Revision:             C980</span><br><span class="line">Compliance:           SPC-4</span><br><span class="line">User Capacity:        10,000,831,348,736 bytes [10.0 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br><span class="line">Physical block size:  4096 bytes</span><br><span class="line">LU is fully provisioned</span><br><span class="line">Rotation Rate:        7200 rpm</span><br><span class="line">Form Factor:          3.5 inches</span><br><span class="line">Logical Unit <span class="built_in">id</span>:      0x5000cca0b07ff9b0</span><br><span class="line">Serial number:        VCJ8BV1P</span><br><span class="line">Device <span class="built_in">type</span>:          disk</span><br><span class="line">Transport protocol:   SAS (SPL-3)</span><br><span class="line">Local Time is:        Mon Jan 22 10:26:12 2024 CST</span><br><span class="line">SMART support is:     Available - device has SMART capability.</span><br><span class="line">SMART support is:     Enabled</span><br><span class="line">Temperature Warning:  Enabled</span><br><span class="line"></span><br><span class="line">=== START OF READ SMART DATA SECTION ===</span><br><span class="line">SMART Health Status: OK</span><br><span class="line"></span><br><span class="line">Grown defects during certification &lt;not available&gt;</span><br><span class="line">Total blocks reassigned during format &lt;not available&gt;</span><br><span class="line">Total new blocks reassigned &lt;not available&gt;</span><br><span class="line">Power on minutes since format &lt;not available&gt;</span><br><span class="line">Current Drive Temperature:     33 C</span><br><span class="line">Drive Trip Temperature:        85 C</span><br><span class="line"></span><br><span class="line">Accumulated power on time, hours:minutes 5842:57</span><br><span class="line">Manufactured <span class="keyword">in</span> week 36 of year 2021</span><br><span class="line">Specified cycle count over device lifetime:  50000</span><br><span class="line">Accumulated start-stop cycles:  6</span><br><span class="line">Specified load-unload count over device lifetime:  600000</span><br><span class="line">Accumulated load-unload cycles:  682</span><br><span class="line">Elements <span class="keyword">in</span> grown defect list: 3</span><br><span class="line"></span><br><span class="line">Error counter <span class="built_in">log</span>:</span><br><span class="line">           Errors Corrected by           Total   Correction     Gigabytes    Total</span><br><span class="line">               ECC          rereads/    errors   algorithm      processed    uncorrected</span><br><span class="line">           fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors</span><br><span class="line"><span class="built_in">read</span>:          0       41         0        41    1802157      95322.595         111</span><br><span class="line">write:         0        0         0         0     526651     171989.938           0</span><br><span class="line">verify:        0        0         0         0       3151          0.000          11</span><br><span class="line"></span><br><span class="line">Non-medium error count:        0</span><br><span class="line"></span><br><span class="line">Self-<span class="built_in">test</span> execution status:             75% of <span class="built_in">test</span> remaining</span><br><span class="line">SMART Self-<span class="built_in">test</span> <span class="built_in">log</span></span><br><span class="line">Num  Test              Status                 segment  LifeTime  LBA_first_err [SK ASC ASQ]</span><br><span class="line">     Description                              number   (hours)</span><br><span class="line"><span class="comment"># 1  Background long   Self test in progress ...   -     NOW                 - [-   -    -]</span></span><br><span class="line"></span><br><span class="line">Long (extended) Self-<span class="built_in">test</span> duration: 57993 seconds [966.5 minutes]  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[1:0:58:0]   disk    WDC      WUS721010AL5204  C980  /dev/sdae  35000cca0b07ff9b0  /dev/sg31  10.0TB</span><br></pre></td></tr></table></figure>
<p>All bad sector has been reassigned   </p>
<h3 id="linux-block-integrity"><a href="#linux-block-integrity" class="headerlink" title="linux block integrity"></a>linux block integrity</h3><p>config BLK_DEV_INTEGRITY, copy once, the performance only 1&#x2F;2</p>
<p><a target="_blank" rel="noopener" href="https://www.redhat.com/zh/blog/what-bit-rot-and-how-can-i-detect-it-rhel">Regarding support status: dm-integrity is not labeled as TechPreview, it is supported. Heavy stacks of RAID1 on top, with mdadm or LVM-raid, are not yet widely tested or recommended for production</a></p>
<p>Issues, </p>
<ul>
<li>reformat, it ‘s a long time for 10TB+ HDD</li>
<li>performance impact</li>
</ul>
<p>dm-integrity</p>
<ul>
<li>Emulates per-sector metadata</li>
<li>Optionally standalone mode (CRC32)</li>
</ul>
<p>Because the T13&#x2F;ATA External Path Protection has <a target="_blank" rel="noopener" href="https://www.spinics.net/lists/raid/msg41308.html">dead</a><br>I can ‘t see any support from raid&#x2F;HBA vendor<br>I found linux community support the block integrity, linux kernel need to &gt;&#x3D; 4.12</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=rawfile bs=1M count=128</span><br><span class="line">$ MYLOOP=$(losetup -f --show rawfile)</span><br><span class="line">$ integritysetup format <span class="variable">$MYLOOP</span> -I crc32</span><br><span class="line">$ integritysetup open <span class="variable">$MYLOOP</span> mydata -I crc32</span><br><span class="line">$ mkfs.xfs /dev/mapper/mydata</span><br><span class="line">$ mount /dev/mapper/mydata /mnt</span><br><span class="line">$ <span class="built_in">yes</span> &gt;/mnt/infile</span><br><span class="line">$ <span class="built_in">md5sum</span> /mnt/infile </span><br><span class="line">13e14c50aaf2054d987663ed31b5f786  /mnt/infile</span><br><span class="line">$ umount /mnt/</span><br><span class="line">$ losetup -d <span class="variable">$MYLOOP</span></span><br><span class="line">$ integritysetup close mydata</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=rawfile bs=1 count=10 skip=$((<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span>)) 2&gt;/dev/null|hexdump -vC</span><br><span class="line">00000000  79 0a 79 0a 79 0a 79 0a  79 0a |y.y.y.y.y.|</span><br><span class="line">0000000a</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;x&#x27;</span> | <span class="built_in">dd</span> of=rawfile bs=1 count=1 seek=$((<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span>)) conv=notrunc</span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=rawfile bs=1 count=10 skip=$((<span class="number">50</span>*<span class="number">1024</span>*<span class="number">1024</span>)) 2&gt;/dev/null|hexdump -vC</span><br><span class="line">00000000  78 0a 79 0a 79 0a 79 0a  79 0a |x.y.y.y.y.|</span><br><span class="line">0000000a</span><br><span class="line"></span><br><span class="line"><span class="comment"># you can see the log in demsg</span></span><br><span class="line">[Thu Jan 23 12:56:07 2020] device-mapper: integrity: Checksum failed at sector 0x18468</span><br><span class="line"></span><br><span class="line">$ integritysetup status mydata</span><br><span class="line">/dev/mapper/mydata is active and is <span class="keyword">in</span> use.</span><br><span class="line">  <span class="built_in">type</span>:    INTEGRITY</span><br><span class="line">  tag size: 4</span><br><span class="line">  integrity: crc32c</span><br><span class="line">  device:  /dev/loop0</span><br><span class="line">  loop:    /root/rawfile</span><br><span class="line">  sector size:  512 bytes</span><br><span class="line">  interleave sectors: 32768</span><br><span class="line">  size:    258152 sectors</span><br><span class="line">  mode:    <span class="built_in">read</span>/write</span><br><span class="line">  failures: 10</span><br><span class="line">  journal size: 991232 bytes</span><br><span class="line">  journal watermark: 50%</span><br><span class="line">  journal commit time: 10000 ms</span><br><span class="line"></span><br><span class="line">$  <span class="built_in">md5sum</span> /mnt/*</span><br><span class="line"><span class="built_in">md5sum</span>: /mnt/infile: Input/output error <span class="comment">## error file could not be read</span></span><br><span class="line">e7eee6d6c29d2f78bbd28e14df457dc7  /mnt/testfile</span><br></pre></td></tr></table></figure>

<p>Tech preview in CentOS 8<br>Regarding support status: dm-integrity is not labeled as TechPreview, it is supported. Heavy stacks of RAID1 on top, with mdadm or LVM-raid, are not yet widely tested or recommended for production.    </p>
<p><a target="_blank" rel="noopener" href="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/DMIntegrity">For more DMIntegrity</a>   </p>
<h3 id="Seagate-HDD-smart-issue"><a href="#Seagate-HDD-smart-issue" class="headerlink" title="Seagate HDD smart issue"></a>Seagate HDD smart issue</h3><h4 id="Seagate-SATA"><a href="#Seagate-SATA" class="headerlink" title="Seagate SATA"></a>Seagate SATA</h4><p>There are a lot of error in seagate sata smart, but the selftest process is OK, no return any error   </p>
<p><a target="_blank" rel="noopener" href="//www.users.on.net/~fzabkar/HDD/Seagate_SER_RRER_HEC.html">The raw value of each SMART attribute occupies 48 bits. Seagate’s Seek Error Rate attribute consists of two parts – a 16-bit count of seek errors in the uppermost 4 nibbles, and a 32-bit count of seeks in the lowermost 8 nibbles. In order to see these data, we will need a SMART utility that reports all 48 bits, preferably in hexadecimal. Two such utilities are HD Sentinel and HDDScan.</a>    </p>
<p>normalised SER &#x3D; -10 log (lifetime seek errors &#x2F; lifetime seeks)    </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7 Seek_Error_Rate         0x000f 072 060 030 Pre-fail Always      -       17262017054</span><br></pre></td></tr></table></figure>
<p>Error Recovery Usage Rate<br><a target="_blank" rel="noopener" href="http://www.users.on.net/~fzabkar/HDD/Seagate_SER_RRER_HEC.html">The raw values of the RRER and HER attributes represent a sector count, not an error count. This figure rolls over to 0 once the count reaches about 250 million. I suspect that the drive records the total number of errors in each block of 250 million sectors, and then recalculates the normalised values of each attribute accordingly. This means that RRER and HER would be updated according to a rolling average rather than on a lifetime basis. I’m almost certain that the normalised values are also logarithmic, but I’m not sure how they are calculated. The above figure of 250 million sectors applies to the 7200.11 and DiamondMax 22 models, but may not apply to all.</a>     </p>
<p>In fact the document mentions (but does not discuss) 5 different error recovery schemes:   </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HARD = multiple retries invoked and failed</span><br><span class="line">FIRM = multiple retries invoked</span><br><span class="line">SOFT = 5 retries invoked</span><br><span class="line">OTF = 1 retry invoked (On The Fly)</span><br><span class="line">RAW = OTF ECC invoked </span><br></pre></td></tr></table></figure>

<p>“On The Fly” means that errored data is corrected using the ECC bytes, without an additional access of the platters.<br>Based on the abovementioned Error Recovery Usage Rate formula, I now postulate that the normalised value of the Raw Read Error Rate attribute could be calculated as follows:<br>normalised RRER &#x3D; -10 log (number of errored sectors &#x2F; total bits transferred)<br>The total number of bits is …   </p>
<p>That why after smart test will not show any error.   </p>
<p>The SAS has the same<br>In seagate document “Rapid Increase in ECC on-the-Fly”<br>Background<br>Per Seagate SCSI Commands Reference Manual, Rev D: Log page 03h, parameter code 0000: Errors corrected without substantial delay. Error correction was applied to get perfect data (a.k.a., ECC on-the-fly). “Without Substantial Delay” means the correction did not postpone reading of later sectors (e.g., a revolution was not lost). The counter is incremented once for each logical block that requires correction. Two different blocks corrected during the same command are counted as two events.   </p>
<p>Root Cause<br>ECC on-the-fly is necessary for HDDs to function properly at current areal densities. Seagate HDDs will report an increasing value in this counter as part of normal operation. Seagate reports the counter value in accordance with the SCSI specification for informational purposes only; the SCSI specification does not require manufacturers to support the counter (T10&#x2F;BSR INCITS 513 Revision 36h, pg564). Rate of ECC on the fly can vary based on drive model, drive capacity, areal density, disk speed, and environmental factors. Competitors may not support this parameter because the specification says that it is optional, or the arithmetic is different. It is common industry practice to use on-the-fly correction in order to ensure optimal drive operation. Disparity is caused because competitor does not define an accessible counter for this parameter.   </p>
<p>Solution<br>Seagate recommends that customers do not compare values of the log attribute for Seagate brand HDDs to competitors’ drives. Increasing values are part of normal operation of high areal density HDDs. There are no performance concerns related to high values in this counter, and the counter does not indicate any concerns related to reliability or data retention.    </p>
<h3 id="plugin-out-the-device"><a href="#plugin-out-the-device" class="headerlink" title="plugin out the device"></a>plugin out the device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] killing request</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] FAILED Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] CDB: Write(16) 8a 00 00 00 00 04 8c 3f fd fe 00 00 00 02 00 00</span><br><span class="line">[Thu Jul  9 11:05:08 2020] blk_update_request: I/O error, dev sdcz, sector 19532873214</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] Synchronizing SCSI cache</span><br><span class="line">[Thu Jul  9 11:05:08 2020] sd 12:0:13:0: [sdcz] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK</span><br></pre></td></tr></table></figure>

<h3 id="SMR-device"><a href="#SMR-device" class="headerlink" title="SMR device"></a>SMR device</h3><p>f2fs support zoned block device<br>for zoned block device</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dmzadm –format /dev/sdb</span><br><span class="line">$ dmsetup create dmz-sdb</span><br><span class="line">$ <span class="built_in">ls</span> -l /dev/mapper/dmz-sdb</span><br></pre></td></tr></table></figure>

<h3 id="Linux-Explicit-volatile-write-back-cache-control"><a href="#Linux-Explicit-volatile-write-back-cache-control" class="headerlink" title="Linux Explicit volatile write back cache control"></a><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/block/writeback_cache_control.txt">Linux Explicit volatile write back cache control</a></h3><h4 id="Explicit-cache-flushes"><a href="#Explicit-cache-flushes" class="headerlink" title="Explicit cache flushes"></a>Explicit cache flushes</h4><p>The REQ_PREFLUSH flag can be OR ed into the r&#x2F;w flags of a bio submitted from the filesystem and will make sure the volatile cache of the storage device has been flushed before the actual I&#x2F;O operation is started.<br>In addition the REQ_PREFLUSH flag can be set on an otherwise empty bio structure, which causes only an explicit cache flush without any dependent I&#x2F;O.  It is recommend to use the blkdev_issue_flush() helper for a pure cache flush</p>
<h4 id="Forced-Unit-Access"><a href="#Forced-Unit-Access" class="headerlink" title="Forced Unit Access"></a>Forced Unit Access</h4><p>The REQ_FUA flag can be OR ed into the r&#x2F;w flags of a bio submitted from the filesystem and will make sure that I&#x2F;O completion for this request is only signaled after the data has been committed to non-volatile storage.<br>Filesystems can simply set the REQ_PREFLUSH and REQ_FUA bits and do not have to worry if the underlying devices need any explicit cache flushing and how the Forced Unit Access is implemented.  The REQ_PREFLUSH and REQ_FUA flags may both be set on a single bio.</p>
<p>Note that REQ_PREFLUSH requests with a payload are automatically turned into a sequence of an empty REQ_OP_FLUSH request followed by the actual write by the block<br>layer.  For devices that also support the FUA bit the block layer needs to be told to pass through the REQ_FUA bit using:</p>
<pre><code>    blk_queue_write_cache(sdkp-&gt;disk-&gt;queue, true, true);
</code></pre>
<p>and the driver must handle write requests that have the REQ_FUA bit set in prep_fn&#x2F;request_fn.  If the FUA bit is not natively supported the block layer turns it into an empty REQ_OP_FLUSH request after the actual write.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">include/linux/fs.h</span><br><span class="line"> * With that in mind, the available types are:</span><br><span class="line"> *</span><br><span class="line"> * READ                 A normal read operation. Device will be plugged.</span><br><span class="line"> * READ_SYNC            A synchronous read. Device is not plugged, caller can</span><br><span class="line"> *                      immediately wait on this read without caring about</span><br><span class="line"> *                      unplugging.</span><br><span class="line"> * READA                Used for read-ahead operations. Lower priority, and the</span><br><span class="line"> *                      block layer could (in theory) choose to ignore this</span><br><span class="line"> *                      request if it runs into resource problems.</span><br><span class="line"> * WRITE                A normal async write. Device will be plugged.</span><br><span class="line"> * WRITE_SYNC           Synchronous write. Identical to WRITE, but passes down</span><br><span class="line"> *                      the hint that someone will be waiting on this IO</span><br><span class="line"> *                      shortly. The write equivalent of READ_SYNC.</span><br><span class="line"> * WRITE_ODIRECT        Special case write for O_DIRECT only.</span><br><span class="line"> * WRITE_FLUSH          Like WRITE_SYNC but with preceding cache flush.</span><br><span class="line"> * WRITE_FUA            Like WRITE_SYNC but data is guaranteed to be on</span><br><span class="line"> *                      non-volatile media on completion.</span><br><span class="line"> * WRITE_FLUSH_FUA      Combination of WRITE_FLUSH and FUA. The IO is preceded</span><br><span class="line"> *                      by a cache flush and data is guaranteed to be on</span><br><span class="line"> *                      non-volatile media on completion.</span><br></pre></td></tr></table></figure>

<h3 id="mbr-info"><a href="#mbr-info" class="headerlink" title="mbr info"></a><a target="_blank" rel="noopener" href="http://blog.cuicc.com/blog/2011/11/15/mbr-and-boot-loader/">mbr info</a></h3><table>
<thead>
<tr>
<th>hex oct dec</th>
<th>Description</th>
<th>size in bytes</th>
</tr>
</thead>
<tbody><tr>
<td>0000 0000 000</td>
<td>code area</td>
<td>440(max:446)</td>
</tr>
<tr>
<td>01b8 0670 440</td>
<td>disk signature (optional)</td>
<td>4</td>
</tr>
<tr>
<td>01bc 0674 444</td>
<td>Usually nulls; 0×0000</td>
<td>2</td>
</tr>
<tr>
<td>01BE 0676 446</td>
<td>Table of primary partitions, (Four 16-byte entries, IBM partition table scheme)</td>
<td>64 (16 x 4 partions)</td>
</tr>
<tr>
<td>01FE 0776 510</td>
<td>55h MBR signature</td>
<td>1</td>
</tr>
<tr>
<td>01FF 0777 511</td>
<td>AAh MBR signature, the last two bytes: 0xAA55</td>
<td>1</td>
</tr>
<tr>
<td></td>
<td>MBR, total size: 446 + 64 + 2 &#x3D;</td>
<td>sum: 512</td>
</tr>
</tbody></table>
<h3 id="Persisten-memory-to-block"><a href="#Persisten-memory-to-block" class="headerlink" title="Persisten memory to block"></a><a target="_blank" rel="noopener" href="https://pmem.io/2018/05/15/using_persistent_memory_devices_with_the_linux_device_mapper.html">Persisten memory to block</a></h3><p>You could use mdadm replace the dmsetup<br>The dmsetup linear example</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 1024 linear /dev/sda 204</span><br><span class="line">1024 512 linear /dev/sdb 766</span><br><span class="line">1536 128 linear /dev/sdc 0</span><br></pre></td></tr></table></figure>
<p>The mapper device(logic)<br>0-1023 sectors map to the 204 sector of &#x2F;dev&#x2F;sda<br>1024-1535 sectors map to the 766 sector of &#x2F;dev&#x2F;sdb<br>1536-1663 sectors map to the 0 sector of &#x2F;dev&#x2F;sdc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 2048 striped 2 64 /dev/sda 1024 /dev/sdb 0</span><br></pre></td></tr></table></figure>
<p>0-2048 sectors(total length) of the mapper device —&gt; 64 sectors &#x3D; stripe size<br>stripe from 1024 sector of &#x2F;dev&#x2F;sda<br>stripe from 0 sector of &#x2F;dev&#x2F;sdb<br>For loading balancing the IO</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 4711 mirror core 2 64 nosync 2 /dev/sda 2048 /dev/sdb 1024</span><br></pre></td></tr></table></figure>
<p>sda from 2048 sector (mirror) sdb from 1024 sector &#x3D; the mapper device(logic) from 0 sector to 4711 sector</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y ndctl daxctl</span><br><span class="line">$ $ ndctl list -u</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>:<span class="string">&quot;namespace1.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>:<span class="string">&quot;fsdax&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>:<span class="string">&quot;3.93 GiB (4.22 GB)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uuid&quot;</span>:<span class="string">&quot;9b8d6eeb-547c-4865-8213-746c6b20bc9c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;raw_uuid&quot;</span>:<span class="string">&quot;e84e23f4-cab8-4afe-9fbf-6176e37095b1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sector_size&quot;</span>:512,</span><br><span class="line">    <span class="string">&quot;blockdev&quot;</span>:<span class="string">&quot;pmem1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;numa_node&quot;</span>:0</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>:<span class="string">&quot;namespace0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>:<span class="string">&quot;fsdax&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>:<span class="string">&quot;3.93 GiB (4.22 GB)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uuid&quot;</span>:<span class="string">&quot;76a114c5-b7c0-48f7-8fe8-d09702d8b1b1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;raw_uuid&quot;</span>:<span class="string">&quot;2ef21ac8-e22d-4b8e-8cf6-fc0fcbf6258a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sector_size&quot;</span>:512,</span><br><span class="line">    <span class="string">&quot;blockdev&quot;</span>:<span class="string">&quot;pmem0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;numa_node&quot;</span>:0</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">$ sudo ndctl create-namespace -f -e namespace0.0 --mode=fsdax</span><br><span class="line">$ sudo ndctl create-namespace -f -e namespace1.0 --mode=fsdax</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/iomem</span><br><span class="line">...</span><br><span class="line">140000000-23fdfffff : Persistent Memory</span><br><span class="line">  140000000-23fdfffff : namespace0.0</span><br><span class="line">23fe00000-33fbfffff : Persistent Memory</span><br><span class="line">  23fe00000-33fbfffff : namespace1.0</span><br><span class="line"></span><br><span class="line">$ parted /dev/pmem0</span><br><span class="line">$ parted /dev/pmem1</span><br><span class="line"></span><br><span class="line">$ mkfs.ext4 -b 4096 -E stride=512 -F /dev/pmem0</span><br><span class="line">$ mount /dev/pmem0 /mnt/dax</span><br><span class="line"></span><br><span class="line">$ mkfs.xfs -f -d su=2m,sw=1 /dev/pmem0</span><br><span class="line">$ mount /dev/pmem0 /mnt/dax</span><br><span class="line">$ xfs_io -c <span class="string">&quot;extsize 2m&quot;</span> /mnt/dax</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /sys/kernel/debug/tracing</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; events/fs_dax/dax_pmd_fault_done/enable</span><br><span class="line"></span><br><span class="line">$ fallocate --length 1G /mnt/dax/data</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 0 &gt; events/fs_dax/dax_pmd_fault_done/enable</span><br><span class="line"></span><br><span class="line">$  lsblk /dev/pmem*</span><br><span class="line">NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">pmem0 259:0    0   4G  0 disk</span><br><span class="line">pmem1 259:1    0   4G  0 disk</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> -e <span class="string">&quot;0 `blockdev --getsz /dev/pmem0` linear /dev/pmem0 0 &quot;</span>\\n<span class="string">&quot;`blockdev --getsz /dev/pmem0` `blockdev --getsz /dev/pmem1` linear /dev/pmem1 0&quot;</span> | sudo dmsetup create linear-pmem</span><br><span class="line"></span><br><span class="line">$ dmsetup <span class="built_in">ls</span> --tree</span><br><span class="line">linear-pmem (253:2)</span><br><span class="line"> ├─ (259:1)</span><br><span class="line"> └─ (259:0)</span><br><span class="line"></span><br><span class="line">$ lsblk /dev/pmem*</span><br><span class="line">NAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">pmem0         259:0    0   4G  0 disk</span><br><span class="line">└─linear-pmem 253:2    0   8G  0 dm</span><br><span class="line">pmem1         259:1    0   4G  0 disk</span><br><span class="line">└─linear-pmem 253:2    0   8G  0 dm</span><br><span class="line"></span><br><span class="line">$ lsblk /dev/mapper/linear-pmem</span><br><span class="line">NAME        MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">linear-pmem 253:2    0   8G  0 dm</span><br><span class="line"></span><br><span class="line">$ parted /dev/mapper/linear-pmem</span><br><span class="line"></span><br><span class="line">$ mkfs.ext4 -b 4096 -E stride=512 -F /dev/mapper/linear-pmem</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> /pmem; mount -o dax /dev/mapper/linear-pmem /pmem</span><br><span class="line"></span><br><span class="line"><span class="comment">## try stripe</span></span><br><span class="line">$ <span class="built_in">echo</span> -e <span class="string">&quot;0 <span class="subst">$(( `blockdev --getsz /dev/pmem0` + `blockdev --getsz /dev/pmem0` )</span>) striped 2 4096 /dev/pmem0 0 /dev/pmem1 0&quot;</span> | sudo dmsetup create striped-pmem</span><br><span class="line">$ $ dmsetup <span class="built_in">ls</span> --tree</span><br><span class="line">striped-pmem (253:2)</span><br><span class="line"> ├─ (259:1)</span><br><span class="line"> └─ (259:0)</span><br><span class="line"></span><br><span class="line">$ lsblk /dev/pmem*</span><br><span class="line">NAME           MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">pmem0          259:0    0   4G  0 disk</span><br><span class="line">└─striped-pmem 253:2    0   8G  0 dm</span><br><span class="line">pmem1          259:1    0   4G  0 disk</span><br><span class="line">└─striped-pmem 253:2    0   8G  0 dm</span><br><span class="line"></span><br><span class="line">$ lsblk /dev/mapper/striped-pmem</span><br><span class="line">NAME         MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">striped-pmem 253:2    0   8G  0 dm</span><br><span class="line"></span><br><span class="line">$ parted /dev/mapper/striped-pmem</span><br><span class="line"></span><br><span class="line">$ mkfs.ext4 -b 4096 -E stride=512 -F /dev/mapper/striped-pmem</span><br><span class="line">$ mount -o dax /dev/mapper/striped-pmem /pmem</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://zonedstorage.io/docs/linux/dm">for more</a></p>
<h3 id="the-bad-seek-performance-for-the-block-device"><a href="#the-bad-seek-performance-for-the-block-device" class="headerlink" title="the bad seek performance for the block device"></a>the bad seek performance for the block device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> ((i=<span class="number">0</span>;i&lt;<span class="number">128</span>;i++)); <span class="keyword">do</span> <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/sdcn  bs=1K seek=$((i+<span class="number">16384</span>)) count=<span class="variable">$i</span> oflag=direct &amp; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">toshiba : 138,137,139,138, 5X time overhad than seagate</span><br><span class="line">seagate : 25,24,33,28</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.06   99.94    0.00    0.00</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdn               0.00     0.00    0.00   65.50     0.00     0.06     2.00   124.79 2122.11    0.00 2122.11  15.27 100.00</span><br><span class="line">sdcn              0.00     0.00    1.00  405.50     0.00     0.40     2.01   113.14  281.85    7.00  282.53   2.46 100.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.03   99.97    0.00    0.00</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdn               0.00     0.00    0.00    4.00     0.00     0.00     2.00   123.00  844.88    0.00  844.88 250.00 100.00</span><br><span class="line">sdcn              0.00     0.00    0.00  265.00     0.00     0.26     2.00   109.31  388.38    0.00  388.38   3.77 100.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.03    0.00    0.03   99.94    0.00    0.00</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdn               0.00     0.00    0.00   93.00     0.00     0.09     2.00   122.02 1846.38    0.00 1846.38  10.75 100.00</span><br><span class="line">sdcn              0.00     0.00    5.00  364.00     0.02     0.36     2.08   104.42  308.38  152.70  310.51   2.71 100.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.03   99.97    0.00    0.00</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdn               0.00     0.00    0.00   85.50     0.00     0.08     2.00   121.86 2350.01    0.00 2350.01  11.70 100.00</span><br><span class="line">sdcn              0.00     0.00    6.50  292.50     0.07     0.29     2.46    98.64  323.80  225.92  325.97   3.34 100.00</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.03    0.00    0.06   99.91    0.00    0.00</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sdn               0.00     0.00    0.00   29.50     0.00     0.03     2.00   120.00 1070.56    0.00 1070.56  33.90 100.00</span><br><span class="line">sdcn              0.00     0.00    8.00  250.50     0.42     0.24     5.23    92.13  325.49  103.69  332.57   3.87 100.00</span><br><span class="line"></span><br><span class="line">64x <span class="built_in">cat</span> demofile &gt; zfs/file.<span class="variable">$i</span></span><br><span class="line">            |</span><br><span class="line">            -----1G random file <span class="keyword">in</span> dev shm</span><br><span class="line"></span><br><span class="line">stest_raidz-16-as9   127G  86.9T      0  10.8K      0  1.14G &lt;----------seagate</span><br><span class="line">ttest_raidz-16-as9  64.3G  86.9T      0  1.80K      0   213M &lt;----------toshiba</span><br><span class="line">------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">stest_raidz-16-as9   131G  86.9T      0  15.5K      0  1.76G</span><br><span class="line">ttest_raidz-16-as9  64.3G  86.9T      0  1.79K      0   212M</span><br><span class="line">------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">stest_raidz-16-as9   134G  86.9T      0  16.2K      0  1.66G</span><br><span class="line">ttest_raidz-16-as9  64.3G  86.9T      0  1.10K      0   125M</span><br><span class="line">------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">stest_raidz-16-as9   138G  86.9T      0  7.51K      0   765M</span><br><span class="line">ttest_raidz-16-as9  64.3G  86.9T      0    439      0  3.10M</span><br><span class="line">------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">stest_raidz-16-as9   141G  86.9T      0  13.3K      0  1.28G</span><br><span class="line">ttest_raidz-16-as9  68.8G  86.9T      0  2.79K      0   292M</span><br><span class="line">------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">stest_raidz-16-as9   144G  86.9T      0  10.2K      0  1.02G</span><br><span class="line">ttest_raidz-16-as9  68.8G  86.9T      0  2.24K      0   266M</span><br></pre></td></tr></table></figure>

<h3 id="Vendor-tools"><a href="#Vendor-tools" class="headerlink" title="Vendor tools"></a>Vendor tools</h3><ul>
<li>seatools</li>
<li>Samsung HUTIL</li>
<li>Data Lifeguard Diagnostics for linux</li>
</ul>
<h3 id="NVRAM-dev-in-the-megaraid"><a href="#NVRAM-dev-in-the-megaraid" class="headerlink" title="NVRAM dev in the megaraid"></a>NVRAM dev in the megaraid</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">VD LIST :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">DG/VD TYPE  State Access Consist Cache Cac sCC       Size Name </span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">0/0   RAID1 Optl  RW     No      NRWBD -   OFF 422.664 GB      </span><br><span class="line">0/1   RAID1 Optl  RW     No      NRWBD -   OFF   3.906 GB      &lt;---what this ?</span><br><span class="line">0/2   RAID1 Optl  RW     No      NRWBD -   OFF   3.906 GB      </span><br><span class="line">0/3   RAID1 Optl  RW     No      NRWBD -   OFF   3.906 GB      </span><br><span class="line">0/4   RAID1 Optl  RW     No      NRWBD -   OFF   3.906 GB      </span><br><span class="line">0/5   RAID1 Optl  RW     No      NRWBD -   OFF   3.906 GB      </span><br><span class="line">0/6   RAID1 Optl  RW     No      NRWBD -   OFF   3.906 GB      </span><br><span class="line">---------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VD=Virtual Drive| DG=Drive Group|Rec=Recovery</span><br><span class="line">Cac=CacheCade|OfLn=OffLine|Pdgd=Partially Degraded|Dgrd=Degraded</span><br><span class="line">Optl=Optimal|dflt=Default|RO=Read Only|RW=Read Write|HD=Hidden|TRANS=TransportReady</span><br><span class="line">B=Blocked|Consist=Consistent|R=Read Ahead Always|NR=No Read Ahead|WB=WriteBack</span><br><span class="line">AWB=Always WriteBack|WT=WriteThrough|C=Cached IO|D=Direct IO|sCC=Scheduled</span><br><span class="line">Check Consistency</span><br><span class="line"></span><br><span class="line">Physical Drives = 2</span><br><span class="line"></span><br><span class="line">PD LIST :</span><br><span class="line">=======</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line">EID:Slt DID State DG       Size Intf Med SED PI SeSz Model                                   Sp Type </span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line">134:0    52 Onln   0 446.102 GB SATA SSD N   N  512B SSDSC2KB480G8L       01PE331D7A09679LEN U  -    </span><br><span class="line">134:1    53 Onln   0 446.102 GB SATA SSD N   N  512B SSDSC2KB480G8L       01PE331D7A09679LEN U  -    </span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h3 id="WDC-upgrade-firmware"><a href="#WDC-upgrade-firmware" class="headerlink" title="WDC upgrade firmware"></a>WDC upgrade firmware</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ hugo u --serial 7PK3H9MC -f ./LHGNA92C.bin </span><br><span class="line">$ hugo u -m HUH721010AL5200 -f ./LHGNA92C.bin </span><br><span class="line"></span><br><span class="line">Attempting to update Firmware on 1 Devices...</span><br><span class="line"></span><br><span class="line">Update Successful on device: 7PK3H9MC</span><br><span class="line"></span><br><span class="line">Update successful on 1 devices.</span><br><span class="line">Power cycling of updated devices is recommended.</span><br></pre></td></tr></table></figure>

<h3 id="zone-device"><a href="#zone-device" class="headerlink" title="zone device"></a><a target="_blank" rel="noopener" href="https://zonedstorage.io/docs/getting-started/zbd-emulation">zone device</a></h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/westerndigitalcorporation/dm-zoned-tools">dm-zoned-tools</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#if not disable the writeback throttling, modify and test it</span></span><br><span class="line">vm.dirty_background_bytes = 204800000</span><br><span class="line">vm.dirty_bytes = 819200000</span><br><span class="line">vm.dirty_writeback_centisecs = 3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Similarly to CFQ, BFQ has its write-throttling heuristics, and it is better not to combine them with further write-throttling heuristics of a different nature.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable throttling of buffered writeback to make it a lot more smooth, and has way less impact on other system activity. Background writeback should be, by definition, background activity. The fact that we flush huge bundles of it at the time means that it potentially has heavy impacts on foreground workloads, which isn&#x27;t ideal. We can&#x27;t easily limit the sizes of writes that we do, since that would impact file system layout in the presence of delayed allocation. So just throttle back buffered writeback, unless someone is waiting for it.</span></span><br></pre></td></tr></table></figure>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#block-hook-up-writeback-throttling"><span class="toc-number">1.</span> <span class="toc-text">block: hook up writeback throttling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hardware"><span class="toc-number">2.</span> <span class="toc-text">Hardware</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#QLC-performance"><span class="toc-number">2.1.</span> <span class="toc-text">QLC performance</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#firmware-cause-performance-distance"><span class="toc-number">3.</span> <span class="toc-text">firmware cause performance distance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#512-byte-Emulation-512e-Disk-Compatibility-Update"><span class="toc-number">3.1.</span> <span class="toc-text">512-byte Emulation (512e) Disk Compatibility Update</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#here-is-the-5-years-not-worked-free-volume-not-mapping"><span class="toc-number">3.2.</span> <span class="toc-text">here is the 5 years not worked (free volume, not mapping)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Qlogic-driver-setting"><span class="toc-number">4.</span> <span class="toc-text">Qlogic driver setting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SAN-controller-setting-MD3460"><span class="toc-number">5.</span> <span class="toc-text">SAN controller setting MD3460</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rebuild-feature"><span class="toc-number">6.</span> <span class="toc-text">rebuild feature</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux"><span class="toc-number">7.</span> <span class="toc-text">Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#block-driver"><span class="toc-number">7.1.</span> <span class="toc-text">block driver</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parted-alignment"><span class="toc-number">8.</span> <span class="toc-text">parted alignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#power-save-ATA"><span class="toc-number">9.</span> <span class="toc-text">power save (ATA)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Advance-reformat-4Kn-SCSI-devs-to-512-Bytes-sector"><span class="toc-number">10.</span> <span class="toc-text">Advance reformat 4Kn SCSI devs to 512 Bytes sector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iostat"><span class="toc-number">11.</span> <span class="toc-text">iostat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-IO-schduler"><span class="toc-number">12.</span> <span class="toc-text">Linux IO schduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#deadline-parameters"><span class="toc-number">12.1.</span> <span class="toc-text">deadline parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scsi-driver-error-handaling-EH"><span class="toc-number">13.</span> <span class="toc-text">scsi_driver error handaling (EH)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#long-data-sector"><span class="toc-number">14.</span> <span class="toc-text">long-data-sector</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#T10-DIF-PI"><span class="toc-number">14.1.</span> <span class="toc-text">T10 DIF&#x2F;PI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#About-DIF-520-Bytes"><span class="toc-number">14.2.</span> <span class="toc-text">About DIF 520 Bytes</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#models-with-PI-bytes-the-page-only-show-512-or-4096-bytes-the-extra-space-overhead-hide-in-HDD"><span class="toc-number"></span> <span class="toc-text">models with PI bytes, the page only show 512 or 4096 bytes, the extra space overhead hide in HDD</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#modlls-w-o-PI-bytes-smartctl-could-get-520-524-4160-4192-4224-from-logic-sector-bytes"><span class="toc-number"></span> <span class="toc-text">modlls w&#x2F;o PI bytes, smartctl could get 520,524,4160,4192,4224 from logic sector bytes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-erasing"><span class="toc-number">1.</span> <span class="toc-text">Security erasing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enable-the-blk-mq-and-scsi-mq"><span class="toc-number">2.</span> <span class="toc-text">Enable the blk_mq and scsi_mq</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lsscsi"><span class="toc-number">3.</span> <span class="toc-text">lsscsi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#udevinfo"><span class="toc-number">4.</span> <span class="toc-text">udevinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Encrypt-block-device"><span class="toc-number">5.</span> <span class="toc-text">Encrypt block device</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Input-password"><span class="toc-number">5.1.</span> <span class="toc-text">Input password</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapper-test-device"><span class="toc-number">5.2.</span> <span class="toc-text">mapper test device</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-remove-key"><span class="toc-number">5.3.</span> <span class="toc-text">Add&#x2F;remove key</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Back-restore-header"><span class="toc-number">5.4.</span> <span class="toc-text">Back&#x2F;restore header</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#is-luks-partition"><span class="toc-number">5.5.</span> <span class="toc-text">is luks partition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Clean-luks-partition"><span class="toc-number">5.6.</span> <span class="toc-text">Clean luks partition</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smart-err-health-info"><span class="toc-number">6.</span> <span class="toc-text">smart err health info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Re-assign-bad-block"><span class="toc-number">7.</span> <span class="toc-text">Re-assign bad block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-block-integrity"><span class="toc-number">8.</span> <span class="toc-text">linux block integrity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seagate-HDD-smart-issue"><span class="toc-number">9.</span> <span class="toc-text">Seagate HDD smart issue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Seagate-SATA"><span class="toc-number">9.1.</span> <span class="toc-text">Seagate SATA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plugin-out-the-device"><span class="toc-number">10.</span> <span class="toc-text">plugin out the device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMR-device"><span class="toc-number">11.</span> <span class="toc-text">SMR device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-Explicit-volatile-write-back-cache-control"><span class="toc-number">12.</span> <span class="toc-text">Linux Explicit volatile write back cache control</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Explicit-cache-flushes"><span class="toc-number">12.1.</span> <span class="toc-text">Explicit cache flushes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Forced-Unit-Access"><span class="toc-number">12.2.</span> <span class="toc-text">Forced Unit Access</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mbr-info"><span class="toc-number">13.</span> <span class="toc-text">mbr info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Persisten-memory-to-block"><span class="toc-number">14.</span> <span class="toc-text">Persisten memory to block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-bad-seek-performance-for-the-block-device"><span class="toc-number">15.</span> <span class="toc-text">the bad seek performance for the block device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vendor-tools"><span class="toc-number">16.</span> <span class="toc-text">Vendor tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NVRAM-dev-in-the-megaraid"><span class="toc-number">17.</span> <span class="toc-text">NVRAM dev in the megaraid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WDC-upgrade-firmware"><span class="toc-number">18.</span> <span class="toc-text">WDC upgrade firmware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zone-device"><span class="toc-number">19.</span> <span class="toc-text">zone device</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2016/08/10/block_device/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2016/08/10/block_device/&text=The block device"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2016/08/10/block_device/&is_video=false&description=The block device"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=The block device&body=Check out this article: http://example.com/2016/08/10/block_device/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2016/08/10/block_device/&title=The block device"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2016/08/10/block_device/&name=The block device&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2016/08/10/block_device/&t=The block device"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = '67e8c052/67e8c052.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'blog-comments';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
